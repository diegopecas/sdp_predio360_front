"use strict";(self.webpackChunkpredio360_app=self.webpackChunkpredio360_app||[]).push([[8740],{78740:(ae,Z,o)=>{o.r(Z),o.d(Z,{FeatureServiceSnappingSource:()=>y});var p=o(15861),s=o(17626),b=o(83761),V=o(59213),F=o(54024),D=o(75618),f=o(10699),u=o(32917),l=o(77712),C=(o(8314),o(63290),o(4619),o(76898)),k=o(11426),j=o(72469),A=o(60507),P=o(68511),L=o(79800),W=o(29302),_=o(41743);function H(e,t){return(0,_.g)(t.extent,E),(0,_.h)(E,(0,L.s)(J,e.x,e.y,0))}const E=(0,_.a)(),J=(0,W.Ue)();var Y=o(93579);let v=class extends b.Z{get tiles(){const e=this.tilesCoveringView,t=null!=this.pointOfInterest?this.pointOfInterest:this.view.center;return e.sort((n,i)=>H(t,n)-H(t,i)),e}_scaleEnabled(){return(0,Y.rs)(this.view.scale,this.layer.minScale||0,this.layer.maxScale||0)}get tilesCoveringView(){if(!this.view.ready||!this.view.featuresTilingScheme||!this.view.state||null==this.tileInfo)return[];if(!this._scaleEnabled)return[];const{spans:e,lodInfo:t}=this.view.featuresTilingScheme.getTileCoverage(this.view.state,0),{level:n}=t,i=[];for(const{row:r,colFrom:a,colTo:d}of e)for(let h=a;h<=d;h++){const w=t.normalizeCol(h),m=new P.f(null,n,r,w);this.tileInfo.updateTileInfo(m),i.push(m)}return i}get tileInfo(){return this.view.featuresTilingScheme?.tileInfo??null}get tileSize(){return null!=this.tileInfo?this.tileInfo.size[0]:256}constructor(e){super(e),this.pointOfInterest=null}initialize(){this.addHandles((0,u.YP)(()=>this.view?.state?.viewpoint,()=>this.notifyChange("tilesCoveringView"),u.Z_))}};(0,s._)([(0,l.Cb)({readOnly:!0})],v.prototype,"tiles",null),(0,s._)([(0,l.Cb)({readOnly:!0})],v.prototype,"_scaleEnabled",null),(0,s._)([(0,l.Cb)({readOnly:!0})],v.prototype,"tilesCoveringView",null),(0,s._)([(0,l.Cb)({readOnly:!0})],v.prototype,"tileInfo",null),(0,s._)([(0,l.Cb)({readOnly:!0})],v.prototype,"tileSize",null),(0,s._)([(0,l.Cb)({constructOnly:!0})],v.prototype,"view",void 0),(0,s._)([(0,l.Cb)({constructOnly:!0})],v.prototype,"layer",void 0),(0,s._)([(0,l.Cb)()],v.prototype,"pointOfInterest",void 0),v=(0,s._)([(0,C.j)("esri.views.interactive.snapping.featureSources.featureServiceSource.FeatureServiceTiles2D")],v);var G=o(27351);let S=class extends b.Z{get tiles(){const e=this.tilesCoveringView,t=this._effectivePointOfInterest;if(null!=t){const n=e.map(i=>H(t,i));for(let i=1;i<n.length;i++)if(n[i-1]>n[i])return e.sort((r,a)=>H(t,r)-H(t,a)),e.slice()}return e}get tilesCoveringView(){return this._filterTiles(this.view.featureTiles?.tiles?.toArray()).map($)}get tileInfo(){return this.view.featureTiles?.tilingScheme?.toTileInfo()??null}get tileSize(){return this.view.featureTiles?.tileSize??256}get _effectivePointOfInterest(){return this.pointOfInterest??this.view.pointsOfInterest?.focus.location}constructor(e){super(e),this.pointOfInterest=null}initialize(){this.addHandles((0,u.YP)(()=>this.view.featureTiles,e=>{this.removeHandles(R),e&&this.addHandles(e.addClient(),R)},u.nn))}_filterTiles(e){return null==e?[]:e.filter(t=>{const n=t.measures;if(n.visibility===G.E.VISIBLE_ON_SURFACE){const i=n.screenRect;return Math.abs(i[3]-i[1])>B}return!1})}};function $({lij:[e,t,n],extent:i}){return new P.f(`${e}/${t}/${n}`,e,t,n,i)}(0,s._)([(0,l.Cb)({readOnly:!0})],S.prototype,"tiles",null),(0,s._)([(0,l.Cb)({readOnly:!0})],S.prototype,"tilesCoveringView",null),(0,s._)([(0,l.Cb)({readOnly:!0})],S.prototype,"tileInfo",null),(0,s._)([(0,l.Cb)({readOnly:!0})],S.prototype,"tileSize",null),(0,s._)([(0,l.Cb)({constructOnly:!0})],S.prototype,"view",void 0),(0,s._)([(0,l.Cb)()],S.prototype,"pointOfInterest",void 0),(0,s._)([(0,l.Cb)()],S.prototype,"_effectivePointOfInterest",null),S=(0,s._)([(0,C.j)("esri.views.interactive.snapping.featureSources.featureServiceSource.FeatureServiceTiles3D")],S);const B=50,R="feature-tiles";var K=o(44725),M=o(9218),X=o(37118),x=o(65401),Q=o(73187);let T=class extends Q.q{constructor(e){super(e)}initialize(){const e=setInterval(()=>this._fetchDebugInfo(),2e3);this.addHandles((0,F.kB)(()=>clearInterval(e)))}getTiles(){if(!this._debugInfo)return[];const e=new Map,t=new Map;this._debugInfo.storedTiles.forEach(r=>{e.set(r.data.id,r.featureCount)}),this._debugInfo.pendingTiles.forEach(r=>{e.set(r.data.id,r.featureCount),t.set(r.data.id,r.state)});const n=r=>{const a=t.get(r),d=e.get(r)??"?";return a?`${a}:${d}\n${r}`:`store:${d}\n${r}`},i=new Map;return this._debugInfo.storedTiles.forEach(r=>{i.set(r.data.id,r.data)}),this._debugInfo.pendingTiles.forEach(r=>{i.set(r.data.id,r.data)}),Array.from(i.values()).map(r=>({lij:[r.level,r.row,r.col],geometry:X.Z.fromExtent((0,x.HH)(r.extent,this.view.spatialReference)),label:n(r.id)}))}_fetchDebugInfo(){this.handle.getDebugInfo(null).then(e=>{this._debugInfo=e,this.update()})}};(0,s._)([(0,l.Cb)({constructOnly:!0})],T.prototype,"handle",void 0),T=(0,s._)([(0,C.j)("esri.views.interactive.snapping.featureSources.WorkerTileTreeDebugger")],T);var U=o(85931),q=o(62208),ee=o(42930),te=o(71774),ne=o(41967);let g=class extends b.Z{get updating(){return this._updatingHandles.updating||this._workerHandleUpdating}constructor(e){var t;super(e),t=this,this._updatingHandles=new k.R,this._suspendController=null,this.schedule=null,this.hasZ=!1,this.elevationAlignPointsInFeatures=function(){var n=(0,p.Z)(function*(i){const r=[];for(const{points:a}of i.pointsInFeatures)for(const{z:d}of a)r.push(d);return{elevations:r,drapedObjectIds:new Set,failedObjectIds:new Set}});return function(i){return n.apply(this,arguments)}}(),this.queryForSymbologySnapping=(0,p.Z)(function*(){return{candidates:[],sourceCandidateIndices:[]}}),this.availability=0,this._workerHandleUpdating=!0,this._editId=0,this.updateOutFields=(0,f.Ds)(function(){var n=(0,p.Z)(function*(i,r){yield t._updatingHandles.addPromise(t._workerHandle.invokeMethod("updateOutFields",[...i],r)),t._updatingHandles.addPromise(t._workerHandle.invokeMethod("whenNotUpdating",{},r))});return function(i,r){return n.apply(this,arguments)}}())}destroy(){this._suspendController=(0,q.IM)(this._suspendController),this._workerHandle.destroy(),this._updatingHandles.destroy()}initialize(){var t,e=this;this._workerHandle=new ie(this.schedule,{alignElevation:(t=(0,p.Z)(function*(n,{signal:i}){return{result:yield e.elevationAlignPointsInFeatures(n.query,i)}}),function(i,r){return t.apply(this,arguments)}),getSymbologyCandidates:function(){var t=(0,p.Z)(function*(n,{signal:i}){return{result:yield e.queryForSymbologySnapping(n,i)}});return function(i,r){return t.apply(this,arguments)}}()}),this.addHandles([this._workerHandle.on("notify-updating",({updating:t})=>this._workerHandleUpdating=t),this._workerHandle.on("notify-availability",({availability:t})=>this._set("availability",t))])}setup(e,t){var n=this;return(0,p.Z)(function*(){const i=n._serviceInfoFromLayer(e.layer);if(null==i)return;const r={configuration:n._convertConfiguration(e.configuration),serviceInfo:i,spatialReference:e.spatialReference.toJSON(),hasZ:n.hasZ,elevationInfo:e.layer.elevationInfo?.toJSON()};yield n._updatingHandles.addPromise(n._workerHandle.invokeMethod("setup",r,t)),n._updatingHandles.addPromise(n._workerHandle.invokeMethod("whenNotUpdating",{},t))})()}configure(e,t){var n=this;return(0,p.Z)(function*(){const i=n._convertConfiguration(e);yield n._updatingHandles.addPromise(n._workerHandle.invokeMethod("configure",i,t)),n._updatingHandles.addPromise(n._workerHandle.invokeMethod("whenNotUpdating",{},t))})()}refresh(e){var t=this;return(0,p.Z)(function*(){yield t._updatingHandles.addPromise(t._workerHandle.invokeMethod("refresh",{},e)),t._updatingHandles.addPromise(t._workerHandle.invokeMethod("whenNotUpdating",{},e))})()}fetchCandidates(e,t){var n=this;return(0,p.Z)(function*(){const{point:i,filter:r,coordinateHelper:a}=e,d={...e,point:(0,ne.T)(i[0],i[1],i[2],a.spatialReference.toJSON()),filter:r?.toJSON()};return n._workerHandle.invoke(d,t)})()}updateTiles(e,t){var n=this;return(0,p.Z)(function*(){const i={tiles:e.tiles,tileInfo:null!=e.tileInfo?e.tileInfo.toJSON():null,tileSize:e.tileSize};yield n._updatingHandles.addPromise(n._workerHandle.invokeMethod("updateTiles",i,t)),n._updatingHandles.addPromise(n._workerHandle.invokeMethod("whenNotUpdating",{},t))})()}applyEdits(e,t){var n=this;return(0,p.Z)(function*(){const i=n._editId++,r={id:i};yield n._updatingHandles.addPromise(n._workerHandle.invokeMethod("beginApplyEdits",r,t));const a=yield n._updatingHandles.addPromise((0,f.Hl)(e.result,t)),d={id:i,edits:{addedFeatures:a.addedFeatures?.map(({objectId:h})=>h).filter(U.pC)??[],deletedFeatures:a.deletedFeatures?.map(({objectId:h,globalId:w})=>({objectId:h,globalId:w}))??[],updatedFeatures:a.updatedFeatures?.map(({objectId:h})=>h).filter(U.pC)??[]}};yield n._updatingHandles.addPromise(n._workerHandle.invokeMethod("endApplyEdits",d,t)),n._updatingHandles.addPromise(n._workerHandle.invokeMethod("whenNotUpdating",{},t))})()}getDebugInfo(e){return this._workerHandle.invokeMethod("getDebugInfo",{},e)}notifyElevationSourceChange(){var e=this;return(0,p.Z)(function*(){yield e._workerHandle.invokeMethod("notifyElevationSourceChange",{})})()}notifySymbologyChange(){var e=this;return(0,p.Z)(function*(){yield e._workerHandle.invokeMethod("notifySymbologyChange",{})})()}setSymbologySnappingSupported(e){var t=this;return(0,p.Z)(function*(){yield t._workerHandle.invokeMethod("setSymbologySnappingSupported",e)})()}setSuspended(e){var t=this;return(0,p.Z)(function*(){t._suspendController?.abort(),t._suspendController=new AbortController,yield t._workerHandle.invokeMethod("setSuspended",e,t._suspendController.signal)})()}_convertConfiguration(e){return{filter:null!=e.filter?e.filter.toJSON():null,customParameters:e.customParameters,viewType:e.viewType}}_serviceInfoFromLayer(e){return"multipatch"===e.geometryType||"mesh"===e.geometryType?null:{url:e.parsedUrl?.path??"",fieldsIndex:e.fieldsIndex.toJSON(),geometryType:te.M.toJSON(e.geometryType),capabilities:e.capabilities,objectIdField:e.objectIdField,globalIdField:e.globalIdField,spatialReference:e.spatialReference.toJSON(),timeInfo:e.timeInfo?.toJSON()}}};(0,s._)([(0,l.Cb)({constructOnly:!0})],g.prototype,"schedule",void 0),(0,s._)([(0,l.Cb)({constructOnly:!0})],g.prototype,"hasZ",void 0),(0,s._)([(0,l.Cb)({constructOnly:!0})],g.prototype,"elevationAlignPointsInFeatures",void 0),(0,s._)([(0,l.Cb)({constructOnly:!0})],g.prototype,"queryForSymbologySnapping",void 0),(0,s._)([(0,l.Cb)({readOnly:!0})],g.prototype,"updating",null),(0,s._)([(0,l.Cb)({readOnly:!0})],g.prototype,"availability",void 0),(0,s._)([(0,l.Cb)()],g.prototype,"_workerHandleUpdating",void 0),g=(0,s._)([(0,C.j)("esri.views.interactive.snapping.featureSources.featureServiceSource.FeatureServiceSnappingSourceWorkerHandle")],g);class ie extends ee.q{constructor(t,n){super("FeatureServiceSnappingSourceWorker","fetchCandidates",{},t,{strategy:"dedicated",client:n})}}var re=o(72642),se=o(72258),oe=o(2584);let I=class extends b.Z{get tiles(){return[new P.f("0/0/0",0,0,0,(0,x.al)(-1e8,-1e8,1e8,1e8))]}get tileInfo(){return new oe.Z({origin:new re.Z({x:-1e8,y:1e8,spatialReference:this.layer.spatialReference}),size:[512,512],lods:[new se.Z({level:0,scale:1,resolution:390625})],spatialReference:this.layer.spatialReference})}get tileSize(){return this.tileInfo.size[0]}constructor(e){super(e),this.pointOfInterest=null}};(0,s._)([(0,l.Cb)({readOnly:!0})],I.prototype,"tiles",null),(0,s._)([(0,l.Cb)({readOnly:!0})],I.prototype,"tileInfo",null),(0,s._)([(0,l.Cb)({readOnly:!0})],I.prototype,"tileSize",null),(0,s._)([(0,l.Cb)({constructOnly:!0})],I.prototype,"layer",void 0),(0,s._)([(0,l.Cb)()],I.prototype,"pointOfInterest",void 0),I=(0,s._)([(0,C.j)("esri.views.interactive.snapping.featureSources.featureServiceSource.FeatureServiceTilesSimple")],I);var le=o(66463);let y=class extends b.Z{get _updateTilesParameters(){return{tiles:this._tilesOfInterest.tiles,tileInfo:this._tilesOfInterest.tileInfo,tileSize:this._tilesOfInterest.tileSize}}get _layerView(){return this.view?.allLayerViews.find(e=>e.layer===this._layer)}get _isSuspended(){return!(!(0,j.e9)(this._layer)||this.layerSource.sublayerSources.some(e=>e.enabled&&e.layer.visible))||!(!this.view||!1===this._layerView?.suspended&&this.layerSource.enabled)}get updating(){return this._workerHandle?.updating||this._updatingHandles.updating}get _outFields(){const{view:e,_layerView:t,layerSource:n}=this,{layer:i}=n,{fieldsIndex:r,timeInfo:a,floorInfo:d,subtypeField:h}=i,w=t&&"filter"in t?t.filter:null,m=w?.where&&"1=1"!==w.where?this._getOrLoadWhereFields(w.where,r):[];if(w?.timeExtent&&a){const{startField:c,endField:O}=a,z=r.get(c)?.name??c,N=r.get(O)?.name??O;z&&m.push(z),N&&m.push(N)}if(e?.map&&(0,K.n0)(e.map)&&e.map.utilityNetworks?.find(c=>c.isUtilityLayer(i))){const c=i.fieldsIndex.get("assetGroup")?.name,O=i.fieldsIndex.get("assetType")?.name;c&&O&&(m.push(c),m.push(O))}if(i&&d?.floorField&&e?.floors?.length){const c=r.get(d.floorField)?.name??d.floorField;c&&m.push(c)}if(h){const c=r.get(h)?.name??h;c&&m.push(c)}return new Set(m)}get configuration(){const{view:e}=this,{apiKey:t,customParameters:n}=this._layer,i=null!=e?e.type:"2d";return{filter:this._layer.createQuery(),customParameters:t?{...n,token:t}:n,viewType:i}}get availability(){return this._workerHandle?.availability??0}get _layer(){return this.layerSource.layer}constructor(e){super(e),this._updatingHandles=new k.R,this._workerHandle=null,this._debug=null,this._memoizedMakeGetGroundElevation=(0,D.H)(M.g)}initialize(){let e;const t=this.view;if(null==t||t.destroyed)this._tilesOfInterest=new I({layer:this._layer}),e=this._workerHandle=new g;else switch(t.type){case"2d":this._tilesOfInterest=new v({view:t,layer:this._layer}),e=this._workerHandle=new g;break;case"3d":{const{resourceController:n}=t,i=this._layer;this._tilesOfInterest=new S({view:t}),e=this._workerHandle=new g({schedule:r=>n.immediate.schedule(r),hasZ:this._layer.hasZ&&(this._layer.returnZ??!0),elevationAlignPointsInFeatures:(r=(0,p.Z)(function*(a,d){const h=yield t.whenLayerView(i);return(0,f.k_)(d),h.elevationAlignPointsInFeatures(a,d)}),function(d,h){return r.apply(this,arguments)}),queryForSymbologySnapping:function(){var r=(0,p.Z)(function*(a,d){const h=yield t.whenLayerView(i);return(0,f.k_)(d),h.queryForSymbologySnapping(a,d)});return function(d,h){return r.apply(this,arguments)}}()}),this.addHandles([t.elevationProvider.on("elevation-change",({context:r})=>{const{elevationInfo:a}=i;(0,A.W_)(r,a)&&(0,f.R8)(e.notifyElevationSourceChange())}),(0,u.YP)(()=>i.elevationInfo,()=>(0,f.R8)(e.notifyElevationSourceChange()),u.nn),(0,u.YP)(()=>this._layerView?.processor?.renderer,()=>(0,f.R8)(e.notifySymbologyChange()),u.nn),(0,u.YP)(()=>this._layerView?.symbologySnappingSupported??!1,r=>(0,f.R8)(e.setSymbologySnappingSupported(r)),u.nn),(0,u.on)(()=>this._layerView?.layer,["edits","apply-edits","graphic-update"],()=>e.notifySymbologyChange())]);break}}var r;this.addHandles([(0,F.ed)(e)]),(0,f.R8)(e.setup({layer:this._layer,spatialReference:this.spatialReference,configuration:this.configuration},null)),this._updatingHandles.add(()=>this._updateTilesParameters,()=>(0,f.R8)(e.updateTiles(this._updateTilesParameters,null)),u.nn),this.addHandles([(0,u.YP)(()=>this.configuration,n=>(0,f.R8)(e.configure(n,null)),u.Z_),(0,u.YP)(()=>this._outFields,n=>(0,f.R8)(e.updateOutFields(n)),u.nn),(0,u.YP)(()=>this._isSuspended,n=>(0,f.R8)(e.setSuspended(n)),u.tX)]),null!=t&&this.addHandles((0,u.YP)(()=>le.Z.FEATURE_SERVICE_SNAPPING_SOURCE_TILE_TREE_SHOW_TILES,n=>{n&&!this._debug?(this._debug=new T({view:t,handle:e}),this.addHandles((0,F.ed)(this._debug),"debug")):!n&&this._debug&&this.removeHandles("debug")},u.nn)),this.addHandles(this.layerSource.layer.on("apply-edits",n=>{(0,f.R8)(e.applyEdits(n,null))}))}destroy(){this._updatingHandles.destroy()}refresh(){this._workerHandle?.refresh(null)}fetchCandidates(e,t){var n=this;return(0,p.Z)(function*(){const{coordinateHelper:i,point:r}=e;n._tilesOfInterest.pointOfInterest=i.arrayToPoint(r);const a=n._memoizedMakeGetGroundElevation(n.view,i.spatialReference);return(yield n._workerHandle.fetchCandidates({...e},t)).candidates.map(d=>(0,M.X)(d,a))})()}getDebugInfo(e){return this._workerHandle.getDebugInfo(e)}_getOrLoadWhereFields(e,t){var n=this;const{_whereModule:i}=this;if(!this._loadWhereModuleTask&&!i){const r=(0,V.vr)((0,p.Z)(function*(){const a=yield Promise.all([o.e(337),o.e(774)]).then(o.bind(o,80774));return n._whereModule=a.WhereClause,n._whereModule}));return this._loadWhereModuleTask=r,this._updatingHandles.addPromise(r.promise),[]}if(!i)return[];try{return i.create(e,t).fieldNames}catch{return[]}}};(0,s._)([(0,l.Cb)({constructOnly:!0})],y.prototype,"spatialReference",void 0),(0,s._)([(0,l.Cb)({constructOnly:!0})],y.prototype,"layerSource",void 0),(0,s._)([(0,l.Cb)({constructOnly:!0})],y.prototype,"view",void 0),(0,s._)([(0,l.Cb)()],y.prototype,"_tilesOfInterest",void 0),(0,s._)([(0,l.Cb)({readOnly:!0})],y.prototype,"_updateTilesParameters",null),(0,s._)([(0,l.Cb)()],y.prototype,"_layerView",null),(0,s._)([(0,l.Cb)()],y.prototype,"_isSuspended",null),(0,s._)([(0,l.Cb)({readOnly:!0})],y.prototype,"updating",null),(0,s._)([(0,l.Cb)()],y.prototype,"_outFields",null),(0,s._)([(0,l.Cb)({readOnly:!0})],y.prototype,"configuration",null),(0,s._)([(0,l.Cb)({readOnly:!0})],y.prototype,"availability",null),(0,s._)([(0,l.Cb)()],y.prototype,"_loadWhereModuleTask",void 0),(0,s._)([(0,l.Cb)()],y.prototype,"_whereModule",void 0),y=(0,s._)([(0,C.j)("esri.views.interactive.snapping.featureSources.FeatureServiceSnappingSource")],y)}}]);