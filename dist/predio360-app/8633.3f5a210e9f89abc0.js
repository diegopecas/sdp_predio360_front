"use strict";(self.webpackChunkpredio360_app=self.webpackChunkpredio360_app||[]).push([[8633],{76279:(Re,_e,M)=>{M.d(_e,{r:()=>q});var U=M(14259);function q(v,I){if(!(this instanceof q))return new q(v,I);this._maxEntries=Math.max(4,v||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),I&&("function"==typeof I?this.toBBox=I:this._initFormat(I)),this.clear()}function N(v,I,F){if(!F)return I.indexOf(v);for(var w=0;w<I.length;w++)if(F(v,I[w]))return w;return-1}function C(v,I){Z(v,0,v.children.length,I,v)}function Z(v,I,F,w,P){P||(P=k(null)),P.minX=1/0,P.minY=1/0,P.maxX=-1/0,P.maxY=-1/0;for(var Q,z=I;z<F;z++)Q=v.children[z],O(P,v.leaf?w(Q):Q);return P}function O(v,I){return v.minX=Math.min(v.minX,I.minX),v.minY=Math.min(v.minY,I.minY),v.maxX=Math.max(v.maxX,I.maxX),v.maxY=Math.max(v.maxY,I.maxY),v}function H(v,I){return v.minX-I.minX}function B(v,I){return v.minY-I.minY}function X(v){return(v.maxX-v.minX)*(v.maxY-v.minY)}function ie(v){return v.maxX-v.minX+(v.maxY-v.minY)}function J(v,I){return(Math.max(I.maxX,v.maxX)-Math.min(I.minX,v.minX))*(Math.max(I.maxY,v.maxY)-Math.min(I.minY,v.minY))}function Y(v,I){var F=Math.max(v.minX,I.minX),w=Math.max(v.minY,I.minY),P=Math.min(v.maxX,I.maxX),Q=Math.min(v.maxY,I.maxY);return Math.max(0,P-F)*Math.max(0,Q-w)}function ae(v,I){return v.minX<=I.minX&&v.minY<=I.minY&&I.maxX<=v.maxX&&I.maxY<=v.maxY}function T(v,I){return I.minX<=v.maxX&&I.minY<=v.maxY&&I.maxX>=v.minX&&I.maxY>=v.minY}function k(v){return{children:v,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function D(v,I,F,w,P){for(var Q,z=[I,F];z.length;)(F=z.pop())-(I=z.pop())<=w||(Q=I+Math.ceil((F-I)/w/2)*w,(0,U.q)(v,Q,I,F,P),z.push(I,Q,Q,F))}q.prototype={all:function(){return this._all(this.data,[])},search:function(v){var I=this.data,F=[],w=this.toBBox;if(!T(v,I))return F;for(var P,Q,z,he,E=[];I;){for(P=0,Q=I.children.length;P<Q;P++)z=I.children[P],T(v,he=I.leaf?w(z):z)&&(I.leaf?F.push(z):ae(v,he)?this._all(z,F):E.push(z));I=E.pop()}return F},collides:function(v){var I=this.data,F=this.toBBox;if(!T(v,I))return!1;for(var w,P,Q,z,he=[];I;){for(w=0,P=I.children.length;w<P;w++)if(Q=I.children[w],T(v,z=I.leaf?F(Q):Q)){if(I.leaf||ae(v,z))return!0;he.push(Q)}I=he.pop()}return!1},load:function(v){if(!v||!v.length)return this;if(v.length<this._minEntries){for(var I=0,F=v.length;I<F;I++)this.insert(v[I]);return this}var w=this._build(v.slice(),0,v.length-1,0);if(this.data.children.length)if(this.data.height===w.height)this._splitRoot(this.data,w);else{if(this.data.height<w.height){var P=this.data;this.data=w,w=P}this._insert(w,this.data.height-w.height-1,!0)}else this.data=w;return this},insert:function(v){return v&&this._insert(v,this.data.height-1),this},clear:function(){return this.data=k([]),this},remove:function(v,I){if(!v)return this;for(var F,w,P,Q,z=this.data,he=this.toBBox(v),E=[],G=[];z||E.length;){if(z||(z=E.pop(),w=E[E.length-1],F=G.pop(),Q=!0),z.leaf&&-1!==(P=N(v,z.children,I)))return z.children.splice(P,1),E.push(z),this._condense(E),this;Q||z.leaf||!ae(z,he)?w?(F++,z=w.children[F],Q=!1):z=null:(E.push(z),G.push(F),F=0,w=z,z=z.children[0])}return this},toBBox:function(v){return v},compareMinX:H,compareMinY:B,toJSON:function(){return this.data},fromJSON:function(v){return this.data=v,this},_all:function(v,I){for(var F=[];v;)v.leaf?I.push.apply(I,v.children):F.push.apply(F,v.children),v=F.pop();return I},_build:function(v,I,F,w){var P,Q=F-I+1,z=this._maxEntries;if(Q<=z)return C(P=k(v.slice(I,F+1)),this.toBBox),P;w||(w=Math.ceil(Math.log(Q)/Math.log(z)),z=Math.ceil(Q/Math.pow(z,w-1))),(P=k([])).leaf=!1,P.height=w;var he,E,G,K,re=Math.ceil(Q/z),ge=re*Math.ceil(Math.sqrt(z));for(D(v,I,F,ge,this.compareMinX),he=I;he<=F;he+=ge)for(D(v,he,G=Math.min(he+ge-1,F),re,this.compareMinY),E=he;E<=G;E+=re)K=Math.min(E+re-1,G),P.children.push(this._build(v,E,K,w-1));return C(P,this.toBBox),P},_chooseSubtree:function(v,I,F,w){for(var P,Q,z,he,E,G,K,re;w.push(I),!I.leaf&&w.length-1!==F;){for(K=re=1/0,P=0,Q=I.children.length;P<Q;P++)E=X(z=I.children[P]),(G=J(v,z)-E)<re?(re=G,K=E<K?E:K,he=z):G===re&&E<K&&(K=E,he=z);I=he||I.children[0]}return I},_insert:function(v,I,F){var P=F?v:(0,this.toBBox)(v),Q=[],z=this._chooseSubtree(P,this.data,I,Q);for(z.children.push(v),O(z,P);I>=0&&Q[I].children.length>this._maxEntries;)this._split(Q,I),I--;this._adjustParentBBoxes(P,Q,I)},_split:function(v,I){var F=v[I],w=F.children.length,P=this._minEntries;this._chooseSplitAxis(F,P,w);var Q=this._chooseSplitIndex(F,P,w),z=k(F.children.splice(Q,F.children.length-Q));z.height=F.height,z.leaf=F.leaf,C(F,this.toBBox),C(z,this.toBBox),I?v[I-1].children.push(z):this._splitRoot(F,z)},_splitRoot:function(v,I){this.data=k([v,I]),this.data.height=v.height+1,this.data.leaf=!1,C(this.data,this.toBBox)},_chooseSplitIndex:function(v,I,F){var w,P,Q,z,he,E,G,K;for(E=G=1/0,w=I;w<=F-I;w++)z=Y(P=Z(v,0,w,this.toBBox),Q=Z(v,w,F,this.toBBox)),he=X(P)+X(Q),z<E?(E=z,K=w,G=he<G?he:G):z===E&&he<G&&(G=he,K=w);return K},_chooseSplitAxis:function(v,I,F){var w=v.leaf?this.compareMinX:H,P=v.leaf?this.compareMinY:B;this._allDistMargin(v,I,F,w)<this._allDistMargin(v,I,F,P)&&v.children.sort(w)},_allDistMargin:function(v,I,F,w){v.children.sort(w);var P,Q,z=this.toBBox,he=Z(v,0,I,z),E=Z(v,F-I,F,z),G=ie(he)+ie(E);for(P=I;P<F-I;P++)Q=v.children[P],O(he,v.leaf?z(Q):Q),G+=ie(he);for(P=F-I-1;P>=I;P--)Q=v.children[P],O(E,v.leaf?z(Q):Q),G+=ie(E);return G},_adjustParentBBoxes:function(v,I,F){for(var w=F;w>=0;w--)O(I[w],v)},_condense:function(v){for(var I,F=v.length-1;F>=0;F--)0===v[F].children.length?F>0?(I=v[F-1].children).splice(I.indexOf(v[F]),1):this.clear():C(v[F],this.toBBox)},_initFormat:function(v){var I=["return a"," - b",";"];this.compareMinX=new Function("a","b",I.join(v[0])),this.compareMinY=new Function("a","b",I.join(v[1])),this.toBBox=new Function("a","return {minX: a"+v[0]+", minY: a"+v[1]+", maxX: a"+v[2]+", maxY: a"+v[3]+"};")}}},7547:(Re,_e,M)=>{var U,q,N,C,Z,O,H,B,X,ie,J,Y,ae,T,k,D,v,I,F,w,P,Q,z,he,E,G,K,re,ge,Pe,me,Et,be,vt,it,nt,at,Dt,wt,ot,Je,Ke,xt,Le,ze,Ge,ut,je,Ut,St,ht,We,Qe,$e,Rt,Ye,dt,et,bt,Bt,Ct,p;M.d(_e,{$y:()=>Q,AH:()=>q,CS:()=>ut,DD:()=>B,Dd:()=>ge,Em:()=>P,JS:()=>ze,Ky:()=>X,Lh:()=>je,Qb:()=>dt,RL:()=>U,RS:()=>bt,TF:()=>w,Tx:()=>Z,UR:()=>v,UX:()=>Ye,bj:()=>Ge,eZ:()=>H,id:()=>E,kP:()=>nt,r4:()=>ot,sj:()=>at,v2:()=>N,zQ:()=>re,zV:()=>D}),(p=U||(U={}))[p.BUTT=0]="BUTT",p[p.ROUND=1]="ROUND",p[p.SQUARE=2]="SQUARE",p[p.UNKNOWN=4]="UNKNOWN",function(p){p[p.BEVEL=0]="BEVEL",p[p.ROUND=1]="ROUND",p[p.MITER=2]="MITER",p[p.UNKNOWN=4]="UNKNOWN"}(q||(q={})),function(p){p[p.SCREEN=0]="SCREEN",p[p.MAP=1]="MAP"}(N||(N={})),function(p){p[p.Tint=0]="Tint",p[p.Ignore=1]="Ignore",p[p.Multiply=99]="Multiply"}(C||(C={})),function(p){p.Both="Both",p.JustBegin="JustBegin",p.JustEnd="JustEnd",p.None="None"}(Z||(Z={})),function(p){p[p.Mosaic=0]="Mosaic",p[p.Centered=1]="Centered"}(O||(O={})),function(p){p[p.Normal=0]="Normal",p[p.Superscript=1]="Superscript",p[p.Subscript=2]="Subscript"}(H||(H={})),function(p){p[p.MSSymbol=0]="MSSymbol",p[p.Unicode=1]="Unicode"}(B||(B={})),function(p){p[p.Unspecified=0]="Unspecified",p[p.TrueType=1]="TrueType",p[p.PSOpenType=2]="PSOpenType",p[p.TTOpenType=3]="TTOpenType",p[p.Type1=4]="Type1"}(X||(X={})),function(p){p[p.Display=0]="Display",p[p.Map=1]="Map"}(ie||(ie={})),function(p){p.None="None",p.Loop="Loop",p.Oscillate="Oscillate"}(J||(J={})),function(p){p[p.Z=0]="Z",p[p.X=1]="X",p[p.Y=2]="Y"}(Y||(Y={})),function(p){p[p.XYZ=0]="XYZ",p[p.ZXY=1]="ZXY",p[p.YXZ=2]="YXZ"}(ae||(ae={})),function(p){p[p.Rectangle=0]="Rectangle",p[p.RoundedRectangle=1]="RoundedRectangle",p[p.Oval=2]="Oval"}(T||(T={})),function(p){p[p.None=0]="None",p[p.Alpha=1]="Alpha",p[p.Screen=2]="Screen",p[p.Multiply=3]="Multiply",p[p.Add=4]="Add"}(k||(k={})),function(p){p[p.TTB=0]="TTB",p[p.RTL=1]="RTL",p[p.BTT=2]="BTT"}(D||(D={})),function(p){p[p.None=0]="None",p[p.SignPost=1]="SignPost",p[p.FaceNearPlane=2]="FaceNearPlane"}(v||(v={})),function(p){p[p.Float=0]="Float",p[p.String=1]="String",p[p.Boolean=2]="Boolean"}(I||(I={})),function(p){p[p.Intersect=0]="Intersect",p[p.Subtract=1]="Subtract"}(F||(F={})),function(p){p.OpenEnded="OpenEnded",p.Block="Block",p.Crossed="Crossed"}(w||(w={})),function(p){p.FullGeometry="FullGeometry",p.PerpendicularFromFirstSegment="PerpendicularFromFirstSegment",p.ReversedFirstSegment="ReversedFirstSegment",p.PerpendicularToSecondSegment="PerpendicularToSecondSegment",p.SecondSegmentWithTicks="SecondSegmentWithTicks",p.DoublePerpendicular="DoublePerpendicular",p.OppositeToFirstSegment="OppositeToFirstSegment",p.TriplePerpendicular="TriplePerpendicular",p.HalfCircleFirstSegment="HalfCircleFirstSegment",p.HalfCircleSecondSegment="HalfCircleSecondSegment",p.HalfCircleExtended="HalfCircleExtended",p.OpenCircle="OpenCircle",p.CoverageEdgesWithTicks="CoverageEdgesWithTicks",p.GapExtentWithDoubleTicks="GapExtentWithDoubleTicks",p.GapExtentMidline="GapExtentMidline",p.Chevron="Chevron",p.PerpendicularWithArc="PerpendicularWithArc",p.ClosedHalfCircle="ClosedHalfCircle",p.TripleParallelExtended="TripleParallelExtended",p.ParallelWithTicks="ParallelWithTicks",p.Parallel="Parallel",p.PerpendicularToFirstSegment="PerpendicularToFirstSegment",p.ParallelOffset="ParallelOffset",p.OffsetOpposite="OffsetOpposite",p.OffsetSame="OffsetSame",p.CircleWithArc="CircleWithArc",p.DoubleJog="DoubleJog",p.PerpendicularOffset="PerpendicularOffset",p.LineExcludingLastSegment="LineExcludingLastSegment",p.MultivertexArrow="MultivertexArrow",p.CrossedArrow="CrossedArrow",p.ChevronArrow="ChevronArrow",p.ChevronArrowOffset="ChevronArrowOffset",p.PartialFirstSegment="PartialFirstSegment",p.Arch="Arch",p.CurvedParallelTicks="CurvedParallelTicks",p.Arc90Degrees="Arc90Degrees"}(P||(P={})),function(p){p.Mitered="Mitered",p.Bevelled="Bevelled",p.Rounded="Rounded",p.Square="Square",p.TrueBuffer="TrueBuffer"}(Q||(Q={})),function(p){p.ClosePath="ClosePath",p.ConvexHull="ConvexHull",p.RectangularBox="RectangularBox"}(z||(z={})),function(p){p.BeginningOfLine="BeginningOfLine",p.EndOfLine="EndOfLine"}(he||(he={})),function(p){p.Mitered="Mitered",p.Bevelled="Bevelled",p.Rounded="Rounded",p.Square="Square"}(E||(E={})),function(p){p.Fast="Fast",p.Accurate="Accurate"}(G||(G={})),function(p){p.BeginningOfLine="BeginningOfLine",p.EndOfLine="EndOfLine"}(K||(K={})),function(p){p.Sinus="Sinus",p.Square="Square",p.Triangle="Triangle",p.Random="Random"}(re||(re={})),function(p){p[p.None=0]="None",p[p.Default=1]="Default",p[p.Force=2]="Force"}(ge||(ge={})),function(p){p[p.Buffered=0]="Buffered",p[p.Left=1]="Left",p[p.Right=2]="Right",p[p.AlongLine=3]="AlongLine"}(Pe||(Pe={})),function(p){p[p.Linear=0]="Linear",p[p.Rectangular=1]="Rectangular",p[p.Circular=2]="Circular",p[p.Buffered=3]="Buffered"}(me||(me={})),function(p){p[p.Discrete=0]="Discrete",p[p.Continuous=1]="Continuous"}(Et||(Et={})),function(p){p[p.AcrossLine=0]="AcrossLine",p[p.AloneLine=1]="AloneLine"}(be||(be={})),function(p){p[p.Left=0]="Left",p[p.Right=1]="Right",p[p.Center=2]="Center",p[p.Justify=3]="Justify"}(vt||(vt={})),function(p){p[p.Base=0]="Base",p[p.MidPoint=1]="MidPoint",p[p.ThreePoint=2]="ThreePoint",p[p.FourPoint=3]="FourPoint",p[p.Underline=4]="Underline",p[p.CircularCW=5]="CircularCW",p[p.CircularCCW=6]="CircularCCW"}(it||(it={})),function(p){p.Butt="Butt",p.Round="Round",p.Square="Square"}(nt||(nt={})),function(p){p.NoConstraint="NoConstraint",p.HalfPattern="HalfPattern",p.HalfGap="HalfGap",p.FullPattern="FullPattern",p.FullGap="FullGap",p.Custom="Custom"}(at||(at={})),function(p){p[p.None=-1]="None",p[p.Custom=0]="Custom",p[p.Circle=1]="Circle",p[p.OpenArrow=2]="OpenArrow",p[p.ClosedArrow=3]="ClosedArrow",p[p.Diamond=4]="Diamond"}(Dt||(Dt={})),function(p){p[p.ExtraLeading=0]="ExtraLeading",p[p.Multiple=1]="Multiple",p[p.Exact=2]="Exact"}(wt||(wt={})),function(p){p.Bevel="Bevel",p.Round="Round",p.Miter="Miter"}(ot||(ot={})),function(p){p[p.Default=0]="Default",p[p.String=1]="String",p[p.Numeric=2]="Numeric"}(Je||(Je={})),function(p){p[p.InsidePolygon=0]="InsidePolygon",p[p.PolygonCenter=1]="PolygonCenter",p[p.RandomlyInsidePolygon=2]="RandomlyInsidePolygon"}(Ke||(Ke={})),function(p){p[p.Tint=0]="Tint",p[p.Replace=1]="Replace",p[p.Multiply=2]="Multiply"}(xt||(xt={})),function(p){p[p.ClipAtBoundary=0]="ClipAtBoundary",p[p.RemoveIfCenterOutsideBoundary=1]="RemoveIfCenterOutsideBoundary",p[p.DoNotTouchBoundary=2]="DoNotTouchBoundary",p[p.DoNotClip=3]="DoNotClip"}(Le||(Le={})),function(p){p.NoConstraint="NoConstraint",p.WithMarkers="WithMarkers",p.WithFullGap="WithFullGap",p.WithHalfGap="WithHalfGap",p.Custom="Custom"}(ze||(ze={})),function(p){p.Fixed="Fixed",p.Random="Random",p.RandomFixedQuantity="RandomFixedQuantity"}(Ge||(Ge={})),function(p){p.LineMiddle="LineMiddle",p.LineBeginning="LineBeginning",p.LineEnd="LineEnd",p.SegmentMidpoint="SegmentMidpoint"}(ut||(ut={})),function(p){p.OnPolygon="OnPolygon",p.CenterOfMass="CenterOfMass",p.BoundingBoxCenter="BoundingBoxCenter"}(je||(je={})),function(p){p[p.Low=0]="Low",p[p.Medium=1]="Medium",p[p.High=2]="High"}(Ut||(Ut={})),function(p){p[p.MarkerCenter=0]="MarkerCenter",p[p.MarkerBounds=1]="MarkerBounds"}(St||(St={})),function(p){p[p.None=0]="None",p[p.PropUniform=1]="PropUniform",p[p.PropNonuniform=2]="PropNonuniform",p[p.DifUniform=3]="DifUniform",p[p.DifNonuniform=4]="DifNonuniform"}(ht||(ht={})),function(p){p.Tube="Tube",p.Strip="Strip",p.Wall="Wall"}(We||(We={})),function(p){p[p.Random=0]="Random",p[p.Increasing=1]="Increasing",p[p.Decreasing=2]="Decreasing",p[p.IncreasingThenDecreasing=3]="IncreasingThenDecreasing"}(Qe||(Qe={})),function(p){p[p.Relative=0]="Relative",p[p.Absolute=1]="Absolute"}($e||($e={})),function(p){p[p.Normal=0]="Normal",p[p.LowerCase=1]="LowerCase",p[p.Allcaps=2]="Allcaps"}(Rt||(Rt={})),function(p){p[p.LTR=0]="LTR",p[p.RTL=1]="RTL"}(Ye||(Ye={})),function(p){p.Draft="Draft",p.Picture="Picture",p.Text="Text"}(dt||(dt={})),function(p){p[p.Top=0]="Top",p[p.Center=1]="Center",p[p.Baseline=2]="Baseline",p[p.Bottom=3]="Bottom"}(et||(et={})),function(p){p[p.Right=0]="Right",p[p.Upright=1]="Upright"}(bt||(bt={})),function(p){p[p.Small=0]="Small",p[p.Medium=1]="Medium",p[p.Large=2]="Large"}(Bt||(Bt={})),function(p){p[p.Calm=0]="Calm",p[p.Rippled=1]="Rippled",p[p.Slight=2]="Slight",p[p.Moderate=3]="Moderate"}(Ct||(Ct={}))},99666:(Re,_e,M)=>{M.d(_e,{KS:()=>X,PX:()=>Z,QS:()=>J,_I:()=>U,jL:()=>B,nE:()=>ie,vs:()=>H,xp:()=>O});const U=8388607,q=8388608,Z=0,O=1,H=Y=>(Y&q)>>>23,B=Y=>Y&U,X=Y=>H(Y)===O?254:255;function ie(Y){return H(Y)===O}function J(Y,ae){return((ae?q:0)|Y)>>>0}},87526:(Re,_e,M)=>{M.d(_e,{$_:()=>he,UK:()=>Le,ws:()=>nt,xV:()=>at});var U=M(26584),q=M(63290),N=M(7547),C=M(39406),Z=M(67969);const O=q.Z.getLogger("esri.views.2d.engine.webgl.Utils"),H="geometry",B=[{name:H,strideInBytes:12}],X=[{name:H,strideInBytes:36}],ie=[{name:H,strideInBytes:24}],J=[{name:H,strideInBytes:12}],Y=[{name:H,strideInBytes:40}],ae=[{name:H,strideInBytes:36}],T=[{name:H,strideInBytes:36}];function k(A){const le={};for(const oe of A)le[oe.name]=oe.strideInBytes;return le}const D=k([{name:H,strideInBytes:36}]),v=k(B),I=k(X),F=k(ie),w=k(J),P=k(Y),Q=k(ae),z=k(T);function he(A,le){switch(A){case C.LW.MARKER:return le===C.mD.HEATMAP?v:D;case C.LW.FILL:switch(le){case C.mD.DOT_DENSITY:return w;case C.mD.SIMPLE:case C.mD.OUTLINE_FILL_SIMPLE:return F;default:return I}case C.LW.LINE:return P;case C.LW.TEXT:return Q;case C.LW.LABEL:return z}}function nt(A){switch(A){case"butt":return N.RL.BUTT;case"round":return N.RL.ROUND;case"square":return N.RL.SQUARE;default:return O.error(new U.Z("mapview-invalid-type",`Cap type ${A} is not a valid option. Defaulting to round`)),N.RL.ROUND}}function at(A){switch(A){case"miter":return N.AH.MITER;case"bevel":return N.AH.BEVEL;case"round":return N.AH.ROUND;default:return O.error(new U.Z("mapview-invalid-type",`Join type ${A} is not a valid option. Defaulting to round`)),N.AH.ROUND}}function Le(A){switch(A){case Z.Br.UNSIGNED_BYTE:return Uint8Array;case Z.Br.UNSIGNED_SHORT_4_4_4_4:return Uint16Array;case Z.Br.FLOAT:return Float32Array;default:return void O.error(new U.Z("webgl-utils",`Unable to handle type ${A}`))}}},81295:(Re,_e,M)=>{M.d(_e,{aH:()=>C,t2:()=>N});var U=M(5254);function N(O){if(!O)return 0;const{r:H,g:B,b:X,a:ie}=O;return(0,U.Jz)(H*ie,B*ie,X*ie,255*ie)}function C(O){if(!O)return 0;const[H,B,X,ie]=O;return(0,U.Jz)(H*(ie/255),B*(ie/255),X*(ie/255),ie)}},39351:(Re,_e,M)=>{M.d(_e,{AI:()=>N,C1:()=>p,CQ:()=>lt,CU:()=>Qe,Ex:()=>P,I_:()=>O,Ip:()=>et,Iv:()=>oe,Iw:()=>Q,MI:()=>Ct,SD:()=>Me,Tz:()=>De,Uh:()=>jt,V4:()=>We,XJ:()=>dt,_6:()=>xe,a:()=>$e,aK:()=>Ke,e0:()=>le,fL:()=>Ye,jk:()=>Se,m4:()=>ze,oK:()=>A,pU:()=>Je,ru:()=>Z,tQ:()=>St,uG:()=>Ge,vw:()=>Be,xl:()=>ot,xm:()=>ae});const N=1e-30,Z=4294967295,O=512,ae=29,P=24,Q=8,ot=1,Je=2,Ke=3,ze=2,Ge=1,St=1.05,We=5,Qe=6,$e=1.15,Ye=2,dt=8,et=500,Ct=10,p=1024,jt=2,lt=0,De=1,A=4,le=8,oe=16,xe=4,Me=1,Se=4,Be=8},5254:(Re,_e,M)=>{M.d(_e,{Au:()=>Y,Jz:()=>k,UJ:()=>T});const U=new Float32Array(1);function Y(I){return[255&I,(65280&I)>>>8,(16711680&I)>>>16,(4278190080&I)>>>24]}function T(I,F){return 65535&I|F<<16}function k(I,F,w,P){return 255&I|(255&F)<<8|(255&w)<<16|P<<24}new Uint32Array(U.buffer)},55746:(Re,_e,M)=>{M.d(_e,{k:()=>ae,p:()=>T});var U=M(65389),q=M(61885),C=(M(8314),M(62208)),Z=M(76279),O=M(5548),H=M(16669),B=M(52397);const X=(0,O.Ue)();function ie(k,D){return k<<16|D}function J(k){return(4294901760&k)>>>16}function Y(k){return 65535&k}const ae={getObjectId:k=>k.getObjectId(),getAttributes:k=>k.readAttributes(),getAttribute:(k,D)=>k.readAttribute(D),cloneWithGeometry:(k,D)=>k,getGeometry:k=>k.readHydratedGeometry(),getCentroid:(k,D)=>k.readCentroid()};class T extends H.J{constructor(D,v,I){super(D,v),this.featureAdapter=ae,this.events=new q.Z,this._featureSetsByInstance=new Map,this._objectIdToDisplayId=new Map,this._spatialIndexInvalid=!0,this._indexSearchCache=new U.Z(50),this._index=(0,Z.r)(9,F=>({minX:this._storage.getXMin(F),minY:this._storage.getYMin(F),maxX:this._storage.getXMax(F),maxY:this._storage.getYMax(F)})),this.mode=I}get storeStatistics(){let D=0,v=0,I=0;return this.forEach(F=>{const w=F.readGeometry();w&&(v+=w.isPoint?1:w.lengths.reduce((P,Q)=>P+Q,0),I+=w.isPoint?1:w.lengths.length,D+=1)}),{featureCount:D,vertexCount:v,ringCount:I}}hasInstance(D){return this._featureSetsByInstance.has(D)}onTileData(D,v){if((0,C.Wi)(v.addOrUpdate))return v;if(v.addOrUpdate.attachStorage(this._storage),"snapshot"===this.mode){const F=v.addOrUpdate.getCursor();for(;F.next();){const w=F.getDisplayId();this.setComputedAttributes(this._storage,F,w,D.scale)}return v}this._featureSetsByInstance.set(v.addOrUpdate.instance,v.addOrUpdate);const I=v.addOrUpdate.getCursor();for(;I.next();)this._insertFeature(I,D.scale);return this._spatialIndexInvalid=!0,this.events.emit("changed"),v}search(D){this._rebuildIndex();const v=D.id,I=this._indexSearchCache.find(Q=>Q.tileId===v);if((0,C.pC)(I))return I.readers;const F=new Map,w=this._searchIndex(D.bounds),P=[];for(const Q of w){const z=this._storage.getInstanceId(Q),he=J(z),E=Y(z);F.has(he)||F.set(he,[]),F.get(he).push(E)}return F.forEach((Q,z)=>{const he=this._featureSetsByInstance.get(z);P.push(B.t.from(he,Q))}),this._indexSearchCache.enqueue({tileId:v,readers:P}),P}insert(D){const v=D.getCursor(),I=this._storage;for(;v.next();){const F=ie(v.instance,v.getIndex()),w=v.getObjectId(),P=this._objectIdToDisplayId.get(w)??this._storage.createDisplayId();v.setDisplayId(P),I.setInstanceId(P,F),this._objectIdToDisplayId.set(w,P)}this._featureSetsByInstance.set(D.instance,D),this._spatialIndexInvalid=!0}remove(D){const v=this._objectIdToDisplayId.get(D);if(!v)return;const I=this._storage.getInstanceId(v),F=Y(I),w=J(I),P=this._featureSetsByInstance.get(w);this._objectIdToDisplayId.delete(D),this._storage.releaseDisplayId(v),P.removeAtIndex(F),P.isEmpty&&this._featureSetsByInstance.delete(w),this._spatialIndexInvalid=!0}forEach(D){this._objectIdToDisplayId.forEach(v=>{const I=this._storage.getInstanceId(v),F=this._lookupFeature(I);D(F)})}forEachUnsafe(D){this._objectIdToDisplayId.forEach(v=>{const I=this._storage.getInstanceId(v),F=J(I),w=Y(I),P=this._getFeatureSet(F);P.setIndex(w),D(P)})}forEachInBounds(D,v){const I=this._searchIndex(D);for(const F of I){const w=this.lookupFeatureByDisplayId(F,this._storage);v((0,C.Wg)(w))}}forEachBounds(D,v){this._rebuildIndex();for(const I of D){if(!I.readGeometry())continue;const F=I.getDisplayId();(0,O.bZ)(X,this._storage.getXMin(F),this._storage.getYMin(F),this._storage.getXMax(F),this._storage.getYMax(F)),v(X)}}sweepFeatures(D,v,I){this._spatialIndexInvalid=!0,this._objectIdToDisplayId.forEach((F,w)=>{D.has(F)||(v.releaseDisplayId(F),I&&I.unsetAttributeData(F),this._objectIdToDisplayId.delete(w))}),this.events.emit("changed")}sweepFeatureSets(D){this._spatialIndexInvalid=!0,this._featureSetsByInstance.forEach((v,I)=>{D.has(I)||this._featureSetsByInstance.delete(I)})}lookupObjectId(D,v){const I=this.lookupFeatureByDisplayId(D,v);return(0,C.Wi)(I)?null:I.getObjectId()}lookupDisplayId(D){return this._objectIdToDisplayId.get(D)}lookupFeatureByDisplayId(D,v){const I=v.getInstanceId(D);return this._lookupFeature(I)}lookupByDisplayIdUnsafe(D){const v=this._storage.getInstanceId(D),I=J(v),F=Y(v),w=this._getFeatureSet(I);return w?(w.setIndex(F),w):null}_insertFeature(D,v){const I=this._storage,F=D.getObjectId(),w=ie(D.instance,D.getIndex());I.getInstanceId(D.getDisplayId());let P=this._objectIdToDisplayId.get(F);P||(P=I.createDisplayId(),this._objectIdToDisplayId.set(F,P),this._spatialIndexInvalid=!0),D.setDisplayId(P),I.setInstanceId(P,w),this.setComputedAttributes(I,D,P,v)}_searchIndex(D){return this._rebuildIndex(),this._index.search({minX:D[0],minY:D[1],maxX:D[2],maxY:D[3]})}_rebuildIndex(){if(!this._spatialIndexInvalid)return;const D=[];"snapshot"===this.mode?this._featureSetsByInstance.forEach(v=>{const I=v.getCursor();for(;I.next();){const F=I.getDisplayId();this._storage.setBounds(F,I)&&D.push(F)}}):this._objectIdToDisplayId.forEach(v=>{const I=this._storage.getInstanceId(v);this._storage.setBounds(v,this._lookupFeature(I))&&D.push(v)}),this._index.clear(),this._index.load(D),this._indexSearchCache.clear(),this._spatialIndexInvalid=!1}_lookupFeature(D){const v=J(D),I=this._getFeatureSet(v);if(!I)return;const F=I.getCursor(),w=Y(D);return F.setIndex(w),F}_getFeatureSet(D){return this._featureSetsByInstance.get(D)}}},78633:(Re,_e,M)=>{M.r(_e),M.d(_e,{default:()=>Dr});var U=M(15861),q=M(17626),N=M(80542),C=M(8314),Z=M(32917),O=M(77712),X=(M(90912),M(85931),M(76898)),ie=M(37053),J=M(2584),ae=M(14517),T=M(62208),k=M(10699),D=M(82054),v=M(58175),I=M(60466),F=M(55746),w=M(38305),P=M(84792),Q=M(26584),z=M(63290),he=M(93662),E=M(7848),G=M(89628),K=M(20477),re=M(66385),ge=M(25208);class me extends ge.s{static fromFeatures(a,h){const{objectIdField:d,geometryType:c}=h,f=(0,D.Yn)([],a,c,!1,!1,d);for(let _=0;_<f.length;_++)f[_].displayId=a[_].displayId;return me.fromOptimizedFeatures(f,h)}static fromFeatureSet(a,h){const d=(0,D.h_)(a,h.objectIdField);return me.fromOptimizedFeatureSet(d,h)}static fromOptimizedFeatureSet(a,h){const{features:d}=a,c=me.fromOptimizedFeatures(d,h);c._exceededTransferLimit=a.exceededTransferLimit,c._transform=a.transform;for(const f of a.fields)"esriFieldTypeDate"===f.type&&c._dateFields.add(f.name);return c}static fromOptimizedFeatures(a,h,d){const c=ge.s.createInstance(),f=new me(c,a,h);return f._transform=d,f}constructor(a,h,d){super(a,d),this._exceededTransferLimit=!1,this._featureIndex=-1,this._dateFields=new Set,this._geometryType=d?.geometryType,this._features=h}get _current(){return this._features[this._featureIndex]}get geometryType(){return this._geometryType}get hasFeatures(){return!!this._features.length}get hasNext(){return this._featureIndex+1<this._features.length}get exceededTransferLimit(){return this._exceededTransferLimit}get hasZ(){return!1}get hasM(){return!1}removeIds(a){const h=new Set(a);this._features=this._features.filter(d=>!(d.objectId&&h.has(d.objectId)))}append(a){for(const h of a)this._features.push(h)}getSize(){return this._features.length}getCursor(){return this.copy()}getQuantizationTransform(){return this._transform}getAttributeHash(){let a="";for(const h in this._current.attributes)a+=this._current.attributes[h];return a}getIndex(){return this._featureIndex}setIndex(a){this._featureIndex=a}getObjectId(){return this._current?.objectId}getDisplayId(){return this._current.displayId}setDisplayId(a){this._current.displayId=a}getGroupId(){return this._current.groupId}setGroupId(a){this._current.groupId=a}copy(){const a=new me(this.instance,this._features,this.fullSchema());return this.copyInto(a),a}next(){for(;++this._featureIndex<this._features.length&&!this._getExists(););return this._featureIndex<this._features.length}readLegacyFeature(){return(0,D.EI)(this._current,this.geometryType,this.hasZ,this.hasM)}readOptimizedFeature(){return this._current}readLegacyPointGeometry(){return this.readGeometry()?{x:this.getX(),y:this.getY()}:null}readLegacyGeometry(){const a=this.readGeometry();return(0,D.di)(a,this.geometryType,this.hasZ,this.hasM)}readLegacyCentroid(){const a=this.readCentroid();return(0,T.Wi)(a)?null:{x:a.coords[0]*this._sx+this._tx,y:a.coords[1]*this._sy+this._ty}}readGeometryArea(){return(0,re.S6)(this._current)?(0,D.lz)(this._current.geometry,2):0}readUnquantizedGeometry(){const a=this.readGeometry();if("esriGeometryPoint"===this.geometryType||!a)return a;const h=a.clone();return function Pe({coords:g,lengths:a}){let h=0;for(const d of a){for(let c=1;c<d;c++)g[2*(h+c)]+=g[2*(h+c)-2],g[2*(h+c)+1]+=g[2*(h+c)-1];h+=d}}(h),h}readHydratedGeometry(){const a=this._current.geometry;if((0,T.Wi)(a))return null;const h=a.clone();return(0,T.pC)(this._transform)&&(0,D.$g)(h,h,this.hasZ,this.hasM,this._transform),h}getXHydrated(){if(!(0,re.S6)(this._current))return 0;const a=this._current.geometry.coords[0],h=this.getQuantizationTransform();return(0,T.Wi)(h)?a:a*h.scale[0]+h.translate[0]}getYHydrated(){if(!(0,re.S6)(this._current))return 0;const a=this._current.geometry.coords[1],h=this.getQuantizationTransform();return(0,T.Wi)(h)?a:h.translate[1]-a*h.scale[1]}getX(){return(0,re.S6)(this._current)?this._current.geometry.coords[0]*this._sx+this._tx:0}getY(){return(0,re.S6)(this._current)?this._current.geometry.coords[1]*this._sy+this._ty:0}readGeometry(){if(!(0,re.S6)(this._current)){if((0,T.pC)(this._current.centroid)){const[d,c]=this._current.centroid.coords;return this.createQuantizedExtrudedQuad(d,c)}return null}const a=this._current.geometry.clone();if(a.isPoint)return a.coords[0]=a.coords[0]*this._sx+this._tx,a.coords[1]=a.coords[1]*this._sy+this._ty,a;let h=0;for(const d of a.lengths)a.coords[2*h]=a.coords[2*h]*this._sx+this._tx,a.coords[2*h+1]=a.coords[2*h+1]*this._sy+this._ty,h+=d;return a}readCentroid(){return(0,re.S6)(this._current)?this._computeCentroid():this._current.centroid}hasField(a){return a in this._current.attributes||this.getFieldNames().map(h=>h.toLowerCase()).includes(a.toLowerCase())}getFieldNames(){return Object.keys(this._current.attributes)}_readAttribute(a,h){const d=this._current.attributes[a];if(void 0!==d)return null!=d&&h&&this._dateFields.has(a)?new Date(d):d;const c=this.readAttributes(),f=a?.toLocaleLowerCase().trim();for(const _ in c)if(_.toLocaleLowerCase().trim()===f){const m=this._current.attributes[_];return null!=m&&h&&this._dateFields.has(_)?new Date(m):m}}copyInto(a){super.copyInto(a),a._featureIndex=this._featureIndex,a._transform=this._transform,a._dateFields=this._dateFields}_readAttributes(){return this._current.attributes}}var Et=M(24192),be=M(88071),vt=M(71260);const it=268435455;class nt{constructor(){this.fieldMap=new Map,this.fields=[],this.hasFeatures=!1,this.exceededTransferLimit=!1,this.fieldCount=0,this.featureCount=0,this.objectIdFieldIndex=0,this.vertexCount=0,this.offsets={attributes:new Array,geometry:new Array},this.centroid=new Array}hasField(a){return this.fieldMap.has(a)}isDateField(a){return(null!=a&&this.fieldMap.get(a)?.isDate)??!1}getFieldIndex(a){return null!=a?this.fieldMap.get(a)?.index:void 0}}function at(g){const d=g.asUnsafe(),c=d.getLength(),f=d.pos()+c,_={name:"",isDate:!1};for(;d.pos()<f&&d.next();)switch(d.tag()){case 1:_.name=d.getString();break;case 2:"esriFieldTypeDate"===(0,vt.O7)(d.getEnum())&&(_.isDate=!0);break;default:d.skip()}return _}function Dt(g){return g.toLowerCase().trim()}const Je=268435455,Le={small:{delta:new Int32Array(128),decoded:new Int32Array(128)},large:{delta:new Int32Array(128e3),decoded:new Int32Array(128e3)}};function ze(g){return g<=Le.small.delta.length?Le.small:(g<=Le.large.delta.length||(Le.large.delta=new Int32Array(Math.round(1.25*g)),Le.large.decoded=new Int32Array(Math.round(1.25*g))),Le.large)}function Ge(g){return g.toLowerCase().trim()}function je(g){for(;g.next();){if(1===g.tag())return g.getMessage();g.skip()}return null}function St(g,a,h,d,c,f){return.5*Math.abs(g*d+h*f+c*a-g*f-h*a-c*d)}function ht(g,a,h,d){return g*d-h*a==0&&g*h+a*d>0}class We extends ge.s{static fromBuffer(a,h,d=!1){const c=h.geometryType,f=function ut(g){try{const h=new Et.Z(new Uint8Array(g),new DataView(g));for(;h.next();){if(2===h.tag())return je(h.getMessage());h.skip()}}catch(a){const h=new Q.Z("query:parsing-pbf","Error while parsing FeatureSet PBF payload",{error:a});z.Z.getLogger("esri.view.2d.layers.features.support.FeatureSetReaderPBF").error(h)}return null}(a),_=function wt(g,a,h=!1){const y=g.asUnsafe(),S=y.pos(),b=new nt;let R=0,L=0,se=null,te=null,ee=null,ne=!1;for(;y.next();)switch(y.tag()){case 1:se=y.getString();break;case 3:te=y.getString();break;case 12:ee=y.processMessage(vt.G$);break;case 9:if(b.exceededTransferLimit=y.getBool(),b.exceededTransferLimit){b.offsets.geometry=h?new Float64Array(8e3):new Int32Array(8e3),b.centroid=h?new Float64Array(16e3):new Int32Array(16e3);for(let ue=0;ue<b.centroid.length;ue++)b.centroid[ue]=it}break;case 13:{const ue=at(g),Ie=ue.name,ve=Dt(ue.name),de={fieldName:Ie,index:R++,isDate:ue.isDate};b.fields.push(de),b.fieldMap.set(ue.name,de),b.fieldMap.set(ve,de);break}case 15:{const ue=y.getLength(),Ie=y.pos()+ue;if(!b.exceededTransferLimit){const pe=b.centroid;b.offsets.geometry.push(0),pe.push(it),pe.push(it)}!ne&&b.exceededTransferLimit&&(ne=!0,b.offsets.attributes=h?new Float64Array(8e3*R):new Uint32Array(8e3*R));let ve=L*R;for(;y.pos()<Ie&&y.next();)switch(y.tag()){case 1:{ne?b.offsets.attributes[ve++]=y.pos():b.offsets.attributes.push(y.pos());const de=y.getLength();y.skipLen(de);break}case 2:if(a){const de=y.getLength(),pe=y.pos()+de;for(;y.pos()<pe&&y.next();)switch(y.tag()){case 3:{y.getUInt32();const ye=y.getSInt64(),Te=y.getSInt64();b.centroid[2*L]=ye,b.centroid[2*L+1]=Te;break}default:y.skip()}}else{b.offsets.geometry[L]=y.pos();const de=y.getLength();b.vertexCount+=de,y.skipLen(de)}break;case 4:{const de=y.getLength(),pe=y.pos()+de;for(;y.pos()<pe&&y.next();)switch(y.tag()){case 3:{y.getUInt32();const ye=y.getSInt64(),Te=y.getSInt64();b.centroid[2*L]=ye,b.centroid[2*L+1]=Te;break}default:y.skip()}break}default:y.skip()}L++,b.hasFeatures=!0;break}default:y.skip()}const ce=se||te;if(!ce)throw new Q.Z("FeatureSet has no objectId or globalId field name");return b.featureCount=L,b.fieldCount=R,b.objectIdFieldIndex=b.getFieldIndex(ce),b.transform=ee,b.displayIds=new Uint32Array(b.featureCount),b.groupIds=new Uint16Array(b.featureCount),y.move(S),b}(f,"esriGeometryPoint"===c,d),m=ge.s.createInstance();return new We(m,f,_,h)}constructor(a,h,d,c){super(a,c),this._hasNext=!1,this._isPoints=!1,this._featureIndex=-1,this._featureOffset=0,this._cache={area:0,unquantGeometry:void 0,geometry:void 0,centroid:void 0,legacyFeature:void 0,optFeature:void 0},this._geometryType=c.geometryType,this._reader=h,this._header=d,this._hasNext=d.hasFeatures,this._isPoints="esriGeometryPoint"===c.geometryType}get geometryType(){return this._geometryType}get _size(){return this._header.featureCount}get hasZ(){return!1}get hasM(){return!1}get stride(){return 2+(this.hasZ?1:0)+(this.hasM?1:0)}get hasFeatures(){return this._header.hasFeatures}get hasNext(){return this._hasNext}get exceededTransferLimit(){return this._header.exceededTransferLimit}hasField(a){return this._header.hasField(a)||this._header.hasField(Ge(a))}getFieldNames(){return this._header.fields.map(a=>a.fieldName)}getSize(){return this._size}getQuantizationTransform(){return this._header.transform}getCursor(){return this.copy()}getIndex(){return this._featureIndex}setIndex(a){this._cache.area=0,this._cache.unquantGeometry=void 0,this._cache.geometry=void 0,this._cache.centroid=void 0,this._cache.legacyFeature=void 0,this._cache.optFeature=void 0,this._featureIndex=a}getAttributeHash(){let a="";return this._header.fields.forEach(({index:h})=>{a+=this._readAttributeAtIndex(h)+"."}),a}getObjectId(){return this._readAttributeAtIndex(this._header.objectIdFieldIndex)}getDisplayId(){return this._header.displayIds[this._featureIndex]}setDisplayId(a){this._header.displayIds[this._featureIndex]=a}getGroupId(){return this._header.groupIds[this._featureIndex]}setGroupId(a){this._header.groupIds[this._featureIndex]=a}readLegacyFeature(){if(void 0===this._cache.legacyFeature){const a=this.readCentroid(),h={attributes:this.readAttributes(),geometry:this._isPoints?this.readLegacyPointGeometry():this.readLegacyGeometry(),centroid:(a&&{x:a.coords[0],y:a.coords[1]})??null};return this._cache.legacyFeature=h,h}return this._cache.legacyFeature}readOptimizedFeature(){if(void 0===this._cache.optFeature){const a=new re.u_(this.readGeometry(),this.readAttributes(),this.readCentroid());return a.objectId=this.getObjectId(),a.displayId=this.getDisplayId(),this._cache.optFeature=a,a}return this._cache.optFeature}getXHydrated(){const a=this._header.centroid[2*this._featureIndex],h=this.getQuantizationTransform();return(0,T.Wi)(h)?a:a*h.scale[0]+h.translate[0]}getYHydrated(){const a=this._header.centroid[2*this._featureIndex+1],h=this.getQuantizationTransform();return(0,T.Wi)(h)?a:h.translate[1]-a*h.scale[1]}getX(){return this._header.centroid[2*this._featureIndex]*this._sx+this._tx}getY(){return this._header.centroid[2*this._featureIndex+1]*this._sy+this._ty}readLegacyPointGeometry(){return{x:this.getX(),y:this.getY()}}readLegacyGeometry(a){const h=this.readGeometry(a);return(0,D.di)(h,this.geometryType,!1,!1)}readLegacyCentroid(){const a=this.readCentroid();if(!a)return null;const[h,d]=a.coords;return{x:h,y:d}}readGeometryArea(){return this._cache.area||this.readGeometry(!0),this._cache.area}readUnquantizedGeometry(a=!1){if(void 0===this._cache.unquantGeometry){const h=this.readGeometry(a);if(!h)return this._cache.unquantGeometry=void 0,null;const d=ze(h.coords.length).decoded,c=h.clone(d),f=c.coords;let _=0;for(const m of c.lengths){for(let x=1;x<m;x++){const y=2*(_+x),S=2*(_+x-1);f[y]+=f[S],f[y+1]+=f[S+1]}_+=m}return this._cache.unquantGeometry=c,c}return this._cache.unquantGeometry}readHydratedGeometry(){if(this._isPoints){if(this._header.centroid[2*this._featureIndex]===Je)return null;const c=this.getXHydrated(),f=this.getYHydrated();return new be.Z([],[c,f])}const a=this.readGeometry();if(!a)return null;const h=a.clone(),d=this.getQuantizationTransform();return(0,T.pC)(d)&&(0,D.$g)(h,h,this.hasZ,this.hasM,d),h}readGeometry(a=!1){if(void 0===this._cache.geometry){let h=null;if(this._isPoints){if(this._header.centroid[2*this._featureIndex]===Je)return null;const d=this.getX(),c=this.getY();h=new be.Z([],[d,c])}else{const d=this._header.offsets.geometry[this._featureIndex],c=this._reader;if(0===d){const f=this._readServerCentroid();if(!f)return null;const[_,m]=f.coords;return this.createQuantizedExtrudedQuad(_,m)}c.move(d);try{if(h=a?this._parseGeometryForDisplay(c):this._parseGeometry(c),null===h){const f=this._readServerCentroid();if(!f)return null;const[_,m]=f.coords;return this.createQuantizedExtrudedQuad(_,m)}}catch(f){return console.error("Failed to parse geometry!",f),null}}return this._cache.geometry=h,h}return this._cache.geometry}readCentroid(){if(void 0===this._cache.centroid){let a;return a=this._computeCentroid(),a||(a=this._readServerCentroid()),this._cache.centroid=a??void 0,a??null}return this._cache.centroid}copy(){const a=this._reader.clone(),h=new We(this.instance,a,this._header,this.fullSchema());return this.copyInto(h),h}next(){for(this._cache.area=0,this._cache.unquantGeometry=void 0,this._cache.geometry=void 0,this._cache.centroid=void 0,this._cache.legacyFeature=void 0,this._cache.optFeature=void 0;++this._featureIndex<this._size&&!this._getExists(););return this._featureIndex<this._size}_readAttribute(a,h){const d=this._header.hasField(a)?a:Ge(a),c=this._header.getFieldIndex(d);if(null==c)return;const f=this._readAttributeAtIndex(c);return h&&null!=f&&this._header.isDateField(d)?new Date(f):f}_readAttributes(){const a={};return this._header.fields.forEach(({fieldName:h,index:d})=>{a[h]=this._readAttributeAtIndex(d)}),a}copyInto(a){super.copyInto(a),a._featureIndex=this._featureIndex,a._featureOffset=this._featureOffset,a._hasNext=this._hasNext}_readAttributeAtIndex(a){const d=this._reader;return d.move(this._header.offsets.attributes[this._featureIndex*this._header.fieldCount+a]),function Ut(g){const S=g.getLength(),b=g.pos()+S;for(;g.pos()<b&&g.next();)switch(g.tag()){case 1:return g.getString();case 2:return g.getFloat();case 3:return g.getDouble();case 4:return g.getSInt32();case 5:return g.getUInt32();case 6:return g.getInt64();case 7:return g.getUInt64();case 8:return g.getSInt64();case 9:return g.getBool();default:return g.skip(),null}return null}(d)}_readServerCentroid(){const a=this._header.centroid[2*this._featureIndex]+this._tx;return a===Je?null:new be.Z([],[a,this._header.centroid[2*this._featureIndex+1]+this._ty])}_parseGeometry(a){const c=a.asUnsafe(),f=c.getLength(),_=c.pos()+f,m=[],x=[];for(;c.pos()<_&&c.next();)switch(c.tag()){case 2:{const y=c.getUInt32(),S=c.pos()+y;for(;c.pos()<S;)x.push(c.getUInt32());break}case 3:{const y=c.getUInt32(),S=c.pos()+y;for(m.push(c.getSInt32()+this._tx),m.push(c.getSInt32()+this._ty),this.hasZ&&c.getSInt32(),this.hasM&&c.getSInt32();c.pos()<S;)m.push(c.getSInt32()),m.push(c.getSInt32()),this.hasZ&&c.getSInt32(),this.hasM&&c.getSInt32();break}default:c.skip()}return new be.Z(x,m)}_parseGeometryForDisplay(a){const c=a.asUnsafe(),f=c.getLength(),_=c.pos()+f,m=[],x=[];let y=0,S=0,b=null,R=0;const L="esriGeometryPolygon"===this.geometryType;for(;c.pos()<_&&c.next();)switch(c.tag()){case 2:{const j=c.getUInt32(),W=c.pos()+j;for(;c.pos()<W;){const V=c.getUInt32();m.push(V),y+=V}b=ze(2*y).delta;break}case 3:{c.getUInt32();const j=2+(this.hasZ?1:0)+(this.hasM?1:0);(0,T.O3)(b);for(const W of m)if(S+j*W>b.length)for(let V=0;V<W;V++)c.getSInt32(),c.getSInt32(),this.hasZ&&c.getSInt32(),this.hasM&&c.getSInt32();else if(L){const V=this.getAreaSimplificationThreshold(W,this._header.vertexCount);let $=2,se=1;const te=!1;let ee=c.getSInt32(),ne=c.getSInt32();b[S++]=ee,b[S++]=ne,this.hasZ&&c.getSInt32(),this.hasM&&c.getSInt32();let ce=c.getSInt32(),ue=c.getSInt32();for(this.hasZ&&c.getSInt32(),this.hasM&&c.getSInt32();$<W;){let Ie=c.getSInt32(),ve=c.getSInt32();this.hasZ&&c.getSInt32(),this.hasM&&c.getSInt32();const de=ee+ce,pe=ne+ue;St(ee,ne,de,pe,de+Ie,pe+ve)>=V?(R+=-.5*(de-ee)*(pe+ne),se>1&&ht(b[S-2],b[S-1],ce,ue)?(b[S-2]+=ce,b[S-1]+=ue):(b[S++]=ce,b[S++]=ue,se++),ee=de,ne=pe):(Ie+=ce,ve+=ue),ce=Ie,ue=ve,$++}se<3||te?S-=2*se:(R+=-.5*(ee+ce-ee)*(ne+ue+ne),ht(b[S-2],b[S-1],ce,ue)?(b[S-2]+=ce,b[S-1]+=ue,x.push(se)):(b[S++]=ce,b[S++]=ue,x.push(++se)))}else{let V=0,$=c.getSInt32(),se=c.getSInt32();this.hasZ&&c.getSInt32(),this.hasM&&c.getSInt32(),b[S++]=$,b[S++]=se,V+=1;for(let te=1;te<W;te++){const ee=c.getSInt32(),ne=c.getSInt32(),ce=$+ee,ue=se+ne;R+=-.5*(ce-$)*(ue+se),this.hasZ&&c.getSInt32(),this.hasM&&c.getSInt32(),te>2&&ht(b[S-2],b[S-1],ee,ne)?(b[S-2]+=ee,b[S-1]+=ne):(b[S++]=ee,b[S++]=ne,V+=1),$=ce,se=ue}x.push(V)}break}default:c.skip()}if(this._cache.area=R,!x.length)return null;if(this._tx||this._ty){let j=0;(0,T.O3)(b);for(const W of x)b[2*j]+=this._tx,b[2*j+1]+=this._ty,j+=W}return new be.Z(x,b)}}class Qe{constructor(a){this.service=a}destroy(){}}function et(){return(et=(0,U.Z)(function*(g){const a=new he.Z;return yield a.open(g,{}),a})).apply(this,arguments)}class bt extends Qe{constructor(a){super(a),this._portsOpen=function dt(g){return et.apply(this,arguments)}(a.source).then(h=>this.client=h)}destroy(){this.client.close(),this.client=null}executeQuery(a,h){var d=this;return(0,U.Z)(function*(){yield d._portsOpen;const c=yield d.client.invoke("queryFeatures",a.toJSON(),h);return me.fromFeatureSet(c,d.service)})()}}class Bt extends Qe{executeQuery(a,h){var d=this;return(0,U.Z)(function*(){const{data:c}=yield(0,K.n7)(d.service.source,a,h);return We.fromBuffer(c,d.service,!a.quantizationParameters)})()}}class Ct extends Qe{executeQuery(a,h){var d=this;return(0,U.Z)(function*(){const{source:c,capabilities:f,spatialReference:_,objectIdField:m,geometryType:x}=d.service;if((0,T.pC)(a.quantizationParameters)&&!f.query.supportsQuantization){const S=a.clone(),b=(0,E.vY)((0,T.Wg)(S.quantizationParameters));S.quantizationParameters=null;const{data:R}=yield(0,K.JT)(c,S,_,h),L=(0,D.h_)(R,m);return(0,D.RZ)(b,L),me.fromOptimizedFeatureSet(L,d.service)}const{data:y}=yield(0,K.JT)(c,a,d.service.spatialReference,h);return"esriGeometryPoint"===x&&(y.features=y.features?.filter(S=>{if((0,T.pC)(S.geometry)){const b=S.geometry;return Number.isFinite(b.x)&&Number.isFinite(b.y)}return!0})),me.fromFeatureSet(y,d.service)})()}}class p extends Qe{executeQuery(a,h){var d=this;return(0,U.Z)(function*(){const{capabilities:c}=d.service;if(a.quantizationParameters&&!c.query.supportsQuantization){const _=a.clone(),m=(0,E.vY)((0,T.Wg)(_.quantizationParameters));_.quantizationParameters=null;const x=yield(0,G.WW)(d.service.source,a,h);return(0,D.RZ)(m,x),me.fromOptimizedFeatureSet(x,d.service)}const f=yield(0,G.WW)(d.service.source,a,h);return me.fromOptimizedFeatureSet(f,d.service)})()}}var jt=M(97478),lt=M(61885),De=M(84682),A=M(96854),le=M(65389);class oe{constructor(){this.version=0,this.source=!1,this.targets={feature:!1,aggregate:!1},this.storage={filters:!1,data:!1},this.mesh=!1,this.queryFilter=!1,this.why={mesh:[],source:[]}}static create(a){const h=new oe;for(const d in a){const c=a[d];if("object"==typeof c)for(const f in c)h[d][f]=c[f];h[d]=c}return h}static empty(){return oe.create({})}static all(){return oe.create({source:!0,targets:{feature:!0,aggregate:!0},storage:{filters:!0,data:!0},mesh:!0})}unset(a){this.version=a.version,a.source&&(this.source=!1),a.targets.feature&&(this.targets.feature=!1),a.targets.aggregate&&(this.targets.aggregate=!1),a.storage.filters&&(this.storage.filters=!1),a.storage.data&&(this.storage.data=!1),a.mesh&&(this.mesh=!1),a.queryFilter&&(this.queryFilter=!1)}any(){return this.source||this.mesh||this.storage.filters||this.storage.data||this.targets.feature||this.targets.aggregate||this.queryFilter}describe(){let a=0,h="";if(this.mesh){a+=20,h+="-> (20) Mesh needs update\n";for(const c of this.why.mesh)h+=`    + ${c}\n`}if(this.source){a+=10,h+="-> (10) The source needs update\n";for(const c of this.why.source)h+=`    + ${c}\n`}this.targets.feature&&(a+=5,h+="-> (5) Feature target parameters changed\n"),this.storage.filters&&(a+=5,h+="-> (5) Feature filter parameters changed\n"),this.targets.aggregate&&(a+=4,h+="-> (4) Aggregate target parameters changed\n"),this.storage.data&&(a+=1,h+="-> (1) Texture storage parameters changed"),console.debug(`Applying ${a<5?"Fastest":a<10?"Fast":a<15?"Moderate":a<20?"Slow":"Very Slow"} update of cost ${a}/45 `),console.debug(h)}toJSON(){return{queryFilter:this.queryFilter,source:this.source,targets:this.targets,storage:this.storage,mesh:this.mesh}}}class xe{constructor(a,h){this.requests={done:new Array,stream:new le.Z(10)},this._edits=null,this._abortController=new AbortController,this._version=0,this._done=!1,this.didSend=!1,this.tile=a,this._version=h}get signal(){return this._abortController.signal}get options(){return{signal:this._abortController.signal}}get empty(){return!this.requests.done.length&&(0,T.Wi)(this.edits)}get edits(){return this._edits}get done(){return this._done}end(){this._done=!0}clear(){this.requests.done=[]}applyUpdate(a){this.requests.done.forEach(h=>h.message.status.unset(a)),this._version=a.version,(0,T.pC)(this._edits)&&this._edits.status.unset(a)}add(a){a.message.status=a.message.status??oe.empty(),a.message.status.version=this._version,(0,C.Z)("esri-2d-update-debug")&&console.debug(this.tile.id,"DataTileSubscription:add",this._version),a.message.end&&this.requests.done.forEach(h=>{(0,T.pC)(h.message)&&h.message.end&&(h.message.end=!1)}),this.requests.done.push(a)}edit(a,h){const d=a.getQuantizationTransform(),c=a.fullSchema(),f=Array.from(a.features()).filter(T.pC),_=[...h,...f.map(m=>m.objectId)];this.removeIds(_),this._invalidate(),(0,T.Wi)(this._edits)?this._edits={type:"append",addOrUpdate:me.fromOptimizedFeatures(f,c,(0,T.Wg)(d)),id:this.tile.id,status:oe.empty(),end:!0}:(this.requests.done.forEach(m=>m.message.end=!1),(0,T.Wg)(this._edits.addOrUpdate).append(a.features()))}*readers(){for(const{message:a}of this.requests.done)(0,T.pC)(a.addOrUpdate)&&(yield a.addOrUpdate);(0,T.pC)(this._edits)&&(0,T.pC)(this._edits.addOrUpdate)&&(yield this._edits.addOrUpdate)}_invalidate(){for(const a of this.requests.done)a.message.status=oe.empty();(0,T.pC)(this._edits)&&(this._edits.status=oe.empty())}removeIds(a){this._invalidate();for(const{message:h}of this.requests.done){const d=h.addOrUpdate;(0,T.pC)(d)&&(d.removeIds(a),d.isEmpty&&((0,C.Z)("esri-2d-update-debug")&&console.debug("Removing FeatureSetReader"),h.addOrUpdate=null))}(0,T.pC)(this._edits)&&(0,T.pC)(this._edits.addOrUpdate)&&this._edits.addOrUpdate.removeIds(a),this.requests.done=this.requests.done.filter(h=>h.message.addOrUpdate||h.message.end)}abort(){this._abortController.abort()}}class Se extends ae.Z{constructor(a){super(),this.events=new lt.Z,this._resolver=(0,k.hh)(),this._didEdit=!1,this._subscriptions=new Map,this._outSR=a.outSR,this._serviceInfo=a.serviceInfo,this._onTileUpdateMessage=a.onMessage}_onMessage(a){var h=this;return(0,U.Z)(function*(){const d=h._subscriptions.get(a.id);if(!d)return;const c={...a,remove:a.remove??[],status:a.status??oe.empty()};return(0,k.R8)(h._onTileUpdateMessage(c,d.options))})()}update(a,h){const d=h.fields.length;h.outFields=function Me(g,a){const h=new Set;return g&&g.forEach(d=>h.add(d)),a&&a.forEach(d=>h.add(d)),h.has("*")?["*"]:Array.from(h)}(this._schema?.outFields,h.outFields),h.outFields=h.outFields.length>=.75*d?["*"]:h.outFields,h.outFields.sort();const c=(0,De.Hg)(this._schema,h);if(!c)return;(0,C.Z)("esri-2d-update-debug")&&console.debug("Applying Update - Source:",c);const _={returnCentroid:"esriGeometryPolygon"===this._serviceInfo.geometryType,returnGeometry:!0,timeReferenceUnknownClient:"stream"!==this._serviceInfo.type&&this._serviceInfo.timeReferenceUnknownClient,outFields:h.outFields,outSpatialReference:this._outSR,orderByFields:["orderByFields"in this._serviceInfo&&this._serviceInfo.orderByFields?this._serviceInfo.orderByFields:this._serviceInfo.objectIdField+" ASC"],where:h.definitionExpression||"1=1",gdbVersion:h.gdbVersion,historicMoment:h.historicMoment,timeExtent:h.timeExtent?jt.Z.fromJSON(h.timeExtent):null},m=this._schema&&(0,De.uD)(c,"outFields");this._schema&&(0,De.V7)(c,["timeExtent","definitionExpression","gdbVersion","historicMoment","customParameters"])&&(a.why.mesh.push("Layer filter and/or custom parameters changed"),a.why.source.push("Layer filter and/or custom parameters changed"),a.mesh=!0,a.source=!0,a.queryFilter=!0),m&&(a.why.source.push("Layer required fields changed"),a.source=!0),(0,De.Hg)(_,this._queryInfo)&&(this._queryInfo=_),this._schema=h,this._resolver.resolve()}whenInitialized(){return this._resolver.promise}applyUpdate(a){var h=this;return(0,U.Z)(function*(){if(a.queryFilter||a.source&&h._didEdit)return h.refresh(a.version),void(h._didEdit=!1);h._subscriptions.forEach(d=>d.applyUpdate(a)),yield h.resend()})()}refresh(a,h){for(const d of this._tiles())this.unsubscribe(d),this.subscribe(d,a)}subscribe(a,h){const d=new xe(a,h);this._subscriptions.set(a.id,d)}unsubscribe(a){const h=this.getSubscription(a.id);(0,T.pC)(h)&&h.abort(),this._subscriptions.delete(a.id)}createQuery(a={}){const h=this._queryInfo.historicMoment?new Date(this._queryInfo.historicMoment):null;return new A.Z({...this._queryInfo,historicMoment:h,...a})}getSubscription(a){return this._subscriptions.has(a)?this._subscriptions.get(a):null}queryLastEditDate(){return(0,U.Z)(function*(){throw new Error("Service does not support query type")})()}query(a,h){return(0,U.Z)(function*(){throw new Error("Service does not support query")})()}*_tiles(){const a=Array.from(this._subscriptions.values());for(const h of a)yield h.tile}edit(a,h){var d=this;return(0,U.Z)(function*(){const c=Array.from(d._subscriptions.values()),f=c.map(({tile:_})=>_);for(const _ of c)_.removeIds(h);if(a.length){const _=f.map(x=>{const y=d.createTileQuery(x);return y.objectIds=a,{tile:x,query:y}}).map(function(){var x=(0,U.Z)(function*({tile:y,query:S}){return{tile:y,result:yield d.query(S,{query:{tile:(0,C.Z)("esri-tiles-debug")?y.id.replace(/\//g,"."):void 0}}),query:S}});return function(y){return x.apply(this,arguments)}}()),m=(yield(0,k.WW)(_)).map(function(){var x=(0,U.Z)(function*({tile:y,result:S}){if(!S.hasFeatures&&!h.length&&!a.length)return;const b=d._subscriptions.get(y.key.id);b&&b.edit(S,a)});return function(y){return x.apply(this,arguments)}}());yield(0,k.as)(m)}d._didEdit=!0})()}}var Be=M(71251);class we extends Se{constructor(a){var h,d;super(a),h=this,this.type="feature",this.mode="on-demand",this._adapter=function Ye(g){const{capabilities:a}=g;return function Rt(g){return"ogc-source"===g?.type}(g.source)?new p(g):function $e(g){return Array.isArray(g.source)}(g)?new bt(g):a.query.supportsFormatPBF&&(0,C.Z)("featurelayer-pbf")?new Bt(g):new Ct(g)}(a.serviceInfo),this._queue=new Be.e({concurrency:8,process:(d=(0,U.Z)(function*(c){if((0,k.k_)(c),(0,T.pC)(c.tile)){const f=c.tile.key.id,{signal:_}=c,m=(0,C.Z)("esri-tiles-debug")?{tile:f.replace(/\//g,"."),depth:c.depth}:void 0,x=yield h._adapter.executeQuery(c.query,{signal:_,query:{...m,...h._schema?.customParameters}});return x.level=c.tile.key.level,x}return h._adapter.executeQuery(c.query,{...c,query:h._schema?.customParameters})}),function(f){return d.apply(this,arguments)})}),this._patchQueue=new Be.e({concurrency:8,process:function(){var d=(0,U.Z)(function*(c){if((0,k.k_)(c),(0,T.pC)(c.tile)){const f=c.tile.key.id,{signal:_}=c,m=(0,C.Z)("esri-tiles-debug")?{tile:f.replace(/\//g,"."),depth:c.depth}:void 0,x=yield h._adapter.executeQuery(c.query,{signal:_,query:{...m,...h._schema?.customParameters}});return x.level=c.tile.key.level,x}return h._adapter.executeQuery(c.query,{...c,query:h._schema?.customParameters})});return function(f){return d.apply(this,arguments)}}()})}destroy(){super.destroy(),this._adapter.destroy(),this._queue.destroy(),this._patchQueue.destroy()}get updating(){return!!this._queue.length||Array.from(this._subscriptions.values()).some(a=>!a.done)}get maxRecordCountFactor(){const{query:a}=this._serviceInfo.capabilities;return a.supportsMaxRecordCountFactor?4:null}get maxPageSize(){const{query:a}=this._serviceInfo.capabilities;return(a.maxRecordCount??8e3)*(0,T.Pt)(this.maxRecordCountFactor,1)}get pageSize(){return Math.min(8e3,this.maxPageSize)}enableEvent(a,h){}subscribe(a,h){super.subscribe(a,h);const d=this._subscriptions.get(a.id);this._fetchDataTile(a).catch(c=>{(0,k.D_)(c)||z.Z.getLogger("esri.views.2d.layers.features.sources.BaseFeatureSource").error(new Q.Z("mapview-query-error","Encountered error when fetching tile",{tile:a,error:c}))}).then(()=>d.end())}unsubscribe(a){super.unsubscribe(a)}readers(a){return this._subscriptions.get(a).readers()}query(a,h={}){var d=this;return(0,U.Z)(function*(){const c=h.query??{};return d._adapter.executeQuery(a,{...h,query:{...c,...d._schema?.customParameters}})})()}queryLastEditDate(){var a=this;return(0,U.Z)(function*(){const h=a._serviceInfo.source,d={...h.query,f:"json"};return(yield(0,P.default)(h.path,{query:d,responseType:"json"})).data.editingInfo.lastEditDate})()}createTileQuery(a,h={}){const d=this._serviceInfo.geometryType,c=this.createQuery(h);c.quantizationParameters=h.quantizationParameters??a.getQuantizationParameters(),c.resultType="tile",c.geometry=a.extent,this._serviceInfo.capabilities.query.supportsQuantization?"esriGeometryPolyline"===d&&(c.maxAllowableOffset=a.resolution*(0,C.Z)("feature-polyline-generalization-factor")):"esriGeometryPolyline"!==d&&"esriGeometryPolygon"!==d||(c.maxAllowableOffset=a.resolution,"esriGeometryPolyline"===d&&(c.maxAllowableOffset*=(0,C.Z)("feature-polyline-generalization-factor")));const f=this._serviceInfo.capabilities.query;return c.defaultSpatialReferenceEnabled=f.supportsDefaultSpatialReference,c.compactGeometryEnabled=f.supportsCompactGeometry,c}_executePatchQuery(a,h,d,c){var f=this;return(0,U.Z)(function*(){const _=h.clone();_.outFields=[f._serviceInfo.objectIdField,...d],_.returnCentroid=!1,_.returnGeometry=!1;const m=(0,T.pC)(_.start)?_.start/8e3:0;return f._patchQueue.push({tile:a,query:_,signal:c.signal,depth:m})})()}_resend(a,h){var d=this;return(0,U.Z)(function*(){const{query:c,message:f}=a,_=(0,T.pC)(c.outFields)?c.outFields:[],m=d._queryInfo.outFields,x=m.filter(y=>!_.includes(y));if((0,T.Wi)(f.addOrUpdate))d._onMessage({...f,type:"append"});else if(x.length)try{const y=d._subscriptions.get(f.id).tile,S=yield d._executePatchQuery(y,c,x,h);(0,k.k_)(h),c.outFields=m,f.addOrUpdate.joinAttributes(S),d._onMessage({...f,end:f.end,type:"append"})}catch{}else d._onMessage({...f,type:"append"})})()}_resendSubscription(a){var h=this;return(0,U.Z)(function*(){if((0,C.Z)("esri-2d-update-debug")&&console.debug(a.tile.id,"Resend Subscription"),a.empty)return h._onMessage({id:a.tile.id,addOrUpdate:null,end:!1,type:"append"});const d=a.signal;for(const c of a.requests.done)yield h._resend(c,{signal:d});return(0,T.pC)(a.edits)?h._onMessage(a.edits):void 0})()}resend(){var a=this;return(0,U.Z)(function*(){const h=Array.from(a._subscriptions.values());yield Promise.all(h.map(d=>a._resendSubscription(d)))})()}}const Tt=(0,C.Z)("esri-mobile"),zt={maxDrillLevel:Tt?1:4,maxRecordCountFactor:Tt?1:3};class Wt extends we{constructor(a){super(a)}_fetchDataTile(a){var h=this;return(0,U.Z)(function*(){const d=h._serviceInfo.capabilities.query.supportsMaxRecordCountFactor,c=h._subscriptions.get(a.key.id),f=c.signal,_=a.getQuantizationParameters();let m=0;const x=function(){var y=(0,U.Z)(function*(S,b){const R=h._queryInfo,L=h.createTileQuery(S,{maxRecordCountFactor:d?zt.maxRecordCountFactor:void 0,returnExceededLimitFeatures:!1,quantizationParameters:_});m++;try{const j=yield h._queue.push({tile:a,query:L,signal:f,depth:b});if(m--,(0,k.k_)(f),!j)return;if(R!==h._queryInfo)return void x(S,b);if(j.exceededTransferLimit&&b<zt.maxDrillLevel){for(const V of S.createChildTiles())x(V,b+1);return}const W={id:a.id,addOrUpdate:j,end:0===m,type:"append"};c.add({query:L,message:W}),h._onMessage(W)}catch(j){(0,k.D_)(j)||h._onMessage({id:a.id,addOrUpdate:null,end:!0,type:"append"})}});return function(b,R){return y.apply(this,arguments)}}();x(a,0)})()}}class Kt extends we{constructor(a){super(a)}_fetchDataTile(a){var h=this;return(0,U.Z)(function*(){const f=h._subscriptions.get(a.key.id);let _=!1,m=0,x=0;const y=(R,L)=>{x--,(0,k.k_)(f);const j=a.id,W=R.reader,V=R.query;if(!W.exceededTransferLimit){if(_=!0,0!==L&&!W.hasFeatures){const te={id:j,addOrUpdate:W,end:0===x,type:"append"};return f.add({message:te,query:V}),void h._onMessage(te)}const se={id:j,addOrUpdate:W,end:0===x,type:"append"};return f.add({message:se,query:V}),void h._onMessage(se)}const $={id:j,addOrUpdate:W,end:_&&0===x,type:"append"};f.add({message:$,query:V}),h._onMessage($)};let S=0,b=0;for(;!_&&b++<20;){let R;for(let L=0;L<S+1;L++){const j=m++;x++,R=h._fetchDataTilePage(a,j,f).then(W=>W&&y(W,j)).catch(W=>{_=!0,(0,k.D_)(W)||(z.Z.getLogger("esri.views.2d.layers.features.sources.PagedFeatureSource").error(new Q.Z("mapview-query-error","Encountered error when fetching tile",{tile:a,error:W})),h._onMessage({id:a.id,addOrUpdate:null,end:_,type:"append"}))})}yield R,(0,k.k_)(f),S=Math.min(S+2,6)}})()}_fetchDataTilePage(a,h,d){var c=this;return(0,U.Z)(function*(){(0,k.k_)(d);const f=c._queryInfo,_={start:c.pageSize*h,num:c.pageSize,returnExceededLimitFeatures:!0,quantizationParameters:a.getQuantizationParameters()};(0,T.pC)(c.maxRecordCountFactor)&&(_.maxRecordCountFactor=c.maxRecordCountFactor);const m=c.createTileQuery(a,_);try{const x=d.signal,y=yield c._queue.push({tile:a,query:m,signal:x,depth:h});return(0,k.k_)(d),y?f!==c._queryInfo?c._fetchDataTilePage(a,h,d):{reader:y,query:m}:null}catch(x){return(0,k.H9)(x),null}})()}}var $t=M(4619),es=M(52397);function Pt(g,a,h){const d=g.getXHydrated(),c=g.getYHydrated(),f=a.getColumnForX(d),_=Math.floor(a.normalizeCol(f));return`${h}/${Math.floor(a.getRowForY(c))}/${_}`}function ts(g,a){if((0,T.Wi)(g))return null;const h=a.transform,d=g.getQuantizationTransform();if((0,T.Wi)(d)){const[V,$]=h.scale,[se,te]=h.translate;return g.transform(-se/V,te/$,1/V,1/-$)}const[c,f]=d.scale,[_,m]=d.translate,[x,y]=h.scale,[S,b]=h.translate;return g.transform((_-S)/x,(-m+b)/y,c/x,f/y)}class Es extends we{constructor(a){super(a),this.mode="snapshot",this._loading=!0,this._controller=new AbortController,this._downloadPromise=null,this._didSendEnd=!1,this._queries=new Array,this._invalidated=!1,this._hasAggregates=!1,this._random=new $t.Z(1e3),this._store=a.store,this._markedIdsBufId=this._store.storage.createBitset()}destroy(){super.destroy(),this._controller.abort()}get loading(){return this._loading}get _signal(){return this._controller.signal}update(a,h){super.update(a,h),null==this._featureCount&&(this._featureCount=h.initialFeatureCount),(0,T.pC)(h.changedFeatureCount)&&(this._featureCount=h.changedFeatureCount),this._hasAggregates=!!a.targets?.aggregate}resend(a=!1){var h=this;return(0,U.Z)(function*(){if(yield h._downloadPromise,h._invalidated||a){const c=(0,T.s3)(h._featureCount,"Expected featureCount to be defined");return h._invalidated=!1,h._subscriptions.forEach(f=>f.clear()),h._downloadPromise=h._download(c),void(yield h._downloadPromise)}const d=h._queries.map(({query:c,reader:f})=>h._sendPatchQuery(c,f));yield Promise.all(d),h._subscriptions.forEach(c=>{c.requests.done.forEach(f=>h._onMessage(f.message))})})()}refresh(a,h){var d=this;return(0,U.Z)(function*(){h&&(d._featureCount=h.featureCount),yield d.resend(!0)})()}_sendPatchQuery(a,h){var d=this;return(0,U.Z)(function*(){const c=(0,T.pC)(a.outFields)?a.outFields:[],f=d._queryInfo.outFields,_=f.filter(S=>!c.includes(S));if(!_.length)return;const m=a.clone(),x=d._signal;m.returnGeometry=!1,m.returnCentroid=!1,m.outFields=_,a.outFields=f;const y=yield d._queue.push({query:m,depth:0,signal:x});(0,k.k_)({signal:x}),h.joinAttributes(y)})()}_fetchDataTile(a){var h=this;return(0,U.Z)(function*(){if(!h._downloadPromise){const y=(0,T.s3)(h._featureCount,"Expected featureCount to be defined");h._downloadPromise=h._download(y)}const d=h._store.search(a),c=h._subscriptions.get(a.key.id),f=d.length-1;for(let y=0;y<f;y++){const S=ts(d[y],a),b={type:"append",id:a.id,addOrUpdate:S,end:!1,status:oe.empty()};c.add({query:null,message:b}),h._hasAggregates||(yield(0,k.e4)(1)),h._onMessage(b)}const _=ts(f>=0?d[f]:null,a),x={type:"append",id:a.id,addOrUpdate:_,end:h._didSendEnd,status:oe.empty()};c.add({query:null,message:x}),h._onMessage(x)})()}_download(a){var h=this;return(0,U.Z)(function*(){try{yield h.whenInitialized();const d=h._store.storage.getBitset(h._markedIdsBufId),c=new Set;d.clear();const f=Math.ceil(a/h.pageSize),_=Array.from({length:f},(m,x)=>x).sort((m,x)=>h._random.getInt()-h._random.getInt()).map(m=>h._downloadPage(m,d,c));yield Promise.all(_),h._store.sweepFeatures(d,h._store.storage),h._store.sweepFeatureSets(c)}catch(d){z.Z.getLogger("esri.views.2d.layers.features.sources.SnapshotFeatureSource").error("mapview-snapshot-source","Encountered and error when downloading feature snapshot",d)}h._sendEnd(),h._loading=!1})()}_downloadPage(a,h,d){var c=this;return(0,U.Z)(function*(){const f=c.pageSize,_={start:a*f,num:f,cacheHint:!0};(0,T.pC)(c.maxRecordCountFactor)&&(_.maxRecordCountFactor=c.maxRecordCountFactor);const m=c.createQuery(_),x=c._signal,y=yield c._queue.push({query:m,depth:a,signal:x});(0,k.k_)({signal:x}),c._queries.push({query:m,reader:y}),c._store.insert(y),d.add(y.instance);const S=y.getCursor();for(;S.next();)h.set(S.getDisplayId());c._send(y)})()}_send(a){if(!this._subscriptions.size)return;let h=null;const d=new Map,c=new Set,f=new Map;this._subscriptions.forEach(_=>{const m=_.tile;d.set(m.key.id,null),h=m.tileInfoView,c.add(m.level);const{row:x,col:y}=m.key,S=`${m.level}/${x}/${y}`,b=f.get(S)??[];b.push(_),f.set(S,b)});for(const _ of c){const m=h.getLODInfoAt(_),x=a.getCursor();for(;x.next();){const y=Pt(x,m,_),S=x.getIndex();if(f.has(y))for(const b of f.get(y)){const R=b.tile.id;let L=d.get(R);(0,T.Wi)(L)&&(L=[],d.set(R,L)),L.push(S)}}}d.forEach((_,m)=>{if((0,T.pC)(_)){const x=this._subscriptions.get(m),y={type:"append",id:m,addOrUpdate:ts(es.t.from(a,_),x.tile),end:!1,status:oe.empty()};x.add({query:null,message:y}),this._onMessage(y)}})}_sendEnd(){this._subscriptions.forEach(a=>{const h={type:"append",id:a.tile.id,addOrUpdate:null,end:!0,status:oe.empty()};a.add({query:null,message:h}),this._onMessage(h)}),this._didSendEnd=!0}}var ls=M(76279),Ds=M(5075),ws=M(20901);function Rs(g,a){const h=g.weakClone();if((0,T.pC)(g.geometry)){const d=(0,D.Jd)(a,g.geometry.coords[0]),c=(0,D.IN)(a,g.geometry.coords[1]);h.geometry=new be.Z([],[d,c])}return h}class Zs{constructor(a,h){this.onUpdate=a,this._geometryType=h,this._objectIdToFeature=new Map,this._index=null}get _features(){const a=[];return this._objectIdToFeature.forEach(h=>a.push(h)),a}add(a){this._objectIdToFeature.set(a.objectId,a),this._index=null}get(a){return this._objectIdToFeature.has(a)?this._objectIdToFeature.get(a):null}forEach(a){this._objectIdToFeature.forEach(a)}search(a){return this._index||(this._index=function Ls(g,a){const h=(0,ls.r)(9,function Ps(g){return"esriGeometryPoint"===g?a=>(0,T.pC)(a.geometry)?{minX:a.geometry.coords[0],minY:a.geometry.coords[1],maxX:a.geometry.coords[0],maxY:a.geometry.coords[1]}:{minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}:a=>{let h=1/0,d=1/0,c=-1/0,f=-1/0;return(0,T.pC)(a.geometry)&&a.geometry.forEachVertex((_,m)=>{h=Math.min(h,_),d=Math.min(d,m),c=Math.max(c,_),f=Math.max(f,m)}),{minX:h,minY:d,maxX:c,maxY:f}}}(a));return h.load(g),h}(this._features,this._geometryType)),function Os(g,a){return g.search({minX:a.bounds[0],minY:a.bounds[1],maxX:a.bounds[2],maxY:a.bounds[3]})}(this._index,a)}clear(){this._index=null,this._objectIdToFeature.clear()}removeById(a){const h=this._objectIdToFeature.get(a);return h?(this._objectIdToFeature.delete(a),this._index=null,h):null}update(a,h){this.onUpdate(a,h)}get size(){return this._objectIdToFeature.size}}let Lt=class extends Se{constructor(g){super(g),this.type="stream",this._updateIntervalId=0,this._level=0,this._updateInfo={websocket:0,client:0},this._isPaused=!1,this._inUpdate=!1;const{outSR:a}=g,{geometryType:h,objectIdField:d,timeInfo:c,purgeOptions:f,source:_,spatialReference:m,serviceFilter:x,maxReconnectionAttempts:y,maxReconnectionInterval:S,updateInterval:b,customParameters:R,enabledEventTypes:L}=g.serviceInfo,j=new Zs(this._onUpdate.bind(this),h),W=new Ds.Qo(j,d,c,f),V=(0,ws.createConnection)(_,m,a,h,x,y,S,R??{});this._store=j,this._manager=W,this._connection=V,this._quantize=function Bs(g){return"esriGeometryPoint"===g?Rs:(a,h)=>{const d=a.weakClone(),c=new be.Z,m=(0,D.Nh)(c,a.geometry,!1,!1,g,h,!1,!1);return d.geometry=m,d}}(h),this._enabledEventTypes=new Set(L),this._handles=[this._connection.on("data-received",$=>this._onFeature($)),this._connection.on("message-received",$=>this._onWebSocketMessage($))],this._initUpdateInterval=()=>{let $=performance.now();this._updateIntervalId=setInterval(()=>{const se=performance.now(),te=se-$;if(te>2500){$=se;const ee=Math.round(this._updateInfo.client/(te/1e3)),ne=Math.round(this._updateInfo.websocket/(te/1e3));this._updateInfo.client=0,this._updateInfo.websocket=0,this.events.emit("updateRate",{client:ee,websocket:ne})}g.canAcceptRequest()&&!this._inUpdate&&this._manager.checkForUpdates()},b)},this._initUpdateInterval()}destroy(){super.destroy(),this._clearUpdateInterval(),this._handles.forEach(g=>g.remove()),this._connection.destroy()}_fetchDataTile(){}get connectionStatus(){return this._isPaused?"paused":this._connection?.connectionStatus}get errorString(){return this._connection?.errorString}updateCustomParameters(g){this._connection.updateCustomParameters(g)}pauseStream(){this._isPaused||(this._isPaused=!0,this._clearUpdateInterval())}resumeStream(){this._isPaused&&(this._isPaused=!1,this._initUpdateInterval())}sendMessageToSocket(g){this._connection.sendMessageToSocket(g)}sendMessageToClient(g){this._connection.sendMessageToClient(g)}enableEvent(g,a){a?this._enabledEventTypes.add(g):this._enabledEventTypes.delete(g)}get updating(){return!1}subscribe(g,a){super.subscribe(g,a);const h=this._subscriptions.get(g.id);this._level=g.level;const d=this._getTileFeatures(g);this._onMessage({type:"append",id:g.key.id,addOrUpdate:d,end:!0}),h.didSend=!0}unsubscribe(g){super.unsubscribe(g)}*readers(g){const a=this._subscriptions.get(g),{tile:h}=a;yield this._getTileFeatures(h)}createTileQuery(g){throw new Error("Service does not support tile  queries")}resend(){var g=this;return(0,U.Z)(function*(){g._subscriptions.forEach(a=>{const{tile:h}=a,d={type:"append",id:h.id,addOrUpdate:g._getTileFeatures(h),end:!0};g._onMessage(d)})})()}_getTileFeatures(g){const a=this._store.search(g).map(h=>this._quantize(h,g.transform));return me.fromOptimizedFeatures(a,this._serviceInfo,g.transform)}_onWebSocketMessage(g){if(this._enabledEventTypes.has("message-received")&&this.events.emit("message-received",g),"type"in g)switch(g.type){case"delete":if(g.objectIds)for(const a of g.objectIds)this._manager.removeById(a);if(g.trackIds)for(const a of g.trackIds)this._manager.removeByTrackId(a);break;case"clear":this._store.forEach(a=>this._manager.removeById(a.objectId))}}_onFeature(g){this._updateInfo.websocket++;try{this._enabledEventTypes.has("data-received")&&this.events.emit("data-received",g);const a=(0,D.XA)(g,this._serviceInfo.geometryType,!1,!1,this._serviceInfo.objectIdField);this._manager.add(a)}catch{}}_clearUpdateInterval(){clearInterval(this._updateIntervalId),this._updateIntervalId=0}_onUpdate(g,a){var h=this;return(0,U.Z)(function*(){h._inUpdate=!0;try{(0,T.pC)(g)&&(h._updateInfo.client+=g.length),h._subscriptions.forEach((c,f)=>{c.didSend&&c.tile.level===h._level&&h._onMessage({type:"append",id:f,addOrUpdate:null,clear:!0,end:!1})});const d=[];h._subscriptions.forEach((c,f)=>{if(!c.didSend||c.tile.level!==h._level)return;const m={type:"append",id:f,addOrUpdate:h._getTileFeatures(c.tile),remove:[],end:!1,status:oe.empty()};c.requests.stream.enqueue(m),d.push(h._onMessage(m))}),yield Promise.all(d),h._subscriptions.forEach((c,f)=>{c.didSend&&c.tile.level===h._level&&h._onMessage({type:"append",id:f,addOrUpdate:null,end:!0})})}catch{}h._inUpdate=!1})()}};(0,q._)([(0,O.Cb)()],Lt.prototype,"_isPaused",void 0),(0,q._)([(0,O.Cb)()],Lt.prototype,"connectionStatus",null),(0,q._)([(0,O.Cb)()],Lt.prototype,"errorString",null),Lt=(0,q._)([(0,X.j)("esri.views.2d.layers.features.sources")],Lt);var zs=M(21286),Ce=M(39351),fe=M(99666),Gs=M(87526);M(81295),M(39406);var Ft=M(67969);const Ot=z.Z.getLogger("esri.views.layers.2d.features.support.AttributeStore"),Qt=(Ot,()=>null),Gt={sharedArrayBuffer:(0,C.Z)("esri-shared-array-buffer"),atomics:(0,C.Z)("esri-atomics")};function rs(g,a){return h=>a(g(h))}class Hs{constructor(a,h,d,c){this.size=0,this.texelSize=4,this.dirtyStart=0,this.dirtyEnd=0;const{pixelType:f,layout:_,textureOnly:m}=c;this.textureOnly=m||!1,this.pixelType=f,this._ctype=h,this.layout=_,this._resetRange(),this._shared=a,this.size=d,m||(this.data=this._initData(f,d,a,h))}get buffer(){return(0,T.yw)(this.data,a=>a.buffer)}unsetComponentAllTexels(a,h){const d=(0,T.Wg)(this.data);for(let c=0;c<this.size*this.size;c++)d[c*this.texelSize+a]&=~h;this.dirtyStart=0,this.dirtyEnd=this.size*this.size-1}setComponentAllTexels(a,h){const d=(0,T.Wg)(this.data);for(let c=0;c<this.size*this.size;c++)d[c*this.texelSize+a]|=255&h;this.dirtyStart=0,this.dirtyEnd=this.size*this.size-1}setComponent(a,h,d){const c=(0,T.Wg)(this.data);for(const f of d)c[f*this.texelSize+a]|=h,this.dirtyStart=Math.min(this.dirtyStart,f),this.dirtyEnd=Math.max(this.dirtyEnd,f)}setComponentTexel(a,h,d){(0,T.Wg)(this.data)[d*this.texelSize+a]|=h,this.dirtyStart=Math.min(this.dirtyStart,d),this.dirtyEnd=Math.max(this.dirtyEnd,d)}unsetComponentTexel(a,h,d){(0,T.Wg)(this.data)[d*this.texelSize+a]&=~h,this.dirtyStart=Math.min(this.dirtyStart,d),this.dirtyEnd=Math.max(this.dirtyEnd,d)}getData(a,h){const d=(0,fe.jL)(a);return(0,T.Wg)(this.data)[d*this.texelSize+h]}setData(a,h,d){const c=(0,fe.jL)(a);this.layout&1<<h?(0,T.Wi)(this.data)||(this.data[c*this.texelSize+h]=d,this.dirtyStart=Math.min(this.dirtyStart,c),this.dirtyEnd=Math.max(this.dirtyEnd,c)):Ot.error("mapview-attributes-store","Tried to set a value for a texel's readonly component")}lock(){this.pixelType===Ft.Br.UNSIGNED_BYTE&&this._shared&&Gt.atomics&&"local"!==this._ctype&&Atomics.store(this.data,0,1)}unlock(){this.pixelType===Ft.Br.UNSIGNED_BYTE&&this._shared&&Gt.atomics&&"local"!==this._ctype&&Atomics.store(this.data,0,0)}expand(a){if(this.size=a,!this.textureOnly){const h=this._initData(this.pixelType,a,this._shared,this._ctype),d=(0,T.Wg)(this.data);h.set(d),this.data=h}}toMessage(){const a=this.dirtyStart,h=this.dirtyEnd,d=this.texelSize;if(a>h)return null;this._resetRange();const c=!(this._shared||"local"===this._ctype),f=this.pixelType,_=this.layout,m=(0,T.Wg)(this.data);return{start:a,end:h,data:c&&m.slice(a*d,(h+1)*d)||null,pixelType:f,layout:_}}_initData(a,h,d,c){const f=d&&"local"!==c?SharedArrayBuffer:ArrayBuffer,_=(0,Gs.UK)(a),m=new _(new f(h*h*4*_.BYTES_PER_ELEMENT));for(let x=0;x<m.length;x+=4)m[x+1]=255;return m}_resetRange(){this.dirtyStart=2147483647,this.dirtyEnd=0}}class qs{constructor(a,h,d=(()=>{})){this._client=a,this.config=h,this._notifyChange=d,this._blocks=new Array,this._filters=new Array(Ce.m4),this._attributeComputeInfo=null,this._targetType=0,this._abortController=new AbortController,this._hasScaleExpr=!1,this._size=32,this._nextUpdate=null,this._currUpdate=null,this._idsToHighlight=new Set;const c=h.supportsTextureFloat?Ft.Br.FLOAT:Ft.Br.UNSIGNED_BYTE;Qt(`Creating AttributeStore ${Gt.sharedArrayBuffer?"with":"without"} shared memory`),this._blockDescriptors=[{pixelType:Ft.Br.UNSIGNED_BYTE,layout:1},{pixelType:Ft.Br.UNSIGNED_BYTE,layout:15,textureOnly:!0},{pixelType:Ft.Br.UNSIGNED_BYTE,layout:15,textureOnly:!0},{pixelType:c,layout:15},{pixelType:c,layout:15},{pixelType:c,layout:15},{pixelType:c,layout:15}],this._blocks=this._blockDescriptors.map(()=>null)}destroy(){this._abortController.abort()}get hasScaleExpr(){return this._hasScaleExpr}get _signal(){return this._abortController.signal}get hasHighlight(){return this._idsToHighlight.size>0}isUpdating(){return!!this._currUpdate||!!this._nextUpdate}update(a,h){this.config=h;const d=h.schema.processors[0].storage,c=(0,De.Hg)(this._schema,d);if((a.targets.feature||a.targets.aggregate)&&(a.storage.data=!0),c&&((0,C.Z)("esri-2d-update-debug")&&console.debug("Applying Update - AttributeStore:",c),a.storage.data=!0,this._schema=d,this._attributeComputeInfo=null,!(0,T.Wi)(d))){switch(d.target){case"feature":this._targetType=fe.PX;break;case"aggregate":this._targetType=fe.xp}if("subtype"===d.type){this._attributeComputeInfo={isSubtype:!0,subtypeField:d.subtypeField,map:new Map};for(const f in d.mapping){const _=d.mapping[f];if((0,T.pC)(_)&&(0,T.pC)(_.vvMapping))for(const m of _.vvMapping)this._bindAttribute(m,parseInt(f,10))}}else{if(this._attributeComputeInfo={isSubtype:!1,map:new Map},(0,T.pC)(d.vvMapping))for(const f of d.vvMapping)this._bindAttribute(f);if((0,T.pC)(d.attributeMapping))for(const f of d.attributeMapping)this._bindAttribute(f)}}}onTileData(a,h){if((0,T.Wi)(h.addOrUpdate))return;const d=h.addOrUpdate.getCursor();for(;d.next();){const c=d.getDisplayId();this.setAttributeData(c,d)}}setHighlight(a,h){var d=this;return(0,U.Z)(function*(){const f=d._getBlock(0),_=h.map(m=>(0,fe.jL)(m));f.lock(),f.unsetComponentAllTexels(0,1),f.setComponent(0,1,_),f.unlock(),d._idsToHighlight.clear();for(const m of a)d._idsToHighlight.add(m);yield d.sendUpdates()})()}updateFilters(a,h,d){var c=this;return(0,U.Z)(function*(){const{service:f,spatialReference:_}=d,{filters:m}=h,x=m.map((y,S)=>c._updateFilter(y,S,f,_));(yield Promise.all(x)).some(y=>y)&&(a.storage.filters=!0,(0,C.Z)("esri-2d-update-debug")&&console.debug("Applying Update - AttributeStore:","Filters changed"))})()}setData(a,h,d,c){const f=(0,fe.jL)(a);this._ensureSizeForTexel(f),this._getBlock(h).setData(a,d,c)}getData(a,h,d){return this._getBlock(h).getData(a,d)}getHighlightFlag(a){return this._idsToHighlight.has(a)?Ce.uG:0}unsetAttributeData(a){const h=(0,fe.jL)(a);this._getBlock(0).setData(h,0,0)}setAttributeData(a,h){const d=(0,fe.jL)(a);if(this._ensureSizeForTexel(d),this._getBlock(0).setData(d,0,this.getFilterFlags(h)),this._targetType!==(0,fe.vs)(a))return;const c=this._attributeComputeInfo,f=this.config.supportsTextureFloat?1:2;let m=null;c&&(m=c.isSubtype?c.map.get(h.readAttribute(c.subtypeField)):c.map,m&&m.size&&m.forEach((x,y)=>{const S=y*f%4,b=Math.floor(y*f/4),R=this._getBlock(b+Ce.aK),L=x(h);if(this.config.supportsTextureFloat)R.setData(d,S,L);else if(L===Ce.AI)R.setData(d,S,255),R.setData(d,S+1,255);else{const j=(0,zs.uZ)(Math.round(L),-32767,32766)+32768,V=(65280&j)>>8;R.setData(d,S,255&j),R.setData(d,S+1,V)}}))}sendUpdates(){if((0,C.Z)("esri-2d-update-debug")&&console.debug("AttributeStore::sendUpdate"),this._notifyChange(),this._nextUpdate)return this._nextUpdate.promise;if(this._currUpdate)return this._nextUpdate=(0,k.hh)(),this._nextUpdate.promise;const a={blocks:this._blocks.map(h=>(0,T.pC)(h)?h.toMessage():null)};return this._currUpdate=this._createResources().then(()=>{const h=()=>{if(this._currUpdate=null,this._nextUpdate){const c=this._nextUpdate;this._nextUpdate=null,this.sendUpdates().then(()=>c.resolve())}else(0,C.Z)("esri-2d-update-debug")&&console.debug("AttributeStore::sendUpdate::No additional updates queued");this._notifyChange()};(0,C.Z)("esri-2d-update-debug")&&console.debug("AttributeStore::sendUpdate::client.update");const d=this._client.update(a,this._signal).then(h).catch(h);return this._client.render(this._signal),d}).catch(h=>{if((0,k.D_)(h))return this._createResourcesPromise=null,this._createResources();this._notifyChange(),Ot.error(new Q.Z("mapview-attribute-store","Encountered an error during client update",h))}),this._currUpdate}_ensureSizeForTexel(a){for(;a>=this._size*this._size;)if(this._expand())return}_bindAttribute(a,h){let f;if(null!=a.fieldIndex)f=function c(){return a.normalizationField&&Ot.warn("mapview-arcade","Ignoring normalizationField specified with an arcade expression which is not supported."),y=>y.getComputedNumericAtIndex(a.fieldIndex)}();else{if(!a.field)return;f=function d(){const{normalizationField:y}=a;return y?S=>{const b=S.readAttribute(y);return b?S.readAttribute(a.field)/b:null}:S=>S.readAttribute(a.field)}()}const{valueRepresentation:_}=a;_&&(f=rs(f,y=>function Qs(g,a){if(!g||!a)return g;switch(a){case"radius":case"distance":return 2*g;case"diameter":case"width":return g;case"area":return Math.sqrt(g)}return g}(y,_)));const m=y=>null===y||isNaN(y)||y===1/0||y===-1/0?Ce.AI:y,x=this._attributeComputeInfo;if(x.isSubtype){const y=x.map.get(h)??new Map;y.set(a.binding,rs(f,m)),x.map.set(h,y)}else x.map.set(a.binding,rs(f,m))}_createResources(){if((0,T.pC)(this._createResourcesPromise))return this._createResourcesPromise;this._getBlock(Ce.xl),this._getBlock(Ce.pU),Qt("Initializing AttributeStore");const a={shared:Gt.sharedArrayBuffer&&"local"!==this._client.type,size:this._size,blocks:(0,T.Fd)(this._blocks,d=>({textureOnly:d.textureOnly,buffer:d.buffer,pixelType:d.pixelType}))},h=this._client.initialize(a,this._signal).catch(d=>{(0,k.D_)(d)?this._createResourcesPromise=null:Ot.error(new Q.Z("mapview-attribute-store","Encountered an error during client initialization",d))});return this._createResourcesPromise=h,h.then(()=>(0,T.Wi)(this._createResourcesPromise)?this._createResources():void 0),h}_getBlock(a){const h=this._blocks[a];if((0,T.pC)(h))return h;Qt(`Initializing AttributeBlock at index ${a}`);const f=new Hs(Gt.sharedArrayBuffer,this._client.type,this._size,this._blockDescriptors[a]);return this._blocks[a]=f,this._createResourcesPromise=null,f}_expand(){if(this._size<this.config.maxTextureSize){const a=this._size<<=1;return Qt("Expanding block size to",a,this._blocks),(0,T.JR)(this._blocks,h=>h.expand(a)),this._createResourcesPromise=null,this._size=a,0}return Ot.error(new Q.Z("mapview-limitations","Maximum number of onscreen features exceeded.")),-1}_updateFilter(a,h,d,c){var f=this;return(0,U.Z)(function*(){const _=f._filters[h],m=(0,T.pC)(_)&&_.hash;if(!_&&!a||m===JSON.stringify(a))return!1;if((0,T.Wi)(a)){if(!_)return!1;const y=1<<h+1,S=f._getBlock(0);return f._filters[h]=null,S.setComponentAllTexels(0,y),f.sendUpdates(),!0}return yield(yield f._getFilter(h,d)).update(a,c),!0})()}_getFilter(a,h){var d=this;return(0,U.Z)(function*(){const c=d._filters[a];if((0,T.pC)(c))return c;const{default:f}=yield M.e(8967).then(M.bind(M,8967)),_=new f({geometryType:h.geometryType,hasM:!1,hasZ:!1,timeInfo:h.timeInfo,fieldsIndex:new I.Z(h.fields)});return d._filters[a]=_,_})()}isVisible(a){return!!(2&this._getBlock(0).getData(a,0))}getFilterFlags(a){let h=0;const d=(0,fe.KS)(a.getDisplayId());for(let f=0;f<this._filters.length;f++){const m=this._filters[f];h|=(d&1<<f&&!(0,T.Wi)(m)&&!m.check(a)?0:1)<<f}let c=0;if(this._idsToHighlight.size){const f=a.getObjectId();c=this.getHighlightFlag(f)}return h<<1|c}}function Vt(g,a,h,d){d%2&&(d+=1);let c=0,f=0,_=-90,m=90,x=-180,y=180;for(let S=0;S<d/2;S++){for(let b=0;b<5;b++){const R=(x+y)/2,L=h>R?1:0;c|=L<<29-(b+5*S),x=(1-L)*x+L*R,y=(1-L)*R+L*y}for(let b=0;b<5;b++){const R=(_+m)/2,L=a>R?1:0;f|=L<<29-(b+5*S),_=(1-L)*_+L*R,m=(1-L)*R+L*m}}g.geohashX=c,g.geohashY=f}function Ht(g,a,h,d,c){c%2&&(c+=1);let f=0,_=0,m=-90,x=90,y=-180,S=180;for(let b=0;b<c/2;b++){for(let R=0;R<5;R++){const L=(y+S)/2,j=d>L?1:0;f|=j<<29-(R+5*b),y=(1-j)*y+j*L,S=(1-j)*L+j*S}for(let R=0;R<5;R++){const L=(m+x)/2,j=h>L?1:0;_|=j<<29-(R+5*b),m=(1-j)*m+j*L,x=(1-j)*L+j*x}}g[2*a]=f,g[2*a+1]=_}M(29132),new Float64Array(2),new Float64Array(2);var ft=M(65234),pt=M(82959);class ys{constructor(a=[],h,d=8096){this.onRelease=c=>{},this._nodes=0,this._root=new ns(this,0,0,0),this._statisticFields=a,this._pool=d?new le.Z(8096):null,this._serviceInfo=h}destroy(){this.clear()}_acquire(a,h,d){this._nodes++;let c=null;return(0,T.pC)(this._pool)&&(c=this._pool.dequeue()),(0,T.pC)(c)?c.realloc(a,h,d):c=new ns(this,a,h,d),c}_release(a){this.onRelease(a),this._nodes--,(0,T.pC)(this._pool)&&this._pool.enqueue(a)}get count(){return this._root.count}get size(){return this._nodes}get poolSize(){return(0,T.R2)(this._pool,0,a=>a.size)}get depth(){let a=0;return this.forEach(h=>a=Math.max(a,h.depth)),a}dropLevels(a){this.forEach(h=>{if(h.depth>=a)for(let d=0;d<h.children.length;d++){const c=h.children[d];c&&this._release(c)}}),this.forEach(h=>{if(h.depth>=a)for(let d=0;d<h.children.length;d++)h.children[d]=null})}clear(){this.forEach(a=>this._release(a)),this._root=new ns(this,0,0,0)}insert(a,h,d=0){const c=me.fromOptimizedFeatures([a],this._serviceInfo).getCursor();c.next();const f=c.readGeometry();if(!f)return;const[_,m]=f.coords;this.insertCursor(c,a.displayId,_,m,a.geohashX,a.geohashY,h,d)}insertCursor(a,h,d,c,f,_,m,x=0){let y=this._root,S=0,b=0,R=0;for(;null!==y;){if(y.depth>=x&&(y.count+=1,y.xTotal+=d,y.yTotal+=c,y.xGeohashTotal+=f,y.yGeohashTotal+=_,y.referenceId=h,this._updateStatisticsCursor(a,y,1)),S>=m)return void y.add(h);const L=Math.ceil((S+1)/2),j=Math.floor((S+1)/2),W=1-S%2,V=30-(3*L+2*j),$=30-(2*L+3*j),se=(f&7*W+3*(1-W)<<V)>>V,te=(_&3*W+7*(1-W)<<$)>>$,ee=se+te*(8*W+4*(1-W));b=b<<3*W+2*(1-W)|se,R=R<<2*W+3*(1-W)|te,null==y.children[ee]&&(y.children[ee]=this._acquire(b,R,S+1)),S+=1,y=y.children[ee]}}remove(a,h){const d=me.fromOptimizedFeatures([a],this._serviceInfo).getCursor();d.next();const c=d.readGeometry();if(!c)return;const[f,_]=c.coords;this.removeCursor(d,f,_,a.geohashX,a.geohashY,h)}removeCursor(a,h,d,c,f,_){let m=this._root,x=0;for(;null!==m;){if(m.count-=1,m.xTotal-=h,m.yTotal-=d,m.xGeohashTotal-=c,m.yGeohashTotal-=f,this._updateStatisticsCursor(a,m,-1),x>=_)return void m.remove(a.getDisplayId());const y=Math.ceil((x+1)/2),S=Math.floor((x+1)/2),b=1-x%2,R=30-(3*y+2*S),L=30-(2*y+3*S),j=((c&7*b+3*(1-b)<<R)>>R)+((f&3*b+7*(1-b)<<L)>>L)*(8*b+4*(1-b)),W=m.children[j];1===W?.count&&(this._release(W),m.children[j]=null),x+=1,m=W}}forEach(a){let h=this._root;for(;null!==h;){const d=this._linkChildren(h)||h.next;a(h),h=d}}find(a,h,d){return this._root.find(a,h,d,0,0,0)}findIf(a){let h=null;return this.forEach(d=>{a(d)&&(h=d)}),h}findAllIf(a){const h=[];return this.forEach(d=>{a(d)&&h.push(d)}),h}findSingleOccupancyNode(a,h,d,c,f){let _=this._root;for(;null!==_;){const m=_.depth,x=_.xNode,y=_.yNode,S=1-m%2,b=_.xGeohashTotal/_.count,R=_.yGeohashTotal/_.count;if(1===_.count&&a<b&&b<=d&&h<R&&R<=c)return _;if(m>=f){_=_.next;continue}const L=Math.ceil((m+1)/2),j=Math.floor((m+1)/2),W=30-(3*L+2*j),V=30-(2*L+3*j),$=~((1<<W)-1),se=~((1<<V)-1),ee=(h&se)>>V,ne=(d&$)>>W,ce=(c&se)>>V,ue=x<<3*S+2*(1-S),Ie=y<<2*S+3*(1-S),ve=ue+8*S+4*(1-S),de=Ie+4*S+8*(1-S),pe=Math.max(ue,(a&$)>>W),ye=Math.max(Ie,ee),Te=Math.min(ve,ne),Ue=Math.min(de,ce);let Oe=null,st=null;for(let Fe=ye;Fe<=Ue;Fe++)for(let qe=pe;qe<=Te;qe++){const Ae=_.children[qe-ue+(Fe-Ie)*(8*S+4*(1-S))];Ae&&(Oe||(Oe=Ae,Oe.next=_.next),st&&(st.next=Ae),st=Ae,Ae.next=_.next)}_=Oe||_.next}return null}getRegionDisplayIds(a){let h=this._root;const{bounds:d,geohashBounds:c,level:f}=a,[_,m,x,y]=d,S=[];for(;null!==h;){const b=h.depth,R=h.xNode,L=h.yNode;if(b>=f){const ke=h.xTotal/h.count,Ae=h.yTotal/h.count;ke>=_&&ke<=x&&Ae>=m&&Ae<=y&&h.displayIds.forEach(mt=>S.push(mt)),h=h.next;continue}const j=Math.ceil((b+1)/2),W=Math.floor((b+1)/2),V=1-b%2,$=30-(3*j+2*W),se=30-(2*j+3*W),te=~((1<<$)-1),ee=~((1<<se)-1),ce=(c.yLL&ee)>>se,ue=(c.xTR&te)>>$,Ie=(c.yTR&ee)>>se,ve=R<<3*V+2*(1-V),de=L<<2*V+3*(1-V),pe=ve+8*V+4*(1-V),ye=de+4*V+8*(1-V),Te=Math.max(ve,(c.xLL&te)>>$),Ue=Math.max(de,ce),Oe=Math.min(pe,ue),st=Math.min(ye,Ie);let Fe=null,qe=null;for(let ke=Ue;ke<=st;ke++)for(let Ae=Te;Ae<=Oe;Ae++){const rt=h.children[Ae-ve+(ke-de)*(8*V+4*(1-V))];rt&&(Fe||(Fe=rt,Fe.next=h.next),qe&&(qe.next=rt),qe=rt,rt.next=h.next)}h=Fe||h.next}return S}getRegionStatistics(a){let h=this._root,d=0,c=0,f=0;const _={},{bounds:m,geohashBounds:x,level:y}=a,[S,b,R,L]=m;let j=0;for(;null!==h;){const W=h.depth,V=h.xNode,$=h.yNode;if(W>=y){const yt=h.xTotal/h.count,It=h.yTotal/h.count;yt>S&&yt<=R&&It>b&&It<=L&&(d+=h.count,c+=h.xTotal,f+=h.yTotal,1===h.count&&(j=h.referenceId),this._aggregateStatistics(_,h.statistics)),h=h.next;continue}const se=Math.ceil((W+1)/2),te=Math.floor((W+1)/2),ee=1-W%2,ne=30-(3*se+2*te),ce=30-(2*se+3*te),ue=~((1<<ne)-1),Ie=~((1<<ce)-1),de=(x.yLL&Ie)>>ce,pe=(x.xTR&ue)>>ne,ye=(x.yTR&Ie)>>ce,Te=V<<3*ee+2*(1-ee),Ue=$<<2*ee+3*(1-ee),Oe=Te+8*ee+4*(1-ee),st=Ue+4*ee+8*(1-ee),Fe=Math.max(Te,(x.xLL&ue)>>ne),qe=Math.max(Ue,de),ke=Math.min(Oe,pe),Ae=Math.min(st,ye);let mt=null,rt=null;for(let yt=qe;yt<=Ae;yt++)for(let It=Fe;It<=ke;It++){const Ee=h.children[It-Te+(yt-Ue)*(8*ee+4*(1-ee))];if(Ee){if(yt!==qe&&yt!==Ae&&It!==Fe&&It!==ke){const Ms=Ee.xTotal/Ee.count,As=Ee.yTotal/Ee.count;Ms>S&&Ms<=R&&As>b&&As<=L&&(d+=Ee.count,c+=Ee.xTotal,f+=Ee.yTotal,1===Ee.count&&(j=Ee.referenceId),this._aggregateStatistics(_,Ee.statistics));continue}mt||(mt=Ee,mt.next=h.next),rt&&(rt.next=Ee),rt=Ee,Ee.next=h.next}}h=mt||h.next}return{count:d,attributes:this.normalizeStatistics(_,d),xTotal:c,yTotal:f,referenceId:j}}getBins(a){const h=[],{geohashBounds:d,level:c}=a;let f=this._root;for(;null!==f;){const _=f.depth,m=f.xNode,x=f.yNode;if(_>=c){h.push(f),f=f.next;continue}const y=Math.ceil((_+1)/2),S=Math.floor((_+1)/2),b=1-_%2,R=30-(3*y+2*S),L=30-(2*y+3*S),j=~((1<<R)-1),W=~((1<<L)-1),$=(d.yLL&W)>>L,se=(d.xTR&j)>>R,te=(d.yTR&W)>>L,ee=m<<3*b+2*(1-b),ne=x<<2*b+3*(1-b),ce=ee+8*b+4*(1-b),ue=ne+4*b+8*(1-b),Ie=Math.max(ee,(d.xLL&j)>>R),ve=Math.max(ne,$),de=Math.min(ce,se),pe=Math.min(ue,te);let ye=null,Te=null;for(let Ue=ve;Ue<=pe;Ue++)for(let Oe=Ie;Oe<=de;Oe++){const Fe=f.children[Oe-ee+(Ue-ne)*(8*b+4*(1-b))];Fe&&(ye||(ye=Fe,ye.next=f.next),Te&&(Te.next=Fe),Te=Fe,Fe.next=f.next)}f=ye||f.next}return h}_linkChildren(a){let h=null,d=null;for(let c=0;c<=a.children.length;c++){const f=a.children[c];f&&(h||(h=f,h.next=a.next),d&&(d.next=f),d=f,f.next=a.next)}return h}_updateStatisticsCursor(a,h,d){for(const c of this._statisticFields){const f=c.name,_=c.inField?a.readAttribute(c.inField):a.getComputedNumericAtIndex(c.inFieldIndex);switch(c.statisticType){case"min":if(isNaN(_))break;if(!h.statistics[f]){h.statistics[f]={value:_};break}h.statistics[f].value=Math.min(h.statistics[f].value,_);break;case"max":if(isNaN(_))break;if(!h.statistics[f]){h.statistics[f]={value:_};break}h.statistics[f].value=Math.max(h.statistics[f].value,_);break;case"count":break;case"sum":case"avg":{h.statistics[f]||(h.statistics[f]={value:0,nanCount:0});const m=h.statistics[f].value,x=h.statistics[f].nanCount??0;null==_||isNaN(_)?h.statistics[f].nanCount=x+d:h.statistics[f].value=m+d*_;break}case"avg_angle":{h.statistics[f]||(h.statistics[f]={x:0,y:0,nanCount:0});const m=h.statistics[f].x,x=h.statistics[f].y,y=h.statistics[f].nanCount??0,S=Math.PI/180;null==_||isNaN(_)?h.statistics[f].nanCount=y+d:(h.statistics[f].x=m+d*Math.cos(_*S),h.statistics[f].y=x+d*Math.sin(_*S));break}case"mode":h.statistics[f]||(h.statistics[f]={}),h.statistics[f][_]=(h.statistics[f][_]||0)+d}}}_aggregateStatistics(a,h){for(const d of this._statisticFields){const c=d.name;switch(d.statisticType){case"min":if(!a[c]){a[c]={value:h[c].value};break}a[c].value=Math.min(a[c].value,h[c].value);break;case"max":if(!a[c]){a[c]={value:h[c].value};break}a[c].value=Math.max(a[c].value,h[c].value);break;case"count":break;case"sum":case"avg":case"avg_angle":case"mode":a[c]||(a[c]={});for(const f in h[c])a[c][f]=(a[c][f]||0)+h[c][f]}}}normalizeStatistics(a,h){const d={};for(const c of this._statisticFields){const f=c.name;switch(c.statisticType){case"min":case"max":{const _=a[f];if(!h||!_)break;d[f]=_.value;break}case"count":if(!h)break;d[f]=h;break;case"sum":{if(!h)break;const{value:_,nanCount:m}=a[f];if(!(h-m))break;d[f]=_;break}case"avg":{if(!h)break;const{value:_,nanCount:m}=a[f];if(!(h-m))break;d[f]=_/(h-m);break}case"avg_angle":{if(!h)break;const{x:_,y:m,nanCount:x}=a[f];if(!(h-x))break;const b=180/Math.PI,R=Math.atan2(m/(h-x),_/(h-x))*b;d[f]=R;break}case"mode":{const _=a[f];let m=0,x=0,y=null;for(const S in _){const b=_[S];b===m?x+=1:b>m&&(m=b,x=1,y=S)}d[f]="null"===y||x>1?null:y;break}}}return d}}class ns{constructor(a,h,d,c){this.count=0,this.xTotal=0,this.yTotal=0,this.statistics={},this.displayId=0,this.referenceId=0,this.displayIds=new Set,this.next=null,this.depth=0,this.xNode=0,this.yNode=0,this.xGeohashTotal=0,this.yGeohashTotal=0,this._tree=a,this.children=new Array(32);for(let f=0;f<this.children.length;f++)this.children[f]=null;this.xNode=h,this.yNode=d,this.depth=c}realloc(a,h,d){for(let c=0;c<this.children.length;c++)this.children[c]=null;return this.xNode=a,this.yNode=h,this.depth=d,this.next=null,this.xGeohashTotal=0,this.yGeohashTotal=0,this.displayId=0,this.referenceId=0,this.xTotal=0,this.yTotal=0,this.count=0,this.statistics={},this.displayIds.clear(),this}get id(){return`${this.xNode}.${this.yNode}`}add(a){this.displayIds.add(a)}remove(a){this.displayIds.delete(a)}getAttributes(){const a=this._tree.normalizeStatistics(this.statistics,this.count);return a.referenceId=null,a.aggregateId=this.id,a.aggregateCount=this.count,a}getGeometry(a,h){const d=this.getLngLatBounds(),[c,f,_,m]=d,x=(0,pt.iV)({rings:[[[c,f],[c,m],[_,m],[_,f],[c,f]]]},ft.Z.WGS84,a),y=(0,D.Uy)(new be.Z,x,!1,!1);return(0,T.pC)(h)?(0,D.Nh)(new be.Z,y,!1,!1,"esriGeometryPolygon",h,!1,!1):y}getGeometryCentroid(a,h){const d=this.getLngLatBounds(),[c,f,_,m]=d,x=(0,pt.iV)({x:(c+_)/2,y:(f+m)/2},ft.Z.WGS84,a),y=(0,D.dd)(new be.Z,x);return(0,T.pC)(h)?(0,D.Nh)(new be.Z,y,!1,!1,"esriGeometryPoint",h,!1,!1):y}getLngLatBounds(){const a=this.depth,h=Math.ceil(a/2),d=Math.floor(a/2);return function sr(g,a){let h=-90,d=90,c=-180,f=180;for(let _=0;_<a;_++){const m=Math.ceil((_+1)/2),x=Math.floor((_+1)/2),y=1-_%2,S=30-(3*m+2*x),b=30-(2*m+3*x),L=2*y+3*(1-y),W=(7*y+3*(1-y)<<S&g.geohashX)>>S,V=(3*y+7*(1-y)<<b&g.geohashY)>>b;for(let $=3*y+2*(1-y)-1;$>=0;$--){const se=(c+f)/2,te=W&1<<$?1:0;c=(1-te)*c+te*se,f=(1-te)*se+te*f}for(let $=L-1;$>=0;$--){const se=(h+d)/2,te=V&1<<$?1:0;h=(1-te)*h+te*se,d=(1-te)*se+te*d}}return[c,h,f,d]}({geohashX:this.xNode<<30-(3*h+2*d),geohashY:this.yNode<<30-(2*h+3*d)},this.depth)}find(a,h,d,c,f,_){if(c>=d)return this;const m=1-c%2,x=3*m+2*(1-m),y=2*m+3*(1-m),S=30-f-x,b=30-_-y,L=this.children[((a&7*m+3*(1-m)<<S)>>S)+((h&3*m+7*(1-m)<<b)>>b)*(8*m+4*(1-m))];return null==L?null:L.find(a,h,d,c+1,f+x,_+y)}}var Is=M(5548),_t=M(94425),vs=M(16669),xs=M(37118),as=M(2004);const os=z.Z.getLogger("esri.view.2d.layers.features.support.BinStore"),ur=(0,Is.Ue)();function bs(g){return 57.29577951308232*g}class dr extends vs.J{constructor(a,h,d,c){super(a,d),this.type="bin",this.events=new lt.Z,this.objectIdField="aggregateId",this.featureAdapter=F.k,this._geohashLevel=5,this._geohashBuf=[],this._serviceInfo=c,this.geometryInfo=a.geometryInfo,this._spatialReference=h,this._projectionSupportCheck=(0,pt._W)(h,ft.Z.WGS84),this._bitsets.geohash=d.getBitset(d.createBitset()),this._bitsets.inserted=d.getBitset(d.createBitset())}destroy(){this._tree&&this._tree.destroy()}get featureSpatialReference(){return this._spatialReference}get fields(){return this._fields}updateSchema(a,h){var d=()=>super.updateSchema,c=this;return(0,U.Z)(function*(){const f=c._schema;try{yield d().call(c,a,h),yield c._projectionSupportCheck}catch{}c._fields=c._schema.params.fields;const _=(0,De.Hg)(f,h);h&&(!(0,T.Wi)(_)||a.source||a.storage.filters)?(((0,De.uD)(_,"params.fields")||(0,De.uD)(_,"params")||!c._tree||a.source)&&(c._tree&&c._tree.destroy(),c._tree=new ys(c._statisticFields,c._serviceInfo),c._tree.onRelease=m=>m.displayId&&c._storage.releaseDisplayId(m.displayId),c._geohashLevel=c._schema.params.fixedBinLevel,c._rebuildTree(),(0,C.Z)("esri-2d-update-debug")&&os.info("Aggregate mesh needs update due to tree changing")),(0,C.Z)("esri-2d-update-debug")&&os.info("Aggregate mesh needs update due to tree changing"),a.targets[h.name]=!0,a.mesh=!1):f&&(a.mesh=!0)})()}clear(){this._rebuildTree()}sweepFeatures(a,h){this._bitsets.inserted.forEachSet(d=>{if(!a.has(d)){const c=h.lookupByDisplayIdUnsafe(d);this._remove(c)}})}sweepAggregates(a,h,d){}onTileData(a,h,d,c,f=!0){if(!this._schema||(0,T.Wi)(h.addOrUpdate))return h;this.events.emit("changed");const _=this._getTransforms(a,this._spatialReference);{const x=h.addOrUpdate.getCursor();for(;x.next();)this._update(x,c)}if(h.status.mesh||!f)return h;const m=new Array;this._getBinsForTile(m,a,_,d),h.addOrUpdate=me.fromOptimizedFeatures(m,{...this._serviceInfo,geometryType:"esriGeometryPolygon"}),h.addOrUpdate.attachStorage(d),h.end=!0,h.isRepush||(h.clear=!0);{const x=h.addOrUpdate.getCursor();for(;x.next();){const y=x.getDisplayId();this._bitsets.computed.unset(y),this.setComputedAttributes(d,x,y,a.scale)}}return h}forEachBin(a){this._tree.forEach(a)}forEach(a){this._tree.forEach(h=>{if(h.depth!==this._geohashLevel)return;const d=this._toFeatureJSON(h),c=me.fromFeatures([d],{objectIdField:this.objectIdField,globalIdField:null,geometryType:this.geometryInfo.geometryType,fields:this.fields}).getCursor();c.next(),a(c)})}forEachInBounds(a,h){}forEachBounds(a,h){const{hasM:d,hasZ:c}=this.geometryInfo;for(const f of a){const _=(0,D.$)(ur,f.readGeometry(),c,d);(0,T.Wi)(_)||h(_)}}onTileUpdate(a){}getAggregate(a){const h=(0,fe.QS)(a,!0),d=this._tree.findIf(c=>c.displayId===h);return(0,T.yw)(d,c=>this._toFeatureJSON(c))}getAggregates(){return this._tree.findAllIf(a=>a.depth===this._geohashLevel).map(this._toFeatureJSON.bind(this))}getDisplayId(a){const h=this._tree.findIf(d=>d.id===a);return(0,T.yw)(h,d=>d.displayId)}getFeatureDisplayIdsForAggregate(a){const h=this._tree.findIf(d=>d.id===a);return(0,T.R2)(h,[],d=>Array.from(d.displayIds))}getDisplayIdForReferenceId(a){const h=this._tree.findIf(d=>1===d.displayIds.size&&d.displayIds.has(a));return(0,T.yw)(h,d=>d.displayId)}_toFeatureJSON(a){const h=this._spatialReference;return{displayId:a.displayId,attributes:a.getAttributes(),geometry:(0,D.di)(a.getGeometry(h),"esriGeometryPolygon",!1,!1),centroid:null}}_rebuildTree(){this._bitsets.computed.clear(),this._bitsets.inserted.clear(),this._tree&&this._tree.clear()}_remove(a){const h=a.getDisplayId(),d=a.getXHydrated(),c=a.getYHydrated(),f=this._geohashBuf[2*h],_=this._geohashBuf[2*h+1];this._bitsets.inserted.has(h)&&(this._bitsets.inserted.unset(h),this._tree.removeCursor(a,d,c,f,_,this._geohashLevel))}_update(a,h){const d=a.getDisplayId(),c=this._bitsets.inserted,f=h.isVisible(d);if(f===c.has(d))return;if(!f)return void this._remove(a);const _=a.getXHydrated(),m=a.getYHydrated();this._setGeohash(d,_,m)&&(this._tree.insertCursor(a,d,_,m,this._geohashBuf[2*d],this._geohashBuf[2*d+1],this._geohashLevel),c.set(d))}_setGeohash(a,h,d){if(this._bitsets.geohash.has(a))return!0;const c=this._geohashBuf;if(this._spatialReference.isWebMercator){const f=bs(h/_t.sv.radius),_=f-360*Math.floor((f+180)/360);Ht(c,a,bs(Math.PI/2-2*Math.atan(Math.exp(-d/_t.sv.radius))),_,12)}else{const f=(0,pt.iV)({x:h,y:d},this._spatialReference,ft.Z.WGS84);if(!f)return!1;Ht(c,a,f.y,f.x,12)}return this._bitsets.geohash.set(a),!0}_getBinsForTile(a,h,d,c){try{const f=this._getGeohashBounds(h),_=this._tree.getBins(f);for(const m of _){m.displayId||(m.displayId=c.createDisplayId(!0));let x=null;const y=m.getGeometry(this._spatialReference,d.tile);y||(x=m.getGeometryCentroid(this._spatialReference,d.tile));const S=new re.u_(y,m.getAttributes(),x);S.objectId=m.id,S.displayId=m.displayId,a.push(S)}}catch{return void os.error("Unable to get bins for tile",h.key.id)}}_getGeohash(a,h,d){const c={geohashX:0,geohashY:0};return Vt(c,h,a,d),c}_getGeohashBounds(a){const h=this._getGeohashLevel(a.key.level),d=[a.extent.xmin,a.extent.ymin,a.extent.xmax,a.extent.ymax],c=xs.Z.fromExtent(as.Z.fromBounds(d,this._spatialReference)),f=(0,pt.iV)(c,this._spatialReference,ft.Z.WGS84,{densificationStep:64*a.resolution}),_=(0,D.Uy)(new be.Z,f,!1,!1),m=_.coords.filter((W,V)=>!(V%2)),x=_.coords.filter((W,V)=>V%2),y=Math.min(...m),S=Math.min(...x),b=Math.max(...m),R=Math.max(...x),L=this._getGeohash(y,S,h),j=this._getGeohash(b,R,h);return{bounds:d,geohashBounds:{xLL:L.geohashX,yLL:L.geohashY,xTR:j.geohashX,yTR:j.geohashY},level:h}}_getGeohashLevel(a){return this._schema.params.fixedBinLevel}_getTransforms(a,h){const d={originPosition:"upperLeft",scale:[a.resolution,a.resolution],translate:[a.bounds[0],a.bounds[3]]},c=(0,ie.C5)(h);if(!c)return{tile:d,left:null,right:null};const[f,_]=c.valid;return{tile:d,left:{...d,translate:[_,a.bounds[3]]},right:{...d,translate:[f-_+a.bounds[0],a.bounds[3]]}}}}const cr=(0,Is.Ue)();class hs extends re.nd{constructor(a,h,d,c,f){super(new be.Z([],[h,d]),c,null,a),this.geohashBoundsInfo=f}get count(){return this.attributes.cluster_count}static create(a,h,d,c,f,_,m,x){const y=new hs(h,d,c,_,m);return y.displayId=a.createDisplayId(!0),y.referenceId=x,y.tileLevel=f,y}update(a,h,d,c,f,_){return this.geometry.coords[0]=a,this.geometry.coords[1]=h,this.tileLevel=d,this.attributes=c,this.geohashBoundsInfo=f,this.referenceId=null,this.referenceId=_,this}toJSON(){return{attributes:{...this.attributes,aggregateId:this.objectId,referenceId:1===this.attributes.cluster_count?this.referenceId:null},geometry:{x:this.geometry.coords[0],y:this.geometry.coords[1]}}}}function kt(g){return 57.29577951308232*g}class gr extends vs.J{constructor(a,h,d,c){super(a,d),this.type="cluster",this.events=new lt.Z,this.objectIdField="aggregateId",this.featureAdapter=F.k,this._geohashLevel=0,this._tileLevel=0,this._aggregateValueRanges={},this._aggregateValueRangesChanged=!1,this._geohashBuf=[],this._clusters=new Map,this._tiles=new Map,this._serviceInfo=c,this.geometryInfo=a.geometryInfo,this._spatialReference=h,this._projectionSupportCheck=(0,pt._W)(h,ft.Z.WGS84),this._bitsets.geohash=d.getBitset(d.createBitset()),this._bitsets.inserted=d.getBitset(d.createBitset())}destroy(){this._tree.destroy()}get featureSpatialReference(){return this._spatialReference}get fields(){return this._fields}updateSchema(a,h){var d=()=>super.updateSchema,c=this;return(0,U.Z)(function*(){const f=c._schema;try{yield d().call(c,a,h),yield c._projectionSupportCheck}catch{}c._fields=c._schema.params.fields;const _=(0,De.Hg)(f,h);h&&(!(0,T.Wi)(_)||a.source||a.storage.filters)?(((0,De.uD)(_,"params.fields")||!c._tree||a.source)&&(c._tree&&c._tree.destroy(),c._tree=new ys(c._statisticFields,c._serviceInfo),c._rebuildTree(),(0,C.Z)("esri-2d-update-debug")&&console.debug("Aggregate mesh needs update due to tree changing")),(0,C.Z)("esri-2d-update-debug")&&console.debug("Applying Update - ClusterStore:",_),a.targets[h.name]=!0,a.mesh=!1,c._aggregateValueRanges={}):f&&(a.mesh=!0)})()}clear(){this._rebuildTree()}sweepFeatures(a,h){this._bitsets.inserted.forEachSet(d=>{if(!a.has(d)){const c=h.lookupByDisplayIdUnsafe(d);this._remove(c)}})}sweepAggregates(a,h,d){this._clusters.forEach((c,f)=>{c&&c.tileLevel!==d&&(a.releaseDisplayId(c.displayId),h.unsetAttributeData(c.displayId),this._clusters.delete(f))})}onTileData(a,h,d,c,f=!0){if(!this._schema||(0,T.Wi)(h.addOrUpdate))return h;this.events.emit("changed");const _=this._getTransforms(a,this._spatialReference);{const y=h.addOrUpdate.getCursor();for(;y.next();)this._update(y,c)}if(h.status.mesh||!f)return h;const m=new Array;this._getClustersForTile(m,a,this._schema.params.clusterRadius,d,_),h.addOrUpdate=me.fromOptimizedFeatures(m,this._serviceInfo),h.addOrUpdate.attachStorage(d),h.clear=!0,h.end=!0;{const y=h.addOrUpdate.getCursor();for(;y.next();){const S=y.getDisplayId();this._bitsets.computed.unset(S),this.setComputedAttributes(d,y,S,a.scale)}}return this._aggregateValueRangesChanged&&h.end&&(this.events.emit("valueRangesChanged",{valueRanges:this._aggregateValueRanges}),this._aggregateValueRangesChanged=!1),h}onTileUpdate({added:a,removed:h}){if(a.length){const c=a[0].level;this._tileLevel=c,this._setGeohashLevel(c)}if(!this._schema)return;const d=this._schema.params.clusterRadius;h.forEach(c=>{this._tiles.delete(c.key.id),this._markTileClustersForDeletion(c,d)})}getAggregate(a){for(const h of this._clusters.values())if((h?.displayId&fe._I)==(a&fe._I))return h.toJSON();return null}getAggregates(){const a=[];for(const h of this._clusters.values())h?.tileLevel===this._tileLevel&&a.push(h.toJSON());return a}getDisplayId(a){const h=this._clusters.get(a);return h?h.displayId:null}getFeatureDisplayIdsForAggregate(a){const h=this._clusters.get(a);return h?this._tree.getRegionDisplayIds(h.geohashBoundsInfo):[]}getDisplayIdForReferenceId(a){for(const h of this._clusters.values())if(h?.referenceId===a)return h.displayId;return null}getAggregateValueRanges(){return this._aggregateValueRanges}forEach(a){this._clusters.forEach(h=>{if(!h)return;const d=h.toJSON(),c=me.fromFeatures([d],{objectIdField:this.objectIdField,globalIdField:null,geometryType:this.geometryInfo.geometryType,fields:this.fields}).getCursor();c.next(),a(c)})}forEachInBounds(a,h){}forEachBounds(a,h){const{hasM:d,hasZ:c}=this.geometryInfo;for(const f of a){const _=(0,D.$)(cr,f.readGeometry(),c,d);(0,T.Wi)(_)||h(_)}}size(){let a=0;return this.forEach(h=>a++),a}_rebuildTree(){this._bitsets.computed.clear(),this._bitsets.inserted.clear(),this._tree&&this._tree.clear()}_remove(a){const h=a.getDisplayId(),d=a.getXHydrated(),c=a.getYHydrated(),f=this._geohashBuf[2*h],_=this._geohashBuf[2*h+1];this._bitsets.inserted.has(h)&&(this._bitsets.inserted.unset(h),this._tree.removeCursor(a,d,c,f,_,this._geohashLevel))}_update(a,h){const d=a.getDisplayId(),c=this._bitsets.inserted,f=h.isVisible(d);if(f===c.has(d))return;if(!f)return void this._remove(a);const _=a.getXHydrated(),m=a.getYHydrated();this._setGeohash(d,_,m)&&(this._tree.insertCursor(a,d,_,m,this._geohashBuf[2*d],this._geohashBuf[2*d+1],this._geohashLevel),c.set(d))}_setGeohash(a,h,d){if(this._bitsets.geohash.has(a))return!0;const c=this._geohashBuf;if(this._spatialReference.isWebMercator){const f=kt(h/_t.sv.radius),_=f-360*Math.floor((f+180)/360);Ht(c,a,kt(Math.PI/2-2*Math.atan(Math.exp(-d/_t.sv.radius))),_,12)}else{const f=(0,pt.iV)({x:h,y:d},this._spatialReference,ft.Z.WGS84);if(!f)return!1;Ht(c,a,f.y,f.x,12)}return this._bitsets.geohash.set(a),!0}_getClustersForTile(a,h,d,c,f,_=!0){const m=this._schema.params.clusterPixelBuffer,x=2*d,y=Math.ceil(2**h.key.level*Ce.I_/x)+1,S=Math.ceil(m/x)+0,b=Math.ceil(Ce.I_/x),{row:R,col:L}=h.key,W=R*Ce.I_,V=Math.floor(L*Ce.I_/x)-S,$=Math.floor(W/x)-S,se=V+b+2*S,te=$+b+2*S,ee=h.tileInfoView.getLODInfoAt(h.key.level);for(let ne=V;ne<=se;ne++)for(let ce=$;ce<=te;ce++){let ue=ne;ee.wrap&&(ue=ne<0?ne+y:ne%y);const Ie=ee.wrap&&ne<0,ve=ee.wrap&&ne%y!==ne,de=this._lookupCluster(c,ee,h.key.level,ue,ce,h);if((0,T.pC)(de)){const pe=(0,T.yw)(f,ye=>Ie?ye.left:ve?ye.right:ye.tile);if(_&&(0,T.Wi)(pe)||!de.count)continue;if((0,T.pC)(pe)&&_){const ye=de.geometry.clone();let Te=de.attributes;ye.coords[0]=(0,D.Jd)(pe,ye.coords[0]),ye.coords[1]=(0,D.IN)(pe,ye.coords[1]),1===de.count&&(0,T.pC)(de.referenceId)&&(Te={...de.attributes,referenceId:de.referenceId});const Ue=new re.u_(ye,Te);Ue.displayId=de.displayId,a.push(Ue)}}}}_getGeohashLevel(a){return Math.min(Math.ceil(a/2+2),12)}_setGeohashLevel(a){const h=this._getGeohashLevel(a),d=1*(Math.floor(h/1)+1)-1;if(this._geohashLevel!==d)return this._geohashLevel=d,this._rebuildTree(),void this._bitsets.geohash.clear()}_getTransforms(a,h){const d={originPosition:"upperLeft",scale:[a.resolution,a.resolution],translate:[a.bounds[0],a.bounds[3]]},c=(0,ie.C5)(h);if(!c)return{tile:d,left:null,right:null};const[f,_]=c.valid;return{tile:d,left:{...d,translate:[_,a.bounds[3]]},right:{...d,translate:[f-_+a.bounds[0],a.bounds[3]]}}}_getClusterId(a,h,d){return(15&a)<<28|(16383&h)<<14|16383&d}_markForDeletion(a,h,d){const c=this._getClusterId(a,h,d);this._clusters.delete(c)}_getClusterBounds(a,h,d){const c=this._schema.params.clusterRadius,f=2*c;let _=d%2?h*f:h*f-c;const m=d*f;let x=_+f;const S=2**a.level*Ce.I_;a.wrap&&_<0&&(_=0),a.wrap&&x>S&&(x=S);const R=m/Ce.I_,L=x/Ce.I_,j=(m-f)/Ce.I_;return[a.getXForColumn(_/Ce.I_),a.getYForRow(R),a.getXForColumn(L),a.getYForRow(j)]}_getGeohash(a,h,d){const c={geohashX:0,geohashY:0};return Vt(c,h,a,d),c}_getGeohashBounds(a,h){const d=this._getGeohashLevel(a.key.level);if(this._spatialReference.isWebMercator){const[W,V,$,se]=h,te={x:W,y:V},ee={x:$,y:se};let ne=0,ce=0,ue=0,Ie=0;{const pe=kt(te.x/_t.sv.radius);ne=pe-360*Math.floor((pe+180)/360),ce=kt(Math.PI/2-2*Math.atan(Math.exp(-te.y/_t.sv.radius)))}{const pe=kt(ee.x/_t.sv.radius);ue=pe-360*Math.floor((pe+180)/360),Ie=kt(Math.PI/2-2*Math.atan(Math.exp(-ee.y/_t.sv.radius)))}const ve={geohashX:0,geohashY:0},de={geohashX:0,geohashY:0};return Vt(ve,ce,ne,d),Vt(de,Ie,ue,d),{bounds:[W,V,$,se],geohashBounds:{xLL:ve.geohashX,yLL:ve.geohashY,xTR:de.geohashX,yTR:de.geohashY},level:d}}const c=xs.Z.fromExtent(as.Z.fromBounds(h,this._spatialReference)),f=(0,pt.iV)(c,this._spatialReference,ft.Z.WGS84,{densificationStep:64*a.resolution});if(!f)return null;const _=(0,D.Uy)(new be.Z,f,!1,!1),m=_.coords.filter((W,V)=>!(V%2)),x=_.coords.filter((W,V)=>V%2),y=Math.min(...m),S=Math.min(...x),b=Math.max(...m),R=Math.max(...x),L=this._getGeohash(y,S,d),j=this._getGeohash(b,R,d);return{bounds:h,geohashBounds:{xLL:L.geohashX,yLL:L.geohashY,xTR:j.geohashX,yTR:j.geohashY},level:d}}_lookupCluster(a,h,d,c,f,_){const m=this._getClusterId(d,c,f),x=this._clusters.get(m),y=this._getClusterBounds(h,c,f),S=this._getGeohashBounds(_,y);if((0,T.Wi)(S))return null;const b=this._tree.getRegionStatistics(S),{count:R,xTotal:L,yTotal:j,referenceId:W}=b,V=R?L/R:0,$=R?j/R:0;if(0===R)return this._clusters.set(m,null),null;const se={cluster_count:R,...b.attributes},te=(0,T.pC)(x)?x.update(V,$,d,se,S,W):hs.create(a,m,V,$,d,se,S,W);if(0===R){const[ee,ne,ce,ue]=y;te.geometry.coords[0]=(ee+ce)/2,te.geometry.coords[1]=(ne+ue)/2}return this._clusters.set(m,te),this._updateAggregateValueRangeForCluster(te,te.tileLevel),te}_updateAggregateValueRangeForCluster(a,h){const d=this._aggregateValueRanges[h]||{minValue:1/0,maxValue:0},c=d.minValue,f=d.maxValue;d.minValue=Math.min(c,a.count),d.maxValue=Math.max(f,a.count),this._aggregateValueRanges[h]=d,c===d.minValue&&f===d.maxValue||(this._aggregateValueRangesChanged=!0)}_markTileClustersForDeletion(a,h){const d=2*h,c=Math.ceil(Ce.I_/d),{row:f,col:_}=a.key,x=f*Ce.I_,y=Math.floor(_*Ce.I_/d),S=Math.floor(x/d);for(let b=y;b<y+c;b++)for(let R=S;R<S+c;R++)this._markForDeletion(a.key.level,b,R)}}class fr{constructor(){this._freeIds=[],this._idCounter=1}createId(a=!1){return(0,fe.QS)(this._getFreeId(),a)}releaseId(a){this._freeIds.push(a)}_getFreeId(){return this._freeIds.length?this._freeIds.pop():this._idCounter++}}var pr=M(42797);function qt(g,a,h){if(!(g.length>a))for(;g.length<=a;)g.push(h)}class _r{constructor(){this._numerics=[],this._strings=[],this._idGenerator=new fr,this._allocatedSize=256,this._bitsets=[],this._instanceIds=[],this._bounds=[]}createBitset(){const a=this._bitsets.length;return this._bitsets.push(pr.p.create(this._allocatedSize,fe._I)),a+1}getBitset(a){return this._bitsets[a-1]}_expand(){this._allocatedSize<<=1;for(const a of this._bitsets)a.resize(this._allocatedSize)}_ensureNumeric(a,h){this._numerics[a]||(this._numerics[a]=[]),qt(this._numerics[a],h,0)}_ensureInstanceId(a){qt(this._instanceIds,a,0)}_ensureString(a,h){this._strings[a]||(this._strings[a]=[]),qt(this._strings[a],h,null)}createDisplayId(a=!1){const h=this._idGenerator.createId();return h>this._allocatedSize&&this._expand(),(0,fe.QS)(h,a)}releaseDisplayId(a){for(const h of this._bitsets)h.unset(a);return this._idGenerator.releaseId(a&fe._I)}getComputedNumeric(a,h){return this.getComputedNumericAtIndex(a&fe._I,0)}setComputedNumeric(a,h,d){return this.setComputedNumericAtIndex(a&fe._I,d,0)}getComputedString(a,h){return this.getComputedStringAtIndex(a&fe._I,0)}setComputedString(a,h,d){return this.setComputedStringAtIndex(a&fe._I,0,d)}getComputedNumericAtIndex(a,h){const d=a&fe._I;return this._ensureNumeric(h,d),this._numerics[h][d]}setComputedNumericAtIndex(a,h,d){const c=a&fe._I;this._ensureNumeric(h,c),this._numerics[h][c]=d}getInstanceId(a){const h=a&fe._I;return this._ensureInstanceId(h),this._instanceIds[h]}setInstanceId(a,h){const d=a&fe._I;this._ensureInstanceId(d),this._instanceIds[d]=h}getComputedStringAtIndex(a,h){const d=a&fe._I;return this._ensureString(h,d),this._strings[h][d]}setComputedStringAtIndex(a,h,d){const c=a&fe._I;this._ensureString(h,c),this._strings[h][c]=d}getXMin(a){return this._bounds[4*(a&fe._I)]}getYMin(a){return this._bounds[4*(a&fe._I)+1]}getXMax(a){return this._bounds[4*(a&fe._I)+2]}getYMax(a){return this._bounds[4*(a&fe._I)+3]}setBounds(a,h){const d=h.readHydratedGeometry();if(!d||!d.coords.length)return!1;let c=1/0,f=1/0,_=-1/0,m=-1/0;d.forEachVertex((y,S)=>{c=Math.min(c,y),f=Math.min(f,S),_=Math.max(_,y),m=Math.max(m,S)});const x=a&fe._I;return qt(this._bounds,4*x+4,0),this._bounds[4*x]=c,this._bounds[4*x+1]=f,this._bounds[4*x+2]=_,this._bounds[4*x+3]=m,!0}}function tt(g){if(!(0,k.D_)(g)&&!function xr(g){return"worker:port-closed"===g.name}(g))throw g}function Ts(g){return"feature"===g.type&&"snapshot"===g.mode}let Ne=class extends ae.Z{constructor(){super(...arguments),this._storage=new _r,this._markedIdsBufId=this._storage.createBitset(),this._lastCleanup=performance.now(),this._cleanupNeeded=!1,this._invalidated=!1,this._tileToResolver=new Map,this._didEdit=!1,this._updateVersion=1,this.tileStore=null,this.config=null,this.processor=null,this.remoteClient=null,this.service=null}initialize(){this._initStores(),this._initSource(),this._updateQueue=new Be.e({concurrency:"stream"===this._source.type?1:4,process:(g,a)=>this._onTileMessage(g,{signal:a})}),this.addHandles([this.tileStore.on("update",this.onTileUpdate.bind(this)),(0,Z.gx)(()=>!this.updating,()=>this.onIdle())]),this._checkUpdating=setInterval(()=>this.notifyChange("updating"),300)}_initSource(){this._source=function Ns(g,a,h,d,c,f){const _=function ks(g,a,h,d,c,f){switch(g.type){case"snapshot":return{type:"feature",origin:"snapshot",featureCount:(0,T.Pt)(g.featureCount,0),serviceInfo:g,onMessage:d,outSR:a,tileInfoView:h,canAcceptRequest:c,store:f};case"stream":return{type:"stream",serviceInfo:g,onMessage:d,outSR:a,canAcceptRequest:c};case"memory":case"on-demand":return{type:"feature",serviceInfo:g,onMessage:d,outSR:a,origin:function _(m){return Array.isArray(m)?"local":"path"in m&&(0,w.M8)(m.path)?"hosted":"unknown"}(g.source),tileInfoView:h,canAcceptRequest:c}}}(g,a,h,d,c,f);switch(_.type){case"feature":switch(_.origin){case"hosted":case"local":return new Kt(_);case"snapshot":return new Es(_);default:return new Wt(_)}case"stream":return new Lt(_)}}(this.service,this.spatialReference,this.tileStore.tileScheme,(d,c)=>(this._invalidated=!0,this._patchTile(d,c)),()=>this._updateQueue&&this._updateQueue.length<50,this.featureStore),this._proxyEvents()}_proxyEvents(){if("stream"===this._source.type){const g=this._source.events,a=this._source;this.addHandles([(0,Z.YP)(()=>a.connectionStatus,h=>this.remoteClient.invoke("setProperty",{propertyName:"connectionStatus",value:h}).catch(tt),{initial:!0}),(0,Z.YP)(()=>a.errorString,h=>this.remoteClient.invoke("setProperty",{propertyName:"errorString",value:h}).catch(tt),{initial:!0}),g.on("data-received",h=>this.remoteClient.invoke("emitEvent",{name:"data-received",event:{attributes:h.attributes,centroid:h.centroid,geometry:h.geometry}}).catch(tt)),g.on("message-received",h=>this.remoteClient.invoke("emitEvent",{name:"message-received",event:h}).catch(tt)),g.on("updateRate",h=>this.remoteClient.invoke("emitEvent",{name:"update-rate",event:{...h}}).catch(tt))])}}_initAttributeStore(g){this.attributeStore||(this.attributeStore=new qs({type:"remote",initialize:(a,h)=>(0,k.R8)(this.remoteClient.invoke("tileRenderer.featuresView.attributeView.initialize",a,{signal:h}).catch(tt)),update:(a,h)=>(0,k.R8)(this.remoteClient.invoke("tileRenderer.featuresView.attributeView.requestUpdate",a,{signal:h}).catch(tt)),render:a=>(0,k.R8)(this.remoteClient.invoke("tileRenderer.featuresView.requestRender",void 0,{signal:a}).catch(tt))},g,()=>this.notifyChange("updating")))}_initStores(){this.featureStore=new F.p({geometryInfo:{geometryType:this.service.geometryType,hasM:!1,hasZ:!1},spatialReference:this.spatialReference,fieldsIndex:this.fieldsIndex,fields:this.service.fields},this._storage,"snapshot"===this.service.type?"snapshot":"on-demand")}_initQueryEngine(g){const a=this;this.featureQueryEngine?.destroy(),this.featureQueryEngine=new v.q({definitionExpression:g.schema.source.definitionExpression??void 0,fields:this.service.fields,geometryType:this.service.geometryType,objectIdField:this.service.objectIdField,hasM:!1,hasZ:!1,spatialReference:this.spatialReference.toJSON(),cacheSpatialQueries:!0,featureStore:this.featureStore,aggregateAdapter:{getFeatureObjectIds:h=>(0,T.Wi)(a.aggregateStore)?[]:a.aggregateStore.getFeatureDisplayIdsForAggregate(h).map(d=>a.getObjectId(d))},timeInfo:this.service.timeInfo})}_initAggregateQueryEngine(g,a){if(this.aggregateQueryEngine?.destroy(),(0,T.Wi)(g))return;const h=a.targets.aggregate.params.fields.slice();this.aggregateQueryEngine=new v.q({definitionExpression:void 0,fields:h,geometryType:g.geometryInfo.geometryType,objectIdField:g.objectIdField,hasM:g.geometryInfo.hasM,hasZ:g.geometryInfo.hasZ,spatialReference:this.spatialReference.toJSON(),cacheSpatialQueries:!1,featureStore:g,aggregateAdapter:{getFeatureObjectIds:d=>[]}})}destroy(){this._updateQueue.destroy(),this._source.destroy(),this.featureQueryEngine?.destroy(),this.aggregateQueryEngine?.destroy(),this.attributeStore?.destroy();for(const g of this.tileStore.tiles)this._source.unsubscribe(g);clearInterval(this._checkUpdating)}get fieldsIndex(){return new I.Z(this.service.fields)}get spatialReference(){return this.tileStore.tileScheme.spatialReference}get updating(){return this.isUpdating()}isUpdating(){const g=this._source.updating,a=!!this._updateQueue.length,h=!this.attributeStore||this.attributeStore.isUpdating(),d=g||a||h;return(0,C.Z)("esri-2d-log-updating")&&console.log(`Updating FeatureController2D: ${d}\n  -> updatingSource ${g}\n  -> updateQueue ${a}\n  -> updatingAttributeStore ${h}\n`),d}updateCustomParameters(g){"stream"===this._source.type&&this._source.updateCustomParameters(g)}enableEvent(g){this._source.enableEvent(g.name,g.value)}pause(){this._updateQueue.pause(),this._updateQueue.clear()}resume(){this._updateQueue.resume()}pauseStream(){"stream"===this._source.type&&this._source.pauseStream()}resumeStream(){"stream"===this._source.type&&this._source.resumeStream()}sendMessageToSocket(g){"stream"===this._source.type&&this._source.sendMessageToSocket(g)}sendMessageToClient(g){"stream"===this._source.type&&this._source.sendMessageToClient(g)}_initAggregateStore(g){const a=g.schema.targets?.aggregate?.type;if((0,T.yw)(this.config,d=>d.schema.targets?.aggregate?.type)!==a&&((0,T.pC)(this.aggregateStore)&&(this.removeHandles("valueRangesChanged"),this.aggregateStore.destroy(),this.aggregateStore=null),a)){switch(a){case"cluster":this.aggregateStore=new gr({geometryInfo:{geometryType:"esriGeometryPoint",hasM:!1,hasZ:!1},spatialReference:this.spatialReference,fieldsIndex:this.fieldsIndex,fields:this.service.fields},this.spatialReference,this._storage,this.service),this.addHandles(this.aggregateStore.events.on("valueRangesChanged",c=>{this.remoteClient.invoke("emitEvent",{name:"valueRangesChanged",event:{valueRanges:c.valueRanges}}).catch(tt)}),"valueRangesChanged");break;case"bin":this.aggregateStore=new dr({geometryInfo:{geometryType:"esriGeometryPolygon",hasM:!1,hasZ:!1},spatialReference:this.spatialReference,fieldsIndex:this.fieldsIndex,fields:this.service.fields},this.spatialReference,this._storage,this.service)}this.aggregateStore.onTileUpdate({added:this.tileStore.tiles,removed:[]})}}update(g,a){var h=this;return(0,U.Z)(function*(){h._updateVersion++,h._initQueryEngine(a),h._initAttributeStore(a),h.pause(),yield Promise.all([h._source.update(g,a.schema.source),h.featureStore.updateSchema(g,a.schema.targets.feature),h.attributeStore.update(g,a),h.attributeStore.updateFilters(g,a,h)]),h._initAggregateStore(a),(0,T.pC)(h.aggregateStore)&&(yield h.aggregateStore.updateSchema(g,a.schema.targets.aggregate)),h._initAggregateQueryEngine(h.aggregateStore,a.schema),(0,C.Z)("esri-2d-update-debug")&&g.describe(),h._set("config",a)})()}applyUpdate(g){var a=this;return(0,U.Z)(function*(){g.version=a._updateVersion,(0,C.Z)("esri-2d-update-debug")&&console.debug(`Applying update ${g.version}`),g.mesh&&a.clearTiles(),a._updateQueue.resume(),yield a._source.applyUpdate(g),a.notifyChange("updating"),yield(0,Z.N1)(()=>!a.updating),(0,T.pC)(a.aggregateStore)&&(yield(0,k.e4)(10),yield(0,Z.N1)(()=>!a.updating))})()}onEdits({edits:g}){var a=this;return(0,U.Z)(function*(){(0,C.Z)("esri-2d-update-debug")&&console.debug("Applying Edit:",g),a._didEdit=!0;try{const h=g.removed.map(c=>c.objectId&&-1!==c.objectId?c.objectId:a._lookupObjectIdByGlobalId(c.globalId)),d=g.addOrModified.map(({objectId:c})=>c);a.featureStore.invalidate(),yield a._source.edit(d,h),a.clearTiles(),a.notifyChange("updating"),(0,T.pC)(a.aggregateStore)&&a.aggregateStore.clear(),yield a._source.resend(),yield(0,Z.N1)(()=>!a.updating)}catch{}})()}refresh(g){var a=this;return(0,U.Z)(function*(){if(!g.dataChanged){const h=oe.empty();return h.storage.filters=!0,a.applyUpdate(h)}a.featureStore.invalidate(),a.clearTiles(),a._source.refresh(a._updateVersion,g),a._cleanupNeeded=!0,a.notifyChange("updating"),yield(0,Z.N1)(()=>!a.updating)})()}clearTiles(){for(const g of this.tileStore.tiles)this.processor.onTileClear(g)}onTileUpdate(g){(0,T.pC)(this.aggregateStore)&&this.aggregateStore.onTileUpdate(g);for(const a of g.added)this._source.subscribe(a,this._updateVersion),this._level=a.level;for(const a of g.removed)this._source.unsubscribe(a),this._cleanupNeeded=!0,this._tileToResolver.has(a.id)&&(this._tileToResolver.get(a.id).resolve(),this._tileToResolver.delete(a.id));this.notifyChange("updating")}onIdle(){var g=this;return(0,U.Z)(function*(){g._invalidated&&(g._invalidated=!1,((0,T.pC)(g.aggregateStore)||"heatmap"===g.processor.type)&&(yield g._repushCurrentLevelTiles())),g._markAndSweep()})()}querySummaryStatistics({query:g,params:a}){var h=this;return(0,U.Z)(function*(){return h.featureQueryEngine.executeQueryForSummaryStatistics(g,a)})()}queryAggregateSummaryStatistics({query:g,params:a}){var h=this;return(0,U.Z)(function*(){return h.aggregateQueryEngine.executeQueryForSummaryStatistics(g,a)})()}queryUniqueValues({query:g,params:a}){var h=this;return(0,U.Z)(function*(){return h.featureQueryEngine.executeQueryForUniqueValues(g,a)})()}queryAggregateUniqueValues({query:g,params:a}){var h=this;return(0,U.Z)(function*(){return h.aggregateQueryEngine.executeQueryForUniqueValues(g,a)})()}queryClassBreaks({query:g,params:a}){var h=this;return(0,U.Z)(function*(){return h.featureQueryEngine.executeQueryForClassBreaks(g,a)})()}queryAggregateClassBreaks({query:g,params:a}){var h=this;return(0,U.Z)(function*(){return h.aggregateQueryEngine.executeQueryForClassBreaks(g,a)})()}queryHistogram({query:g,params:a}){var h=this;return(0,U.Z)(function*(){return h.featureQueryEngine.executeQueryForHistogram(g,a)})()}queryAggregateHistogram({query:g,params:a}){var h=this;return(0,U.Z)(function*(){return h.aggregateQueryEngine.executeQueryForHistogram(g,a)})()}queryExtent(g){return this.featureQueryEngine.executeQueryForExtent(g)}queryAggregates(g){return this.aggregateQueryEngine.executeQuery(g)}queryAggregateCount(g){return this.aggregateQueryEngine.executeQueryForCount(g)}queryAggregateIds(g){return this.aggregateQueryEngine.executeQueryForIds(g)}queryFeatures(g){return this.featureQueryEngine.executeQuery(g)}queryVisibleFeatures(g){var a=this;return(0,U.Z)(function*(){const h=yield a.featureQueryEngine.executeQuery(g),d=h.objectIdFieldName;return h.features=h.features.filter(c=>{const _=a.getDisplayId(c.attributes[d]);return(0,T.yw)(_,m=>a.attributeStore.isVisible(m))}),h})()}queryFeatureCount(g){return this.featureQueryEngine.executeQueryForCount(g)}queryLatestObservations(g){return this.featureQueryEngine.executeQueryForLatestObservations(g)}queryObjectIds(g){return this.featureQueryEngine.executeQueryForIds(g)}queryStatistics(){var g=this;return(0,U.Z)(function*(){return g.featureStore.storeStatistics})()}getObjectId(g){return this.featureStore.lookupObjectId(g,this._storage)}getDisplayId(g){if((0,T.pC)(this.aggregateStore)){const a=this.aggregateStore.getDisplayId(g);if((0,T.Wi)(a)){const h=this.featureStore.lookupDisplayId(g);return this.aggregateStore.getDisplayIdForReferenceId(h)}return a}return this.featureStore.lookupDisplayId(g)}getFeatures(g){const a=[],h=[];for(const d of g){const c=(0,T.pC)(this.aggregateStore)?this.getAggregate(d):null;if((0,T.pC)(c))if((0,T.pC)(c.attributes.referenceId)){const f=this.getFeature(c.attributes.referenceId);(0,T.pC)(f)&&a.push(f)}else h.push(c);else{const f=this.getFeature(d);(0,T.pC)(f)&&a.push(f)}}return{features:a,aggregates:h}}getFeature(g){const a=this.featureStore.lookupFeatureByDisplayId(g,this._storage);if((0,T.Wi)(a))return null;const h=a.readHydratedGeometry(),d=(0,D.di)(h,a.geometryType,a.hasZ,a.hasM);return{attributes:a.readAttributes(),geometry:d}}getAggregate(g){return(0,T.Wi)(this.aggregateStore)?null:this.aggregateStore.getAggregate(g)}getAggregates(){return(0,T.Wi)(this.aggregateStore)?[]:this.aggregateStore.getAggregates()}setHighlight(g){var a=this;return(0,U.Z)(function*(){const h=(0,T.lV)(g.map(d=>a.getDisplayId(d)));return a.attributeStore.setHighlight(g,h)})()}_lookupObjectIdByGlobalId(g){const a=this.service.globalIdField;if((0,T.Wi)(a))throw new Error("Expected globalIdField to be defined");let h=null;if(this.featureStore.forEach(d=>{g===d.readAttribute(a)&&(h=d.getObjectId())}),(0,T.Wi)(h))throw new Error(`Expected to find a feature with globalId ${g}`);return h}_repushCurrentLevelTiles(){var g=this;return(0,U.Z)(function*(){const a=g.tileStore.tiles.filter(d=>d.level===g._level);a.map(function(){var d=(0,U.Z)(function*(c){return g._patchTile({type:"append",id:c.key.id,clear:!0,addOrUpdate:null,end:!1})});return function(c){return d.apply(this,arguments)}}());const h=a.map(function(){var d=(0,U.Z)(function*(c){return g._patchTile({type:"append",id:c.key.id,addOrUpdate:me.fromOptimizedFeatures([],g.service),remove:[],end:!0,isRepush:!0,status:oe.empty()})});return function(c){return d.apply(this,arguments)}}());yield Promise.all(h)})()}_maybeForceCleanup(){performance.now()-this._lastCleanup>5e3&&this._markAndSweep()}_patchTile(g,a){const h=this._updateQueue.push(g,a).then(()=>{this.notifyChange("updating")}).catch(d=>{this.notifyChange("updating")});return this.notifyChange("updating"),h}_onTileMessage(g,a){var h=this;return(0,U.Z)(function*(){if((0,k.k_)(a),(0,C.Z)("esri-2d-update-debug")){const _=(0,T.yw)(g.addOrUpdate,m=>m.hasFeatures);console.debug(g.id,`FeatureController:onTileMessage: [clear:${g.clear}, end:${g.end}, features: ${_}]`)}const d=h.tileStore.get(g.id);if(!d)return;if(g.clear)return h.processor.onTileClear(d);const c=g.status;h._cleanupNeeded=!0;const f=[];for(const _ of g.remove??[]){const m=h.featureStore.lookupDisplayId(_);m&&f.push(m)}g.remove=f;try{if((0,T.Wi)(g.addOrUpdate))return void h.processor.onTileMessage(d,{...g,addOrUpdate:null},(0,T.pC)(h.aggregateStore),a).catch(k.H9);if(g.addOrUpdate.setArcadeSpatialReference(h.spatialReference),h.featureStore.hasInstance(g.addOrUpdate.instance)&&c.targets.feature||(c.targets.feature=!0,h.featureStore.onTileData(d,g)),(!c.storage.data||!c.storage.filters)&&(c.storage.data=!0,c.storage.filters=!0,h.attributeStore.onTileData(d,g),"stream"===h._source.type||h._didEdit?(yield h.attributeStore.sendUpdates(),(0,k.k_)(a)):h.attributeStore.sendUpdates()),(0,T.pC)(h.aggregateStore)&&!c.targets.aggregate){c.targets.aggregate=!0;const _=Ts(h._source)&&h._source.loading,m=!Ts(h._source)||_||g.end;if(h.aggregateStore.onTileData(d,g,h._storage,h.attributeStore,m),!m)return;c.mesh||(h.attributeStore.onTileData(d,g),yield h.attributeStore.sendUpdates())}if(!c.mesh){c.mesh=!0;const _=(0,T.pC)(h.aggregateStore)&&"cluster"===h.aggregateStore.type;yield h.processor.onTileMessage(d,g,_,a),(0,k.k_)(a)}h._maybeForceCleanup()}catch(_){(0,k.H9)(_)}})()}_mark(g,a,h){const d=(4294901760&this._storage.getInstanceId(g))>>>16;g&&(a.add(d),h.set(g))}_markAndSweep(){if(this._lastCleanup=performance.now(),"feature"===this._source.type&&"snapshot"===this._source.mode||"stream"!==this._source.type&&!this._cleanupNeeded)return;this._cleanupNeeded=!1;const g=this._storage.getBitset(this._markedIdsBufId),a=new Set;g.clear();for(const h of this.tileStore.tiles)for(const d of this._source.readers(h.id)){const c=d.getCursor();for(;c.next();){let f=c.getDisplayId();if(!f){const _=c.getObjectId();f=this.featureStore.lookupDisplayId(_)}this._mark(f,a,g)}}"symbol"===this.processor.type&&this.processor.forEachBufferId(h=>{this._mark(h,a,g)}),this._updateQueue.forEach(h=>{for(const d of h.remove??[]){const c=this.featureStore.lookupDisplayId(d);this._mark(c,a,g)}}),(0,T.pC)(this.aggregateStore)&&(this.aggregateStore.sweepFeatures(g,this.featureStore),"sweepAggregates"in this.aggregateStore&&this.aggregateStore.sweepAggregates(this._storage,this.attributeStore,this._level)),this.featureStore.sweepFeatures(g,this._storage,this.attributeStore),this.featureStore.sweepFeatureSets(a)}};(0,q._)([(0,O.Cb)({constructOnly:!0})],Ne.prototype,"tileStore",void 0),(0,q._)([(0,O.Cb)()],Ne.prototype,"config",void 0),(0,q._)([(0,O.Cb)({readOnly:!0})],Ne.prototype,"fieldsIndex",null),(0,q._)([(0,O.Cb)()],Ne.prototype,"processor",void 0),(0,q._)([(0,O.Cb)({constructOnly:!0})],Ne.prototype,"remoteClient",void 0),(0,q._)([(0,O.Cb)({constructOnly:!0})],Ne.prototype,"service",void 0),(0,q._)([(0,O.Cb)()],Ne.prototype,"spatialReference",null),(0,q._)([(0,O.Cb)()],Ne.prototype,"updating",null),Ne=(0,q._)([(0,X.j)("esri.views.2d.layers.features.controllers.FeatureController2D")],Ne);const Sr=Ne;var br=M(35575),Cr=M(65401),Tr=M(89621),Fs=M(58098);class Jt{constructor(a,h){this.key=new Fs.Z(0,0,0,0),this.bounds=(0,Cr.Ue)(),this.objectIds=new Set,this.key.set(h);const d=a.getLODInfoAt(this.key);this.tileInfoView=a,this.tileInfoView.getTileBounds(this.bounds,this.key,!0),this.resolution=d.resolution,this.scale=d.scale,this.level=d.level}get id(){return this.key.id}get extent(){return as.Z.fromBounds(this.bounds,this.tileInfoView.tileInfo.spatialReference)}get transform(){return{originPosition:"upperLeft",scale:[this.resolution,this.resolution],translate:[this.bounds[0],this.bounds[3]]}}createChildTiles(){const a=this.key.getChildKeys(),h=br.Z.acquire();for(let d=0;d<a.length;d++)h[d]=new Jt(this.tileInfoView,a[d]);return h}getQuantizationParameters(){return Tr.Z.fromJSON({mode:"view",originPosition:"upperLeft",tolerance:this.resolution,extent:{xmin:this.bounds[0],ymin:this.bounds[1],xmax:this.bounds[2],ymax:this.bounds[3],spatialReference:this.tileInfoView.tileInfo.spatialReference}})}}var Fr=M(84378);const Mt={added:[],removed:[]},ds=new Set,Mr=new Fs.Z(0,0,0,0);class Ar extends lt.Z{constructor(a){super(),this._tiles=new Map,this._index=(0,ls.r)(9,(0,C.Z)("esri-csp-restrictions")?h=>({minX:h.bounds[0],minY:h.bounds[1],maxX:h.bounds[2],maxY:h.bounds[3]}):[".bounds[0]",".bounds[1]",".bounds[2]",".bounds[3]"]),this.tiles=[],this.tileScheme=a}destroy(){this.clear()}clear(){this.tiles.length=0,this._tiles.clear(),this._index.clear()}has(a){return this._tiles.has(a)}get(a){return this._tiles.get(a)}boundsIntersections(a){return this._index.search({minX:a[0],minY:a[1],maxX:a[2],maxY:a[3]})}updateTiles(a){const h={added:[],removed:[]};for(const d of a.added)if(!this.has(d)){const c=new Jt(this.tileScheme,d);this._tiles.set(d,c),this._index.insert(c),h.added.push(c)}for(const d of a.removed)if(this.has(d)){const c=this.get(d);this._tiles.delete(d),this._index.remove(c),h.removed.push(c)}this.tiles.length=0,this._tiles.forEach(d=>this.tiles.push(d)),(h.added.length||h.removed.length)&&this.emit("update",h)}setViewState(a){const h=this.tileScheme.getTileCoverage(a,0);if(!h)return;const{spans:d,lodInfo:c}=h,{level:f}=c;if(d.length>0)for(const{row:_,colFrom:m,colTo:x}of d)for(let y=m;y<=x;y++){const S=Mr.set(f,_,c.normalizeCol(y),c.getWorldForColumn(y)).id;if(ds.add(S),!this.has(S)){const b=new Jt(this.tileScheme,S);this._tiles.set(S,b),this._index.insert(b),this.tiles.push(b),Mt.added.push(b)}}for(let _=this.tiles.length-1;_>=0;_--){const m=this.tiles[_];ds.has(m.id)||(this._tiles.delete(m.id),this.tiles.splice(_,1),this._index.remove(m),Mt.removed.push(m))}(Mt.added.length||Mt.removed.length)&&this.emit("update",Mt),Fr.Z.pool.release(h),ds.clear(),Mt.added.length=0,Mt.removed.length=0}}var Er=M(9598);let At=class extends N.r{constructor(){super(...arguments),this.controller=null,this.processor=null,this.remoteClient=null,this.tileStore=null,this.service=null,this.viewState=null,this._paused=!1,this._pendingTileUpdates=[]}initialize(){this.handles.add((0,Z.YP)(()=>this.updating,g=>{this.remoteClient.invoke("setUpdating",g).catch(a=>{})}))}destroy(){this.stop(),this.controller?.destroy(),this.processor?.destroy(),this.controller=this.processor=this.tileStore=this.remoteClient=null}get updating(){return!this.controller||this.controller.updating}stop(){this._paused=!0,Array.isArray(this.service?.source)&&(this.service.source.forEach(g=>g.close()),this.service.source.length=0),this.tileStore?.updateTiles({added:[],removed:this.tileStore.tiles.map(g=>g.id)}),this.tileStore?.destroy(),this.tileStore=null,this._pendingTileUpdates.length=0}startup({service:g,config:a,tileInfo:h,tiles:d}){var c=this;return(0,U.Z)(function*(){if(c._paused=!0,Array.isArray(c.service?.source)&&(c.service.source.forEach(f=>f.close()),c.service.source.length=0),c.service=g,!c.tileStore||!(0,ie.fS)(c.tileStore.tileScheme.spatialReference,h.spatialReference)){const f=new Er.Z(J.Z.fromJSON(h));d.added.length=d.removed.length=0,c.tileStore?.updateTiles({added:[],removed:c.tileStore.tiles.map(_=>_.id)}),c.tileStore?.destroy(),c.tileStore=new Ar(f),c._pendingTileUpdates.length=0}for(yield c._createProcessorAndController(a),yield c.update({config:a}),c.controller.resume(),c.tileStore.clear(),c.tileStore.updateTiles(d),c._paused=!1;c._pendingTileUpdates.length;)c.tileStore.updateTiles(c._pendingTileUpdates.pop())})()}updateTiles(g){var a=this;return(0,U.Z)(function*(){a._paused?a._pendingTileUpdates.push(g):a.tileStore?.updateTiles(g)})()}update({config:g}){var a=this;return(0,U.Z)(function*(){const h=oe.empty();return yield Promise.all([a.processor.update(h,g),a.controller.update(h,g)]),h.toJSON()})()}applyUpdate(g){var a=this;return(0,U.Z)(function*(){return a.controller.applyUpdate(oe.create(g))})()}_createProcessorAndController(g){var a=this;return(0,U.Z)(function*(){yield Promise.all([a._handleControllerConfig(g),a._handleProcessorConfig(g)]),a.controller.processor=a.processor})()}_handleControllerConfig(g){var a=this;return(0,U.Z)(function*(){return a._createController(a.service,g)})()}_handleProcessorConfig(g){var a=this;return(0,U.Z)(function*(){return a._createProcessor(a.service,g)})()}_createController(g,a){var h=this;return(0,U.Z)(function*(){h.controller&&h.controller.destroy();const{tileStore:d,remoteClient:c}=h,f=new Sr({service:g,tileStore:d,remoteClient:c});return h.controller=f,f})()}_createProcessor(g,a){var h=this;return(0,U.Z)(function*(){const d=a.schema.processors[0].type,c=(yield function Y(g){return"heatmap"===g?Promise.all([M.e(8592),M.e(7434)]).then(M.bind(M,67434)):Promise.all([M.e(2815),M.e(3678),M.e(8592),M.e(8460)]).then(M.bind(M,28460))}(d)).default,{remoteClient:f,tileStore:_}=h,m=new c({service:g,config:a,tileStore:_,remoteClient:f});return h.processor&&h.processor.destroy(),h.processor=m,m})()}};(0,q._)([(0,O.Cb)()],At.prototype,"controller",void 0),(0,q._)([(0,O.Cb)()],At.prototype,"processor",void 0),(0,q._)([(0,O.Cb)()],At.prototype,"updating",null),(0,q._)([(0,O.Cb)()],At.prototype,"viewState",void 0),At=(0,q._)([(0,X.j)("esri.views.2d.layers.features.Pipeline")],At);const Dr=At},16669:(Re,_e,M)=>{M.d(_e,{J:()=>X});var U=M(15861),q=M(8314),N=M(62208),C=M(84682),Z=M(46679),O=M(63290);const B=Promise.resolve().then(M.bind(M,22445));class X{constructor(J,Y){this._canCacheExpressionValue=!1,this._sourceInfo=J,this._storage=Y,this._bitsets={computed:Y.getBitset(Y.createBitset())}}get storage(){return this._storage}invalidate(){this._bitsets.computed.clear()}updateSchema(J,Y){var ae=this;return(0,U.Z)(function*(){const T=(0,C.Hg)(ae._schema,Y);if(ae._schema=Y,!Y||(0,N.Wi)(T)||!(0,C.uD)(T,"attributes"))return;(0,q.Z)("esri-2d-update-debug")&&console.debug("Applying Update - Store:",T),ae._bitsets.computed.clear(),J.targets[Y.name]=!0;const k=Y.attributes,D=[],v=[];for(const I in k){const F=k[I];switch(F.type){case"field":break;case"expression":D.push(ae._createArcadeComputedField(F));break;case"label-expression":D.push(ae._createLabelArcadeComputedField(F));break;case"statistic":v.push(F)}}ae._computedFields=yield Promise.all(D),ae._canCacheExpressionValue=!ae._computedFields.some(I=>"expression"===I.type&&(0,N.pC)(I.expression)&&I.expression.referencesScale()),ae._statisticFields=v})()}setComputedAttributes(J,Y,ae,T){const k=this._bitsets.computed;if(!this._canCacheExpressionValue||!k.has(ae)){k.set(ae);for(const D of this._computedFields){const v=this._evaluateField(Y,D,T);switch(D.resultType){case"numeric":J.setComputedNumericAtIndex(ae,D.fieldIndex,v);break;case"string":J.setComputedStringAtIndex(ae,D.fieldIndex,v)}}}}_createArcadeComputedField(J){var Y=this;return(0,U.Z)(function*(){const ae=Y._sourceInfo.spatialReference,T=Y._sourceInfo.fieldsIndex;return{...J,expression:yield(0,Z.Yi)(J.valueExpression,ae,T)}})()}_createLabelArcadeComputedField(J){var Y=this;return(0,U.Z)(function*(){const ae=Y._sourceInfo.spatialReference,T=Y._sourceInfo.fieldsIndex,{createLabelFunction:k}=yield B,D=yield k(J.label,T,ae);return{...J,builder:D}})()}_evaluateField(J,Y,ae){switch(Y.type){case"label-expression":{const T=J.readArcadeFeature();return Y.builder.evaluate(T)||""}case"expression":{const{expression:T}=Y;return function H(ie,J,Y){if((0,N.Wi)(ie))return null;const ae=J.readArcadeFeature();try{return ie.evaluate({...Y,$feature:ae})}catch(T){return O.Z.getLogger("esri.views.2d.support.arcadeOnDemand").warn("Feature arcade evaluation failed:",T),null}}(T,J,{$view:{scale:ae}})}}}}},25208:(Re,_e,M)=>{M.d(_e,{s:()=>z}),M(29132);var q=M(91365),N=M(29050),C=M(8314),Z=M(62208),O=M(77044),H=M(82054),B=M(88071),X=M(42797),ie=M(91179);let J=0;const Y=(0,C.Z)("featurelayer-simplify-thresholds")??[.5,.5,.5,.5],ae=Y[0],T=Y[1],k=Y[2],D=Y[3],v=(0,C.Z)("featurelayer-simplify-payload-size-factors")??[1,2,4],I=v[0],F=v[1],w=v[2],P=(0,C.Z)("featurelayer-simplify-mobile-factor")??2,Q=(0,C.Z)("esri-mobile");class z{constructor(E,G){this.type="FeatureSetReader",this.arcadeDeclaredClass="esri.arcade.Feature",this.seen=!1,this.instance=0,this._tx=0,this._ty=0,this._sx=1,this._sy=1,this._deleted=null,this._joined=[],this._objectIdToIndex=null,this._level=0,this._datetimeMetadata=null,this.contextTimeReference=null,this.instance=E,this._layerSchema=G}static createInstance(){return J++,J=J>65535?0:J,J}get isEmpty(){return(0,Z.pC)(this._deleted)&&this._deleted.countSet()===this.getSize()}set level(E){this._level=E}getAreaSimplificationThreshold(E,G){let K=1;const re=Q?P:1;G>4e6?K=w*re:G>1e6?K=F*re:G>5e5?K=I*re:G>1e5&&(K=re);let ge=0;E>4e3?ge=D*K:E>2e3?ge=k*K:E>100?ge=T:E>15&&(ge=ae);let Pe=8;return this._level<4?Pe=1:this._level<5?Pe=2:this._level<6&&(Pe=4),ge*Pe}createQuantizedExtrudedQuad(E,G){return new B.Z([5],[E-1,G,1,-1,1,1,-1,1,-1,-1])}setArcadeSpatialReference(E){this._arcadeSpatialReference=E}attachStorage(E){this._storage=E}getQuantizationTransform(){throw new Error("Unable to find transform for featureSet")}getStorage(){return this._storage}getComputedNumeric(E){return this.getComputedNumericAtIndex(0)}setComputedNumeric(E,G){return this.setComputedNumericAtIndex(G,0)}getComputedString(E){return this.getComputedStringAtIndex(0)}setComputedString(E,G){return this.setComputedStringAtIndex(0,G)}getComputedNumericAtIndex(E){return this._storage.getComputedNumericAtIndex(this.getDisplayId(),E)}setComputedNumericAtIndex(E,G){this._storage.setComputedNumericAtIndex(this.getDisplayId(),E,G)}getComputedStringAtIndex(E){return this._storage.getComputedStringAtIndex(this.getDisplayId(),E)}setComputedStringAtIndex(E,G){return this._storage.setComputedStringAtIndex(this.getDisplayId(),E,G)}transform(E,G,K,re){const ge=this.copy();return ge._tx+=E,ge._ty+=G,ge._sx*=K,ge._sy*=re,ge}readAttribute(E,G=!1){const K=this._readAttribute(E,G);if(void 0!==K)return K;for(const re of this._joined){re.setIndex(this.getIndex());const ge=re._readAttribute(E,G);if(void 0!==ge)return ge}}readAttributes(){const E=this._readAttributes();for(const G of this._joined){G.setIndex(this.getIndex());const K=G._readAttributes();for(const re of Object.keys(K))E[re]=K[re]}return E}joinAttributes(E){this._joined.push(E)}readArcadeFeature(){return this}geometry(){const E=this.readHydratedGeometry(),G=(0,H.di)(E,this.geometryType,this.hasZ,this.hasM),K=(0,ie.im)(G);return K&&(K.spatialReference=this._arcadeSpatialReference),K}get dateTimeReferenceFieldIndex(){return this._datetimeMetadata||(this._datetimeMetadata=N.nu.create(this._layerSchema.fields,this._layerSchema)),this._datetimeMetadata}autocastArcadeDate(E,G){return G&&G instanceof Date?this.isUnknownDateTimeField(E)?q.iG.unknownDateJSToArcadeDate(G):q.iG.dateJSAndZoneToArcadeDate(G,this.contextTimeReference?.timeZone??"system"):G}isUnknownDateTimeField(E){return"unknown"===this.dateTimeReferenceFieldIndex?.fieldTimeZone(E)}fieldSourceTimeZone(E){return this.dateTimeReferenceFieldIndex?.fieldTimeZone(E)??""}get layerPreferredTimeZone(){return this.dateTimeReferenceFieldIndex?.layerPreferredTimeZone??""}field(E){if(this.hasField(E))return this.autocastArcadeDate(E,this.readAttribute(E,!0));for(const G of this._joined)if(G.setIndex(this.getIndex()),G.hasField(E)){const K=G._readAttribute(E,!0);return this.autocastArcadeDate(E,K)}throw new Error(`Field ${E} does not exist`)}setField(E,G){throw new Error("Unable to update feature attribute values, feature is readonly")}keys(){return this.getFieldNames()}castToText(E=!1){if(!E)return JSON.stringify(this.readLegacyFeature());const G=this.readLegacyFeature();if(!G)return JSON.stringify(null);const K={geometry:G.geometry,attributes:{...G.attributes?G.attributes:{}}};for(const re in K.attributes){const ge=K.attributes[re];ge instanceof Date&&(K.attributes[re]=ge.getTime())}return JSON.stringify(K)}gdbVersion(){return null}fullSchema(){return this._layerSchema}castAsJson(E=null){return{attributes:this._readAttributes(),geometry:!0===E?.keepGeometryType?this.geometry():this.geometry()?.toJSON()??null}}castAsJsonAsync(E=null,G=null){return Promise.resolve(this.castAsJson(G))}removeIds(E){if((0,Z.Wi)(this._objectIdToIndex)){const K=new Map,re=this.getCursor();for(;re.next();){const ge=(0,Z.s3)(re.getObjectId());K.set(ge,re.getIndex())}this._objectIdToIndex=K}const G=this._objectIdToIndex;for(const K of E)G.has(K)&&this.removeAtIndex(G.get(K))}removeAtIndex(E){(0,Z.Wi)(this._deleted)&&(this._deleted=X.p.create(this.getSize())),this._deleted.set(E)}readGeometryForDisplay(){return this.readUnquantizedGeometry(!0)}readLegacyGeometryForDisplay(){return this.readLegacyGeometry(!0)}*features(){const E=this.getCursor();for(;E.next();)yield E.readOptimizedFeature()}_getExists(){return(0,Z.Wi)(this._deleted)||!this._deleted.has(this.getIndex())}_computeCentroid(){if("esriGeometryPolygon"!==this.geometryType)return null;const E=this.readUnquantizedGeometry();if(!E||E.hasIndeterminateRingOrder)return null;const G=(0,Z.Pt)(this.getQuantizationTransform(),null);return(0,O.Y)(new B.Z,E,this.hasM,this.hasZ,G)}copyInto(E){E.seen=this.seen,E._storage=this._storage,E._arcadeSpatialReference=this._arcadeSpatialReference,E._joined=this._joined,E._tx=this._tx,E._ty=this._ty,E._sx=this._sx,E._sy=this._sy,E._deleted=this._deleted,E._objectIdToIndex=this._objectIdToIndex}}},52397:(Re,_e,M)=>{M.d(_e,{t:()=>q});var U=M(25208);class q extends U.s{static from(C,Z){return new q(C.copy(),Z)}constructor(C,Z){super(U.s.createInstance(),C.fullSchema()),this._currentIndex=-1,this._reader=C,this._indices=Z}get hasNext(){return this._currentIndex+1<this._indices.length}getSize(){return this._indices.length}getCursor(){return this.copy()}copy(){const C=new q(this._reader.copy(),this._indices);return C._currentIndex=this._currentIndex,C}next(){for(;this._nextIndex()&&!this._reader._getExists(););return this._currentIndex<this._indices.length}_nextIndex(){return++this._currentIndex<this._indices.length&&(this._reader.setIndex(this._indices[this._currentIndex]),!0)}setArcadeSpatialReference(C){this._reader.setArcadeSpatialReference(C)}attachStorage(C){this._reader.attachStorage(C)}get geometryType(){return this._reader.geometryType}get hasFeatures(){return this._reader.hasFeatures}get exceededTransferLimit(){return this._reader.exceededTransferLimit}get hasZ(){return this._reader.hasZ}get hasM(){return this._reader.hasM}getStorage(){return this._reader.getStorage()}getComputedNumeric(C){return this._reader.getComputedNumericAtIndex(0)}setComputedNumeric(C,Z){return this._reader.setComputedNumericAtIndex(Z,0)}getComputedString(C){return this._reader.getComputedStringAtIndex(0)}setComputedString(C,Z){return this._reader.setComputedStringAtIndex(0,Z)}getComputedNumericAtIndex(C){return this._reader.getComputedNumericAtIndex(C)}setComputedNumericAtIndex(C,Z){this._reader.setComputedNumericAtIndex(C,Z)}getComputedStringAtIndex(C){return this._reader.getComputedStringAtIndex(C)}setComputedStringAtIndex(C,Z){return this._reader.setComputedStringAtIndex(C,Z)}transform(C,Z,O,H){const B=this.copy();return B._reader=this._reader.transform(C,Z,O,H),B}readAttribute(C,Z=!1){return this._reader.readAttribute(C,Z)}readAttributes(){return this._reader.readAttributes()}joinAttributes(C){return this._reader.joinAttributes(C)}readArcadeFeature(){return this._reader.readArcadeFeature()}geometry(){return this._reader.geometry()}field(C){return this.readAttribute(C,!0)}hasField(C){return this._reader.hasField(C)}setField(C,Z){return this._reader.setField(C,Z)}keys(){return this._reader.keys()}castToText(C=!1){return this._reader.castToText(C)}getQuantizationTransform(){return this._reader.getQuantizationTransform()}getFieldNames(){return this._reader.getFieldNames()}getAttributeHash(){return this._reader.getAttributeHash()}getObjectId(){return this._reader.getObjectId()}getDisplayId(){return this._reader.getDisplayId()}setDisplayId(C){return this._reader.setDisplayId(C)}getGroupId(){return this._reader.getGroupId()}setGroupId(C){return this._reader.setGroupId(C)}getXHydrated(){return this._reader.getXHydrated()}getYHydrated(){return this._reader.getYHydrated()}getX(){return this._reader.getX()}getY(){return this._reader.getY()}setIndex(C){return this._reader.setIndex(C)}getIndex(){return this._reader.getIndex()}readLegacyFeature(){return this._reader.readLegacyFeature()}readOptimizedFeature(){return this._reader.readOptimizedFeature()}readLegacyPointGeometry(){return this._reader.readLegacyPointGeometry()}readLegacyGeometry(){return this._reader.readLegacyGeometry()}readLegacyCentroid(){return this._reader.readLegacyCentroid()}readGeometryArea(){return this._reader.readGeometryArea()}readUnquantizedGeometry(){return this._reader.readUnquantizedGeometry()}readHydratedGeometry(){return this._reader.readHydratedGeometry()}readGeometry(){return this._reader.readGeometry()}readCentroid(){return this._reader.readCentroid()}_readAttribute(C,Z){throw new Error("Error: Should not be called. Underlying _reader should be used instead")}_readAttributes(){throw new Error("Error: Should not be called. Underlying _reader should be used instead")}}},42797:(Re,_e,M)=>{M.d(_e,{p:()=>U});class U{static fromBuffer(N,C){return new U(N,C)}static create(N,C=4294967295){const Z=new Uint32Array(Math.ceil(N/32));return new U(Z,C)}constructor(N,C){this._mask=0,this._buf=N,this._mask=C}_getIndex(N){return Math.floor(N/32)}has(N){const C=this._mask&N;return!!(this._buf[this._getIndex(C)]&1<<C%32)}hasRange(N,C){let Z=N,O=C;for(;Z%32&&Z!==O;){if(this.has(Z))return!0;Z++}for(;O%32&&Z!==O;){if(this.has(Z))return!0;O--}if(Z===O)return!1;for(let H=Z/32;H!==O/32;H++)if(this._buf[H])return!0;return!1}set(N){const C=this._mask&N,Z=this._getIndex(C);this._buf[Z]|=1<<C%32}setRange(N,C){let Z=N,O=C;for(;Z%32&&Z!==O;)this.set(Z++);for(;O%32&&Z!==O;)this.set(O--);if(Z!==O)for(let H=Z/32;H!==O/32;H++)this._buf[H]=4294967295}unset(N){const C=this._mask&N,Z=this._getIndex(C);this._buf[Z]&=4294967295^1<<C%32}resize(N){const C=this._buf,Z=new Uint32Array(Math.ceil(N/32));Z.set(C),this._buf=Z}or(N){for(let C=0;C<this._buf.length;C++)this._buf[C]|=N._buf[C];return this}and(N){for(let C=0;C<this._buf.length;C++)this._buf[C]&=N._buf[C];return this}xor(N){for(let C=0;C<this._buf.length;C++)this._buf[C]^=N._buf[C];return this}ior(N){for(let C=0;C<this._buf.length;C++)this._buf[C]|=~N._buf[C];return this}iand(N){for(let C=0;C<this._buf.length;C++)this._buf[C]&=~N._buf[C];return this}ixor(N){for(let C=0;C<this._buf.length;C++)this._buf[C]^=~N._buf[C];return this}any(){for(let N=0;N<this._buf.length;N++)if(this._buf[N])return!0;return!1}copy(N){for(let C=0;C<this._buf.length;C++)this._buf[C]=N._buf[C];return this}clone(){return new U(this._buf.slice(),this._mask)}clear(){for(let N=0;N<this._buf.length;N++)this._buf[N]=0}forEachSet(N){for(let C=0;C<this._buf.length;C++){let Z=this._buf[C],O=32*C;if(Z)for(;Z;)1&Z&&N(O),Z>>>=1,O++}}countSet(){let N=0;return this.forEachSet(C=>{N++}),N}}},71251:(Re,_e,M)=>{M.d(_e,{e:()=>O});var U=M(62208),q=M(10699),N=M(35133),C=M(50618);class Z{constructor(B,X){this.item=B,this.controller=X,this.promise=null}}class O{constructor(B){this._deferreds=new Map,this._controllers=new Map,this._processingItems=new Map,this._isPaused=!1,this._schedule=null,this._task=null,this.concurrency=1,B.concurrency&&(this.concurrency=B.concurrency),this._queue=new N.Z(B.peeker),this.process=B.process;const X=B.scheduler;B.priority&&(0,U.pC)(X)&&(this._task=X.registerTask(B.priority,this))}destroy(){this.clear(),this._schedule&&(this._schedule.remove(),this._schedule=null),this._task&&(this._task.remove(),this._task=null)}get length(){return this._processingItems.size+this._queue.length}abort(B){const X=this._controllers.get(B);X&&X.abort()}clear(){this._queue.clear();const B=[];this._controllers.forEach(X=>B.push(X)),this._controllers.clear(),B.forEach(X=>X.abort()),this._processingItems.clear(),this._cancelNext()}forEach(B){this._deferreds.forEach((X,ie)=>B(ie))}get(B){const X=this._deferreds.get(B);return X?X.promise:void 0}isOngoing(B){return this._processingItems.has(B)}has(B){return this._deferreds.has(B)}pause(){this._isPaused||(this._isPaused=!0,this._cancelNext())}push(B,X){const ie=this.get(B);if(ie)return ie;const J=new AbortController;let Y=null;X&&(Y=(0,q.fu)(X,()=>J.abort()));const T=()=>{k.remove(),(0,U.pC)(Y)&&Y.remove(),this._deferreds.delete(B),this._controllers.delete(B),this._queue.remove(B),this._processingItems.delete(B),this._scheduleNext()},k=(0,q.$F)(J.signal,()=>{const v=this._processingItems.get(B);v&&v.controller.abort(),T(),D.reject((0,q.zE)())}),D=(0,q.dD)();return this._deferreds.set(B,D),this._controllers.set(B,J),D.promise.then(T,T),this._queue.push(B),this._scheduleNext(),D.promise}last(){return this._queue.last()}peek(){return this._queue.peek()}popLast(){return this._queue.popLast()}reset(){const B=[];this._processingItems.forEach(X=>B.push(X)),this._processingItems.clear();for(const X of B)this._queue.push(X.item),X.controller.abort();this._scheduleNext()}resume(){this._isPaused&&(this._isPaused=!1,this._scheduleNext())}takeAll(){const B=[];for(;this._queue.length;)B.push(this._queue.pop());return this.clear(),B}get running(){return!this._isPaused&&this._queue.length>0&&this._processingItems.size<this.concurrency}runTask(B){for(;!B.done&&this._queue.length>0&&this._processingItems.size<this.concurrency;)this._process(this._queue.pop()),B.madeProgress()}_scheduleNext(){this._task||this._isPaused||this._schedule||(this._schedule=(0,C.Os)(()=>{this._schedule=null,this._next()}))}_next(){for(;this._queue.length>0&&this._processingItems.size<this.concurrency;)this._process(this._queue.pop())}_cancelNext(){this._schedule&&(this._schedule.remove(),this._schedule=null)}_processResult(B,X){this._canProcessFulfillment(B)&&(this._scheduleNext(),this._deferreds.get(B.item).resolve(X))}_processError(B,X){this._canProcessFulfillment(B)&&(this._scheduleNext(),this._deferreds.get(B.item).reject(X))}_canProcessFulfillment(B){return!!this._deferreds.get(B.item)&&this._processingItems.get(B.item)===B}_process(B){if((0,U.Wi)(B))return;let X;const ie=new AbortController,J=new Z(B,ie);this._processingItems.set(B,J);try{X=this.process(B,ie.signal)}catch(Y){this._processError(J,Y)}(0,q.y8)(X)?(J.promise=X,X.then(Y=>this._processResult(J,Y),Y=>this._processError(J,Y))):this._processResult(J,X)}get test(){return{update:B=>this.runTask(B)}}}}}]);