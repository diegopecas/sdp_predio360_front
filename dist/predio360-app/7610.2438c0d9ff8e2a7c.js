"use strict";(self.webpackChunkpredio360_app=self.webpackChunkpredio360_app||[]).push([[7610],{36592:(ue,$,a)=>{a.d($,{Q:()=>se});var v=a(85931),H=a(77029),q=a(14259);class se{constructor(r=9,l){this._compareMinX=F,this._compareMinY=x,this._toBBox=h=>h,this._maxEntries=Math.max(4,r||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),l&&("function"==typeof l?this._toBBox=l:this._initFormat(l)),this.clear()}destroy(){this.clear(),Q.prune(),ee.prune(),w.prune(),le.prune()}all(r){this._all(this._data,r)}search(r,l){let h=this._data;const p=this._toBBox;if(Z(r,h))for(Q.clear();h;){for(let _=0,m=h.children.length;_<m;_++){const T=h.children[_],E=h.leaf?p(T):T;Z(r,E)&&(h.leaf?l(T):b(r,E)?this._all(T,l):Q.push(T))}h=Q.pop()}}collides(r){let l=this._data;const h=this._toBBox;if(!Z(r,l))return!1;for(Q.clear();l;){for(let p=0,_=l.children.length;p<_;p++){const m=l.children[p],T=l.leaf?h(m):m;if(Z(r,T)){if(l.leaf||b(r,T))return!0;Q.push(m)}}l=Q.pop()}return!1}load(r){if(!r.length)return this;if(r.length<this._minEntries){for(let h=0,p=r.length;h<p;h++)this.insert(r[h]);return this}let l=this._build(r.slice(0,r.length),0,r.length-1,0);if(this._data.children.length)if(this._data.height===l.height)this._splitRoot(this._data,l);else{if(this._data.height<l.height){const h=this._data;this._data=l,l=h}this._insert(l,this._data.height-l.height-1,!0)}else this._data=l;return this}insert(r){return r&&this._insert(r,this._data.height-1),this}clear(){return this._data=new J([]),this}remove(r){if(!r)return this;let l,h=this._data,p=null,_=0,m=!1;const T=this._toBBox(r);for(w.clear(),le.clear();h||w.length>0;){if(h||(h=w.pop(),p=w.data[w.length-1],_=le.pop()??0,m=!0),h.leaf&&(l=(0,v.cq)(h.children,r,h.children.length,h.indexHint),-1!==l))return h.children.splice(l,1),w.push(h),this._condense(w),this;m||h.leaf||!b(h,T)?p?(_++,h=p.children[_],m=!1):h=null:(w.push(h),le.push(_),_=0,p=h,h=h.children[0])}return this}toJSON(){return this._data}fromJSON(r){return this._data=r,this}_all(r,l){let h=r;for(ee.clear();h;){if(!0===h.leaf)for(const p of h.children)l(p);else ee.pushArray(h.children);h=ee.pop()??null}}_build(r,l,h,p){const _=h-l+1;let m=this._maxEntries;if(_<=m){const M=new J(r.slice(l,h+1));return P(M,this._toBBox),M}p||(p=Math.ceil(Math.log(_)/Math.log(m)),m=Math.ceil(_/m**(p-1)));const T=new O([]);T.height=p;const E=Math.ceil(_/m),R=E*Math.ceil(Math.sqrt(m));K(r,l,h,R,this._compareMinX);for(let M=l;M<=h;M+=R){const V=Math.min(M+R-1,h);K(r,M,V,E,this._compareMinY);for(let ie=M;ie<=V;ie+=E){const ce=Math.min(ie+E-1,V);T.children.push(this._build(r,ie,ce,p-1))}}return P(T,this._toBBox),T}_chooseSubtree(r,l,h,p){for(;p.push(l),!0!==l.leaf&&p.length-1!==h;){let _,m=1/0,T=1/0;for(let E=0,R=l.children.length;E<R;E++){const M=l.children[E],V=A(M),ie=G(r,M)-V;ie<T?(T=ie,m=V<m?V:m,_=M):ie===T&&V<m&&(m=V,_=M)}l=_||l.children[0]}return l}_insert(r,l,h){const _=h?r:(0,this._toBBox)(r);w.clear();const m=this._chooseSubtree(_,this._data,l,w);for(m.children.push(r),X(m,_);l>=0&&w.data[l].children.length>this._maxEntries;)this._split(w,l),l--;this._adjustParentBBoxes(_,w,l)}_split(r,l){const h=r.data[l],p=h.children.length,_=this._minEntries;this._chooseSplitAxis(h,_,p);const m=this._chooseSplitIndex(h,_,p);if(!m)return void console.log("  Error: assertion failed at PooledRBush._split: no valid split index");const T=h.children.splice(m,h.children.length-m),E=h.leaf?new J(T):new O(T);E.height=h.height,P(h,this._toBBox),P(E,this._toBBox),l?r.data[l-1].children.push(E):this._splitRoot(h,E)}_splitRoot(r,l){this._data=new O([r,l]),this._data.height=r.height+1,P(this._data,this._toBBox)}_chooseSplitIndex(r,l,h){let p,_,m;p=_=1/0;for(let T=l;T<=h-l;T++){const E=D(r,0,T,this._toBBox),R=D(r,T,h,this._toBBox),M=re(E,R),V=A(E)+A(R);M<p?(p=M,m=T,_=V<_?V:_):M===p&&V<_&&(_=V,m=T)}return m}_chooseSplitAxis(r,l,h){const p=r.leaf?this._compareMinX:F,_=r.leaf?this._compareMinY:x;this._allDistMargin(r,l,h,p)<this._allDistMargin(r,l,h,_)&&r.children.sort(p)}_allDistMargin(r,l,h,p){r.children.sort(p);const _=this._toBBox,m=D(r,0,l,_),T=D(r,h-l,h,_);let E=Y(m)+Y(T);for(let R=l;R<h-l;R++){const M=r.children[R];X(m,r.leaf?_(M):M),E+=Y(m)}for(let R=h-l-1;R>=l;R--){const M=r.children[R];X(T,r.leaf?_(M):M),E+=Y(T)}return E}_adjustParentBBoxes(r,l,h){for(let p=h;p>=0;p--)X(l.data[p],r)}_condense(r){for(let l=r.length-1;l>=0;l--){const h=r.data[l];if(0===h.children.length)if(l>0){const p=r.data[l-1],_=p.children;_.splice((0,v.cq)(_,h,_.length,p.indexHint),1)}else this.clear();else P(h,this._toBBox)}}_initFormat(r){const l=["return a"," - b",";"];this._compareMinX=new Function("a","b",l.join(r[0])),this._compareMinY=new Function("a","b",l.join(r[1])),this._toBBox=new Function("a","return {minX: a"+r[0]+", minY: a"+r[1]+", maxX: a"+r[2]+", maxY: a"+r[3]+"};")}}function P(d,r){D(d,0,d.children.length,r,d)}function D(d,r,l,h,p){p||(p=new J([])),p.minX=1/0,p.minY=1/0,p.maxX=-1/0,p.maxY=-1/0;for(let _,m=r;m<l;m++)_=d.children[m],X(p,d.leaf?h(_):_);return p}function X(d,r){d.minX=Math.min(d.minX,r.minX),d.minY=Math.min(d.minY,r.minY),d.maxX=Math.max(d.maxX,r.maxX),d.maxY=Math.max(d.maxY,r.maxY)}function F(d,r){return d.minX-r.minX}function x(d,r){return d.minY-r.minY}function A(d){return(d.maxX-d.minX)*(d.maxY-d.minY)}function Y(d){return d.maxX-d.minX+(d.maxY-d.minY)}function G(d,r){return(Math.max(r.maxX,d.maxX)-Math.min(r.minX,d.minX))*(Math.max(r.maxY,d.maxY)-Math.min(r.minY,d.minY))}function re(d,r){const l=Math.max(d.minX,r.minX),h=Math.max(d.minY,r.minY),p=Math.min(d.maxX,r.maxX),_=Math.min(d.maxY,r.maxY);return Math.max(0,p-l)*Math.max(0,_-h)}function b(d,r){return d.minX<=r.minX&&d.minY<=r.minY&&r.maxX<=d.maxX&&r.maxY<=d.maxY}function Z(d,r){return r.minX<=d.maxX&&r.minY<=d.maxY&&r.maxX>=d.minX&&r.maxY>=d.minY}function K(d,r,l,h,p){const _=[r,l];for(;_.length;){const m=_.pop(),T=_.pop();if(m-T<=h)continue;const E=T+Math.ceil((m-T)/h/2)*h;(0,q.q)(d,E,T,m,p),_.push(T,E,E,m)}}const Q=new H.Z,ee=new H.Z,w=new H.Z,le=new H.Z({deallocator:void 0});class oe{constructor(){this.minX=1/0,this.minY=1/0,this.maxX=-1/0,this.maxY=-1/0}}class he extends oe{constructor(){super(...arguments),this.height=1,this.indexHint=new v.SO}}class J extends he{constructor(r){super(),this.children=r,this.leaf=!0}}class O extends he{constructor(r){super(),this.children=r,this.leaf=!1}}},26268:(ue,$,a)=>{a.d($,{Z:()=>X});var v=a(8314),H=a(39406),q=a(44589),se=a(13382),P=a(7590);const D=(F,x)=>F.key.level-x.key.level!=0?F.key.level-x.key.level:F.key.row-x.key.row!=0?F.key.row-x.key.row:F.key.col-x.key.col;class X extends q.Z{constructor(x){super(),this._tileInfoView=x}renderChildren(x){this.sortChildren(D),this.setStencilReference(x),super.renderChildren(x)}createRenderParams(x){const{state:A}=x,Y=super.createRenderParams(x);return Y.requiredLevel=this._tileInfoView.getClosestInfoForScale(A.scale).level,Y.displayLevel=this._tileInfoView.tileInfo.scaleToZoom(A.scale),Y}prepareRenderPasses(x){const A=super.prepareRenderPasses(x);return A.push(x.registerRenderPass({name:"stencil",brushes:[se.Z],drawPhase:H.jx.DEBUG|H.jx.MAP|H.jx.HIGHLIGHT|H.jx.LABEL,target:()=>this.getStencilTarget()})),(0,v.Z)("esri-tiles-debug")&&A.push(x.registerRenderPass({name:"tileInfo",brushes:[P.Z],drawPhase:H.jx.DEBUG,target:()=>this.children})),A}getStencilTarget(){return this.children}setStencilReference(x){let A=1;for(const Y of this.children)Y.stencilRef=A++}}},56800:(ue,$,a)=>{a.d($,{y:()=>he});var Z,v=a(17626),H=a(46160),q=a(89726),se=a(26584),P=a(32917),D=a(77712),A=(a(8314),a(63290),a(4619),a(76898)),Y=a(83137),G=a(1011),re=a(38093),b=a(90135);let K=Z=class extends b.Z{constructor(J){super(J),this.type="rect",this.left=null,this.right=null,this.top=null,this.bottom=null}clone(){return new Z({left:this.left,right:this.right,top:this.top,bottom:this.bottom})}commitVersionProperties(){this.commitProperty("left"),this.commitProperty("right"),this.commitProperty("top"),this.commitProperty("bottom")}};(0,v._)([(0,D.Cb)({type:[Number,String],json:{write:!0}})],K.prototype,"left",void 0),(0,v._)([(0,D.Cb)({type:[Number,String],json:{write:!0}})],K.prototype,"right",void 0),(0,v._)([(0,D.Cb)({type:[Number,String],json:{write:!0}})],K.prototype,"top",void 0),(0,v._)([(0,D.Cb)({type:[Number,String],json:{write:!0}})],K.prototype,"bottom",void 0),K=Z=(0,v._)([(0,A.j)("esri.views.layers.support.ClipRect")],K);const Q=K;var ee=a(74835);let w=class extends b.Z{constructor(J){super(J),this.type="path",this.path=[]}commitVersionProperties(){this.commitProperty("path")}};(0,v._)([(0,D.Cb)({type:[[[Number]]],json:{write:!0}})],w.prototype,"path",void 0),w=(0,v._)([(0,A.j)("esri.views.layers.support.Path")],w);const oe=H.Z.ofType({key:"type",base:null,typeMap:{rect:Q,path:w,geometry:ee.Z}}),he=J=>{let O=class extends J{constructor(){super(...arguments),this.attached=!1,this.clips=new oe,this.lastUpdateId=-1,this.moving=!1,this.updateRequested=!1,this.visibleAtCurrentScale=!1,this.highlightOptions=null}initialize(){this.view?.spatialReference&&(this.view?.spatialReferenceLocked??1)&&!this.spatialReferenceSupported?this.addResolvingPromise(Promise.reject(new se.Z("layerview:spatial-reference-incompatible","The spatial reference of this layer does not meet the requirements of the view",{layer:this.layer}))):(this.container||(this.container=new G.W),this.container.fadeTransitionEnabled=!0,this.container.visible=!1,this.container.endTransitions(),this.addHandles([(0,P.YP)(()=>this.suspended,l=>{this.container&&(this.container.visible=!l)},P.tX),(0,P.YP)(()=>this.updateSuspended,l=>{this.view&&!l&&this.updateRequested&&this.view.requestUpdate()},P.tX),(0,P.YP)(()=>this.layer?.opacity??1,l=>{this.container&&(this.container.opacity=l)},P.tX),(0,P.YP)(()=>this.layer&&"blendMode"in this.layer?this.layer.blendMode:"normal",l=>{this.container&&(this.container.blendMode=l)},P.tX),(0,P.YP)(()=>this.layer&&"effect"in this.layer?this.layer.effect:null,l=>{this.container&&(this.container.effect=l)},P.tX),(0,P.YP)(()=>this.highlightOptions,l=>this.container.highlightOptions=l,P.tX),(0,P.on)(()=>this.clips,"change",()=>{this.container&&(this.container.clips=this.clips)},P.tX),(0,P.YP)(()=>({scale:this.view?.scale,scaleRange:this.layer&&"effectiveScaleRange"in this.layer?this.layer.effectiveScaleRange:null}),({scale:l})=>{const h=null!=l&&this.isVisibleAtScale(l);h!==this.visibleAtCurrentScale&&this._set("visibleAtCurrentScale",h)},P.tX)],"constructor"),this.view?.whenLayerView?this.view.whenLayerView(this.layer).then(l=>{l===this&&this.processAttach()},()=>{}):this.when().then(()=>{this.processAttach()},()=>{}))}destroy(){this.processDetach(),this.updateRequested=!1}get spatialReferenceSupported(){const d=this.view?.spatialReference;return null==d||this.supportsSpatialReference(d)}get updateSuspended(){return this.suspended}get updating(){return this.spatialReferenceSupported&&(!this.attached||!this.suspended&&(this.updateRequested||this.isUpdating())||!!this._updatingHandles?.updating)}processAttach(){this.isResolved()&&!this.attached&&!this.destroyed&&this.spatialReferenceSupported&&(this.attach(),this.attached=!0,this.requestUpdate())}processDetach(){this.attached&&(this.attached=!1,this.removeHandles("attach"),this.detach(),this.updateRequested=!1)}isVisibleAtScale(d){const r=this.layer&&"effectiveScaleRange"in this.layer?this.layer.effectiveScaleRange:null;if(!r)return!0;const{minScale:l,maxScale:h}=r;return(0,Y.o2)(d,l,h)}requestUpdate(){this.destroyed||this.updateRequested||(this.updateRequested=!0,this.updateSuspended||this.view.requestUpdate())}processUpdate(d){!this.isFulfilled()||this.isResolved()?(this._set("updateParameters",d),this.updateRequested&&!this.updateSuspended&&(this.updateRequested=!1,this.update(d))):this.updateRequested=!1}hitTest(d,r){return Promise.resolve(null)}supportsSpatialReference(d){return!0}canResume(){return!!this.spatialReferenceSupported&&!!super.canResume()&&this.visibleAtCurrentScale}getSuspendInfo(){const d=super.getSuspendInfo(),r=!this.spatialReferenceSupported,l=this.visibleAtCurrentScale;return r&&(d.spatialReferenceNotSupported=r),l&&(d.outsideScaleRange=l),d}addAttachHandles(d){this.addHandles(d,"attach")}};return(0,v._)([(0,D.Cb)()],O.prototype,"attached",void 0),(0,v._)([(0,D.Cb)({type:oe,set(d){const r=(0,q.Z)(d,this._get("clips"),oe);this._set("clips",r)}})],O.prototype,"clips",void 0),(0,v._)([(0,D.Cb)()],O.prototype,"container",void 0),(0,v._)([(0,D.Cb)()],O.prototype,"moving",void 0),(0,v._)([(0,D.Cb)({readOnly:!0})],O.prototype,"spatialReferenceSupported",null),(0,v._)([(0,D.Cb)({readOnly:!0})],O.prototype,"updateParameters",void 0),(0,v._)([(0,D.Cb)()],O.prototype,"updateRequested",void 0),(0,v._)([(0,D.Cb)()],O.prototype,"updateSuspended",null),(0,v._)([(0,D.Cb)()],O.prototype,"updating",null),(0,v._)([(0,D.Cb)()],O.prototype,"view",void 0),(0,v._)([(0,D.Cb)({readOnly:!0})],O.prototype,"visibleAtCurrentScale",void 0),(0,v._)([(0,D.Cb)({type:re.Z})],O.prototype,"highlightOptions",void 0),O=(0,v._)([(0,A.j)("esri.views.2d.layers.LayerView2D")],O),O}},67610:(ue,$,a)=>{a.r($),a.d($,{default:()=>We});var v=a(15861),H=a(17626),q=a(58817),se=a(63290),P=a(62208),D=a(10699),X=a(77712),x=(a(8314),a(76898)),A=a(84682),Y=a(72642),G=a(65401),re=a(37053),b=a(919),Z=a(63631),K=a(93961),Q=a(84378),ee=a(58098);const oe=(s,e)=>s+1/(1<<2*e);class he{constructor(e,t){this._tiles=new Map,this._tileCache=new K.z(40,i=>i.dispose()),this._viewSize=[0,0],this._visibleTiles=new Map,this.acquireTile=e.acquireTile,this.releaseTile=e.releaseTile,this.tileInfoView=e.tileInfoView,this._container=t}destroy(){for(const[e,t]of this._tiles)t.dispose();this._tiles=null,this._tileCache.clear(),this._tileCache=null}update(e){this._updateCacheSize(e);const t=this.tileInfoView,i=t.getTileCoverage(e.state,0,!0,"smallest");if(!i)return!0;const{spans:n,lodInfo:c}=i,{level:o}=c,y=this._tiles,u=new Set,S=new Set;for(const{row:C,colFrom:g,colTo:U}of n)for(let I=g;I<=U;I++){const z=ee.Z.getId(o,C,c.normalizeCol(I),c.getWorldForColumn(I)),B=this._getOrAcquireTile(z);u.add(z),B.processed()?this._addToContainer(B):S.add(new ee.Z(z))}for(const[C,g]of y)g.isCoverage=u.has(C);for(const C of S)this._findPlaceholdersForMissingTiles(C,u);let f=!1;for(const[C,g]of y)g.neededForCoverage=u.has(C),g.neededForCoverage||g.isHoldingForFade&&t.intersects(i,g.key)&&u.add(C),g.isFading&&(f=!0);for(const[C,g]of this._tiles)u.has(C)||this._releaseTile(C);return Q.Z.pool.release(i),!f}clear(){this._tiles.clear(),this._tileCache.clear(),this._visibleTiles.clear()}clearCache(){this._tileCache.clear()}getIntersectingTiles(e,t,i,n,c){const o=[0,0],y=[0,0];n.toMap(o,e-i,t+i),n.toMap(y,e+i,t-i);const u=Math.min(o[0],y[0]),S=Math.min(o[1],y[1]),f=Math.max(o[0],y[0]),C=Math.max(o[1],y[1]),g=(0,G.al)(u,S,f,C),U=(0,G.Ue)(),I=[];for(const[z,B]of this._visibleTiles)this.tileInfoView.getTileBounds(U,B.key),(0,G.kK)(g,U)&&I.push(B);if(null!=c&&c.length>0){const z=new Set(I.map(L=>L.id)),B=c.filter(L=>!z.has(L.tileKey.id)).map(L=>this._visibleTiles.get(L.tileKey.id)).filter(L=>void 0!==L);I.push(...B)}return I}_findPlaceholdersForMissingTiles(e,t){const i=[];for(const[c,o]of this._tiles)this._addPlaceholderChild(i,o,e,t);const n=i.reduce(oe,0);Math.abs(1-n)<1e-6||this._addPlaceholderParent(e.id,t)}_addPlaceholderChild(e,t,i,n){t.key.level<=i.level||!t.hasData()||function O(s,e){const t=e.level-s.level;return s.row===e.row>>t&&s.col===e.col>>t&&s.world===e.world}(i,t.key)&&(this._addToContainer(t),n.add(t.id),e.push(t.key.level-i.level))}_addPlaceholderParent(e,t){const i=this._tiles;let n=e;for(;;){if(n=J(n),!n||t.has(n))return;const c=i.get(n);if(c&&c.hasData())return this._addToContainer(c),void t.add(c.id)}}_getOrAcquireTile(e){let t=this._tiles.get(e);return t||(t=this._tileCache.pop(e),t||(t=this.acquireTile(new ee.Z(e))),this._tiles.set(e,t),t)}_releaseTile(e){const t=this._tiles.get(e);this.releaseTile(t),this._removeFromContainer(t),this._tiles.delete(e),t.hasData()?this._tileCache.put(e,t,1):t.dispose()}_addToContainer(e){let t;const i=[],n=this._container;if(n.contains(e))return;const c=this._visibleTiles;for(const[o,y]of c)this._canConnectDirectly(e,y)&&i.push(y),null==t&&this._canConnectDirectly(y,e)&&(t=y);if(null!=t){for(const o of i)t.childrenTiles.delete(o),e.childrenTiles.add(o),o.parentTile=e;t.childrenTiles.add(e),e.parentTile=t}else for(const o of i)e.childrenTiles.add(o),o.parentTile=e;c.set(e.id,e),n.addChild(e)}_removeFromContainer(e){if(this._visibleTiles.delete(e.id),this._container.removeChild(e),null!=e.parentTile){e.parentTile.childrenTiles.delete(e);for(const t of e.childrenTiles)null!=e.parentTile&&e.parentTile.childrenTiles.add(t)}for(const t of e.childrenTiles)t.parentTile=e.parentTile;e.parentTile=null,e.childrenTiles.clear()}_canConnectDirectly(e,t){const i=e.key;let{level:n,row:c,col:o,world:y}=t.key;const u=this._visibleTiles;for(;n>0;){if(n--,c>>=1,o>>=1,i.level===n&&i.row===c&&i.col===o&&i.world===y)return!0;if(u.has(`${n}/${c}/${o}/${y}`))return!1}return!1}_updateCacheSize(e){const t=e.state.size;if(t[0]===this._viewSize[0]&&t[1]===this._viewSize[1])return;const i=Math.ceil(t[0]/512)+1,n=Math.ceil(t[1]/512)+1;this._viewSize[0]=t[0],this._viewSize[1]=t[1],this._tileCache.maxSize=5*i*n}}function J(s){const[e,t,i,n]=s.split("/"),c=parseInt(e,10);return 0===c?null:`${c-1}/${parseInt(t,10)>>1}/${parseInt(i,10)>>1}/${parseInt(n,10)}`}var d=a(40022),r=a(2584),l=a(37922),h=a(47132),p=a(51200),_=a(78224),m=a(12378),T=a(59047),E=a(76763),R=a(1268);const V=1e-6;class ie{constructor(e,t){this.styleRepository=e,this._tileToHandle=new Map,this._viewState={scale:0,rotation:0,center:[0,0],size:[0,0]},this._declutterViewState={scale:0,rotation:0,center:[0,0],size:[0,0]},this._offsetFromScreenCenter=[0,0],this._completed=!1,this._fading=(0,l.t)(!1),this._symbolRepository=new T.L(4096,t,()=>new p.J),this._symbolDeclutterer=new m.g(t,this._symbolRepository,(i,n,c)=>this._createCollisionJob(i,n,c),(i,n)=>{i.allSymbolsFadingOut=!0,i.lastOpacityUpdate=n,(0,E.C$)(i,n,!0),i.decluttered=!0,i.requestRender()},(i,n)=>this.styleRepository.getStyleLayerByUID(i.styleLayerUID).z-this.styleRepository.getStyleLayerByUID(n.styleLayerUID).z,i=>{const n=this.styleRepository.getStyleLayerByUID(i);if(this._zoom+V<n.minzoom||this._zoom-V>=n.maxzoom)return!1;const c=n.getLayoutProperty("visibility");return!c||c.getValue()!==R.EE.NONE})}get symbolRepository(){return this._symbolRepository}_createCollisionJob(e,t,i){return this.updateDecluttererViewState(),new _.f(e,t,i,this.styleRepository,this._zoom,this._viewState.rotation)}get fading(){return this._fading.value}get decluttererOffset(){return this._offsetFromScreenCenter}addTile(e){e.decluttered=!1,this._tileToHandle.set(e,e.on("symbols-changed",()=>{this._symbolRepository.add(e),this.restartDeclutter()})),this._symbolRepository.add(e),this.restartDeclutter()}removeTile(e){const t=this._tileToHandle.get(e);t&&(this._symbolRepository.removeTile(e),this.restartDeclutter(),t.remove(),this._tileToHandle.delete(e))}update(e,t){this._zoom=e,this._viewState={scale:t.scale,rotation:t.rotation,center:[t.center[0],t.center[1]],size:[t.size[0],t.size[1]]};const i=[0,0];t.toScreen(i,t.center);const n=[0,0];return t.toScreen(n,this._declutterViewState.center),this._offsetFromScreenCenter[0]=i[0]-n[0],this._offsetFromScreenCenter[1]=i[1]-n[1],this._continueDeclutter(),this._completed}restartDeclutter(){this._completed=!1,this._symbolDeclutterer.restart(),this._notifyUnstable()}clear(){this._completed=!1,this._symbolRepository=null,this._symbolDeclutterer.restart(),this._tileToHandle.forEach(e=>e.remove()),this._tileToHandle.clear()}get stale(){return this._zoom!==this._declutterZoom||this._viewState.size[0]!==this._declutterViewState.size[0]||this._viewState.size[1]!==this._declutterViewState.size[1]||this._viewState.scale!==this._declutterViewState.scale||this._viewState.rotation!==this._declutterViewState.rotation}deleteStyleLayers(e){this._symbolRepository.deleteStyleLayers(e)}_continueDeclutter(){this._completed&&!this.stale||(this._symbolDeclutterer.running||(this.updateDecluttererViewState(),this._symbolDeclutterer.restart()),this._symbolDeclutterer.setScreenSize(this._viewState.size[0],this._viewState.size[1]),this._completed=this._symbolDeclutterer.continue(h.JM),this._completed&&this._scheduleNotifyStable())}_scheduleNotifyStable(){null!=this._stableNotificationHandle&&clearTimeout(this._stableNotificationHandle),this._stableNotificationHandle=setTimeout(()=>{this._stableNotificationHandle=null,this._fading.value=!1},1.5*h.v7)}_notifyUnstable(){null!=this._stableNotificationHandle&&(clearTimeout(this._stableNotificationHandle),this._stableNotificationHandle=null),this._fading.value=!0}updateDecluttererViewState(){this._declutterZoom=this._zoom,this._declutterViewState.center[0]=this._viewState.center[0],this._declutterViewState.center[1]=this._viewState.center[1],this._declutterViewState.rotation=this._viewState.rotation,this._declutterViewState.scale=this._viewState.scale,this._declutterViewState.size[0]=this._viewState.size[0],this._declutterViewState.size[1]=this._viewState.size[1],this._offsetFromScreenCenter[0]=0,this._offsetFromScreenCenter[1]=0}}var ce=a(39406),Ae=a(67176),Oe=a(26268),k=a(67969);const pe=1e-6;function Te(s,e){if(s){const t=s.getLayoutProperty("visibility");if(!t||t.getValue()!==R.EE.NONE&&(void 0===s.minzoom||s.minzoom<e+pe)&&(void 0===s.maxzoom||s.maxzoom>=e-pe))return!0}return!1}class Ue extends Oe.Z{constructor(e){super(e),this._backgroundTiles=[],this._computeDisplayInfoView(e)}destroy(){this.removeAllChildren(),this._spriteMosaic?.dispose(),this._spriteMosaic=null,this._glyphMosaic?.dispose(),this._glyphMosaic=null,null!=this._symbolFader&&(this._symbolFader.clear(),this._symbolFader=null),this._styleRepository=null,this._backgroundTiles=[]}get fading(){return this._symbolFader?.fading??!1}get symbolFader(){return this._symbolFader}get symbolRepository(){return this._symbolFader?.symbolRepository}setStyleResources(e,t,i,n){this._spriteMosaic=e,this._glyphMosaic=t,this._styleRepository=i,this._tileInfoView=n,this._computeDisplayInfoView(n),null==this._symbolFader&&(this._symbolFader=new ie(this._styleRepository,this.children)),this._symbolFader.styleRepository=i}setSpriteMosaic(e){this._spriteMosaic?.dispose(),this._spriteMosaic=e}deleteStyleLayers(e){null!=this._symbolFader&&this._symbolFader.deleteStyleLayers(e)}createRenderParams(e){return{...super.createRenderParams(e),renderPass:null,styleLayer:null,styleLayerUID:-1,glyphMosaic:this._glyphMosaic,spriteMosaic:this._spriteMosaic,hasClipping:!!this._clippingInfos}}doRender(e){!this.visible||e.drawPhase!==ce.jx.MAP&&e.drawPhase!==ce.jx.DEBUG||void 0===this._spriteMosaic||super.doRender(e)}addChild(e){return super.addChild(e),null!=this._symbolFader?this._symbolFader.addTile(e):e.decluttered=!0,this.requestRender(),e}removeChild(e){return null!=this._symbolFader&&this._symbolFader.removeTile(e),this.requestRender(),super.removeChild(e)}renderChildren(e){const{drawPhase:t}=e;t!==ce.jx.DEBUG?this._doRender(e):super.renderChildren(e)}removeAllChildren(){for(let e=0;e<this.children.length;e++){const t=this.children[e];null!=this._symbolFader&&this._symbolFader.removeTile(t),t.dispose()}super.removeAllChildren()}getStencilTarget(){return this.children.filter(e=>e.neededForCoverage&&e.hasData())}restartDeclutter(){null!=this._symbolFader&&this._symbolFader.restartDeclutter()}_doRender(e){const{context:t,state:i}=e,n=this._styleRepository;if(!n)return;const c=n.layers,o=this._displayInfo.scaleToZoom(i.scale);n.backgroundBucketIds.length>0&&(e.renderPass="background",this._renderBackgroundLayers(e,n.backgroundBucketIds,o)),super.renderChildren(e),e.drawPhase===ce.jx.MAP&&this._fade(o,i);const y=this.children.filter(u=>u.visible&&u.hasData());if(!y||0===y.length)return t.bindVAO(),t.setStencilTestEnabled(!0),void t.setBlendingEnabled(!0);for(const u of y)u.triangleCount=0;t.setStencilWriteMask(0),t.setColorMask(!0,!0,!0,!0),t.setStencilOp(k.xS.KEEP,k.xS.KEEP,k.xS.REPLACE),t.setStencilTestEnabled(!0),t.setBlendingEnabled(!1),t.setDepthTestEnabled(!0),t.setDepthWriteEnabled(!0),t.setDepthFunction(k.wb.LEQUAL),t.setClearDepth(1),t.clear(t.gl.DEPTH_BUFFER_BIT),e.renderPass="opaque";for(let u=c.length-1;u>=0;u--)this._renderStyleLayer(c[u],e,y);t.setDepthWriteEnabled(!1),t.setBlendingEnabled(!0),t.setBlendFunctionSeparate(k.zi.ONE,k.zi.ONE_MINUS_SRC_ALPHA,k.zi.ONE,k.zi.ONE_MINUS_SRC_ALPHA),e.renderPass="translucent";for(let u=0;u<c.length;u++)this._renderStyleLayer(c[u],e,y);t.bindVAO(),t.setStencilTestEnabled(!0),t.setBlendingEnabled(!0);for(const u of y)u.debugInfo.display.triangleCount=u.triangleCount}_fade(e,t){null!=this._symbolFader&&(this._symbolFader.update(e,t)||this.requestRender())}_renderStyleLayer(e,t,i){const{displayLevel:n,painter:c,renderPass:o}=t;if(void 0===e)return;const y=e.getLayoutProperty("visibility");if(y&&y.getValue()===R.EE.NONE)return;let u;switch(e.type){case R.fR.BACKGROUND:return;case R.fR.FILL:if("opaque"!==o&&"translucent"!==t.renderPass)return;u="vtlFill";break;case R.fR.LINE:if("translucent"!==o)return;u="vtlLine";break;case R.fR.CIRCLE:if("translucent"!==o)return;u="vtlCircle";break;case R.fR.SYMBOL:if("translucent"!==o)return;u="vtlSymbol"}if(i=i.filter(e.type===R.fR.SYMBOL?f=>f.decluttered:f=>f.neededForCoverage),"vtlSymbol"!==u&&(0===i.length||void 0!==e.minzoom&&e.minzoom>=n+pe||void 0!==e.maxzoom&&e.maxzoom<n-pe))return;const S=e.uid;t.styleLayerUID=S,t.styleLayer=e;for(const f of i)if(f.layerData.has(S)){c.renderObjects(t,i,u);break}}_renderBackgroundLayers(e,t,i){const{context:n,painter:c,state:o}=e,y=this._styleRepository;let u=!1;for(const N of t)if(y.getLayerById(N).type===R.fR.BACKGROUND&&Te(y.getLayerById(N),i)){u=!0;break}if(!u)return;const S=this._tileInfoView,f=S.getTileCoverage(e.state,0,!0,"smallest"),{spans:C,lodInfo:g}=f,{level:U}=g,I=(0,G.Ue)(),z=[];if(this._renderPasses){const N=this._renderPasses[0];null!=this._clippingInfos&&(N.brushes[0].prepareState(e),N.brushes[0].drawMany(e,this._clippingInfos))}const B=this._backgroundTiles;let L,ne=0;for(const{row:N,colFrom:te,colTo:ye}of C)for(let j=te;j<=ye;j++){if(ne<B.length)L=B[ne],L.key.set(U,N,g.normalizeCol(j),g.getWorldForColumn(j)),S.getTileBounds(I,L.key,!1),L.x=I[0],L.y=I[3],L.resolution=S.getTileResolution(U);else{const ae=new ee.Z(U,N,g.normalizeCol(j),g.getWorldForColumn(j)),de=S.getTileBounds((0,G.Ue)(),ae),fe=S.getTileResolution(U);L=new Ae.H(ae,fe,de[0],de[3],512,512,4096,4096),B.push(L)}L.setTransform(o),z.push(L),ne++}n.setStencilWriteMask(0),n.setColorMask(!0,!0,!0,!0),n.setStencilOp(k.xS.KEEP,k.xS.KEEP,k.xS.REPLACE),n.setStencilFunction(k.wb.EQUAL,0,255),n.setStencilTestEnabled(!0);for(const N of t){const te=y.getLayerById(N);te.type===R.fR.BACKGROUND&&Te(te,i)&&(e.styleLayerUID=te.uid,e.styleLayer=te,c.renderObjects(e,z,"vtlBackground"))}Q.Z.pool.release(f)}_computeDisplayInfoView(e){let t=e.tileInfo.lods[0].scale;const i=Math.max(25,e.tileInfo.lods.length),n=[];for(let c=0;c<=i;c++)n.push(t),t/=2;this._displayInfo=r.Z.create({scales:n,size:512,spatialReference:e.spatialReference,numLODs:i})}}var Se=a(88879),He=a(88159),Ce=a(24192),Fe=a(36592),Re=a(35688),Ve=a(86575),Pe=a(38320),Ye=a(77928);const ze=(s,e)=>{const t=s.vtlSymbol.sourceTile,i=e.vtlSymbol.sourceTile;return t.level!==i.level?t.level-i.level:t.row!==i.row?t.row-i.row:t.col!==i.col?t.col-i.col:s.styleLayerUID-e.styleLayerUID};class ge{constructor(e,t,i,n,c){this.tileKey=e,this._index=null,this._styleRepository=null,this._tileHandler=null,this._tileKeyToPBF=new Map,this._tileLayerData=t,this._styleRepository=i,this._tileHandler=n,this._parentLayer=c}static create(e,t,i,n,c){return new ge(e,t,i,n,c)}clear(){this._index?.clear(),this._tileKeyToPBF.clear()}queryAttributes(e,t,i,n,c){var o=this;return(0,v.Z)(function*(){if(0===o._tileLayerData.size||!o._styleRepository||!o._tileHandler)return[];null===o._index&&(o._index=new Fe.Q(100,Ne),yield o._indexLayers());const y=[];return o._queryIndex(y,e,t,i,o.tileKey.level,n),c&&c?.length>0&&(yield o._getSymbolsAttributes(y,c)),y})()}_indexLayers(){var e=this;return(0,v.Z)(function*(){const t=e.tileKey,i=e._styleRepository.layers,n=yield e._getTilePayload(t);for(const[c,o]of e._tileLayerData){const y=i[c],u=n.find(C=>C.sourceName===y.source);if(!u)continue;const{protobuff:S,key:f}=u;if(o.type!==b.al.SYMBOL){const C=1<<t.level-f.level;e._indexLayer(y,S,t.level,C,t.row-f.row*C,t.col-f.col*C)}}})()}_indexLayer(e,t,i,n,c,o){const y=e.sourceLayer,u=e.getFeatureFilter(),S=i,f=i+1,C=(0,Ve.KU)(S),g=new Ce.Z(new Uint8Array(t),new DataView(t));for(;g.next();)switch(g.tag()){case 3:{const U=g.getMessage(),I=new Pe.Z(U);if(U.release(),I.name!==y)continue;const z=I.getData(),B=I.extent/n,L=B*o-C,ne=B*c-C,N=L+B+2*C,te=ne+B+2*C,ye=B/512,j=4096/B,ae=B*o,de=B*c;for(;z.nextTag(2);){const fe=z.getMessage(),me=new Re.Z(fe,I);if(fe.release(),u&&!u.filter(me,i))continue;const Le=me.values||{},we=Le._minzoom,Be=Le._maxzoom;if(we&&we>=10*f||Be&&Be<=10*S)continue;const W=e.getFeatureInflatedBounds(me,S,I.extent,ye);null==W||W[0]>N||W[1]>te||W[2]<L||W[3]<ne||(W[0]=(W[0]-ae)*j,W[1]=(W[1]-de)*j,W[2]=(W[2]-ae)*j,W[3]=(W[3]-de)*j,this._index.insert(new Ye.$L(e,me,W,j,ae,de)))}break}default:g.skip()}}_getSymbolsAttributes(e,t){var i=this;return(0,v.Z)(function*(){if(!t||0===t.length)return e;const n=[];t.sort(ze);let c=t[0].styleLayerUID,o=0;for(let f=0;f<t.length;f++)c!==t[f].styleLayerUID&&(n.push({from:o,to:f,styleLayerUID:c,sourceTileKey:t[f].vtlSymbol.sourceTile}),o=f,c=t[f].styleLayerUID);n.push({from:o,to:t.length,styleLayerUID:c,sourceTileKey:t[t.length-1].vtlSymbol.sourceTile});const y=i._styleRepository.layers;let u,S=null;for(const f of n){const C=yield i._getTilePayload(f.sourceTileKey);u=y[f.styleLayerUID],S=!!u&&C.find(g=>g.sourceName===u.source),S&&i._addSymbolsAttributes(e,t.slice(f.from,f.to).map(g=>g.vtlSymbol),c,S)}return e})()}_addSymbolsAttributes(e,t,i,n){const c=this._styleRepository.layers,o=n.key,y=this.tileKey,u=1<<y.level-o.level;this._getSymbolAttributes(n.protobuff,t,i,u,y.row-o.row*u,y.col-o.col*u).forEach(C=>{const{attributes:g,tilePoint:U}=C;e.push({layerId:c[i].id,layerIndex:i,graphic:new Se.Z({attributes:g,origin:{type:"vector-tile",layerId:c[i].id,layerIndex:i,layer:this._parentLayer}}),tilePoint:U})})}_getSymbolAttributes(e,t,i,n,c,o){const y=[],u=this._styleRepository.layers;let S=0;t.sort((C,g)=>C.featureIndex-g.featureIndex);const f=new Ce.Z(new Uint8Array(e),new DataView(e));for(;f.next();)switch(f.tag()){case 3:{const C=f.getMessage(),g=new Pe.Z(C);if(C.release(),g.name!==u[i].sourceLayer)continue;const U=g.getData(),I=g.extent/n,z=4096/I,B=I*o,L=I*c;let ne=0;for(;U.nextTag(2);){const N=U.getMessage();if(ne++===t[S].featureIndex){const te=new Re.Z(N,g),ye=te.values,j=te.getGeometry();y.push({attributes:ye,tilePoint:null!=j?[z*(j[0][0].x-B),z*(j[0][0].y-L)]:null}),S++}if(N.release(),S===t.length)return y}break}default:f.skip()}return y}_queryIndex(e,t,i,n,c,o){const y=8*n*(window.devicePixelRatio||1);return this._index?.search({minX:t-y,minY:i-y,maxX:t+y,maxY:i+y},u=>{const{layer:S,feature:f}=u;S.isIntersectingFeature(t,i,n,f,c,o,u)&&e.push({layerId:S.id,layerIndex:S.uid,tilePoint:null,graphic:new Se.Z({attributes:f.values,origin:{type:"vector-tile",layerId:u.layer.id,layerIndex:u.layer.uid,layer:this._parentLayer}})})}),e}_getTilePayload(e){var t=this;return(0,v.Z)(function*(){return(0,He.s1)(t._tileKeyToPBF,e.id,()=>t._tileHandler.fetchTilePBFs(e)).then(i=>i)})()}}const Ne=s=>({minX:s.bounds[0],minY:s.bounds[1],maxX:s.bounds[2],maxY:s.bounds[3]});var Ee=a(78364),Xe=a(56800),xe=a(92862),Me=a(8480),Ke=a(45611);let _e=class extends((0,Xe.y)(Ke.Z)){constructor(){super(...arguments),this._styleChanges=[],this._fetchQueue=null,this._parseQueue=null,this._tileHandlerPromise=null,this._isTileHandlerReady=!1}get fading(){return this._vectorTileContainer?.fading??!1}hitTest(s,e){var t=this;return(0,v.Z)(function*(){const i=t._tileHandlerPromise,n=t._vectorTileContainer?.symbolFader;if(!i||!t._isTileHandlerReady||!n)return;yield i;let c=null;const o=t._vectorTileContainer?.symbolRepository;o&&(c=o.querySymbols(e,2,n.decluttererOffset,{}));const u=t._tileManager.getIntersectingTiles(e.x,e.y,2,t.view.state,c);if((!u||0===u.length)&&0===c?.length)return null;s=s.clone().normalize();const S=[],f=[];for(const C of u)S.push(t._queryTile(f,s,2,t.view.state.rotation,C,c?.filter(g=>g.tileKey.id===C.id)));return yield Promise.all(S),f})()}update(s){if(this._tileHandlerPromise&&this._isTileHandlerReady)return s.pixelRatio!==this._tileHandler.devicePixelRatio?(this._start(),void(this._tileHandler.devicePixelRatio=s.pixelRatio)):void(this._styleChanges.length>0?this._tileHandlerPromise=this._applyStyleChanges():(this._fetchQueue.pause(),this._parseQueue.pause(),this._fetchQueue.state=s.state,this._parseQueue.state=s.state,this._tileManager.update(s)||this.requestUpdate(),this._parseQueue.resume(),this._fetchQueue.resume()))}attach(){const{style:s}=this.layer.currentStyleInfo;this._styleRepository=new Ee.Z(s),this._tileInfoView=new xe.Z(this.layer.tileInfo,this.layer.fullExtent),this._vectorTileContainer=new Ue(this._tileInfoView),this._tileHandler=new Z.m(this.layer,this._styleRepository,window.devicePixelRatio||1,this.layer.tileInfo.lods.length-1),this.container.addChild(this._vectorTileContainer),this._start(),this.addAttachHandles([this.layer.on("paint-change",e=>{if(e.isDataDriven)this._styleChanges.push({type:b.Fr.PAINTER_CHANGED,data:e}),this.requestUpdate();else{const t=this._styleRepository,i=t.getLayerById(e.layer);if(!i)return;const n=i.type===R.fR.SYMBOL;t.setPaintProperties(e.layer,e.paint),n&&this._vectorTileContainer?.restartDeclutter(),this._vectorTileContainer?.requestRender()}}),this.layer.on("layout-change",e=>{const t=this._styleRepository,i=t.getLayerById(e.layer);if(!i)return;const n=(0,A.Hg)(i.layout,e.layout);if(null!=n){if((0,A.uD)(n,"visibility")&&1===function Qe(s){if(null==s)return 0;switch(s.type){case"partial":return Object.keys(s.diff).length;case"complete":return Math.max(Object.keys(s.oldValue).length,Object.keys(s.newValue).length);case"collection":return Object.keys(s.added).length+Object.keys(s.changed).length+Object.keys(s.removed).length}}(n))return t.setLayoutProperties(e.layer,e.layout),i.type===R.fR.SYMBOL&&this._vectorTileContainer?.restartDeclutter(),void this._vectorTileContainer?.requestRender();this._styleChanges.push({type:b.Fr.LAYOUT_CHANGED,data:e}),this.requestUpdate()}}),this.layer.on("style-layer-visibility-change",e=>{const t=this._styleRepository,i=t.getLayerById(e.layer);i&&(t.setStyleLayerVisibility(e.layer,e.visibility),i.type===R.fR.SYMBOL&&this._vectorTileContainer?.restartDeclutter(),this._vectorTileContainer?.requestRender())}),this.layer.on("style-layer-change",e=>{this._styleChanges.push({type:b.Fr.LAYER_CHANGED,data:e}),this.requestUpdate()}),this.layer.on("delete-style-layer",e=>{this._styleChanges.push({type:b.Fr.LAYER_REMOVED,data:e}),this.requestUpdate()}),this.layer.on("load-style",()=>this._loadStyle()),this.layer.on("spriteSource-change",e=>{this._styleChanges.push({type:b.Fr.SPRITES_CHANGED,data:e});const t=this._styleRepository.layers;for(const i of t)switch(i.type){case R.fR.SYMBOL:i.getLayoutProperty("icon-image")&&this._styleChanges.push({type:b.Fr.LAYOUT_CHANGED,data:{layer:i.id,layout:i.layout}});break;case R.fR.LINE:i.getPaintProperty("line-pattern")&&this._styleChanges.push({type:b.Fr.PAINTER_CHANGED,data:{layer:i.id,paint:i.paint,isDataDriven:i.isPainterDataDriven()}});break;case R.fR.FILL:i.getLayoutProperty("fill-pattern")&&this._styleChanges.push({type:b.Fr.PAINTER_CHANGED,data:{layer:i.id,paint:i.paint,isDataDriven:i.isPainterDataDriven()}})}this.requestUpdate()})])}detach(){this._stop(),this.container.removeAllChildren(),this._vectorTileContainer=(0,P.SC)(this._vectorTileContainer),this._tileHandler=(0,P.SC)(this._tileHandler)}moveStart(){this.requestUpdate()}viewChange(){this.requestUpdate()}moveEnd(){this.requestUpdate()}supportsSpatialReference(s){return(0,re.fS)(this.layer.tileInfo?.spatialReference,s)}canResume(){let s=super.canResume();const{currentStyleInfo:e}=this.layer;if(s&&e?.layerDefinition){const t=this.view.scale,{minScale:i,maxScale:n}=e.layerDefinition;e?.layerDefinition&&(i&&i<t&&(s=!1),n&&n>t&&(s=!1))}return s}isUpdating(){return this.fading}acquireTile(s){const e=this._createVectorTile(s);return this._updatingHandles.addPromise(this._fetchQueue.push(e.key).then(t=>this._parseQueue.push({key:e.key,data:t})).then(t=>{e.once("attach",()=>this.requestUpdate()),e.setData(t),this.requestUpdate()}).catch(t=>{(0,D.D_)(t)||se.Z.getLogger(this).error(t)})),e}releaseTile(s){const e=s.key.id;this._fetchQueue.abort(e),this._parseQueue.abort(e),this.requestUpdate()}_start(){if(this._stop(),this._tileManager=new he({acquireTile:t=>this.acquireTile(t),releaseTile:t=>this.releaseTile(t),tileInfoView:this._tileInfoView},this._vectorTileContainer),!this.layer.currentStyleInfo)return;const s=new AbortController,e=this._tileHandler.start({signal:s.signal}).then(()=>{this._fetchQueue=new Me.Z({tileInfoView:this._tileInfoView,process:(t,i)=>this._getTileData(t,i),concurrency:15}),this._parseQueue=new Me.Z({tileInfoView:this._tileInfoView,process:(t,i)=>this._parseTileData(t,i),concurrency:8}),this.requestUpdate(),this._isTileHandlerReady=!0});this._tileHandler.spriteMosaic.then(t=>{this._vectorTileContainer.setStyleResources(t,this._tileHandler.glyphMosaic,this._styleRepository,this._tileInfoView),this.requestUpdate()}),this._tileHandlerAbortController=s,this._tileHandlerPromise=e}_stop(){if(!this._tileHandlerAbortController||!this._vectorTileContainer)return;const s=this._tileHandlerAbortController;s&&s.abort(),this._tileHandlerPromise=null,this._isTileHandlerReady=!1,this._fetchQueue=(0,P.SC)(this._fetchQueue),this._parseQueue=(0,P.SC)(this._parseQueue),this._tileManager=(0,P.SC)(this._tileManager),this._vectorTileContainer.removeAllChildren()}_getTileData(s,e){var t=this;return(0,v.Z)(function*(){return t._tileHandler.fetchTileData(s,e)})()}_parseTileData(s,e){var t=this;return(0,v.Z)(function*(){return t._tileHandler.parseTileData(s,e)})()}_applyStyleChanges(){var s=this;return(0,v.Z)(function*(){s._isTileHandlerReady=!1,s._fetchQueue.pause(),s._parseQueue.pause(),s._fetchQueue.clear(),s._parseQueue.clear(),s._tileManager.clearCache();const e=s._styleChanges;try{yield s._tileHandler.updateStyle(e)}catch(o){se.Z.getLogger(s).error("error applying vector-tiles style update",o.message),s._fetchQueue.resume(),s._parseQueue.resume(),s._isTileHandlerReady=!0}const t=s._styleRepository,i=new Set;e.forEach(o=>{if(o.type!==b.Fr.LAYER_REMOVED)return;const u=t.getLayerById(o.data.layer);u&&i.add(u.uid)});const n=new Set;e.forEach(o=>{let y;switch(o.type){case b.Fr.PAINTER_CHANGED:t.setPaintProperties(o.data.layer,o.data.paint),y=o.data.layer;break;case b.Fr.LAYOUT_CHANGED:t.setLayoutProperties(o.data.layer,o.data.layout),y=o.data.layer;break;case b.Fr.LAYER_REMOVED:return void t.deleteStyleLayer(o.data.layer);case b.Fr.LAYER_CHANGED:t.setStyleLayer(o.data.layer,o.data.index),y=o.data.layer.id;break;case b.Fr.SPRITES_CHANGED:s._vectorTileContainer.setSpriteMosaic(s._tileHandler.setSpriteSource(o.data.spriteSource))}if(y){const u=t.getLayerById(y);u&&n.add(u.uid)}});const c=s._vectorTileContainer.children;if(i.size>0){const o=Array.from(i);s._vectorTileContainer.deleteStyleLayers(o);for(const y of c)y.deleteLayerData(o)}if(s._fetchQueue.resume(),s._parseQueue.resume(),n.size>0){const o=Array.from(n),y=[];for(const u of c){const S=s._updatingHandles.addPromise(s._fetchQueue.push(u.key).then(f=>s._parseQueue.push({key:u.key,data:f,styleLayerUIDs:o})).then(f=>u.setData(f)));y.push(S)}yield Promise.all(y)}s._styleChanges=[],s._isTileHandlerReady=!0,s.requestUpdate()})()}_loadStyle(){var s=this;return(0,v.Z)(function*(){const{style:e}=s.layer.currentStyleInfo,t=(0,q.d9)(e);s._isTileHandlerReady=!1,s._fetchQueue.pause(),s._parseQueue.pause(),s._fetchQueue.clear(),s._parseQueue.clear(),s._styleRepository=new Ee.Z(t),s._vectorTileContainer.destroy(),s._tileManager.clear(),s._tileHandlerAbortController.abort(),s._tileHandlerAbortController=new AbortController;const{signal:i}=s._tileHandlerAbortController;try{s._tileHandlerPromise=s._tileHandler.setStyle(s._styleRepository,t,s.layer.tileInfo.lods.length-1),yield s._tileHandlerPromise}catch(o){if(!(0,D.D_)(o))throw o}if(i.aborted)return s._fetchQueue.resume(),s._parseQueue.resume(),s._isTileHandlerReady=!0,void s.requestUpdate();const n=yield s._tileHandler.spriteMosaic,c=s._vectorTileContainer;s._tileInfoView=new xe.Z(s.layer.tileInfo,s.layer.fullExtent),c.setStyleResources(n,s._tileHandler.glyphMosaic,s._styleRepository,s._tileInfoView),s._tileManager=new he({acquireTile:o=>s.acquireTile(o),releaseTile:o=>s.releaseTile(o),tileInfoView:s._tileInfoView},s._vectorTileContainer),s._fetchQueue.resume(),s._parseQueue.resume(),s._isTileHandlerReady=!0,s.requestUpdate()})()}_createVectorTile(s){const e=this._tileInfoView.getTileBounds((0,G.Ue)(),s),t=this._tileInfoView.getTileResolution(s.level);return new d.i(s,t,e[0],e[3],512,512,this._styleRepository)}_queryTile(s,e,t,i,n,c){var o=this;return(0,v.Z)(function*(){if(0===n.layerData.size)return;const y=o._ensureTileIndex(n),u=o._tileInfoView.getTileBounds((0,G.Ue)(),n.key,!0),S=(e.x-u[0])/(u[2]-u[0])*4096,f=4096*(1-(e.y-u[1])/(u[3]-u[1])),C=yield y.queryAttributes(S,f,t,i,c);for(const g of C)g.graphic.geometry=o._tileToMapPoint(g.tilePoint,n.transforms.tileUnitsToPixels),s.push({type:"graphic",layer:o.layer,graphic:g.graphic,mapPoint:e.clone()});s.sort((g,U)=>U.graphic.origin.layerIndex-g.graphic.origin.layerIndex)})()}_tileToMapPoint(s,e){if(!s)return null;const n=this.view.state,c=[0,0];return n.toMap(c,[s[0]*e[0]+s[1]*e[3]+e[6],s[0]*e[1]+s[1]*e[4]+e[7]]),new Y.Z({x:c[0],y:c[1],spatialReference:n.spatialReference})}_ensureTileIndex(s){let e=s.featureIndex;return e||(e=ge.create(s.key,s.layerData,this._styleRepository,this._tileHandler,this.layer),s.featureIndex=e),e}};(0,H._)([(0,X.Cb)()],_e.prototype,"_isTileHandlerReady",void 0),_e=(0,H._)([(0,x.j)("esri.views.2d.layers.VectorTileLayerView2D")],_e);const We=_e},90135:(ue,$,a)=>{a.d($,{Z:()=>x});var v=a(17626),H=a(86810),q=a(77712),X=(a(8314),a(63290),a(4619),a(76898));let F=class extends H.wq{get version(){return this.commitVersionProperties(),(this._get("version")||0)+1}};(0,v._)([(0,q.Cb)({readOnly:!0})],F.prototype,"version",null),F=(0,v._)([(0,X.j)("esri.views.layers.support.ClipArea")],F);const x=F},74835:(ue,$,a)=>{a.d($,{Z:()=>K});var re,v=a(17626),q=(a(29132),a(77712)),X=(a(8314),a(63290),a(4619),a(76898)),F=a(21674),x=a(91179),A=a(90135),Y=a(2004),G=a(37118);const b={base:F.Z,key:"type",typeMap:{extent:Y.Z,polygon:G.Z}};let Z=re=class extends A.Z{constructor(Q){super(Q),this.type="geometry",this.geometry=null}clone(){return new re({geometry:this.geometry?.clone()??null})}commitVersionProperties(){this.commitProperty("geometry")}};(0,v._)([(0,q.Cb)({types:b,json:{read:x.im,write:!0}})],Z.prototype,"geometry",void 0),Z=re=(0,v._)([(0,X.j)("esri.views.layers.support.Geometry")],Z);const K=Z}}]);