"use strict";(self.webpackChunkpredio360_app=self.webpackChunkpredio360_app||[]).push([[5171],{90512:(ee,Y,c)=>{c.d(Y,{Z:()=>V});var _=c(15861);class V{constructor(){this.declaredRootClass="esri.arcade.featureSetCollection",this._layerById={},this._layerByName={}}add(N,D,U){this._layerById[D]=U,this._layerByName[N]=U}featureSetByName(N,D=!0,U=["*"]){var j=this;return(0,_.Z)(function*(){return void 0===j._layerByName[N]?null:j._layerByName[N]})()}featureSetById(N,D=!0,U=["*"]){var j=this;return(0,_.Z)(function*(){return void 0===j._layerById[N]?null:j._layerById[N]})()}castToText(N=!1){return"object, FeatureSetCollection"}}},85171:(ee,Y,c)=>{c.r(Y),c.d(Y,{constructAssociationMetaDataFeatureSetFromUrl:()=>Le,constructFeatureSet:()=>ne,constructFeatureSetFromPortalItem:()=>Be,constructFeatureSetFromRelationship:()=>Ze,constructFeatureSetFromUrl:()=>ue,convertToFeatureSet:()=>ke,createFeatureSetCollectionFromMap:()=>je,createFeatureSetCollectionFromService:()=>Ue,initialiseMetaDataCache:()=>Pe});var _=c(15861),V=c(84792),q=c(90512),N=c(53997),D=c(88879),U=c(47562),j=c(52724),w=c(95896),y=c(49086),R=c(91510),L=c(57366),f=c(77132),d=c(83947),P=c(45333),o=c(47982),C=c(10410);class x{constructor(){this.field="",this.tofieldname="",this.typeofstat="MIN",this.workingexpr=null}clone(){const e=new x;return e.field=this.field,e.tofieldname=this.tofieldname,e.typeofstat=this.typeofstat,e.workingexpr=this.workingexpr,e}static parseStatField(e,t,n){const r=new x;r.field=e;const a=C.WhereClause.create(t,n),i=function O(b){if("function"===b.parseTree.type){if(0===b.parseTree.args.value.length)return{name:b.parseTree.name,expr:null};if(b.parseTree.args.value.length>1)throw new o.eS(o.f.MissingStatisticParameters);const e=C.WhereClause.create((0,d.XF)(b.parseTree.args.value[0],f.Bj.Standardised,b.parameters),b.fieldsIndex);return{name:b.parseTree.name,expr:e}}return null}(a);if(null===i)throw new o.eS(o.f.UnsupportedSqlFunction,{function:""});const l=i.name.toUpperCase().trim();if("MIN"===l){if(r.typeofstat="MIN",r.workingexpr=i.expr,null===a)throw new o.eS(o.f.InvalidFunctionParameters,{function:"min"})}else if("MAX"===l){if(r.typeofstat="MAX",r.workingexpr=i.expr,null===a)throw new o.eS(o.f.InvalidFunctionParameters,{function:"max"})}else if("COUNT"===l)r.typeofstat="COUNT",r.workingexpr=i.expr;else if("STDEV"===l){if(r.typeofstat="STDDEV",r.workingexpr=i.expr,null===a)throw new o.eS(o.f.InvalidFunctionParameters,{function:"stdev"})}else if("SUM"===l){if(r.typeofstat="SUM",r.workingexpr=i.expr,null===a)throw new o.eS(o.f.InvalidFunctionParameters,{function:"sum"})}else if("MEAN"===l){if(r.typeofstat="AVG",r.workingexpr=i.expr,null===a)throw new o.eS(o.f.InvalidFunctionParameters,{function:l})}else if("AVG"===l){if(r.typeofstat="AVG",r.workingexpr=i.expr,null===a)throw new o.eS(o.f.InvalidFunctionParameters,{function:"avg"})}else{if("VAR"!==l)throw new o.eS(o.f.UnsupportedSqlFunction,{function:l});if(r.typeofstat="VAR",r.workingexpr=i.expr,null===a)throw new o.eS(o.f.InvalidFunctionParameters,{function:"var"})}return r}toStatisticsName(){switch(this.typeofstat.toUpperCase()){case"MIN":return"min";case"MAX":return"max";case"SUM":return"sum";case"COUNT":default:return"count";case"VAR":return"var";case"STDDEV":return"stddev";case"AVG":return"avg"}}}var I=c(50011),g=c(65234),u=c(36255),m=c(60466);function F(b){if(!b)return"COUNT";switch(b.toLowerCase()){case"max":return"MAX";case"var":case"variance":return"VAR";case"avg":case"average":case"mean":return"AVG";case"min":return"MIN";case"sum":return"SUM";case"stdev":case"stddev":return"STDDEV";case"count":return"COUNT"}return"COUNT"}class S extends y.Z{constructor(e){super(e),this._decodedStatsfield=[],this._decodedGroupbyfield=[],this._candosimplegroupby=!0,this.phsyicalgroupbyfields=[],this.objectIdField="ROW__ID",this._internalObjectIdField="ROW__ID",this._adaptedFields=[],this.declaredClass="esri.arcade.featureset.actions.Aggregate",this._uniqueIds=1,this._maxQuery=10,this._maxProcessing=10,this._parent=e.parentfeatureset,this._config=e}isTable(){return!0}_getSet(e){var t=this;return(0,_.Z)(function*(){if(null===t._wset){const n=yield t._getFilteredSet("",null,null,null,e);return t._wset=n,t._wset}return t._wset})()}_isInFeatureSet(){return f.dj.InFeatureSet}_nextUniqueName(e){for(;1===e["T"+this._uniqueIds.toString()];)this._uniqueIds++;const t="T"+this._uniqueIds.toString();return e[t]=1,t}_convertToEsriFieldType(e){return e}_initialiseFeatureSet(){const e={};let t=!1,n=1;const r=this._parent?this._parent.getFieldsIndex():new m.Z([]);for(this.objectIdField="ROW__ID",this.globalIdField="";!1===t;){let i=!1;for(let l=0;l<this._config.groupbyfields.length;l++)if(this._config.groupbyfields[l].name.toLowerCase()===this.objectIdField.toLowerCase()){i=!0;break}if(!1===i)for(let l=0;l<this._config.statsfields.length;l++)if(this._config.statsfields[l].name.toLowerCase()===this.objectIdField.toLowerCase()){i=!0;break}!1===i?t=!0:(this.objectIdField="ROW__ID"+n.toString(),n++)}for(const i of this._config.statsfields){const l=new x;l.field=i.name,l.tofieldname=i.name,l.workingexpr=i.expression instanceof C.WhereClause?i.expression:C.WhereClause.create(i.expression,r),l.typeofstat=F(i.statistic),this._decodedStatsfield.push(l)}this._decodedGroupbyfield=[];for(const i of this._config.groupbyfields){const l={name:i.name,singlefield:null,tofieldname:i.name,expression:i.expression instanceof C.WhereClause?i.expression:C.WhereClause.create(i.expression,r)};this._decodedGroupbyfield.push(l)}if(null!==this._parent){this.geometryType=this._parent.geometryType,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField="";for(const i of this._parent.fields)e[i.name.toUpperCase()]=1;this.types=null}else this.geometryType=f.Qk.point,this.typeIdField="",this.types=null,this.spatialReference=new g.Z({wkid:4326});this.fields=[];const a=new x;a.field=this._nextUniqueName(e),a.tofieldname=this.objectIdField,a.workingexpr=C.WhereClause.create(this._parent.objectIdField,this._parent.getFieldsIndex()),a.typeofstat="MIN",this._decodedStatsfield.push(a);for(const i of this._decodedGroupbyfield){const l=new u.Z;if(i.name=this._nextUniqueName(e),l.name=i.tofieldname,l.alias=l.name,(0,d.y5)(i.expression)){const s=this._parent.getField((0,d.zR)(i.expression,f.Bj.Standardised));if(!s)throw new o.EN(o.H9.AggregationFieldNotFound);i.name=s.name,i.singlefield=s.name,this.phsyicalgroupbyfields.push(s.name),l.type=s.type}else{l.type=this._convertToEsriFieldType((0,d.DT)(i.expression,this._parent.fields));const s=new u.Z;s.name=i.name,s.alias=s.name,this.phsyicalgroupbyfields.push(i.name),this._adaptedFields.push(new j.yN(s,i.expression)),this._candosimplegroupby=!1}this.fields.push(l)}if(this._adaptedFields.length>0)for(const i of this._parent.fields)this._adaptedFields.push(new j.$X(i));for(let i=0;i<this._decodedStatsfield.length;i++){const l=new u.Z;let s=null;const h=this._decodedStatsfield[i];h.field=this._nextUniqueName(e),h.tofieldname===this.objectIdField&&(this._internalObjectIdField=h.field),l.name=h.tofieldname,l.alias=l.name;const p=null!==h.workingexpr&&(0,d.y5)(h.workingexpr)?(0,d.zR)(h.workingexpr,f.Bj.Standardised):"";switch(this._decodedStatsfield[i].typeofstat){case"SUM":if(""!==p){if(s=this._parent.getField(p),!s)throw new o.EN(o.H9.AggregationFieldNotFound);l.type=s.type}else l.type="double";break;case"MIN":case"MAX":if(""!==p){if(s=this._parent.getField(p),!s)throw new o.EN(o.H9.AggregationFieldNotFound);l.type=s.type}else l.type="double";break;case"COUNT":l.type="integer";break;case"STDDEV":case"VAR":case"AVG":if(""!==p&&(s=this._parent.getField(p),!s))throw new o.EN(o.H9.AggregationFieldNotFound);l.type="double"}this.fields.push(l)}}_canDoAggregates(){return(0,_.Z)(function*(){return!1})()}_getFeatures(e,t,n,r){var a=this;return(0,_.Z)(function*(){const i=a._maxQuery;return!0===a._checkIfNeedToExpandKnownPage(e,i)?(yield a._expandPagedSet(e,i,0,0,r),a._getFeatures(e,t,n,r)):"success"})()}_getFilteredSet(e,t,n,r,a){var i=this;return(0,_.Z)(function*(){if(""!==e)return new R.Z([],[],!0,null);let l=null;const s={ordered:!1,nowhereclause:!1};if(yield i._ensureLoaded(),null!==n)for(let p=0;p<i._decodedStatsfield.length;p++)if(!0===(0,d.hq)(n,i._decodedStatsfield[p].tofieldname)){s.nowhereclause=!0,n=null;break}if(null!==r){s.ordered=!0;for(let p=0;p<i._decodedStatsfield.length;p++)if(!0===r.scanForField(i._decodedStatsfield[p].tofieldname)){r=null,s.ordered=!1;break}if(null!==r)for(const p of i._decodedGroupbyfield)if(null===p.singlefield&&!0===r.scanForField(p.tofieldname)){r=null,s.ordered=!1;break}}if(!1!==i._candosimplegroupby&&(yield i._parent._canDoAggregates(i.phsyicalgroupbyfields,i._decodedStatsfield,"",null,null))){let p=null;n&&(p=i._reformulateWhereClauseWithoutGroupByFields(n));let E=null;r&&(E=i._reformulateOrderClauseWithoutGroupByFields(r));const A=yield i._parent._getAggregatePagesDataSourceDefinition(i.phsyicalgroupbyfields,i._decodedStatsfield,"",null,p,E,i._internalObjectIdField);return i._checkCancelled(a),l=!0===s.nowhereclause?new R.Z(A._candidates.slice(0).concat(A._known.slice(0)),[],!0===s.ordered&&A._ordered,i._clonePageDefinition(A.pagesDefinition)):new R.Z(A._candidates.slice(0),A._known.slice(0),!0===s.ordered&&A._ordered,i._clonePageDefinition(A.pagesDefinition)),l}let h=i._parent;if(i._adaptedFields.length>0&&(h=new j.Xx({parentfeatureset:i._parent,adaptedFields:i._adaptedFields,extraFilter:null})),!0===s.nowhereclause)l=new R.Z(["GETPAGES"],[],!1,{aggregatefeaturesetpagedefinition:!0,resultOffset:0,resultRecordCount:i._maxQuery,internal:{fullyResolved:!1,workingItem:null,type:"manual",iterator:null,set:[],subfeatureset:new w.Z({parentfeatureset:h,orderbyclause:new L.Z(i.phsyicalgroupbyfields.join(",")+","+i._parent.objectIdField+" ASC")})}});else{let p=h;if(null!==n){let E=null;n&&(E=i._reformulateWhereClauseWithoutGroupByFields(n)),p=new N.Z({parentfeatureset:p,whereclause:E})}l=new R.Z(["GETPAGES"],[],!1,{aggregatefeaturesetpagedefinition:!0,resultOffset:0,resultRecordCount:i._maxQuery,internal:{fullyResolved:!1,workingItem:null,type:"manual",iterator:null,set:[],subfeatureset:new w.Z({parentfeatureset:p,orderbyclause:new L.Z(i.phsyicalgroupbyfields.join(",")+","+i._parent.objectIdField+" ASC")})}})}return l})()}_reformulateWhereClauseWithoutStatsFields(e){for(const t of this._decodedStatsfield)e=(0,d.bB)(e,t.tofieldname,(0,d.zR)(t.workingexpr,f.Bj.Standardised),this._parent.getFieldsIndex());return e}_reformulateWhereClauseWithoutGroupByFields(e){for(const t of this._decodedGroupbyfield)t.tofieldname!==t.name&&(e=(0,d.bB)(e,t.tofieldname,(0,d.zR)(t.expression,f.Bj.Standardised),this._parent.getFieldsIndex()));return e}_reformulateOrderClauseWithoutGroupByFields(e){const t=[];for(const n of this._decodedGroupbyfield)n.tofieldname!==n.name&&t.push({field:n.tofieldname,newfield:n.name});return t.length>0?e.replaceFields(t):e}_clonePageDefinition(e){return null===e?null:!0===e.aggregatefeaturesetpagedefinition?{aggregatefeaturesetpagedefinition:!0,resultRecordCount:e.resultRecordCount,resultOffset:e.resultOffset,internal:e.internal}:this._parent._clonePageDefinition(e)}_refineSetBlock(e,t,n){var r=this;return(0,_.Z)(function*(){return!0===r._checkIfNeedToExpandCandidatePage(e,r._maxQuery)?(yield r._expandPagedSet(e,r._maxQuery,0,0,n),r._refineSetBlock(e,t,n)):(r._checkCancelled(n),r._refineKnowns(e,t),e)})()}_expandPagedSet(e,t,n,r,a){return this._expandPagedSetFeatureSet(e,t,n,r,a)}_getPhysicalPage(e,t,n){var r=this;return(0,_.Z)(function*(){if(!0===e.pagesDefinition.aggregatefeaturesetpagedefinition)return r._sequentialGetPhysicalItem(e,e.pagesDefinition.resultRecordCount,n,[]);const a=yield r._getAgregagtePhysicalPage(e,t,n);for(const i of a){const l={geometry:i.geometry,attributes:{}};for(const s of r._decodedGroupbyfield)l.attributes[s.tofieldname]=i.attributes[s.name];for(const s of r._decodedStatsfield)l.attributes[s.tofieldname]=i.attributes[s.field];r._featureCache[l.attributes[r.objectIdField]]=new D.Z(l)}return a.length})()}_sequentialGetPhysicalItem(e,t,n,r){return new Promise((a,i)=>{null===e.pagesDefinition.internal.iterator&&(e.pagesDefinition.internal.iterator=e.pagesDefinition.internal.subfeatureset.iterator(n)),!0===e.pagesDefinition.internal.fullyResolved||0===t?a(r.length):this._nextAggregateItem(e,t,n,r,l=>{a(null===l?r.length:this._sequentialGetPhysicalItem(e,t-=1,n,r))},i)})}_nextAggregateItem(e,t,n,r,a,i){try{(0,U.W)(e.pagesDefinition.internal.iterator.next()).then(l=>{if(null===l)if(null!==e.pagesDefinition.internal.workingItem){const s=this._calculateAndAppendAggregateItem(e.pagesDefinition.internal.workingItem);r.push(s),e.pagesDefinition.internal.workingItem=null,e.pagesDefinition.internal.set.push(s.attributes[this.objectIdField]),e.pagesDefinition.internal.fullyResolved=!0,a(null)}else e.pagesDefinition.internal.fullyResolved=!0,a(null);else{const s=this._generateAggregateHash(l);if(null===e.pagesDefinition.internal.workingItem)e.pagesDefinition.internal.workingItem={features:[l],id:s};else{if(s!==e.pagesDefinition.internal.workingItem.id){const h=this._calculateAndAppendAggregateItem(e.pagesDefinition.internal.workingItem);return r.push(h),e.pagesDefinition.internal.workingItem=null,e.pagesDefinition.internal.set.push(h.attributes[this.objectIdField]),t-=1,e.pagesDefinition.internal.workingItem={features:[l],id:s},void a(h)}e.pagesDefinition.internal.workingItem.features.push(l)}this._nextAggregateItem(e,t,n,r,a,i)}},i)}catch(l){i(l)}}_calculateFieldStat(e,t,n){const r=[];for(let a=0;a<e.features.length;a++)if(null!==t.workingexpr){const i=t.workingexpr.calculateValue(e.features[a]);null!==i&&r.push(i)}else r.push(null);switch(t.typeofstat){case"MIN":n.attributes[t.tofieldname]=(0,P.tj)("min",r,-1);break;case"MAX":n.attributes[t.tofieldname]=(0,P.tj)("max",r,-1);break;case"SUM":n.attributes[t.tofieldname]=(0,P.tj)("sum",r,-1);break;case"COUNT":n.attributes[t.tofieldname]=r.length;break;case"VAR":n.attributes[t.tofieldname]=(0,P.tj)("var",r,-1);break;case"STDDEV":n.attributes[t.tofieldname]=(0,P.tj)("stddev",r,-1);break;case"AVG":n.attributes[t.tofieldname]=(0,P.tj)("avg",r,-1)}return!0}_calculateAndAppendAggregateItem(e){const t={attributes:{},geometry:null};for(const r of this._decodedGroupbyfield){const a=r.singlefield?e.features[0].attributes[r.singlefield]:r.expression.calculateValue(e.features[0]);t.attributes[r.tofieldname]=a}for(const r of this._decodedStatsfield)this._calculateFieldStat(e,r,t);const n=[];for(let r=0;r<this._decodedStatsfield.length;r++)n.push(this._calculateFieldStat(e,this._decodedStatsfield[r],t));return this._featureCache[t.attributes[this.objectIdField]]=new D.Z({attributes:t.attributes,geometry:t.geometry}),t}_generateAggregateHash(e){let t="";for(const n of this._decodedGroupbyfield){const r=n.singlefield?e.attributes[n.singlefield]:n.expression.calculateValue(e);t+=null==r?":":":"+r.toString()}return(0,I.F)(t,I.M.String)}_stat(){return(0,_.Z)(function*(){return{calculated:!1}})()}getFeatureByObjectId(){return(0,_.Z)(function*(){return null})()}static registerAction(){y.Z._featuresetFunctions.groupby=function(e,t){return new S({parentfeatureset:this,groupbyfields:e,statsfields:t})}}}var v=c(3482),z=c(79429),Z=c(22386),B=c(24263),W=c(91179),T=c(80415),M=c(82054),me=(c(26584),c(8314),c(63290),c(15283),c(2865)),we=(c(59318),c(85931),c(21726),c(16730),c(37053),c(20477)),ve=c(17253),te=c(96854),De=(c(87183),c(67736),c(90463)),Ce=(c(29132),c(24865)),Fe=c(67010),Re=(c(93555),c(6871),c(98558)),Se=c(60776),Ee=c(6729);class ae extends y.Z{constructor(e){super(e),this.declaredClass="esri.arcade.featureset.sources.FeatureLayerDynamic",this._removeGeometry=!1,this._overrideFields=null,this.formulaCredential=null,this._pageJustIds=!1,this._requestStandardised=!1,this._useDefinitionExpression=!0,this._cachedDateMetaData={},e.spatialReference&&(this.spatialReference=e.spatialReference),this._transparent=!0,this._maxProcessing=1e3,this._layer=e.layer,this._wset=null,void 0!==e.outFields&&(this._overrideFields=e.outFields),void 0!==e.includeGeometry&&(this._removeGeometry=!1===e.includeGeometry)}_maxQueryRate(){return f.tI}end(){return this._layer}optimisePagingFeatureQueries(e){this._pageJustIds=e}get urlQueryPath(){return this._layer.parsedUrl.path||""}convertQueryToLruCacheKey(e){const t=this.urlQueryPath+","+(0,f.hd)(e.toJSON());return(0,I.F)(t,I.M.String)}loadImpl(){var e=this;return(0,_.Z)(function*(){return!0===e._layer.loaded?(e._initialiseFeatureSet(),e):(yield e._layer.load(),e._initialiseFeatureSet(),e)})()}_initialiseFeatureSet(){if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this._layer.geometryType,this.fields=this._layer.fields.slice(0),this._layer.outFields&&(1!==this._layer.outFields.length||"*"!==this._layer.outFields[0])){const e=[];for(const t of this.fields)if("oid"===t.type)e.push(t);else for(const n of this._layer.outFields)if(n.toLowerCase()===t.name.toLowerCase()){e.push(t);break}this.fields=e}if(null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{const e=[],t=[];for(const n of this.fields)if("oid"===n.type)e.push(n),t.push(n.name);else for(const r of this._overrideFields)if(r.toLowerCase()===n.name.toLowerCase()){e.push(n),t.push(n.name);break}this.fields=e,this._overrideFields=t}if(this._layer.source&&this._layer.source.sourceJSON){const e=this._layer.source.sourceJSON.currentVersion;!0===this._layer.source.sourceJSON.useStandardizedQueries?(this._databaseType=f.Bj.StandardisedNoInterval,null!=e&&e>=10.61&&(this._databaseType=f.Bj.Standardised)):null!=e&&(e>=10.5&&(this._databaseType=f.Bj.StandardisedNoInterval,this._requestStandardised=!0),e>=10.61&&(this._databaseType=f.Bj.Standardised))}this.objectIdField=this._layer.objectIdField;for(const e of this.fields)"global-id"===e.type&&(this.globalIdField=e.name);this.hasM=this._layer.supportsM,this.hasZ=this._layer.supportsZ,this.typeIdField=this._layer.typeIdField??"",this.types=this._layer.types}_isInFeatureSet(){return f.dj.InFeatureSet}_refineSetBlock(e){return(0,_.Z)(function*(){return e})()}_candidateIdTransform(e){return e}_getSet(e){var t=this;return(0,_.Z)(function*(){if(null===t._wset){yield t._ensureLoaded();const n=yield t._getFilteredSet("",null,null,null,e);return t._wset=n,n}return t._wset})()}_runDatabaseProbe(e){var t=this;return(0,_.Z)(function*(){yield t._ensureLoaded();const n=new te.Z;t.datesInUnknownTimezone&&(n.timeReferenceUnknownClient=!0),n.where=e.replace("OBJECTID",t._layer.objectIdField);try{return yield t._layer.queryObjectIds(n),!0}catch{return!1}})()}_canUsePagination(){return!(!this._layer.capabilities||!this._layer.capabilities.query||!0!==this._layer.capabilities.query.supportsPagination)}_cacheableFeatureSetSourceKey(){return this._layer.url}pbfSupportedForQuery(e){const t=this._layer?.capabilities?.query;return!e.outStatistics&&!0===t?.supportsFormatPBF&&!0===t?.supportsQuantizationEditMode}queryPBF(e){var t=this;return(0,_.Z)(function*(){e.quantizationParameters={mode:"edit"};const n=yield(0,we.qp)(t._layer.parsedUrl,e,new Re.J({}));return ve.Z.fromJSON((0,M.cn)(n.data)).unquantize()})()}get gdbVersion(){return this._layer&&this._layer.capabilities&&this._layer.capabilities.data&&this._layer.capabilities.data.isVersioned?this._layer.gdbVersion?this._layer.gdbVersion:"SDE.DEFAULT":""}nativeCapabilities(){return{title:this._layer.title??"",source:this,canQueryRelated:!0,capabilities:this._layer.capabilities,databaseType:this._databaseType,requestStandardised:this._requestStandardised}}executeQuery(e,t){const n="execute"===t?me.e:"executeForCount"===t?De.P:Ce.G,r="execute"===t&&this.pbfSupportedForQuery(e);let a=null;if(this.recentlyUsedQueries){const i=this.convertQueryToLruCacheKey(e);a=this.recentlyUsedQueries.getFromCache(i),null===a&&(a=!0!==r?n(this._layer.parsedUrl.path,e):this.queryPBF(e),this.recentlyUsedQueries.addToCache(i,a),a=a.catch(l=>{throw this.recentlyUsedQueries?.removeFromCache(i),l}))}return this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preLayerQueryCallback({layer:this._layer,query:e,method:t}),null===a&&(a=!0!==r?n(this._layer.parsedUrl.path,e):this.queryPBF(e)),a}_getFilteredSet(e,t,n,r,a){var i=this;return(0,_.Z)(function*(){const l=yield i.databaseType();if(i.isTable()&&t&&null!==e&&""!==e)return new R.Z([],[],!0,null);if(i._canUsePagination())return i._getFilteredSetUsingPaging(e,t,n,r,a);let s="",h=!1;null!==r&&i._layer.capabilities&&i._layer.capabilities.query&&!0===i._layer.capabilities.query.supportsOrderBy&&(s=r.constructClause(),h=!0);const p=new te.Z;i.datesInUnknownTimezone&&(p.timeReferenceUnknownClient=!0),p.where=null===n?null===t?"1=1":"":(0,d.zR)(n,l),i._requestStandardised&&(p.sqlFormat="standard"),p.spatialRelationship=i._makeRelationshipEnum(e),p.outSpatialReference=i.spatialReference,p.orderByFields=""!==s?s.split(","):null,p.geometry=null===t?null:t,p.relationParameter=i._makeRelationshipParam(e);let E=yield i.executeQuery(p,"executeForIds");return null===E&&(E=[]),i._checkCancelled(a),new R.Z([],E,h,null)})()}_expandPagedSet(e,t,n,r,a){return this._expandPagedSetFeatureSet(e,t,n,r,a)}_getFilteredSetUsingPaging(e,t,n,r,a){var i=this;return(0,_.Z)(function*(){let l="",s=!1;null!==r&&i._layer.capabilities&&i._layer.capabilities.query&&!0===i._layer.capabilities.query.supportsOrderBy&&(l=r.constructClause(),s=!0);const h=yield i.databaseType();let p=null===n?null===t?"1=1":"":(0,d.zR)(n,h);i._layer.definitionExpression&&i._useDefinitionExpression&&(p=""!==p?"(("+i._layer.definitionExpression+") AND ("+p+"))":i._layer.definitionExpression);let E=i._maxQueryRate();const A=i._layer.capabilities?.query.maxRecordCount;null!=A&&A<E&&(E=A);let k=null;if(!0===i._pageJustIds)k=new R.Z([],["GETPAGES"],s,{spatialRel:i._makeRelationshipEnum(e),relationParam:i._makeRelationshipParam(e),outFields:i._layer.objectIdField,resultRecordCount:E,resultOffset:0,geometry:null===t?null:t,where:p,orderByFields:l,returnGeometry:!1,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}});else{let K=!0;!0===i._removeGeometry&&(K=!1);const H=null!==i._overrideFields?i._overrideFields:i._fieldsIncludingObjectId(i._layer.outFields?i._layer.outFields:["*"]);k=new R.Z([],["GETPAGES"],s,{spatialRel:i._makeRelationshipEnum(e),relationParam:i._makeRelationshipParam(e),outFields:H.join(","),resultRecordCount:E,resultOffset:0,geometry:null===t?null:t,where:p,orderByFields:l,returnGeometry:K,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}})}return yield i._expandPagedSet(k,E,0,1,a),k})()}_clonePageDefinition(e){return null===e?null:!0!==e.groupbypage?{groupbypage:!1,spatialRel:e.spatialRel,relationParam:e.relationParam,outFields:e.outFields,resultRecordCount:e.resultRecordCount,resultOffset:e.resultOffset,geometry:e.geometry,where:e.where,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}:{groupbypage:!0,spatialRel:e.spatialRel,relationParam:e.relationParam,outFields:e.outFields,resultRecordCount:e.resultRecordCount,useOIDpagination:e.useOIDpagination,generatedOid:e.generatedOid,groupByFieldsForStatistics:e.groupByFieldsForStatistics,resultOffset:e.resultOffset,outStatistics:e.outStatistics,geometry:e.geometry,where:e.where,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}}_getPhysicalPage(e,t,n){var r=this;return(0,_.Z)(function*(){const a=e.pagesDefinition.internal.lastRetrieved,i=a,l=e.pagesDefinition.internal.lastPage,s=new te.Z;r._requestStandardised&&(s.sqlFormat="standard"),r.datesInUnknownTimezone&&(s.timeReferenceUnknownClient=!0),s.spatialRelationship=e.pagesDefinition.spatialRel,s.relationParameter=e.pagesDefinition.relationParam,s.outFields=e.pagesDefinition.outFields.split(","),s.num=e.pagesDefinition.resultRecordCount,s.start=e.pagesDefinition.internal.lastPage,s.geometry=e.pagesDefinition.geometry,s.where=e.pagesDefinition.where,s.orderByFields=""!==e.pagesDefinition.orderByFields?e.pagesDefinition.orderByFields.split(","):null,s.returnGeometry=e.pagesDefinition.returnGeometry,s.outSpatialReference=r.spatialReference;const h=yield r.executeQuery(s,"execute");if(r._checkCancelled(n),e.pagesDefinition.internal.lastPage!==l)return"done";const p=r._layer.objectIdField;for(let E=0;E<h.features.length;E++)e.pagesDefinition.internal.set[i+E]=h.features[E].attributes[p];if(!1===r._pageJustIds)for(let E=0;E<h.features.length;E++)r._featureCache[h.features[E].attributes[p]]=h.features[E];return(void 0===h.exceededTransferLimit&&h.features.length!==e.pagesDefinition.resultRecordCount||!1===h.exceededTransferLimit)&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=a+h.features.length,e.pagesDefinition.internal.lastPage+=e.pagesDefinition.resultRecordCount,"done"})()}_fieldsIncludingObjectId(e){if(null===e)return[this.objectIdField];const t=e.slice(0);if(t.includes("*"))return t;let n=!1;for(const r of t)if(r.toUpperCase()===this.objectIdField.toUpperCase()){n=!0;break}return!1===n&&t.push(this.objectIdField),t}_getFeatures(e,t,n,r){var a=this;return(0,_.Z)(function*(){const i=[];if(-1!==t&&void 0===a._featureCache[t]&&i.push(t),!0===a._checkIfNeedToExpandKnownPage(e,a._maxProcessingRate()))return yield a._expandPagedSet(e,a._maxProcessingRate(),0,0,r),a._getFeatures(e,t,n,r);let l=0;for(let E=e._lastFetchedIndex;E<e._known.length;E++){if(e._lastFetchedIndex+=1,l++,void 0===a._featureCache[e._known[E]]){let A=!1;if(null!=a._layer._mode){const k=a._layer._mode;if(void 0!==k._featureMap[e._known[E]]){const K=k._featureMap[e._known[E]];null!==K&&(A=!0,a._featureCache[e._known[E]]=K)}}if(!1===A&&(e._known[E]!==t&&i.push(e._known[E]),i.length>=a._maxProcessingRate()-1))break}if(l>=n&&0===i.length)break}if(0===i.length)return"success";const s=new te.Z;a._requestStandardised&&(s.sqlFormat="standard"),a.datesInUnknownTimezone&&(s.timeReferenceUnknownClient=!0),s.objectIds=i,s.outFields=null!==a._overrideFields?a._overrideFields:a._fieldsIncludingObjectId(a._layer.outFields?a._layer.outFields:["*"]),s.returnGeometry=!0,!0===a._removeGeometry&&(s.returnGeometry=!1),s.outSpatialReference=a.spatialReference;const h=yield a.executeQuery(s,"execute");if(a._checkCancelled(r),void 0!==h.error)throw new o.EN(o.H9.RequestFailed,{reason:h.error});const p=a._layer.objectIdField;for(let E=0;E<h.features.length;E++)a._featureCache[h.features[E].attributes[p]]=h.features[E];return"success"})()}_getDistinctPages(e,t,n,r,a,i,l,s,h){var p=this;return(0,_.Z)(function*(){yield p._ensureLoaded();const E=yield p.databaseType();let A=n.parseTree.column;const k=p._layer.fields??[];for(let Q=0;Q<k.length;Q++)if(k[Q].name.toLowerCase()===A.toLowerCase()){A=k[Q].name;break}const K=new te.Z;p._requestStandardised&&(K.sqlFormat="standard"),p.datesInUnknownTimezone&&(K.timeReferenceUnknownClient=!0);let H=null===i?null===a?"1=1":"":(0,d.zR)(i,E);p._layer.definitionExpression&&p._useDefinitionExpression&&(H=""!==H?"(("+p._layer.definitionExpression+") AND ("+H+"))":p._layer.definitionExpression),K.where=H,K.spatialRelationship=p._makeRelationshipEnum(r),K.relationParameter=p._makeRelationshipParam(r),K.geometry=null===a?null:a,K.returnDistinctValues=!0,K.returnGeometry=!1,K.outFields=[A];const X=yield p.executeQuery(K,"execute");if(p._checkCancelled(h),!X.hasOwnProperty("features"))throw new o.EN(o.H9.InvalidStatResponse);let $=!1;for(let Q=0;Q<k.length;Q++)if(k[Q].name===A){"date"===k[Q].type&&($=!0);break}for(let Q=0;Q<X.features.length;Q++){if($){const ie=X.features[Q].attributes[A];s.push(null!==ie?new Date(ie):ie)}else s.push(X.features[Q].attributes[A]);if(s.length>=l)break}return 0===X.features.length?s:X.features.length===p._layer.capabilities?.query.maxRecordCount&&s.length<l?{calculated:!0,result:yield p._getDistinctPages(e+X.features.length,t,n,r,a,i,l,s,h)}:s})()}_distinctStat(e,t,n,r,a,i,l){var s=this;return(0,_.Z)(function*(){return{calculated:!0,result:yield s._getDistinctPages(0,e,t,n,r,a,i,[],l)}})()}isTable(){return this._layer.isTable||null===this._layer.geometryType||"table"===this._layer.type||""===this._layer.geometryType||"esriGeometryNull"===this._layer.geometryType}_countstat(e,t,n,r){var a=this;return(0,_.Z)(function*(){const i=yield a.databaseType(),l=new te.Z;if(a._requestStandardised&&(l.sqlFormat="standard"),a.isTable()&&n&&null!==t&&""!==t)return{calculated:!0,result:0};let s=null===r?null===n?"1=1":"":(0,d.zR)(r,i);return a._layer.definitionExpression&&a._useDefinitionExpression&&(s=""!==s?"(("+a._layer.definitionExpression+") AND ("+s+"))":a._layer.definitionExpression),l.where=s,a.datesInUnknownTimezone&&(l.timeReferenceUnknownClient=!0),l.where=s,l.spatialRelationship=a._makeRelationshipEnum(t),l.relationParameter=a._makeRelationshipParam(t),l.geometry=null===n?null:n,l.returnGeometry=!1,{calculated:!0,result:yield a.executeQuery(l,"executeForCount")}})()}_stats(e,t,n,r,a,i,l){var s=this;return(0,_.Z)(function*(){yield s._ensureLoaded();const h=s._layer.capabilities&&s._layer.capabilities.query&&!0===s._layer.capabilities.query.supportsSqlExpression,p=s._layer.capabilities&&s._layer.capabilities.query&&!0===s._layer.capabilities.query.supportsStatistics,E=s._layer.capabilities&&s._layer.capabilities.query&&!0===s._layer.capabilities.query.supportsDistinct;if("count"===e)return E?s._countstat(e,n,r,a):{calculated:!1};if(!1===p||!1===(0,d.y5)(t)&&!1===h||!1===t.isStandardized)return""!==n||null!==a?{calculated:!1}:s._manualStat(e,t,i,l);if("distinct"===e)return!1===E?""!==n||null!==a?{calculated:!1}:s._manualStat(e,t,i,l):s._distinctStat(e,t,n,r,a,i,l);const A=yield s.databaseType();if(s.isTable()&&r&&null!==n&&""!==n)return{calculated:!0,result:null};const k=new te.Z;s._requestStandardised&&(k.sqlFormat="standard");let K=null===a?null===r?"1=1":"":(0,d.zR)(a,A);s._layer.definitionExpression&&s._useDefinitionExpression&&(K=""!==K?"(("+s._layer.definitionExpression+") AND ("+K+"))":s._layer.definitionExpression),k.where=K,k.spatialRelationship=s._makeRelationshipEnum(n),k.relationParameter=s._makeRelationshipParam(n),k.geometry=null===r?null:r,s.datesInUnknownTimezone&&(k.timeReferenceUnknownClient=!0);const H=new Se.Z;H.statisticType=(0,P.g3)(e),H.onStatisticField=(0,d.zR)(t,A),H.outStatisticFieldName="ARCADE_STAT_RESULT",k.returnGeometry=!1;let X="ARCADE_STAT_RESULT";k.outStatistics=[H];const $=yield s.executeQuery(k,"execute");if(!$.hasOwnProperty("features")||0===$.features.length)throw new o.EN(o.H9.InvalidStatResponse);let Q=!1;const ie=$.fields??[];for(let re=0;re<ie.length;re++)if("ARCADE_STAT_RESULT"===ie[re].name.toUpperCase()){X=ie[re].name,"date"===ie[re].type&&(Q=!0);break}if(Q){let re=$.features[0].attributes[X];return null!==re&&(re=new Date($.features[0].attributes[X])),{calculated:!0,result:re}}return{calculated:!0,result:$.features[0].attributes[X]}})()}_stat(e,t,n,r,a,i,l){return this._stats(e,t,n,r,a,i,l)}_canDoAggregates(e,t){var n=this;return(0,_.Z)(function*(){yield n._ensureLoaded();let r=!1;const a=n._layer.capabilities?.query,i=!0===a?.supportsSqlExpression;if(null!=a&&!0===a.supportsStatistics&&!0===a.supportsOrderBy&&(r=!0),r)for(let l=0;l<t.length-1;l++)(!1===t[l].workingexpr?.isStandardized||!1===(0,d.y5)(t[l].workingexpr)&&!1===i)&&(r=!1);return!1!==r})()}_makeRelationshipEnum(e){if(e.includes("esriSpatialRelRelation"))return"relation";switch(e){case"esriSpatialRelRelation":return"relation";case"esriSpatialRelIntersects":return"intersects";case"esriSpatialRelContains":return"contains";case"esriSpatialRelOverlaps":return"overlaps";case"esriSpatialRelWithin":return"within";case"esriSpatialRelTouches":return"touches";case"esriSpatialRelCrosses":return"crosses";case"esriSpatialRelEnvelopeIntersects":return"envelope-intersects"}return e}_makeRelationshipParam(e){return e.includes("esriSpatialRelRelation")?e.split(":")[1]:""}_getAggregatePagesDataSourceDefinition(e,t,n,r,a,i,l){var s=this;return(0,_.Z)(function*(){yield s._ensureLoaded();const h=yield s.databaseType();let p="",E=!1,A=!1;null!==i&&s._layer.capabilities&&s._layer.capabilities.query&&!0===s._layer.capabilities.query.supportsOrderBy&&(p=i.constructClause(),A=!0),s._layer.capabilities&&s._layer.capabilities.query&&!1===s._layer.capabilities.query.supportsPagination&&(A=!1,E=!0,p=s._layer.objectIdField);const k=[];for(let $=0;$<t.length;$++){const Q=new Se.Z;Q.onStatisticField=null!==t[$].workingexpr?(0,d.zR)(t[$].workingexpr,h):"",Q.outStatisticFieldName=t[$].field,Q.statisticType=t[$].toStatisticsName(),k.push(Q)}""===p&&(p=e.join(","));let K=s._maxQueryRate();const H=s._layer.capabilities?.query.maxRecordCount;null!=H&&H<K&&(K=H);let X=null===a?null===r?"1=1":"":(0,d.zR)(a,h);return s._layer.definitionExpression&&s._useDefinitionExpression&&(X=""!==X?"(("+s._layer.definitionExpression+") AND ("+X+"))":s._layer.definitionExpression),new R.Z([],["GETPAGES"],A,{groupbypage:!0,spatialRel:s._makeRelationshipEnum(n),relationParam:s._makeRelationshipParam(n),outFields:["*"],useOIDpagination:E,generatedOid:l,resultRecordCount:K,resultOffset:0,groupByFieldsForStatistics:e,outStatistics:k,geometry:null===r?null:r,where:X,orderByFields:p,returnGeometry:!1,returnIdsOnly:!1,internal:{lastMaxId:-1,set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}})})()}_getAgregagtePhysicalPage(e,t,n){var r=this;return(0,_.Z)(function*(){let a=e.pagesDefinition.where;!0===e.pagesDefinition.useOIDpagination&&(a=""!==a?"("+a+") AND ("+e.pagesDefinition.generatedOid+">"+e.pagesDefinition.internal.lastMaxId.toString()+")":e.pagesDefinition.generatedOid+">"+e.pagesDefinition.internal.lastMaxId.toString());const i=e.pagesDefinition.internal.lastRetrieved,l=i,s=e.pagesDefinition.internal.lastPage,h=new te.Z;if(r._requestStandardised&&(h.sqlFormat="standard"),h.where=a,h.spatialRelationship=e.pagesDefinition.spatialRel,h.relationParameter=e.pagesDefinition.relationParam,h.outFields=e.pagesDefinition.outFields,h.outStatistics=e.pagesDefinition.outStatistics,h.geometry=e.pagesDefinition.geometry,h.groupByFieldsForStatistics=e.pagesDefinition.groupByFieldsForStatistics,h.num=e.pagesDefinition.resultRecordCount,h.start=e.pagesDefinition.internal.lastPage,h.returnGeometry=e.pagesDefinition.returnGeometry,r.datesInUnknownTimezone&&(h.timeReferenceUnknownClient=!0),h.orderByFields=""!==e.pagesDefinition.orderByFields?e.pagesDefinition.orderByFields.split(","):null,r.isTable()&&h.geometry&&h.spatialRelationship)return[];const p=yield r.executeQuery(h,"execute");if(r._checkCancelled(n),!p.hasOwnProperty("features"))throw new o.EN(o.H9.InvalidStatResponse);const E=[];if(e.pagesDefinition.internal.lastPage!==s)return[];for(let A=0;A<p.features.length;A++)e.pagesDefinition.internal.set[l+A]=p.features[A].attributes[e.pagesDefinition.generatedOid];for(let A=0;A<p.features.length;A++)E.push(new D.Z({attributes:p.features[A].attributes,geometry:null}));return!0===e.pagesDefinition.useOIDpagination?0===p.features.length?e.pagesDefinition.internal.fullyResolved=!0:e.pagesDefinition.internal.lastMaxId=p.features[p.features.length-1].attributes[e.pagesDefinition.generatedOid]:(void 0===p.exceededTransferLimit&&p.features.length!==e.pagesDefinition.resultRecordCount||!1===p.exceededTransferLimit)&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=i+p.features.length,e.pagesDefinition.internal.lastPage+=e.pagesDefinition.resultRecordCount,E})()}static create(e,t,n,r,a){const i=new T.default({url:e,outFields:null===t?["*"]:t});return new ae({layer:i,spatialReference:n,lrucache:r,interceptor:a})}relationshipMetaData(){return this._layer&&this._layer.source&&this._layer.source.sourceJSON&&this._layer.source.sourceJSON.relationships?this._layer.source.sourceJSON.relationships:[]}serviceUrl(){return(0,f.US)(this._layer.parsedUrl.path)}queryAttachments(e,t,n,r,a){var i=this;return(0,_.Z)(function*(){const l=i._layer.capabilities;if(l?.data.supportsAttachment&&l?.operations.supportsQueryAttachments){const s={objectIds:[e],returnMetadata:a};(t&&t>0||n&&n>0)&&(s.size=[t&&t>0?t:0,n&&n>0?n:t+1]),r&&r.length>0&&(s.attachmentTypes=r),i.featureSetQueryInterceptor&&i.featureSetQueryInterceptor.preLayerQueryCallback({layer:i._layer,query:s,method:"attachments"});const h=yield i._layer.queryAttachments(s),p=[];return h&&h[e]&&h[e].forEach(E=>{const A=i._layer.parsedUrl.path+"/"+e.toString()+"/attachments/"+E.id.toString();let k=null;a&&E.exifInfo&&(k=Ee.Z.convertJsonToArcade(E.exifInfo,"system",!0)),p.push(new Z.Z(E.id,E.name,E.contentType,E.size,A,k))}),p}return[]})()}queryRelatedFeatures(e){var t=this;return(0,_.Z)(function*(){const n={f:"json",relationshipId:e.relationshipId.toString(),definitionExpression:e.where,outFields:e.outFields?.join(","),returnGeometry:e.returnGeometry.toString()};null!=e.resultOffset&&(n.resultOffset=e.resultOffset.toString()),null!=e.resultRecordCount&&(n.resultRecordCount=e.resultRecordCount.toString()),e.orderByFields&&(n.orderByFields=e.orderByFields.join(",")),e.objectIds&&e.objectIds.length>0&&(n.objectIds=e.objectIds.join(",")),e.outSpatialReference&&(n.outSR=JSON.stringify(e.outSpatialReference.toJSON())),t.featureSetQueryInterceptor&&t.featureSetQueryInterceptor.preRequestCallback({layer:t._layer,queryPayload:n,method:"relatedrecords",url:t._layer.parsedUrl.path+"/queryRelatedRecords"});const r=yield(0,V.default)(t._layer.parsedUrl.path+"/queryRelatedRecords",{responseType:"json",query:n});if(r.data){const a={},i=r.data;if(i&&i.relatedRecordGroups){const l=i.spatialReference;for(const s of i.relatedRecordGroups){const h=s.objectId,p=[];for(const E of s.relatedRecords){E.geometry&&(E.geometry.spatialReference=l);const A=new D.Z({geometry:E.geometry?(0,W.im)(E.geometry):null,attributes:E.attributes});p.push(A)}a[h]={features:p,exceededTransferLimit:!0===i.exceededTransferLimit}}}return a}throw new o.EN(o.H9.InvalidRequest)})()}getFeatureByObjectId(e,t){var n=this;return(0,_.Z)(function*(){const r=new te.Z;r.outFields=t,r.returnGeometry=!1,r.outSpatialReference=n.spatialReference,r.where=n.objectIdField+"="+e.toString(),n.datesInUnknownTimezone&&(r.timeReferenceUnknownClient=!0),n.featureSetQueryInterceptor&&n.featureSetQueryInterceptor.preLayerQueryCallback({layer:n._layer,query:r,method:"execute"});const a=yield(0,me.e)(n._layer.parsedUrl.path,r);return 1===a.features.length?a.features[0]:null})()}getIdentityUser(){var e=this;return(0,_.Z)(function*(){yield e.load();const t=B.id?.findCredential(e._layer.url);return t?t.userId:null})()}getOwningSystemUrl(){var e=this;return(0,_.Z)(function*(){yield e.load();const t=B.id?.findServerInfo(e._layer.url);if(t)return t.owningSystemUrl;let n=e._layer.url;const r=n.toLowerCase().indexOf("/rest/services");if(n=r>-1?n.substring(0,r):n,n){n+="/rest/info";try{const a=yield(0,V.default)(n,{query:{f:"json"}});let i="";return a.data&&a.data.owningSystemUrl&&(i=a.data.owningSystemUrl),i}catch{return""}}return""})()}getDataSourceFeatureSet(){const e=new ae({layer:this._layer,spatialReference:this.spatialReference??void 0,outFields:this._overrideFields??void 0,includeGeometry:!this._removeGeometry,lrucache:this.recentlyUsedQueries??void 0,interceptor:this.featureSetQueryInterceptor??void 0});return e._useDefinitionExpression=!1,e}get preferredTimeReference(){return void 0===this._cachedDateMetaData.preferredTimeReference&&(this._cachedDateMetaData.preferredTimeReference=this._layer?.preferredTimeReference?.toJSON()??null),this._cachedDateMetaData.preferredTimeReference}get dateFieldsTimeReference(){return void 0===this._cachedDateMetaData.dateFieldsTimeReference&&(this._cachedDateMetaData.dateFieldsTimeReference=this._layer?.dateFieldsTimeReference?.toJSON()??null),this._cachedDateMetaData.dateFieldsTimeReference}get datesInUnknownTimezone(){return this._layer.datesInUnknownTimezone}get editFieldsInfo(){return void 0===this._cachedDateMetaData.editFieldsInfo&&(this._cachedDateMetaData.editFieldsInfo=this._layer?.editFieldsInfo?.toJSON()??null),this._cachedDateMetaData.editFieldsInfo}get timeInfo(){return void 0===this._cachedDateMetaData.timeInfo&&(this._cachedDateMetaData.timeInfo=this._layer?.timeInfo?.toJSON()??null),this._cachedDateMetaData.timeInfo}}var Te=c(16776);class be extends y.Z{constructor(e){super(e),this.declaredClass="esri.arcade.featureset.sources.FeatureLayerRelated",this._findObjectId=-1,this._requestStandardised=!1,this._removeGeometry=!1,this._overrideFields=null,this.featureObjectId=null,e.spatialReference&&(this.spatialReference=e.spatialReference),this._transparent=!0,this._maxProcessing=1e3,this._layer=e.layer,this._wset=null,this._findObjectId=e.objectId,this.featureObjectId=e.objectId,this.relationship=e.relationship,this._relatedLayer=e.relatedLayer,void 0!==e.outFields&&(this._overrideFields=e.outFields),void 0!==e.includeGeometry&&(this._removeGeometry=!1===e.includeGeometry)}_maxQueryRate(){return f.tI}end(){return this._layer}optimisePagingFeatureQueries(){}loadImpl(){var e=this;return(0,_.Z)(function*(){return yield Promise.all([e._layer.load(),e._relatedLayer?.load()]),e._initialiseFeatureSet(),e})()}nativeCapabilities(){return this._relatedLayer.nativeCapabilities()}_initialiseFeatureSet(){if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this._relatedLayer.geometryType,this.fields=this._relatedLayer.fields.slice(0),null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{const t=[],n=[];for(const r of this.fields)if("oid"===r.type)t.push(r),n.push(r.name);else for(const a of this._overrideFields)if(a.toLowerCase()===r.name.toLowerCase()){t.push(r),n.push(r.name);break}this.fields=t,this._overrideFields=n}const e=this._layer.nativeCapabilities();e&&(this._databaseType=e.databaseType,this._requestStandardised=e.requestStandardised),this.objectIdField=this._relatedLayer.objectIdField,this.globalIdField=this._relatedLayer.globalIdField,this.hasM=this._relatedLayer.supportsM,this.hasZ=this._relatedLayer.supportsZ,this.typeIdField=this._relatedLayer.typeIdField,this.types=this._relatedLayer.types}databaseType(){var e=this;return(0,_.Z)(function*(){return yield e._relatedLayer.databaseType(),e._databaseType=e._relatedLayer._databaseType,e._databaseType})()}isTable(){return this._relatedLayer.isTable()}_isInFeatureSet(){return f.dj.InFeatureSet}_candidateIdTransform(e){return e}_getSet(e){var t=this;return(0,_.Z)(function*(){if(null===t._wset){yield t._ensureLoaded();const n=yield t._getFilteredSet("",null,null,null,e);return t._wset=n,n}return t._wset})()}_changeFeature(e){const t={};for(const n of this.fields)t[n.name]=e.attributes[n.name];return new D.Z({geometry:!0===this._removeGeometry?null:e.geometry,attributes:t})}_getFilteredSet(e,t,n,r,a){var i=this;return(0,_.Z)(function*(){if(yield i.databaseType(),i.isTable()&&t&&null!==e&&""!==e)return new R.Z([],[],!0,null);const l=i._layer.nativeCapabilities();if(!1===l.canQueryRelated)return new R.Z([],[],!0,null);if(l.capabilities?.queryRelated&&l.capabilities.queryRelated.supportsPagination)return i._getFilteredSetUsingPaging(e,t,n,r,a);let s="",h=!1;null!==r&&l.capabilities&&l.capabilities.queryRelated&&!0===l.capabilities.queryRelated.supportsOrderBy&&(s=r.constructClause(),h=!0);const p=new Fe.default;p.objectIds=[i._findObjectId];const E=null!==i._overrideFields?i._overrideFields:i._fieldsIncludingObjectId(i._relatedLayer.fields?i._relatedLayer.fields.map(Q=>Q.name):["*"]);p.outFields=E,p.relationshipId=i.relationship.id,p.where="1=1";let A=!0;!0===i._removeGeometry&&(A=!1),p.returnGeometry=A,i._requestStandardised&&(p.sqlFormat="standard"),p.outSpatialReference=i.spatialReference,p.orderByFields=""!==s?s.split(","):null;const k=yield l.source.queryRelatedFeatures(p);i._checkCancelled(a);const K=k[i._findObjectId]?k[i._findObjectId].features:[],H=[];for(let Q=0;Q<K.length;Q++)i._featureCache[K[Q].attributes[i._relatedLayer.objectIdField]]=K[Q],H.push(K[Q].attributes[i._relatedLayer.objectIdField]);const X=t&&null!==e&&""!==e,$=null!=n;return new R.Z(X||$?H:[],X||$?[]:H,h,null)})()}_fieldsIncludingObjectId(e){if(null===e)return[this.objectIdField];const t=e.slice(0);if(t.includes("*"))return t;let n=!1;for(const r of t)if(r.toUpperCase()===this.objectIdField.toUpperCase()){n=!0;break}return!1===n&&t.push(this.objectIdField),t}_getFilteredSetUsingPaging(e,t,n,r,a){var i=this;return(0,_.Z)(function*(){let l="",s=!1;const h=i._layer.nativeCapabilities();null!==r&&h&&h.capabilities?.queryRelated&&!0===h.capabilities.queryRelated.supportsOrderBy&&(l=r.constructClause(),s=!0),yield i.databaseType();let E=i._maxQueryRate();const A=h.capabilities?.query.maxRecordCount;null!=A&&A<E&&(E=A);const k=t&&null!==e&&""!==e,K=null!=n;let H=null,X=!0;!0===i._removeGeometry&&(X=!1);const $=null!==i._overrideFields?i._overrideFields:i._fieldsIncludingObjectId(i._relatedLayer.fields?i._relatedLayer.fields.map(Q=>Q.name):["*"]);return H=new R.Z(k||K?["GETPAGES"]:[],k||K?[]:["GETPAGES"],s,{outFields:$.join(","),resultRecordCount:E,resultOffset:0,objectIds:[i._findObjectId],where:"1=1",orderByFields:l,returnGeometry:X,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}}),yield i._expandPagedSet(H,E,0,0,a),H})()}_expandPagedSet(e,t,n,r,a){return this._expandPagedSetFeatureSet(e,t,n,r,a)}_clonePageDefinition(e){return null===e?null:!0!==e.groupbypage?{groupbypage:!1,outFields:e.outFields,resultRecordCount:e.resultRecordCount,resultOffset:e.resultOffset,where:e.where,objectIds:e.objectIds,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}:{groupbypage:!0,outFields:e.outFields,resultRecordCount:e.resultRecordCount,useOIDpagination:e.useOIDpagination,generatedOid:e.generatedOid,groupByFieldsForStatistics:e.groupByFieldsForStatistics,resultOffset:e.resultOffset,outStatistics:e.outStatistics,geometry:e.geometry,where:e.where,objectIds:e.objectIds,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}}_getPhysicalPage(e,t,n){var r=this;return(0,_.Z)(function*(){const a=e.pagesDefinition.internal.lastRetrieved,i=a,l=e.pagesDefinition.internal.lastPage,s=r._layer.nativeCapabilities(),h=new Fe.default;!0===r._requestStandardised&&(h.sqlFormat="standard"),h.relationshipId=r.relationship.id,h.objectIds=e.pagesDefinition.objectIds,h.resultOffset=e.pagesDefinition.internal.lastPage,h.resultRecordCount=e.pagesDefinition.resultRecordCount,h.outFields=e.pagesDefinition.outFields.split(","),h.where=e.pagesDefinition.where,h.orderByFields=""!==e.pagesDefinition.orderByFields?e.pagesDefinition.orderByFields.split(","):null,h.returnGeometry=e.pagesDefinition.returnGeometry,h.outSpatialReference=r.spatialReference;const p=yield s.source.queryRelatedFeatures(h);if(r._checkCancelled(n),e.pagesDefinition.internal.lastPage!==l)return 0;const E=p[r._findObjectId]?p[r._findObjectId].features:[];for(let k=0;k<E.length;k++)e.pagesDefinition.internal.set[i+k]=E[k].attributes[r._relatedLayer.objectIdField];for(let k=0;k<E.length;k++)r._featureCache[E[k].attributes[r._relatedLayer.objectIdField]]=E[k];return E.length!==e.pagesDefinition.resultRecordCount&&(!p[r._findObjectId]||!1===p[r._findObjectId].exceededTransferLimit)&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=a+E.length,e.pagesDefinition.internal.lastPage+=e.pagesDefinition.resultRecordCount,E.length})()}_getFeatures(e,t,n,r){var a=this;return(0,_.Z)(function*(){const i=[];-1!==t&&void 0===a._featureCache[t]&&i.push(t);const l=a._maxQueryRate();if(!0===a._checkIfNeedToExpandKnownPage(e,l))return yield a._expandPagedSet(e,l,0,0,r),a._getFeatures(e,t,n,r);let s=0;for(let h=e._lastFetchedIndex;h<e._known.length&&(s++,s<=n&&(e._lastFetchedIndex+=1),!("GETPAGES"!==e._known[h]&&void 0===a._featureCache[e._known[h]]&&(e._known[h]!==t&&i.push(e._known[h]),i.length>n)))&&!(s>=n&&0===i.length);h++);if(0===i.length)return"success";throw new o.EN(o.H9.MissingFeatures)})()}_refineSetBlock(e,t,n){return(0,_.Z)(function*(){return e})()}_stat(e,t,n,r,a,i,l){return(0,_.Z)(function*(){return{calculated:!1}})()}get gdbVersion(){return this._relatedLayer.gdbVersion}_canDoAggregates(e,t,n,r,a){return(0,_.Z)(function*(){return!1})()}relationshipMetaData(){return this._relatedLayer.relationshipMetaData()}serviceUrl(){return this._relatedLayer.serviceUrl()}queryAttachments(e,t,n,r,a){return this._relatedLayer.queryAttachments(e,t,n,r,a)}getFeatureByObjectId(e,t){return this._relatedLayer.getFeatureByObjectId(e,t)}getOwningSystemUrl(){return this._relatedLayer.getOwningSystemUrl()}getIdentityUser(){return this._relatedLayer.getIdentityUser()}getDataSourceFeatureSet(){return this._relatedLayer}get preferredTimeReference(){return this._relatedLayer?.preferredTimeReference??null}get dateFieldsTimeReference(){return this._relatedLayer?.dateFieldsTimeReference??null}get datesInUnknownTimezone(){return this._relatedLayer?.datesInUnknownTimezone}get editFieldsInfo(){return this._relatedLayer?.editFieldsInfo??null}get timeInfo(){return this._relatedLayer?.timeInfo??null}}var J=c(53791),Oe=c(55463);function Pe(){null===J.Z.applicationCache&&(J.Z.applicationCache=new J.Z)}function le(b,e){return oe.apply(this,arguments)}function oe(){return(oe=(0,_.Z)(function*(b,e){if(J.Z.applicationCache){const t=J.Z.applicationCache.getLayerInfo(b);if(t){const a=yield t;return new T.default({url:b,outFields:e,sourceJSON:a})}const n=new T.default({url:b,outFields:e}),r=(0,_.Z)(function*(){return yield n.load(),n.sourceJSON})();if(J.Z.applicationCache){J.Z.applicationCache.setLayerInfo(b,r);try{return yield r,n}catch(a){throw J.Z.applicationCache.clearLayerInfo(b),a}}return yield r,n}return new T.default({url:b,outFields:e})})).apply(this,arguments)}function ue(b,e,t,n,r){return de.apply(this,arguments)}function de(){return(de=(0,_.Z)(function*(b,e,t,n,r,a=null){return ne(yield le(b,["*"]),e,t,n,r,a)})).apply(this,arguments)}function ne(b,e=null,t=null,n=!0,r=null,a=null){const i={layer:b,spatialReference:e,outFields:t,includeGeometry:n,lrucache:r,interceptor:a};return!0===b._hasMemorySource()?new Te.Z(i):new ae(i)}function ce(){return(ce=(0,_.Z)(function*(b){if(null!==J.Z.applicationCache){const t=J.Z.applicationCache.getLayerInfo(b);if(null!==t)return t}const e=(0,_.Z)(function*(){const t=yield(0,V.default)(b,{responseType:"json",query:{f:"json"}});return t.data?t.data:null})();if(null!==J.Z.applicationCache){J.Z.applicationCache.setLayerInfo(b,e);try{return yield e}catch(t){throw J.Z.applicationCache.clearLayerInfo(b),t}}return e})).apply(this,arguments)}function he(){return(he=(0,_.Z)(function*(b,e){const t="QUERYDATAELEMTS:"+e.toString()+":"+b;if(null!==J.Z.applicationCache){const r=J.Z.applicationCache.getLayerInfo(t);if(null!==r)return r}const n=(0,_.Z)(function*(){const r=yield(0,V.default)(b+"/queryDataElements",{method:"post",responseType:"json",query:{layers:JSON.stringify([e.toString()]),f:"json"}});if(r.data){const a=r.data;if(a.layerDataElements&&a.layerDataElements[0])return a.layerDataElements[0]}throw new o.EN(o.H9.DataElementsNotFound)})();if(null!==J.Z.applicationCache){J.Z.applicationCache.setLayerInfo(t,n);try{return yield n}catch(r){throw J.Z.applicationCache.clearLayerInfo(t),r}}return n})).apply(this,arguments)}function Ie(b){return fe.apply(this,arguments)}function fe(){return(fe=(0,_.Z)(function*(b){if(null!==J.Z.applicationCache){const t=J.Z.applicationCache.getLayerInfo(b);if(null!==t)return t}const e=(0,_.Z)(function*(){const t=yield(0,V.default)(b,{responseType:"json",query:{f:"json"}});if(t.data){const n=t.data;return n.layers||(n.layers=[]),n.tables||(n.tables=[]),n}return{layers:[],tables:[]}})();if(null!==J.Z.applicationCache){J.Z.applicationCache.setLayerInfo(b,e);try{return yield e}catch(t){throw J.Z.applicationCache.clearLayerInfo(b),t}}return e})).apply(this,arguments)}function Le(b,e){return _e.apply(this,arguments)}function _e(){return _e=(0,_.Z)(function*(b,e){const t={metadata:null,networkId:-1,unVersion:3,terminals:[],queryelem:null,layerNameLkp:{},lkp:null},n=yield Ie(b);if(t.metadata=n,n.controllerDatasetLayers&&null!=n.controllerDatasetLayers.utilityNetworkLayerId){if(n.layers)for(const i of n.layers)t.layerNameLkp[i.id]=i.name;if(n.tables)for(const i of n.tables)t.layerNameLkp[i.id]=i.name;const r=n.controllerDatasetLayers.utilityNetworkLayerId;t.networkId=r;const a=yield function Ne(b,e){return he.apply(this,arguments)}(b,r);if(a){t.queryelem=a,t.queryelem&&t.queryelem.dataElement&&void 0!==t.queryelem.dataElement.schemaGeneration&&(t.unVersion=t.queryelem.dataElement.schemaGeneration),t.lkp={},t.queryelem.dataElement.domainNetworks||(t.queryelem.dataElement.domainNetworks=[]);for(const l of t.queryelem.dataElement.domainNetworks){for(const s of l.edgeSources?l.edgeSources:[]){const h={layerId:s.layerId,sourceId:s.sourceId,className:t.layerNameLkp[s.layerId]?t.layerNameLkp[s.layerId]:null};h.className&&(t.lkp[h.className]=h)}for(const s of l.junctionSources?l.junctionSources:[]){const h={layerId:s.layerId,sourceId:s.sourceId,className:t.layerNameLkp[s.layerId]?t.layerNameLkp[s.layerId]:null};h.className&&(t.lkp[h.className]=h)}}if(t.queryelem.dataElement.terminalConfigurations)for(const l of t.queryelem.dataElement.terminalConfigurations)for(const s of l.terminals)t.terminals.push({terminalId:s.terminalId,terminalName:s.terminalName});const i=yield function xe(b){return ce.apply(this,arguments)}(b+"/"+r);if(i.systemLayers&&null!=i.systemLayers.associationsTableId){const l=[];t.unVersion>=4&&(l.push("STATUS"),l.push("PERCENTALONG"));let s=yield ue(b+"/"+i.systemLayers.associationsTableId.toString(),e,["OBJECTID","FROMNETWORKSOURCEID","TONETWORKSOURCEID","FROMGLOBALID","TOGLOBALID","TOTERMINALID","FROMTERMINALID","ASSOCIATIONTYPE","ISCONTENTVISIBLE","GLOBALID",...l],!1,null,null);return yield s.load(),t.unVersion>=4&&(s=s.filter(C.WhereClause.create("STATUS NOT IN (1, 2, 3, 4, 5, 6, 7, 9, 10, 11, 12, 13, 14, 15, 17, 18, 19, 20, 21, 22, 23, 25, 26, 27, 28, 29, 30, 31, 33, 34, 35, 36, 37, 38, 39, 41, 42, 43, 44, 45, 46, 47, 49, 50, 51, 52, 53, 54, 55, 57, 58, 59, 60, 61, 62,63)",s.getFieldsIndex())),yield s.load()),{lkp:t.lkp,associations:s,unVersion:t.unVersion,terminals:t.terminals}}return{associations:null,unVersion:t.unVersion,lkp:null,terminals:[]}}return{associations:null,unVersion:t.unVersion,lkp:null,terminals:[]}}return{associations:null,unVersion:t.unVersion,lkp:null,terminals:[]}}),_e.apply(this,arguments)}function Ze(b,e,t){return pe.apply(this,arguments)}function pe(){return(pe=(0,_.Z)(function*(b,e,t,n=null,r=null,a=!0,i=null,l=null){let s=b.serviceUrl();if(!s)return null;s="/"===s.charAt(s.length-1)?s+e.relatedTableId.toString():s+"/"+e.relatedTableId.toString();const h=yield ue(s,n,r,a,i,l);return new be({layer:b,relatedLayer:h,relationship:e,objectId:t,spatialReference:n,outFields:r,includeGeometry:a,lrucache:i,interceptor:l})})).apply(this,arguments)}N.Z.registerAction(),S.registerAction(),w.Z.registerAction(),v.Z.registerAction(),z.Z.registerAction();class Ae extends q.Z{constructor(e,t=null,n=null,r=null){super(),this._map=e,this._overridespref=t,this._lrucache=n,this._interceptor=r,this._instantLayers=[]}_makeAndAddFeatureSet(e,t=!0,n=null){const r=ne(e,this._overridespref,null===n?["*"]:n,t,this._lrucache,this._interceptor);return this._instantLayers.push({featureset:r,opitem:e,includeGeometry:t,outFields:JSON.stringify(n)}),r}featureSetByName(e,t=!0,n=null){var r=this;return(0,_.Z)(function*(){if(void 0!==r._map.loaded&&void 0!==r._map.load&&!1===r._map.loaded)return yield r._map.load(),r.featureSetByName(e,t,n);null===n&&(n=["*"]),n=(n=n.slice(0)).sort();const a=JSON.stringify(n);for(let l=0;l<r._instantLayers.length;l++){const s=r._instantLayers[l];if(s.opitem.title===e&&s.includeGeometry===t&&s.outFields===a)return r._instantLayers[l].featureset}const i=r._map.allLayers.find(l=>l instanceof T.default&&l.title===e);if(i)return r._makeAndAddFeatureSet(i,t,n);if(r._map.tables){const l=r._map.tables.find(s=>!!(s.title&&s.title===e||s.title&&s.title===e));if(l){if(l instanceof T.default)return r._makeAndAddFeatureSet(l,t,n);if(!l._materializedTable){const s=l.outFields?l:{...l,outFields:["*"]};l._materializedTable=new T.default(s)}return yield l._materializedTable.load(),r._makeAndAddFeatureSet(l._materializedTable,t,n)}}return null})()}featureSetById(e,t=!0,n=["*"]){var r=this;return(0,_.Z)(function*(){if(void 0!==r._map.loaded&&void 0!==r._map.load&&!1===r._map.loaded)return yield r._map.load(),r.featureSetById(e,t,n);null===n&&(n=["*"]),n=(n=n.slice(0)).sort();const a=JSON.stringify(n);for(let l=0;l<r._instantLayers.length;l++){const s=r._instantLayers[l];if(s.opitem.id===e&&s.includeGeometry===t&&s.outFields===a)return r._instantLayers[l].featureset}const i=r._map.allLayers.find(l=>l instanceof T.default&&l.id===e);if(i)return r._makeAndAddFeatureSet(i,t,n);if(r._map.tables){const l=r._map.tables.find(s=>s.id===e);if(l){if(l instanceof T.default)return r._makeAndAddFeatureSet(l,t,n);if(!l._materializedTable){const s={...l,outFields:["*"]};l._materializedTable=new T.default(s)}return yield l._materializedTable.load(),r._makeAndAddFeatureSet(l._materializedTable,t,n)}}return null})()}}class ye extends q.Z{constructor(e,t=null,n=null,r=null){super(),this._url=e,this._overridespref=t,this._lrucache=n,this._interceptor=r,this.metadata=null,this._instantLayers=[]}get url(){return this._url}_makeAndAddFeatureSet(e,t=!0,n=null){const r=ne(e,this._overridespref,null===n?["*"]:n,t,this._lrucache);return this._instantLayers.push({featureset:r,opitem:e,includeGeometry:t,outFields:JSON.stringify(n)}),r}_loadMetaData(){var e=this;return(0,_.Z)(function*(){const t=yield Ie(e._url);return e.metadata=t,t})()}load(){return this._loadMetaData()}clone(){return new ye(this._url,this._overridespref,this._lrucache,this._interceptor)}featureSetByName(e,t=!0,n=null){var r=this;return(0,_.Z)(function*(){null===n&&(n=["*"]),n=(n=n.slice(0)).sort();const a=JSON.stringify(n);for(let s=0;s<r._instantLayers.length;s++){const h=r._instantLayers[s];if(h.opitem.title===e&&h.includeGeometry===t&&h.outFields===a)return r._instantLayers[s].featureset}const i=yield r._loadMetaData();let l=null;for(const s of i.layers?i.layers:[])s.name===e&&(l=s);if(!l)for(const s of i.tables?i.tables:[])s.name===e&&(l=s);if(l){const s=yield le(r._url+"/"+l.id,["*"]);return r._makeAndAddFeatureSet(s,t,n)}return null})()}featureSetById(e,t=!0,n=["*"]){var r=this;return(0,_.Z)(function*(){null===n&&(n=["*"]),n=(n=n.slice(0)).sort();const a=JSON.stringify(n);e=null!=e?e.toString():"";for(let s=0;s<r._instantLayers.length;s++){const h=r._instantLayers[s];if(h.opitem.id===e&&h.includeGeometry===t&&h.outFields===a)return r._instantLayers[s].featureset}const i=yield r._loadMetaData();let l=null;for(const s of i.layers?i.layers:[])null!=s.id&&s.id.toString()===e&&(l=s);if(!l)for(const s of i.tables?i.tables:[])null!=s.id&&s.id.toString()===e&&(l=s);if(l){const s=yield le(r._url+"/"+l.id,["*"]);return r._makeAndAddFeatureSet(s,t,n)}return null})()}}function je(b,e,t=null,n=null){return new Ae(b,e,t,n)}function Ue(b,e,t=null,n=null){return new ye(b,e,t,n)}function ke(b,e,t,n,r){if(null===b)return null;if(b instanceof T.default){switch(e){case"datasource":return ne(b,r,b.outFields,!0,t,n).getDataSourceFeatureSet();case"parent":case"root":return ne(b,r,b.outFields,!0,t,n)}return null}if(b instanceof y.Z)switch(e){case"datasource":return b.getDataSourceFeatureSet();case"parent":return b;case"root":return b.getRootFeatureSet()}return null}function Be(b,e,t,n,r,a,i){return ge.apply(this,arguments)}function ge(){return(ge=(0,_.Z)(function*(b,e,t,n,r,a,i,l=null){if(J.Z.applicationCache){const h=J.Z.applicationCache.getLayerInfo(b+":"+a.url);if(h){const p=yield h;return ne(new T.default({url:(0,f.US)(p.url)+"/"+e,outFields:["*"]}),t,n,r,i,l)}}const s=new Oe.default({id:b,portal:a}).load();J.Z.applicationCache&&J.Z.applicationCache.setLayerInfo(b+":"+a.url,s);try{const h=yield s;return ne(new T.default({url:(0,f.US)(h.url??"")+"/"+e,outFields:["*"]}),t,n,r,i,l)}catch(h){throw J.Z.applicationCache&&J.Z.applicationCache.clearLayerInfo(b+":"+a.url),h}})).apply(this,arguments)}},52724:(ee,Y,c)=>{c.d(Y,{$X:()=>P,QP:()=>o,TO:()=>C,Xx:()=>x,yN:()=>O});var _=c(15861),V=c(88879),q=c(91365),N=c(27187),D=c(47982),U=c(49086),j=c(91510),w=c(77132),y=c(83947),R=c(62208),L=c(10410),f=c(65234);class d{constructor(g){this.field=g,this.sqlRewritable=!1}postInitialization(g,u){}}class P extends d{constructor(g){super(g),this.sqlRewritable=!0}extractValue(g){return g.attributes[this.field.name]}rewriteSql(g){return{rewritten:this.sqlRewritable,where:g}}}class o extends d{constructor(g,u,m){super((0,w.JW)(g)),this.originalField=g,this.sqlRewritable=!0,this.field.name=u,this.field.alias=m}rewriteSql(g,u){return{rewritten:this.sqlRewritable,where:(0,y.bB)(g,this.field.name,this.originalField.name,u.getFieldsIndex())}}extractValue(g){return g.attributes[this.originalField.name]}}let C=(()=>{class I extends d{constructor(u,m,F){super(u),this.codefield=m,this.lkp=F,this.reverseLkp={};for(const S in F)this.reverseLkp[F[S]]=S;this.sqlRewritable=!0}rewriteSql(u,m){const F=this.evaluateNodeToWhereClause(u.parseTree,w.Bj.Standardised,this.field.name,this.codefield instanceof L.WhereClause?(0,y.zR)(this.codefield,w.Bj.Standardised):this.codefield,u.parameters);return F.includes(I.BADNESS)?{rewritten:!1,where:u}:{rewritten:this.sqlRewritable,where:L.WhereClause.create(F,(0,R.s3)(m._parent).getFieldsIndex())}}evaluateNodeToWhereClause(u,m,F=null,S=null,v){let z,Z,B,W;switch(u.type){case"interval":return(0,y.TE)(this.evaluateNodeToWhereClause(u.value,m,F,S,v),u.qualifier,u.op);case"case-expression":{let T=" CASE ";"simple"===u.format&&(T+=this.evaluateNodeToWhereClause(u.operand,m,F,I.BADNESS,v));for(let M=0;M<u.clauses.length;M++)T+=" WHEN "+this.evaluateNodeToWhereClause(u.clauses[M].operand,m,F,I.BADNESS,v)+" THEN "+this.evaluateNodeToWhereClause(u.clauses[M].value,m,F,I.BADNESS,v);return null!==u.else&&(T+=" ELSE "+this.evaluateNodeToWhereClause(u.else,m,F,I.BADNESS,v)),T+=" END ",T}case"parameter":{const T=v[u.value.toLowerCase()];if("string"==typeof T)return"'"+T.toString().replace(/'/g,"''")+"'";if(T instanceof Date)return(0,y.oX)(T,m,null);if(T instanceof q.iG)return(0,y.mA)(T,m,null);if(T instanceof Array){const M=[];for(let G=0;G<T.length;G++)"string"==typeof T[G]?M.push("'"+T[G].toString().replace(/'/g,"''")+"'"):T[G]instanceof Date?M.push((0,y.oX)(T[G],m,null)):M.push(T[G]instanceof q.iG?(0,y.mA)(T[G],m,null):T[G].toString());return M}return T.toString()}case"expression-list":Z=[];for(const T of u.value)Z.push(this.evaluateNodeToWhereClause(T,m,F,S,v));return Z;case"unary-expression":return" ( NOT "+this.evaluateNodeToWhereClause(u.expr,m,F,I.BADNESS,v)+" ) ";case"binary-expression":switch(u.operator){case"AND":return" ("+this.evaluateNodeToWhereClause(u.left,m,F,S,v)+" AND "+this.evaluateNodeToWhereClause(u.right,m,F,S,v)+") ";case"OR":return" ("+this.evaluateNodeToWhereClause(u.left,m,F,S,v)+" OR "+this.evaluateNodeToWhereClause(u.right,m,F,S,v)+") ";case"IS":if("null"!==u.right.type)throw new D.eS(D.f.UnsupportedIsRhs);return" ("+this.evaluateNodeToWhereClause(u.left,m,F,S,v)+" IS NULL )";case"ISNOT":if("null"!==u.right.type)throw new D.eS(D.f.UnsupportedIsRhs);return" ("+this.evaluateNodeToWhereClause(u.left,m,F,S,v)+" IS NOT NULL )";case"IN":if(z=[],"expression-list"===u.right.type){if("column-reference"===u.left.type&&u.left.column.toUpperCase()===this.field.name.toUpperCase()){const T=[];let M=!0;for(const G of u.right.value){if("string"!==G.type){M=!1;break}if(void 0===this.lkp[G.value]){M=!1;break}T.push(this.lkp[G.value].toString())}if(M)return" ("+this.evaluateNodeToWhereClause(u.left,m,F,S,v)+" IN ("+T.join(",")+")) "}return z=this.evaluateNodeToWhereClause(u.right,m,F,S,v)," ("+this.evaluateNodeToWhereClause(u.left,m,F,S,v)+" IN ("+z.join(",")+")) "}return W=this.evaluateNodeToWhereClause(u.right,m,F,S,v),W instanceof Array?" ("+this.evaluateNodeToWhereClause(u.left,m,F,S,v)+" IN ("+W.join(",")+")) ":" ("+this.evaluateNodeToWhereClause(u.left,m,F,S,v)+" IN ("+W+")) ";case"NOT IN":if(z=[],"expression-list"===u.right.type){if("column-reference"===u.left.type&&u.left.column.toUpperCase()===this.field.name.toUpperCase()){const T=[];let M=!0;for(const G of u.right.value){if("string"!==G.type){M=!1;break}if(void 0===this.lkp[G.value]){M=!1;break}T.push(this.lkp[G.value].toString())}if(M)return" ("+this.evaluateNodeToWhereClause(u.left,m,F,S,v)+" NOT IN ("+T.join(",")+")) "}return z=this.evaluateNodeToWhereClause(u.right,m,F,S,v)," ("+this.evaluateNodeToWhereClause(u.left,m,F,S,v)+" NOT IN ("+z.join(",")+")) "}return W=this.evaluateNodeToWhereClause(u.right,m,F,S,v),W instanceof Array?" ("+this.evaluateNodeToWhereClause(u.left,m,F,S,v)+" NOT IN ("+W.join(",")+")) ":" ("+this.evaluateNodeToWhereClause(u.left,m,F,S,v)+" NOT IN ("+W+")) ";case"BETWEEN":return B=this.evaluateNodeToWhereClause(u.right,m,F,I.BADNESS,v)," ("+this.evaluateNodeToWhereClause(u.left,m,F,I.BADNESS,v)+" BETWEEN "+B[0]+" AND "+B[1]+" ) ";case"NOTBETWEEN":return B=this.evaluateNodeToWhereClause(u.right,m,F,I.BADNESS,v)," ("+this.evaluateNodeToWhereClause(u.left,m,F,I.BADNESS,v)+" NOT BETWEEN "+B[0]+" AND "+B[1]+" ) ";case"LIKE":return""!==u.escape?" ("+this.evaluateNodeToWhereClause(u.left,m,F,I.BADNESS,v)+" LIKE "+this.evaluateNodeToWhereClause(u.right,m,F,I.BADNESS,v)+" ESCAPE '"+u.escape+"') ":" ("+this.evaluateNodeToWhereClause(u.left,m,F,I.BADNESS,v)+" LIKE "+this.evaluateNodeToWhereClause(u.right,m,F,I.BADNESS,v)+") ";case"NOT LIKE":return""!==u.escape?" ("+this.evaluateNodeToWhereClause(u.left,m,F,I.BADNESS,v)+" NOT LIKE "+this.evaluateNodeToWhereClause(u.right,m,F,I.BADNESS,v)+" ESCAPE '"+u.escape+"') ":" ("+this.evaluateNodeToWhereClause(u.left,m,F,I.BADNESS,v)+" NOT LIKE "+this.evaluateNodeToWhereClause(u.right,m,F,I.BADNESS,v)+") ";case"<>":case"=":if("column-reference"===u.left.type&&"string"===u.right.type){if(u.left.column.toUpperCase()===this.field.name.toUpperCase()&&void 0!==this.lkp[u.right.value.toString()])return" ("+S+" "+u.operator+" "+this.lkp[u.right.value.toString()].toString()+") "}else if("column-reference"===u.right.type&&"string"===u.left.type&&u.right.column.toUpperCase()===this.field.name.toUpperCase())return" ("+this.lkp[u.right.value.toString()].toString()+" "+u.operator+" "+S+") ";return" ("+this.evaluateNodeToWhereClause(u.left,m,F,I.BADNESS,v)+" "+u.operator+" "+this.evaluateNodeToWhereClause(u.right,m,F,I.BADNESS,v)+") ";case"<":case">":case">=":case"<=":case"*":case"-":case"+":case"/":case"||":return" ("+this.evaluateNodeToWhereClause(u.left,m,F,I.BADNESS,v)+" "+u.operator+" "+this.evaluateNodeToWhereClause(u.right,m,F,I.BADNESS,v)+") "}case"null":return"null";case"boolean":return!0===u.value?"1":"0";case"string":return"'"+u.value.toString().replace(/'/g,"''")+"'";case"timestamp":case"date":return(0,y.oX)(u.value,m,null);case"number":return u.value.toString();case"current-time":return(0,y.vR)("date"===u.mode,m);case"column-reference":return F&&F.toLowerCase()===u.column.toLowerCase()?"("+S+")":u.column;case"data-type":return u.value;case"function":{const T=this.evaluateNodeToWhereClause(u.args,m,F,I.BADNESS,v);return(0,y.fz)(u.name,T,m)}}throw new D.eS(D.f.UnsupportedSyntax,{node:u.type})}extractValue(u){return this.codefield instanceof L.WhereClause?this.reverseLkp[this.codefield.calculateValueCompiled(u)]:this.reverseLkp[u.attributes[this.codefield]]}}return I.BADNESS="_!!!_BAD_LKP_!!!!",I})();class O extends d{constructor(g,u){super(g),this._sql=u}rewriteSql(g,u){return{rewritten:!0,where:(0,y.bB)(g,this.field.name,(0,y.zR)(this._sql,w.Bj.Standardised),u.getFieldsIndex())}}extractValue(g){return this._sql.calculateValueCompiled(g)}}class x extends U.Z{static findField(g,u){for(const m of g)if(m.name.toLowerCase()===u.toString().toLowerCase())return m;return null}constructor(g){super(g),this._calcFunc=null,this.declaredClass="esri.arcade.featureset.actions.Adapted",this.adaptedFields=[],this._extraFilter=null,this._extraFilter=g.extraFilter,this._parent=g.parentfeatureset,this._maxProcessing=30,this.adaptedFields=g.adaptedFields}_initialiseFeatureSet(){null!==this._parent?(this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types):(this.spatialReference=new f.Z({wkid:4326}),this.objectIdField="",this.globalIdField="",this.geometryType=w.Qk.point,this.typeIdField="",this.types=null),this.fields=[];for(const g of this.adaptedFields)g.postInitialization(this,this._parent),this.fields.push(g.field)}_getSet(g){var u=this;return(0,_.Z)(function*(){if(null===u._wset){yield u._ensureLoaded();let m=null;return m=u._extraFilter?yield u._getFilteredSet("",null,null,null,g):yield u._parent?._getSet(g),u._checkCancelled(g),(0,R.O3)(m),u._wset=new j.Z(m._candidates.slice(0),m._known.slice(0),m._ordered,u._clonePageDefinition(m.pagesDefinition)),u._wset}return u._wset})()}_isInFeatureSet(g){return(0,R.s3)(this._parent)._isInFeatureSet(g)}_getFeatures(g,u,m,F){var S=this;return(0,_.Z)(function*(){const v=[];-1!==u&&void 0===S._featureCache[u]&&v.push(u);const z=S._maxQueryRate();if(!0===S._checkIfNeedToExpandKnownPage(g,z))return yield S._expandPagedSet(g,z,0,0,F),S._getFeatures(g,u,m,F);let Z=0;for(let T=g._lastFetchedIndex;T<g._known.length&&(Z++,Z<=m&&(g._lastFetchedIndex+=1),!(void 0===S._featureCache[g._known[T]]&&(g._known[T]!==u&&v.push(g._known[T]),v.length>=z)));T++);if(0===v.length)return"success";g=new j.Z([],v,g._ordered,null);const B=Math.min(v.length,m);yield S._parent?._getFeatures(g,-1,B,F),S._checkCancelled(F);const W=[];for(let T=0;T<B;T++){const M=S._parent?._featureFromCache(v[T]);void 0!==M&&W.push({geometry:M.geometry,attributes:M.attributes,id:v[T]})}for(const T of W){const M=[];for(const G of S.adaptedFields)M[G.field.name]=G.extractValue(T);S._featureCache[T.id]=new V.Z({attributes:M,geometry:(0,N.r1)(T.geometry)})}return"success"})()}_fetchAndRefineFeatures(){return(0,_.Z)(function*(){throw new D.EN(D.H9.NeverReach)})()}_getFilteredSet(g,u,m,F,S){var v=this;return(0,_.Z)(function*(){let z=!1;const Z=v._reformulateWithoutAdaptions(m);z=Z.cannot,m=Z.where;let B=!1;if(null!==F){B=!0;const M=[];for(const G of v.adaptedFields)if(!(G instanceof P)&&!0===F.scanForField(G.field.name)){if(!(G instanceof o)){F=null,B=!1;break}M.push({field:G.field.name,newfield:G.originalField.name})}F&&M.length>0&&(F=F.replaceFields(M))}null!==m?null!==v._extraFilter&&(m=(0,y.$e)(v._extraFilter,m)):m=v._extraFilter,yield v._ensureLoaded();const W=yield(0,R.s3)(v._parent)._getFilteredSet(g,u,m,F,S);let T;return v._checkCancelled(S),T=!0===z?new j.Z(W._candidates.slice(0).concat(W._known.slice(0)),[],!0===B&&W._ordered,v._clonePageDefinition(W.pagesDefinition)):new j.Z(W._candidates.slice(0),W._known.slice(0),!0===B&&W._ordered,v._clonePageDefinition(W.pagesDefinition)),T})()}_reformulateWithoutAdaptions(g){const u={cannot:!1,where:g};if(null!==g)for(const m of this.adaptedFields)if(!0===(0,y.hq)(g,m.field.name)){const F=m.rewriteSql(g,this);if(!0!==F.rewritten){u.cannot=!0,u.where=null;break}u.where=F.where}return u}_stat(g,u,m,F,S,v,z){var Z=this;return(0,_.Z)(function*(){let B=!1,W=Z._reformulateWithoutAdaptions(u);if(B=W.cannot,u=W.where,W=Z._reformulateWithoutAdaptions(S),B=B||W.cannot,null!==(S=W.where)?null!==Z._extraFilter&&(S=(0,y.$e)(Z._extraFilter,S)):S=Z._extraFilter,!0===B)return null===S&&""===m&&null===F?Z._manualStat(g,u,v,z):{calculated:!1};const T=yield(0,R.s3)(Z._parent)._stat(g,u,m,F,S,v,z);return!1===T.calculated?null===S&&""===m&&null===F?Z._manualStat(g,u,v,z):{calculated:!1}:T})()}_canDoAggregates(g,u,m,F,S){var v=this;return(0,_.Z)(function*(){if(null===v._parent)return!1;for(let B=0;B<g.length;B++)for(const W of v.adaptedFields)if(g[B].toLowerCase()===W.field.name.toLowerCase()&&!(W instanceof P))return!1;const z=[];for(let B=0;B<u.length;B++){const W=u[B];if(null!==W.workingexpr){const T=v._reformulateWithoutAdaptions(W.workingexpr);if(T.cannot)return!1;const M=W.clone();M.workingexpr=T.where,z.push(M)}else z.push(W)}const Z=v._reformulateWithoutAdaptions(S);return!Z.cannot&&(null!==(S=Z.where)?null!==v._extraFilter&&(S=(0,y.$e)(v._extraFilter,S)):S=v._extraFilter,v._parent._canDoAggregates(g,z,m,F,S))})()}_getAggregatePagesDataSourceDefinition(g,u,m,F,S,v,z){var Z=this;return(0,_.Z)(function*(){if(null===Z._parent)throw new D.EN(D.H9.NeverReach);const B=[];for(let T=0;T<u.length;T++){const M=u[T];if(null!==M.workingexpr){const G=Z._reformulateWithoutAdaptions(M.workingexpr);if(G.cannot)throw new D.EN(D.H9.NeverReach);const se=M.clone();se.workingexpr=G.where,B.push(se)}else B.push(M)}const W=Z._reformulateWithoutAdaptions(S);if(W.cannot)throw new D.EN(D.H9.NeverReach);return null!==(S=W.where)?null!==Z._extraFilter&&(S=(0,y.$e)(Z._extraFilter,S)):S=Z._extraFilter,Z._parent._getAggregatePagesDataSourceDefinition(g,B,m,F,S,v,z)})()}}},53997:(ee,Y,c)=>{c.d(Y,{Z:()=>R});var _=c(15861),V=c(47982),q=c(49086),N=c(91510),D=c(77132),U=c(83947),j=c(10699),w=c(10410),y=c(65234);class R extends q.Z{constructor(f){super(f),this.declaredClass="esri.arcade.featureset.actions.AttributeFilter",this._maxProcessing=1e3,this._parent=f.parentfeatureset,f.whereclause instanceof w.WhereClause?(this._whereclause=f.whereclause,this._whereClauseFunction=null):(this._whereClauseFunction=f.whereclause,this._whereclause=null)}_initialiseFeatureSet(){null!==this._parent?(this.fields=this._parent.fields.slice(0),this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types):(this.fields=[],this.typeIdField="",this.objectIdField="",this.globalIdField="",this.spatialReference=new y.Z({wkid:4326}),this.geometryType=D.Qk.point)}_getSet(f){var d=this;return(0,_.Z)(function*(){if(null===d._wset){yield d._ensureLoaded();const P=yield d._parent._getFilteredSet("",null,d._whereclause,null,f);return d._checkCancelled(f),d._wset=null!==d._whereClauseFunction?new N.Z(P._candidates.slice(0).concat(P._known.slice(0)),[],P._ordered,d._clonePageDefinition(P.pagesDefinition)):new N.Z(P._candidates.slice(0),P._known.slice(0),P._ordered,d._clonePageDefinition(P.pagesDefinition)),d._wset}return d._wset})()}_isInFeatureSet(f){let d=this._parent?._isInFeatureSet(f);return d===D.dj.NotInFeatureSet?d:(d=this._idstates[f],void 0===d?D.dj.Unknown:d)}_getFeature(f,d,P){return this._parent._getFeature(f,d,P)}_getFeatures(f,d,P,o){return this._parent._getFeatures(f,d,P,o)}_featureFromCache(f){return this._parent._featureFromCache(f)}executeWhereClause(f){return this._whereclause?.testFeature(f)??!1}executeWhereClauseDeferred(f){var d=this;return(0,_.Z)(function*(){if(null!==d._whereClauseFunction){const P=d._whereClauseFunction(f);return(0,j.y8)(P),P}return d.executeWhereClause(f)})()}_fetchAndRefineFeatures(f,d,P){var o=this;return(0,_.Z)(function*(){const C=new N.Z([],f,!1,null),O=Math.min(d,f.length);if(yield o._parent?._getFeatures(C,-1,O,P),o._checkCancelled(P),null==o._whereClauseFunction){for(let I=0;I<O;I++){const g=o._parent?._featureFromCache(f[I]);o._idstates[f[I]]=!0===o.executeWhereClause(g)?D.dj.InFeatureSet:D.dj.NotInFeatureSet}return"success"}const x=[];for(let I=0;I<O;I++){const g=o._parent?._featureFromCache(f[I]);x.push(yield o.executeWhereClauseDeferred(g))}for(let I=0;I<d;I++)o._idstates[f[I]]=!0===x[I]?D.dj.InFeatureSet:D.dj.NotInFeatureSet;return"success"})()}_getFilteredSet(f,d,P,o,C){var O=this;return(0,_.Z)(function*(){null!==O._whereClauseFunction||(null!==P?null!==O._whereclause&&(P=(0,U.$e)(O._whereclause,P)):P=O._whereclause),yield O._ensureLoaded();const x=yield O._parent._getFilteredSet(f,d,P,o,C);let I;return O._checkCancelled(C),I=null!==O._whereClauseFunction?new N.Z(x._candidates.slice(0).concat(x._known.slice(0)),[],x._ordered,O._clonePageDefinition(x.pagesDefinition)):new N.Z(x._candidates.slice(0),x._known.slice(0),x._ordered,O._clonePageDefinition(x.pagesDefinition)),I})()}_stat(f,d,P,o,C,O,x){var I=this;return(0,_.Z)(function*(){if(null!==I._whereClauseFunction)return null===C&&""===P&&null===o?I._manualStat(f,d,O,x):{calculated:!1};let g=I._whereclause;null!==C&&null!==I._whereclause&&(g=(0,U.$e)(I._whereclause,C));const u=yield I._parent._stat(f,d,P,o,g,O,x);return!1===u.calculated?null===C&&""===P&&null===o?I._manualStat(f,d,O,x):{calculated:!1}:u})()}_canDoAggregates(f,d,P,o,C){var O=this;return(0,_.Z)(function*(){return null===O._whereClauseFunction&&(null!==C?null!==O._whereclause&&(C=(0,U.$e)(O._whereclause,C)):C=O._whereclause,null!==O._parent&&O._parent._canDoAggregates(f,d,P,o,C))})()}_getAggregatePagesDataSourceDefinition(f,d,P,o,C,O,x){var I=this;return(0,_.Z)(function*(){if(null===I._parent)throw new V.EN(V.H9.NeverReach);return null!==C?null!==I._whereclause&&(C=(0,U.$e)(I._whereclause,C)):C=I._whereclause,I._parent._getAggregatePagesDataSourceDefinition(f,d,P,o,C,O,x)})()}static registerAction(){q.Z._featuresetFunctions.filter=function(f){if("function"==typeof f)return new R({parentfeatureset:this,whereclause:f});let d=null;return f instanceof w.WhereClause&&(d=f),new R({parentfeatureset:this,whereclause:d})}}}},95896:(ee,Y,c)=>{c.d(Y,{Z:()=>j});var _=c(15861),V=c(47562),q=c(47982),N=c(49086),D=c(91510),U=c(57366);class j extends N.Z{constructor(y){super(y),this._orderbyclause=null,this.declaredClass="esri.arcade.featureset.actions.OrderBy",this._maxProcessing=100,this._orderbyclause=y.orderbyclause,this._parent=y.parentfeatureset}_getSet(y){var R=this;return(0,_.Z)(function*(){if(null===R._wset){yield R._ensureLoaded();const L=yield R._getFilteredSet("",null,null,R._orderbyclause,y);return R._checkCancelled(y),R._wset=L,R._wset}return R._wset})()}manualOrderSet(y,R){var L=this;return(0,_.Z)(function*(){const f=yield L.getIdColumnDictionary(y,[],-1,R);L._orderbyclause?.order(f);const d=new D.Z([],[],!0,null);for(let P=0;P<f.length;P++)d._known.push(f[P].id);return d})()}getIdColumnDictionary(y,R,L,f){var d=this;return(0,_.Z)(function*(){if(L<y._known.length-1){const P=d._maxQueryRate();if("GETPAGES"===y._known[L+1])return yield(0,V.W)(d._parent._expandPagedSet(y,P,0,0,f)),d.getIdColumnDictionary(y,R,L,f);let o=L+1;const C=[];for(;o<y._known.length&&"GETPAGES"!==y._known[o];)C.push(y._known[o]),o++;L+=C.length;const O=yield(0,V.W)(d._parent._getFeatureBatch(C,f));d._checkCancelled(f);for(const x of O)R.push({id:x.attributes[d.objectIdField],feature:x});return d.getIdColumnDictionary(y,R,L,f)}return y._candidates.length>0?(yield(0,V.W)(d._refineSetBlock(y,d._maxProcessingRate(),f)),d._checkCancelled(f),d.getIdColumnDictionary(y,R,L,f)):R})()}_isInFeatureSet(y){return this._parent._isInFeatureSet(y)}_getFeatures(y,R,L,f){return this._parent._getFeatures(y,R,L,f)}_featureFromCache(y){if(void 0===this._featureCache[y]){const R=this._parent._featureFromCache(y);return void 0===R?void 0:null===R?null:(this._featureCache[y]=R,R)}return this._featureCache[y]}_fetchAndRefineFeatures(){return(0,_.Z)(function*(){throw new q.EN(q.H9.NeverReach)})()}_getFilteredSet(y,R,L,f,d){var P=this;return(0,_.Z)(function*(){yield P._ensureLoaded();const o=yield P._parent._getFilteredSet(y,R,L,null===f?P._orderbyclause:f,d);P._checkCancelled(d);const C=new D.Z(o._candidates.slice(0),o._known.slice(0),o._ordered,P._clonePageDefinition(o.pagesDefinition));let O=!0;if(o._candidates.length>0&&(O=!1),!1===C._ordered){let x=yield P.manualOrderSet(C,d);return!1===O&&(null===R&&null===L||(x=new D.Z(x._candidates.slice(0).concat(x._known.slice(0)),[],x._ordered,P._clonePageDefinition(x.pagesDefinition)))),x}return C})()}static registerAction(){N.Z._featuresetFunctions.orderBy=function(y){return""===y?this:new j({parentfeatureset:this,orderbyclause:new U.Z(y)})}}}},79429:(ee,Y,c)=>{c.d(Y,{Z:()=>U});var _=c(15861),V=c(47982),q=c(49086),N=c(91510),D=c(77132);class U extends q.Z{constructor(w){super(w),this._topnum=0,this.declaredClass="esri.arcade.featureset.actions.Top",this._countedin=0,this._maxProcessing=100,this._topnum=w.topnum,this._parent=w.parentfeatureset}_getSet(w){var y=this;return(0,_.Z)(function*(){if(null===y._wset){yield y._ensureLoaded();const R=yield y._parent._getSet(w);return y._wset=new N.Z(R._candidates.slice(0),R._known.slice(0),!1,y._clonePageDefinition(R.pagesDefinition)),y._setKnownLength(y._wset)>y._topnum&&(y._wset._known=y._wset._known.slice(0,y._topnum)),y._setKnownLength(y._wset)>=y._topnum&&(y._wset._candidates=[]),y._wset}return y._wset})()}_setKnownLength(w){return w._known.length>0&&"GETPAGES"===w._known[w._known.length-1]?w._known.length-1:w._known.length}_isInFeatureSet(w){const y=this._parent._isInFeatureSet(w);if(y===D.dj.NotInFeatureSet)return y;const R=this._idstates[w];return R===D.dj.InFeatureSet||R===D.dj.NotInFeatureSet?R:y===D.dj.InFeatureSet&&void 0===R?this._countedin<this._topnum?(this._idstates[w]=D.dj.InFeatureSet,this._countedin++,D.dj.InFeatureSet):(this._idstates[w]=D.dj.NotInFeatureSet,D.dj.NotInFeatureSet):D.dj.Unknown}_expandPagedSet(w,y,R,L,f){var d=this;return(0,_.Z)(function*(){if(null===d._parent)throw new V.EN(V.H9.NotImplemented);if(y>d._topnum&&(y=d._topnum),d._countedin>=d._topnum&&w.pagesDefinition.internal.set.length<=w.pagesDefinition.resultOffset){let o=w._known.length;return o>0&&"GETPAGES"===w._known[o-1]&&(w._known.length=o-1),o=w._candidates.length,o>0&&"GETPAGES"===w._candidates[o-1]&&(w._candidates.length=o-1),"success"}const P=yield d._parent._expandPagedSet(w,y,R,L,f);return d._setKnownLength(w)>d._topnum&&(w._known.length=d._topnum),d._setKnownLength(w)>=d._topnum&&(w._candidates.length=0),P})()}_getFeatures(w,y,R,L){var f=this;return(0,_.Z)(function*(){const d=[],P=f._maxQueryRate();if(!0===f._checkIfNeedToExpandKnownPage(w,P))return yield f._expandPagedSet(w,P,0,0,L),f._getFeatures(w,y,R,L);-1!==y&&void 0===f._featureCache[y]&&d.push(y);let o=0;for(let x=w._lastFetchedIndex;x<w._known.length&&(o++,o<=R&&(w._lastFetchedIndex+=1),!(void 0===f._featureCache[w._known[x]]&&(w._known[x]!==y&&d.push(w._known[x]),d.length>P)));x++);if(0===d.length)return"success";const C=new N.Z([],d,!1,null),O=Math.min(d.length,R);yield f._parent._getFeatures(C,-1,O,L);for(let x=0;x<O;x++){const I=f._parent._featureFromCache(d[x]);void 0!==I&&(f._featureCache[d[x]]=I)}return"success"})()}_getFilteredSet(w,y,R,L,f){var d=this;return(0,_.Z)(function*(){yield d._ensureLoaded();const P=yield d._getSet(f);return new N.Z(P._candidates.slice(0).concat(P._known.slice(0)),[],!1,d._clonePageDefinition(P.pagesDefinition))})()}_refineKnowns(w,y){let R=0,L=null;const f=[];for(let d=0;d<w._candidates.length;d++){const P=this._isInFeatureSet(w._candidates[d]);if(P===D.dj.InFeatureSet){if(w._known.push(w._candidates[d]),R+=1,null===L?L={start:d,end:d}:L.end===d-1?L.end=d:(f.push(L),L={start:d,end:d}),w._known.length>=this._topnum)break}else if(P===D.dj.NotInFeatureSet)null===L?L={start:d,end:d}:L.end===d-1?L.end=d:(f.push(L),L={start:d,end:d}),R+=1;else if(P===D.dj.Unknown)break;if(R>=y)break}null!==L&&f.push(L);for(let d=f.length-1;d>=0;d--)w._candidates.splice(f[d].start,f[d].end-f[d].start+1);this._setKnownLength(w)>this._topnum&&(w._known=w._known.slice(0,this._topnum)),this._setKnownLength(w)>=this._topnum&&(w._candidates=[])}_stat(){return(0,_.Z)(function*(){return{calculated:!1}})()}_canDoAggregates(){return(0,_.Z)(function*(){return!1})()}static registerAction(){q.Z._featuresetFunctions.top=function(w){return new U({parentfeatureset:this,topnum:w})}}}},16776:(ee,Y,c)=>{c.d(Y,{Z:()=>d});var _=c(15861),V=c(88879),q=c(47982),N=c(49086),D=c(91510),U=c(77132),j=c(83947),w=c(21674),y=c(80415),R=c(41638),L=c(36255),f=c(96854);class d extends N.Z{constructor(o){super(o),this.declaredClass="esri.arcade.featureset.sources.FeatureLayerMemory",this._removeGeometry=!1,this._overrideFields=null,this._forceIsTable=!1,o.spatialReference&&(this.spatialReference=o.spatialReference),this._transparent=!0,this._maxProcessing=1e3,this._layer=o.layer,this._wset=null,!0===o.isTable&&(this._forceIsTable=!0),void 0!==o.outFields&&(this._overrideFields=o.outFields),void 0!==o.includeGeometry&&(this._removeGeometry=!1===o.includeGeometry)}_maxQueryRate(){return U.tI}end(){return this._layer}optimisePagingFeatureQueries(){}loadImpl(){var o=this;return(0,_.Z)(function*(){return!0===o._layer.loaded?(o._initialiseFeatureSet(),o):(yield o._layer.load(),o._initialiseFeatureSet(),o)})()}get gdbVersion(){return""}_initialiseFeatureSet(){if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this._layer.geometryType,this.fields=this._layer.fields.slice(0),this._layer.outFields&&(1!==this._layer.outFields.length||"*"!==this._layer.outFields[0])){const o=[];for(const C of this.fields)if("oid"===C.type)o.push(C);else for(const O of this._layer.outFields)if(O.toLowerCase()===C.name.toLowerCase()){o.push(C);break}this.fields=o}if(null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{const o=[],C=[];for(const O of this.fields)if("oid"===O.type)o.push(O),C.push(O.name);else for(const x of this._overrideFields)if(x.toLowerCase()===O.name.toLowerCase()){o.push(O),C.push(O.name);break}this.fields=o,this._overrideFields=C}this.objectIdField=this._layer.objectIdField;for(const o of this.fields)"global-id"===o.type&&(this.globalIdField=o.name);this.hasM=this._layer.supportsM,this.hasZ=this._layer.supportsZ,this._databaseType=U.Bj.Standardised,this.typeIdField=this._layer.typeIdField,this.types=this._layer.types}isTable(){return this._forceIsTable||this._layer.isTable||"table"===this._layer.type||!this._layer.geometryType}_isInFeatureSet(){return U.dj.InFeatureSet}_candidateIdTransform(o){return o}_getSet(o){var C=this;return(0,_.Z)(function*(){if(null===C._wset){yield C._ensureLoaded();const O=yield C._getFilteredSet("",null,null,null,o);return C._wset=O,O}return C._wset})()}_changeFeature(o){const C={};for(const O of this.fields)C[O.name]=o.attributes[O.name];return new V.Z({geometry:!0===this._removeGeometry?null:o.geometry,attributes:C})}_getFilteredSet(o,C,O,x,I){var g=this;return(0,_.Z)(function*(){let u="",m=!1;if(null!==x&&(u=x.constructClause(),m=!0),g.isTable()&&C&&null!==o&&""!==o)return new D.Z([],[],!0,null);const F=new f.Z;F.where=null===O?null===C?"1=1":"":(0,j.zR)(O,U.Bj.Standardised),F.spatialRelationship=g._makeRelationshipEnum(o),F.outSpatialReference=g.spatialReference,F.orderByFields=""!==u?u.split(","):null,F.geometry=null===C?null:C,F.returnGeometry=!0,F.relationParameter=g._makeRelationshipParam(o);const S=yield g._layer.queryFeatures(F);if(null===S)return new D.Z([],[],m,null);g._checkCancelled(I);const v=[];return S.features.forEach(z=>{const Z=z.attributes[g._layer.objectIdField];v.push(Z),g._featureCache[Z]=g._changeFeature(z)}),new D.Z([],v,m,null)})()}_makeRelationshipEnum(o){if(o.includes("esriSpatialRelRelation"))return"relation";switch(o){case"esriSpatialRelRelation":return"relation";case"esriSpatialRelIntersects":return"intersects";case"esriSpatialRelContains":return"contains";case"esriSpatialRelOverlaps":return"overlaps";case"esriSpatialRelWithin":return"within";case"esriSpatialRelTouches":return"touches";case"esriSpatialRelCrosses":return"crosses";case"esriSpatialRelEnvelopeIntersects":return"envelope-intersects"}return o}_makeRelationshipParam(o){return o.includes("esriSpatialRelRelation")?o.split(":")[1]:""}_queryAllFeatures(){var o=this;return(0,_.Z)(function*(){if(o._wset)return o._wset;const C=new f.Z;if(C.where="1=1",yield o._ensureLoaded(),o._layer.source&&o._layer.source.items){const I=[];return o._layer.source.items.forEach(g=>{const u=g.attributes[o._layer.objectIdField];I.push(u),o._featureCache[u]=o._changeFeature(g)}),o._wset=new D.Z([],I,!1,null),o._wset}const O=yield o._layer.queryFeatures(C),x=[];return O.features.forEach(I=>{const g=I.attributes[o._layer.objectIdField];x.push(g),o._featureCache[g]=o._changeFeature(I)}),o._wset=new D.Z([],x,!1,null),o._wset})()}_getFeatures(o,C,O){var x=this;return(0,_.Z)(function*(){const I=[];-1!==C&&void 0===x._featureCache[C]&&I.push(C);for(let g=o._lastFetchedIndex;g<o._known.length&&(o._lastFetchedIndex+=1,!(void 0===x._featureCache[o._known[g]]&&(o._known[g]!==C&&I.push(o._known[g]),I.length>O)));g++);if(0===I.length)return"success";throw new q.EN(q.H9.MissingFeatures)})()}_refineSetBlock(o){return(0,_.Z)(function*(){return o})()}_stat(){return(0,_.Z)(function*(){return{calculated:!1}})()}_canDoAggregates(){return(0,_.Z)(function*(){return!1})()}relationshipMetaData(){return[]}static _cloneAttr(o){const C={};for(const O in o)C[O]=o[O];return C}nativeCapabilities(){return{title:this._layer.title??"",canQueryRelated:!1,source:this,capabilities:this._layer.capabilities,databaseType:this._databaseType,requestStandardised:!0}}static create(o,C){let O=o.layerDefinition.objectIdField;const x=o.layerDefinition.typeIdField?o.layerDefinition.typeIdField:"",I=[];if(o.layerDefinition.types)for(const Z of o.layerDefinition.types)I.push(R.Z.fromJSON(Z));let g=o.layerDefinition.geometryType;void 0===g&&(g=o.featureSet.geometryType||"");let u=o.featureSet.features;const m=C.toJSON();if(""===O||void 0===O){let Z=!1;for(const B of o.layerDefinition.fields)if("oid"===B.type||"esriFieldTypeOID"===B.type){O=B.name,Z=!0;break}if(!1===Z){let B="FID",W=!0,T=0;for(;W;){let G=!0;for(const se of o.layerDefinition.fields)if(se.name===B){G=!1;break}!0===G?W=!1:(T++,B="FID"+T.toString())}o.layerDefinition.fields.push({type:"esriFieldTypeOID",name:B,alias:B});const M=[];for(let G=0;G<u.length;G++)M.push({geometry:o.featureSet.features[G].geometry,attributes:o.featureSet.features[G].attributes?this._cloneAttr(o.featureSet.features[G].attributes):{}}),M[G].attributes[B]=G;u=M,O=B}}const F=[];for(const Z of o.layerDefinition.fields)F.push(Z instanceof L.Z?Z:L.Z.fromJSON(Z));let S=g;switch(S||(S=""),S){case"esriGeometryPoint":S="point";break;case"esriGeometryPolyline":S="polyline";break;case"esriGeometryPolygon":S="polygon";break;case"esriGeometryExtent":S="extent";break;case"esriGeometryMultipoint":S="multipoint";break;case"":case"esriGeometryNull":S="esriGeometryNull"}if("esriGeometryNull"!==S)for(const Z of u)Z.geometry&&!(Z.geometry instanceof w.Z)&&(Z.geometry.type=S,void 0===Z.geometry.spatialReference&&(Z.geometry.spatialReference=m));else for(const Z of u)Z.geometry&&(Z.geometry=null);const v={outFields:["*"],source:u,fields:F,types:I,typeIdField:x,objectIdField:O,spatialReference:C};""!==S&&"esriGeometryNull"!==S&&null!==S&&(v.geometryType=S);const z=new y.default(v);return new d({layer:z,spatialReference:C,isTable:null===S||""===S||"esriGeometryNull"===S})}queryAttachments(){return(0,_.Z)(function*(){return[]})()}getFeatureByObjectId(o){var C=this;return(0,_.Z)(function*(){const O=new f.Z;O.where=C.objectIdField+"="+o.toString();const x=yield C._layer.queryFeatures(O);return 1===x.features.length?x.features[0]:null})()}getOwningSystemUrl(){return(0,_.Z)(function*(){return""})()}getIdentityUser(){return(0,_.Z)(function*(){return""})()}get preferredTimeReference(){return this._layer?.preferredTimeReference?.toJSON()??null}get dateFieldsTimeReference(){return this._layer?.dateFieldsTimeReference?.toJSON()??null}get datesInUnknownTimezone(){return this._layer?.datesInUnknownTimezone}get editFieldsInfo(){return this._layer?.editFieldsInfo?.toJSON()??null}get timeInfo(){return this._layer?.timeInfo?.toJSON()??null}}},57366:(ee,Y,c)=>{function _(q,N){return q===N?0:null===q?-1:null===N?1:q<N?-1:1}c.d(Y,{Z:()=>V});class V{constructor(N){const D=N.split(",");this._fields=[],this._directions=[];for(let U=0;U<D.length;U++){const j=D[U].match(/\S+/g);this._fields.push(j[0]),2===j.length?"asc"===j[1].toLowerCase()?this._directions.push(1):this._directions.push(0):this._directions.push(1)}}constructClause(){let N="";for(let D=0;D<this._fields.length;D++)0!==D&&(N+=","),N+=this._fields[D],N+=1===this._directions[D]?" ASC":" DESC";return N}order(N){N.sort((D,U)=>{for(let j=0;j<this._fields.length;j++){const w=this.featureValue(D.feature,this._fields[j],j),y=this.featureValue(U.feature,this._fields[j],j);let R=0;if(R=1===this._directions[j]?_(w,y):-1*_(w,y),0!==R)return R}return 0})}scanForField(N){for(let D=0;D<this._fields.length;D++)if(this._fields[D].toLowerCase().trim()===N.toLowerCase().trim())return!0;return!1}replaceFields(N){let D="";for(let U=0;U<this._fields.length;U++){0!==U&&(D+=",");let j=this._fields[U];for(const w of N)if(j.toLowerCase()===w.field.toLowerCase()){j=w.newfield;break}D+=j,D+=1===this._directions[U]?" ASC":" DESC"}return new V(D)}featureValue(N,D,U){const j=N.attributes[D];if(void 0!==j)return j;for(const w in N.attributes)if(D.toLowerCase()===w.toLowerCase())return this._fields[U]=w,N.attributes[w];return null}}},90463:(ee,Y,c)=>{c.d(Y,{P:()=>D});var _=c(15861),V=c(2618),q=c(20477),N=c(96854);function D(j,w,y){return U.apply(this,arguments)}function U(){return(U=(0,_.Z)(function*(j,w,y){const R=(0,V.en)(j);return(0,q.hH)(R,N.Z.from(w),{...y}).then(L=>L.data.count)})).apply(this,arguments)}},24865:(ee,Y,c)=>{c.d(Y,{G:()=>D});var _=c(15861),V=c(2618),q=c(20477),N=c(96854);function D(j,w,y){return U.apply(this,arguments)}function U(){return(U=(0,_.Z)(function*(j,w,y){const R=(0,V.en)(j);return(0,q.Ev)(R,N.Z.from(w),{...y}).then(L=>L.data.objectIds)})).apply(this,arguments)}}}]);