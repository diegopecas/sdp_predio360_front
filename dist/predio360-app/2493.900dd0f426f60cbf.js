"use strict";(self.webpackChunkpredio360_app=self.webpackChunkpredio360_app||[]).push([[2493],{42493:(X,M,p)=>{p.r(M),p.d(M,{ElevationQuery:()=>k,GeometryDescriptor:()=>g,getFinestLodIndex:()=>_});var f=p(15861),Q=p(59213),T=p(26584),z=p(62208),E=p(10699),Z=p(16730),I=p(72854),S=p(72642),W=p(55214),x=p(55915),R=p(65401),O=p(13762),K=p(80403);class L{constructor(e,t=null){this.tile=e,null!=t&&null!=e&&(this._samplerData=new K.K(t,e.extent))}get zmin(){return null!=this._samplerData?this._samplerData.data.minValue:0}get zmax(){return null!=this._samplerData?this._samplerData.data.maxValue:0}get hasNoDataValues(){return!!this._samplerData?.data.hasNoDataValues}sample(e,t){if(null==this._samplerData)return;const{safeWidth:n,data:l,dx:o,dy:i,y1:s,x0:a}=this._samplerData,{width:r,values:c,noDataValue:h}=l,y=V(i*(s-t),0,n),u=V(o*(e-a),0,n),v=Math.floor(y),G=Math.floor(u),C=v*r+G,N=C+r,q=c[C],F=c[N],U=c[C+1],$=c[N+1];if(q!==h&&F!==h&&U!==h&&$!==h){const b=u-G,H=q+(U-q)*b;return H+(F+($-F)*b-H)*(y-v)}}}function V(d,e,t){return d<e?e:d>t?t:d}var P=p(68511);class k{queryAll(e,t,n){var l=this;return(0,f.Z)(function*(){if(!(e=n&&n.ignoreInvisibleLayers?e.filter(c=>c.visible):e.slice()).length)throw new T.Z("elevation-query:invalid-layer","Elevation queries require at least one elevation layer to fetch tiles from");const o=g.fromGeometry(t);let i=!1;n&&n.returnSampleInfo||(i=!0);const s={...D,...n,returnSampleInfo:!0},a=yield l.query(e[e.length-1],o,s),r=yield l._queryAllContinue(e,a,s);return r.geometry=r.geometry.export(),i&&delete r.sampleInfo,r})()}query(e,t,n){var l=this;return(0,f.Z)(function*(){if(!e)throw new T.Z("elevation-query:invalid-layer","Elevation queries require an elevation layer to fetch tiles from");if(!t||!(t instanceof g)&&"point"!==t.type&&"multipoint"!==t.type&&"polyline"!==t.type)throw new T.Z("elevation-query:invalid-geometry","Only point, polyline and multipoint geometries can be used to query elevation");const o={...D,...n},i=new B(e,t.spatialReference,o),s=o.signal;return yield e.load({signal:s}),yield l._createGeometryDescriptor(i,t,s),yield l._selectTiles(i,s),yield l._populateElevationTiles(i,s),l._sampleGeometryWithElevation(i),l._createQueryResult(i,s)})()}createSampler(e,t,n){var l=this;return(0,f.Z)(function*(){if(!e)throw new T.Z("elevation-query:invalid-layer","Elevation queries require an elevation layer to fetch tiles from");if(!t||"extent"!==t.type)throw new T.Z("elevation-query:invalid-extent","Invalid or undefined extent");const o={...D,...n};return l._createSampler(e,t,o)})()}createSamplerAll(e,t,n){var l=this;return(0,f.Z)(function*(){if(!(e=n&&n.ignoreInvisibleLayers?e.filter(s=>s.visible):e.slice()).length)throw new T.Z("elevation-query:invalid-layer","Elevation queries require at least one elevation layer to fetch tiles from");if(!t||"extent"!==t.type)throw new T.Z("elevation-query:invalid-extent","Invalid or undefined extent");const o={...D,...n,returnSampleInfo:!0},i=yield l._createSampler(e[e.length-1],t,o);return l._createSamplerAllContinue(e,t,i,o)})()}_createSampler(e,t,n,l){var o=this;return(0,f.Z)(function*(){const i=n.signal;yield e.load({signal:i});const s=t.spatialReference,a=e.tileInfo.spatialReference;s.equals(a)||(yield(0,x.initializeProjection)([{source:s,dest:a}],{signal:i}),t=(0,x.project)(t,a));const r=new J(e,t,n,l);return yield o._selectTiles(r,i),yield o._populateElevationTiles(r,i),new O.Tl(r.elevationTiles,r.layer.tileInfo,r.options.noDataValue)})()}_createSamplerAllContinue(e,t,n,l){var o=this;return(0,f.Z)(function*(){if(e.pop(),!e.length)return n;const i=n.samplers.filter(c=>!c.tile.hasNoDataValues).map(c=>(0,R.oJ)(c.extent)),s=yield o._createSampler(e[e.length-1],t,l,i);if(0===s.samplers.length)return n;const a=n.samplers.concat(s.samplers),r=new O.Tl(a,l.noDataValue);return o._createSamplerAllContinue(e,t,r,l)})()}_queryAllContinue(e,t,n){var l=this;return(0,f.Z)(function*(){const o=e.pop(),i=t.geometry.coordinates,s=t.sampleInfo;(0,z.O3)(s);const a=[],r=[];for(let u=0;u<i.length;u++){const v=s[u];v.demResolution>=0?v.source||(v.source=o):e.length&&(a.push(i[u]),r.push(u))}if(!e.length||0===a.length)return t;const c=t.geometry.clone(a),h=yield l.query(e[e.length-1],c,n),y=h.sampleInfo;if(!y)throw new Error("no sampleInfo");return r.forEach((u,v)=>{i[u].z=h.geometry.coordinates[v].z,s[u].demResolution=y[v].demResolution}),l._queryAllContinue(e,t,n)})()}_createQueryResult(e,t){var n=this;return(0,f.Z)(function*(){const l=yield e.geometry.project(e.outSpatialReference,t);(0,z.O3)(l);const o={geometry:l.export(),noDataValue:e.options.noDataValue};return e.options.returnSampleInfo&&(o.sampleInfo=n._extractSampleInfo(e)),e.geometry.coordinates.forEach(i=>{i.tile=null,i.elevationTile=null}),o})()}_createGeometryDescriptor(e,t,n){return(0,f.Z)(function*(){let l;const o=e.layer.tileInfo.spatialReference;if(t instanceof g?l=yield t.project(o,n):(yield(0,x.initializeProjection)([{source:t.spatialReference,dest:o}],{signal:n}),l=(0,x.project)(t,o)),!l)throw new T.Z("elevation-query:spatial-reference-mismatch",`Cannot query elevation in '${t.spatialReference.wkid}' on an elevation service in '${o.wkid}'`);e.geometry=g.fromGeometry(l)})()}_selectTiles(e,t){var n=this;return(0,f.Z)(function*(){"geometry"===e.type&&n._preselectOutsideLayerExtent(e);const l=e.options.demResolution;if("number"==typeof l)n._selectTilesClosestResolution(e,l);else if("finest-contiguous"===l)yield n._selectTilesFinestContiguous(e,t);else{if("auto"!==l)throw new T.Z("elevation-query:invalid-dem-resolution",`Invalid dem resolution value '${l}', expected a number, "finest-contiguous" or "auto"`);yield n._selectTilesAuto(e,t)}})()}_preselectOutsideLayerExtent(e){if(null==e.layer.fullExtent)return;const t=new L(null);t.sample=()=>e.options.noDataValue,e.outsideExtentTile=t;const n=e.layer.fullExtent;e.geometry.coordinates.forEach(l=>{const o=l.x,i=l.y;(o<n.xmin||o>n.xmax||i<n.ymin||i>n.ymax)&&(l.elevationTile=t)})}_selectTilesClosestResolution(e,t){const n=this._findNearestDemResolutionLODIndex(e,t);e.selectTilesAtLOD(n)}_findNearestDemResolutionLODIndex(e,t){const{tileInfo:n,tilemapCache:l}=e.layer,o=t/(0,Z.c9)(n.spatialReference),i=w(n,l);let s=i[0],a=0;for(let r=1;r<i.length;r++){const c=i[r];Math.abs(c.resolution-o)<Math.abs(s.resolution-o)&&(s=c,a=r)}return a}_selectTilesFinestContiguous(e,t){var n=this;return(0,f.Z)(function*(){const{tileInfo:l,tilemapCache:o}=e.layer,i=_(l,o,e.options.minDemResolution);yield n._selectTilesFinestContiguousAt(e,i,t)})()}_selectTilesFinestContiguousAt(e,t,n){var l=this;return(0,f.Z)(function*(){const o=e.layer;if(e.selectTilesAtLOD(t),t<0)return;const i=o.tilemapCache,s=e.getTilesToFetch();try{if(i&&!A(i))yield(0,E.Hl)(Promise.all(s.map(a=>i.fetchAvailability(a.level,a.row,a.col,{signal:n}))),n);else if(yield l._populateElevationTiles(e,n),!e.allElevationTilesFetched())throw e.clearElevationTiles(),new T.Z("elevation-query:has-unavailable-tiles")}catch(a){(0,E.r9)(a),yield l._selectTilesFinestContiguousAt(e,t-1,n)}})()}_populateElevationTiles(e,t){return(0,f.Z)(function*(){const n=e.getTilesToFetch(),l={},o=e.options.cache,i=e.options.noDataValue,s=n.map(function(){var a=(0,f.Z)(function*(r){if(null==r.id)return;const c=`${e.layer.uid}:${r.id}:${i}`,y=(null!=o?o.get(c):null)??(yield e.layer.fetchTile(r.level,r.row,r.col,{noDataValue:i,signal:t}));o?.put(c,y),l[r.id]=new L(r,y)});return function(r){return a.apply(this,arguments)}}());yield(0,E.Hl)(Promise.allSettled(s),t),e.populateElevationTiles(l)})()}_selectTilesAuto(e,t){var n=this;return(0,f.Z)(function*(){n._selectTilesAutoFinest(e),n._reduceTilesForMaximumRequests(e);const l=e.layer.tilemapCache;if(!l||A(l))return n._selectTilesAutoPrefetchUpsample(e,t);const o=e.getTilesToFetch(),i={},s=o.map(function(){var a=(0,f.Z)(function*(r){const c=new P.f(null,0,0,0,(0,R.Ue)()),h=yield(0,Q.q6)(l.fetchAvailabilityUpsample(r.level,r.row,r.col,c,{signal:t}));!1!==h.ok?null!=r.id&&(i[r.id]=c):(0,E.r9)(h.error)});return function(r){return a.apply(this,arguments)}}());yield(0,E.Hl)(Promise.all(s),t),e.remapTiles(i)})()}_reduceTilesForMaximumRequests(e){const t=e.layer.tileInfo;let n=0;const l={},o=a=>{null!=a.id&&(a.id in l?l[a.id]++:(l[a.id]=1,n++))},i=a=>{if(null==a.id)return;const r=l[a.id];1===r?(delete l[a.id],n--):l[a.id]=r-1};e.forEachTileToFetch(o,i);let s=!0;for(;s&&(s=!1,e.forEachTileToFetch(a=>{n<=e.options.maximumAutoTileRequests||(i(a),t.upsampleTile(a)&&(s=!0),o(a))},i),s););}_selectTilesAutoFinest(e){const{tileInfo:t,tilemapCache:n}=e.layer,l=_(t,n,e.options.minDemResolution);e.selectTilesAtLOD(l,e.options.maximumAutoTileRequests)}_selectTilesAutoPrefetchUpsample(e,t){var n=this;return(0,f.Z)(function*(){const l=e.layer.tileInfo;yield n._populateElevationTiles(e,t);let o=!1;e.forEachTileToFetch((i,s)=>{l.upsampleTile(i)?o=!0:s()}),o&&(yield n._selectTilesAutoPrefetchUpsample(e,t))})()}_sampleGeometryWithElevation(e){e.geometry.coordinates.forEach(t=>{const n=t.elevationTile;let l=e.options.noDataValue;if(n){const o=n.sample(t.x,t.y);null!=o?l=o:t.elevationTile=null}t.z=l})}_extractSampleInfo(e){const t=e.layer.tileInfo,n=(0,Z.c9)(t.spatialReference);return e.geometry.coordinates.map(l=>{let o=-1;return l.elevationTile&&l.elevationTile!==e.outsideExtentTile&&(o=t.lodAt(l.elevationTile.tile.level).resolution*n),{demResolution:o}})}}class g{export(){return this._exporter(this.coordinates,this.spatialReference)}clone(e){const t=new g;return t.geometry=this.geometry,t.spatialReference=this.spatialReference,t.coordinates=e||this.coordinates.map(n=>n.clone()),t._exporter=this._exporter,t}project(e,t){var n=this;return(0,f.Z)(function*(){if(n.spatialReference.equals(e))return n.clone();yield(0,x.initializeProjection)([{source:n.spatialReference,dest:e}],{signal:t});const l=new I.Z({spatialReference:n.spatialReference,points:n.coordinates.map(a=>[a.x,a.y])}),o=(0,x.project)(l,e);if(!o)return null;const i=n.coordinates.map((a,r)=>{const c=a.clone(),h=o.points[r];return c.x=h[0],c.y=h[1],c}),s=n.clone(i);return s.spatialReference=e,s})()}static fromGeometry(e){const t=new g;if(t.geometry=e,t.spatialReference=e.spatialReference,e instanceof g)t.coordinates=e.coordinates.map(n=>n.clone()),t._exporter=(n,l)=>{const o=e.clone(n);return o.spatialReference=l,o};else switch(e.type){case"point":{const n=e,{hasZ:l,hasM:o}=n;t.coordinates=l&&o?[new m(n.x,n.y,n.z,n.m)]:l?[new m(n.x,n.y,n.z)]:o?[new m(n.x,n.y,null,n.m)]:[new m(n.x,n.y)],t._exporter=(i,s)=>e.hasM?new S.Z(i[0].x,i[0].y,i[0].z,i[0].m,s):new S.Z(i[0].x,i[0].y,i[0].z,s);break}case"multipoint":{const n=e,{hasZ:l,hasM:o}=n;t.coordinates=n.points.map(l&&o?i=>new m(i[0],i[1],i[2],i[3]):l?i=>new m(i[0],i[1],i[2]):o?i=>new m(i[0],i[1],null,i[2]):i=>new m(i[0],i[1])),t._exporter=(i,s)=>e.hasM?new I.Z({points:i.map(a=>[a.x,a.y,a.z,a.m]),hasZ:!0,hasM:!0,spatialReference:s}):new I.Z(i.map(a=>[a.x,a.y,a.z]),s);break}case"polyline":{const n=e,l=[],o=[],{hasZ:i,hasM:s}=e;let a=0;for(const r of n.paths)if(o.push([a,a+r.length]),a+=r.length,i&&s)for(const c of r)l.push(new m(c[0],c[1],c[2],c[3]));else if(i)for(const c of r)l.push(new m(c[0],c[1],c[2]));else if(s)for(const c of r)l.push(new m(c[0],c[1],null,c[2]));else for(const c of r)l.push(new m(c[0],c[1]));t.coordinates=l,t._exporter=(r,c)=>{const h=r.map(e.hasM?u=>[u.x,u.y,u.z,u.m]:u=>[u.x,u.y,u.z]),y=o.map(u=>h.slice(u[0],u[1]));return new W.Z({paths:y,hasM:e.hasM,hasZ:!0,spatialReference:c})};break}}return t}}class m{constructor(e,t,n=null,l=null,o=null,i=null){this.x=e,this.y=t,this.z=n,this.m=l,this.tile=o,this.elevationTile=i}clone(){return new m(this.x,this.y,this.z,this.m)}}class j{constructor(e,t){this.layer=e,this.options=t}}class B extends j{constructor(e,t,n){super(e,n),this.outSpatialReference=t,this.type="geometry"}selectTilesAtLOD(e){if(e<0)this.geometry.coordinates.forEach(t=>t.tile=null);else{const{tileInfo:t,tilemapCache:n}=this.layer,l=w(t,n)[e].level;this.geometry.coordinates.forEach(o=>o.tile=t.tileAt(l,o.x,o.y))}}allElevationTilesFetched(){return!this.geometry.coordinates.some(e=>!e.elevationTile)}clearElevationTiles(){for(const e of this.geometry.coordinates)e.elevationTile!==this.outsideExtentTile&&(e.elevationTile=null)}populateElevationTiles(e){for(const t of this.geometry.coordinates)!t.elevationTile&&t.tile?.id&&(t.elevationTile=e[t.tile.id])}remapTiles(e){for(const t of this.geometry.coordinates){const n=t.tile?.id;t.tile=n?e[n]:null}}getTilesToFetch(){const e={},t=[];for(const n of this.geometry.coordinates){const l=n.tile;if(!l)continue;const o=n.tile?.id;n.elevationTile||!o||e[o]||(e[o]=l,t.push(l))}return t}forEachTileToFetch(e){for(const t of this.geometry.coordinates)t.tile&&!t.elevationTile&&e(t.tile,()=>{t.tile=null})}}class J extends j{constructor(e,t,n,l){super(e,n),this.type="extent",this.elevationTiles=[],this._candidateTiles=[],this._fetchedCandidates=new Set,this.extent=t.clone().intersection(e.fullExtent),this.maskExtents=l}selectTilesAtLOD(e,t){const n=this._maximumLodForRequests(t),l=Math.min(n,e);l<0?this._candidateTiles.length=0:this._selectCandidateTilesCoveringExtentAt(l)}_maximumLodForRequests(e){const{tileInfo:t,tilemapCache:n}=this.layer,l=w(t,n);if(!e)return l.length-1;const o=this.extent;if(null==o)return-1;for(let i=l.length-1;i>=0;i--){const s=l[i],r=s.resolution*t.size[1];if(Math.ceil(o.width/(s.resolution*t.size[0]))*Math.ceil(o.height/r)<=e)return i}return-1}allElevationTilesFetched(){return this._candidateTiles.length===this.elevationTiles.length}clearElevationTiles(){this.elevationTiles.length=0,this._fetchedCandidates.clear()}populateElevationTiles(e){for(const t of this._candidateTiles){const n=t.id&&e[t.id];n&&(this._fetchedCandidates.add(t),this.elevationTiles.push(n))}}remapTiles(e){this._candidateTiles=this._uniqueNonOverlappingTiles(this._candidateTiles.map(t=>e[t.id]))}getTilesToFetch(){return this._candidateTiles}forEachTileToFetch(e,t){const n=this._candidateTiles;this._candidateTiles=[],n.forEach(l=>{if(this._fetchedCandidates.has(l))return void(t&&t(l));let o=!1;e(l,()=>o=!0),o?t&&t(l):this._candidateTiles.push(l)}),this._candidateTiles=this._uniqueNonOverlappingTiles(this._candidateTiles,t)}_uniqueNonOverlappingTiles(e,t){const n={},l=[];for(const i of e){const s=i.id;s&&!n[s]?(n[s]=i,l.push(i)):t&&t(i)}const o=l.sort((i,s)=>i.level-s.level);return o.filter((i,s)=>{for(let a=0;a<s;a++){const r=o[a].extent;if(r&&i.extent&&(0,R.r3)(r,i.extent))return t&&t(i),!1}return!0})}_selectCandidateTilesCoveringExtentAt(e){this._candidateTiles.length=0;const t=this.extent;if(null==t)return;const{tileInfo:n,tilemapCache:l}=this.layer,o=w(n,l)[e],i=n.tileAt(o.level,t.xmin,t.ymin),s=i.extent;if(null==s)return;const r=o.resolution*n.size[1],c=Math.ceil((t.xmax-s[0])/(o.resolution*n.size[0])),h=Math.ceil((t.ymax-s[1])/r);for(let y=0;y<h;y++)for(let u=0;u<c;u++){const v=new P.f(null,i.level,i.row-y,i.col+u);n.updateTileInfo(v),this._tileIsMasked(v)||this._candidateTiles.push(v)}}_tileIsMasked(e){return!!this.maskExtents&&this.maskExtents.some(t=>e.extent&&(0,R.r3)(t,e.extent))}}function _(d,e,t=0){const n=w(d,e);let l=n.length-1;if(t>0){const o=t/(0,Z.c9)(d.spatialReference),i=n.findIndex(s=>s.resolution<o);0===i?l=0:i>0&&(l=i-1)}return l}const D={maximumAutoTileRequests:20,noDataValue:0,returnSampleInfo:!1,demResolution:"auto",minDemResolution:0};function w(d,e){const t=d.lods;if(A(e)){const{effectiveMinLOD:n,effectiveMaxLOD:l}=e;return t.filter(o=>o.level>=n&&o.level<=l)}return t}function A(d){return null!=d?.tileInfo}}}]);