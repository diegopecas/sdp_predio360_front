"use strict";(self.webpackChunkpredio360_app=self.webpackChunkpredio360_app||[]).push([[6354],{36592:(tt,Y,d)=>{d.d(Y,{Q:()=>U});var x=d(85931),m=d(77029),w=d(14259);class U{constructor(s=9,r){this._compareMinX=V,this._compareMinY=H,this._toBBox=n=>n,this._maxEntries=Math.max(4,s||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),r&&("function"==typeof r?this._toBBox=r:this._initFormat(r)),this.clear()}destroy(){this.clear(),b.prune(),L.prune(),A.prune(),G.prune()}all(s){this._all(this._data,s)}search(s,r){let n=this._data;const a=this._toBBox;if(g(s,n))for(b.clear();n;){for(let h=0,p=n.children.length;h<p;h++){const E=n.children[h],S=n.leaf?a(E):E;g(s,S)&&(n.leaf?r(E):f(s,S)?this._all(E,r):b.push(E))}n=b.pop()}}collides(s){let r=this._data;const n=this._toBBox;if(!g(s,r))return!1;for(b.clear();r;){for(let a=0,h=r.children.length;a<h;a++){const p=r.children[a],E=r.leaf?n(p):p;if(g(s,E)){if(r.leaf||f(s,E))return!0;b.push(p)}}r=b.pop()}return!1}load(s){if(!s.length)return this;if(s.length<this._minEntries){for(let n=0,a=s.length;n<a;n++)this.insert(s[n]);return this}let r=this._build(s.slice(0,s.length),0,s.length-1,0);if(this._data.children.length)if(this._data.height===r.height)this._splitRoot(this._data,r);else{if(this._data.height<r.height){const n=this._data;this._data=r,r=n}this._insert(r,this._data.height-r.height-1,!0)}else this._data=r;return this}insert(s){return s&&this._insert(s,this._data.height-1),this}clear(){return this._data=new W([]),this}remove(s){if(!s)return this;let r,n=this._data,a=null,h=0,p=!1;const E=this._toBBox(s);for(A.clear(),G.clear();n||A.length>0;){if(n||(n=A.pop(),a=A.data[A.length-1],h=G.pop()??0,p=!0),n.leaf&&(r=(0,x.cq)(n.children,s,n.children.length,n.indexHint),-1!==r))return n.children.splice(r,1),A.push(n),this._condense(A),this;p||n.leaf||!f(n,E)?a?(h++,n=a.children[h],p=!1):n=null:(A.push(n),G.push(h),h=0,a=n,n=n.children[0])}return this}toJSON(){return this._data}fromJSON(s){return this._data=s,this}_all(s,r){let n=s;for(L.clear();n;){if(!0===n.leaf)for(const a of n.children)r(a);else L.pushArray(n.children);n=L.pop()??null}}_build(s,r,n,a){const h=n-r+1;let p=this._maxEntries;if(h<=p){const c=new W(s.slice(r,n+1));return y(c,this._toBBox),c}a||(a=Math.ceil(Math.log(h)/Math.log(p)),p=Math.ceil(h/p**(a-1)));const E=new K([]);E.height=a;const S=Math.ceil(h/p),P=S*Math.ceil(Math.sqrt(p));O(s,r,n,P,this._compareMinX);for(let c=r;c<=n;c+=P){const j=Math.min(c+P-1,n);O(s,c,j,S,this._compareMinY);for(let T=c;T<=j;T+=S){const it=Math.min(T+S-1,j);E.children.push(this._build(s,T,it,a-1))}}return y(E,this._toBBox),E}_chooseSubtree(s,r,n,a){for(;a.push(r),!0!==r.leaf&&a.length-1!==n;){let h,p=1/0,E=1/0;for(let S=0,P=r.children.length;S<P;S++){const c=r.children[S],j=v(c),T=Z(s,c)-j;T<E?(E=T,p=j<p?j:p,h=c):T===E&&j<p&&(p=j,h=c)}r=h||r.children[0]}return r}_insert(s,r,n){const h=n?s:(0,this._toBBox)(s);A.clear();const p=this._chooseSubtree(h,this._data,r,A);for(p.children.push(s),F(p,h);r>=0&&A.data[r].children.length>this._maxEntries;)this._split(A,r),r--;this._adjustParentBBoxes(h,A,r)}_split(s,r){const n=s.data[r],a=n.children.length,h=this._minEntries;this._chooseSplitAxis(n,h,a);const p=this._chooseSplitIndex(n,h,a);if(!p)return void console.log("  Error: assertion failed at PooledRBush._split: no valid split index");const E=n.children.splice(p,n.children.length-p),S=n.leaf?new W(E):new K(E);S.height=n.height,y(n,this._toBBox),y(S,this._toBBox),r?s.data[r-1].children.push(S):this._splitRoot(n,S)}_splitRoot(s,r){this._data=new K([s,r]),this._data.height=s.height+1,y(this._data,this._toBBox)}_chooseSplitIndex(s,r,n){let a,h,p;a=h=1/0;for(let E=r;E<=n-r;E++){const S=R(s,0,E,this._toBBox),P=R(s,E,n,this._toBBox),c=X(S,P),j=v(S)+v(P);c<a?(a=c,p=E,h=j<h?j:h):c===a&&j<h&&(h=j,p=E)}return p}_chooseSplitAxis(s,r,n){const a=s.leaf?this._compareMinX:V,h=s.leaf?this._compareMinY:H;this._allDistMargin(s,r,n,a)<this._allDistMargin(s,r,n,h)&&s.children.sort(a)}_allDistMargin(s,r,n,a){s.children.sort(a);const h=this._toBBox,p=R(s,0,r,h),E=R(s,n-r,n,h);let S=I(p)+I(E);for(let P=r;P<n-r;P++){const c=s.children[P];F(p,s.leaf?h(c):c),S+=I(p)}for(let P=n-r-1;P>=r;P--){const c=s.children[P];F(E,s.leaf?h(c):c),S+=I(E)}return S}_adjustParentBBoxes(s,r,n){for(let a=n;a>=0;a--)F(r.data[a],s)}_condense(s){for(let r=s.length-1;r>=0;r--){const n=s.data[r];if(0===n.children.length)if(r>0){const a=s.data[r-1],h=a.children;h.splice((0,x.cq)(h,n,h.length,a.indexHint),1)}else this.clear();else y(n,this._toBBox)}}_initFormat(s){const r=["return a"," - b",";"];this._compareMinX=new Function("a","b",r.join(s[0])),this._compareMinY=new Function("a","b",r.join(s[1])),this._toBBox=new Function("a","return {minX: a"+s[0]+", minY: a"+s[1]+", maxX: a"+s[2]+", maxY: a"+s[3]+"};")}}function y(l,s){R(l,0,l.children.length,s,l)}function R(l,s,r,n,a){a||(a=new W([])),a.minX=1/0,a.minY=1/0,a.maxX=-1/0,a.maxY=-1/0;for(let h,p=s;p<r;p++)h=l.children[p],F(a,l.leaf?n(h):h);return a}function F(l,s){l.minX=Math.min(l.minX,s.minX),l.minY=Math.min(l.minY,s.minY),l.maxX=Math.max(l.maxX,s.maxX),l.maxY=Math.max(l.maxY,s.maxY)}function V(l,s){return l.minX-s.minX}function H(l,s){return l.minY-s.minY}function v(l){return(l.maxX-l.minX)*(l.maxY-l.minY)}function I(l){return l.maxX-l.minX+(l.maxY-l.minY)}function Z(l,s){return(Math.max(s.maxX,l.maxX)-Math.min(s.minX,l.minX))*(Math.max(s.maxY,l.maxY)-Math.min(s.minY,l.minY))}function X(l,s){const r=Math.max(l.minX,s.minX),n=Math.max(l.minY,s.minY),a=Math.min(l.maxX,s.maxX),h=Math.min(l.maxY,s.maxY);return Math.max(0,a-r)*Math.max(0,h-n)}function f(l,s){return l.minX<=s.minX&&l.minY<=s.minY&&s.maxX<=l.maxX&&s.maxY<=l.maxY}function g(l,s){return s.minX<=l.maxX&&s.minY<=l.maxY&&s.maxX>=l.minX&&s.maxY>=l.minY}function O(l,s,r,n,a){const h=[s,r];for(;h.length;){const p=h.pop(),E=h.pop();if(p-E<=n)continue;const S=E+Math.ceil((p-E)/n/2)*n;(0,w.q)(l,S,E,p,a),h.push(E,S,S,p)}}const b=new m.Z,L=new m.Z,A=new m.Z,G=new m.Z({deallocator:void 0});class ${constructor(){this.minX=1/0,this.minY=1/0,this.maxX=-1/0,this.maxY=-1/0}}class z extends ${constructor(){super(...arguments),this.height=1,this.indexHint=new x.SO}}class W extends z{constructor(s){super(),this.children=s,this.leaf=!0}}class K extends z{constructor(s){super(),this.children=s,this.leaf=!1}}},61256:(tt,Y,d)=>{d.d(Y,{H:()=>V});var x=d(8314),m=d(36592),w=d(65401);const y={minX:0,minY:0,maxX:0,maxY:0};class V{constructor(){this._indexInvalid=!1,this._boundsToLoad=[],this._boundsById=new Map,this._idByBounds=new Map,this._index=new m.Q(9,(0,x.Z)("esri-csp-restrictions")?v=>({minX:v[0],minY:v[1],maxX:v[2],maxY:v[3]}):["[0]","[1]","[2]","[3]"]),this._loadIndex=()=>{if(this._indexInvalid){const v=new Array(this._idByBounds.size);let I=0;this._idByBounds.forEach((Z,X)=>{v[I++]=X}),this._indexInvalid=!1,this._index.clear(),this._index.load(v)}else this._boundsToLoad.length&&(this._index.load(Array.from(new Set(this._boundsToLoad.filter(v=>this._idByBounds.has(v))))),this._boundsToLoad.length=0)}}get fullBounds(){if(!this._boundsById.size)return null;const v=(0,w.cS)();for(const I of this._boundsById.values())I&&(v[0]=Math.min(I[0],v[0]),v[1]=Math.min(I[1],v[1]),v[2]=Math.max(I[2],v[2]),v[3]=Math.max(I[3],v[3]));return v}get valid(){return!this._indexInvalid}clear(){this._indexInvalid=!1,this._boundsToLoad.length=0,this._boundsById.clear(),this._idByBounds.clear(),this._index.clear()}delete(v){const I=this._boundsById.get(v);this._boundsById.delete(v),I&&(this._idByBounds.delete(I),this._indexInvalid||this._index.remove(I))}forEachInBounds(v,I){this._loadIndex(),function F(H,v,I){(function R(H){y.minX=H[0],y.minY=H[1],y.maxX=H[2],y.maxY=H[3]})(v),H.search(y,I)}(this._index,v,Z=>I(this._idByBounds.get(Z)))}get(v){return this._boundsById.get(v)}has(v){return this._boundsById.has(v)}invalidateIndex(){this._indexInvalid||(this._indexInvalid=!0,this._boundsToLoad.length=0)}set(v,I){if(!this._indexInvalid){const Z=this._boundsById.get(v);Z&&(this._index.remove(Z),this._idByBounds.delete(Z))}this._boundsById.set(v,I),I&&(this._idByBounds.set(I,v),this._indexInvalid||(this._boundsToLoad.push(I),this._boundsToLoad.length>5e4&&this._loadIndex()))}}},3579:(tt,Y,d)=>{d.d(Y,{Z:()=>Z});var x=d(85931),m=d(26584),w=d(61885),U=d(63290),y=d(5548),R=d(65401),F=d(82054),V=d(61256),H=d(16983),v=d(92794);const I=(0,y.Ue)();class Z{constructor(f){this.geometryInfo=f,this._boundsStore=new V.H,this._featuresById=new Map,this._markedIds=new Set,this.events=new w.Z,this.featureAdapter=v.n}get geometryType(){return this.geometryInfo.geometryType}get hasM(){return this.geometryInfo.hasM}get hasZ(){return this.geometryInfo.hasZ}get numFeatures(){return this._featuresById.size}get fullBounds(){return this._boundsStore.fullBounds}get storeStatistics(){let f=0;return this._featuresById.forEach(g=>{null!=g.geometry&&g.geometry.coords&&(f+=g.geometry.coords.length)}),{featureCount:this._featuresById.size,vertexCount:f/(this.hasZ?this.hasM?4:3:this.hasM?3:2)}}getFullExtent(f){if(null==this.fullBounds)return null;const[g,O,b,L]=this.fullBounds;return{xmin:g,ymin:O,xmax:b,ymax:L,spatialReference:(0,H.S2)(f)}}add(f){this._add(f),this._emitChanged()}addMany(f){for(const g of f)this._add(g);this._emitChanged()}upsertMany(f){const g=f.map(O=>this._upsert(O));return this._emitChanged(),g.filter(x.pC)}clear(){this._featuresById.clear(),this._boundsStore.clear(),this._emitChanged()}removeById(f){const g=this._featuresById.get(f);return g?(this._remove(g),this._emitChanged(),g):null}removeManyById(f){this._boundsStore.invalidateIndex();for(const g of f){const O=this._featuresById.get(g);O&&this._remove(O)}this._emitChanged()}forEachBounds(f,g){for(const O of f){const b=this._boundsStore.get(O.objectId);b&&g((0,y.JR)(I,b))}}getFeature(f){return this._featuresById.get(f)}has(f){return this._featuresById.has(f)}forEach(f){this._featuresById.forEach(g=>f(g))}forEachInBounds(f,g){this._boundsStore.forEachInBounds(f,O=>{g(this._featuresById.get(O))})}startMarkingUsedFeatures(){this._boundsStore.invalidateIndex(),this._markedIds.clear()}sweep(){let f=!1;this._featuresById.forEach((g,O)=>{this._markedIds.has(O)||(f=!0,this._remove(g))}),this._markedIds.clear(),f&&this._emitChanged()}_emitChanged(){this.events.emit("changed",void 0)}_add(f){if(!f)return;const g=f.objectId;if(null==g)return void U.Z.getLogger("esri.layers.graphics.data.FeatureStore").error(new m.Z("featurestore:invalid-feature","feature id is missing",{feature:f}));const O=this._featuresById.get(g);let b;if(this._markedIds.add(g),O?(f.displayId=O.displayId,b=this._boundsStore.get(g),this._boundsStore.delete(g)):null!=this.onFeatureAdd&&this.onFeatureAdd(f),!f.geometry?.coords?.length)return this._boundsStore.set(g,null),void this._featuresById.set(g,f);b=(0,F.$)(b??(0,R.Ue)(),f.geometry,this.geometryInfo.hasZ,this.geometryInfo.hasM),null!=b&&this._boundsStore.set(g,b),this._featuresById.set(g,f)}_upsert(f){const g=f?.objectId;if(null==g)return U.Z.getLogger("esri.layers.graphics.data.FeatureStore").error(new m.Z("featurestore:invalid-feature","feature id is missing",{feature:f})),null;const O=this._featuresById.get(g);if(!O)return this._add(f),f;this._markedIds.add(g);const{geometry:b,attributes:L}=f;for(const A in L)O.attributes[A]=L[A];return b&&(O.geometry=b,this._boundsStore.set(g,(0,F.$)((0,R.Ue)(),b,this.geometryInfo.hasZ,this.geometryInfo.hasM)??null)),O}_remove(f){null!=this.onFeatureRemove&&this.onFeatureRemove(f);const g=f.objectId;return this._markedIds.delete(g),this._boundsStore.delete(g),this._featuresById.delete(g),f}}},76391:(tt,Y,d)=>{function x(m){const w={};for(const U in m){if("declaredClass"===U)continue;const y=m[U];if(null!=y&&"function"!=typeof y)if(Array.isArray(y)){w[U]=[];for(let R=0;R<y.length;R++)w[U][R]=x(y[R])}else"object"==typeof y?y.toJSON&&(w[U]=JSON.stringify(y)):w[U]=y}return w}d.d(Y,{A:()=>x})},20477:(tt,Y,d)=>{d.d(Y,{Ev:()=>L,JT:()=>X,Vn:()=>z,Vr:()=>G,hH:()=>A,n7:()=>b,qp:()=>g});var x=d(15861),m=d(84792),w=d(21726),U=d(91179),y=d(93555),R=d(37053),F=d(76391),V=d(85262),H=d(61515);const v="Layer does not support extent calculation.";function Z(l,s){const r=l.geometry,n=l.toJSON();delete n.compactGeometryEnabled,delete n.defaultSpatialReferenceEnabled;const a=n;let h,p,E;if(null!=r&&(p=r.spatialReference,E=(0,R.B9)(p),a.geometryType=(0,U.Ji)(r),a.geometry=function I(l,s){if(s&&"extent"===l.type)return`${l.xmin},${l.ymin},${l.xmax},${l.ymax}`;if(s&&"point"===l.type)return`${l.x},${l.y}`;const r=l.toJSON();return delete r.spatialReference,JSON.stringify(r)}(r,l.compactGeometryEnabled),a.inSR=E),n.groupByFieldsForStatistics&&(a.groupByFieldsForStatistics=n.groupByFieldsForStatistics.join(",")),n.objectIds&&(a.objectIds=n.objectIds.join(",")),n.orderByFields&&(a.orderByFields=n.orderByFields.join(",")),!n.outFields||!n.returnDistinctValues&&(s?.returnCountOnly||s?.returnExtentOnly||s?.returnIdsOnly)?delete a.outFields:a.outFields=n.outFields.includes("*")?"*":n.outFields.join(","),n.outSR?(a.outSR=(0,R.B9)(n.outSR),h=l.outSpatialReference):r&&(n.returnGeometry||n.returnCentroid)&&(a.outSR=a.inSR,h=p),n.returnGeometry&&delete n.returnGeometry,n.outStatistics&&(a.outStatistics=JSON.stringify(n.outStatistics)),n.fullText&&(a.fullText=JSON.stringify(n.fullText)),n.pixelSize&&(a.pixelSize=JSON.stringify(n.pixelSize)),n.quantizationParameters&&(l.defaultSpatialReferenceEnabled&&null!=p&&null!=l.quantizationParameters?.extent&&p.equals(l.quantizationParameters.extent.spatialReference)&&delete n.quantizationParameters.extent.spatialReference,a.quantizationParameters=JSON.stringify(n.quantizationParameters)),n.parameterValues&&(a.parameterValues=JSON.stringify(n.parameterValues)),n.rangeValues&&(a.rangeValues=JSON.stringify(n.rangeValues)),n.dynamicDataSource&&(a.layer=JSON.stringify({source:n.dynamicDataSource}),delete n.dynamicDataSource),n.timeExtent){const S=n.timeExtent,{start:P,end:c}=S;null==P&&null==c||(a.time=P===c?P:`${P??"null"},${c??"null"}`),delete n.timeExtent}return l.defaultSpatialReferenceEnabled&&null!=p&&null!=h&&p.equals(h)&&(a.defaultSR=a.inSR,delete a.inSR,delete a.outSR),a}function X(l,s,r,n){return f.apply(this,arguments)}function f(){return(f=(0,x.Z)(function*(l,s,r,n){const a=null!=s.timeExtent&&s.timeExtent.isEmpty?{data:{features:[]}}:yield z(l,s,"json",n);return(0,H.p)(s,r,a.data),a})).apply(this,arguments)}function g(l,s,r,n){return O.apply(this,arguments)}function O(){return(O=(0,x.Z)(function*(l,s,r,n){if(null!=s.timeExtent&&s.timeExtent.isEmpty)return{data:r.createFeatureResult()};const a=yield b(l,s,n),h=a;return h.data=(0,V.C)(a.data,r),h})).apply(this,arguments)}function b(l,s,r){return z(l,s,"pbf",r)}function L(l,s,r){return null!=s.timeExtent&&s.timeExtent.isEmpty?Promise.resolve({data:{objectIds:[]}}):z(l,s,"json",r,{returnIdsOnly:!0})}function A(l,s,r){return null!=s.timeExtent&&s.timeExtent.isEmpty?Promise.resolve({data:{count:0}}):z(l,s,"json",r,{returnIdsOnly:!0,returnCountOnly:!0})}function G(l,s,r){return $.apply(this,arguments)}function $(){return($=(0,x.Z)(function*(l,s,r){if(null!=s.timeExtent&&s.timeExtent.isEmpty)return{data:{count:0,extent:null}};const n=yield z(l,s,"json",r,{returnExtentOnly:!0,returnCountOnly:!0}),a=n.data;if(a.hasOwnProperty("extent"))return n;if(a.features)throw new Error(v);if(a.hasOwnProperty("count"))throw new Error(v);return n})).apply(this,arguments)}function z(l,s,r){return W.apply(this,arguments)}function W(){return(W=(0,x.Z)(function*(l,s,r,n={},a={}){const h="string"==typeof l?(0,w.mN)(l):l,p=s.geometry?[s.geometry]:[],S=(yield(0,y.aX)(p,null,{signal:n.signal}))?.[0];null!=S&&((s=s.clone()).geometry=S);const P=(0,F.A)({...h.query,f:r,...a,...Z(s,a)});return(0,m.Z)((0,w.v_)(h.path,function K(l,s){return null!=l.formatOf3DObjects&&!(s.returnCountOnly||s.returnExtentOnly||s.returnIdsOnly)}(s,a)?"query3d":"query"),{...n,responseType:"pbf"===r?"array-buffer":"json",query:{...P,...n.query}})})).apply(this,arguments)}},86354:(tt,Y,d)=>{d.r(Y),d.d(Y,{default:()=>xt});var x=d(15861),m=d(17626),U=(d(29132),d(61885)),y=d(10699),R=d(32917),F=d(77712),H=(d(8314),d(63290)),I=(d(4619),d(76898)),Z=d(11426),X=d(65234),f=d(3579),g=d(73771),O=d(2584),b=d(96854),L=d(82706),A=d(17936),G=d(1520),$=d(83010),z=d(83761),W=d(85931);let K=class extends z.Z{constructor(){super(...arguments),this.updating=!1,this._pending=[]}push(t,e){this._pending.push({promise:t,callback:e}),1===this._pending.length&&this._process()}_process(){if(!this._pending.length)return void(this.updating=!1);this.updating=!0;const t=this._pending[0];t.promise.then(e=>t.callback(e)).catch(()=>{}).then(()=>{this._pending.shift(),this._process()})}};(0,m._)([(0,F.Cb)()],K.prototype,"updating",void 0),K=(0,m._)([(0,I.j)("esri.core.AsyncSequence")],K);var c,t,l=d(59213),s=d(54024),r=d(28862),n=d(2004),a=d(65401),h=d(82054),p=d(38305),E=d(98558),S=d(20477);class P{constructor(e,i){this.data=e,this.resolution=i,this.state={type:c.CREATED},this.alive=!0}process(e){switch(this.state.type){case c.CREATED:return this.state=this._gotoFetchCount(this.state,e),this.state.task.promise.then(e.resume,e.resume);case c.FETCH_COUNT:break;case c.FETCHED_COUNT:return this.state=this._gotoFetchFeatures(this.state,e),this.state.task.promise.then(e.resume,e.resume);case c.FETCH_FEATURES:break;case c.FETCHED_FEATURES:this.state=this._goToDone(this.state,e)}return null}get debugInfo(){return{data:this.data,featureCount:this._featureCount,state:this._stateToString}}get _featureCount(){switch(this.state.type){case c.CREATED:case c.FETCH_COUNT:return 0;case c.FETCHED_COUNT:return this.state.featureCount;case c.FETCH_FEATURES:return this.state.previous.featureCount;case c.FETCHED_FEATURES:return this.state.features.length;case c.DONE:return this.state.previous.features.length}}get _stateToString(){switch(this.state.type){case c.CREATED:return"created";case c.FETCH_COUNT:return"fetch-count";case c.FETCHED_COUNT:return"fetched-count";case c.FETCH_FEATURES:return"fetch-features";case c.FETCHED_FEATURES:return"fetched-features";case c.DONE:return"done"}}_gotoFetchCount(e,i){var o=this;return{type:c.FETCH_COUNT,previous:e,task:(0,l.vr)(function(){var u=(0,x.Z)(function*(_){const C=yield(0,l.mt)(i.fetchCount(o,_));o.state.type===c.FETCH_COUNT&&(o.state=o._gotoFetchedCount(o.state,C.ok?C.value:1/0))});return function(_){return u.apply(this,arguments)}}())}}_gotoFetchedCount(e,i){return{type:c.FETCHED_COUNT,featureCount:i,previous:e}}_gotoFetchFeatures(e,i){var o=this;return{type:c.FETCH_FEATURES,previous:e,task:(0,l.vr)(function(){var u=(0,x.Z)(function*(_){const C=yield(0,l.mt)(i.fetchFeatures(o,e.featureCount,_));o.state.type===c.FETCH_FEATURES&&(o.state=o._gotoFetchedFeatures(o.state,C.ok?C.value:[]))});return function(_){return u.apply(this,arguments)}}())}}_gotoFetchedFeatures(e,i){return{type:c.FETCHED_FEATURES,previous:e,features:i}}_goToDone(e,i){return i.finish(this,e.features),{type:c.DONE,previous:e}}reset(){const e=this.state;switch(this.state={type:c.CREATED},e.type){case c.CREATED:case c.FETCHED_COUNT:case c.FETCHED_FEATURES:case c.DONE:break;case c.FETCH_COUNT:case c.FETCH_FEATURES:e.task.abort()}}intersects(e){return null==e||!this.data.extent||((0,a.oJ)(e,j),(0,a.kK)(this.data.extent,j))}}(t=c||(c={}))[t.CREATED=0]="CREATED",t[t.FETCH_COUNT=1]="FETCH_COUNT",t[t.FETCHED_COUNT=2]="FETCHED_COUNT",t[t.FETCH_FEATURES=3]="FETCH_FEATURES",t[t.FETCHED_FEATURES=4]="FETCHED_FEATURES",t[t.DONE=5]="DONE";const j=(0,a.Ue)();let T=class extends z.Z{get _minimumVerticesPerFeature(){switch(this.store?.featureStore.geometryType){case"esriGeometryPoint":case"esriGeometryMultipoint":return 1;case"esriGeometryPolygon":return 4;case"esriGeometryPolyline":return 2}}get _mandatoryOutFields(){const t=new Set;return this.objectIdField&&t.add(this.objectIdField),this.globalIdField&&t.add(this.globalIdField),t}set outFields(t){const e=this._get("outFields"),i=(0,r.G0)(t,this._mandatoryOutFields);(0,r.fS)(i,e)||(this._set("outFields",i),(0,r.ik)(i,e)||this.refresh())}get outFields(){return this._get("outFields")??this._mandatoryOutFields}set filter(t){const e=this._get("filter"),i=this._filterProperties(t);JSON.stringify(e)!==JSON.stringify(i)&&this._set("filter",i)}set customParameters(t){const e=this._get("customParameters");JSON.stringify(e)!==JSON.stringify(t)&&this._set("customParameters",t)}get _configuration(){return{filter:this.filter,customParameters:this.customParameters,tileInfo:this.tileInfo,tileSize:this.tileSize}}set tileInfo(t){const e=this._get("tileInfo");e!==t&&(null!=t&&null!=e&&JSON.stringify(t)===JSON.stringify(e)||(this._set("tileInfo",t),this.store.tileInfo=t))}set tileSize(t){this._get("tileSize")!==t&&this._set("tileSize",t)}get updating(){return this.updatingExcludingEdits||this._pendingEdits.updating}get updatingExcludingEdits(){return this._updatingHandles.updating}get hasZ(){return this.store.featureStore.hasZ}constructor(t){super(t),this.suspended=!0,this.tilesOfInterest=[],this.availability=0,this._pendingTiles=new Map,this._updatingHandles=new Z.R,this._pendingEdits=new K,this._pendingEditsAbortController=new AbortController}initialize(){this._initializeFetchExtent(),this._updatingHandles.add(()=>this._configuration,()=>this.refresh()),this._updatingHandles.add(()=>this.tilesOfInterest,(t,e)=>{(0,W.fS)(t,e,({id:i},{id:o})=>i===o)||this._process()},R.Z_),this.addHandles((0,R.gx)(()=>!this.suspended,()=>this._process()))}destroy(){this._pendingTiles.forEach(t=>this._deletePendingTile(t)),this._pendingTiles.clear(),this.store.destroy(),this.tilesOfInterest.length=0,this._pendingEditsAbortController.abort(),this._pendingEditsAbortController=null,this._updatingHandles.destroy()}refresh(){this.store.refresh(),this._pendingTiles.forEach(t=>this._deletePendingTile(t)),this._process()}applyEdits(t){var e=this;this._pendingEdits.push(t,function(){var i=(0,x.Z)(function*(o){if(0===o.addedFeatures.length&&0===o.updatedFeatures.length&&0===o.deletedFeatures.length)return;for(const[,_]of e._pendingTiles)_.reset();const u={...o,deletedFeatures:o.deletedFeatures.map(({objectId:_,globalId:C})=>_&&-1!==_?_:e._lookupObjectIdByGlobalId(C))};yield e._updatingHandles.addPromise(e.store.processEdits(u,(_,C)=>e._queryFeaturesById(_,C),e._pendingEditsAbortController.signal)),e._processPendingTiles()});return function(o){return i.apply(this,arguments)}}())}_initializeFetchExtent(){var t=this;if(!this.capabilities.query.supportsExtent||!(0,p.M8)(this.url))return;const e=(0,l.vr)(function(){var i=(0,x.Z)(function*(o){try{const u=yield(0,S.Vr)(t.url,new b.Z({where:"1=1",outSpatialReference:t.spatialReference,cacheHint:t.capabilities.query.supportsCacheHint??void 0}),{query:t._configuration.customParameters,signal:o});t.store.extent=n.Z.fromJSON(u.data?.extent)}catch(u){(0,y.r9)(u),H.Z.getLogger(t).warn("Failed to fetch data extent",u)}});return function(o){return i.apply(this,arguments)}}());this._updatingHandles.addPromise(e.promise.then(()=>this._process())),this.addHandles((0,s.kB)(()=>e.abort()))}get debugInfo(){return{numberOfFeatures:this.store.featureStore.numFeatures,tilesOfInterest:this.tilesOfInterest,pendingTiles:Array.from(this._pendingTiles.values()).map(t=>t.debugInfo),storedTiles:this.store.debugInfo}}_process(){this._markTilesNotAlive(),this._createPendingTiles(),this._deletePendingTiles(),this._processPendingTiles()}_markTilesNotAlive(){for(const[,t]of this._pendingTiles)t.alive=!1}_createPendingTiles(){if(this.suspended)return;const t=this._collectMissingTilesInfo();if(this._setAvailability(null==t?1:t.coveredArea/t.fullArea),null!=t)for(const{data:e,resolution:i}of t.missingTiles){const o=this._pendingTiles.get(e.id);o?(o.resolution=i,o.alive=!0):this._createPendingTile(e,i)}}_collectMissingTilesInfo(){let t=null;for(let e=this.tilesOfInterest.length-1;e>=0;e--){const o=this.store.process(this.tilesOfInterest[e],(u,_)=>this._verifyTileComplexity(u,_),this.outFields);null==t?t=o:t.prepend(o)}return t}_deletePendingTiles(){for(const[,t]of this._pendingTiles)t.alive||this._deletePendingTile(t)}_processPendingTiles(){const t={fetchCount:(e,i)=>this._fetchCount(e,i),fetchFeatures:(e,i,o)=>this._fetchFeatures(e,i,o),finish:(e,i)=>this._finishPendingTile(e,i),resume:()=>this._processPendingTiles()};if(this._ensureFetchAllCounts(t))for(const[,e]of this._pendingTiles)this._verifyTileComplexity(this.store.getFeatureCount(e.data),e.resolution)&&this._updatingHandles.addPromise(e.process(t))}_verifyTileComplexity(t,e){return this._verifyVertexComplexity(t)&&this._verifyFeatureDensity(t,e)}_verifyVertexComplexity(t){return t*this._minimumVerticesPerFeature<at}_verifyFeatureDensity(t,e){if(null==this.tileInfo)return!1;const i=this.tileSize*e;return t*(lt/(i*i))<ut}_ensureFetchAllCounts(t){let e=!0;for(const[,i]of this._pendingTiles)i.state.type<c.FETCHED_COUNT&&this._updatingHandles.addPromise(i.process(t)),i.state.type<=c.FETCH_COUNT&&(e=!1);return e}_finishPendingTile(t,e){this.store.add(t.data,e),this._deletePendingTile(t),this._updateAvailability()}_updateAvailability(){const t=this._collectMissingTilesInfo();this._setAvailability(null==t?1:t.coveredArea/t.fullArea)}_setAvailability(t){this._set("availability",t)}_createPendingTile(t,e){const i=new P(t,e);return this._pendingTiles.set(t.id,i),i}_deletePendingTile(t){t.reset(),this._pendingTiles.delete(t.data.id)}_fetchCount(t,e){var i=this;return(0,x.Z)(function*(){return i.store.fetchCount(t.data,i.url,i._createCountQuery(t),{query:i.customParameters,timeout:st,signal:e})})()}_fetchFeatures(t,e,i){var o=this;return(0,x.Z)(function*(){let u=0;const _=[];let C=0,B=e;for(;;){const M=o._createFeaturesQuery(t),D=o._setPagingParameters(M,u,B),{features:N,exceededTransferLimit:et}=yield o._queryFeatures(M,i);D&&(u+=M.num),C+=N.length;for(const Ct of N)_.push(Ct);if(B=e-C,!D||!et||B<=0)return _}})()}_filterProperties(t){return null==t?{where:"1=1",gdbVersion:void 0,timeExtent:void 0}:{where:t.where||"1=1",timeExtent:t.timeExtent,gdbVersion:t.gdbVersion}}_lookupObjectIdByGlobalId(t){const e=this.globalIdField,i=this.objectIdField;if(null==e)throw new Error("Expected globalIdField to be defined");let o=null;if(this.store.featureStore.forEach(u=>{t===u.attributes[e]&&(o=u.objectId??u.attributes[i])}),null==o)throw new Error(`Expected to find a feature with globalId ${t}`);return o}_queryFeaturesById(t,e){const i=this._createFeaturesQuery();return i.objectIds=t,this._queryFeatures(i,e)}_queryFeatures(t,e){return this.capabilities.query.supportsFormatPBF?this._queryFeaturesPBF(t,e):this._queryFeaturesJSON(t,e)}_queryFeaturesPBF(t,e){var i=this;return(0,x.Z)(function*(){const{sourceSpatialReference:o}=i,{data:u}=yield(0,S.qp)(i.url,t,new E.J({sourceSpatialReference:o}),{query:i._configuration.customParameters,timeout:st,signal:e});return(0,h.lM)(u)})()}_queryFeaturesJSON(t,e){var i=this;return(0,x.Z)(function*(){const{sourceSpatialReference:o}=i,{data:u}=yield(0,S.JT)(i.url,t,o,{query:i._configuration.customParameters,timeout:st,signal:e});return(0,h.h_)(u,i.objectIdField)})()}_createCountQuery(t){const e=this._createBaseQuery(t);return this.capabilities.query.supportsCacheHint&&(e.cacheHint=!0),e}_createFeaturesQuery(t=null){const e=this._createBaseQuery(t),i=null!=t?.data?this.store.getAttributesForTile(t?.data?.id):null,o=(0,r.G0)((0,r.e5)(this.outFields,i??new Set),this._mandatoryOutFields);return e.outFields=Array.from(o),e.returnGeometry=!0,null!=t&&(this.capabilities.query.supportsResultType?e.resultType="tile":this.capabilities.query.supportsCacheHint&&(e.cacheHint=!0)),e}_createBaseQuery(t){const e=new b.Z({returnZ:this.hasZ,returnM:!1,geometry:null!=this.tileInfo&&null!=t?(0,a.HH)(t.data.extent,this.tileInfo.spatialReference):void 0}),i=this._configuration.filter;return null!=i&&(e.where=i.where,e.gdbVersion=i.gdbVersion,e.timeExtent=i.timeExtent),e.outSpatialReference=this.spatialReference,e}_setPagingParameters(t,e,i){if(!this.capabilities.query.supportsPagination)return!1;const{supportsMaxRecordCountFactor:o,supportsCacheHint:u,tileMaxRecordCount:_,maxRecordCount:C,supportsResultType:B}=this.capabilities.query,M=o?b.Z.MAX_MAX_RECORD_COUNT_FACTOR:1,D=M*((B||u)&&_?_:C||it);return t.start=e,o?(t.maxRecordCountFactor=Math.min(M,Math.ceil(i/D)),t.num=Math.min(i,t.maxRecordCountFactor*D)):t.num=Math.min(i,D),!0}};(0,m._)([(0,F.Cb)({constructOnly:!0})],T.prototype,"url",void 0),(0,m._)([(0,F.Cb)({constructOnly:!0})],T.prototype,"objectIdField",void 0),(0,m._)([(0,F.Cb)({constructOnly:!0})],T.prototype,"globalIdField",void 0),(0,m._)([(0,F.Cb)({constructOnly:!0})],T.prototype,"capabilities",void 0),(0,m._)([(0,F.Cb)({constructOnly:!0})],T.prototype,"sourceSpatialReference",void 0),(0,m._)([(0,F.Cb)({constructOnly:!0})],T.prototype,"spatialReference",void 0),(0,m._)([(0,F.Cb)({constructOnly:!0})],T.prototype,"store",void 0),(0,m._)([(0,F.Cb)({readOnly:!0})],T.prototype,"_minimumVerticesPerFeature",null),(0,m._)([(0,F.Cb)()],T.prototype,"_mandatoryOutFields",null),(0,m._)([(0,F.Cb)()],T.prototype,"outFields",null),(0,m._)([(0,F.Cb)()],T.prototype,"suspended",void 0),(0,m._)([(0,F.Cb)()],T.prototype,"filter",null),(0,m._)([(0,F.Cb)()],T.prototype,"customParameters",null),(0,m._)([(0,F.Cb)({readOnly:!0})],T.prototype,"_configuration",null),(0,m._)([(0,F.Cb)()],T.prototype,"tileInfo",null),(0,m._)([(0,F.Cb)()],T.prototype,"tileSize",null),(0,m._)([(0,F.Cb)()],T.prototype,"tilesOfInterest",void 0),(0,m._)([(0,F.Cb)({readOnly:!0})],T.prototype,"updating",null),(0,m._)([(0,F.Cb)({readOnly:!0})],T.prototype,"updatingExcludingEdits",null),(0,m._)([(0,F.Cb)({readOnly:!0})],T.prototype,"availability",void 0),(0,m._)([(0,F.Cb)()],T.prototype,"hasZ",null),T=(0,m._)([(0,I.j)("esri.views.interactive.snapping.featureSources.featureServiceSource.FeatureServiceTiledFetcher")],T);const it=2e3,st=6e5,at=1e6,lt=25,ut=1;var nt=d(27306),dt=d(41844),ht=d(61256),ct=d(68511);class _t{constructor(){this._store=new Map,this._byteSize=0}set(e,i){this.delete(e),this._store.set(e,i),this._byteSize+=i.byteSize}delete(e){const i=this._store.get(e);return!!this._store.delete(e)&&(null!=i&&(this._byteSize-=i.byteSize),!0)}get(e){return this._used(e),this._store.get(e)}has(e){return this._used(e),this._store.has(e)}clear(){this._store.clear()}applyByteSizeLimit(e,i){for(const[o,u]of this._store){if(this._byteSize<=e)break;this.delete(o),i(u)}}values(){return this._store.values()}[Symbol.iterator](){return this._store[Symbol.iterator]()}_used(e){const i=this._store.get(e);i&&(this._store.delete(e),this._store.set(e,i))}}let Q=class extends z.Z{constructor(t){super(t),this.tileInfo=null,this.extent=null,this.maximumByteSize=10*dt.Y.MEGABYTES,this._tileBounds=new ht.H,this._tiles=new _t,this._refCounts=new Map,this._tileFeatureCounts=new Map,this._tmpBoundingRect=(0,a.Ue)()}add(t,e){for(const u of e)this._referenceFeature(u.objectId);const i=this.featureStore.upsertMany(e),o=i.map(u=>new Set(Object.keys(u.attributes))).reduce((u,_)=>(0,r.jV)(u,_),new Set(Object.keys(i[0]?.attributes??[])));this._addTileStorage(t,new Set(i.map(u=>u.objectId)),function ft(t){return t.reduce((e,i)=>e+function pt(t){return 32+function gt(t){if(null==t)return 0;const e=(0,nt.do)(t.lengths,4);return 32+(0,nt.do)(t.coords,8)+e}(t.geometry)+(0,nt.f2)(t.attributes)}(i),0)}(i),o),this._tiles.applyByteSizeLimit(this.maximumByteSize,u=>this._removeTileStorage(u))}getAttributesForTile(t){return t?this._tiles.get(t)?.attributeKeys:null}destroy(){this.clear(),this._tileFeatureCounts.clear()}clear(){this.featureStore.clear(),this._tileBounds.clear(),this._tiles.clear(),this._refCounts.clear()}refresh(){this.clear(),this._tileFeatureCounts.clear()}processEdits(t,e,i){return this._processEditsDelete(t.deletedFeatures.concat(t.updatedFeatures)),this._processEditsRefetch(t.addedFeatures.concat(t.updatedFeatures),e,i)}_addTileStorage(t,e,i,o){const u=t.id;this._tiles.set(u,new mt(t,e,i,o)),this._tileBounds.set(u,t.extent),this._tileFeatureCounts.set(u,e.size)}_remove({id:t}){const e=this._tiles.get(t);e&&this._removeTileStorage(e)}_removeTileStorage(t){const e=[];for(const o of t.objectIds)this._unreferenceFeature(o)===k.REMOVED&&e.push(o);this.featureStore.removeManyById(e);const i=t.data.id;this._tiles.delete(i),this._tileBounds.delete(i)}_processEditsDelete(t){this.featureStore.removeManyById(t);for(const[,e]of this._tiles){for(const i of t)e.objectIds.delete(i);this._tileFeatureCounts.set(e.data.id,e.objectIds.size)}for(const e of t)this._refCounts.delete(e)}_processEditsRefetch(t,e,i){var o=this;return(0,x.Z)(function*(){const u=(yield e(t,i)).features,{hasZ:_,hasM:C}=o.featureStore;for(const B of u){const M=(0,h.$)(o._tmpBoundingRect,B.geometry,_,C);null!=M&&o._tileBounds.forEachInBounds(M,D=>{const N=o._tiles.get(D);o.featureStore.add(B);const et=B.objectId;N.objectIds.has(et)||(N.objectIds.add(et),o._referenceFeature(et),o._tileFeatureCounts.set(N.data.id,N.objectIds.size))})}})()}process(t,e=(()=>!0),i){if(null==this.tileInfo||!t.extent||null!=this.extent&&!(0,a.kK)((0,a.oJ)(this.extent,this._tmpBoundingRect),t.extent))return new rt(t);const o=this.getAttributesForTile(t.id);if((0,r.ik)(i,o))return new rt(t);const u=this._createTileTree(t,this.tileInfo);return this._simplify(u,e,null,0,1),this._collectMissingTiles(t,u,this.tileInfo,i)}get debugInfo(){return Array.from(this._tiles.values()).map(({data:t})=>({data:t,featureCount:this._tileFeatureCounts.get(t.id)||0}))}getFeatureCount(t){return this._tileFeatureCounts.get(t.id)??0}fetchCount(t,e,i,o){var u=this;return(0,x.Z)(function*(){const _=u._tileFeatureCounts.get(t.id);if(null!=_)return _;const C=yield(0,S.hH)(e,i,o);return u._tileFeatureCounts.set(t.id,C.data.count),C.data.count})()}_createTileTree(t,e){const i=new ot(t.level,t.row,t.col);return e.updateTileInfo(i,O.Z.ExtrapolateOptions.POWER_OF_TWO),this._tileBounds.forEachInBounds(t.extent,o=>{const u=this._tiles.get(o)?.data;u&&this._tilesAreRelated(t,u)&&this._populateChildren(i,u,e,this._tileFeatureCounts.get(u.id)||0)}),i}_tilesAreRelated(t,e){if(!t||!e)return!1;if(t.level===e.level)return t.row===e.row&&t.col===e.col;const i=t.level<e.level,o=i?t:e,u=i?e:t,_=1<<u.level-o.level;return Math.floor(u.row/_)===o.row&&Math.floor(u.col/_)===o.col}_populateChildren(t,e,i,o){const u=e.level-t.level-1;if(u<0)return void(t.isLeaf=!0);const _=e.row>>u,C=e.col>>u,M=C-(t.col<<1)+(_-(t.row<<1)<<1),D=t.children[M];if(null!=D)this._populateChildren(D,e,i,o);else{const N=new ot(t.level+1,_,C);i.updateTileInfo(N,O.Z.ExtrapolateOptions.POWER_OF_TWO),t.children[M]=N,this._populateChildren(N,e,i,o)}}_simplify(t,e,i,o,u){const _=u*u;if(t.isLeaf)return e(this.getFeatureCount(t),u)?0:(this._remove(t),null!=i&&(i.children[o]=null),_);const C=u/2,B=C*C;let M=0;for(let D=0;D<t.children.length;D++){const N=t.children[D];M+=null!=N?this._simplify(N,e,t,D,C):B}return 0===M?this._mergeChildren(t):1-M/_<Et&&(this._purge(t),null!=i&&(i.children[o]=null),M=_),M}_mergeChildren(t){const e=new Set;let i,o=0;this._forEachLeaf(t,u=>{const _=this._tiles.get(u.id);if(_){i=i?(0,r.jV)(i,_.attributeKeys):new Set(_.attributeKeys),o+=_.byteSize;for(const C of _.objectIds)e.has(C)||(e.add(C),this._referenceFeature(C));this._remove(u)}}),this._addTileStorage(t,e,o,i??new Set),t.isLeaf=!0,t.children[0]=t.children[1]=t.children[2]=t.children[3]=null,this._tileFeatureCounts.set(t.id,e.size)}_forEachLeaf(t,e){for(const i of t.children)null!=i&&(i.isLeaf?e(i):this._forEachLeaf(i,e))}_purge(t){if(null!=t)if(t.isLeaf)this._remove(t);else for(let e=0;e<t.children.length;e++)this._purge(t.children[e]),t.children[e]=null}_collectMissingTiles(t,e,i,o){const u=new yt(i,t,this.extent);return this._collectMissingTilesRecurse(e,u,1,o),u.info}_collectMissingTilesRecurse(t,e,i,o){const u=this.getAttributesForTile(t.id),_=u&&!(0,r.ik)(o,u);if(_&&e.addMissing(t.level,t.row,t.col,i),t.isLeaf)return;if(!t.hasChildren)return void(_||e.addMissing(t.level,t.row,t.col,i));const C=i/2;for(let B=0;B<t.children.length;B++){const M=t.children[B];null==M?e.addMissing(t.level+1,(t.row<<1)+((2&B)>>1),(t.col<<1)+(1&B),C):this._collectMissingTilesRecurse(M,e,C,o)}}_referenceFeature(t){const e=(this._refCounts.get(t)||0)+1;return this._refCounts.set(t,e),1===e?k.ADDED:k.UNCHANGED}_unreferenceFeature(t){const e=(this._refCounts.get(t)||0)-1;return 0===e?(this._refCounts.delete(t),k.REMOVED):(e>0&&this._refCounts.set(t,e),k.UNCHANGED)}get test(){return{tiles:Array.from(this._tiles.values()).map(t=>`${t.data.id}:[${Array.from(t.objectIds)}]`),featureReferences:Array.from(this._refCounts.keys()).map(t=>`${t}:${this._refCounts.get(t)}`)}}};(0,m._)([(0,F.Cb)({constructOnly:!0})],Q.prototype,"featureStore",void 0),(0,m._)([(0,F.Cb)()],Q.prototype,"tileInfo",void 0),(0,m._)([(0,F.Cb)()],Q.prototype,"extent",void 0),(0,m._)([(0,F.Cb)()],Q.prototype,"maximumByteSize",void 0),Q=(0,m._)([(0,I.j)("esri.views.interactive.snapping.featureSources.featureServiceSource.FeatureServiceTileStore")],Q);class mt{constructor(e,i,o,u){this.data=e,this.objectIds=i,this.byteSize=o,this.attributeKeys=u}}class ot{constructor(e,i,o){this.level=e,this.row=i,this.col=o,this.isLeaf=!1,this.extent=null,this.children=[null,null,null,null]}get hasChildren(){return!this.isLeaf&&(null!=this.children[0]||null!=this.children[1]||null!=this.children[2]||null!=this.children[3])}}class rt{constructor(e,i=[]){this.missingTiles=i,this.fullArea=0,this.coveredArea=0,this.fullArea=(0,a.SO)(e.extent),this.coveredArea=this.fullArea}prepend(e){this.missingTiles=e.missingTiles.concat(this.missingTiles),this.coveredArea+=e.coveredArea,this.fullArea+=e.fullArea}}class yt{constructor(e,i,o){this._tileInfo=e,this._extent=null,this.info=new rt(i),null!=o&&(this._extent=(0,a.oJ)(o))}addMissing(e,i,o,u){const _=new ct.f(null,e,i,o);this._tileInfo.updateTileInfo(_,O.Z.ExtrapolateOptions.POWER_OF_TWO),null==_.extent||null!=this._extent&&!(0,a.kK)(this._extent,_.extent)||(this.info.missingTiles.push({data:_,resolution:u}),this.info.coveredArea-=(0,a.SO)(_.extent))}}const Et=.18751;var k;!function(t){t[t.ADDED=0]="ADDED",t[t.REMOVED=1]="REMOVED",t[t.UNCHANGED=2]="UNCHANGED"}(k||(k={}));var vt=d(91179);let q=class extends U.Z.EventedAccessor{constructor(){var t;super(...arguments),t=this,this._isInitializing=!0,this.remoteClient=null,this._whenSetup=(0,y.hh)(),this._elevationAligner=(0,A.p)(),this._elevationFilter=(0,G.c)(),this._symbologyCandidatesFetcher=(0,$.k)(),this._updatingHandles=new Z.R,this._editsUpdatingHandles=new Z.R,this._pendingApplyEdits=new Map,this._alignPointsInFeatures=function(){var e=(0,x.Z)(function*(i,o){const u={query:i},_=yield t.remoteClient.invoke("alignElevation",u,{signal:o});return(0,y.k_)(o),_});return function(i,o){return e.apply(this,arguments)}}(),this._getSymbologyCandidates=function(){var e=(0,x.Z)(function*(i,o){const u={candidates:i,spatialReference:t._spatialReference.toJSON()},_=yield t.remoteClient.invoke("getSymbologyCandidates",u,{signal:o});return(0,y.k_)(o),_});return function(i,o){return e.apply(this,arguments)}}()}get updating(){return this.updatingExcludingEdits||this._editsUpdatingHandles.updating||this._featureFetcher.updating}get updatingExcludingEdits(){return this._featureFetcher.updatingExcludingEdits||this._isInitializing||this._updatingHandles.updating}destroy(){this._featureFetcher?.destroy(),this._queryEngine?.destroy(),this._featureStore?.clear()}setup(t){var e=this;return(0,x.Z)(function*(){if(e.destroyed)return{result:{}};const{geometryType:i,objectIdField:o,timeInfo:u,fieldsIndex:_}=t.serviceInfo,{hasZ:C}=t,B=X.Z.fromJSON(t.spatialReference);e._spatialReference=B,e._featureStore=new f.Z({...t.serviceInfo,hasZ:C,hasM:!1}),e._queryEngine=new g.q({spatialReference:t.spatialReference,featureStore:e._featureStore,geometryType:i,fieldsIndex:_,hasZ:C,hasM:!1,objectIdField:o,timeInfo:u}),e._featureFetcher=new T({store:new Q({featureStore:e._featureStore}),url:t.serviceInfo.url,objectIdField:t.serviceInfo.objectIdField,globalIdField:t.serviceInfo.globalIdField,capabilities:t.serviceInfo.capabilities,spatialReference:B,sourceSpatialReference:X.Z.fromJSON(t.serviceInfo.spatialReference),customParameters:t.configuration.customParameters});const M="3d"===t.configuration.viewType;return e._elevationAligner=(0,A.p)(M,{elevationInfo:null!=t.elevationInfo?L.Z.fromJSON(t.elevationInfo):null,alignPointsInFeatures:e._alignPointsInFeatures}),e._elevationFilter=(0,G.c)(M),e.addHandles([(0,R.YP)(()=>e._featureFetcher.availability,D=>e.emit("notify-availability",{availability:D}),R.Z_),(0,R.YP)(()=>e.updating,()=>e._notifyUpdating())]),e._whenSetup.resolve(),e._isInitializing=!1,e.configure(t.configuration)})()}configure(t){var e=this;return(0,x.Z)(function*(){return yield e._updatingHandles.addPromise(e._whenSetup.promise),e._updateFeatureFetcherConfiguration(t),J})()}setSuspended(t,e){var i=this;return(0,x.Z)(function*(){return yield i._updatingHandles.addPromise(i._whenSetup.promise),(0,y.k_)(e),i._featureFetcher.suspended=t,J})()}updateOutFields(t,e){var i=this;return(0,x.Z)(function*(){return yield i._updatingHandles.addPromise(i._whenSetup.promise),(0,y.k_)(e),i._featureFetcher.outFields=new Set(t??[]),J})()}fetchCandidates(t,e){var i=this;return(0,x.Z)(function*(){yield i._whenSetup.promise,(0,y.k_)(e);const o=function Ft(t){if(!t.filter)return{...t,query:{where:"1=1"}};const{distance:e,units:i,spatialRel:o,where:u,timeExtent:_,objectIds:C}=t.filter,B={geometry:t.filter.geometry?(0,vt.im)(t.filter.geometry):void 0,distance:e,units:i,spatialRel:o,timeExtent:_,objectIds:C,where:u??"1=1"};return{...t,query:B}}(t),u=e?.signal,_=yield i._queryEngine.executeQueryForSnapping(o,u);(0,y.k_)(u);const C=yield i._elevationAligner.alignCandidates(_.candidates,X.Z.fromJSON(t.point.spatialReference)??X.Z.WGS84,u);(0,y.k_)(u);const B=yield i._symbologyCandidatesFetcher.fetch(C,u);(0,y.k_)(u);const M=0===B.length?C:C.concat(B);return{result:{candidates:i._elevationFilter.filter(o,M)}}})()}updateTiles(t,e){var i=this;return(0,x.Z)(function*(){return yield i._updatingHandles.addPromise(i._whenSetup.promise),(0,y.k_)(e),i._featureFetcher.tileSize=t.tileSize,i._featureFetcher.tilesOfInterest=t.tiles,i._featureFetcher.tileInfo=null!=t.tileInfo?O.Z.fromJSON(t.tileInfo):null,J})()}refresh(t,e){var i=this;return(0,x.Z)(function*(){return yield i._updatingHandles.addPromise(i._whenSetup.promise),(0,y.k_)(e),i._featureFetcher.refresh(),J})()}whenNotUpdating(t,e){var i=this;return(0,x.Z)(function*(){return yield i._updatingHandles.addPromise(i._whenSetup.promise),(0,y.k_)(e),yield(0,R.N1)(()=>!i.updatingExcludingEdits,e),(0,y.k_)(e),J})()}getDebugInfo(t,e){var i=this;return(0,x.Z)(function*(){return(0,y.k_)(e),{result:i._featureFetcher.debugInfo}})()}beginApplyEdits(t,e){var i=this;return(0,x.Z)(function*(){i._updatingHandles.addPromise(i._whenSetup.promise),(0,y.k_)(e);const o=(0,y.hh)();return i._pendingApplyEdits.set(t.id,o),i._featureFetcher.applyEdits(o.promise),i._editsUpdatingHandles.addPromise(o.promise),J})()}endApplyEdits(t,e){var i=this;return(0,x.Z)(function*(){const o=i._pendingApplyEdits.get(t.id);return o&&o.resolve(t.edits),(0,y.k_)(e),J})()}notifyElevationSourceChange(t,e){var i=this;return(0,x.Z)(function*(){return i._elevationAligner.notifyElevationSourceChange(),J})()}notifySymbologyChange(t,e){var i=this;return(0,x.Z)(function*(){return i._symbologyCandidatesFetcher.notifySymbologyChange(),J})()}setSymbologySnappingSupported(t){var e=this;return(0,x.Z)(function*(){return e._symbologyCandidatesFetcher=(0,$.k)(t,e._getSymbologyCandidates),J})()}_updateFeatureFetcherConfiguration(t){this._featureFetcher.filter=null!=t.filter?b.Z.fromJSON(t.filter):null,this._featureFetcher.customParameters=t.customParameters}_notifyUpdating(){this.emit("notify-updating",{updating:this.updating})}};(0,m._)([(0,F.Cb)({readOnly:!0})],q.prototype,"updating",null),(0,m._)([(0,F.Cb)({readOnly:!0})],q.prototype,"updatingExcludingEdits",null),(0,m._)([(0,F.Cb)()],q.prototype,"_isInitializing",void 0),q=(0,m._)([(0,I.j)("esri.views.interactive.snapping.featureSources.featureServiceSource.FeatureServiceSnappingSourceWorker")],q);const xt=q,J={result:{}}}}]);