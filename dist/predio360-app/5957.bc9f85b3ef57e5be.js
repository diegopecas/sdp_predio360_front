"use strict";(self.webpackChunkpredio360_app=self.webpackChunkpredio360_app||[]).push([[5957,5611],{1956:(pe,G,r)=>{r.d(G,{P:()=>k,a:()=>A,b:()=>Ee,c:()=>he,g:()=>re});var u=r(21286),h=r(52113),j=r(74741),B=r(95470),$=r(15331),K=r(79800),E=r(29302),P=r(5548),L=r(52382),b=r(13934),N=r(78925),z=r(62952),y=r(19278),p=r(32181),d=r(95285),S=r(77739),g=r(17625),F=r(47205),ne=r(63123),R=r(22355),Y=r(16396);class k extends g.K{constructor(){super(...arguments),this.clipBox=(0,P.Ue)(P.gy),this.useFixedSizes=!1,this.useRealWorldSymbolSizes=!1,this.scaleFactor=1,this.minSizePx=0,this.size=0,this.sizePx=0}get fixedSize(){return this.drawScreenSpace?this.sizePx:this.size}get screenMinSize(){return this.useFixedSizes?0:this.minSizePx}get drawScreenSpace(){return this.useFixedSizes&&!this.useRealWorldSymbolSizes}}class A extends N.UT{constructor(w,ue,oe){super(w),this.origin=w,this.isLeaf=ue,this.splatSize=oe}}function he(T){const w=new R.kG,ue=T.output===b.H_.Color,oe=T.output===b.H_.LinearDepth,Ce=T.output===b.H_.Highlight,{vertex:ae,fragment:Re}=w;return w.include(N.f5,T),w.attributes.add(Y.T.POSITION,"vec3"),w.attributes.add(Y.T.COLOR,"vec3"),ae.uniforms.add(new F.K("modelView",(I,M)=>(0,h.Jp)(ge,M.camera.viewMatrix,(0,h.vc)(ge,I.origin))),new ne.g("proj",(I,M)=>M.camera.projectionMatrix),new p.q("screenMinMaxSize",(I,M,H)=>(0,B.t8)(xe,H.useFixedSizes?0:H.minSizePx*M.camera.pixelRatio,re(I.isLeaf)*M.camera.pixelRatio)),T.useFixedSizes?new d.A("pointScale",(I,M)=>(0,B.t8)(xe,I.fixedSize*M.camera.pixelRatio,M.camera.fullHeight)):new p.q("pointScale",(I,M,H)=>(0,B.t8)(xe,I.splatSize*H.scaleFactor*M.camera.pixelRatio,M.camera.fullHeight/M.camera.pixelRatio))),T.clippingEnabled?ae.uniforms.add(new S.B("clipMin",(I,M,H)=>(0,K.s)(fe,H.clipBox[0]-I.origin[0],H.clipBox[1]-I.origin[1],H.clipBox[2]-I.origin[2])),new S.B("clipMax",(I,M,H)=>(0,K.s)(fe,H.clipBox[3]-I.origin[0],H.clipBox[4]-I.origin[1],H.clipBox[5]-I.origin[2]))):(ae.constants.add("clipMin","vec3",[-u.F3,-u.F3,-u.F3]),ae.constants.add("clipMax","vec3",[u.F3,u.F3,u.F3])),oe?((0,L.Zu)(w),(0,L.bA)(w),w.varyings.add("depth","float")):T.output!==b.H_.Highlight&&w.varyings.add("vColor","vec3"),ae.code.add(g.H`
    void main(void) {
      // Move clipped points outside of clipspace
      if (position.x < clipMin.x || position.y < clipMin.y || position.z < clipMin.z ||
        position.x > clipMax.x || position.y > clipMax.y || position.z > clipMax.z) {
        gl_Position = vec4(0.0,0.0,0.0,2.0);
        gl_PointSize = 0.0;
        return;
      }

      if (rejectBySlice(position)) {
        gl_Position = vec4(0.0,0.0,0.0,2.0);
        gl_PointSize = 0.0;
        return;
      }

      // Position in camera space
      vec4 camera = modelView * vec4(position, 1.0);

      float pointSize = pointScale.x;
      vec4 position = proj * camera;
     ${T.drawScreenSize?g.H`
      float clampedScreenSize = pointSize;`:g.H`
      float pointRadius = 0.5 * pointSize;
      vec4 cameraOffset = camera + vec4(0.0, pointRadius, 0.0, 0.0);
      vec4 positionOffset = proj * cameraOffset;
      float radius = abs(positionOffset.y - position.y);
      float viewHeight = pointScale.y;
      // screen diameter = (2 * r / w) * (h / 2)
      float screenPointSize = (radius / position.w) * viewHeight;
      float clampedScreenSize = clamp(screenPointSize, screenMinMaxSize.x, screenMinMaxSize.y);
      // Shift towards camera, to move rendered point out of terrain i.e. to
      // the camera-facing end of the virtual point when considering it as a
      // 3D sphere.
      camera.xyz -= normalize(camera.xyz) * pointRadius * clampedScreenSize / screenPointSize;
      position = proj * camera;`}

     gl_PointSize = clampedScreenSize;
     gl_Position = position;

     ${oe?g.H`depth = calculateLinearDepth(nearFar, camera.z);`:""}
     ${ue?g.H`vColor = color;`:""}
    }
  `),Re.include(y.n,T),Ce&&w.include(z.bA,T),Re.code.add(g.H`
    void main(void) {
      vec2 vOffset = gl_PointCoord - vec2(0.5, 0.5);
      float r2 = dot(vOffset, vOffset);

      if (r2 > 0.25) {
        discard;
      }
      ${oe?g.H`fragColor = float2rgba(depth);`:""}
      ${Ce?g.H`outputHighlight();`:""}
      ${ue?g.H`fragColor = vec4(vColor, 1.0);`:""}
    }
  `),w}function re(T){return T?256:64}const ge=(0,j.Ue)(),fe=(0,E.Ue)(),xe=(0,$.Ue)(),Ee=Object.freeze(Object.defineProperty({__proto__:null,PointRendererDrawParameters:A,PointRendererPassParameters:k,build:he,getMaxPointSizeScreenspace:re},Symbol.toStringTag,{value:"Module"}))},19702:(pe,G,r)=>{r.d(G,{A:()=>z});var u=r(15861),h=r(17626),j=r(54024),B=r(10699),$=r(32917),K=r(77712),b=(r(8314),r(63290),r(4619),r(76898)),N=r(36947);const z=y=>{let p=class extends y{constructor(){super(...arguments),this.slicePlaneEnabled=!1,this.supportsHeightUnitConversion=!1}postscript(d){super.postscript(d),(0,N.qC)(this.layer)&&this.addResolvingPromise(this._validateHeightModelInfo())}_validateHeightModelInfo(){var d=this;return(0,u.Z)(function*(){const S=new AbortController,g=S.signal;d.addHandles((0,j.kB)(()=>S.abort())),yield(0,$.N1)(()=>d.view.defaultsFromMap?.heightModelInfoReady,g),(0,B.k_)(g);const F=(0,N.Wt)(d.layer,d.view.heightModelInfo,d.supportsHeightUnitConversion);if(F)throw F})()}canResume(){const d=this.layer&&"effectiveScaleRange"in this.layer?this.layer.effectiveScaleRange:null;return super.canResume()&&(!d?.minScale||!d.maxScale||d.minScale>=d.maxScale)}getSuspendInfo(){const d=super.getSuspendInfo(),S=this.layer&&"effectiveScaleRange"in this.layer?this.layer.effectiveScaleRange:null;return S&&S.minScale&&S.maxScale&&S.minScale<S.maxScale&&(d.outsideScaleRange=!0),d}};return(0,h._)([(0,K.Cb)()],p.prototype,"view",void 0),(0,h._)([(0,K.Cb)()],p.prototype,"slicePlaneEnabled",void 0),p=(0,h._)([(0,b.j)("esri.views.3d.layers.LayerView3D")],p),p}},5957:(pe,G,r)=>{r.r(G),r.d(G,{default:()=>$t});var u=r(15861),h=r(17626),j=r(85931),B=r(59213),$=r(46160),K=r(54024),E=r(63290),P=r(62208),L=r(10699),b=r(32917),N=r(23841),z=r(55713),y=r(16730),p=r(77712),S=(r(8314),r(76898)),g=r(79800),F=r(48310),ne=r(51707),R=r(5548),Y=r(65401),k=r(90014),A=r(41967),he=r(86219),re=r(26036),Ee=(r(50028),r(90336),r(68155),r(90194)),T=r(41291),w=r(29505),ue=r(19702),oe=r(46196);class Ce extends oe.W{constructor(t,i,s,n,o){super(t,i,-1,s,n),this.queue=o}}class ae{constructor(t,i,s,n){this.loading=t,this.indexLoading=i,this.processing=s,this.idleProcessing=n}}var Re=r(42930);class I extends Re.q{constructor(t){super("PointCloudWorker","transform",{transform:i=>this._getTransferList(i)},t)}_getTransferList(t){const i=[t.geometryBuffer];if(null!=t.primaryAttributeData&&t.primaryAttributeData.buffer&&i.push(t.primaryAttributeData.buffer),null!=t.modulationAttributeData&&t.modulationAttributeData.buffer&&i.push(t.modulationAttributeData.buffer),null!=t.filterAttributesData)for(const s of t.filterAttributesData)null!=s&&s.buffer&&i.push(s.buffer);for(const s of t.userAttributesData)s.buffer&&i.push(s.buffer);return i}}var M=r(42964);const De=[!1],q=[null],Ae=[!1],ee=[null];function Qe(e,t,i){let s=e;for(;s>0;){const n=t.indexOf(s);if(n>=0)return n;s=i.getParentId(s)}return t.indexOf(s)}function ht(e,t,i){const s=[t.remove[0]],n=[];for(;1===s.length;){const o=s.pop();n.length=0;for(let a=0;a<t.load.length;a++){let l=t.load[a],c=i.getParentId(l);for(;c!==o;)l=c,c=i.getParentId(l);let _=s.indexOf(l);_<0&&(_=s.length,s.push(l),n.push([])),n[_].push(t.load[a])}}t.load=s;for(let o=0;o<s.length;o++)n[o].length>1?e.push({remove:[s[o]],load:n[o]}):s[o]=n[o][0]}var ut=r(81863);class ct{constructor(t,i,s){this._pages=[],this.pageSize=0,this._nodeSR=t,this._renderSR=i,this._renderSRSphericalPCPF=(0,ut.rS)(i),this.pageSize=s}addPage(t,i,s=0){for(;this._pages.length<t;)this._pages.push(null);(function pt(e,t,i,s,n){for(let o=0;o<e.length;o++){const a=e[o];a.obb.transform(a.obbInRenderSR,t,i,s,n)}})(i,this._nodeSR,this._renderSR,s,this._renderSRSphericalPCPF),this._pages[t]={nodes:i,parents:new Uint32Array(this.pageSize)},function gt(e,t){const i=[0];for(;i.length;){const s=i.pop(),n=e[J(s,t)].nodes[ce(s,t)];for(let o=0;o<n.childCount;o++){const a=n.firstChild+o;null!=e[J(a,t)]&&(e[J(a,t)].parents[ce(a,t)]=s,i.push(a))}}}(this._pages,this.pageSize)}hasPage(t){return!!this._pages[t]}getNode(t){const i=this.pageSize;return this._pages[J(t,i)].nodes[ce(t,i)]}getRenderObb(t){const i=this.pageSize;return this._pages[J(t,i)].nodes[ce(t,i)].obbInRenderSR}setRenderObb(t,i){const s=this.pageSize;this._pages[J(t,s)].nodes[ce(t,s)].obbInRenderSR.copy(i)}getParentId(t){const i=this.pageSize;return this._pages[J(t,i)].parents[ce(t,i)]}hasNodes(t,i){const s=J(t,this.pageSize),n=J(t+i-1,this.pageSize);for(let o=s;o<=n;o++)if(null==this._pages[o])return!1;return!0}forEachNodeId(t){for(let i=0;i<this._pages.length;i++){const s=this._pages[i];if(s)for(let n=0;n<s.nodes.length;n++)t(i*this.pageSize+n)}}createVisibilityTraverse(){const t={index:this,queue:[],masks:[],tempAabb:(0,R.Ue)()};return(i,s)=>function _t(e,t,i){const s=e.index;if(!s.hasNodes(0,1))return;const n=e.queue;n.length=0,n.push(0);const o=e.masks;for(o.length=0,o.push(0);n.length>0;){const a=n.pop();let l=o.pop();const c=s.getNode(a),_=s.getRenderObb(a);let m=!0;if(null!=t.clippingBox){const x=1<<t.frustum.length;!(l&x)&&(_.toAaBoundingBox(e.tempAabb),(0,R.r3)(t.clippingBox,e.tempAabb)?l|=x:(0,R.kK)(t.clippingBox,e.tempAabb)||(m=!1))}for(let x=0;x<t.frustum.length&&m;x++){const C=1<<x;if(!(l&C)){const v=_.intersectPlane(t.frustum[x]);v>0?m=!1:v<0&&(l|=C)}}if(i.predicate(a,c,m)){const x=c.firstChild,C=c.childCount;let v=!1;const D=J(x,s.pageSize),V=J(x+C-1,s.pageSize);for(let O=D;O<=V;O++)if(!s.hasPage(O)){i.pageMiss(a,O),v=!0;break}if(!v)for(let O=0;O<C;O++)n.push(x+O),o.push(l)}}}(t,i,s)}}function J(e,t){return e/t|0}function ce(e,t){return e%t}function Ze(e){const t=e.renderer,i=t?.type,s=t?.toJSON()??null;let n=null,o=!1;const a=e.attributeStorageInfo;"point-cloud-unique-value"===i||"point-cloud-stretch"===i||"point-cloud-class-breaks"===i?n=me(a,t.field):"point-cloud-rgb"===i?(n=Xe(a,t.field),o=null!=n):(n=Xe(a,"RGB"),o=null!=n);let l=null;return t?.colorModulation&&(l=me(a,t.colorModulation.field)),{rendererJSON:s,isRGBRenderer:o,primaryAttribute:n,modulationAttribute:l}}function $e(e){const t=e.filters;return t?t.map(i=>({filterJSON:i.toJSON(),attributeInfo:me(e.attributeStorageInfo,i.field)})):[]}function Je(e){const t=e?.pointSizeAlgorithm;return t&&"fixed-size"===t.type?t:null}function Xe(e,t){for(const i of e??[])if(i.name===t&&null!=i.attributeValues&&"UInt8"===i.attributeValues.valueType&&3===i.attributeValues.valuesPerElement)return{name:t,storageInfo:i,useElevation:!1};return null}function me(e,t){for(const i of e??[])if(i.name===t){const s="embedded-elevation"===i.encoding;return s?{name:t,storageInfo:null,useElevation:s}:{name:t,storageInfo:i,useElevation:s}}return"elevation"===t?.toLowerCase()?{name:t,storageInfo:null,useElevation:!0}:null}var Ue=r(14471),vt=r(88879);r(4619);let ve=class extends vt.Z{constructor(e){super(e),this.pointCloudMetadata=null}};(0,h._)([(0,p.Cb)({constructOnly:!0,clonable:"reference"})],ve.prototype,"pointCloudMetadata",void 0),ve=(0,h._)([(0,S.j)("esri.views.3d.layers.i3s.PointGraphic")],ve);var Pt=r(77029),Pe=r(29302),yt=r(63657),St=r(70562),bt=r(77926),xt=r(42743),Et=r(7167);class Ct{constructor(t){this._context=t,this._highlights=new Set}get empty(){return 0===this._highlights.size}destroy(){this._highlights=null}add(t){const i=new Rt(t);return this._highlights.add(i),this._enableSet(i),(0,K.kB)(()=>this._removeSet(i))}_removeSet(t){this._disableSet(t),this._highlights.delete(t)}_enableSet(t){t.enabled||(t.enabled=!0,this._context.forEachNode(i=>this._enableSetForNode(t,i)))}_enableSetForNode(t,i){if(!t.enabled)return;const s=t.ids.get(i.id);s&&s.forEach(n=>this._context.addHighlight(i,n,t.id))}_disableSet(t){t.enabled&&(t.enabled=!1,this._context.forEachNode(i=>this._disableSetForNode(t,i)))}_disableSetForNode(t,i){t.enabled||this._context.removeHighlight(i,t.id)}nodeAdded(t){this._highlights.forEach(i=>this._enableSetForNode(i,t))}nodeRemoved(t){this._highlights.forEach(i=>this._disableSetForNode(i,t))}removeAll(){this._highlights.forEach(t=>this._disableSet(t))}}class Rt{constructor(t){this.id=new Et.O(xt.V_.Highlight),this.ids=new Map,this.enabled=!1;for(const i of t)null!=i&&this._add(i.nodeId,i.pointId)}_add(t,i){const s=this.ids.get(t);s?s.add(i):this.ids.set(t,new Set([i]))}}var te=r(13934),Ot=r(81088),Ye=r(39114),It=r(62483),ye=r(67857),Le=r(5894),Mt=r(15197),ke=r(16396),Oe=r(1956),Dt=r(651),At=r(91056),Ut=r(12407),qe=r(64127),ie=r(67969),Ne=r(2078);class Ie extends At.A{constructor(t,i,s){super(t,i,s)}initializeProgram(t){return new Ut.$(t.rctx,Ie.shader.get().build(this.configuration),Ye.i)}initializePipeline(){return(0,Ne.sm)({depthTest:{func:ie.wb.LESS},depthWrite:Ne.LZ,colorWrite:Ne.BK,stencilWrite:this.configuration.hasOccludees?qe.s3:null,stencilTest:this.configuration.hasOccludees?qe.RY:null})}}Ie.shader=new Dt.J(Oe.b,()=>r.e(9298).then(r.bind(r,99298)));var le=r(87601),Lt=r(41528);class se extends Lt.W{constructor(){super(...arguments),this.output=te.H_.Color,this.hasSlicePlane=!1,this.drawScreenSize=!1,this.useFixedSizes=!1,this.hasOccludees=!1,this.clippingEnabled=!1}}(0,h._)([(0,le.o)({count:te.H_.COUNT})],se.prototype,"output",void 0),(0,h._)([(0,le.o)()],se.prototype,"hasSlicePlane",void 0),(0,h._)([(0,le.o)()],se.prototype,"drawScreenSize",void 0),(0,h._)([(0,le.o)()],se.prototype,"useFixedSizes",void 0),(0,h._)([(0,le.o)()],se.prototype,"hasOccludees",void 0),(0,h._)([(0,le.o)()],se.prototype,"clippingEnabled",void 0),(0,h._)([(0,le.o)({constValue:!0})],se.prototype,"hasSliceInVertexProgram",void 0);var et=r(83994),tt=r(40852);const Nt={positions:[new tt.G(ke.T.POSITION,3,ie.g.FLOAT,0,12)],colors:[new tt.G(ke.T.COLOR,3,ie.g.UNSIGNED_BYTE,0,3,!0)]};let Me=class extends Ot.He{constructor(e){super(e),this.type=ye.q7.PCL,this.isGround=!1,this._passParameters=new Oe.P,this._highlights=new Ct({forEachNode:t=>this.forEachNode(t),addHighlight:(t,i,s)=>this._addHighlight(t,i,s),removeHighlight:(t,i)=>this._removeHighlight(t,i)}),this.produces=new Map([[Le.r.OPAQUE_MATERIAL,t=>t!==te.H_.LinearDepth&&(t!==te.H_.Highlight||!this._highlights.empty)],[Le.r.OPAQUE_NO_SSAO_DEPTH,t=>t===te.H_.LinearDepth]]),this.layerUid="",this._slicePlaneEnabled=!1,this._techniqueConfig=new se,this._nodes=new Pt.Z}initializeRenderContext(e){this._context=e,e.requestRender()}uninitializeRenderContext(){}intersect(e,t,i,s){const n=(0,Pe.Ue)(),o=(0,Pe.Ue)(),a=(0,Pe.Ue)(),l=(0,Pe.Ue)(),c=(0,k.Ue)(),_=e.camera.perScreenPixelRatio/2,m=e.camera.near;(0,g.f)(o,s,i);const x=1/(0,g.l)(o);(0,g.h)(o,o,x),(0,g.F)(a,o),(0,yt.s)(c,o[0],o[1],o[2],-(0,g.k)(o,i));const C=new Be,v=new Be,D=new Array,V=(0,R.Ue)(),O=(0,R.Ue)(this._passParameters.clipBox);(0,R.cv)(O,-i[0],-i[1],-i[2],O),this._nodes.forAll(f=>{const W=f.splatSize*this._passParameters.scaleFactor;let Q=f.obb.minimumDistancePlane(c),Z=f.obb.maximumDistancePlane(c);if(Q-=Te(W,Q+m,this._passParameters,_,f.isLeaf),Z-=Te(W,Z+m,this._passParameters,_,f.isLeaf),Z<0||null!=C.dist&&null!=v.dist&&C.dist<Q*x&&v.dist>Z*x)return;const Ve=ze(W,Z+m,this._passParameters,_,f.isLeaf);if(!f.obb.intersectRay(i,o,Ve))return;const qt=Ve*Ve;f.obb.toAaBoundingBox(V),(0,R.cv)(V,-i[0],-i[1],-i[2],V);const ei=!(0,R.r3)(O,V);(0,g.f)(l,f.origin,i);const ti=f.coordinates.length/3;for(let de=0;de<ti;de++){if(n[0]=l[0]+f.coordinates[3*de],n[1]=l[1]+f.coordinates[3*de+1],n[2]=l[2]+f.coordinates[3*de+2],ei&&!(0,R.BD)(O,n))continue;const be=(0,g.k)(n,o),ot=(0,g.p)(n)-be*be;if(ot>qt)continue;let je=be+m;const Ke=Te(W,je,this._passParameters,_,f.isLeaf);if(be-Ke<0)continue;je-=Ke;const at=ze(W,je,this._passParameters,_,f.isLeaf);if(ot>at*at)continue;const _e=(be-Ke)*x,Ge=X=>(X.point=Bt(f,de,X.point),X.dist=_e,X.normal=a,X.node=f,X.pointId=de,X.layerUid=this.layerUid,X);if((null==C.dist||_e<C.dist)&&(null==t||t(i,s,_e))&&Ge(C),e.options.store!==ye.eC.MIN&&(null==v.dist||_e>v.dist)&&(null==t||t(i,s,_e))&&Ge(v),e.options.store===ye.eC.ALL&&(null==t||t(i,s,_e))){const X=new Be;D.push(Ge(X))}}});const He=f=>{const{layerUid:W,node:Q,pointId:Z}=f;return new bt.AK(f.point,W,Z,()=>this.createGraphic(Q,Z,f.point))},Se=(f,W)=>{const Q=He(W);f.set(this.type,Q,W.dist,W.normal)};if(st(C)){const f=e.results.min;(null==f.dist||C.dist<f.dist)&&Se(f,C)}if(st(v)&&e.options.store!==ye.eC.MIN){const f=e.results.max;(null==f.dist||v.dist>f.dist)&&Se(f,v)}if(e.options.store===ye.eC.ALL){const f=(0,St.zk)(i,s);for(const W of D){const Q=(0,It.LP)(f);Se(Q,W),e.results.all.push(Q)}}}prepareTechnique(e){return 0===this._nodes.length||e.output!==te.H_.Color&&(e.output!==te.H_.LinearDepth||e.bindParameters.slot!==Le.r.OPAQUE_NO_SSAO_DEPTH)&&e.output!==te.H_.Highlight?null:(this._nodes.forAll(t=>{null==t.vao&&this._initNode(e,t)}),this._techniqueConfig.drawScreenSize=this._passParameters.drawScreenSpace,this._techniqueConfig.useFixedSizes=this._passParameters.useFixedSizes,this._techniqueConfig.hasSlicePlane=this._slicePlaneEnabled,this._techniqueConfig.hasOccludees=e.bindParameters.hasOccludees,this._techniqueConfig.clippingEnabled=this._clippingEnabled,this._techniqueConfig.output=e.output,this._context.techniqueRepository.releaseAndAcquire(Ie,this._techniqueConfig,this._technique))}renderNode(e,t){const i=e.rctx,s=i.bindTechnique(t,e.bindParameters,this._passParameters),n=e.output===te.H_.Highlight;this._nodes.forAll(o=>{0===o.coordinates.length||n&&!o.highlights||(s.bindDraw(o,e.bindParameters,this._passParameters),i.bindVAO(o.vao),n?this._renderHighlightFragments(i,o):i.drawArrays(ie.MX.POINTS,0,o.coordinates.length/3))})}_renderHighlightFragments(e,t){const i=t.highlights;if(null==i)return;let s=i[0].component,n=s+1;for(let a=1;a<i.length;a++){const l=i[a].component;if(l!==n){const c=n-s;c>0&&e.drawArrays(ie.MX.POINTS,s,c),s=l}n=l+1}const o=n-s;o>0&&e.drawArrays(ie.MX.POINTS,s,o)}set useFixedSizes(e){this._passParameters.useFixedSizes!==e&&(this._passParameters.useFixedSizes=e,this._requestRender())}get useFixedSizes(){return this._passParameters.useFixedSizes}set scaleFactor(e){this._passParameters.scaleFactor!==e&&(this._passParameters.scaleFactor=e,this._requestRender())}get scaleFactor(){return this._passParameters.scaleFactor}set minSizePx(e){this._passParameters.minSizePx!==e&&(this._passParameters.minSizePx=e,this._requestRender())}get minSizePx(){return this._passParameters.minSizePx}set useRealWorldSymbolSizes(e){this._passParameters.useRealWorldSymbolSizes!==e&&(this._passParameters.useRealWorldSymbolSizes=e,this._requestRender())}get useRealWorldSymbolSizes(){return this._passParameters.useRealWorldSymbolSizes}set size(e){this._passParameters.size!==e&&(this._passParameters.size=e,this._requestRender())}get size(){return this._passParameters.size}set sizePx(e){this._passParameters.sizePx!==e&&(this._passParameters.sizePx=e,this._requestRender())}get sizePx(){return this._passParameters.sizePx}set clippingBox(e){(0,R.t8)(this._passParameters.clipBox,e||R.gy)}get _clippingEnabled(){return!(0,R.fS)(this._passParameters.clipBox,R.gy,(e,t)=>e===t)}get slicePlaneEnabled(){return this._slicePlaneEnabled}set slicePlaneEnabled(e){this._slicePlaneEnabled!==e&&(this._slicePlaneEnabled=e,this._requestRender())}addNode(e){this._nodes.push(e),this._highlights.nodeAdded(e),this._requestRender()}removeNode(e){let t=null;return this._nodes.filterInPlace(i=>i.id!==e||(t=i,i.vao=(0,P.M2)(i.vao),this._highlights.nodeRemoved(i),!1)),this._requestRender(),t}forEachNode(e){this._nodes.forAll(e)}removeAll(){this._nodes.forAll(e=>e.vao=(0,P.M2)(e.vao)),this._highlights.removeAll(),this._nodes.clear(),this._requestRender()}highlight(e){return this._highlights.add(e)}_addHighlight(e,t,i){e.highlights=function wt(e,t,i){null==e&&(e=[]);const s={component:t,id:i};e.push(s);const n=it(s);let o=e.length-1;for(;o>0&&n<it(e[o-1]);)[e[o-1],e[o]]=[e[o],e[o-1]],--o;return e}(e.highlights,t,i),this._requestRender()}_removeHighlight(e,t){e.highlights=function Wt(e,t){if(null==e)return e;const i=e.filter(s=>s.id!==t);return 0===i.length?null:i}(e.highlights,t),this._requestRender()}_initNode(e,t){const i=e.rctx;t.vao=new Mt.U(i,Ye.i,Nt,{positions:et.f.createVertex(i,ie.l1.STATIC_DRAW,t.coordinates),colors:et.f.createVertex(i,ie.l1.STATIC_DRAW,t.rgb)})}_requestRender(){this._context&&this._context.requestRender()}};(0,h._)([(0,p.Cb)({constructOnly:!0})],Me.prototype,"createGraphic",void 0),Me=(0,h._)([(0,S.j)("esri.views.3d.layers.i3s.PointRenderer")],Me);class zt extends Oe.a{constructor(t,i,s,n,o,a,l,c,_=null,m=null){super(s,o,i),this.id=t,this.obb=n,this.coordinates=a,this.rgb=l,this.attributes=c,this.pointIdFilterMap=_,this.highlights=m}}function ze(e,t,i,s,n){if(i.drawScreenSpace)return i.fixedSize*t*s;const o=(0,Oe.g)(n)*t*s;return i.useFixedSizes?Math.min(i.fixedSize/2,o):i.screenMinSize>0?Math.min(Math.max(i.screenMinSize*t*s,e/2),o):Math.min(e/2,o)}function Te(e,t,i,s,n){return i.drawScreenSpace?0:ze(e,t,i,s,n)}function Bt(e,t,i){return null==i&&(i=(0,Pe.Ue)()),i[0]=e.origin[0]+e.coordinates[3*t],i[1]=e.origin[1]+e.coordinates[3*t+1],i[2]=e.origin[2]+e.coordinates[3*t+2],i}function it(e){return null!=e.component?e.component:-1}class Be{constructor(){this.node=null,this.pointId=null,this.point=null,this.dist=null,this.normal=null,this.layerUid=""}}function st(e){return null!=e.dist&&null!=e.point&&null!=e.pointId&&null!=e.node}var Ft=r(40465),Ht=r(55745),Vt=r(60490),nt=r(39135),we=r(93394),jt=r(41632),Kt=r(45611),We=r(93579),Gt=r(87091);const Zt=(0,k.Ue)();let U=class extends((0,Ft.i)((0,ue.A)(Kt.Z))){constructor(){super(...arguments),this.type="point-cloud-3d",this.maximumPointCount=4e6,this.slicePlaneEnabled=!1,this._renderer=null,this._rendererAdded=!1,this._renderedNodes=new Set,this._nodeScales=new Map,this._updateViewNeeded=!0,this._lodFactor=1,this._maxLoggedBoxWarnings=5,this._pageMultiplier=1,this._nodeLoadEpoch=0,this._indexQueue=[],this._workQueue=new Array,this._idleQueue=new T.b,this._indexPagesLoading=new Map,this._loadingNodes=new Map,this._recalcWork=!0,this._layerIsVisible=!1,this._codedDomainPopulationPromise=null,this._codedDomainPopulationAbortController=null,this._totalWork=0,this._index=null,this._loadingInitNodePage=!1,this._nodeIdArray=[],this.ignoresMemoryFactor=!1}get baseUrl(){return this.layer.parsedUrl.path}get pointScale(){const e=function ft(e){const t=e?.pointSizeAlgorithm;return t&&"splat"===t.type?t:null}(this.layer?.renderer);return null!=e?.scaleFactor?e.scaleFactor:1}get useRealWorldSymbolSizes(){const e=Je(this.layer?.renderer);return null!=e?.useRealWorldSymbolSizes&&e.useRealWorldSymbolSizes}get pointSize(){const e=Je(this.layer?.renderer);return null!=e?.size?e.size:0}get inverseDensity(){return this.layer?.renderer?96/this.layer.renderer.pointsPerInch:5}get availableFields(){const e=Ze(this.layer),t=new Set;e.primaryAttribute&&t.add(e.primaryAttribute.name),e.modulationAttribute&&t.add(e.modulationAttribute.name);const i=$e(this.layer);if(i)for(const s of i)s.attributeInfo&&t.add(s.attributeInfo.name);if(this.layer.outFields)for(const s of(0,Ee.Lk)(this.layer.fieldsIndex,this.layer.outFields))t.add(s);return Array.from(t)}get _clippingBox(){if(!this.view||!this.view.clippingArea)return null;const e=(0,R.Ue)();return(0,Ht.O)(this.view.clippingArea,e,this.view.renderSpatialReference)?e:null}get _elevationOffset(){const e=this.layer&&this.layer.elevationInfo;if(e&&"absolute-height"===e.mode){const t=(0,y._R)(this.layer.spatialReference),i=(0,w.Z7)(e.unit);return(e.offset??0)*i/t}return 0}initialize(){const e=this.view.resourceController,t=function Xt(e){return t=>e.immediate.schedule(t)}(e);this._worker=new I(t),this.addResolvingPromise(this._worker.promise),this._tmpPoint=(0,A.T)(0,0,0,this.layer.spatialReference),(0,M.zW)(this.layer),(0,M.yS)(this.layer,this.view),this._indexRequester=e.createStreamDataRequester(nt.Bh.I3S_INDEX),this._dataRequester=e.createStreamDataRequester(nt.Bh.I3S_DATA),this._initRenderer();const i=this._initNodePages();this._memCache=this.view.resourceController.memoryController.newCache(`pcl-${this.layer.uid}`),this._updatingHandles.add(()=>this._clippingBox,()=>this._setUpdateViewNeeded(),b.nn),this._updatingHandles.add(()=>this._elevationOffset,()=>this._elevationOffsetChanged(),b.nn),this._updatingHandles.add(()=>this.layer.renderer,()=>this._rendererChanged(),b.nn),this._updatingHandles.add(()=>this.layer.filters,()=>this._reload(),b.nn),this._updatingHandles.add(()=>this.layer.outFields,()=>this._reload(),b.nn),this._updatingHandles.add(()=>this.layer.effectiveScaleRange,()=>this._setUpdateViewNeeded()),this._updatingHandles.add(()=>this.view.state.contentCamera,()=>this._setUpdateViewNeeded()),this.addHandles([this.view.basemapTerrain.on("scale-change",n=>this._scaleUpdateHandler(n)),(0,b.YP)(()=>this.view.quality,()=>this._setUpdateViewNeeded(),b.Z_)]),this.addResolvingPromise(i),this.when(()=>{this.addHandles([e.scheduler.registerTask(Gt.T8.POINT_CLOUD_LAYER,this),e.scheduler.registerIdleStateCallbacks(()=>this._idleBegin(),()=>this._idleEnd()),this._updatingHandles.add(()=>this.suspended,n=>{n?this._clearNodeState():this._setUpdateViewNeeded()},b.nn)])},()=>{this._updatingHandles.removeAll(),this.removeAllHandles()})}_setUpdateViewNeeded(){this._updateViewNeeded=!0,this._updateLoading()}destroy(){this.cancelLoading(),this._worker=(0,P.SC)(this._worker),this._destroyRenderer(),this._memCache=(0,P.SC)(this._memCache),this._codedDomainPopulationAbortController=(0,P.IM)(this._codedDomainPopulationAbortController),this._codedDomainPopulationPromise=null}_initRenderer(){this._renderer=new Me({createGraphic:(e,t,i)=>this._createGraphic(e,t,i)}),this._renderer.layerUid=this.layer.uid,this._updatingHandles.add(()=>this._clippingBox,e=>this._renderer.clippingBox=e,b.nn),this._updatingHandles.add(()=>this.suspended,e=>this._setPointsVisible(!e),b.nn),this._updatingHandles.add(()=>this.pointScale,e=>this._renderer.scaleFactor=e,b.nn),this._renderer.minSizePx=Math.sqrt(2),this._updatingHandles.add(()=>this.useRealWorldSymbolSizes,e=>this._renderer.useRealWorldSymbolSizes=e,b.nn),this._updatingHandles.add(()=>this.pointSize,e=>{const t=(0,N.F2)(e);this._renderer.size=e,this._renderer.sizePx=t},b.nn),this._updatingHandles.add(()=>this.slicePlaneEnabled,e=>this._renderer.slicePlaneEnabled=e,b.nn),this._updatingHandles.add(()=>this.inverseDensity,()=>this._setUpdateViewNeeded(),b.nn),this._updatingHandles.add(()=>this.maximumPointCount,()=>this._setUpdateViewNeeded(),b.nn),this._updatingHandles.add(()=>this.view.qualitySettings.sceneService.pointCloud.lodFactor,e=>{this._lodFactor=e,this._setUpdateViewNeeded()},b.nn)}_destroyRenderer(){this._renderer.removeAll(),this._setPointsVisible(!1)}_createGraphic(e,t,i){const s=null!=e.pointIdFilterMap?e.pointIdFilterMap[t]:t,n=(0,Vt.K0)(this.view,i),o=this._createGraphicAttributes(e,s);return new ve({pointCloudMetadata:{nodeId:e.id,pointIndexInNode:t,attributePointIndexInNode:s,epoch:this._nodeLoadEpoch},geometry:n,attributes:o,layer:this.layer,sourceLayer:this.layer})}_createGraphicAttributes(e,t){const i={};for(const s of e.attributes)this._encodeGraphicAttribute(s.attributeInfo,s.values,t,i);return i}_encodeGraphicAttribute(e,t,i,s){const n=e.storageInfo?.attributeValues,o=n?.valuesPerElement??1;if(1===o)s[e.name]=t[i];else if("UInt8"===n?.valueType&&o<=4){let a=0;const l=i*o;for(let c=l;c<l+o;c++)a=(a<<8)+t[c];s[e.name]=a}else s[e.name]=void 0}_setPointsVisible(e){e&&!this._rendererAdded?(this.view._stage.addRenderPlugin(this._renderer),this._rendererAdded=!0):!e&&this._rendererAdded&&(this.view._stage.removeRenderPlugin(this._renderer),this._rendererAdded=!1)}_rendererChanged(){this._renderer.useFixedSizes=function mt(e){const t=e?.pointSizeAlgorithm;return!!t?.type&&"fixed-size"===t.type}(this.layer.renderer),this._reload()}_reload(){this._clearNodeState(),this._memCache.clear(),this._setUpdateViewNeeded()}_elevationOffsetChanged(){this._clearNodeState(),this._memCache.clear(),this._initNodePages()}_scaleUpdateHandler(e){const t=this.layer.effectiveScaleRange;(0,We.Av)(t.minScale,t.maxScale)?(0,ne.d)(e.extent,e.spatialReference,rt,this.layer.spatialReference)&&(this._nodeScales.forEach((i,s)=>{if(!this._renderedNodes.has(s))return void this._nodeScales.delete(s);const n=this._index.getNode(s);(0,Y.BD)(rt,n.obb.center)&&this._nodeScales.set(s,e.scale)}),this._setUpdateViewNeeded()):this._nodeScales.clear()}_displayNodes(e){this._workQueue=function H(e,t,i){for(let n=0;n<t.length;n++)Ae[n]=!1,ee[n]=null;for(let n=0;n<e.length;n++)De[n]=!1,q[n]=null;for(let n=0;n<t.length;n++){const o=Qe(t[n],e,i);o>=0&&(Ae[n]=!0,null!=q[o]?q[o].push(t[n]):q[o]=[t[n]])}for(let n=0;n<e.length;n++){const o=Qe(e[n],t,i);o>=0&&(De[n]=!0,null!=ee[o]?ee[o].push(e[n]):ee[o]=[e[n]])}const s=[];for(let n=0;n<e.length;n++)null!=q[n]||De[n]||s.push({load:[],remove:[e[n]]});for(let n=0;n<t.length;n++)null!=ee[n]||Ae[n]||s.push({load:[t[n]],remove:[]});for(let n=0;n<t.length;n++)null!=ee[n]&&(ee[n].length>1||ee[n][0]!==t[n])&&s.push({load:[t[n]],remove:ee[n]});for(let n=0;n<e.length;n++)null!=q[n]&&(q[n].length>1||q[n][0]!==e[n])&&s.push({load:q[n],remove:[e[n]]});return s}([...this._renderedNodes],e,this._index),function lt(e,t,i){e.sort((s,n)=>{if(0===s.load.length&&0===n.load.length)return 0;if(0===s.load.length)return-1;if(0===n.load.length)return 1;if(0===s.remove.length&&0===n.remove.length){const o=i.getRenderObb(s.load[0]).center,a=i.getRenderObb(n.load[0]).center;return(0,g.k)(o,t)-(0,g.k)(a,t)}if(0===s.remove.length)return-1;if(0===n.remove.length)return 1;if(1===s.load.length&&1===n.load.length){const o=i.getRenderObb(s.load[0]).center,a=i.getRenderObb(n.load[0]).center;return(0,g.k)(o,t)-(0,g.k)(a,t)}if(1===s.load.length)return-1;if(1===n.load.length)return 1;{const o=i.getRenderObb(s.remove[0]).center,a=i.getRenderObb(n.remove[0]).center;return(0,g.k)(o,t)-(0,g.k)(a,t)}})}(this._workQueue,this.view.state.contentCamera.viewForward,this._index),function dt(e,t,i){for(let s=0;s<e.length;++s){const n=e[s];n.load.length>t&&1===n.remove.length&&ht(e,n,i)}}(this._workQueue,8,this._index),this._updateQueues(),this._totalWork=this._computeWork(),this._updateLoading(),this._layerIsVisible=e.length>0||this._loadingInitNodePage,this.notifyChange("suspended")}cancelLoading(){this._cancelNodeLoading(),this._cancelIndexLoading()}_cancelNodeLoading(){const e=new Array;this._loadingNodes.forEach(({abortController:t})=>e.push(t)),this._loadingNodes.clear();for(const t of e)t.abort();this._workQueue=[],this._idleQueue.cancelAll(),this._totalWork=this._computeWork(),this._updateLoading()}_updateQueues(){const e=new Set;this._workQueue.forEach(s=>s.load.forEach(n=>e.add(n)));const t=new Array,i=new Map;this._loadingNodes.forEach((s,n)=>{e.has(n)?i.set(n,s):t.push(s)}),this._loadingNodes=i;for(const{abortController:s}of t)s.abort();this._workQueue=this._workQueue.filter(s=>{for(const n of s.load)if(this._loadingNodes.has(n))return this._recalcWork=!0,!1;return!0}),this._totalWork=this._computeWork(),this._updateLoading()}_cancelIndexLoading(){this._indexQueue=[],this._indexPagesLoading.forEach(({abortController:e})=>e.abort()),this._indexPagesLoading.clear(),this._totalWork=this._computeWork(),this._updateLoading()}_clearNodeState(){this._nodeLoadEpoch++,this._renderedNodes.forEach(e=>this._removeFromRenderer(e)),this._cancelNodeLoading()}_idleBegin(){this._setUpdateViewNeeded()}_idleEnd(){this._setUpdateViewNeeded()}get running(){return this.suspended?this._updateViewNeeded:this._updateViewNeeded||this._indexQueue.length>0||this._workQueue.length>0||this._idleQueue.running}runTask(e){if(this.suspended){if(this._updateViewNeeded){this._updateViewNeeded=!1;const t=this._isRootNodeVisible();t!==this._layerIsVisible&&(this._layerIsVisible=t,this.notifyChange("suspended")),this._updateLoading()}}else{for(e.run(()=>this._updateWorkQueues());this._indexQueue.length>0&&e.run(()=>this._processIndexQueue()););this._processWorkQueue(e),this._idleQueue.runTask(e)}}_processIndexQueue(){const e=this._indexQueue.shift(),t=this._loadNodePage(e);return this._indexPagesLoading.set(e,t),t.promise.then(i=>{this._index.addPage(e,i,this._elevationOffset),this._setUpdateViewNeeded()}).then(()=>{this._indexPagesLoading.delete(e)},()=>{this._indexPagesLoading.delete(e)}),!0}_processWorkQueue(e){for(;!e.done;){const t=this._scheduleWorkEntry();if(null==t)return void e.madeProgress();this._processWorkEntry(t),e.madeProgress()}}_scheduleWorkEntry(){let e=this._workQueue.length;for(;e--;){const t=this._workQueue.shift();if(!t.remove.find(i=>!this._renderedNodes.has(i)))return t;this._workQueue.push(t)}return null}_processWorkEntry(e){if(0!==e.load.length)Promise.all(e.load.map(t=>{const i=new AbortController,s=this._memCache.pop(t.toString());return null!=s?this._loadingNodes.set(t,{abortController:i,promise:Promise.resolve(s)}):this._loadingNodes.has(t)||this._loadingNodes.set(t,{abortController:i,promise:this._loadNode(t,i.signal)}),this._loadingNodes.get(t).promise})).then(t=>{for(let i=0;i<e.load.length;i++)if(t[i]){const s=this._setupRendererData(e.load[i],t[i]);this._addToRenderer(s)}for(const i of e.remove)this._removeFromRenderer(i)}).catch(()=>{}).then(()=>{for(const t of e.load)this._loadingNodes.delete(t);this._updateLoading(),this._recalcWork&&!this._idleQueue.running&&0===this._indexQueue.length&&0===this._loadingNodes.size&&(this._recalcWork=!1,this._setUpdateViewNeeded())}),this._updateLoading();else for(const t of e.remove)this._removeFromRenderer(t)}_populateClassCodeCodedDomain(e,t){var i=this;return(0,u.Z)(function*(){const s="CLASS_CODE",n=i.layer.fieldsIndex.get(s);if(!n||n.domain||!e.includes(n.name))return;const o=yield(0,B.q6)(i.layer.queryCachedStatistics(s,{signal:t}));if(!1===o.ok)return;const a=o.value?.stats?.labels?.labels;a&&Array.isArray(a)&&(n.domain=new re.Z({name:"CLASS_CODE",codedValues:a.map(l=>new he.u({code:l.value,name:l.label}))}))})()}prepareFetchPopupFeatures(e){var t=this;return(0,u.Z)(function*(){return t._codedDomainPopulationPromise||(t._codedDomainPopulationAbortController=new AbortController,t._codedDomainPopulationPromise=t._populateClassCodeCodedDomain(e,t._codedDomainPopulationAbortController.signal).then(()=>{t._codedDomainPopulationAbortController=null})),t._codedDomainPopulationPromise})()}whenGraphicAttributes(e,t){var i=this;return(0,u.Z)(function*(){const s=i._splitGraphicsPerNode(e),n=i.layer.attributeStorageInfo,o=t.map(c=>me(n,c)).filter(j.pC),a=function(){var c=(0,u.Z)(function*(_,m){const x=i._index.getNode(m);yield(0,B.Ed)(o,function(){var C=(0,u.Z)(function*(v){const D=v.useElevation?yield i._loadElevationAttributeFromGeometry(x.resourceId):yield i._loadAndParseAttribute(x,v);if(D)for(const V of _)i._isValidPointGraphic(V)&&i._encodeGraphicAttribute(v,D,V.pointCloudMetadata.attributePointIndexInNode,V.attributes)});return function(v){return C.apply(this,arguments)}}())});return function(m,x){return c.apply(this,arguments)}}(),l=[];return s.forEach((c,_)=>{l.push(a(c,_))}),yield Promise.allSettled(l),e})()}_isValidPointGraphic(e){return e instanceof ve&&e.pointCloudMetadata?.epoch===this._nodeLoadEpoch}_splitGraphicsPerNode(e){const t=new Map;for(const i of e){if(!this._isValidPointGraphic(i))continue;const s=i.pointCloudMetadata,n=t.get(s.nodeId);n?n.push(i):t.set(s.nodeId,[i])}return t}_loadAndParseAttribute(e,t){var i=this;return(0,u.Z)(function*(){const s=yield i._loadAttribute(e.resourceId,t,null);return null!=s?(0,Ue.dH)({attributeInfo:t,buffer:s},null,e.vertexCount):null})()}_loadElevationAttributeFromGeometry(e){var t=this;return(0,u.Z)(function*(){const s=(0,Ue.Ym)(t.layer.store.defaultGeometrySchema,yield t._loadGeometry(e,null));return(0,Ue.et)(s,s.length/3)})()}highlight(e){if(!e)return(0,K.kB)();const t=$.Z.isCollection(e)?e.toArray():Array.isArray(e)?e:[e];return this._renderer.highlight(t.map(i=>this._graphicToPointDefinition(i)))}_graphicToPointDefinition(e){if(!this._isValidPointGraphic(e))return null;const{nodeId:t,pointIndexInNode:i}=e.pointCloudMetadata;return null!=t&&null!=i?{nodeId:t,pointId:i}:null}_computeWork(){let e=0;for(const t of this._workQueue)e+=t.load.length+t.remove.length;return e+=this._loadingNodes.size,e+=(this._indexQueue.length+this._indexPagesLoading.size)*this._index.pageSize,e+=this._loadingInitNodePage?100:0,e+=this._updateViewNeeded?100:0,e}get updatingProgressValue(){if(this.suspended)return this._updateViewNeeded?0:1;const e=this._computeWork();return 1-Math.min(this._totalWork,e)/this._totalWork}_updateLoading(){this.notifyChange("updating"),this.notifyChange("updatingProgressValue")}canResume(){return super.canResume()&&this._layerIsVisible}isUpdating(){return this.suspended?this._updateViewNeeded:this._computeWork()>0}_initNodePages(){const e=this.layer.store.index;return this._index=new ct(this.layer.spatialReference,this.view.renderCoordsHelper.spatialReference,e.nodesPerPage||e.nodePerIndexBlock),this._cancelIndexLoading(),this._traverseVisible=this._index.createVisibilityTraverse(),this._loadingInitNodePage=!0,this._layerIsVisible=!0,this.notifyChange("suspended"),this._updateLoading(),this._pageMultiplier=null!=e.nodesPerPage?1:e.nodePerIndexBlock,this._loadNodePage(0).promise.then(i=>{this._index.addPage(0,i,this._elevationOffset),this._loadingInitNodePage=!1,this._setUpdateViewNeeded()})}_loadNodePage(e){const t=new AbortController;return{promise:this._requestNodePage(`${this.baseUrl}/nodepages/${e*this._pageMultiplier}`,t.signal).then(s=>s.nodes.map((n,o)=>({resourceId:null!=n.resourceId?n.resourceId:e*this._index.pageSize+o,obb:we.Oo.fromJSON(n.obb),obbInRenderSR:new we.Oo,firstChild:n.firstChild,childCount:n.childCount,vertexCount:n.vertexCount??n.pointCount,lodThreshold:n.lodThreshold??n.effectiveArea}))),abortController:t}}_updateWorkQueues(){if(!this._updateViewNeeded)return!1;const e=this.view.quality;let t=this.inverseDensity/this._lodFactor*e;const i=this.maximumPointCount*this._lodFactor*e;let s=this._computeNodesForMinimumDensity(t),n=this._computePointCount(s),o=Math.sqrt(n/(.75*i));for(;n>i;)t*=o,s=this._computeNodesForMinimumDensity(t),n=this._computePointCount(s),o=Math.sqrt(2);return this._displayNodes(s),this._updateViewNeeded=!1,this._updateLoading(),!0}_computePointCount(e){let t=0;for(let i=0;i<e.length;i++){const s=this._index.getNode(e[i]);s&&(t+=s.vertexCount)}return t}_isRootNodeVisible(){let e=!1;return this._traverseVisible({frustum:this.view.state.contentCamera.frustum,clippingBox:this._clippingBox},{predicate:(t,i,s)=>(e=s,!1),pageMiss:()=>{}}),e}_computeNodesForMinimumDensity(e){const t=this.view.state.contentCamera,i=t.frustum,s=this._clippingBox,n=t.viewForward,o=(0,g.k)(n,t.eye),a=(0,k.Oy)(n,-o,Zt),l=t.perScreenPixelRatio/2,c=e*e,_=this._nodeIdArray;_.length=0;const{minScale:m,maxScale:x}=(0,We.lu)(this.layer),C=0===m&&0===x?v=>_.push(v):v=>{const D=this._getScale(v);(0,We.rs)(D,m,x)&&_.push(v)};return this._traverseVisible({frustum:i,clippingBox:s},{predicate:(v,D,V)=>{if(!V)return!1;if(0===D.childCount)return C(v),!1;const O=this._index.getRenderObb(v);return!(this._computeAveragePixelArea(O,D.lodThreshold,D.vertexCount,a,l)<=c&&(C(v),1))},pageMiss:(v,D)=>{C(v),this._indexQueue.includes(D)||this._indexQueue.push(D)}}),_}_getScale(e){let t=this._nodeScales.get(e);if(null==t){const i=this._index.getNode(e).obb.center;this._tmpPoint.x=i[0],this._tmpPoint.y=i[1],this._tmpPoint.z=i[2],t=this.view.basemapTerrain.getScale(this._tmpPoint),this._nodeScales.set(e,t)}return t}_computeAveragePixelArea(e,t,i,s,n){const a=Math.max(1e-7,e.minimumDistancePlane(s));return t/(a*a)/(4*n*n)/i}_loadNode(e,t){try{return this._loadNodeAsync(e,t)}catch(i){throw(0,L.D_)(i)||E.Z.getLogger(this).error(i),i}}_loadAdditionalUserAttributes(e,t,i){var s=this;return(0,u.Z)(function*(){const n=s.layer.outFields;if(!n)return[];const o=(0,Ee.Lk)(s.layer.fieldsIndex,n),a=new Set(e.map(m=>null!=m?m.name:null)),l=s.layer.attributeStorageInfo,c=[];for(const m of o){if(a.has(m))continue;const x=me(l,m);x&&c.push(t(x))}const _=yield(0,L.OT)(c);return(0,L.k_)(i),_.filter(j.pC)})()}_loadNodeAsync(e,t){var i=this;return(0,u.Z)(function*(){const s=i._index.getNode(e),n=Ze(i.layer),o=$e(i.layer),a=s.resourceId,l=function(){var c=(0,u.Z)(function*(_){if(!_)return null;if(_.useElevation)return{attributeInfo:_,buffer:null};const m=yield i._loadAttribute(a,_,t);return null!=m?{attributeInfo:_,buffer:m}:null});return function(m){return c.apply(this,arguments)}}();return i._idleQueue.push((0,u.Z)(function*(){const c=i._loadGeometry(a,t),{primaryAttribute:_,modulationAttribute:m}=n,x=l(_),C=l(m),v=o.map(Z=>Z.attributeInfo),D=v.map(Z=>l(Z)),V=i._loadAdditionalUserAttributes([_,m,...v],l,t),[O,He,Se,f,W]=yield Promise.all([c,x,C,Promise.all(D),V]);(0,L.k_)(t);const Q={geometryBuffer:O,primaryAttributeData:He,modulationAttributeData:Se,filterAttributesData:f,userAttributesData:W,schema:i.layer.store.defaultGeometrySchema,rendererInfo:n,filterInfo:o,obbData:i._index.getRenderObb(e).data,elevationOffset:i._elevationOffset,inSR:i.layer.spatialReference.toJSON(),outSR:i.view.renderCoordsHelper.spatialReference.toJSON()};return i._worker.invoke(Q,t)}),t)})()}_loadGeometry(e,t){var i=this;return(0,u.Z)(function*(){return i._requestData(`${i.baseUrl}/nodes/${e}/geometries/0`,t)})()}_loadAttribute(e,t,i){var s=this;return(0,u.Z)(function*(){return t?.storageInfo?s._requestData(`${s.baseUrl}/nodes/${e}/attributes/${t.storageInfo.key}`,i):null})()}_requestNodePage(e,t){const i={f:"json",...this.layer.customParameters,token:this.layer.apiKey};return this._indexRequester.request(e,"json",{query:i,signal:t})}_requestData(e,t){return this._dataRequester.request(e,"binary",{query:{...this.layer.customParameters,token:this.layer.apiKey},signal:t})}_removeFromRenderer(e){if(this._renderedNodes.has(e)){const t=this._renderer.removeNode(e);this._renderedNodes.delete(e),this._nodeScales.delete(e),this._memCache.put(t.id.toString(),t,function Jt(e){return 5*e.coordinates.length+128}(t))}}_addToRenderer(e){this._renderedNodes.has(e.id)||(this._renderedNodes.add(e.id),this._renderer.addNode(e))}_setupRendererData(e,t){const i=this._index.getNode(e),s=Math.sqrt(i.lodThreshold/i.vertexCount),n=this._index.getRenderObb(e);if(function Tt(e){return e.hasOwnProperty("splatSize")}(t))return t.splatSize=s,t.obb=n,(0,g.c)(t.origin,t.obb.center),t;const o=we.Oo.fromData(t.obbData),a=o.halfSize,l=n.halfSize,c=.01*Math.max(l[0],l[1],l[2]);if(a[0]>l[0]+c||a[1]>l[1]+c||a[2]>l[2]+c){if(this._maxLoggedBoxWarnings>0){const _=m=>`[${m.halfSize[0]}, ${m.halfSize[1]}, ${m.halfSize[2]}]`;E.Z.getLogger(this).warn(`Node ${e} reported bounding box too small. got ${_(n)} but points cover ${_(o)}`),0==--this._maxLoggedBoxWarnings&&E.Z.getLogger(this).warn("  Too many bounding box errors, stopping reporting for this layer.")}this._index.setRenderObb(e,o)}return new zt(e,s,(0,F.d9)(n.center),n,0===i.childCount,t.points,t.rgb,t.attributes,t.pointIdFilterMap)}get usedMemory(){let e=0;return this._renderer.forEachNode(t=>{e+=Fe,e+=(0,z.Xw)(t.coordinates);for(const i of t.attributes){const s=i.values;(0,z.eP)(s.buffer)&&(e+=(0,z.Xw)(s))}}),e}get unloadedMemory(){const e=this._renderedNodes.size;if(e<4)return 0;const t=[...this._renderedNodes].reduce((s,n)=>s+this._index.getNode(n).vertexCount);let i=this._loadingNodes.size;for(let s=0;s<this._workQueue.length;s++)i+=this._workQueue[s].load.length,i-=this._workQueue[s].remove.length;return i<0?0:i*t/e*((this.usedMemory-e*Fe)/t)+i*Fe}get performanceInfo(){return new Ce(this.usedMemory,this._renderedNodes.size,[...this._renderedNodes].reduce((e,t)=>e+this._index.getNode(t).vertexCount,0),this.maximumPointCount,new ae(this._loadingNodes.size,this._indexQueue.length,this._workQueue.length,this._idleQueue.length))}get test(){return{index:this._index,visibleNodes:this._renderedNodes}}};(0,h._)([(0,p.Cb)()],U.prototype,"layer",void 0),(0,h._)([(0,p.Cb)()],U.prototype,"baseUrl",null),(0,h._)([(0,p.Cb)()],U.prototype,"pointScale",null),(0,h._)([(0,p.Cb)()],U.prototype,"useRealWorldSymbolSizes",null),(0,h._)([(0,p.Cb)()],U.prototype,"pointSize",null),(0,h._)([(0,p.Cb)()],U.prototype,"inverseDensity",null),(0,h._)([(0,p.Cb)()],U.prototype,"maximumPointCount",void 0),(0,h._)([(0,p.Cb)({readOnly:!0})],U.prototype,"availableFields",null),(0,h._)([(0,p.Cb)({readOnly:!0})],U.prototype,"_clippingBox",null),(0,h._)([(0,p.Cb)({readOnly:!0})],U.prototype,"_elevationOffset",null),(0,h._)([(0,p.Cb)({type:Boolean})],U.prototype,"slicePlaneEnabled",void 0),(0,h._)([(0,p.Cb)()],U.prototype,"updating",void 0),(0,h._)([(0,p.Cb)(jt.q)],U.prototype,"updatingProgress",void 0),(0,h._)([(0,p.Cb)({readOnly:!0})],U.prototype,"updatingProgressValue",null),U=(0,h._)([(0,S.j)("esri.views.3d.layers.PointCloudLayerView3D")],U);const $t=U,rt=(0,Y.Ue)(),Fe=160},40465:(pe,G,r)=>{r.d(G,{i:()=>b});var u=r(15861),h=r(17626),j=r(26584),E=(r(63290),r(8314),r(4619),r(76898)),P=r(90194),L=r(10023);const b=N=>{let z=class extends N{_validateFetchPopupFeatures(y){const{layer:p}=this,{popupEnabled:d}=p;if(!d)throw new j.Z("scenelayerview3d:fetchPopupFeatures","Popups are disabled",{layer:p});if(!(0,L.V5)(p,y))throw new j.Z("scenelayerview3d:fetchPopupFeatures","Layer does not define a popup template",{layer:p})}prepareFetchPopupFeatures(y){return(0,u.Z)(function*(){})()}fetchPopupFeaturesFromGraphics(y,p){var d=this;return(0,u.Z)(function*(){if(d._validateFetchPopupFeatures(p),0===y.length)return[];const S="scene"===d.layer.type&&null!=d.layer.associatedLayer?d.layer.associatedLayer:d.layer;let g=[];"fieldsIndex"in d.layer&&(g=(0,P.Lk)(d.layer.fieldsIndex,yield(0,L.e7)(S,(0,L.V5)(d.layer,p)))),yield d.prepareFetchPopupFeatures(g);const F=new Set,ne=[],R=[];for(const A of y)(0,P.Gm)(g,A,F)?R.push(A):ne.push(A);if(0===R.length)return ne;const Y=new Map;for(let A=0;A<y.length;A++)Y.set(y[A].getObjectId()??0,A);const k=yield d.whenGraphicAttributes(R,[...F]).catch(()=>R).then(A=>ne.concat(A));return k.sort((A,he)=>{const re=A.getObjectId()??0,ge=Y.get(re)??0,fe=he.getObjectId()??0;return ge-(Y.get(fe)??0)}),k})()}};return z=(0,h._)([(0,E.j)("esri.views.3d.layers.support.PopupSceneLayerView")],z),z}},45611:(pe,G,r)=>{r.d(G,{Z:()=>p});var u=r(17626),h=r(83761),j=r(61885),B=r(61996),$=r(63290),K=r(62208),E=r(60330),P=r(77712),N=(r(8314),r(4619),r(76898)),z=r(11426);let y=class extends((0,B.IG)((0,E.v)(j.Z.EventedMixin(h.Z)))){constructor(d){super(d),this._updatingHandles=new z.R,this.layer=null,this.parent=null}initialize(){this.when().catch(d=>{if("layerview:create-error"!==d.name){const S=this.layer&&this.layer.id||"no id",g=this.layer?.title||"no title";$.Z.getLogger(this).error("#resolve()",`Failed to resolve layer view (layer title: '${g}', id: '${S}')`,d)}})}destroy(){this._updatingHandles=(0,K.SC)(this._updatingHandles)}get fullOpacity(){return(this.layer?.opacity??1)*(this.parent?.fullOpacity??1)}get suspended(){return!this.canResume()}get suspendInfo(){return this.getSuspendInfo()}get legendEnabled(){return!this.suspended&&!0===this.layer?.legendEnabled}get updating(){return!(!this._updatingHandles?.updating&&!this.isUpdating())}get updatingProgress(){return this.updating?0:1}get visible(){return!0===this.layer?.visible}set visible(d){this._overrideIfSome("visible",d)}canResume(){return this.visible&&this.layer?.loaded&&!this.parent?.suspended&&this.view?.ready||!1}getSuspendInfo(){const d=this.parent?.suspended?this.parent.suspendInfo:{};return this.view?.ready||(d.viewNotReady=!0),this.layer&&this.layer.loaded||(d.layerNotLoaded=!0),this.visible||(d.layerInvisible=!0),d}isUpdating(){return!1}};(0,u._)([(0,P.Cb)()],y.prototype,"fullOpacity",null),(0,u._)([(0,P.Cb)()],y.prototype,"layer",void 0),(0,u._)([(0,P.Cb)()],y.prototype,"parent",void 0),(0,u._)([(0,P.Cb)({readOnly:!0})],y.prototype,"suspended",null),(0,u._)([(0,P.Cb)({readOnly:!0})],y.prototype,"suspendInfo",null),(0,u._)([(0,P.Cb)({readOnly:!0})],y.prototype,"legendEnabled",null),(0,u._)([(0,P.Cb)({type:Boolean,readOnly:!0})],y.prototype,"updating",null),(0,u._)([(0,P.Cb)({readOnly:!0})],y.prototype,"updatingProgress",null),(0,u._)([(0,P.Cb)()],y.prototype,"visible",null),(0,u._)([(0,P.Cb)()],y.prototype,"view",void 0),y=(0,u._)([(0,N.j)("esri.views.layers.LayerView")],y);const p=y},10023:(pe,G,r)=>{r.d(G,{V5:()=>$,e7:()=>j,zc:()=>K});var u=r(15861),h=r(90194);function j(E){return B.apply(this,arguments)}function B(){return(B=(0,u.Z)(function*(E,P=E.popupTemplate){if(null==P)return[];const L=yield P.getRequiredFields(E.fieldsIndex),{lastEditInfoEnabled:b}=P,{objectIdField:N,typeIdField:z,globalIdField:y,relationships:p}=E;if(L.includes("*"))return["*"];const d=b?(0,h.CH)(E):[],S=(0,h.Q0)(E.fieldsIndex,[...L,...d]);return z&&S.push(z),S&&N&&E.fieldsIndex?.has(N)&&!S.includes(N)&&S.push(N),S&&y&&E.fieldsIndex?.has(y)&&!S.includes(y)&&S.push(y),p&&p.forEach(g=>{const{keyField:F}=g;S&&F&&E.fieldsIndex?.has(F)&&!S.includes(F)&&S.push(F)}),S})).apply(this,arguments)}function $(E,P){return E.popupTemplate?E.popupTemplate:null!=P&&P.defaultPopupTemplateEnabled&&null!=E.defaultPopupTemplate?E.defaultPopupTemplate:null}function K(E,P){return null!=$(E,{defaultPopupTemplateEnabled:P})}}}]);