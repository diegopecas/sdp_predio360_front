"use strict";(self.webpackChunkpredio360_app=self.webpackChunkpredio360_app||[]).push([[277],{128:(Re,ie,o)=>{o.d(ie,{B:()=>$});var C=o(26584),g=o(50011),A=o(22558),b=o(21726),re=o(35948),oe=o(34117),pe=o(31283),W=o(77712),z=o(61556),V=o(29840);function $(M){const U=M?.origins??[void 0];return(R,q)=>{const H=function N(M,U,R){if("resource"===M?.type)return function le(M,U,R){const q=(0,oe.Oe)(U,R);return{type:String,read:(H,_,x)=>{const P=(0,V.r)(H,_,x);return q.type===String?P:"function"==typeof q.type?new q.type({url:P}):void 0},write:{writer(H,_,x,P){if(!P?.resources)return"string"==typeof H?void(_[x]=(0,V.t)(H,P)):void(_[x]=H.write({},P));const m=function O(M){return null==M?null:"string"==typeof M?M:M.url}(H),X=(0,V.t)(m,{...P,verifyItemRelativeUrls:P?.verifyItemRelativeUrls?{writtenUrls:P.verifyItemRelativeUrls.writtenUrls,rootPath:void 0}:void 0},V.M.NO),de=q.type!==String&&(!(0,A.l)(this)||P?.origin&&this.originIdOf(R)>(0,pe.M9)(P.origin)),ue={object:this,propertyName:R,value:H,targetUrl:X,dest:_,targetPropertyName:x,context:P,params:M};P?.portalItem&&X&&!(0,b.YP)(X)?de&&M?.contentAddressed?T(ue):de?function S(M){const{context:U,targetUrl:R,params:q,value:H,dest:_,targetPropertyName:x}=M;if(!U.portalItem)return;const P=U.portalItem.resourceFromPath(R),m=se(H,R,U),X=(0,z.B)(m),de=(0,b.Ml)(P.path),ue=q?.compress??!1;X===de?(U.resources&&te({...M,resource:P,content:m,compress:ue,updates:U.resources.toUpdate}),_[x]=R):T(M)}(ue):function Q({context:M,targetUrl:U,dest:R,targetPropertyName:q}){M.portalItem&&M.resources&&(M.resources.toKeep.push({resource:M.portalItem.resourceFromPath(U),compress:!1}),R[q]=U)}(ue):P?.portalItem&&(null==X||null!=(0,V.i)(X)||(0,b.jc)(X)||de)?T(ue):_[x]=X}}}}(M,U,R);switch(M?.type??"other"){case"other":return{read:!0,write:!0};case"url":{const{read:q,write:H}=V.b;return{read:q,write:H}}}}(M,R,q);for(const _ of U){const x=(0,W.CJ)(R,_,q);for(const P in H)x[P]=H[P]}}}function T(M){const{targetUrl:U,params:R,value:q,context:H,dest:_,targetPropertyName:x}=M;if(!H.portalItem)return;const P=(0,V.p)(U),m=se(q,U,H);if(R?.contentAddressed&&"json"!==m.type)return void H.messages?.push(new C.Z("persistable:contentAddressingUnsupported",`Property "${x}" is trying to serializing a resource with content of type ${m.type} with content addressing. Content addressing is only supported for json resources.`,{content:m}));const X=R?.contentAddressed&&"json"===m.type?(0,g.F)(m.jsonString):P?.filename??(0,re.DO)(),de=(0,b.v_)(R?.prefix??P?.prefix,X),ue=`${de}.${(0,z.B)(m)}`;if(R?.contentAddressed&&H.resources&&"json"===m.type){const ne=H.resources.toKeep.find(({resource:he})=>he.path===ue)??H.resources.toAdd.find(({resource:he})=>he.path===ue);if(ne)return void(_[x]=ne.resource.itemRelativeUrl)}const Ie=H.portalItem.resourceFromPath(ue);(0,b.jc)(U)&&H.resources&&H.resources.pendingOperations.push((0,b.gi)(U).then(ne=>{Ie.path=`${de}.${(0,z.B)({type:"blob",blob:ne})}`,_[x]=Ie.itemRelativeUrl}).catch(()=>{}));const Ne=R?.compress??!1;H.resources&&te({...M,resource:Ie,content:m,compress:Ne,updates:H.resources.toAdd}),_[x]=Ie.itemRelativeUrl}function te({object:M,propertyName:U,updates:R,resource:q,content:H,compress:_}){R.push({resource:q,content:H,compress:_,finish:P=>{!function Y(M,U,R){"string"==typeof M[U]?M[U]=R.url:M[U].url=R.url}(M,U,P)}})}function se(M,U,R){return"string"==typeof M?{type:"url",url:U}:{type:"json",jsonString:JSON.stringify(M.toJSON(R))}}},22558:(Re,ie,o)=>{function C(g){return g&&"getAtOrigin"in g&&"originOf"in g}o.d(ie,{l:()=>C})},37946:(Re,ie,o)=>{o.d(ie,{X:()=>re});var C=o(79800),g=o(94008),A=o(94425),b=o(37053);function re(oe,pe,W,z){if(null==pe||null==z)return!1;const V=(0,g.eT)(pe,g.Jz),$=(0,g.eT)(z,g.sp);if(V===$&&V!==g.Ej.UNKNOWN||(0,b.fS)(pe,z))return W[0]=1,W[1]=1,W[2]=1,!0;if(V===g.Ej.SPHERICAL_ECEF){const N=(0,C.l)(oe),le=N/Math.sqrt(oe[0]*oe[0]+oe[1]*oe[1]),T=N/A.sv.radius;if($===g.Ej.WEB_MERCATOR)return W[0]=le*T,W[1]=le*T,W[2]=1,!0;if($===g.Ej.WGS84||$===g.Ej.CGCS2000){const S=g.Ms;return W[0]=S*le*T,W[1]=S*T,W[2]=1,!0}}else if(V===g.Ej.PLATE_CARREE){if($===g.Ej.WGS84||$===g.Ej.CGCS2000)return W[0]=g.Ms,W[1]=g.Ms,W[2]=1,!0;if($===g.Ej.WEB_MERCATOR){const N=oe[1]/A.sv.radius;return W[0]=1,W[1]=1/Math.cos(N),W[2]=1,!0}}return!1}},10439:(Re,ie,o)=>{o.d(ie,{Z:()=>Q});var T,C=o(17626),A=(o(29132),o(86810)),b=o(58817),re=o(14889),oe=o(77712),z=(o(8314),o(63290),o(76898)),V=o(99433),$=o(128),N=o(55915),le=o(37118);let S=T=class extends A.wq{constructor(te){super(te),this.geometry=null,this.type="clip"}writeGeometry(te,se,O,Y){if(Y.layer?.spatialReference&&!Y.layer.spatialReference.equals(this.geometry.spatialReference)){if(!(0,N.canProjectWithoutEngine)(te.spatialReference,Y.layer.spatialReference))return void(Y?.messages&&Y.messages.push(new re.Z("scenemodification:unsupported","Scene modifications with incompatible spatial references are not supported",{modification:this,spatialReference:Y.layer.spatialReference,context:Y})));const M=new le.Z;(0,N.projectPolygon)(te,M,Y.layer.spatialReference),se[O]=M.toJSON(Y)}else se[O]=te.toJSON(Y);delete se[O].spatialReference}clone(){return new T({geometry:(0,b.d9)(this.geometry),type:this.type})}};(0,C._)([(0,oe.Cb)({type:le.Z}),(0,$.B)()],S.prototype,"geometry",void 0),(0,C._)([(0,V.c)(["web-scene","portal-item"],"geometry")],S.prototype,"writeGeometry",null),(0,C._)([(0,oe.Cb)({type:["clip","mask","replace"],nonNullable:!0}),(0,$.B)()],S.prototype,"type",void 0),S=T=(0,C._)([(0,z.j)("esri.layers.support.SceneModification")],S);const Q=S},17926:(Re,ie,o)=>{var C,g,A;o.d(ie,{B:()=>g,P:()=>C}),(A=C||(C={}))[A.None=0]="None",A[A.Int16=1]="Int16",A[A.Int32=2]="Int32",function(A){A[A.Replace=0]="Replace",A[A.Outside=1]="Outside",A[A.Inside=2]="Inside",A[A.Finished=3]="Finished"}(g||(g={}))},61556:(Re,ie,o)=>{o.d(ie,{B:()=>g});var C=o(21726);function g(z){return re[function A(z){return"json"===z.type?"application/json":"blob"===z.type?z.blob.type:function b(z){const V=(0,C.Ml)(z);return W[V]||oe}(z.url)}(z)]||pe}const re={},oe="text/plain",pe=re[oe],W={png:"image/png",jpeg:"image/jpeg",jpg:"image/jpg",bmp:"image/bmp",gif:"image/gif",json:"application/json",txt:"text/plain",xml:"application/xml",svg:"image/svg+xml",zip:"application/zip",pbf:"application/vnd.mapbox-vector-tile",gz:"application/gzip","bin.gz":"application/octet-stream"};for(const z in W)re[W[z]]=z},30277:(Re,ie,o)=>{o.d(ie,{N:()=>Vs});var C=o(15861),g=o(17626),A=o(91558),b=o(88879),re=o(85931),oe=o(41844),pe=o(46160),W=o(54024),z=o(8314),V=o(63290),$=o(88159),N=o(62208),le=o(77029),T=o(10699),S=o(32917),Q=o(50618),te=o(55713),se=o(16730),O=o(77712),Y=o(76898),M=o(86274),U=o(32884),R=o(52113),q=o(74741),H=o(42722),_=o(79800),x=o(29302),P=o(63657),m=o(1503),X=o(11426),de=o(37946),ue=o(15869),Ie=o(39774),Ne=o(94008),ne=o(1582),he=o(5548),Ce=o(65401),Oe=o(36344),Je=o(46401),f=o(28844),v=o(97126),ge=o(5437),ae=o(80543),xe=o(90194),ye=o(10439),Ee=o(81808),_e=o(46679),Be=o(82157),Qe=o(39368),ze=o(29505),ve=(o(20383),o(83761)),Ue=o(58817),we=o(21286),ht=o(86236),Pe=o(84682),Ve=o(41967),He=o(13864),ct=o(67873),Ze=o(2694),G=o(61885);class Xe extends G.Z{constructor(){super(...arguments),this._map=new Map}clear(){if(this._map.size>0){const n=this.toArray();this._map.clear(),this.emit("change",{added:[],removed:n})}}get length(){return this._map.size}get(n){return this._map.get(n)}addMany(n){if(0===n.length)return;const e=new Set;for(let s=0;s<n.length;s++){const i=n[s],r=i.objectId,l=this._map.get(r);l?(e.add(r),i!==l&&(n[s]=l),l.refCount||(l.refCount=0),++l.refCount):(i.refCount=1,this._map.set(r,i))}const t=e.size>0?n.filter(s=>!e.has(s.objectId)):n;t.length>0&&this.emit("change",{added:t,removed:[]})}removeMany(n){const e=[];for(const t of n){const s=t.objectId,i=this._map.get(s);null!=i&&(!i.refCount||--i.refCount<=0)&&(this._map.delete(s),e.push(t))}e.length>0&&this.emit("change",{added:[],removed:e})}removeManyByObjectId(n){const e=[];for(const t of n){const s=this._map.get(t);null!=s&&(!s.refCount||--s.refCount<=0)&&(this._map.delete(t),e.push(s))}e.length>0&&this.emit("change",{added:[],removed:e})}toArray(){return[...this._map.values()]}find(n){let e;return(0,$.oE)(this._map,t=>!!n(t)&&(e=t,!0)),e}forEach(n){this._map.forEach(e=>n(e))}}class ke extends G.Z{constructor(n){super(),this._limit=n,this._all=new Xe,this._active=new ut(this),this._pending=new Map,this._handle=this._all.on("change",e=>this._handleChanges(e))}destroy(){this._handle.remove()}get length(){return this._active.length}toArray(){return this._active.toArray()}find(n){return this._active.find(n)}forEach(n){this._active.forEach(n)}addMany(n){this._all.addMany(n)}removeManyByObjectId(n){this._all.removeManyByObjectId(n)}_handleChanges(n){let e=n.removed;if(this._pending.size>0){e=new Array;for(const r of n.removed)this._pending.delete(r.objectId)||e.push(r)}let t=this._limit-this._active.length+e.length;t<n.added.length&&(this._active.removeMany(e),e=[],Fe.reset(1-this._limit/(this._active.length+n.added.length)),this._active.forEach(r=>{Fe.sample()&&(e.push(r),this._pending.set(r.objectId,r))}),t=this._limit-this._active.length+e.length);let s=n.added;if(t<n.added.length){s=new Array,Fe.reset(t/n.added.length);for(const r of n.added)Fe.sample()?s.push(r):this._pending.set(r.objectId,r)}const i=t-s.length;i>0&&this._pending.size>0&&(Fe.reset(i/this._pending.size),this._pending.forEach(r=>{Fe.sample()&&(s.push(r),this._pending.delete(r.objectId))})),this._active.addAndRemove(s,e)}}const Fe=new class Rt{constructor(){this._percentage=1,this._last=-1,this._index=0}reset(n){this._percentage=n,this._last=-1}sample(){const n=Math.floor(this._index*this._percentage);return++this._index,n!==this._last&&(this._last=n,!0)}};class ut{constructor(n){this._parent=n,this._map=new Map}get length(){return this._map.size}forEach(n){this._map.forEach(e=>n(e))}find(n){let e;return(0,$.oE)(this._map,t=>!!n(t)&&(e=t,!0)),e}toArray(){return[...this._map.values()]}addAndRemove(n,e){for(const t of n)this._map.set(t.objectId,t);for(const t of e)this._map.delete(t.objectId);(n.length>0||e.length>0)&&this._parent.emit("change",{added:n,removed:e})}removeMany(n){for(const e of n)this._map.delete(e.objectId);n.length>0&&this._parent.emit("change",{added:[],removed:n})}}var gt=o(23147),ft=o(69852);class qe{constructor(n,e){this.meta=n,this.index=e}}class xt{constructor(n,e){this.graphic=n,this.geometry=e,this.components=[],this.overridesDirty=!1}}let ce=class extends ve.Z{get updating(){return this._graphicsCore?.updating??!1}constructor(a){super(a),this.loadedGraphics=new ke(5e4),this.slicePlaneEnabled=!1,this._renderingInfo={symbol:new ft.Z},this._featuresMap=new Map}initialize(){const a=this.view.basemapTerrain;this._graphicsCore=new He.w({owner:this,layer:this.layer,preferredUpdatePolicy:gt.j.ASYNC,elevationFeatureExpressionEnabled:!1,graphicSymbolSupported:!1,getRenderingInfoWithoutRenderer:!0,hasZ:!0,hasM:!1,componentFactories:{deconflictor:n=>this.view.deconflictor.addGraphicsOwner(n),labeler:(n,e)=>this.view.labeler.addGraphicsOwner(n,e,{emptySymbolLabelSupported:!0,elevationInfoOverride:{mode:"absolute-height",offset:0},disablePlacement:{logEntityDescription:"3D Object Scene Layer features"}}),scaleVisibility:(n,e)=>new ct.c({graphicsCoreOwner:this,layer:this.layer,queryGraphicUIDsInExtent:e,graphicsCore:n,basemapTerrain:a,layerScaleEnabled:!1})}}),this._graphicsCore.initializePromise.then(()=>this._graphicsCore.startCreateGraphics()).catch(()=>{}),this.addHandles((0,S.YP)(()=>this.layer.labelingInfo,(n,e)=>{(0,Pe.Hg)(n,e)&&this._graphicsCore.updateLabelingInfo()}))}destroy(){this._graphicsCore=(0,N.SC)(this._graphicsCore),this.loadedGraphics=(0,N.SC)(this.loadedGraphics),this.view=null}addNodeMeta(a,n){let e=0;const t=a.filteredIds,s=this.view.spatialReference,i=[];for(let r=0;r<a.featureIds.length;r++){const l=a.featureIds[r];let d=null==t;if(t&&e<t.length&&l===t[e]&&(d=!0,e++),!this._enabledForFeatureInNode(a,r))continue;const h=this._featuresMap.get(l);if(h){h.components.push(new qe(a,r)),this._updateLabelPosition(l);continue}const c=n(r,a),u=(0,Ve.T)(0,0,0,s),j={objectId:l,uid:(0,ht.D)(),attributes:c,visible:d,geometry:u},L=new xt(j,u);L.components.push(new qe(a,r)),this._featuresMap.set(l,L),this._updateLabelGeometry(l),i.push(j)}this.loadedGraphics.addMany(i)}updateLabelPositions(a){const n=this.view.renderCoordsHelper;this._forEachGraphic(a,(e,t,s)=>{const i=this._graphicsCore.getGraphics3DGraphicById(t.uid);null!=i&&this._updateLabelGeometry(a.featureIds[e])&&i.alignWithAbsoluteElevation(s.z??0,n,!1)})}setNodeMetaAttributes(a,n){const e=new Array;this._forEachGraphic(a,(t,s)=>{const i=n(t,a);(0,Ue.y7)(s.attributes,i)||(s.attributes=i,e.push(s.uid))}),this._graphicsCore.updateLabelingInfo(e)}applyFilterChange(a){this._forEachFeature(a,(n,e,t)=>{if(!this._enabledForFeatureInNode(a,n)){const r=a.featureIds[n];switch(this._removeFeature(e,a,n)){case Te.REMOVED:this.loadedGraphics.removeManyByObjectId([r]);break;case Te.MODIFIED:this._updateLabelPosition(r)}return}const s=e.graphic,i=s.visible;i!==t&&(s.visible=t,Me.graphic=s,Me.property="visible",Me.oldValue=i,Me.newValue=t,this._graphicsCore.graphicUpdateHandler(Me))})}removeNodeMeta(a){const n=[];this._forEachGraphic(a,e=>{const t=a.featureIds[e],s=this._featuresMap.get(t);if(s)switch(this._removeFeature(s,a,e)){case Te.MODIFIED:this._updateLabelPosition(t);break;case Te.REMOVED:n.push(t)}}),this.loadedGraphics.removeManyByObjectId(n)}_removeFeature(a,n,e){const t=a.components.length;return(0,re.hv)(a.components,s=>!(s.meta===n&&s.index===e)),0===a.components.length?(this._featuresMap.delete(n.featureIds[e]),Te.REMOVED):t!==a.components.length?Te.MODIFIED:Te.UNMODIFIED}getRenderingInfo(){return this._renderingInfo}notifyGraphicGeometryChanged(){}notifyGraphicVisibilityChanged(){}_updateLabelPosition(a){const n=this._featuresMap.get(a);n&&this._updateLabelGeometry(a)&&(this.loadedGraphics.removeManyByObjectId([a]),this.loadedGraphics.addMany([n.graphic]))}_updateLabelGeometry(a){const n=this._featuresMap.get(a);if(!n)return!1;const e=n.geometry,t=this.view.spatialReference,s=this.view.renderCoordsHelper,i=e.x,r=e.y,l=e.z??0,h=(0,Oe.bg)(n.components.length*Ze.Wx);let c=0;for(const{meta:u,index:j}of n.components)(0,Ze.z6)(j,this.collection,u.objectHandle,h,c),c+=Ze.Wx;return(0,Ie.projectBuffer)(h,s.spatialReference,0,h,t,0,h.length/3),(0,he.t8)(Ge,he.G_),(0,he.G1)(Ge,h),e.x=(Ge[0]+Ge[3])/2,e.y=(Ge[1]+Ge[4])/2,e.z=Ge[5],!(0,we.Po)(e.x,i)||!(0,we.Po)(e.y,r)||!(0,we.Po)(e.z,l)}_forEachGraphic(a,n){this._forEachFeature(a,(e,{graphic:t,geometry:s},i)=>{this._enabledForFeatureInNode(a,e)&&n(e,t,s,i)})}_forEachFeature(a,n){let e=0;for(let t=0;t<a.featureIds.length;t++){const s=this._featuresMap.get(a.featureIds[t]);let i=null==a.filteredIds;a.filteredIds&&a.filteredIds[e]===a.featureIds[t]&&(i=!0,e++),s&&n(t,s,i)}}_enabledForFeatureInNode(a,n){return a.node.index<0||!this.overrides?.featureHasGeometryChanges(a.featureIds[n])}get updatePolicy(){return this._graphicsCore.effectiveUpdatePolicy}get usedMemory(){return this._graphicsCore.usedMemory}get unloadedMemoryEstimate(){return this._graphicsCore.unprocessedMemoryEstimate}get test(){return{graphicsCore:this._graphicsCore}}};(0,g._)([(0,O.Cb)()],ce.prototype,"view",void 0),(0,g._)([(0,O.Cb)()],ce.prototype,"layer",void 0),(0,g._)([(0,O.Cb)()],ce.prototype,"collection",void 0),(0,g._)([(0,O.Cb)()],ce.prototype,"loadedGraphics",void 0),(0,g._)([(0,O.Cb)()],ce.prototype,"overrides",void 0),(0,g._)([(0,O.Cb)()],ce.prototype,"updating",null),(0,g._)([(0,O.Cb)()],ce.prototype,"slicePlaneEnabled",void 0),(0,g._)([(0,O.Cb)()],ce.prototype,"_graphicsCore",void 0),ce=(0,g._)([(0,Y.j)("esri.views.3d.layers.I3SMeshViewLabeler")],ce);const Me={graphic:null,property:null,oldValue:null,newValue:null};var Te,a;(a=Te||(Te={}))[a.UNMODIFIED=0]="UNMODIFIED",a[a.MODIFIED=1]="MODIFIED",a[a.REMOVED=2]="REMOVED";const Ge=(0,he.Ue)(),ls=ce;var ds=o(46196);class hs extends ds.W{constructor(n,e,t,s,i,r,l){super(n,0,0,0,e),this.gpuMB=t,this.geometryMB=s,this.textureMB=i,this.unloadedMB=r,this.idbHitRate=l}}var cs=o(42930),us=o(55915),Ke=o(17926);class gs extends cs.q{constructor(n){super("SceneLayerWorker","process",{process:e=>[e.geometryBuffer],project:e=>[e.positions.buffer],transformNormals:e=>[e.normals.buffer]},n,{hasInitialize:!0})}setModifications(n,e,t,s){const i={context:n,modifications:Lt(e,t,s),isGeodetic:s.isGeographic};this.broadcast(i,"setModifications")}setLegacySchema(n,e){const t=JSON.stringify(e);return this.broadcast({context:n,jsonSchema:t},"setLegacySchema")}destroyContext(n){return this.broadcast(n,"destroyContext")}project(n,e){return this.invokeMethod("project",n,e)}transformNormals(n,e){return this.invokeMethod("transformNormals",n,e)}}const y=new le.Z({deallocator:null}),$e=(0,x.Ue)();function Lt(a,n,e){y.clear();let t=1/0,s=1/0,i=-1/0,r=-1/0,l=!1;for(const h of n){const c="clip"===h.type?Ke.B.Inside:"mask"===h.type?Ke.B.Outside:Ke.B.Replace,u=h.geometry;let j=L=>L;if(u.spatialReference){if(!(0,us.canProjectWithoutEngine)(u.spatialReference,e)){V.Z.getLogger("esri.views.3d.layers.I3SMeshWorkerHandle").warn("Can't project modification polygon into layer spatial reference, ignoring modification");continue}j=L=>((0,ne.S)(L,u.spatialReference,$e,e),$e)}else u.hasZ||($e[2]=0,j=L=>($e[0]=L[0],$e[1]=L[1],$e));l=l||c===Ke.B.Outside,y.push(c),y.push(u.rings.length);for(const L of u.rings){y.push(L.length);for(const ee of L){const J=j(ee);y.push(J[0]),y.push(J[1]),y.push(J[2]),t=Math.min(t,J[0]),s=Math.min(s,J[1]),i=Math.max(i,J[0]),r=Math.max(r,J[1])}}}null!=a&&(l?(y.push(Ke.B.Inside),y.push(2),y.push(4),y.push(t-1e-4),y.push(s-1e-4),y.push(0),y.push(i+1e-4),y.push(s-1e-4),y.push(0),y.push(i+1e-4),y.push(r+1e-4),y.push(0),y.push(t-1e-4),y.push(r+1e-4),y.push(0),y.push(4),y.push(a[0]),y.push(a[1]),y.push(0),y.push(a[2]),y.push(a[1]),y.push(0),y.push(a[2]),y.push(a[3]),y.push(0),y.push(a[0]),y.push(a[3]),y.push(0)):(y.push(Ke.B.Outside),y.push(1),y.push(4),y.push(a[0]),y.push(a[1]),y.push(0),y.push(a[2]),y.push(a[1]),y.push(0),y.push(a[2]),y.push(a[3]),y.push(0),y.push(a[0]),y.push(a[3]),y.push(0))),y.push(Ke.B.Finished);const d=new Float64Array(y.length);for(let h=0;h<y.length;++h)d[h]=y.at(h);return d}var F=o(52836),pt=o(30375),Bt=o(67225),fs=o(29425),je=o(81937);class ps{constructor(){this.ids=new Set}}class _s{constructor({collection:n,forAllFeatures:e,forAllFeaturesOfNode:t}){this._highlights=[],this._collection=n,this._forAllFeatures=e,this._forAllFeaturesOfNode=t}destroy(){this._highlights.forEach(n=>this._releaseSet(n)),this._highlights=null}acquireSet(){const n=new ps;this._highlights.push(n);const e=(0,W.kB)(()=>{this._highlights&&(this._releaseSet(n),(0,re.e$)(this._highlights,n))});return{set:n,handle:e}}setFeatureIds(n,e){e.forEach(t=>n.ids.add(t)),this._initializeSet(n)}_initializeSet(n){this._forAllFeatures((e,t,s)=>(n.ids.has(e)&&this._collection.addComponentHighlight(s.objectHandle,t),F.Ku.CONTINUE))}_releaseSet(n){this._forAllFeatures((e,t,s)=>(n.ids.has(e)&&this._collection.removeComponentHighlight(s.objectHandle,t),F.Ku.CONTINUE))}objectCreated(n){this._highlights.forEach(e=>{this._forAllFeaturesOfNode(n,(t,s)=>(e.ids.has(t)&&this._collection.addComponentHighlight(n.objectHandle,s),F.Ku.CONTINUE))})}objectDeleted(n){this._collection.clearHighlights(n.objectHandle)}}o(4619);var ms=o(51541),wt=o(87091);let _t=class extends ve.Z{constructor(a,n,e,t){super({}),this._updateExtent=n,this._updateNode=e,this._getElevationMode=t,this.running=!1,this._extentSet=new ms.D,this._nodeSet=new Set;const s=this._taskPriority,i=a.registerTask(this._taskPriority,this);this.addHandles(i),this._task=i,this._lastTaskPriority=s}get _taskPriority(){const a=this._getElevationMode();return a&&a===F.vV.RelativeToGround?wt.T8.ELEVATION_ALIGNMENT_SCENE:wt.T8.ELEVATION_ALIGNMENT}_updateTaskPriority(){const a=this._taskPriority;a!==this._lastTaskPriority&&(this._task.priority=a,this._lastTaskPriority=a)}normalizeCtorArgs(){return{}}addExtent(a){this._extentSet.add(a),this._updateTaskPriority(),this.running=!0}schedule(a){this._nodeSet.add(a),this._updateTaskPriority(),this.running=!0}remove(a){this._nodeSet.delete(a),this._updateRunning()}runTask(a){const n=this._extentSet;for(a.run(()=>n.merge(a));!n.empty&&!a.done;)this._updateExtent(n.pop())?.forAll(s=>this.schedule(s)),a.madeProgress();if(a.done)return;const e=this._nodeSet;for(const t of e)if(e.delete(t),this._updateNode(t),a.madeProgress(),a.done)break;this._updateRunning()}_updateRunning(){this.running=this._nodeSet.size>0||this._extentSet.size>0}};(0,g._)([(0,O.Cb)()],_t.prototype,"running",void 0),_t=(0,g._)([(0,Y.j)("esri.views.3d.layers.i3s.I3SAsyncElevationUpdater.ts")],_t);var mt=o(73683);class ys{constructor(){this.lodCrossfadeSignedDuration=0}}class vs{constructor(n){this._view=n,this._preRenderFrameTaskHandle=null,this._currentFrameStartTime=null,this._numFadingNodes=0}destroy(){this._preRenderFrameTaskHandle?.remove(),this._preRenderFrameTaskHandle=null,this._view=null}get updating(){return this._numFadingNodes>0}stopNodeFading(n){null!=n.lodCrossfadeProgress&&(this._numFadingNodes--,n.lodCrossfadeProgress=null,0===this._numFadingNodes&&(null!=this._preRenderFrameTaskHandle&&(this._preRenderFrameTaskHandle=(0,N.hw)(this._preRenderFrameTaskHandle)),this._view.notifyLODUpdate(),this._view.notifyUpdate()))}_startNodeFading(n,e,t){0===this._numFadingNodes&&(this._preRenderFrameTaskHandle=(0,Q.A)({preRender:s=>this._updateAllNodeFading(s)}),this._view.notifyLODUpdate()),null==n.lodCrossfadeProgress&&(this._numFadingNodes++,this._view.notifyUpdate()),n.lodCrossfadeSignedDuration=t,n.lodCrossfadeProgress=e}_updateAllNodeFading(n){const e=this._view.nodeCrossfadingEnabled;this._view.foreachCrossfadeNode((t,s)=>{if(null!=t?.lodCrossfadeProgress){const i=t.lodCrossfadeSignedDuration,r=i>0?this._view.fullOpacity:0,d=t.lodCrossfadeProgress+Math.abs(n.deltaTime/i),h=!e||d>=1||0===i,c=r-(h?0:i>0?1:-1)*(1-d);h?(this.stopNodeFading(t),i<0&&this._view.markNodeToRemove(s)):t.lodCrossfadeProgress=d,this._view.setNodeOpacityByIndex(s,c)}}),this._view.removeMarkedNodes()}stopAllNodeFading(){this._view.foreachCrossfadeNode((n,e)=>{if(null!=n?.lodCrossfadeProgress){this.stopNodeFading(n);const t=n.lodCrossfadeSignedDuration;t<0&&this._view.markNodeToRemove(e),this._view.setNodeOpacityByIndex(e,t>0?this._view.fullOpacity:0)}}),this._view.removeMarkedNodes()}fadeNode(n,e,t,s){null==this._currentFrameStartTime&&(this._currentFrameStartTime=Date.now());const i=this._view,r=i.nodeCrossfadingEnabled,l=t===mt.B.FadeIn?i.fullOpacity:0,d=r?s?t===mt.B.FadeIn?i.lodCrossfadeinDuration:i.lodCrossfadeoutDuration:i.lodCrossfadeUncoveredDuration:0,h=this._view.getNodeOpacityByIndex(n);if(r&&h!==l&&d>0){const c=1-Math.abs(l-h);this._startNodeFading(e,c,function bs(a){return a===mt.B.FadeIn?1:-1}(t)*d)}else this.stopNodeFading(e),this._view.setNodeOpacityByIndex(n,l),t===mt.B.FadeOut&&this._view.removeNode(n)}isNodeFullyFadedIn(n){const e=this._view.getNodeCrossfadeMetaData(n);return null==e||null==e.lodCrossfadeProgress&&this._view.getNodeOpacityByIndex(n)===this._view.fullOpacity}}var Is=o(59617),k=o(42964),Es=o(77926),Ms=o(62483),Vt=o(67857),Cs=o(40841);class Os{constructor(n){this.type=Vt.q7.I3S,this._needVerticalOffset=!1,this.layerUid=n.layerUid,this.sublayerUid=n.sublayerUid,this._collection=n.collection,this._traverseNodeHierarchy=n.traverseNodeHierarchy,this.slicePlaneEnabled=n.slicePlaneEnabled,this.isGround=n.isGround}updateElevationAlignState(n,e){this._needVerticalOffset=n&&e===Is.JY.Global}intersect(n,e,t,s,i,r){const l=r??!1,d=n.results,h=n.options.store===Vt.eC.ALL,c=n.ray.direction,u=n.tolerance;let j=p=>p,L=p=>p;const ee=(0,Cs.iO)(n.verticalOffset??(this._needVerticalOffset?0:null));null!=n.verticalOffset&&null!=ee&&(j=p=>ee.applyToMbs(p),L=p=>ee.applyToObb(p)),this._traverseNodeHierarchy((p,B)=>{if(0===p.childrenLoaded)return!1;const D=p.serviceObbInRenderSR?.isValid?p.serviceObbInRenderSR:null;return!(D&&!L(D).intersectRay(t,c,u)||(!B||!D&&(0,k.c$)(p.serviceMbsInRenderSR)&&!function Rs(a,n,e,t=0){const s=a[3]+t,i=n[0]-a[0],r=n[1]-a[1],l=n[2]-a[2],d=e[0],h=e[1],c=e[2],u=d*i+h*r+c*l;return u*u-(d*d+h*h+c*c)*(i*i+r*r+l*l-s*s)>=0}(j(p.serviceMbsInRenderSR),t,c,u)||null!=p.geometryObbInRenderSR&&!L(p.geometryObbInRenderSR).intersectRay(t,c,u)||this._collection.intersect(B,t,s,u,ee,(E,I,Z,K)=>{if(I<0||null!=e&&!e(t,s,I))return;const be=Ae=>{const ot=new Es.f9(this.layerUid,this.sublayerUid,p.index,E,K);Ae.set(this.type,ot,I,Z)};if(this.isGround&&(null==d.ground.dist||I<d.ground.dist)&&be(d.ground),!n.options.isFiltered&&((null==d.min.dist||I<d.min.dist)&&be(d.min),(null==d.max.dist||I>d.max.dist)&&be(d.max),h)){const Ae=(0,Ms.LP)(n.ray);be(Ae),n.results.all.push(Ae)}},l),0))})}}var et=o(42767),St=o(52565),xs=o(39159),Pt=o(5590),Ss=o(26584);class Ds{constructor(n,e,t=14){this._version=t,this._db=null,this._quotaReductionPromise=null,this._gcCounter=0,this._hit=0,this._miss=0,this._destroyed=!1,this.gcFrequency=50,this.maxByteSize=oe.Y.GIGABYTES,this.quotaReductionFactor=.2,this._dbName=n,this._storeName=e}init(){return Promise.resolve().then(()=>{const n=indexedDB.open(this._dbName,this._version);return n.onupgradeneeded=e=>{const t=n.result,s=n.transaction,i=t.objectStoreNames.contains(this._storeName)?s.objectStore(this._storeName):t.createObjectStore(this._storeName),r=t.objectStoreNames.contains("last_access")?s.objectStore("last_access"):t.createObjectStore("last_access");r.indexNames.contains("date")||r.createIndex("date","date",{unique:!1}),r.indexNames.contains("byteSize")||r.createIndex("byteSize","byteSize",{unique:!1}),e.oldVersion<this._version&&(i.clear(),r.clear())},Ye(n)}).then(n=>{this._destroyed?n.close():this._db=n})}destroy(){this._db&&(this._db.close(),this._db=null),this._destroyed=!0}get initialized(){return null!=this._db}getHitRate(){return this._hit/(this._hit+this._miss)}put(n,e){return null==this._db?Promise.reject(new Ss.Z("indexedb:not-initialized","IndexedDB Cache is not initialized")):(null!=this._quotaReductionPromise?this._quotaReductionPromise:Promise.resolve()).then(()=>this._put(n,e)).catch(t=>{if(t&&"QuotaExceededError"===t.name)return null==this._quotaReductionPromise&&(this._quotaReductionPromise=this._getCacheSize().then(s=>this._removeLeastRecentlyAccessed(e.byteSize+Math.ceil(s*this.quotaReductionFactor))),this._quotaReductionPromise.then(()=>this._quotaReductionPromise=null,()=>this._quotaReductionPromise=null)),this._quotaReductionPromise.then(()=>this._put(n,e));throw t}).then(()=>{this._gcCounter--,this._gcCounter<0&&null!=this._db&&(this._gcCounter=this.gcFrequency,this._getCacheSize().then(t=>this._removeLeastRecentlyAccessed(t-this.maxByteSize)))})}get(n,e){const t=this._db;if(null==t)return Promise.resolve(void 0);let s=null;return Promise.resolve().then(()=>{const i=t.transaction(this._storeName,"readonly");return s=(0,T.fu)(e,()=>{i.abort()}),Ye(i.objectStore(this._storeName).get(n))}).then(i=>(null==i?++this._miss:this._db&&(++this._hit,this._db.transaction("last_access","readwrite").objectStore("last_access").put({date:Date.now(),byteSize:i.byteSize},n)),s?.remove(),i)).catch(()=>{++this._miss,(0,T.k_)(e),s?.remove()})}remove(n){var e=this;const t=this._db;return null==t?Promise.resolve():Promise.resolve().then((0,C.Z)(function*(){const s=t.transaction([e._storeName,"last_access"],"readwrite"),i=s.objectStore(e._storeName),r=s.objectStore("last_access"),l=i.delete(n),d=r.delete(n);yield Promise.all([Ye(l),Ye(d),yt(s)])}))}_put(n,e){const t=this._db;if(null==t)return Promise.resolve();const s=t.transaction([this._storeName,"last_access"],"readwrite"),i=s.objectStore(this._storeName),r=s.objectStore("last_access"),l=i.put(e,n),d=r.put({date:Date.now(),byteSize:e.byteSize},n);return Promise.all([Ye(l),Ye(d),yt(s)])}_removeLeastRecentlyAccessed(n){if(n<=0||!this._db)return Promise.resolve();const e=this._db.transaction([this._storeName,"last_access"],"readwrite"),t=e.objectStore(this._storeName),s=e.objectStore("last_access");let i=0;const r=s.index("date").openCursor(null,"next");return r.onsuccess=()=>{const l=r.result;null!=l&&(null!=l.value.byteSize&&(i+=l.value.byteSize),t.delete(l.primaryKey),s.delete(l.primaryKey),i<n&&l.continue())},yt(e)}_getCacheSize(){const n=this._db;if(null==n)return Promise.resolve(0);const e=n.transaction("last_access"),t=e.objectStore("last_access");let s=0;const i=t.index("byteSize").openKeyCursor();return i.onsuccess=()=>{const r=i.result;if(!r)return;const l=r.key;null!=l&&(s+=l),r.continue()},yt(e).then(()=>s)}}function yt(a){return new Promise((n,e)=>{a.oncomplete=()=>n(),a.onerror=()=>e(a.error),a.onabort=()=>e(a.error)})}function Ye(a){return new Promise((n,e)=>{"done"===a.readyState?null!=a.error?e(a.error):n(a.result):(a.onsuccess=()=>n(a.result),a.onerror=()=>e(a.error))})}const Ht=new WeakMap;class As{constructor(n,e){switch(this._miss=0,this._hit=0,this.initialized=!0,e){case"layer":this._data=new Map;break;case"view":{const t=Ht.get(n);if(t){this._data=t;break}const s=new Map;this._data=s,Ht.set(n,s)}}}init(){return Promise.resolve()}get(n,e){var t=this;return(0,C.Z)(function*(){if(t._data.has(n))return t._hit++,t._data.get(n)??void 0;t._miss++})()}destroy(){}put(n,e){return this._data.set(n,e),Promise.resolve()}remove(n){return this._data.delete(n),Promise.resolve()}getHitRate(){return this._hit/(this._hit+this._miss)}}var Ns=o(46884),Dt=o(97445),Ts=o(95201),vt=o(9044),tt=o(93605),At=o(74993),Gt=o(55745),st=o(93394),js=o(41632),Us=o(4511),Fs=o(27355),bt=o(36603),Kt=o(13756),It=o(17803);const Wt="esri.views.3d.layers.I3SMeshView3D",De=()=>V.Z.getLogger(Wt),zt=[1,1,1,1];class Ls extends ys{constructor(n,e,t,s,i,r,l,d,h){super(),this.node=n,this.featureIds=e,this.objectHandle=t,this.cachedRendererVersion=s,this.attributeInfo=i,this.material=r,this.textures=l,this.anchorIds=d,this.anchors=h,this.cachedElevationAnchors=null,this.cachedEdgeMaterials=new Array,this.edgeMemoryUsage=0}}var We;!function(a){a[a.CastShadows=4]="CastShadows",a[a.Pickable=5]="Pickable"}(We||(We={}));const ws=100*oe.Y.MEGABYTES,Vs=a=>{let n=class extends a{constructor(...e){super(e),this._needsNormals=!0,this._updatingHandles=new X.R,this._nodeId2Meta=new Map,this._nodeId2MetaReloading=new Map,this._i3sWasmLoaded=!1,this._snappingSourcesTrackers=[],this._hasLoadedPBRTextures=!1,this._asyncModuleLoading=0,this._addTasks=new Map,this._currentRenderer=null,this._rendererVersion=0,this._colorVariable=null,this._opacityVariable=null,this._rendererFields=null,this._symbologyFields=null,this._symbologyOverride=null,this._symbologyOverrideFields=null,this._symbolInfos=new Map,this._visibleGeometryChangedSchedulerHandle=null,this._hasComponentData=!1,this._hasVertexColors=!1,this._nodeColorOverride=null,this.updating=!0,this.holeFilling="auto",this._hasColors=!1,this._hasTextures=!1,this._hasData=!1,this.slicePlaneEnabled=!1,this._modifications=new Array,this.ignoresMemoryFactor=!1,this._layerUrl="",this._cacheKeySuffix=null,this._planetRadiusInGlobalMode=0,this._elevationTask=null,this._filters=[],this._arcade=null,this._tmpAttributeOnlyGraphic=new b.Z(null,null,{}),this._crossfadeHelper=new vs(this)}get lodCrossfadeoutDuration(){return 0}get lodCrossfadeinDuration(){return 0}get lodCrossfadeUncoveredDuration(){return 0}get layerUid(){return this.i3slayer&&this.i3slayer.uid}get sublayerUid(){return null}get layerId(){return this.i3slayer&&this.i3slayer.id}get sublayerId(){return null}get contentVisible(){return!this.suspended&&this._controller?.rootNodeVisible}get legendEnabled(){return this.contentVisible&&!0===this.i3slayer?.legendEnabled}get updatingProgressValue(){return this._controller?.updatingProgress??0}get hasTexturesOrVertexColors(){return this._hasData?this._hasTextures||this._hasColors?"yes":"probably-not":"unknown"}get rendererTextureUsage(){return(0,k.a7)(this._currentRenderer)?this._usePBR||this._hasLoadedPBRTextures?je.v.AllTexturesPBR:je.v.AllTextures:this._usePBR||this._hasLoadedPBRTextures?je.v.GeometryTexturesPBR:je.v.GeometryTextures}get elevationOffset(){const e=null!=this.i3slayer?this.i3slayer.elevationInfo:null;if(null!=e&&"absolute-height"===e.mode){const t=(0,se._R)(this.i3slayer.spatialReference),s=(0,ze.Z7)(e.unit);return(e.offset??0)*s/t}return 0}get elevationInfo(){const e=null!=this.i3slayer?this.i3slayer.elevationInfo:null;if(null==e)return new rt(F.vV.Absolute,0);const t=(0,se._R)(this.i3slayer.spatialReference),s=(0,ze.Z7)(e.unit),i=(e.offset??0)*s/t;switch(e.mode){case"absolute-height":return new rt(F.vV.Absolute,i);case"relative-to-ground":return new rt(F.vV.RelativeToGround,i);case"on-the-ground":return new rt(F.vV.OnTheGround,0);default:return new rt(F.vV.Absolute,0)}}get supportedTextureEncodings(){return(0,et.K0)(this.view._stage.renderView.capabilities)}get uncompressedTextureDownsamplingEnabled(){const e=this.view?.qualitySettings.sceneService.uncompressedTextureDownsamplingEnabled;return e&&0==(this.supportedTextureEncodings&je.j.DDS_S3TC)}get clientGeometry(){return this.i3sOverrides.geometryOverrides}get elevationRange(){const e=this._nodeId2Meta,t=new At.r;for(const s of e.values()){if(null==s)continue;const{node:{serviceMbsInIndexSR:i}}=s,[r,l,d,h]=i;t.expandElevationRangeValues(d-h,d+h)}return t.elevationRangeValid?t:null}get fullExtent(){return this.i3slayer.fullExtent}initialize(){const e=(0,z.Z)("enable-feature:idb-mock-cache");this._idbCache=e?new As(this.view,e):new Ds("esri-scenelayer-cache","geometries"),this._preLoadBasis(),this.addResolvingPromise(this.i3slayer.indexInfo);const t=this.view.resourceController;this.i3sOverrides=new xs.v({view:this.view,layer:this.i3slayer,memoryController:t.memoryController}),this._worker=new gs((0,Ts.H)(t)),this.addResolvingPromise(this._worker.promise);const i=this.i3slayer.store;this._worker.setLegacySchema(this.uid,i.defaultGeometrySchema),(0,k.p8)(this.i3slayer),(0,k.gn)(this.i3slayer,this.view),this._layerUrl=this.i3slayer.parsedUrl.path,this._controller=new ae.Z({layerView:this,worker:this._worker}),this._gpuMemoryEstimate=0,this._texMemoryEstimate=0,this._geoMemoryEstimate=0,this._stage=this.view._stage,this._collection=this._stage.renderView.componentObjectCollection,this.resetHighlights();const r=i.defaultGeometrySchema;if(this._isIntegratedMesh||!r)this._hasComponentData=!1;else{const p=r.featureAttributes;this._hasComponentData=!!(p&&p.faceRange&&p.id)}this._hasVertexColors=null!=(r?.vertexAttributes.color??null)&&!this.i3slayer.cachedDrawingInfo?.color,this._isIntegratedMesh||(this._edgeView=this._stage.renderer.ensureEdgeView());const l=this.view.resourceController.memoryController.newCache(`sl-${this.uid}`,p=>this._deleteComponentObject(p));this._memCache=l;const d=this._controller,h=this._nodeId2Meta,c=this._nodeId2MetaReloading;this._intersectionHandler=new Os({layerUid:this.layerUid,sublayerUid:this.sublayerUid,collection:this._collection,slicePlaneEnabled:this.slicePlaneEnabled,isGround:this._isIntegratedMesh,traverseNodeHierarchy:p=>{const B=d.index;if(!B)return;const D=B.rootNode;D&&B.traverse(D,I=>{const Z=I.index,K=h.get(Z)||c.get(Z);return p(I,K?.objectHandle??null)})}}),this._updatingHandles.add(()=>this.layerUid,p=>this._intersectionHandler.layerUid=p),this._updatingHandles.add(()=>this.sublayerUid,p=>this._intersectionHandler.sublayerUid=p),this._elevationProvider=new Ns.u({view:this.view,layerElevationSource:this,intersectionHandler:this._intersectionHandler}),this._hasLoadedPBRTextures=this._usePBR,this._updatingHandles.add(()=>this.view.clippingArea,()=>this._clippingAreaChanged(),S.nn),this._updatingHandles.add(()=>this.fullOpacity,p=>this._opacityChange(p)),this._updatingHandles.add(()=>this.slicePlaneEnabled,p=>this._slicePlaneEnabledChange(p)),this._updatingHandles.add(()=>this.elevationOffset,(p,B)=>{this._reloadAll(B),this._controller.invalidateVisibilityObbs()}),this._updatingHandles.add(()=>this.elevationInfo,(p,B)=>this._elevationInfoChanged(p,B),S.nn),this._updatingHandles.add(()=>!this.suspended&&this.elevationInfo.mode!==F.vV.Absolute,(p,B)=>{p?this.addHandles(this.view.basemapTerrain.on("elevation-change",({extent:D})=>this._ensureElevationTask().addExtent(D)),es):B&&this.removeHandles(es)},S.nn),this._updatingHandles.add(()=>this._usePBR,p=>this._updatePBR(p));const j=()=>{this._reloadAll(),this.clearMemCache()};this._updatingHandles.add(()=>this.rendererTextureUsage,j),this._updatingHandles.add(()=>this.uncompressedTextureDownsamplingEnabled,j),this._updatingHandles.add(()=>this.contentVisible,p=>this._contentVisibleChanged(p),S.nn),this._updatingHandles.add(()=>this.i3slayer.labelsVisible,()=>this._labelingChanged(),S.nn),this._updatingHandles.add(()=>this.i3slayer.labelingInfo,()=>this._labelingChanged(),S.nn),this._updatingHandles.add(()=>this._modifications,()=>this._modificationsChanged(),S.nn),this.addHandles([(0,S.YP)(()=>tt.h.I3S_TREE_SHOW_TILES,p=>{if(p&&!this._treeDebugger){const B=this._controller.crsIndex;Promise.all([o.e(8592),o.e(3109)]).then(o.bind(o,3109)).then(({I3STreeDebugger:D})=>{!this._treeDebugger&&tt.h.I3S_TREE_SHOW_TILES&&(this._treeDebugger=new D({lv:this,view:this.view,nodeSR:B}))})}else p||tt.h.I3S_TREE_SHOW_TILES||(this._treeDebugger=(0,N.SC)(this._treeDebugger))},S.nn),(0,S.YP)(()=>tt.h.I3S_SHOW_MODIFICATIONS,()=>this._showModifications(),S.nn)]),this._cacheKeySuffix=(0,k.ei)(this.i3slayer.spatialReference,this.view.renderSpatialReference),this._idbCache.init().catch(p=>De().warn(`Failed to initialize IndexedDB cache: ${p}`));const{view:L}=this,{viewingMode:ee,renderCoordsHelper:J}=L;this._planetRadiusInGlobalMode="local"===ee?0:J.referenceEllipsoid.radius}destroy(){this._clearAddTasks(),this._elevationTask=(0,N.SC)(this._elevationTask),this.i3sOverrides=(0,N.SC)(this.i3sOverrides),this._elevationProvider&&(this._elevationProvider.objectsChanged(this.getVisibleObbs()),this.view.elevationProvider.unregister(this._elevationProvider),this._elevationProvider=null),this._intersectionHandler&&(this._stage.view.sceneIntersectionHelper.removeIntersectionHandler(this._intersectionHandler),this._intersectionHandler=null);const e=this._worker;e&&(e.destroyContext(this.uid).then(()=>e.destroy()),this._worker=null),this._removeAllNodeDataFromStage(),this._memCache=(0,N.SC)(this._memCache),this._collection=null,this._stage=null,this._edgeView=null,this._labeler=(0,N.SC)(this._labeler),this._treeDebugger=(0,N.SC)(this._treeDebugger),this._controller=(0,N.SC)(this._controller),this._highlights.destroy(),this._nodeId2Meta.clear(),this._nodeId2MetaReloading.clear(),this._crossfadeHelper=(0,N.SC)(this._crossfadeHelper),this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle.remove(),this._visibleGeometryChangedSchedulerHandle=null),this._updatingHandles=(0,N.SC)(this._updatingHandles)}_memEstimateTextureAdded(e){const t=e.memoryEstimate;return this._gpuMemoryEstimate+=t,this._texMemoryEstimate+=t,t}_memEstimateTextureRemoved(e){if(null!=e){const t=e.memoryEstimate;this._gpuMemoryEstimate-=t,this._texMemoryEstimate-=t}}_memEstimateGeometryAdded(e){const t=this._collection.getObjectGPUMemoryUsage(e);return this._gpuMemoryEstimate+=t,this._geoMemoryEstimate+=t,t}_memEstimateGeometryRemoved(e){const t=this._collection.getObjectGPUMemoryUsage(e);this._gpuMemoryEstimate-=t,this._geoMemoryEstimate-=t}isNodeLoaded(e){return this._nodeId2Meta.has(e)}isNodeReloading(e){return this._nodeId2MetaReloading.has(e)}get usedMemory(){let e=null!=this._labeler?this._labeler.usedMemory:0;return this._nodeId2Meta.forEach(t=>e+=null!=t?t.node.memory:0),this._nodeId2MetaReloading.forEach(t=>e+=null!=t?t.node.memory:0),e}get unloadedMemory(){return(null!=this._controller?this._controller.unloadedMemoryEstimate:0)+(null!=this._labeler?this._labeler.unloadedMemoryEstimate:0)}_labelingChanged(){if(!(0,fs.C)(this.i3slayer)||!this._supportsLabeling)return void(null!=this._labeler&&(this._labeler.destroy(),this._labeler=null));if(null!=this._labeler)return;const e=new ls({view:this.view,layer:this.i3slayer,collection:this._collection,overrides:this.i3sOverrides});this._nodeId2Meta.forEach(t=>null!=t&&this._addMetaToLabeler(e,t)),this._labeler=e}_loadAsyncModule(e){return++this._asyncModuleLoading,e.then(t=>(--this._asyncModuleLoading,t),t=>{throw--this._asyncModuleLoading,t})}_modificationsChanged(){if(!this._i3sWasmLoaded&&this.hasModifications)return this._i3sWasmLoaded=(0,pt.initialize)().then(()=>{this._i3sWasmLoaded=!0,this._modificationsChanged(),this.notifyUpdate()}),void this.notifyUpdate();if(!0!==this._i3sWasmLoaded)return;const e=this.uid,t=this.i3slayer.spatialReference;this._worker.setModifications(e,this._layerClippingArea,this._modifications,t);const s=Lt(this._layerClippingArea,this._modifications,t);(0,pt.setModificationsSync)({context:e,modifications:s,isGeodetic:t.isGeographic}),this._controller.modificationsChanged();const i=this.hasModifications?new le.Z:null;this._nodeId2Meta.forEach((r,l)=>{null==r?(this._nodeId2Meta.delete(l),this._controller.updateLoadStatus(l,!1)):r.node.hasModifications?(this._nodeId2Meta.delete(l),this._nodeId2MetaReloading.set(l,r)):i?.push(r.node)}),this.notifyChange("elevationRange"),null!=i&&this._nodeId2MetaReloading.forEach(r=>i.push(r.node)),null!=i&&i.length>0&&(this.updateNodeModificationStatus(i),i.forAll(r=>{if(r.imModificationImpact!==St.O4.Culled){const l=this._nodeId2Meta.get(r.index);this._controller.invalidateGeometryVisibility(r.index),null!=l?(this._nodeId2Meta.delete(r.index),this._nodeId2MetaReloading.set(r.index,l),this.notifyChange("elevationRange")):this._nodeId2Meta.has(r.index)&&(this._nodeId2Meta.delete(r.index),this._controller.updateLoadStatus(r.index,!1))}})),this.clearMemCache(),this._controller.restartNodeLoading(),this._showModifications()}_showModifications(){if(null!=this._modificationGraphics&&(this.view.graphics.removeMany(this._modificationGraphics),this._modificationGraphics=null),!tt.h.I3S_SHOW_MODIFICATIONS||0===this._modifications.length)return;const e={clip:[227,227,79,.8],mask:[227,139,79,.8],replace:[139,227,79,.8]},t={type:"simple-fill",outline:{color:[255,255,255],width:1}};this._modificationGraphics=new Array;for(const s of this._modifications){const i=s.geometry;i.spatialReference=this.i3slayer.spatialReference;const r={...t,color:e[s.type]};this._modificationGraphics.push(new b.Z({geometry:i,symbol:r}))}this.view.graphics.addMany(this._modificationGraphics)}_addMetaToLabeler(e,t){e.addNodeMeta(t,(s,i)=>this._createAttributes(s,i))}_contentVisibleChanged(e){e?(this.view.elevationProvider.register(this._elevationContext,this._elevationProvider),this._stage.view.sceneIntersectionHelper.addIntersectionHandler(this._intersectionHandler)):(this._removeAllNodeDataFromStage(),this.view.elevationProvider&&this.view.elevationProvider.unregister(this._elevationProvider),this._stage.view.sceneIntersectionHelper.removeIntersectionHandler(this._intersectionHandler))}getLoadedAttributes(e){const t=this._nodeId2Meta.get(e);if(null!=t?.attributeInfo)return t.attributeInfo.loadedAttributes}getAttributeData(e){const t=this._nodeId2Meta.get(e);if(null!=t?.attributeInfo)return t.attributeInfo.attributeData}setAttributeData(e,t){const s=this._nodeId2Meta.get(e);null!=s?.attributeInfo&&(s.attributeInfo.attributeData=t,this._attributeValuesChanged(s))}updateAttributes(e,t,s){var i=this;return(0,C.Z)(function*(){const r=i._nodeId2Meta.get(e);null!=r&&(yield i.i3sOverrides.applyAttributeOverrides(r.featureIds,t,s,i._controller.requiredAttributes),r.attributeInfo=t,i._controller.reschedule(()=>i._attributeValuesChanged(r),s).catch(l=>{(0,T.D_)(l)||De().warn("Error while updating attribute values. Layer might not display correctly.",l)}))})()}_attributeValuesChanged(e){e.cachedRendererVersion=this._getInvalidRendererVersion(),e.filteredIds=null,null!=this._labeler&&this._labeler.setNodeMetaAttributes(e,(t,s)=>this._createAttributes(t,s)),this._updateEngineObject(e)}clearMemCache(){null!=this._memCache&&this._memCache.clear()}getVisibleNodes(){const e=new Array;return this._nodeId2Meta.forEach(t=>null!=t&&e.push(t.node)),e}getVisibleObbs(){const e=new Array;return this._nodeId2Meta.forEach(t=>{if(null!=t){const s=this.getNodeComponentObb(t.node);null!=s&&e.push(s)}}),e}getNodeComponentObb(e){const t=this._nodeId2Meta.get(e.index)??this._nodeId2MetaReloading.get(e.index);return null!=t?this._collection.getComponentObb(t.objectHandle):null}getLoadedNodeIndices(e){this._nodeId2Meta.forEach((t,s)=>e.push(s)),this._nodeId2MetaReloading.forEach((t,s)=>e.push(s))}_preLoadBasis(){!(0,z.Z)("disable-feature:i3s-basis")&&this.supportedTextureEncodings&je.j.Basis&&this.i3slayer.textureSetDefinitions?.some(e=>e.formats.some(t=>"basis"===t.format||"ktx2"===t.format))&&(0,Kt.$8)()}_getVertexBufferLayout(e,t){const s={hasTexture:Jt(e.params.material),hasNormals:t.normal,hasRegions:t.uvRegion};return(0,Us.K)((0,Fs.N)(this._getGeometryParameters(s)))}_getObjectIdField(){return this.i3slayer.objectIdField||ge.d}_getGlobalIdField(){return this.i3slayer.associatedLayer?.globalIdField}_findGraphicNodeAndIndex(e){const t=(0,Dt.g)(this.i3slayer.fieldsIndex,e.attributes,this._getObjectIdField());let s=null;return(0,$.oE)(this._nodeId2Meta,i=>{if(null==i)return!1;const r=i.featureIds.indexOf(t);return-1!==r&&(s={node:i.node,index:r},!0)}),s}_getGraphicIndices(e,t){const s=this._nodeId2Meta.get(e.index);if(null==s)return[];const i=[],r=this._getObjectIdField(),l=this.i3slayer.fieldsIndex;for(const d of t){const h=(0,Dt.g)(l,d.attributes,r),c=s.featureIds.indexOf(h);-1!==c&&i.push(c)}return i}whenGraphicBounds(e){const t=this._findGraphicNodeAndIndex(e);if(!t)return Promise.reject();const s=this._getAABB(t.node.index,t.index);return null==s?Promise.reject():Promise.resolve({boundingBox:s,screenSpaceObjects:[]})}getAABBFromIntersectorTarget(e){return null==e.nodeIndex||null==e.componentIndex?null:this._getAABB(e.nodeIndex,e.componentIndex)}_getAABB(e,t){const s=this._nodeId2Meta.get(e);if(null==s?.featureIds||t>=s.featureIds.length)return null;const r=(0,Ze.z6)(t,this._collection,s.objectHandle,(0,Oe.bg)(24),0);if(!(0,Ie.projectBuffer)(r,this.view.renderSpatialReference,0,r,this.view.spatialReference,0,8))return null;const h=(0,he.cS)();return(0,he.G1)(h,r,0,8),h}whenGraphicAttributes(e,t){return(0,k.bf)(this.i3slayer,e,this._getObjectIdField(),t,()=>[...this._nodeId2Meta.values()].filter(re.pC))}getGraphicFromIntersectorTarget(e){if(null==e.nodeIndex||null==e.componentIndex)return null;const t=this._nodeId2Meta.get(e.nodeIndex);return null==t?.featureIds||e.componentIndex>=t.featureIds.length?null:this._createGraphic(e.componentIndex,t)}_getCacheKey(e){return`${this._layerUrl}/v23/${e}${this._cacheKeySuffix}`}_getMemCacheKey(e,t=this.elevationOffset){return e+"#"+t}get _idbCacheEnabled(){return!this._controller.disableIDBCache&&!this.hasModifications&&0===this.elevationOffset&&null!=this._cacheKeySuffix}loadCachedGPUData(e){return null!=this._memCache?this._memCache.pop(this._getMemCacheKey(e)):null}deleteCachedGPUData(e){null!=e&&this._deleteComponentObject(e)}_cacheGPUData(e,t=this.elevationOffset){if(null==this._memCache)return void this._deleteComponentObject(e);const s=this._controller.indexDepth-e.node.level;this._memCache.put(this._getMemCacheKey(e.node.index,t),e,e.node.memory,s)}loadMissingTextures(e,t,s,i){const r=e?.filter((l,d)=>{if(!(l.usage&this.rendererTextureUsage))return!1;if(null==t)return!0;const h=(0,et.nn)(l.encodings,this.supportedTextureEncodings),c=t[d];return!!(null==c?.data||h&&c.encoding!==h.encoding)})??[];return 0===r.length?Promise.resolve(!1):s(r,i).then(l=>{let d=0;for(let h=0;h<e.length;h++)d<l.length&&l[d].id===e[h].id&&(t[h]=l[d],d++);return!0})}loadCachedNodeData(e,t,s){return this._idbCacheEnabled?this._idbCache.get(this._getCacheKey(e.id),t).then(i=>null==i?null:i.nodeVersion!==e.version?(this._idbCache.remove(this._getCacheKey(e.id)),null):(this.elevationInfo.mode===F.vV.Absolute&&(e.geometryObbInRenderSR=st.Oo.fromData(i.geometryObbData)),this.loadMissingTextures(i.requiredTextures,i.textureData,s,t).then(r=>(r&&this._idbCache.initialized&&null!=i.textureData&&(i.byteSize=Xt(i.transformedGeometry,i.textureData),i.textureData.every(Qt)&&kt(e,i)&&this._idbCache.put(this._getCacheKey(e.id),i).catch(l=>De().warn(`Failed to update node with textures in IndexedDB cache: ${e.id}: ${l}`))),(0,T.k_)(t),i)))):Promise.resolve(null)}addNode(e,t,s){return function Ws(a){return"geometryData"in a}(t)?null==t.geometryBuffer?(this._addNodeMeta(e.index,null),Promise.resolve()):this._addData(e,t.attributeDataInfo,()=>this._transformNode(e,t,s).then(i=>this._safeReschedule(()=>{if(null==i)return e.hasModifications=!1,this._addCachedNodeData(e,null,s);e.hasModifications=i.transformedGeometry.hasModifications;const{obb:r,componentOffsets:l,featureIds:d,anchorIds:h,anchors:c,transformedGeometry:u}=i,ee=(0,Pt.c)(e.serviceMbsInIndexSR,this.elevationOffset,this._controller.crsIndex,this.view.renderSpatialReference),J=(0,_.s)(qt,r.center.x,r.center.y,r.center.z);(0,_.e)(J,J,ee);const p=new st.Oo(J,[r.extents.x,r.extents.y,r.extents.z],(0,H.al)(r.orientation.x,r.orientation.y,r.orientation.z,r.orientation.w));this.elevationInfo.mode===F.vV.Absolute&&(e.geometryObbInRenderSR=p),t.geometryData.componentOffsets=l,d&&(t.geometryData.featureIds=Array.from(d)),t.geometryData.anchorIds=h,t.geometryData.anchors=c;const B={nodeVersion:e.version,geometryData:t.geometryData,requiredTextures:t.requiredTextures,textureData:t.textureData,transformedGeometry:u,globalTrafo:ee,geometryObbData:p.data,byteSize:Xt(u,t.textureData)};if(this._idbCacheEnabled&&this._idbCache.initialized&&kt(e,B)){const D=null!=B.textureData?B.textureData.map(E=>Qt(E)?E:null):null;this._idbCache.put(this._getCacheKey(e.id),{...B,textureData:D}).catch(E=>De().warn(`Failed to store node in IndexedDB cache: ${e.id}: ${E}`))}return this._addCachedNodeData(e,B,s)},s))):Promise.reject()}getElevationRange(e){const t=new At.r,s=this._controller,{index:i}=s;if(!i)return t;const{rootNode:r}=i;if(!r)return t;const l=this._nodeId2Meta,d=e[3],h=s.viewportQueries,c=this._planetRadiusInGlobalMode,{view:u}=this,{renderCoordsHelper:j}=u,L=j.referenceEllipsoid.radius,ee=this._collection;return i.traverse(r,p=>{const{childrenLoaded:B}=p;if(0===B)return!1;const D=h.getAndUpdateVisibilityObbInRenderSR(p);let E=null,I=-1;if(D){if(I=D.radius,!D.intersectSphereWithMBS(e,I))return!1}else E=h.getServiceMbsInRenderSR(p),E&&(I=E[3]);if(I>=0&&d>=1*I)return null!=D?Nt(t,D,c):null!=E&&E[3]>=0&&ts(t,E,c),!1;const Z=$s;if(Z.elevationRangeMin=1/0,Z.elevationRangeMax=-1/0,(null!=D||null!=E)&&(null!=D?Nt(Z,D,c):null!=E&&ts(Z,E,c),Z.elevationRangeMin>=t.elevationRangeMin&&Z.elevationRangeMax<=t.elevationRangeMax))return!1;const K=l.get(p.index);if(K){const{geometryObbInRenderSR:be}=p;if(!be||be.intersectSphereWithMBS(e)){if(be&&d>0*be.radius)return Nt(t,be,c),!1;const{objectHandle:Ae}=K,ot=ee.getObjectTransform(Ae),Tt=j.getAltitude(ot.position);ee.expandRangeWithComponentObjectElevationRange(Ae,Tt,L,t)}}return B-(K?1:0)>0}),t}computeVisibilityObb(e){return(0,k.Cx)(e,this.view.renderSpatialReference,this._controller.crsIndex,this.i3slayer.spatialReference,this.elevationOffset,this._modifications,this.view.renderCoordsHelper.sphericalPCPF)}_transformNode(e,t,s){const i=t.geometryData.geometries??[],r=new Array(i.length);for(let E=0;E<i.length;++E)r[E]=this._getVertexBufferLayout(i[E],t.geometryDescriptor);const l=e.serviceMbsInIndexSR,d=this.elevationOffset,h=this._controller.crsIndex,c=this._controller.crsVertex,u=this.view.renderSpatialReference,j=(0,Pt.n)(l,d,h),L=(0,Pt.c)(l,d,h,u),ee=(0,Ne.YD)(h,c),J=(0,Ne.YD)(c,u);return null==ee||null==J?Promise.resolve(null):this._worker.invoke({context:this.uid,geometryBuffer:t.geometryBuffer,geometryData:t.geometryData,geometryDescriptor:t.geometryDescriptor,layouts:r,localOrigin:j,globalTrafo:L,mbs:l,obbData:e.serviceObbInIndexSR?.data,elevationOffset:d,needNormals:this._needsNormals&&this._controller.isMeshPyramid,normalReferenceFrame:t.normalReferenceFrame??this.i3slayer.normalReferenceFrame??"none",indexToVertexProjector:ee,vertexToRenderProjector:J},s)}get _supportsNodeCrossFading(){return!this.view?._stage?.renderer.shadowsEnabled}get nodeCrossfadingEnabled(){return this._supportsNodeCrossFading&&(this.lodCrossfadeinDuration>0||this.lodCrossfadeoutDuration>0||this.lodCrossfadeUncoveredDuration>0)}get nodeFadeoutEnabled(){return this._supportsNodeCrossFading&&this.lodCrossfadeoutDuration>0}_setNewNodeOpacity(e){this._setNodeOpacity(e,this.nodeCrossfadingEnabled?0:this.fullOpacity)}addCachedGPUData(e,t,s){if(this.elevationInfo.mode===F.vV.Absolute&&(e.geometryObbInRenderSR=this._collection.getComponentObb(t.objectHandle).clone()),!this._controller.isGeometryVisible(e))return void this._cacheGPUData(t);null!=this._labeler&&this._addMetaToLabeler(this._labeler,t);const i=e.index;this._addNodeMeta(i,t),this.updateNodeState(i,s),this._collection.setObjectVisibility(t.objectHandle,!0),this._updateMaterial(t),this._setNewNodeOpacity(t),this.elevationInfo.mode!==F.vV.Absolute&&this._ensureElevationTask().schedule(i),this._updateEngineObject(t),this._highlights.objectCreated(t),null!=this._treeDebugger&&this._treeDebugger.update()}addCachedNodeData(e,t,s,i){return this._addData(e,s,()=>this._addCachedNodeData(e,t,i))}deleteCachedNodeData(e){var t=this;return(0,C.Z)(function*(){if(t._idbCacheEnabled)return t._idbCache.remove(t._getCacheKey(e))})()}_addCachedNodeData(e,t,s){var i=this;return(0,C.Z)(function*(){if(!i.contentVisible||!i._controller.isGeometryVisible(e))return void i._removeNodeStageData(e.index,i.elevationOffset,i._nodeId2MetaReloading);if(null==t)return void i._addNodeMeta(e.index,null);const r=i._addTasks.get(e.index),{geometryData:l,transformedGeometry:d,globalTrafo:h}=t;yield i.i3sOverrides.applyAttributeOverrides(l.featureIds,r.attributeInfo,s,i._controller.requiredAttributes);const c=null!=t.textureData?t.textureData.filter(fe=>null!=fe&&0!=(fe.usage&i.rendererTextureUsage)):[];!(0,z.Z)("disable-feature:i3s-basis")&&c.some(fe=>null!=fe&&(fe.encoding===je.j.Basis||fe.encoding===je.j.KTX2))&&(yield(0,Kt.$8)()),e.memory=0;const{componentOffsets:u,geometries:j,featureIds:L,anchorIds:ee,anchors:J}=l,p=i._collection,B=j[0],{layout:D,indices:E,interleavedVertexData:I,positionData:Z,hasColors:K}=d,{material:be,geometryParameters:Ae}=i._materialParameters(B,D),ot=u||new Uint32Array([0,E?E.length:I.byteLength/D[0].stride]),Tt={vertices:{data:I,count:I.byteLength/D[0].stride,layoutParameters:Ae},positionData:{positions:(0,Je.YI)(Z.data),indices:(0,f.mi)(Z.indices)},indices:E,componentOffsets:ot},Mt=B.transformation?(0,q.d9)(B.transformation):(0,q.Ue)();(0,R.Jp)(Mt,h,Mt);const ss=(0,R.i0)((0,x.Ue)(),Mt),is=(0,M.xO)((0,U.Ue)(),Mt),ns=i.view.renderSpatialReference,rs=i.view.basemapTerrain.spatialReference,jt=st.Oo.fromData(t.geometryObbData).center,at=[1,1,1];(0,de.X)(jt,ns,at,rs)||De().errorOnce("Unsupported coordinate system for IM overlay");const Ut=(0,x.Ue)();(0,ne.S)(jt,ns,Ut,rs);const os=(0,U.Ue)();(0,M.U_)(os,is);const Ct=(0,x.Ue)();(0,_.t)(Ct,(0,_.z)(Ct,jt,ss),os);const Ot=p.createObject({toMapSpace:(0,m.al)(Ut[0]-Ct[0]*at[0],Ut[1]-Ct[1]*at[1],at[0],at[1]),geometry:Tt,obb:st.Oo.fromData(t.geometryObbData),transform:{position:ss,rotationScale:is}}),Qs=Ae.textureCoordinates===bt.N.Atlas,{textures:as,texturePromise:Xs}=i._initMaterialAndTextures(Ot,be,c,Qs);e.memory+=i._memEstimateGeometryAdded(Ot),e.memory+=as.reduce((fe,Ft)=>fe+(null!=Ft?i._memEstimateTextureAdded(Ft):0),0);const ks=!!be.hasParametersFromSource,qs="blend"!==be.alphaMode&&be.metallicRoughness.baseColorFactor[3]>=1,me=new Ls(e,L,Ot,i._getInvalidRendererVersion(),r.attributeInfo,{hasParametersFromSource:ks,isOpaque:qs},as,ee,J);r.meta=me,!i._hasTextures&&t.requiredTextures?.some(({usage:fe})=>0!=(fe&je.v.ColorTextures))&&(i._hasTextures=!0),i._hasData=!0,i._hasColors=i._hasColors||K,i._hasTextures=i._hasTextures||!!e.resources.texture,i.notifyChange("hasTexturesOrVertexColors");const ei=i.slicePlaneEnabled;return Promise.all([i._addOrUpdateEdgeRendering(me),Xs]).then(([fe,Ft])=>(fe?.updateObjectVisibility(me.objectHandle,!1).catch(lt=>Le(lt,i.i3slayer.title)),i._safeReschedule(()=>{const lt=i._addTasks.get(e.index);if(!lt)return;if(i._addNodeMeta(e.index,me),lt.meta=null,!i.contentVisible)return void i._removeNodeStageData(e.index,i.elevationOffset);p.setObjectVisibility(Ot,!0),fe?.updateObjectVisibility(me.objectHandle,!0).catch(ri=>Le(ri,i.i3slayer.title)),me.attributeInfo=lt.attributeInfo;const ti=me.cachedRendererVersion!==i._rendererVersion,si=ei!==i.slicePlaneEnabled;i._updateElevationOffsets(me);const ii=me.elevationOffsets;i._updateComponentData(me);const ni=i._applyFiltersToNode(me);(ti||null!=fe&&(si||ni||ii))&&i._addOrUpdateEdgeRendering(me),null!=i._labeler&&i._addMetaToLabeler(i._labeler,me),i._visibleGeometryChanged(me,Se.ADD),i._highlights.objectCreated(me),i._updateMaterial(me),i._setNewNodeOpacity(me),null!=i._treeDebugger&&i._treeDebugger.update()},s))).catch(fe=>{throw null!=r.meta&&(i._cacheGPUData(r.meta),r.meta=null),fe})})()}_addNodeMeta(e,t){if(this._removeNodeStageData(e,this.elevationOffset,this._nodeId2MetaReloading),this._nodeId2Meta.has(e)){De().error("Removing duplicated node");const s=this._nodeId2Meta.get(e);null!=s&&this._deleteComponentObject(s)}else this._controller.updateLoadStatus(e,!0);null!=t&&(t.lodCrossfadeProgress=null,this.nodeCrossfadingEnabled&&nt(t.cachedEdgeMaterials,0)),this._nodeId2Meta.set(e,t),this.notifyChange("elevationRange")}_updateElevationOffsets(e){const t=this.view.renderSpatialReference,s=this._controller.crsIndex,i=this.elevationInfo,r=this.view.basemapTerrain,l=r.spatialReference,d=i.mode;if(null==t||null==l||d===F.vV.Absolute)return void(e.elevationOffsets=null);const h=this._collection.getObjectTransform(e.objectHandle);e.elevationOffsets=e.elevationOffsets??[];const c=qt,u=Zs,j=d===F.vV.OnTheGround,L=this.view.renderCoordsHelper,ee=e.featureIds.length,J=(()=>{if(e.cachedElevationAnchors)return e.cachedElevationAnchors;const E=(0,Oe.bg)(3*ee);e.cachedElevationAnchors=E;for(let I=0;I<ee;I++){const Z=3*I,K=e.anchorIds?.indexOf(I)??-1;e.anchors&&K>=0?((0,_.s)(c,e.anchors[3*K],e.anchors[3*K+1],e.anchors[3*K+2]),(0,_.g)(c,c,(0,v.g)(e.node.serviceMbsInIndexSR)),(0,ne.S)(c,s,c,l),E[Z]=c[0],E[Z+1]=c[1],E[Z+2]=L.getAltitude(c)):(this._collection.getComponentAabb(e.objectHandle,I,u,!0),(0,_.s)(c,(u[0]+u[3])/2,(u[1]+u[4])/2,u[2]),(0,_.t)(c,c,h.rotationScale),(0,_.g)(c,c,h.position),E[Z+2]=L.getAltitude(c),(0,ne.S)(c,t,c,l),E[Z]=c[0],E[Z+1]=c[1])}return E})(),p=i.offset,B=e.elevationOffsets;r.getElevations(J,ee,(E,I)=>{B[E]=p+(null!=I?I-(j?J[3*E+2]:0):0)})}_ensureElevationTask(){return null!=this._elevationTask||(this._elevationTask=new _t(this.view.resourceController.scheduler,e=>{const t=this._controller.updateElevationChanged(e,this.view.basemapTerrain.spatialReference);return null!=t?t.filterInPlace(s=>null!=this._nodeId2Meta.get(s)):null},e=>{const t=this._nodeId2Meta.get(e);this._nodeElevationAlignmentChanged(t)},()=>this.elevationInfo?.mode)),this._elevationTask}_elevationInfoChanged(e,t){const s=e.mode!==F.vV.Absolute,i=!!t&&t!==e&&t.mode!==F.vV.Absolute;this._intersectionHandler.updateElevationAlignState(s,this.view.state.viewingMode),s&&!i&&this._controller.removeAllGeometryObbs(),this._nodeId2Meta.forEach(r=>this._nodeElevationAlignmentChanged(r))}_nodeElevationAlignmentChanged(e){null!=e&&(this._updateElevationOffsets(e),this._updateComponentData(e),this._updateEdgeRendering(e),null!=this._labeler&&this._labeler.updateLabelPositions(e),this._updateSnappingSources(e,Se.UPDATE))}_safeReschedule(e,t){return(0,T.k_)(t),this._controller.reschedule(e,t)}_materialParameters(e,t){const s=null!=e.params.material?e.params.material:(0,et.dY)(),i=t.some(d=>"uvRegion"===d.name),r=t.some(d=>"normalCompressed"===d.name),l=Jt(s);return{geometryParameters:this._getGeometryParameters({hasTexture:l,hasNormals:r,hasRegions:i}),material:s}}_initMaterialAndTextures(e,t,s,i){const r=this._stage.renderView,l=s.map(h=>(0,et.cU)(h,t,i,r));this._stage.addMany(l);let d=null;return this._collection.updateMaterial(e,h=>{d=(0,et.RE)(h,t,l,s,this.view._stage.renderView.textureRepository,{rendererTextureUsage:this.rendererTextureUsage,usePBR:this._usePBR,isIntegratedMesh:this._isIntegratedMesh,slicePlaneEnabled:this.slicePlaneEnabled,viewSpatialReference:this.view.spatialReference}),this._updateMaterialOverlay(h)}),{textures:l,texturePromise:d}}_getGeometryParameters(e){return{textureCoordinates:e.hasTexture?e.hasRegions?bt.N.Atlas:bt.N.Default:bt.N.None,colors:this._hasVertexColors,hasNormals:e.hasNormals&&this._needsNormals,needsNormals:this._needsNormals}}_addData(e,t,s){let i=this._addTasks.get(e.index);return i?i.attributeInfo=t:(i={...(0,T.hh)(),attributeInfo:t,meta:null},this._addTasks.set(e.index,i),s().then(i.resolve,i.reject).then(()=>this._addTasks.delete(e.index)).catch(r=>{throw this._addTasks.delete(e.index),r})),i.promise}_clearAddTasks(){this._addTasks.forEach(e=>{null!=e.meta&&(this._cacheGPUData(e.meta),e.meta=null)}),this._addTasks.clear()}_clippingAreaChanged(){const e=this.view.renderSpatialReference,t=this.i3slayer.spatialReference,s=(0,Ce.Ue)();this._renderClippingArea=(0,Gt.G)(this.view.clippingArea,s,e)?s:null;const i=(0,Ce.Ue)();this._layerClippingArea=(0,Gt.G)(this.view.clippingArea,i,t)?i:null,this._filterChange(),this._controller&&this._controller.updateClippingArea(this.view.clippingArea),this._isIntegratedMesh&&this._modificationsChanged()}get hasGeometryFilter(){return!1}_geometryFilterChange(){const e=this.hasGeometryFilter;this._controller.geometryFilterChanged(e),this._applyFilters(e)}_filterChange(){this._applyFilters(this.hasGeometryFilter)}_applyFilters(e){this._filters=this.getFilters(),e?this._controller&&this._controller.requestUpdate():this._nodeId2Meta.forEach(t=>{null!=t&&this._applyFiltersToNode(t)&&(this._addOrUpdateEdgeRendering(t),this._visibleGeometryChanged(t,Se.UPDATE))})}getFilters(){const e=[],t=this._renderClippingArea;return null!=t&&e.push((s,i)=>this._boundingRectFilter(s,i,t)),e}addSqlFilter(e,t,s){if(null!=t){const i=t.fieldNames;e.push((r,l)=>this._sqlFilter(r,l,t,i,s))}}_sqlFilter(e,t,s,i,r){const l={},d=this._createLayerGraphic(l),h=this.i3slayer.objectIdField,c=t.featureIds,u=t.attributeInfo?.attributeData;i.every(j=>j===h||null!=u?.[j])&&(0,k.hv)(e,c,j=>{l[h]=c[j];for(const L of i)L!==h&&(l[L]=u?(0,k.Jx)(u[L],j):null);try{return s.testFeature(d)}catch(L){return r(L),!1}})}_boundingRectNodeTest(e,t){return(0,ue.s)(e.node.serviceMbsInIndexSR,this._controller.crsIndex,Yt,this.view.renderSpatialReference),(0,k.cr)(t,Yt)}_boundingRectFeatureTest(e,t,s){return this._collection.getComponentAabb(e.objectHandle,t,Zt),(0,he.y8)(Zt,$t),(0,Ce.kK)(s,$t)}_boundingRectFilter(e,t,s){const i=this._collection,r=this._boundingRectNodeTest(t,s);if(r===k.pD.INSIDE)return;if(r===k.pD.OUTSIDE)return void(e.length=0);const l=i.getComponentCount(t.objectHandle);if(l.invisible+l.visible!==t.featureIds.length)return;const d=this._transformClippingArea(Hs,s,t.objectHandle);(0,k.hv)(e,t.featureIds,h=>this._boundingRectFeatureTest(t,h,d))}_transformClippingArea(e,t,s){const i=this._collection.getObjectTransform(s),r=i.position,l=i.rotationScale;return e[0]=(t[0]-r[0])/l[0],e[1]=(t[1]-r[1])/l[4],e[2]=(t[2]-r[0])/l[0],e[3]=(t[3]-r[1])/l[4],e}_addOrUpdateEdgeRendering(e,t=!0){const s=this._edgeView;if(null==s)return Promise.resolve(null);const i=e.objectHandle,r=s.hasObject(i),{hasEdges:l,perFeatureEdgeMaterials:d}=this._getFilteredEdgeMaterials(e),h={hasSlicePlane:this.slicePlaneEnabled};return l&&r?(this.nodeCrossfadingEnabled&&nt(d,this.getNodeOpacity(e)),s.updateAllComponentMaterials(i,d,h,t).catch(c=>Le(c,this.i3slayer.title)),s.updateObjectVisibility(i,!0).catch(c=>Le(c,this.i3slayer.title)),s.updateAllVerticalOffsets(i,e.elevationOffsets).catch(c=>Le(c,this.i3slayer.title)),Promise.resolve(s)):l&&!r?this._collection.addEdges(i,s,d,h).then(c=>(e.edgeMemoryUsage=c,e.node.memory+=c,s.updateAllVerticalOffsets(i,e.elevationOffsets).catch(u=>Le(u,this.i3slayer.title)),s)):(!l&&r&&(e.node.memory-=e.edgeMemoryUsage,e.edgeMemoryUsage=0,s.removeObject(i)),Promise.resolve(null))}_applyFiltersToNode(e){return!!this._applyFiltersToNodeComponents(e)&&(null!=this._labeler&&this._labeler.applyFilterChange(e),!0)}_applyFiltersToNodeComponents(e){const t=this._collection,s=t.getComponentCount(e.objectHandle),i=null!=e.filteredIds,r=0===s.invisible;if(t.setAllComponentVisibilities(e.objectHandle,"all"),0===this._filters.length)return e.filteredIds=null,!r;if(this._updateCachedFilteredIds(e),i&&e.filteredIds===e.featureIds)return!r;const l=this._computeFilteredComponentIndices(e);return t.setAllComponentVisibilities(e.objectHandle,l),!0}_updateCachedFilteredIds(e){null!=e.filteredIds&&e.appliedFilters===this._filters||(e.filteredIds=this._computeFilteredIds(e),e.appliedFilters=this._filters)}_computeFilteredIds(e){const t=e.featureIds.slice();for(const s of this._filters)if(s(t,e),0===t.length)break;return t.length===e.featureIds.length?e.featureIds:t}_computeFilteredComponentIndices(e){const t=new Array,s=e.filteredIds;return null!=s&&e.featureIds.forEach((i,r)=>{s[t.length]===i&&t.push(r)}),t}_removeAllNodeDataFromStage(e=this.elevationOffset){this._nodeId2Meta.forEach((t,s)=>this._removeNodeStageData(s,e)),this._nodeId2MetaReloading.forEach((t,s)=>this._removeNodeStageData(s,e,this._nodeId2MetaReloading)),this._elevationTask=(0,N.SC)(this._elevationTask)}removeNode(e){const t=this.elevationOffset;this._removeNodeStageData(e,t),this._removeNodeStageData(e,t,this._nodeId2MetaReloading),null!=this._elevationTask&&this._elevationTask.remove(e)}_removeNodeStageData(e,t,s=this._nodeId2Meta){s.has(e)&&this._controller.updateLoadStatus(e,!1);const i=s.get(e);null!=i?(this._collection.setObjectVisibility(i.objectHandle,!1),null!=this._edgeView&&this._edgeView.hasObject(i.objectHandle)&&this._edgeView.updateObjectVisibility(i.objectHandle,!1).catch(r=>Le(r,this.i3slayer.title)),this._visibleGeometryChanged(i,Se.REMOVE),null!=this._labeler&&this._labeler.removeNodeMeta(i),s.delete(e),this._highlights.objectDeleted(i),s===this._nodeId2Meta?(this._cacheGPUData(i,t),this.nodeCrossfadingEnabled&&this._crossfadeHelper.stopNodeFading(i)):this._deleteComponentObject(i),null!=this._treeDebugger&&this._treeDebugger.update()):s.delete(e)}_deleteComponentObject(e){if(null!=this._edgeView&&this._edgeView.removeObject(e.objectHandle),this._memEstimateGeometryRemoved(e.objectHandle),this._collection.destroyObject(e.objectHandle),e.textures)for(const t of e.textures)this._memEstimateTextureRemoved(t),this._stage.remove(t)}updateNodeState(e,t){const s=this._nodeId2Meta.get(e);null!=s&&this._collection.updateMaterial(s.objectHandle,i=>i.polygonOffsetEnabled=t===St.FE.Hole)}updateNodeIndex(e,t){if(this._nodeId2Meta.has(e)){const i=this._nodeId2Meta.get(e);this._nodeId2Meta.delete(e),this._nodeId2Meta.set(t,i),this.notifyChange("elevationRange")}const s=this._nodeId2MetaReloading.get(e);s&&(this._nodeId2MetaReloading.delete(e),this._nodeId2MetaReloading.set(t,s))}_invalidateAllSymbols(){this._rendererVersion=(0,k.HV)(this._rendererVersion,1),this._controller&&this._controller.requestUpdate()}_getInvalidRendererVersion(){return(0,k.HV)(this._rendererVersion,-1)}_rendererChange(e){var t=this;return(0,C.Z)(function*(){if(t._currentRenderer=e,t.notifyChange("rendererTextureUsage"),t._rendererVersion=(0,k.HV)(t._rendererVersion,1),t._rendererFields=null,t._colorVariable=null,t._opacityVariable=null,t._invalidateAllSymbols(),e&&(t._rendererFields=yield e.getRequiredFields(t.i3slayer.fieldsIndex)),t._updateSymbologyFields(),!t._arcade&&e&&"arcadeRequired"in e&&e.arcadeRequired&&(t._arcade=yield(0,_e.LC)()),e&&"visualVariables"in e&&e.visualVariables)for(const s of e.visualVariables)"color"===s.type?t._colorVariable=s:"opacity"===s.type?t._opacityVariable=s:De().warn(`Unsupported visual variable type for 3D Object Scene Services: ${s.type}`);if(e)for(const s of e.getSymbols())"mesh-3d"!==s.type&&De().error(`Symbols of type '${s.type}' are not supported for 3D Object Scene Services.`);t._controller&&t._controller.requestUpdate()})()}_getCachedEdgeMaterials(e){return this._hasComponentData&&e.cachedRendererVersion!==this._rendererVersion&&this._updateCachedRendererData(e),e.cachedEdgeMaterials}_getComponentParameters(e){this._hasComponentData&&e.cachedRendererVersion!==this._rendererVersion&&this._updateCachedRendererData(e);const t=e.cachedSymbology;return(s,i)=>{const r=5*s;if((0,P.s)(i.externalColor,t[r]/255,t[r+1]/255,t[r+2]/255,t[r+3]/255),null!=this._stage.renderView.objectAndLayerIdRenderHelper){const l=e.featureIds[s],d=(0,Be.ql)(this.view.map,this.layerUid);this._stage.renderView.objectAndLayerIdRenderHelper.setUidToObjectAndLayerId(l,l,this.layerId,this.layerUid+"_"+this.sublayerId,this.layerPopupEnabledAndHasTemplate&&!d,e.node.resources.attributes,s,this.sublayerId),i.objectAndLayerIdColor=this._stage.renderView.getObjectAndLayerIdColor({graphicUid:l,layerUid:this.layerUid+"_"+this.sublayerId})}i.externalColorMixMode=t[r+4]&(1<<We.CastShadows)-1,i.castShadows=0!=(t[r+4]&1<<We.CastShadows),i.pickable=0!=(t[r+4]&1<<We.Pickable),i.elevationOffset=e.elevationOffsets?.[s]??0}}_getSymbolInfo(e,t){const s=e?.getSymbol(t,{arcade:this._arcade});if(!(s instanceof Qe.Z))return null;const i=s.id;if(this._symbolInfos.has(i))return this._symbolInfos.get(i);const r=(0,k.ix)(s);return this._symbolInfos.set(i,r),r}_setSymbologyOverride(e,t){this._symbologyOverride!==e&&(this._symbologyOverride=e,this._symbologyOverrideFields=t,this._invalidateAllSymbols(),this._updateSymbologyFields())}_updateSymbologyFields(){this._symbologyFields=null!=this._symbologyOverrideFields&&this._symbologyOverrideFields.length>0?null!=this._rendererFields&&this._rendererFields.length>0?(0,xe.Q0)(this.i3slayer.fieldsIndex,[...this._rendererFields,...this._symbologyOverrideFields]):this._symbologyOverrideFields:this._rendererFields}_updateCachedRendererData(e){if(e.cachedRendererVersion=this._rendererVersion,!this._hasComponentData)return;const t=this._tmpAttributeOnlyGraphic,s={};t.attributes=s;const i=this._currentRenderer,r=e.attributeInfo?.attributeData,l=null!=e.featureIds?this.i3slayer.objectIdField:null,d=null!=r&&null!=this._symbologyFields&&this._symbologyFields.length>0;let h=null,c=null;if(d&&null!=this._symbologyFields){h=[],c=[];for(const D of this._symbologyFields){const E=r[D];E&&(h.push(D),c.push(E))}}e.cachedSymbology||(e.cachedSymbology=function w(a,n=!1){return a<=te.c8?n?new Array(a).fill(0):new Array(a):new Uint8Array(a)}(5*e.featureIds.length));const u={color:it,castShadows:!0,pickable:!0,colorMixMode:vt.a9.Multiply,edgeMaterial:null},j=this.fullOpacity,L=this.nodeCrossfadingEnabled?this.getNodeOpacity(e):j;let ee=null,J=It.i.OPAQUE,p=k.uC,B=0;for(let D=0;D<e.featureIds.length;D++){if(null!=l&&(s[l]=e.featureIds[D]),d&&h)for(let K=0;K<h.length;K++)s[h[K]]=(0,k.Jx)(c[K],D);const E=i?this._getSymbolInfo(i,t):null;let I=null,Z=null;if(i&&"visualVariables"in i){if(this._colorVariable){const K=(0,Ee.getColor)(this._colorVariable,t,{color:Ks,arcade:this._arcade});K&&(I=it,I[0]=K.r/255,I[1]=K.g/255,I[2]=K.b/255,this._opacityVariable||null===K.a||(Z=K.a))}this._opacityVariable&&(Z=(0,Ee.getOpacity)(this._opacityVariable,t,{arcade:this._arcade}))}if(E?.material){const K=E.material;I=null==I||null==Z?(0,Bt.$o)(I,Z,K.color,K.alpha,zt,it):(0,Bt.$o)(I,Z,null,null,zt,it)}if(null==I&&(I=it,I[0]=1,I[1]=1,I[2]=1,I[3]=1),u.pickable=!0,u.castShadows=!E||E.castShadows,u.colorMixMode=E?.material?E.material.colorMixMode:vt.a9.Multiply,u.edgeMaterial=E?E.edgeMaterial:null,null!=this._symbologyOverride&&(u.color=I,this._symbologyOverride(t,u),I=u.color),null!=this._nodeColorOverride&&(this._nodeColorOverride(e.node,I),u.colorMixMode=vt.a9.Replace),null!=u.edgeMaterial){const K=I[3]<=0?It.i.INVISIBLE:I[3]>=1&&(e.material.isOpaque||u.colorMixMode===vt.a9.Replace)?It.i.OPAQUE:It.i.TRANSPARENT;u.edgeMaterial===ee&&K===J||(p={...u.edgeMaterial,opacity:L,objectTransparency:K},ee=u.edgeMaterial,J=K),e.cachedEdgeMaterials[D]=p}else e.cachedEdgeMaterials[D]=k.uC;e.cachedSymbology[B++]=Math.round(255*I[0]),e.cachedSymbology[B++]=Math.round(255*I[1]),e.cachedSymbology[B++]=Math.round(255*I[2]),e.cachedSymbology[B++]=Math.round(255*I[3]),e.cachedSymbology[B++]=u.colorMixMode|+u.castShadows<<We.CastShadows|+u.pickable<<We.Pickable}}_getFilteredEdgeMaterials(e){const t=this._getCachedEdgeMaterials(e);this.nodeCrossfadingEnabled||nt(t,this.fullOpacity);const s=e.filteredIds;if(null==s)return{hasEdges:t.some(d=>d!==k.uC),perFeatureEdgeMaterials:t};let i=0,r=!1;const l=t.map((d,h)=>e.featureIds[h]!==s[i]?k.uC:(r=r||d!==k.uC,i++,d));return{hasEdges:r,perFeatureEdgeMaterials:l}}_updateComponentData(e){if(!this._hasComponentData)return;const t=e.objectHandle,s=this._getComponentParameters(e);this._collection.setComponentData(t,s),this._stage.renderView.requestRender()}_reloadAll(e=this.elevationOffset){this._removeAllNodeDataFromStage(e),null!=this._controller&&this._controller.restartNodeLoading()}_opacityChange(e){this.nodeCrossfadingEnabled&&this._crossfadeHelper.stopAllNodeFading(),this._nodeId2Meta.forEach(t=>{null!=t&&(this._collection.updateMaterial(t.objectHandle,s=>s.objectOpacity=e),nt(t.cachedEdgeMaterials,e),this._updateEdgeRendering(t))})}_updateMaterial(e){this._collection.updateMaterial(e.objectHandle,t=>{t.commonMaterialParameters.hasSlicePlane=this.slicePlaneEnabled,t.usePBR=this._usePBR,this._updateMaterialOverlay(t)})}_updateMaterialOverlay(e){}_updateEngineObject(e){this._updateComponentData(e),this._applyFiltersToNode(e),this._addOrUpdateEdgeRendering(e),this._visibleGeometryChanged(e,Se.UPDATE)}_slicePlaneEnabledChange(e){this._intersectionHandler&&(this._intersectionHandler.slicePlaneEnabled=e),null!=this._labeler&&(this._labeler.slicePlaneEnabled=e),this._nodeId2Meta.forEach(t=>{null!=t&&(this._collection.updateMaterial(t.objectHandle,s=>s.commonMaterialParameters.hasSlicePlane=e),this._updateEdgeRendering(t,!1))})}_updatePBR(e){this._nodeId2Meta.forEach(t=>{null!=t&&this._collection.updateMaterial(t.objectHandle,s=>s.usePBR=e)}),this._hasLoadedPBRTextures=!0}get _usePBR(){return this._needsNormals&&this.view.qualitySettings.physicallyBasedRenderingEnabled}_updateEdgeRendering(e,t=!0){null!=this._edgeView&&this._edgeView.hasObject(e.objectHandle)&&this._addOrUpdateEdgeRendering(e,t)}_forAllNodes(e){this._nodeId2Meta.forEach(e)}_ignoreClientNodeOverriddenFeatures(e){return this.i3sOverrides.hasGeometryChanges?(t,s,i)=>i.node.index>=0&&this.i3sOverrides.featureHasGeometryChanges(t)?F.Ku.CONTINUE:e(t,s,i):e}_forAllFeatures(e,t,s){(0,$.oE)(this._nodeId2Meta,i=>{if(null==i)return!1;if(null!=t)switch(t(i)){case F.Ku.EXIT:return!0;case F.Ku.SKIP:return!1}let r=F.Ku.CONTINUE;switch(s){case F.p1.ALL:r=this._forAllFeaturesOfNode(i,e);break;case F.p1.VISIBLE_ONLY:r=this._forAllVisibleFeaturesOfNode(i,e);break;case F.p1.QUERYABLE:r=this._forAllQueryableFeaturesOfNode(i,e)}return r===F.Ku.EXIT})}_forAllFeaturesOfNode(e,t){let s=F.Ku.CONTINUE;const i=e.featureIds;for(let r=0;r<i.length;r++)if(s=t(i[r],r,e),s===F.Ku.EXIT)return s;return s}_forAllVisibleFeaturesOfNode(e,t){let s=F.Ku.CONTINUE;const i=e.featureIds;return this._collection.forEachVisibleComponent(e.objectHandle,r=>(s=t(i[r],r,e),s===F.Ku.CONTINUE)),s}_forAllQueryableFeaturesOfNode(e,t){const s=this._ignoreClientNodeOverriddenFeatures(t);if(null==this._renderClippingArea)return this._forAllFeaturesOfNode(e,s);const i=this._boundingRectNodeTest(e,this._renderClippingArea);if(i===k.pD.OUTSIDE)return F.Ku.CONTINUE;if(i===k.pD.INSIDE)return this._forAllFeaturesOfNode(e,s);const r=F.Ku.CONTINUE,l=e.featureIds,h=(0,k.ns)(this._renderClippingArea,this._collection.getObjectTransform(e.objectHandle));for(let c=0;c<l.length;c++){if(!this._boundingRectFeatureTest(e,c,h))continue;const u=s(l[c],c,e);if(u===F.Ku.EXIT)return u}return r}_createAttributes(e,t){const s={};null!=t.featureIds&&(s[this._getObjectIdField()]=t.featureIds[e]);const i=t.attributeInfo?.attributeData;if(null!=i)for(const r of Object.keys(i))s[r]=(0,k.Jx)(i[r],e);return s}_createGraphic(e,t){return this._createLayerGraphic(this._createAttributes(e,t))}highlight(e){if("number"==typeof e||e instanceof b.Z?e=[e]:e instanceof pe.Z&&(e=e.toArray()),Array.isArray(e)&&e.length>0){if(e[0]instanceof b.Z){const t=e,s=this.i3slayer.fieldsIndex,i=this._getObjectIdField(),r=t.map(h=>(0,Dt.g)(s,h.attributes,i)),{set:l,handle:d}=this._highlights.acquireSet();return this._highlights.setFeatureIds(l,r),d}if("number"==typeof e[0]){const t=e,{set:s,handle:i}=this._highlights.acquireSet();return this._highlights.setFeatureIds(s,t),i}}return(0,W.kB)()}resetHighlights(){(0,N.SC)(this._highlights),this._highlights=new _s({collection:this._collection,forAllFeatures:e=>this._forAllFeatures(e,null,F.p1.ALL),forAllFeaturesOfNode:(e,t)=>this._forAllFeaturesOfNode(e,t)})}_visibleGeometryChanged(e,t){if(!this._elevationProvider)return;const s=this.getNodeComponentObb(e.node);s&&this._elevationProvider.objectChanged(s),null==this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle=(0,Q.Os)(()=>{this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle=null})),this._updateSnappingSources(e,t)}get performanceInfo(){return new hs(this.usedMemory,this._nodeId2Meta.size,Math.round(this._gpuMemoryEstimate/1048576),Math.round(this._geoMemoryEstimate/1048576),Math.round(this._texMemoryEstimate/1048576),Math.round(this.unloadedMemory/1048576),this._idbCacheEnabled?Math.round(100*this._idbCache.getHitRate()):0)}get test(){const e=this,t=s=>{this._nodeColorOverride=s,this._invalidateAllSymbols()};return{controller:this._controller,labeler:this._labeler,get visibleObjectIds(){const s=[];return e._forAllFeatures(i=>(s.push(i),F.Ku.CONTINUE),null,F.p1.VISIBLE_ONLY),s.sort((i,r)=>i-r),s},get numNodes(){return e._nodeId2Meta.size},get loadedNodes(){return Array.from(e._nodeId2Meta.keys()).sort((s,i)=>s-i)},setNodeColorOverride:t,setNodeColoring:s=>{t("client-nodes"===s?(i,r)=>{i.index<0?(r[0]=1,r[1]=0,r[2]=0):(r[0]=1,r[1]=1,r[2]=1)}:null)}}}getNodeOpacityByIndex(e){const t=this._nodeId2Meta.get(e);return this.getNodeOpacity(t)}getNodeOpacity(e){return null!=e?this._collection.getMaterial(e.objectHandle).objectOpacity:0}isNodeFullyFadedIn(e){return this._crossfadeHelper.isNodeFullyFadedIn(e)}getNodeCrossfadeMetaData(e){return this._nodeId2Meta.get(e)}markNodeToRemove(e){this._controller&&this._controller.markNodeToRemove(e)}removeMarkedNodes(){this._controller&&this._controller.removeMarkedNodes()}foreachCrossfadeNode(e){this._nodeId2Meta.forEach(e)}fadeNode(e,t,s){if(!this.nodeCrossfadingEnabled)return;const i=this._nodeId2Meta.get(e);null!=i&&this._crossfadeHelper.fadeNode(e,i,t,s)}setNodeOpacityByIndex(e,t){const s=this._nodeId2Meta.get(e);null!=s&&this._setNodeOpacity(s,t)}_setNodeOpacity(e,t){this._collection.updateMaterial(e.objectHandle,s=>s.objectOpacity=t),this._setNodeEdgeOpacity(e,t)}_setNodeEdgeOpacity(e,t){if(null==this._edgeView||!e.cachedEdgeMaterials)return;nt(e.cachedEdgeMaterials,t);const s=e.objectHandle;this._edgeView.hasObject(s)&&this._edgeView.updateAllComponentOpacities(s,t).catch(i=>Le(i,this.i3slayer.title))}get hasModifications(){return this._isIntegratedMesh&&null!=this._layerClippingArea||this._modifications&&this._modifications.length>0}updateNodeModificationStatus(e){if(!this.hasModifications||e.length<=0||!0!==this._i3sWasmLoaded)return;const s=this.uid,i=function zs(a){if(0===a.length)return;const e=new Float64Array(10*a.length);let t=0;return a.forAll(s=>{let i=s.serviceObbInIndexSR;null==i&&(i=Gs,i.center=(0,v.g)(s.serviceMbsInIndexSR),i.halfSize=[s.serviceMbsInIndexSR[3],s.serviceMbsInIndexSR[3],s.serviceMbsInIndexSR[3]]);const r=i.data;e[t++]=r[0],e[t++]=r[1],e[t++]=r[2],e[t++]=r[3],e[t++]=r[4],e[t++]=r[5],e[t++]=r[6],e[t++]=r[7],e[t++]=r[8],e[t++]=r[9]}),e}(e);if(i){(0,pt.filterObbsForModificationsSync)({context:s,buffer:i.buffer});const l=new Float64Array(i.buffer);e.forAll((d,h)=>{const u=(0,pt.interpretObbModificationResults)(l[h]);d.imModificationImpact=u,u!==St.O4.Unmodified&&this._controller.invalidateGeometryVisibility(d.index)})}}notifyUpdate(){this.notifyChange("updating")}notifyLODUpdate(){this._controller.notifyLODUpdate()}isUpdating(){return!(!this._controller||!this._controller.updating)||!!this._visibleGeometryChangedSchedulerHandle||null!=this._labeler&&this._labeler.updating||this._crossfadeHelper?.updating||this._i3sWasmLoaded instanceof Promise||this._asyncModuleLoading>0||null!=this._elevationTask&&this._elevationTask.running}trackSnappingSources(e){var t=this;const s={events:e,fetchEdgeLocations:(i=(0,C.Z)(function*(r,l,d){const h=t._nodeId2Meta.get(r);if(null==h)throw new Error("invalid-node");const{origin:c,buffer:u}=yield t._collection.extractEdgeInformation(h.objectHandle,l,d);return t._snappingLocationsApplyElevation(h,u,c),{type:"components",objectIds:h.featureIds,locations:u,origin:c}}),function(l,d,h){return i.apply(this,arguments)}),remove:()=>(0,re.e$)(this._snappingSourcesTrackers,s)};var i;return this._snappingSourcesTrackers.push(s),this._nodeId2Meta.forEach((i,r)=>{if(null==i)return;const l=this._controller.getRenderMbs(i.node);l&&e.add(r,l)}),s}_snappingLocationsApplyElevation(e,t,s){if(!e.elevationOffsets||this.elevationInfo.mode===F.vV.Absolute)return;const i=t.position0,r=t.position1,l=t.componentIndex,d=(0,x.Ue)(),h=(0,x.Ue)(),c=(u,j)=>{(0,_.g)(u,u,s),this.view.renderCoordsHelper.worldUpAtPosition(u,h),(0,_.g)(u,u,(0,_.h)(h,h,j)),(0,_.f)(u,u,s)};for(let u=0;u<i.count;u++){const j=e.elevationOffsets[l.get(u)];i.getVec(u,d),c(d,j),i.setVec(u,d),r.getVec(u,d),c(d,j),r.setVec(u,d)}}_updateSnappingSources(e,t){const{index:s}=e.node,i=this._controller.getRenderMbs(e.node);if(null!=i)for(const r of this._snappingSourcesTrackers)t!==Se.REMOVE&&t!==Se.UPDATE||r.events.remove(s),t!==Se.ADD&&t!==Se.UPDATE||r.events.add(s,i)}};return(0,g._)([(0,O.Cb)()],n.prototype,"_hasLoadedPBRTextures",void 0),(0,g._)([(0,O.Cb)()],n.prototype,"_asyncModuleLoading",void 0),(0,g._)([(0,O.Cb)()],n.prototype,"_visibleGeometryChangedSchedulerHandle",void 0),(0,g._)([(0,O.Cb)()],n.prototype,"view",void 0),(0,g._)([(0,O.Cb)()],n.prototype,"i3slayer",void 0),(0,g._)([(0,O.Cb)()],n.prototype,"_controller",void 0),(0,g._)([(0,O.Cb)()],n.prototype,"_labeler",void 0),(0,g._)([(0,O.Cb)()],n.prototype,"updating",void 0),(0,g._)([(0,O.Cb)()],n.prototype,"suspended",void 0),(0,g._)([(0,O.Cb)()],n.prototype,"contentVisible",null),(0,g._)([(0,O.Cb)({readOnly:!0})],n.prototype,"legendEnabled",null),(0,g._)([(0,O.Cb)()],n.prototype,"holeFilling",void 0),(0,g._)([(0,O.Cb)(js.q)],n.prototype,"updatingProgress",void 0),(0,g._)([(0,O.Cb)()],n.prototype,"updatingProgressValue",null),(0,g._)([(0,O.Cb)()],n.prototype,"hasTexturesOrVertexColors",null),(0,g._)([(0,O.Cb)()],n.prototype,"rendererTextureUsage",null),(0,g._)([(0,O.Cb)()],n.prototype,"elevationOffset",null),(0,g._)([(0,O.Cb)()],n.prototype,"elevationInfo",null),(0,g._)([(0,O.Cb)({type:Boolean})],n.prototype,"slicePlaneEnabled",void 0),(0,g._)([(0,O.Cb)()],n.prototype,"supportedTextureEncodings",null),(0,g._)([(0,O.Cb)()],n.prototype,"uncompressedTextureDownsamplingEnabled",null),(0,g._)([(0,O.Cb)({type:[ye.Z]})],n.prototype,"_modifications",void 0),(0,g._)([(0,O.Cb)({readOnly:!0})],n.prototype,"clientGeometry",null),(0,g._)([(0,O.Cb)()],n.prototype,"elevationRange",null),(0,g._)([(0,O.Cb)()],n.prototype,"fullExtent",null),(0,g._)([(0,O.Cb)()],n.prototype,"_elevationTask",void 0),(0,g._)([(0,O.Cb)({readOnly:!0})],n.prototype,"_usePBR",null),n=(0,g._)([(0,Y.j)(Wt)],n),n};function Le(a,n){(0,T.D_)(a)||De().warn("Error while processing edges. Edges on this layer might not display correctly",n,a)}var Se;!function(a){a[a.ADD=0]="ADD",a[a.REMOVE=1]="REMOVE",a[a.UPDATE=2]="UPDATE"}(Se||(Se={}));const Zt=(0,he.Ue)(),$t=(0,Ce.Ue)(),Hs=(0,Ce.Ue)(),Gs=new st.Oo,it=[0,0,0,0],Ks=new A.Z([0,0,0,0]),Yt=(0,v.f)(0,0,0,0);function Jt(a){if(null==a)return!1;const n=a.metallicRoughness;return n&&n.baseColorTextureId>=0||n&&n.metallicRoughnessTextureId>=0||a.normalTextureId>=0||a.emissiveTextureId>=0||a.occlusionTextureId>=0}function Qt(a){return null!=a&&(0,te.eP)(a.data)}function Xt(a,n){let e=1024+a.interleavedVertexData.byteLength+(a.indices?a.indices.byteLength:0)+a.positionData.data.byteLength+a.positionData.indices.byteLength;if(null!=n)for(const t of n)null!=t&&(0,te.eP)(t.data)&&(e+=t.data.byteLength);return e}function kt(a,n){return n.byteSize>ws?(De().warn(`Node is too big to store in IndexedDB cache: ${a.id} (${n.byteSize} bytes)`),!1):n.byteSize>0}function nt(a,n){a.forEach(e=>e.opacity=n)}class rt{constructor(n,e){this.mode=n,this.offset=e}}const qt=(0,x.Ue)(),Zs=(0,he.Ue)(),es="elevation-change",Et=[[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0]],$s=new At.r;function Nt(a,n,e){let t=a.elevationRangeMin,s=a.elevationRangeMax;const i=e;if(i>0){n.getCorners(Et);for(const r of Et){const l=(0,_.H)(r)-i;t=Math.min(t,l),s=Math.max(s,l)}}else{n.getCorners(Et);for(const r of Et){const l=r[2];t=Math.min(t,l),s=Math.max(s,l)}}a.expandElevationRangeValues(t,s)}function ts(a,n,e){const t=(0,v.g)(n),s=e>0?(0,_.H)(t)-e:t[2],i=(0,v.b)(n);a.expandElevationRangeValues(s-i,s+i)}},52836:(Re,ie,o)=>{var C,g,A,b;o.d(ie,{Ku:()=>g,p1:()=>C,vV:()=>A}),(b=C||(C={}))[b.VISIBLE_ONLY=0]="VISIBLE_ONLY",b[b.ALL=1]="ALL",b[b.QUERYABLE=2]="QUERYABLE",function(b){b[b.EXIT=0]="EXIT",b[b.CONTINUE=1]="CONTINUE",b[b.SKIP=2]="SKIP"}(g||(g={})),function(b){b[b.Absolute=0]="Absolute",b[b.RelativeToGround=1]="RelativeToGround",b[b.OnTheGround=2]="OnTheGround"}(A||(A={}))},30375:(Re,ie,o)=>{o.r(ie),o.d(ie,{destroyContext:()=>x,dracoDecompressPointCloudData:()=>S,filterObbsForModifications:()=>te,filterObbsForModificationsSync:()=>Ie,initialize:()=>he,interpretObbModificationResults:()=>ue,process:()=>le,project:()=>R,setLegacySchema:()=>M,setModifications:()=>O,setModificationsSync:()=>X,test:()=>Je,transformNormals:()=>H});var C=o(15861),g=o(65234),A=o(36344),b=o(57517),re=o(28036),oe=o(84161),pe=o(17926),W=o(54346);function V(f){return(0,W.V)(`esri/libs/i3s/${f}`)}let $;var N=o(52565);function le(f){return T.apply(this,arguments)}function T(){return(T=(0,C.Z)(function*(f){m=yield Oe();const v=[f.geometryBuffer];return{result:de(m,f,v),transferList:v}})).apply(this,arguments)}function S(f){return Q.apply(this,arguments)}function Q(){return(Q=(0,C.Z)(function*(f){m=yield Oe();const v=[f.geometryBuffer],{geometryBuffer:w}=f,ge=w.byteLength,ae=m._malloc(ge),xe=new Uint8Array(m.HEAPU8.buffer,ae,ge);xe.set(new Uint8Array(w));const ye=m.dracoDecompressPointCloudData(ae,xe.byteLength);if(m._free(ae),ye.error.length>0)throw new Error(`i3s.wasm: ${ye.error}`);const Ee=ye.featureIds?.length>0?ye.featureIds.slice():null,_e=ye.positions.slice();return Ee&&v.push(Ee.buffer),v.push(_e.buffer),{result:{positions:_e,featureIds:Ee},transferList:v}})).apply(this,arguments)}function te(f){return se.apply(this,arguments)}function se(){return(se=(0,C.Z)(function*(f){yield Oe(),Ie(f);const v={buffer:f.buffer};return{result:v,transferList:[v.buffer]}})).apply(this,arguments)}function O(f){return Y.apply(this,arguments)}function Y(){return(Y=(0,C.Z)(function*(f){yield Oe(),X(f)})).apply(this,arguments)}function M(f){return U.apply(this,arguments)}function U(){return(U=(0,C.Z)(function*(f){m=yield Oe(),m.setLegacySchema(f.context,f.jsonSchema)})).apply(this,arguments)}function R(f){return q.apply(this,arguments)}function q(){return(q=(0,C.Z)(function*(f){const{localMatrix:v,origin:w,positions:ge,vertexSpace:ae,localMode:xe}=f,ye=g.Z.fromJSON(f.inSpatialReference),Ee=g.Z.fromJSON(f.outSpatialReference);let _e;if("georeferenced"===ae.type&&null==ae.origin){const[{projectBuffer:ve},{initializeProjection:Ue}]=yield Promise.all([Promise.resolve().then(o.bind(o,39774)),Promise.resolve().then(o.bind(o,55915))]);yield Ue(ye,Ee),_e=new Float64Array(ge.length),ve(ge,ye,0,_e,Ee,0,_e.length/3)}else{const ve="georeferenced"===ae.type?b.Z.fromJSON(ae):re.Z.fromJSON(ae),{project:Ue}=yield Promise.resolve().then(o.bind(o,60853));_e=(0,A.mB)(Ue({positions:ge,transform:v?{localMatrix:v}:void 0,vertexSpace:ve,inSpatialReference:ye,outSpatialReference:Ee,localMode:xe}))}const Be=_e.length,[Qe,ze,dt]=w;for(let ve=0;ve<Be;ve+=3)_e[ve]-=Qe,_e[ve+1]-=ze,_e[ve+2]-=dt;return{result:{projected:_e,original:ge},transferList:[_e.buffer,ge.buffer]}})).apply(this,arguments)}function H(f){return _.apply(this,arguments)}function _(){return(_=(0,C.Z)(function*({normalMatrix:f,normals:v}){const w=new Float32Array(v.length);return(0,oe.b)(w,v,f),(0,oe.n)(w,w),{result:{transformed:w,original:v},transferList:[w.buffer,v.buffer]}})).apply(this,arguments)}function x(f){Ne(f)}let P,m;function X(f){if(!m)return;const v=f.modifications,w=m._malloc(8*v.length),ge=new Float64Array(m.HEAPU8.buffer,w,v.length);for(let ae=0;ae<v.length;++ae)ge[ae]=v[ae];m.setModifications(f.context,w,v.length,f.isGeodetic),m._free(w)}function de(f,v,w){const{context:ge,localOrigin:ae,globalTrafo:xe,mbs:ye,obbData:Ee,elevationOffset:_e,geometryBuffer:Be,geometryDescriptor:Qe,indexToVertexProjector:ze,vertexToRenderProjector:dt}=v,ve=f._malloc(Be.byteLength),we=f._malloc(33*Float64Array.BYTES_PER_ELEMENT),ht=new Uint8Array(f.HEAPU8.buffer,ve,Be.byteLength);ht.set(new Uint8Array(Be));const Pe=new Float64Array(f.HEAPU8.buffer,we,33);ne(Pe,ae);let Ve=Pe.byteOffset+3*Pe.BYTES_PER_ELEMENT,He=new Float64Array(Pe.buffer,Ve);ne(He,xe),Ve+=16*Pe.BYTES_PER_ELEMENT,He=new Float64Array(Pe.buffer,Ve),ne(He,ye),Ve+=4*Pe.BYTES_PER_ELEMENT,Ee&&(He=new Float64Array(Pe.buffer,Ve),ne(He,Ee));const ct=Qe,Ze={isDraco:!1,isLegacy:!1,color:v.layouts.some(ce=>ce.some(Me=>"color"===Me.name)),normal:v.needNormals&&v.layouts.some(ce=>ce.some(Me=>"normalCompressed"===Me.name)),uv0:v.layouts.some(ce=>ce.some(Me=>"uv0"===Me.name)),uvRegion:v.layouts.some(ce=>ce.some(Me=>"uvRegion"===Me.name)),featureIndex:ct.featureIndex},G=f.process(ge,!!v.obbData,ve,ht.byteLength,ct,Ze,we,_e,ze,dt,v.normalReferenceFrame);if(f._free(we),f._free(ve),G.error.length>0)throw new Error(`i3s.wasm: ${G.error}`);if(G.discarded)return null;const Xe=G.componentOffsets.length>0?G.componentOffsets.slice():null,ke=G.featureIds.length>0?G.featureIds.slice():null,Rt=G.anchorIds.length>0?Array.from(G.anchorIds):null,Fe=G.anchors.length>0?Array.from(G.anchors):null,ut=G.interleavedVertedData.slice().buffer,gt=G.indicesType===pe.P.Int16?new Uint16Array(G.indices.buffer,G.indices.byteOffset,G.indices.byteLength/2).slice():new Uint32Array(G.indices.buffer,G.indices.byteOffset,G.indices.byteLength/4).slice(),ft=G.positions.slice(),qe=G.positionIndicesType===pe.P.Int16?new Uint16Array(G.positionIndices.buffer,G.positionIndices.byteOffset,G.positionIndices.byteLength/2).slice():new Uint32Array(G.positionIndices.buffer,G.positionIndices.byteOffset,G.positionIndices.byteLength/4).slice(),xt={layout:v.layouts[0],interleavedVertexData:ut,indices:gt,hasColors:G.hasColors,hasModifications:G.hasModifications,positionData:{data:ft,indices:qe}};return ke&&w.push(ke.buffer),Xe&&w.push(Xe.buffer),w.push(ut),w.push(gt.buffer),w.push(ft.buffer),w.push(qe.buffer),{componentOffsets:Xe,featureIds:ke,anchorIds:Rt,anchors:Fe,transformedGeometry:xt,obb:G.obb}}function ue(f){return 0===f?N.O4.Unmodified:1===f?N.O4.PotentiallyModified:2===f?N.O4.Culled:N.O4.Unknown}function Ie(f){if(!m)return;const{context:v,buffer:w}=f,ge=m._malloc(w.byteLength),ae=w.byteLength/Float64Array.BYTES_PER_ELEMENT,xe=new Float64Array(m.HEAPU8.buffer,ge,ae),ye=new Float64Array(w);xe.set(ye),m.filterOBBs(v,ge,ae),ye.set(xe),m._free(ge)}function Ne(f){m&&0===m.destroy(f)&&(m=null)}function ne(f,v){for(let w=0;w<v.length;++w)f[w]=v[w]}function he(){return Ce.apply(this,arguments)}function Ce(){return(Ce=(0,C.Z)(function*(){m||(yield Oe())})).apply(this,arguments)}function Oe(){return m?Promise.resolve(m):(P||(P=function z(){return $||($=new Promise(f=>o.e(5979).then(o.bind(o,85979)).then(v=>v.i).then(({default:v})=>{const w=v({locateFile:V,onRuntimeInitialized:()=>f(w)});delete w.then})).catch(f=>{throw f})),$}().then(f=>(m=f,P=null,m))),P)}const Je={transform:(f,v)=>m&&de(m,f,v),destroy:Ne}},2694:(Re,ie,o)=>{o.d(ie,{Wx:()=>W,gz:()=>oe,z6:()=>pe});var C=o(79800),g=o(29302),A=o(39774),b=o(5548),re=o(36344);function oe($,N,le){const T=(0,re.bg)(24);return S=>{let Q=S.meta.featureExtents;if(null==Q){Q=new Float64Array(6*S.meta.featureIds.length),S.meta.featureExtents=Q;for(let se=0;se<Q.length;se+=6)Q[se]=Number.POSITIVE_INFINITY}const te=new Float64Array(Q.buffer,6*S.index*Float64Array.BYTES_PER_ELEMENT,6);return te[0]===Number.POSITIVE_INFINITY&&(pe(S.index,le,S.meta.objectHandle,T,0),(0,A.projectBuffer)(T,N,0,T,$,0,8)?((0,b.t8)(te,b.G_),(0,b.G1)(te,T,0,8)):(0,b.t8)(te,b.bM)),te}}function pe($,N,le,T,S){const Q=N.getComponentAabb(le,$,z),te=N.getObjectTransform(le);for(let se=0;se<8;++se)V[0]=1&se?Q[0]:Q[3],V[1]=2&se?Q[1]:Q[4],V[2]=4&se?Q[2]:Q[5],(0,C.t)(V,V,te.rotationScale),(0,C.g)(V,V,te.position),T[S++]=V[0],T[S++]=V[1],T[S++]=V[2];return T}const W=24,z=(0,b.Ue)(),V=(0,g.Ue)()},46884:(Re,ie,o)=>{o.d(ie,{u:()=>Y});var C=o(17626),g=o(83761),A=o(61885),b=o(63290),re=o(77712),W=(o(8314),o(4619),o(76898)),z=o(52113),V=o(74741),$=o(79800),N=o(29302),le=o(15869),T=o(65401),S=o(97126),Q=o(74993),te=o(21358),se=o(62483),O=o(67857);let Y=class extends(A.Z.EventedMixin(g.Z)){constructor(_){super(_),this._tmpEvent=new te.c,this._renderCoordsHelper=_.view.renderCoordsHelper,this._renderSR=this._renderCoordsHelper.spatialReference,this._layerElevationSource=_.layerElevationSource}initialize(){this._intersector=(0,se.Z8)(this.view.state.viewingMode),this._intersector.options.store=O.eC.MIN,this._tmpEvent.context=this.intersectionHandler.isGround?"ground":"scene"}get spatialReference(){return this.view?.elevationProvider?.spatialReference}getElevation(_,x,P,m){const X=this._renderCoordsHelper,de=(0,$.s)(R,_,x,P);if(!X.toRenderCoords(de,m,de))return b.Z.getLogger(this).error("could not project point to compute elevation"),null;const{layerElevationSource:ue,_intersector:Ie,intersectionHandler:Ne}=this,ne=ue.fullExtent,he=null!=ne&&Number.isFinite(ne.xmin)&&Number.isFinite(ne.xmax)&&Number.isFinite(ne.ymin)&&Number.isFinite(ne.ymax)&&Number.isFinite(ne.zmin)&&Number.isFinite(ne.zmax)?new Q.r(ne.zmin,ne.zmax):ue.elevationRange;if(null==he)return null;const Ce=ue.elevationOffset,Oe=he.elevationRangeMin+Ce,f=X.setAltitude(q,he.elevationRangeMax+Ce,de),v=X.setAltitude(H,Oe,de);return Ie.reset(f,v,null),Ne.intersect(Ie,null,f,v,null,!0),Ie.results.min.getIntersectionPoint(de)?X.getAltitude(de):null}getSphereElevationBounds(_,x){return(0,le.s)(_,x,U,this._renderSR),this._layerElevationSource.getElevationRange(U)}getRootElevationBounds(){const _=this.layerElevationSource.fullExtent;return _?.hasZ?new Q.r(_.zmin,_.zmax):null}objectsChanged(_){this.spatialReference&&(this._computeLayerExtent(_,this._tmpEvent.extent),this._tmpEvent.spatialReference=this.spatialReference,this.emit("elevation-change",this._tmpEvent))}objectChanged(_){this.spatialReference&&(this._computeObjectExtent(_,this._tmpEvent.extent),this._tmpEvent.spatialReference=this.spatialReference,this.emit("elevation-change",this._tmpEvent))}_computeObjectExtent(_,x){(0,T.cS)(x),this._expandExtent(_,x)}_computeLayerExtent(_,x){(0,T.cS)(x);for(const P of _)this._expandExtent(P,x)}_expandExtent(_,x){const P=this.spatialReference;if(null==P||null==_)return;(0,z.en)(M,_.quaternion),M[12]=_.center[0],M[13]=_.center[1],M[14]=_.center[2];const m=_.halfSize;for(let X=0;X<8;++X)R[0]=1&X?m[0]:-m[0],R[1]=2&X?m[1]:-m[1],R[2]=4&X?m[2]:-m[2],(0,$.e)(R,R,M),this._renderCoordsHelper.fromRenderCoords(R,R,P),(0,T.jn)(x,R,x)}};(0,C._)([(0,re.Cb)({constructOnly:!0})],Y.prototype,"layerElevationSource",void 0),(0,C._)([(0,re.Cb)({constructOnly:!0})],Y.prototype,"intersectionHandler",void 0),(0,C._)([(0,re.Cb)({constructOnly:!0})],Y.prototype,"view",void 0),(0,C._)([(0,re.Cb)()],Y.prototype,"spatialReference",null),Y=(0,C._)([(0,W.j)("esri.views.3d.layers.i3s.LayerElevationProvider")],Y);const M=(0,V.Ue)(),U=(0,S.f)(0,0,0,0),R=(0,N.Ue)(),q=(0,N.Ue)(),H=(0,N.Ue)()},95201:(Re,ie,o)=>{function C(g){return A=>{if(g.immediate)return g.immediate.schedule(A);const b="No immediate scheduler";throw console.error(b),new Error(b)}}o.d(ie,{H:()=>C})}}]);