"use strict";(self.webpackChunkpredio360_app=self.webpackChunkpredio360_app||[]).push([[901],{20901:(U,Z,u)=>{u.r(Z),u.d(Z,{createConnection:()=>c});var h=u(15861),_=u(17626),v=(u(29132),u(84792)),f=u(26584),y=u(63290),k=u(10699),M=u(21726),R=(u(8314),u(4619),u(76898)),w=u(77712),T=u(33696),j=u(61885);let F=class extends j.Z.EventedAccessor{destroy(){this.emit("destroy")}get connectionError(){return this.errorString?new f.Z("stream-connection",this.errorString):null}onFeature(e){this.emit("data-received",e)}onMessage(e){this.emit("message-received",e)}};(0,_._)([(0,w.Cb)({readOnly:!0})],F.prototype,"connectionError",null),F=(0,_._)([(0,R.j)("esri.layers.support.StreamConnection")],F);const P=F;var O,e;(e=O||(O={}))[e.CONNECTING=0]="CONNECTING",e[e.OPEN=1]="OPEN",e[e.CLOSING=2]="CLOSING",e[e.CLOSED=3]="CLOSED";let b=class extends P{constructor(e){super({}),this._outstandingMessages=[],this.errorString=null;const{geometryType:t,spatialReference:r,sourceSpatialReference:n}=e;this._config=e,this._featureZScaler=(0,T.k)(t,n,r),this._open()}normalizeCtorArgs(){return{}}_open(){var e=this;return(0,h.Z)(function*(){yield e._tryCreateWebSocket(),e.destroyed||(yield e._handshake())})()}destroy(){super.destroy(),null!=this._websocket&&(this._websocket.onopen=null,this._websocket.onclose=null,this._websocket.onerror=null,this._websocket.onmessage=null,this._websocket.close()),this._websocket=null}get connectionStatus(){if(null==this._websocket)return"disconnected";switch(this._websocket.readyState){case O.CONNECTING:case O.OPEN:return"connected";case O.CLOSING:case O.CLOSED:return"disconnected"}}sendMessageToSocket(e){null!=this._websocket?this._websocket.send(JSON.stringify(e)):this._outstandingMessages.push(e)}sendMessageToClient(e){this._onMessage(e)}updateCustomParameters(e){this._config.customParameters=e,null!=this._websocket&&this._websocket.close()}_tryCreateWebSocket(e=this._config.source.path,t=1e3,r=0){var n=this;return(0,h.Z)(function*(){try{if(n.destroyed)return;const a=(0,M.fl)(e,n._config.customParameters??{});n._websocket=yield n._createWebSocket(a),n.notifyChange("connectionStatus")}catch(a){const d=t/1e3;return n._config.maxReconnectionAttempts&&r>=n._config.maxReconnectionAttempts?(y.Z.getLogger(n).error(new f.Z("websocket-connection","Exceeded maxReconnectionAttempts attempts. No further attempts will be made")),void n.destroy()):(y.Z.getLogger(n).error(new f.Z("websocket-connection",`Failed to connect. Attempting to reconnect in ${d}s`,a)),yield(0,k.e4)(t),n._tryCreateWebSocket(e,Math.min(1.5*t,1e3*n._config.maxReconnectionInterval),r+1))}})()}_setWebSocketJSONParseHandler(e){e.onmessage=t=>{try{const r=JSON.parse(t.data);this._onMessage(r)}catch(r){return void y.Z.getLogger(this).error(new f.Z("websocket-connection","Failed to parse message, invalid JSON",{error:r}))}}}_createWebSocket(e){return new Promise((t,r)=>{const n=new WebSocket(e);n.onopen=()=>{if(n.onopen=null,this.destroyed)return n.onclose=null,void n.close();n.onclose=a=>this._onClose(a),n.onerror=a=>this._onError(a),this._setWebSocketJSONParseHandler(n),t(n)},n.onclose=a=>{n.onopen=n.onclose=null,r(a)}})}_handshake(e=1e4){var t=this;return(0,h.Z)(function*(){const r=t._websocket;if(null==r)return;const n=(0,k.hh)(),a=r.onmessage,{filter:d,outFields:g,spatialReference:E}=t._config;return n.timeout(e),r.onmessage=S=>{let p=null;try{p=JSON.parse(S.data)}catch{}p&&"object"==typeof p||(y.Z.getLogger(t).error(new f.Z("websocket-connection","Protocol violation. Handshake failed - malformed message",S.data)),n.reject(),t.destroy()),p.spatialReference?.wkid!==E?.wkid&&(y.Z.getLogger(t).error(new f.Z("websocket-connection",`Protocol violation. Handshake failed - expected wkid of ${E.wkid}`,S.data)),n.reject(),t.destroy()),"json"!==p.format&&(y.Z.getLogger(t).error(new f.Z("websocket-connection","Protocol violation. Handshake failed - format is not set",S.data)),n.reject(),t.destroy()),d&&p.filter!==d&&y.Z.getLogger(t).error(new f.Z("websocket-connection","Tried to set filter, but server doesn't support it")),g&&p.outFields!==g&&y.Z.getLogger(t).error(new f.Z("websocket-connection","Tried to set outFields, but server doesn't support it")),r.onmessage=a;for(const m of t._outstandingMessages)r.send(JSON.stringify(m));t._outstandingMessages=[],n.resolve()},r.send(JSON.stringify({filter:d,outFields:g,format:"json",spatialReference:{wkid:E.wkid}})),n.promise})()}_onMessage(e){if(this.onMessage(e),"type"in e)switch(e.type){case"features":case"featureResult":for(const t of e.features)null!=this._featureZScaler&&this._featureZScaler(t.geometry),this.onFeature(t)}}_onError(e){const t="Encountered an error over WebSocket connection";this._set("errorString",t),y.Z.getLogger(this).error("websocket-connection",t)}_onClose(e){this._websocket=null,this.notifyChange("connectionStatus"),1e3!==e.code&&y.Z.getLogger(this).error("websocket-connection",`WebSocket closed unexpectedly with error code ${e.code}`),this.destroyed||this._open()}};(0,_._)([(0,w.Cb)()],b.prototype,"connectionStatus",null),(0,_._)([(0,w.Cb)()],b.prototype,"errorString",void 0),b=(0,_._)([(0,R.j)("esri.layers.graphics.sources.connections.WebSocketConnection")],b);var D=u(20477),J=u(96854),N=u(91179),C=u(65234);const W={maxQueryDepth:5,maxRecordCountFactor:3};let i=class extends b{constructor(e){super({...W,...e}),this._buddyServicesQuery=null,this._relatedFeatures=null}_open(){var e=this;return(0,h.Z)(function*(){const t=yield e._fetchServiceDefinition(e._config.source);t.timeInfo.trackIdField||y.Z.getLogger(e).warn("GeoEvent service was configured without a TrackIdField. This may result in certain functionality being disabled. The purgeOptions.maxObservations property will have no effect.");const r=e._fetchWebSocketUrl(t.streamUrls,e._config.spatialReference);e._buddyServicesQuery||(e._buddyServicesQuery=e._queryBuddyServices()),yield e._buddyServicesQuery,yield e._tryCreateWebSocket(r);const{filter:n,outFields:a}=e._config;e.destroyed||e._setFilter(n,a)})()}_onMessage(e){if("attributes"in e){let t;try{t=this._enrich(e),null!=this._featureZScaler&&this._featureZScaler(t.geometry)}catch(r){return void y.Z.getLogger(this).error(new f.Z("geoevent-connection","Failed to parse message",r))}this.onFeature(t)}else this.onMessage(e)}_fetchServiceDefinition(e){var t=this;return(0,h.Z)(function*(){const r={f:"json",...t._config.customParameters},n=(0,v.Z)(e.path,{query:r,responseType:"json"}),a=(yield n).data;return t._serviceDefinition=a,a})()}_fetchWebSocketUrl(e,t){const r=e[0],{urls:n,token:a}=r,d=this._inferWebSocketBaseUrl(n);return(0,M.fl)(`${d}/subscribe`,{outSR:""+t.wkid,token:a})}_inferWebSocketBaseUrl(e){if(1===e.length)return e[0];for(const t of e)if(t.includes("wss"))return t;return y.Z.getLogger(this).error(new f.Z("geoevent-connection","Unable to infer WebSocket url",e)),null}_setFilter(e,t){var r=this;return(0,h.Z)(function*(){const n=r._websocket;if(null==n||null==e&&null==t)return;const a=JSON.stringify({filter:r._serializeFilter(e,t)});let d=!1;const g=(0,k.hh)();return n.onmessage=p=>{const m=JSON.parse(p.data);m.filter&&(m.error&&(y.Z.getLogger(r).error(new f.Z("geoevent-connection","Failed to set service filter",m.error)),r._set("errorString",`Could not set service filter - ${m.error}`),g.reject(m.error)),r._setWebSocketJSONParseHandler(n),d=!0,g.resolve())},n.send(a),setTimeout(()=>{d||(r.destroyed||r._websocket!==n||y.Z.getLogger(r).error(new f.Z("geoevent-connection","Server timed out when setting filter")),g.reject())},1e4),g.promise})()}_serializeFilter(e,t){const r={};if(null==e&&null==t)return r;if(e?.geometry)try{const n=(0,N.im)(e.geometry);if("extent"!==n.type)throw new f.Z(`Expected extent but found type ${n.type}`);r.geometry=JSON.stringify(n.shiftCentralMeridian())}catch(n){y.Z.getLogger(this).error(new f.Z("geoevent-connection","Encountered an error when setting connection geometryDefinition",n))}return e?.where&&"1 = 1"!==e.where&&"1=1"!==e.where&&(r.where=e.where),null!=t&&(r.outFields=t.join(",")),r}_enrich(e){if(!this._relatedFeatures)return e;const n=this._relatedFeatures.get(e.attributes[this._serviceDefinition.relatedFeatures.joinField]);if(!n)return y.Z.getLogger(this).warn("geoevent-connection","Feature join failed. Is the join field configured correctly?",e),e;const{attributes:a,geometry:d}=n;for(const g in a)e.attributes[g]=a[g];return d&&(e.geometry=d),e.geometry||e.centroid||y.Z.getLogger(this).error(new f.Z("geoevent-connection","Found malformed feature - no geometry found",e)),e}_queryBuddyServices(){var e=this;return(0,h.Z)(function*(){try{const{relatedFeatures:t,keepLatestArchive:r}=e._serviceDefinition,n=e._queryRelatedFeatures(t),a=e._queryArchive(r);yield n;const d=yield a;if(!d)return;for(const g of d.features)e.onFeature(e._enrich(g))}catch(t){y.Z.getLogger(e).error(new f.Z("geoevent-connection","Encountered an error when querying buddy services",{error:t}))}})()}_queryRelatedFeatures(e){var t=this;return(0,h.Z)(function*(){if(!e)return;const r=yield t._queryBuddy(e.featuresUrl);t._addRelatedFeatures(r)})()}_queryArchive(e){var t=this;return(0,h.Z)(function*(){if(e)return t._queryBuddy(e.featuresUrl)})()}_queryBuddy(e){var t=this;return(0,h.Z)(function*(){const r=new((yield Promise.resolve().then(u.bind(u,80415))).default)({url:e}),{capabilities:n}=yield r.load(),a=n.query.supportsMaxRecordCountFactor,d=n.query.supportsPagination,g=n.query.supportsCentroid,E=t._config.maxRecordCountFactor,S=r.capabilities.query.maxRecordCount,p=a?S*E:S,m=new J.Z;if(m.outFields=t._config.outFields??["*"],m.where=t._config.filter?.where??"1=1",m.returnGeometry=!0,m.returnExceededLimitFeatures=!0,m.outSpatialReference=C.Z.fromJSON(t._config.spatialReference),g&&(m.returnCentroid=!0),a&&(m.maxRecordCountFactor=E),d)return m.num=p,r.destroy(),t._queryPages(e,m);const A=yield(0,D.JT)(e,m,t._config.sourceSpatialReference);return r.destroy(),A.data})()}_queryPages(e,t,r=[],n=0){var a=this;return(0,h.Z)(function*(){t.start=null!=t.num?n*t.num:null;const{data:d}=yield(0,D.JT)(e,t,a._config.sourceSpatialReference);return d.exceededTransferLimit&&n<(a._config.maxQueryDepth??0)?(d.features.forEach(g=>r.push(g)),a._queryPages(e,t,r,n+1)):(r.forEach(g=>d.features.push(g)),d)})()}_addRelatedFeatures(e){const t=new Map,r=e.features,n=this._serviceDefinition.relatedFeatures.joinField;for(const a of r)t.set(a.attributes[n],a);this._relatedFeatures=t}};i=(0,_._)([(0,R.j)("esri.layers.graphics.sources.connections.GeoEventConnection")],i);const s=i;let l=class extends P{constructor(e){super({}),this.connectionStatus="connected",this.errorString=null;const{geometryType:t,spatialReference:r,sourceSpatialReference:n}=e;this._featureZScaler=(0,T.k)(t,n,r)}normalizeCtorArgs(){return{}}updateCustomParameters(e){}sendMessageToSocket(e){}sendMessageToClient(e){if("type"in e)switch(e.type){case"features":case"featureResult":for(const t of e.features)null!=this._featureZScaler&&this._featureZScaler(t.geometry),this.onFeature(t)}this.onMessage(e)}};function o(e,t){if(null==e&&null==t)return null;const r={};return null!=t&&(r.geometry=t),null!=e&&(r.where=e),r}function c(e,t,r,n,a,d,g,E,S){const p={source:e,sourceSpatialReference:t,spatialReference:r,geometryType:n,filter:o(a,d),maxReconnectionAttempts:g,maxReconnectionInterval:E,customParameters:S};return e?e.path.startsWith("wss://")||e.path.startsWith("ws://")?new b(p):new s(p):new l(p)}(0,_._)([(0,w.Cb)()],l.prototype,"connectionStatus",void 0),(0,_._)([(0,w.Cb)()],l.prototype,"errorString",void 0),l=(0,_._)([(0,R.j)("esri.layers.support.ClientSideConnection")],l)},76391:(U,Z,u)=>{function h(_){const x={};for(const v in _){if("declaredClass"===v)continue;const f=_[v];if(null!=f&&"function"!=typeof f)if(Array.isArray(f)){x[v]=[];for(let y=0;y<f.length;y++)x[v][y]=h(f[y])}else"object"==typeof f?f.toJSON&&(x[v]=JSON.stringify(f)):x[v]=f}return x}u.d(Z,{A:()=>h})},20477:(U,Z,u)=>{u.d(Z,{Ev:()=>b,JT:()=>T,Vn:()=>C,Vr:()=>J,hH:()=>D,n7:()=>O,qp:()=>F});var h=u(15861),_=u(84792),x=u(21726),v=u(91179),f=u(93555),y=u(37053),k=u(76391),M=u(85262),B=u(61515);const I="Layer does not support extent calculation.";function w(i,s){const l=i.geometry,o=i.toJSON();delete o.compactGeometryEnabled,delete o.defaultSpatialReferenceEnabled;const c=o;let e,t,r;if(null!=l&&(t=l.spatialReference,r=(0,y.B9)(t),c.geometryType=(0,v.Ji)(l),c.geometry=function R(i,s){if(s&&"extent"===i.type)return`${i.xmin},${i.ymin},${i.xmax},${i.ymax}`;if(s&&"point"===i.type)return`${i.x},${i.y}`;const l=i.toJSON();return delete l.spatialReference,JSON.stringify(l)}(l,i.compactGeometryEnabled),c.inSR=r),o.groupByFieldsForStatistics&&(c.groupByFieldsForStatistics=o.groupByFieldsForStatistics.join(",")),o.objectIds&&(c.objectIds=o.objectIds.join(",")),o.orderByFields&&(c.orderByFields=o.orderByFields.join(",")),!o.outFields||!o.returnDistinctValues&&(s?.returnCountOnly||s?.returnExtentOnly||s?.returnIdsOnly)?delete c.outFields:c.outFields=o.outFields.includes("*")?"*":o.outFields.join(","),o.outSR?(c.outSR=(0,y.B9)(o.outSR),e=i.outSpatialReference):l&&(o.returnGeometry||o.returnCentroid)&&(c.outSR=c.inSR,e=t),o.returnGeometry&&delete o.returnGeometry,o.outStatistics&&(c.outStatistics=JSON.stringify(o.outStatistics)),o.fullText&&(c.fullText=JSON.stringify(o.fullText)),o.pixelSize&&(c.pixelSize=JSON.stringify(o.pixelSize)),o.quantizationParameters&&(i.defaultSpatialReferenceEnabled&&null!=t&&null!=i.quantizationParameters?.extent&&t.equals(i.quantizationParameters.extent.spatialReference)&&delete o.quantizationParameters.extent.spatialReference,c.quantizationParameters=JSON.stringify(o.quantizationParameters)),o.parameterValues&&(c.parameterValues=JSON.stringify(o.parameterValues)),o.rangeValues&&(c.rangeValues=JSON.stringify(o.rangeValues)),o.dynamicDataSource&&(c.layer=JSON.stringify({source:o.dynamicDataSource}),delete o.dynamicDataSource),o.timeExtent){const n=o.timeExtent,{start:a,end:d}=n;null==a&&null==d||(c.time=a===d?a:`${a??"null"},${d??"null"}`),delete o.timeExtent}return i.defaultSpatialReferenceEnabled&&null!=t&&null!=e&&t.equals(e)&&(c.defaultSR=c.inSR,delete c.inSR,delete c.outSR),c}function T(i,s,l,o){return j.apply(this,arguments)}function j(){return(j=(0,h.Z)(function*(i,s,l,o){const c=null!=s.timeExtent&&s.timeExtent.isEmpty?{data:{features:[]}}:yield C(i,s,"json",o);return(0,B.p)(s,l,c.data),c})).apply(this,arguments)}function F(i,s,l,o){return P.apply(this,arguments)}function P(){return(P=(0,h.Z)(function*(i,s,l,o){if(null!=s.timeExtent&&s.timeExtent.isEmpty)return{data:l.createFeatureResult()};const c=yield O(i,s,o),e=c;return e.data=(0,M.C)(c.data,l),e})).apply(this,arguments)}function O(i,s,l){return C(i,s,"pbf",l)}function b(i,s,l){return null!=s.timeExtent&&s.timeExtent.isEmpty?Promise.resolve({data:{objectIds:[]}}):C(i,s,"json",l,{returnIdsOnly:!0})}function D(i,s,l){return null!=s.timeExtent&&s.timeExtent.isEmpty?Promise.resolve({data:{count:0}}):C(i,s,"json",l,{returnIdsOnly:!0,returnCountOnly:!0})}function J(i,s,l){return N.apply(this,arguments)}function N(){return(N=(0,h.Z)(function*(i,s,l){if(null!=s.timeExtent&&s.timeExtent.isEmpty)return{data:{count:0,extent:null}};const o=yield C(i,s,"json",l,{returnExtentOnly:!0,returnCountOnly:!0}),c=o.data;if(c.hasOwnProperty("extent"))return o;if(c.features)throw new Error(I);if(c.hasOwnProperty("count"))throw new Error(I);return o})).apply(this,arguments)}function C(i,s,l){return L.apply(this,arguments)}function L(){return(L=(0,h.Z)(function*(i,s,l,o={},c={}){const e="string"==typeof i?(0,x.mN)(i):i,t=s.geometry?[s.geometry]:[],n=(yield(0,f.aX)(t,null,{signal:o.signal}))?.[0];null!=n&&((s=s.clone()).geometry=n);const a=(0,k.A)({...e.query,f:l,...c,...w(s,c)});return(0,_.Z)((0,x.v_)(e.path,function W(i,s){return null!=i.formatOf3DObjects&&!(s.returnCountOnly||s.returnExtentOnly||s.returnIdsOnly)}(s,c)?"query3d":"query"),{...o,responseType:"pbf"===l?"array-buffer":"json",query:{...a,...o.query}})})).apply(this,arguments)}}}]);