"use strict";(self.webpackChunkpredio360_app=self.webpackChunkpredio360_app||[]).push([[7601,6446,3740],{42763:(De,le,l)=>{l.d(le,{Z:()=>c});var E=l(36082),I=l(48902);class c{constructor(te){this._observable=new I.s,this._set=new Set(te)}get size(){return(0,E.it)(this._observable),this._set.size}add(te){const Q=this._set.size;return this._set.add(te),this._set.size!==Q&&this._observable.notify(),this}clear(){this._set.size>0&&(this._set.clear(),this._observable.notify())}delete(te){const Q=this._set.delete(te);return Q&&this._observable.notify(),Q}entries(){return(0,E.it)(this._observable),this._set.entries()}forEach(te,Q){(0,E.it)(this._observable),this._set.forEach((j,ie)=>te.call(Q,j,ie,this),Q)}has(te){return(0,E.it)(this._observable),this._set.has(te)}keys(){return(0,E.it)(this._observable),this._set.keys()}values(){return(0,E.it)(this._observable),this._set.values()}[Symbol.iterator](){return(0,E.it)(this._observable),this._set[Symbol.iterator]()}get[Symbol.toStringTag](){return this._set[Symbol.toStringTag]}}},15869:(De,le,l)=>{l.d(le,{s:()=>te});var E=l(21286),I=l(29302),c=l(94008),he=l(94425);function te(M,ve,q,S){if(null==ve||null==S)return!1;const z=(0,c.Bg)(ve,S,ie);if(z.projector===c.iq)return q[0]=M[0],q[1]=M[1],q[2]=M[2],q[3]=M[3],!0;if(null==z.projector)return!1;const{source:B,dest:fe}=z;if(fe.spatialReferenceId===c.Ej.WEB_MERCATOR){const ue=c.rf[B.spatialReferenceId][c.Ej.WGS84];return null!=ue&&(ue(M,0,j,0),(0,c.uT)(j,0,q,0),q[3]=Q(j[1],M[2],M[3],he.sv.radius),!0)}if(B.spatialReferenceId!==c.Ej.WGS84&&B.spatialReferenceId!==c.Ej.CGCS2000||fe.spatialReferenceId!==c.Ej.PLATE_CARREE)z.projector(M,0,q,0),q[3]=M[3]*(B.metersPerUnit??1)/(fe.metersPerUnit??1);else{let F=M[3];null!=c.rf[B.spatialReferenceId][c.Ej.SPHERICAL_ECEF]&&null!=c.rf[c.Ej.SPHERICAL_ECEF][c.Ej.PLATE_CARREE]&&(F=Q(M[1],M[2],M[3],he.sv.radius)),z.projector(M,0,q,0),q[3]=F}return!0}function Q(M,ve,q,S){const z=S+ve;if(z<S/2||q>z)return Number.MAX_VALUE;const B=Math.abs(k*M)+Math.asin(q/z);return B>=Math.PI/2?Number.MAX_VALUE:q/Math.cos(B)}const j=(0,I.Ue)(),ie=(0,c.sw)(),k=(0,E.Vl)(1)},80543:(De,le,l)=>{l.d(le,{Z:()=>mi});var E=l(15861),I=l(17626),c=l(83761),he=l(8314),te=l(63290),Q=l(77029),j=l(60330),ie=l(10699),k=l(32917),M=l(77712),q=(l(4619),l(76898)),S=l(51707),z=l(65401),B=l(41967),fe=l(41291),ue=l(59617),oe=l(26584),F=l(62208),J=l(1036),ce=l(35948),P=l(86274),Y=l(32884),y=l(79800),g=l(29302),v=l(15869),O=l(17727),w=l(97126),W=l(91558),T=l(33899),ne=l(19574),L=l(81937),_=l(42743),f=l(45582),b=l(30395);function Z(){return(Z=(0,E.Z)(function*(n){const e=[],t=[];if(null==n)return{material:{alphaMode:"opaque",alphaCutoff:.1,doubleSided:!0,cullFace:0,normalTextureId:-1,emissiveTextureId:-1,occlusionTextureId:-1,emissiveFactor:[0,0,0],metallicRoughness:{baseColorFactor:[1,1,1,1],baseColorTextureId:-1,metallicRoughnessTextureId:-1,metallicFactor:0,roughnessFactor:.6000000238418579},wrapTextures:!1,hasParametersFromSource:!0},requiredTextures:e,textureData:t};const i=function $(n){return n.hasOwnProperty("metallicRoughnessTexture")}(n);"auto"===n.alphaMode&&console.warn('alphaMode "auto" not supported by I3S PBRMaterial - defaulting to "blend".');const s=(0,b.Ih)({normalTexture:n.normalTexture,emissiveTexture:i?n.emissiveTexture:null,emissiveFactor:i?W.Z.toUnitRGB(n.emissiveColor):null,occlusionTexture:i?n.occlusionTexture:null,metallicRoughnessTexture:i?n.metallicRoughnessTexture:null,metallicFactor:i?n.metallic:null,roughnessFactor:i?n.roughness:null}),r=s?b.yI[0]:i?n.metallic:0,o=s?b.yI[1]:i?n.roughness:0;return{material:{alphaMode:"auto"===n.alphaMode?"blend":n.alphaMode,alphaCutoff:n.alphaCutoff,doubleSided:n.doubleSided,cullFace:n.doubleSided?_.Vr.None:_.Vr.Back,normalTextureId:yield G(n.normalTexture,e,t,L.v.Normal),emissiveTextureId:i?yield G(n.emissiveTexture,e,t,L.v.Emissive):-1,occlusionTextureId:i?yield G(n.occlusionTexture,e,t,L.v.Occlusion):-1,emissiveFactor:i&&null!=n.emissiveColor?W.Z.toUnitRGB(n.emissiveColor):[0,0,0],metallicRoughness:{baseColorFactor:null!=n.color?W.Z.toUnitRGBA(n.color):[1,1,1,1],baseColorTextureId:yield G(n.colorTexture,e,t,L.v.Color),metallicRoughnessTextureId:i?yield G(n.metallicRoughnessTexture,e,t,L.v.MetallicRoughness):-1,metallicFactor:r,roughnessFactor:o},wrapTextures:!0,hasParametersFromSource:s},requiredTextures:e,textureData:t}})).apply(this,arguments)}function G(n,e,t,i){return H.apply(this,arguments)}function H(){return(H=(0,E.Z)(function*(n,e,t,i){if(null==n)return-1;const s=t.length,r=n.data,o=n.url;if(null!=r){if(r instanceof HTMLImageElement||r instanceof HTMLCanvasElement){const a=(0,f.n9)(r);return t.push({id:s,usage:i,data:a,encoding:L.j.PNG,downsampled:!1}),e.push({id:s,usage:i,encodings:[{name:void 0,encoding:L.j.PNG}]}),s}if(r instanceof HTMLVideoElement)return-1;if(r instanceof ImageData)throw new oe.Z("ImageData textures not supported yet for client side I3S nodes");if(r instanceof ne.NM)throw new oe.Z("EncodedMeshTexture textures not supported yet for client side I3S nodes")}else if(null!=o){const a=new Image;a.src=o;const d=yield(0,T.fY)(a,a.src,!1,void 0),h=(0,f.n9)(d);return t.push({id:s,usage:i,data:h,encoding:L.j.PNG,downsampled:!1}),e.push({id:s,usage:i,encodings:[{name:void 0,encoding:L.j.PNG}]}),s}return-1})).apply(this,arguments)}class se{constructor(e,t,i,s){this._uid=e,this._worker=s,this._id2Meta=new Map,this._oid2Meta=new Map,this._indexSR=t.indexSR,this._vertexSR=t.vertexSR,this._renderSR=t.renderSR,this._localMode=t.localMode,this._memCache=i.newCache(`sl-client-mesh-data-${this._uid}`)}get uid(){return this._uid}get worker(){return this._worker}get indexSR(){return this._indexSR}get renderSR(){return this._renderSR}createMeshNodeInfo(e,t){const i=`mesh${t}`,s=e.extent,r=s.spatialReference,o=this._indexSR,a=function X(n,e){const{spatialReference:t}=n,i=[1,-1],s=[.5*n.width,.5*n.height,n.hasZ?.5*(n.zmax-n.zmin):0],r=t.isGeographic?t.metersPerUnit:1,o=n.center;let a=0;if(n.hasZ)for(let d=0;d<2;++d)for(let h=0;h<2;++h)for(let m=0;m<2;++m){const x=(o.x+i[d]*s[0]-e.x)*r,u=(o.y+i[h]*s[1]-e.y)*r,p=o.z+i[m]*s[2]-e.z;a=Math.max(x*x+u*u+p*p,a)}else for(let d=0;d<2;++d)for(let h=0;h<2;++h){const m=(o.x+i[d]*s[0]-e.x)*r,x=(o.y+i[h]*s[1]-e.y)*r;a=Math.max(m*m+x*x,a)}return(0,w.k)([e.x,e.y,e.z],Math.sqrt(a))}(s,e.origin);return(0,v.s)(a,r,a,o),{type:"mesh",id:i,version:Te(e),oid:t,mbs:a,componentNodeIds:[],unloadedMesh:e,nodeIndex:null,loadMeshPromise:null}}addMeshNode(e,t){if(null!=this.getMeshNodeIndex(t.oid))throw new oe.Z(`I3SClientNodeLoader: client side mesh for feature oid=${t.oid} already exists`);t.nodeIndex=e,this._id2Meta.set(t.id,t),this._oid2Meta.set(t.oid,t)}getMeshNodeIndex(e){const t=this._oid2Meta.get(e);return null==t||"mesh"!==t.type?null:t.nodeIndex}removeNode(e){const t=this._id2Meta.get(e);null!=t&&(this._id2Meta.delete(e),"mesh"===t.type&&this._oid2Meta.delete(t.oid))}loadNodeJSON(e){var t=this;return(0,E.Z)(function*(){const i=t._id2Meta.get(e);if(null==i)throw new oe.Z(`I3SClientNodeLoader::loadNodeJSON unable to find node ${e}`);switch(i.type){case"mesh":return t._loadMeshNodeJSON(i);case"mesh-component":return t._loadMeshComponentNodeJSON(i);default:throw new oe.Z(`I3SClientNodeLoader::loadNodeJSON unable to handle node ${e}`)}})()}_loadMeshNodeJSON(e){var t=this;return(0,E.Z)(function*(){const i=e.id,s=(yield t._getMeshData(e)).loadedMesh;if(null==s.components||0===s.components.length)return{id:i,version:null,mbs:e.mbs,obb:null,sharedResource:null,geometryData:null,attributeData:null,featureData:null,children:null};const r=[],o=s.components;for(let a=0;a<o.length;++a){const d=`${i}-component${a}`,h={type:"mesh-component",id:d,mbs:e.mbs,componentIndex:a,meshNodeInfo:e,textureData:new Map};t._id2Meta.set(h.id,h),e.componentNodeIds.push(d),r.push({id:h.id,href:null,mbs:h.mbs,obb:null})}return{id:i,version:null,mbs:e.mbs,obb:null,sharedResource:null,geometryData:null,attributeData:null,featureData:null,children:r}})()}updateNodeIndex(e,t,i){const s=this._id2Meta.get(e);s&&"mesh"===s.type&&(s.nodeIndex=i)}_loadMeshComponentNodeJSON(e){return(0,E.Z)(function*(){return{id:e.id,version:e.meshNodeInfo.version,mbs:e.mbs,obb:null,sharedResource:null,geometryData:null,attributeData:null,featureData:null,children:null,isEmpty:!1}})()}loadNodeData(e,t){var i=this;return(0,E.Z)(function*(){const s=i._id2Meta.get(e);if(null==s||"mesh-component"!==s.type)throw new oe.Z(`Failed to load client node data for node ${e} (unexpected node info)`);const r=s.meshNodeInfo,o=yield i._getMeshData(r),a=o.loadedMesh,d=r.oid;if(null==a.components)throw new oe.Z(`Failed to load client node data for node ${e} (unexpected null reference)`);const h=a.components[s.componentIndex],{material:m,requiredTextures:x,textureData:u}=yield function A(n){return Z.apply(this,arguments)}(h.material);if(null!=u)for(const Fe of u)null!=Fe&&s.textureData.set(Fe.id,Fe);const p={params:{material:m},type:"ArrayBufferView"},{vertexSpace:N,origin:D,transform:C}=a,U=[D.x,D.y,D.z??0],V={featureDataPosition:U,featureIds:[],geometries:[p]};o.projectionPromise||((0,F.O3)(i._worker,"SceneLayerWorker is needed to project mesh"),o.projectionPromise=i._worker.project({positions:a.vertexAttributes.position,localMatrix:C?.localMatrix,vertexSpace:N.toJSON(),origin:U,inSpatialReference:a.spatialReference.toJSON(),outSpatialReference:i._vertexSR.toJSON(),localMode:i._localMode},t));const{projected:ee,original:de}=yield o.projectionPromise;a.vertexAttributes.position=de;const{transformed:me,original:pe}=yield function _e(n,e,t,i){return re.apply(this,arguments)}(h,o,i._worker,t);a.vertexAttributes.normal=pe,(0,ie.k_)(t);const{geometryBuffer:be,geometryDescriptor:Ce}=function xe(n,e,t,i,s,r){const a=e.length/3,d=3*a;let h=0,m=0,x=!1,u=0,p=!1,N=0,D=!1,C=0,U=0,V=0;h+=Ie,h+=Ie,m=h,h+=3*d*Pe,null!=t&&(x=!0,u=h,h+=3*d*Pe),null!=i&&(p=!0,N=h,h+=2*d*Pe),null!=s&&(D=!0,C=h,h+=4*d*Ze),U=h,h+=1*He,V=h,h+=2*Ie;const R=new ArrayBuffer(h),ee=new Uint8Array(R);ae(ee,0,d),ae(ee,Ie,1);const de=new Float32Array(R,m),me=null!=t?new Float32Array(R,u):null,pe=null!=i?new Float32Array(R,N):null,be=null!=s?new Uint8Array(R,C):null;for(let Ce=0;Ce<a;++Ce){const Fe=3*Ce;for(let Ue=0;Ue<3;++Ue){const Oe=e[Fe+Ue],Ae=3*Oe,Qe=9*Ce+3*Ue;if(de[Qe]=n[Ae],de[Qe+1]=n[Ae+1],de[Qe+2]=n[Ae+2],null!=me&&(me[Qe]=t[Ae],me[Qe+1]=t[Ae+1],me[Qe+2]=t[Ae+2]),null!=pe){const Ge=2*Oe,We=6*Ce+2*Ue;pe[We]=i[Ge],pe[We+1]=i[Ge+1]}if(null!=be){const Ge=4*Oe,We=12*Ce+4*Ue;be[We]=s[Ge],be[We+1]=s[Ge+1],be[We+2]=s[Ge+2],be[We+3]=s[Ge+3]}}}return ae(ee,U,r),ae(ee,U+Ie,r/2**32),ae(ee,V,0),ae(ee,V+Ie,a-1),{geometryBuffer:R,geometryDescriptor:{isDraco:!1,isLegacy:!0,color:D,normal:x,uv0:p,uvRegion:!1,featureIndex:!0}}}(ee,h.faces,me,a.vertexAttributes.uv,a.vertexAttributes.color,d);return{geometryData:V,attributeDataInfo:{attributeData:{},loadedAttributes:[]},geometryBuffer:be,geometryDescriptor:Ce,requiredTextures:x,textureData:u,normalReferenceFrame:i._vertexSR.isGeographic?"east-north-up":"vertex-reference-frame"}})()}loadAttributes(e,t,i){return(0,E.Z)(function*(){const s=e.numFeatures,r={};for(const{field:{name:o}}of t)r[o]=new Array(s);return r})()}loadTextures(e,t,i){var s=this;return(0,E.Z)(function*(){const o=s._id2Meta.get(e.id);if(null==o||"mesh-component"!==o.type)throw new Error(`Failed to load textures for node ${e.id} (unexpected node info)`);const a=[];for(const d of t)a.push(o.textureData.get(d.id)||null);return a})()}_getMeshData(e){var t=this;return(0,E.Z)(function*(){const i=e.version,s=t._memCache.get(i);if(null==s){if(null!=e.loadMeshPromise)return e.loadMeshPromise;const r=function(){var o=(0,E.Z)(function*(a,d){const h=e.unloadedMesh.clone();try{yield h.load()}catch(u){d(u)}const m=h.memoryUsage,x={loadedMesh:h,projectionPromise:null,normalsTransformPromise:null,usedMemoryInBytes:m};t._memCache.put(i,x,m,J.M4),e.loadMeshPromise=null,a(x)});return function(d,h){return o.apply(this,arguments)}}();return e.loadMeshPromise=new Promise((o,a)=>r(o,a)),e.loadMeshPromise}return s})()}}function re(){return(re=(0,E.Z)(function*(n,e,t,i){const{transform:s,vertexAttributes:r}=e.loadedMesh,o="source"===n.shading?r.normal:null;if(null==o||null==s||0===s.rotationAngle&&(0,y.j)(s.scale,g.hq))return{transformed:o,original:r.normal};if(!e.normalsTransformPromise){(0,F.O3)(t,"SceneLayerWorker is needed to transform mesh normals");const a=(0,Y.Ue)();(0,P.XL)(a,s.localMatrix),e.normalsTransformPromise=t.transformNormals({normalMatrix:a,normals:o},i)}return e.normalsTransformPromise})).apply(this,arguments)}function ae(n,e,t){n[e]=255&t,n[e+1]=255&t>>8,n[e+2]=255&t>>16,n[e+3]=255&t>>24}function Te(n){const e=n.metadata.displaySource?.source;if(null==e||!Array.isArray(e)||!e.length||e[0]instanceof File)return(0,ce.DO)();const t=e;let i="";for(const s of t)i+=s.makeHash();return i+JSON.stringify(null!=n.transform?n.transform.toJSON():"")+((0,O.zZ)(n.vertexSpace)?JSON.stringify(n.vertexSpace.origin):"")}const Ie=4,Pe=4,Ze=1,He=8;var Ne=l(85931),Me=l(54024),Je=l(87091);let Ve=class extends c.Z{constructor(){super(),this.referenceCount=0,this.callbacks=new Array,this.runIndex=0}get running(){return this.callbacks.some(n=>n.running)}runTask(n){this._sort();const e=this.callbacks,t={numIndexLoading:0,numNodesLoading:0};for(let i=0;i<e.length&&!n.done;++i)e[i].priority=e[i].runTask(n,t),this.runIndex=i}_sort(){const n=this.callbacks;let e=n.length;for(let t=this.runIndex;t>0;t--){const i=n[t-1];let s=t;for(;s<n.length&&i.priority<=n[s].priority&&(s!==e||i.priority<n[s].priority);)n[s-1]=n[s],s++;n[s-1]=i,e=s-1}this.runIndex=0}add(n){this._sort(),n.priority=1/0,this.callbacks.unshift(n),this.notifyChange("running")}remove(n){(0,Ne.e$)(this.callbacks,n),this.runIndex=this.callbacks.length,this._sort(),this.notifyChange("running")}};(0,I._)([(0,M.Cb)({readOnly:!0})],Ve.prototype,"running",null),Ve=(0,I._)([(0,q.j)("esri.views.3d.layers.i3s.I3SFrameTask")],Ve);class Ye{constructor(e,t){this.task=e,this.handle=t}}const je=new Map;function Tt(n,e){let t=je.get(n);if(null==t){const i=new Ve,s=n.registerTask(Je.T8.I3S_CONTROLLER,i);t=new Ye(i,s),je.set(n,t)}return t.task.add(e),(0,Me.kB)(()=>{null!=t&&(t.task.remove(e),t.task.callbacks.length>0||(je.delete(n),t.handle.remove(),t.task.destroy()),t=null)})}var Ft=l(35560),K=l(52565),Ee=l(42964);class Ut{constructor(e,t,i,s,r,o,a,d){this.id=e,this.mbs=t,this.obb=i,this.version=s,this.resources=r,this.children=o,this.lodSelection=a,this.numFeatures=d}}var Vt=l(74993),Be=l(93394);class at{constructor(e,t,i,s,r){this.childOffset=e,this.childCount=t,this.visibilityCache=i,this.ref=s,this.node=r,this.useAsHole=0,this.filterImpact=K.U_.NotChecked,this.traversalState=null,this.parent=-1}}class lt{constructor(e=new Array,t=new Array){this.nodes=e,this.children=t,this.lastTraversed=0,this.numNodesWithLoadedChildren=0}}class jt{get _useNodePages(){return this._pageSize>0}constructor(e,t,i,s,r,o,a,d,h,m,x,u,p,N,D,C){this.viewingMode=e,this._layer=t,this._streamDataController=s,this._clientNodeLoader=r,this._viewportQueries=o,this._logger=a,this.holeFilling=d,this._isLoaded=h,this._isReloading=m,this._isSelected=x,this._enable=u,this._needsUpdate=p,this._canRequest=N,this._computeVisibilityObb=D,this._computeNodeFiltering=C,this._dirty=!0,this._nodePages=new Map,this._clientNodePage=null,this._pageSize=0,this._rootIndex=0,this._lodMetric=K.w5.None,this._lodConversion=U=>U,this._isEditable=!1,this._urlPrefix="",this._loadingNodes=new Set,this._loadingPages=new Set,this._failedNodes=new Set,this._failedPages=new Set,this._indexMissing=1,this._maxUnloadedPrio=Number.NEGATIVE_INFINITY,this._maxProcessingPrio=Number.POSITIVE_INFINITY,this._version=Ke(0),this._visibilityCacheVersion=Ke(0),this._maxLevel=1,this._featureEstimate={estimate:0,leavesReached:!1},this._unloadedMemoryEstimate=0,this._missingPagesAndNodes=new Q.Z({deallocator:null}),this._prefetchNodes=new Q.Z({deallocator:null}),this._updates=new Bt(this._missingPagesAndNodes),this._imModificationUncategorized=new Q.Z({deallocator:null}),this.ignoreServiceObb=!1,this.progressiveLoadPenalty=0,this._pageQueue=new Array,this._newPages=new Array,this.needNodeElevationRange=!1,this.layerHasModifications=!1,this._layerHasFilter=!1,this._frameNumber=0,this._traverseDescendantsQueue=[0],this._traverseDescendantsNestingLevel=0,this._isEditable=(0,Ft.yA)()&&null!=t.associatedLayer?.infoFor3D,t.serviceUpdateTimeStamp?.lastUpdate&&(this._lastUpdate=`${t.serviceUpdateTimeStamp.lastUpdate}`),this._maxLodLevel=this._viewportQueries?this._viewportQueries.maxLodLevel:1,this._init(i)}_init(e){if("page"===e.type){const t=e.rootPage;switch(this._urlPrefix=e.urlPrefix,this._pageSize=e.pageSize,e.lodMetric){case"maxScreenThreshold":this._lodMetric=K.w5.MaxScreenThreshold;break;case"maxScreenThresholdSQ":this._lodMetric=K.w5.MaxScreenThreshold,this._lodConversion=Zt}if(this._isEditable){this._rootIndex=-1;const i=Se(e.rootIndex,e.pageSize),s=t.nodes[i],r={nodes:[{index:this._rootIndex,children:[e.rootIndex],mesh:void 0,obb:s.obb,lodThreshold:s.lodThreshold}]};this._addPage(Le(this._rootIndex,this._pageSize),r),this.getNode(-1).serviceObbInIndexSR=void 0}else this._rootIndex=e.rootIndex;this._addPage(Le(e.rootIndex,this._pageSize),t),this._updateParentsAndLevel()}else if("node"===e.type){this._urlPrefix=e.urlPrefix;const t=new lt;if(this._nodePages.set(0,t),this._isEditable){this._clientNodePage=new lt;const s={id:"-1",version:null,mbs:e.rootNode.mbs,obb:e.rootNode.obb,sharedResource:null,geometryData:null,attributeData:null,featureData:null,children:[{id:"root",href:"../root",mbs:e.rootNode.mbs,obb:e.rootNode.obb}]};this._rootIndex=this._makeClientRefNode(new K.$i(s.id,null),-1);const r=this._validateNode(s.id,s);r&&this._addNode(r,this._rootIndex)}else this._rootIndex=this._makeRefNode(new K.$i(e.rootNode.id,null),-1);const i=this._validateNode(e.rootNode.id,e.rootNode);i&&this._addNode(i,0)}}addClientNodeToIndex(e,t){const s=new K.$i(e,t),r=this._makeClientRefNode(s,-1);return this._linkChildToParentNode(-1,r),this.requestUpdate(),r}removeClientNodeFromIndex(e,t,i){this._destroyClientRefNode(e,t,i),this.requestUpdate()}_loadPage(e){this._loadingPages.add(e),this._streamDataController.request(this._urlPrefix+e,"json").then(i=>{this._pageQueue.push({pageIndex:e,page:i})}).catch(i=>{this._loadingPages.delete(e),(0,ie.D_)(i)||(this._failedPages.add(e),this._logger.error("#loadPage()",this._layer,`Error when loading page ${e}`,i))})}_addQueuedPages(e){for(;this._pageQueue.length>0&&!e.done;){const{pageIndex:t,page:i}=this._pageQueue.shift();this._addPage(t,i),this._loadingPages.delete(t),e.madeProgress(),this.needNodeElevationRange&&this._newPages.push(t)}this._updateParentsAndLevel()}_invalidateElevationRangeForNewPages(e){if(this.needNodeElevationRange)for(;this._newPages.length>0&&!e.done;)this._nodePages.get(this._newPages.shift())?.nodes.forEach(i=>{let s=i.parent;for(;null!=s&&s!==this._rootIndex;){const r=this.getNode(s);r&&!Number.isNaN(r?.elevationRangeMin)&&(r.invalidateElevationRange(),this.invalidateBoundingVolumeCache(s)),s=this.getParentIndex(s)}})}_addPage(e,t){const i=[],s=[],r=t.nodes.map((a,d)=>{const h=i.length,m=a.children?a.children.length:0;s.push(this._rootIndex);for(let R=0;R<m;R++)i.push(a.children[R]);const x=`${a.index}`,u=Be.Oo.fromJSON(a.obb),p=(0,w.k)(u.center,u.radius),N=a.mesh?.attribute,D=a.mesh?.geometry,C=a.mesh?.material,U={hasSharedResource:!1,isEmpty:null==D,attributes:null!=N?.resource?`${N.resource}`:void 0,geometry:null!=D?.resource?`${D.resource}`:void 0,texture:null!=C?.resource?`${C.resource}`:void 0,geometryDefinition:D?D.definition:-1,materialDefinition:C?C.definition:-1},V=new K.NB(x,et(d,e,this._pageSize),p,m,0,U,this._lastUpdate,this._lodMetric,this._lodConversion(a.lodThreshold),D?D.featureCount:null);return V.serviceObbInIndexSR=u,V.visibilityObbInRenderSR=this._computeVisibilityObb(V),V.vertexCount=D?D.vertexCount:0,new at(h,m,Xe(this._visibilityCacheVersion),null,V)}),o=new lt(r,i);-1===e?this._clientNodePage=o:this._nodePages.set(e,o)}_updateParentsAndLevel(){const e=new Array,t=(i,s,r)=>{const o=this._getPage(i);if(null!=o){const a=Se(i,this._pageSize),d=o.nodes[a];d.parent=s??-1;const h=d.node;null!=h&&(h.level=r,e.push(i))}};for(t(this._rootIndex,null,0);e.length;){const i=e.pop(),s=this.getNode(i);if(null!=s)for(let r=0;r<s.childCount;r++)t(this.getChildIndex(s.index,r),i,s.level+1),this._maxLevel=Math.max(this._maxLevel,s.level+1)}}_getPage(e){const t=Le(e,this._pageSize);return this._getPageFromPageIndex(t)}_getPageFromPageIndex(e){return e<0?this._clientNodePage:this._nodePages.get(e)}_getNodeInternal(e){const t=this._getPage(e);return null==t?null:(t.lastTraversed=this._frameNumber,t.nodes[Se(e,this._pageSize)])}_addNode(e,t){e.children&&this.populateChildren(t,e.children);const i=this.getParent(t),s=null!=i?i.level+1:0;this._maxLevel=Math.max(this._maxLevel,e.children?s+1:s);const{lodMetric:r,maxError:o}=function Wt(n){if(n)for(let e=0;e<n.length;e++)for(const t of Gt)if(t[0]===n[e].metricType)return{lodMetric:t[1],maxError:n[e].maxError};return{lodMetric:K.w5.None,maxError:0}}(e.lodSelection),a=this._getNodeInternal(t),d=new K.NB(e.id,t,e.mbs,a.childCount,s,e.resources,e.version,r,o,e.numFeatures);a.node=d,e.obb&&(d.serviceObbInIndexSR=Be.Oo.fromJSON(e.obb)),d.visibilityObbInRenderSR=this._computeVisibilityObb(d);const h=a.ref;return null!=h&&(null==h.serviceMbsInIndexSR&&(h.serviceMbsInIndexSR=e.mbs),d.shareServiceBVsInRenderSRWith(h),h.visibilityObbInRenderSR=d.visibilityObbInRenderSR),d}_makeRefNode(e,t){const i=this._nodePages.get(0);if(t<-1)return this._makeClientRefNode(e,t);if(null==i)return-1;const s=i.nodes.length,r=new at(0,0,Xe(this._visibilityCacheVersion),e,null);return i.nodes.push(r),r.parent=t,e.invalidateServiceBVsInRenderSR(),s}_makeClientRefNode(e,t){const i=this._clientNodePage;if(null==i)return-1;if(t>=0)throw new Error("I3SIndex::client side nodes can not be made children of service side nodes.");const s=-(i.nodes.length+1),r=new at(0,0,Xe(this._visibilityCacheVersion),e,null);return i.nodes.push(r),r.parent=t,e.invalidateServiceBVsInRenderSR(),s}_linkChildToParentNode(e,t){const i=this._clientNodePage;if(null==i||e>=0)return;const s=Se(e,this._pageSize),r=Se(t,this._pageSize),o=i.nodes[s],a=o.childOffset;i.children.splice(o.childOffset+o.childCount,0,t),o.childCount+=1,null!=o.node&&(o.node.childCount+=1);for(const h of i.nodes)h.childOffset>a&&(h.childOffset+=1);i.nodes[r].parent=e,this._updateParentBoundingInformation(e)}_destroyClientRefNode(e,t,i){const s=this._clientNodePage;if(null==s)return;const r=this.getParentIndex(e);if(null==r)return;const o=new Set,a=new Map,d=N=>{const D=Se(N,this._pageSize),C=s.nodes[D];if(C.childCount>0)for(let V=C.childOffset;V<C.childOffset+C.childCount;++V)d(s.children[V]);const U=C.node?.id??C.ref?.id;if(null==U)throw new Error("Node has no id");t(U,N),o.add(C)};d(e);const h=s.nodes,m=s.children,x=s.nodes.map(()=>-1),u=[],p=[];for(let N=0;N<h.length;++N){const D=h[N];if(o.has(D))continue;const C=u.length,U=et(N,-1,this._pageSize),V=et(C,-1,this._pageSize);if(D.node&&(D.node.index=V),x[N]=V,u.push(D),U!==V){const R=D.node?.id??D.ref?.id;if(null==R)throw new Error("Node has no id");i(R,U,V),a.set(U,V)}}for(let N=0;N<u.length;++N){const D=et(N,-1,this._pageSize),C=u[N],U=p.length;for(let V=C.childOffset;V<C.childOffset+C.childCount;++V){const R=m[V];if(R>=0)p.push(R);else{const ee=Se(R,this._pageSize),de=h[ee];if(o.has(de))continue;p.push(x[ee]),de.parent=D}}C.childOffset=U,C.childCount=p.length-U,C.node&&(C.node.childCount=C.childCount)}s.nodes=u,s.children=p,this._updateParentBoundingInformation(x[Se(r,this._pageSize)])}_updateParentBoundingInformation(e){let t=e;do{let i=null;const s=this._clientNodeLoader.indexSR,r=this._clientNodeLoader.renderSR,o=this._getNodeInternal(t);if(null==o)return;for(let d=0;d<o.childCount;d++){const h=this.getChildIndex(t,d),m=this._getNodeInternal(h),x=null!=m?m.ref||m.node:null;if(null!=x&&x.serviceMbsInIndexSR[3]>0)if(null==i)i=(0,w.a)(x.serviceMbsInIndexSR,Ht);else{const u=Kt,p=zt,N=$t;(0,v.s)(x.serviceMbsInIndexSR,s,u,r),(0,v.s)(i,s,p,r),(0,w.u)(u,p,N),(0,v.s)(N,r,i,s)}}const a=o.ref||o.node;null!=a&&(null!=i?(a.serviceMbsInIndexSR??=(0,w.c)(),(0,w.a)(i,a.serviceMbsInIndexSR)):(0,Ee.WD)(a.serviceMbsInIndexSR),a.invalidateServiceBVsInRenderSR(),a.geometryObbInRenderSR=null),this.invalidateNodeVisibilityCacheInternal(o),t=this.getParentIndex(t)}while(null!=t)}populateChildren(e,t){const i=this._getNodeInternal(e),s=this._getPage(e);i.childOffset=s.children.length,i.childCount=t.length;for(let r=0;r<t.length;r++){const o=this._makeRefNode(t[r],e);s.children.push(o)}}getNode(e){const t=this._getNodeInternal(e);return null!=t?t.node:null}getIndexById(e){let t;return this._forAllNodes((i,s)=>{(null!=i.node&&i.node.id===e||null!=i.ref&&i.ref.id===e)&&(t=s)}),t}getNodeById(e){const t=this.getIndexById(e);return null!=t&&t>=0?this.getNode(t):null}getChildIndex(e,t){const i=this._getPage(e);if(null==i)return-1;const s=i.nodes[Se(e,this._pageSize)];return i.children[s.childOffset+t]}getParentIndex(e){const t=this._getPage(e);return null!=t&&e!==this._rootIndex?t.nodes[Se(e,this._pageSize)].parent:null}getParent(e){const t=this.getParentIndex(e);return null!=t?this.getNode(t):null}isLeaf(e){const t=this._getNodeInternal(e);return null!=t&&0===t.childCount}get rootNode(){return this.getNode(this._rootIndex)}get isEditable(){return this._isEditable}removeAllGeometryObbs(){this._forAllNodes(e=>{null!=e.node&&(e.node.geometryObbInRenderSR=null)})}invalidateVisibilityCache(){this._visibilityCacheVersion=Ke(this._visibilityCacheVersion)}invalidateNodeVisibilityCache(e){const t=this._getNodeInternal(e);null!=t&&this.invalidateNodeVisibilityCacheInternal(t)}invalidateNodeVisibilityCacheInternal(e){e.visibilityCache=Xe(this._visibilityCacheVersion)}invalidateBoundingVolumeCache(e){const t=this._getNodeInternal(e);null!=t&&(yt(t),this.invalidateNodeVisibilityCacheInternal(t))}updateElevationChanged(e){const t=this._getNodeInternal(e);null!=t&&(this.needNodeElevationRange?(null!=t.node?t.node:t.ref)?.invalidateElevationRange():this.invalidateBoundingVolumeCache(e))}invalidateGeometryVisibility(e){const i=this._getNodeInternal(e)?.node;i&&(i.geometryObbInRenderSR=null,i.invalidateServiceBVsInRenderSR())}invalidateVisibilityObbs(){null!=this.rootNode&&this.traverse(this.rootNode,e=>(e.visibilityObbInRenderSR=this._computeVisibilityObb(e),e.geometryObbInRenderSR=null,!0))}_updateElevationRange(e){this._updateElevationRangeInternal(e,null)}_updateElevationRangeInternal(e,t){const i=this._getNodeInternal(e);if(!i)return!1;const s=i?.node??i?.ref;if(!s)return!1;if(s.elevationRangeValid)return t?.expandElevationRange(s),!0;const r=new Vt.r;let o=!1;for(let h=0;h<i.childCount;h++){const m=this.getChildIndex(e,h),x=this._updateElevationRangeInternal(m,r);o=o||!x}return(0===i.childCount||o)&&this._viewportQueries.expandElevationRange(s,!i.node?.resources.isEmpty,r),s.elevationRangeMin===r.elevationRangeMin&&s.elevationRangeMax===r.elevationRangeMax?(t?.expandElevationRange(s),!0):(i.node?.setElevationRange(r),i.ref?.setElevationRange(r),this.invalidateBoundingVolumeCache(e),t?.expandElevationRange(s),!0)}isNodeVisible(e){const t=this._getNodeInternal(e);if(null==t)return!0;const i=t.ref;if(null!=i&&!i.serviceMbsInIndexSR)return!0;if(!this.needNodeElevationRange&&qe(t.visibilityCache,this._visibilityCacheVersion))return dt(t.visibilityCache);const s=t.node,r=this._viewportQueries;if(s&&s.level>0&&(r.ensureElevationAgnosticBoundingVolume(s,this.viewingMode),!r.isElevationAgnosticBoundingVolumeVisible(this.viewingMode,s.elevationAgnosticBoundingVolume)))return t.visibilityCache=ke(!1,this._visibilityCacheVersion),!1;if(this.needNodeElevationRange&&this._updateElevationRange(e),!qe(t.visibilityCache,this._visibilityCacheVersion)){if(this._layerHasFilter&&this._computeNodeFiltering&&(null!=s||null!=i)&&t.filterImpact===K.U_.NotChecked){const m=null!=s?s.serviceMbsInIndexSR:null!=i?i.serviceMbsInIndexSR:null;t.filterImpact=null!=m?this._computeNodeFiltering(m):K.U_.Unmodified}const o=null!=s&&t.filterImpact===K.U_.Culled,d=!s||i&&!s.visibilityObbInRenderSR?i??null:s,h=!(null!=s&&s.imModificationImpact===K.O4.Culled)&&(!d||r.isNodeVisible(d))&&!o;return t.visibilityCache=ke(h,this._visibilityCacheVersion),h}return dt(t.visibilityCache)}isGeometryVisible(e){if(!this.isNodeVisible(e))return!1;const t=this._getNodeInternal(e);return!!(null==t?.node?.geometryObbInRenderSR||this.layerHasModifications&&t.node.imModificationImpact===K.O4.NotChecked)||this._viewportQueries.isGeometryVisible(t.node)}_traverseCoverage(e,t,i,s,r){const o=this._getPage(e);if(null==o||0===t.childCount)return;const a=t.childOffset+t.childCount,d=new Array;for(let h=t.childOffset;h<a;++h){const m=o.children[h],x=this._getNodeInternal(m);null!=x?.node&&this.isGeometryVisible(m)&&d.push(x)}s/=d.length;for(const h of d){const m=h.node.index;this._isLoaded(m)||this._isReloading(m)?(r.delta=Math.max(r.delta,i),r.coverage+=s):this._traverseCoverage(m,h,i+1,s,r)}}useNodeAsHole(e){if("off"===this.holeFilling)return!1;const t=this._getNodeInternal(e);if(null==t)return!1;if("always"===this.holeFilling)return!0;if(qe(t.useAsHole,this._version))return dt(t.useAsHole);const i={delta:0,coverage:0};this._traverseCoverage(e,t,0,1,i);const s=i.delta*i.coverage<=.5;return t.useAsHole=ke(s,this._version),s}get maxLevel(){return this._maxLevel}get dirty(){return this._dirty}destroy(){this._updates.add.prune(),this._updates.update.prune()}requestUpdate(){this._dirty=!0,this._indexMissing=1,this._version=Ke(this._version)}imModificationsChanged(e){this.layerHasModifications=e,this._forAllNodes(({node:t})=>{null!=t&&(t.imModificationImpact=K.O4.NotChecked,t.visibilityObbInRenderSR=this._computeVisibilityObb(t),t.hasModifications&&this.invalidateGeometryVisibility(t.index))}),this.invalidateVisibilityCache()}layerFilterChanged(e){this._layerHasFilter=e,this._forAllNodes(t=>{if(null!=t){t.filterImpact=K.U_.NotChecked;const i=t.node;null!=i&&this.invalidateNodeVisibilityCache(i.index)}}),this.invalidateVisibilityCache()}update(e,t,i){if(!this._dirty)return;this._pageQueue.length>0&&this._addQueuedPages(t),this._invalidateElevationRangeForNewPages(t),this._maxUnloadedPrio=Number.NEGATIVE_INFINITY,this._maxProcessingPrio=Number.NEGATIVE_INFINITY,this._missingPagesAndNodes.clear(),this._prefetchNodes.clear(),this._updates.reset(e),ye.clear();let s=!0;const r=new ht,o=new ht,a=this._imModificationUncategorized;a.clear();const d=new Set;let h=0;this.traverseVisible((u,p,N)=>{const D=Le(u,this._pageSize);if(null==p){let R=this._entryPriority(u);return R===1/0&&(R=this._entryPriority(N)),ye.set(D,Math.max(R,ye.get(D)||0)),this._loadingPages.has(D)||this._failedPages.has(D)||(this._missingPagesAndNodes.push(D),++h),void(this._maxProcessingPrio=Math.max(this._maxProcessingPrio,R))}const C=p.node;if(this._updateNodeFeatureEstimate(C,o),null==C){const R=this._entryPriority(u);return this._loadingNodes.has(u)||this._failedNodes.has(u)||(this._missingPagesAndNodes.push(u),ye.set(u,R)),void(this._maxProcessingPrio=Math.max(this._maxProcessingPrio,R))}const U=this._getPage(u);if(0===this._missingPagesAndNodes.length&&!this._useNodePages)for(let R=0;R<p.childCount;R++){const ee=U.children[p.childOffset+R],de=this._getNodeInternal(ee);null==de||de.node||this._loadingNodes.has(ee)||this._failedNodes.has(ee)||(ye.set(ee,this._entryPriority(ee)),this._prefetchNodes.push(ee))}if(C.failed||C.resources.isEmpty)return void(s&&p.childCount>0&&this._isSelected(C)&&(s=!1));if(this._isLoaded(u)){if(r.known+=C.memory,++r.knownNodes,this._isSelected(C)?p.childCount>0&&(s=!1):(r.unremoved+=C.memory,s=!1),this._needsUpdate(C)){const R=this._entryPriority(u);ye.set(u,R),this._maxProcessingPrio=Math.max(this._maxProcessingPrio,R),this._updates.update.push(u)}return}if(C.memory&&(r.known+=C.memory,++r.knownNodes),!this._isSelected(C))return void(this._isReloading(u)&&this._updates.remove.push(u));if(p.childCount>0&&(s=!1),C.memory?(r.missing+=C.memory,r.known+=C.memory,++r.knownNodes):++r.missingNodes,e.includes(C.index))return this._maxProcessingPrio=Math.max(this._maxProcessingPrio,this._entryPriority(u)),void(this._updates.cancel=this._updates.cancel.filter(R=>R!==C.index));if(!t.done&&this._enable(C))return void t.madeProgress();const V=this._entryPriority(u);ye.set(u,V),this._maxProcessingPrio=Math.max(this._maxProcessingPrio,V),this._updates.add.push(u),this.layerHasModifications&&i&&null!=C&&C.imModificationImpact===K.O4.NotChecked&&a.push(u)},d),this._frameNumber++,this._missingPagesAndNodes.sort((u,p)=>u-p),this._missingPagesAndNodes.filterInPlace((u,p)=>p<1||this._missingPagesAndNodes.data[p-1]!==u),this._missingPagesAndNodes.sort((u,p)=>ye.get(u)-ye.get(p)),this._missingPagesAndNodes.length>0&&(this._maxUnloadedPrio=ye.get(this._missingPagesAndNodes.back()),this._prefetchNodes.clear()),this._removeUnusedNodePages(d,h);const x=this._updates.add;x.length>0&&this.layerHasModifications&&(a.length>0&&i?.(a),x.filterInPlace(u=>{const p=this._getNodeInternal(u),N=null==p?.node||p.node.imModificationImpact!==K.O4.Culled;return N||this.invalidateNodeVisibilityCache(u),N})),this._unloadedMemoryEstimate=r.missing-r.unremoved,r.knownNodes>3&&r.missingNodes>0&&(this._unloadedMemoryEstimate+=r.known/r.knownNodes*r.missingNodes),this._unloadedMemoryEstimate=.8*Math.max(0,this._unloadedMemoryEstimate),this._featureEstimate.estimate=this._computeFeatureEstimate(o),this._featureEstimate.leavesReached=s,this._updates.add.filterInPlace(u=>ye.get(u)>=this._maxUnloadedPrio).sort((u,p)=>ye.get(u)-ye.get(p)),this._updates.update.sort((u,p)=>ye.get(u)-ye.get(p)),this._indexMissing=this._loadingPages.size+this._loadingNodes.size+this._missingPagesAndNodes.length,this._dirty=this._indexMissing>0,ye.clear()}checkFeatureTarget(e,t){const i=this._viewportQueries.updateScreenSpaceErrorBias(t);let s=t,r=t,o=i,a=10;for(;a--;){const d=new ht;if(this._updateFeatureEstimate(s,d),this._computeFeatureEstimate(d)<=e){if(s>=t||d.missingNodes>0||0===a)break;o=s,s=.5*(s+r)}else r=s,s=.5*(s+o)}return this._version=Ke(this._version),this._viewportQueries.updateScreenSpaceErrorBias(i),Math.min(t,s)}_removeUnusedNodePages(e,t){if(!this._useNodePages)return;const s=this._nodePages,r=s.size+this._loadingPages.size+t;if(r>bt&&r>e.size){const o=new Array;for(const[a,d]of s)0!==d.numNodesWithLoadedChildren||e.has(a)||o.push([d.lastTraversed,a]);o.sort((a,d)=>a[0]-d[0]).some(a=>(this._deleteNodePage(a[1]),s.size<=bt))}}_updateFeatureEstimate(e,t){this._version=Ke(this._version),this._viewportQueries.updateScreenSpaceErrorBias(e),this.traverseVisible((i,s)=>this._updateNodeFeatureEstimate(s?.node,t))}_updateNodeFeatureEstimate(e,t){null==e||e.failed||null==e.numFeatures||this._isSelected(e)&&(null!=e.numFeatures?(t.missing+=e.numFeatures,t.known+=e.numFeatures,++t.knownNodes):++t.missingNodes)}_computeFeatureEstimate(e){let t=e.known-e.unremoved;return e.knownNodes>3&&e.missingNodes>0&&(t+=e.known/e.knownNodes*e.missingNodes),Math.max(0,t)}load(){return this._load(this._missingPagesAndNodes)}prefetch(){return this._prefetchNodes.sort((e,t)=>ye.get(e)-ye.get(t)),this._load(this._prefetchNodes)}_load(e){if(0===e.length||!this._canRequest())return!1;for(;e.length>0&&this._canRequest();){const t=e.pop();this._useNodePages&&t>=0?this._loadPage(t):this._loadNode(t)}return!0}get isLoading(){return this._indexMissing>0}get isPrefetching(){return this._prefetchNodes.length>0}get indexLoading(){return this._loadingPages.size+this._loadingNodes.size}get indexMissing(){return this._indexMissing}get unloadedMemoryEstimate(){return this._unloadedMemoryEstimate}get updates(){return this._updates}get featureEstimate(){return this._featureEstimate}get maxPriority(){return Math.max(this._maxProcessingPrio,this._maxUnloadedPrio)}nodeTraversalState(e){if(null==e)return null;const t=e.index,i=this._getNodeInternal(t);if(!i)return null;let s=i?.traversalState;if(s&&qe(s.version,this._version))return s;const r=this._viewportQueries.getLodLevel(e),o=this._viewportQueries.hasLOD(e);let a=!0;if(o){const d=this.getParentIndex(t);if(null!=d){const m=this._getNodeInternal(d)?.traversalState;a=!!m&&r>m.lodLevel}else a=r>0}else a=0===e.childCount;return s?(s.lodLevel=r,s.isChosen=a,s.version=ke(!0,this._version),s):(s=new K.oQ(o,a,r,ke(!0,this._version)),i.traversalState=s,s)}_loadNode(e){var t=this;return(0,E.Z)(function*(){t._loadingNodes.add(e);const i=t._getNodeInternal(e).ref;if(null==i)return void t._failedNodes.add(e);const s=i.id,r=t._urlPrefix+s,o=()=>{t._loadingNodes.delete(e),0===t._missingPagesAndNodes.length&&0===t._loadingNodes.size&&t.requestUpdate()};let a=null;try{a=e>=0?yield t._streamDataController.request(r,"json"):yield t._clientNodeLoader.loadNodeJSON(s)}catch(m){return o(),void((0,ie.D_)(m)||(t._logger.error("#loadNode()",t._layer,"Error loading node: "+r),t._failedNodes.add(e)))}o();const d=t._validateNode(s,a);if(null==d)return;d.obb&&t.invalidateNodeVisibilityCache(e);const h=t._addNode(d,e);t.nodeTraversalState(h)})()}_validateNode(e,t){if(null==t||"object"!=typeof t||t.id!==e)return this._logger.error("#validateNode()",this._layer,`Invalid node. Wrong type or wrong id "${e}"`),null;if(!Array.isArray(t.mbs))return this._logger.error("#validateNode()",this._layer,`Invalid bounding volume on node ${e}.`),null;t.sharedResource&&"./shared"!==t.sharedResource.href&&"./shared/"!==t.sharedResource.href&&this._logger.warn("#validateNode()",this._layer,`Invalid shared resource href on node "${e}"`);const i=t.geometryData;null==i||Array.isArray(i)&&0===i.length||Array.isArray(i)&&1===i.length&&"./geometries/0"===i[0].href||this._logger.warn("#validateNode()",this._layer,`Invalid geometry data on node "${e}"`);const s=t.attributeData,r=this._layer.attributeStorageInfo;null==s||Array.isArray(s)&&!s.some((u,p)=>u.href!==`./attributes/${r?.[p]?.key??`f_${p}`}/0`)||this._logger.warn("#validateNode()",this._layer,`Invalid attribute data on node "${e}"`),t.featureData&&t.featureData.length>1&&this._logger.warn("#validateNode()",this._layer,`Node ${e} has ${t.featureData.length} bundles. Only the first bundle will be loaded.`);const o=t.hasOwnProperty("obb")&&!this.ignoreServiceObb?t.obb:void 0,a=t.featureData&&1===t.featureData.length&&t.featureData[0].featureRange?t.featureData[0].featureRange[1]-t.featureData[0].featureRange[0]+1:void 0,h=Array.isArray(t.children)?t.children.map(u=>{if(null==u)return null;const p=D=>this._logger.error("#validateNode()",this._layer,`Invalid node reference on node ${e}: ${D}`);if("number"==typeof u.id)p(`id ${u.id} is a number instead of a string.`);else if("string"!=typeof u.id||!Array.isArray(u.mbs))return p("Missing or invalid id."),null;if(!Array.isArray(u.mbs))return p(`Invalid bounding volume on reference ${u.id}.`),null;u.href&&u.href!=="../"+u.id&&this._logger.error("#validateNode()",this._layer,`Invalid node href on node "${e}"`);const N=new K.$i(`${u.id}`,u.mbs);return N.serviceObbInIndexSR=!this.ignoreServiceObb&&u.hasOwnProperty("obb")&&u.obb?Be.Oo.fromJSON(u.obb):null,N.visibilityObbInRenderSR=this._computeVisibilityObb(N),N}).filter(u=>null!=u):null;return new Ut(e,t.mbs,o,"string"==typeof t.version?t.version:null,{isEmpty:!t.featureData?.length&&!0===t.isEmpty,hasSharedResource:null!=t.sharedResource,attributes:t.attributeData?e:void 0,texture:t.textureData&&t.textureData.length>0?e:void 0,geometry:null!=t.geometryData?e:void 0},h,Array.isArray(t.lodSelection)?t.lodSelection:null,a)}resetFailedNodes(){this._failedNodes.clear(),this._failedPages.clear(),this._forAllNodes(e=>{null!=e.node&&(e.node.failed=!1)})}_entryPriority(e){const t=this._getNodeInternal(e),i=this.getParentIndex(e);if(null==t||null==i&&null==t.node)return null==i?1/0:this._entryPriority(i);let s=0;if(t.node&&null!=i){const a=this._getNodeInternal(i).traversalState;null!=a&&(s=a.lodLevel)}let r=this.progressiveLoadPenalty;for(let a=e;null!=a;a=this.getParentIndex(a))if(this._isLoaded(a)){r=0;break}const o=null!=t.ref?this._viewportQueries.distToPOI(t.ref):null!=t.node?this._viewportQueries.distToPOI(t.node):0;return-o-s*(o+this.progressiveLoadPenalty)+r}traverseVisible(e,t){const i=this._getNodeInternal(this._rootIndex);null!=i?this._traverseVisible(this._rootIndex,null,i,e,t):e(this._rootIndex,null,null)}_traverseVisible(e,t,i,s,r){const o=Le(e,this._pageSize);if(r&&r.add(o),i.node&&0===i.childCount)return void(this.isGeometryVisible(e)&&s(e,i,t));if(!this.isNodeVisible(e)||(s(e,i,t),null==i.node))return;const a=this.nodeTraversalState(i.node);if(a?.nodeHasLOD&&a.lodLevel===this._maxLodLevel)return;const d=this._getPageFromPageIndex(o);for(let h=0;h<i.childCount;h++){const m=d.children[i.childOffset+h],x=this._getNodeInternal(m);if(x)this._traverseVisible(m,e,x,s,r);else{if(r){const u=Le(m,this._pageSize);r.add(u)}s(m,null,e)}}}traverse(e,t){t(e)&&this.traverseDescendants(e,t)}traverseDescendants(e,t){++this._traverseDescendantsNestingLevel;const i=e.index,s=this._pageSize,r=Le(i,s),o=this._getPageFromPageIndex(r);if(null==o)return;const a=this._frameNumber,d=this._nodePages;o.lastTraversed=a;const h=Se(i,s),m=o.nodes[h],{childCount:x}=m;if(0===x)return;const u=1===this._traverseDescendantsNestingLevel?this._traverseDescendantsQueue:[0];let p=0;const N=[];{const{childOffset:D,childCount:C}=m,{children:U}=o;u.length=2**Math.ceil(Math.log2(p+C));for(let V=D;V<D+C;++V){const R=U[V];R>=0?(u[p]=R,++p):N.push(R)}}if(N.length>0){const D=this._clientNodePage;if(D){const C=D.children;let U=0;for(;U<N.length;){const V=N[U];++U;const ee=D.nodes[-V-1],de=ee.node;if(!de||!t(de))continue;const{childCount:me}=ee;if(0===me)continue;const{childOffset:pe}=ee,be=pe+me;for(let Ce=pe;Ce<be;++Ce)N.push(C[Ce])}}}if(p>0){let D=0;if(s>0){let C=r*s,U=o,V=U.nodes;for(;D<p;){const R=u[D];let ee;if(++D,C<=R&&R<C+s)ee=U;else{const Oe=R/s|0,Ae=d.get(Oe);if(void 0===Ae)continue;ee=Ae,ee.lastTraversed=a,U=ee,V=U.nodes,C=s*Oe}const de=V[R-C],me=de.node;if(null==me||!1===t(me))continue;const{childCount:pe}=de;if(0===pe)continue;for(u.length<p+pe&&(u.length=2**Math.ceil(Math.log2(p+pe)));u.length<p+pe;)u.length+=u.length;const Ce=ee.children,{childOffset:Fe}=de,Ue=Fe+pe;for(let Oe=Fe;Oe<Ue;++Oe)u[p]=Ce[Oe],++p}}else{const C=d.get(0);if(C)for(;D<p;){const U=u[D];++D;const V=C.nodes[U],R=V.node;if(!R||!t(R))continue;const{childCount:ee}=V;if(0===ee)continue;u.length=Math.max(u.length,2**Math.ceil(Math.log2(p+ee)));const de=C.children,{childOffset:me}=V,pe=me+ee;for(let be=me;be<pe;++be)u[p]=de[be],++p}}}--this._traverseDescendantsNestingLevel}updateChildrenLoaded(e,t){let i=this.getNode(e);for(;null!=i;){const s=i.childrenLoaded,r=s+t;i.childrenLoaded=r;const o=0===s?1:0===r?-1:0,a=i.index;0!==o&&(this._getPage(a).numNodesWithLoadedChildren+=o),i=this.getParent(a)}}checkChildrenLoadedInvariant(){if(null==this.rootNode)return!0;const e=[],t=i=>{let s=this._isLoaded(i.index)||this._isReloading(i.index)?1:0;return this.traverseDescendants(i,r=>(s+=t(r),!1)),i.childrenLoaded!==s&&e.push(i.index),s};return t(this.rootNode),e.length&&this._logger.error("childrenLoaded invariant broken at following nodes: "+e.join(",")),e.length>0}updateElevationInfo(e,t){this.needNodeElevationRange=t&&!!e&&("relative-to-ground"===e.mode||"on-the-ground"===e.mode),this._viewportQueries.updateElevationInfo(e),this.invalidateAllElevationRanges()}invalidateAllElevationRanges(){this._forAllNodes(e=>{yt(e),null!=e.node&&e.node.invalidateElevationRange(),null!=e.ref&&e.ref.invalidateElevationRange()})}_forAllNodes(e){if(null!=this._clientNodePage){const t=this._clientNodePage;for(let i=0;i<t.nodes.length;i++)e(t.nodes[i],-(i+1))}for(const[t,i]of this._nodePages){const s=t*this._pageSize;for(let r=0;r<i.nodes.length;r++)e(i.nodes[r],s+r)}}clearCaches(){if(this._useNodePages){const e=this._nodePages,t=new Set;this.traverseVisible(i=>t.add(Le(i,this._pageSize)));for(const[i,s]of e)if(0!==s.numNodesWithLoadedChildren||t.has(i))for(const r of s.nodes)r.traversalState=null;else this._deleteNodePage(i)}}_deleteNodePage(e){this._nodePages.delete(e)}get test(){return{addNode:(e,t)=>this._addNode(this._validateNode(e.id,e),t),getNodeInternal:e=>this._getNodeInternal(e),getPageIndex:e=>Le(e,this._pageSize),getIndexWithinPage:e=>Se(e,this._pageSize),getNodePage:e=>e<0?this._clientNodePage:this._nodePages.get(e),getChildIndices:e=>{const t=this._getNodeInternal(e),i=this._getPage(e);if(null==t||null==i)return[];const s=[];for(let r=t.childOffset;r<t.childOffset+t.childCount;++r)s.push(i.children[r]);return s},rootIndex:this._rootIndex,clientNodePage:this._clientNodePage,nodePages:this._nodePages}}}const ye=new Map;class Bt{constructor(e){this.missing=e,this.update=new Q.Z({deallocator:null}),this.add=new Q.Z({deallocator:null}),this.remove=new Q.Z({deallocator:null}),this.cancel=[]}reset(e){this.add.clear(),this.update.clear(),this.cancel=e}}function yt(n){n.node?.invalidateServiceBVsInRenderSR(),n.ref?.invalidateServiceBVsInRenderSR()}function Xe(n){return(0,Ee.HV)(n,-2)}function Ke(n){return(0,Ee.HV)(n,2)}function ke(n,e){return e+(n?1:0)}function qe(n,e){return(-2&n)===e}function dt(n){return 1==(1&n)}function Le(n,e){return n<0?-1:e>0?n/e|0:0}function Se(n,e){return n<0?-n-1:0===e?n:n%e}function et(n,e,t){return-1===e?-(n+1):0===t?n:e*t+n}const Gt=[["maxScreenThreshold",K.w5.MaxScreenThreshold],["screenSpaceRelative",K.w5.ScreenSpaceRelative],["removedFeatureDiameter",K.w5.RemovedFeatureDiameter],["distanceRangeFromDefaultCamera",K.w5.DistanceRangeFromDefaultCamera]];class ht{constructor(){this.known=0,this.knownNodes=0,this.missing=0,this.missingNodes=0,this.unremoved=0}}function Zt(n){return Math.sqrt(n*(4/Math.PI))}const Ht=(0,w.c)(),Kt=(0,w.c)(),zt=(0,w.c)(),$t=(0,w.c)(),bt=(0,he.Z)("esri-mobile")?100:300;var ut=l(73683);class Qt{constructor(e){this._layerView=e,this._lodGlobalDirty=!1}startNodeLoading(e,t,i,s){this._maxLodLevel=s.maxLodLevel,this._index=i,this._isNodeInScaleBounds=e,this._removeNodes=t}shouldLoadNode(e){if(null==e)return!1;const t=this._index.nodeTraversalState(e);return!!this._isChosenMaxLOD(t)||!!t.isChosen&&this._childrenRequireLoading(e)}setLodGlobalDirty(){this._lodGlobalDirty=!0}get requiresLODGlobalHandling(){return null!=this._index&&!0===this._lodGlobalDirty}lodGlobalHandling(e){if(!this.requiresLODGlobalHandling)return!1;this._lodGlobalDirty=!1;const i=Math.max(0,Math.floor(10*(this._layerView.view.resourceController.memoryController.usedMemory-1)));we.clear(),this._lodGlobalHandling(this._index.rootNode,i,!1,!!this._layerView.nodeCrossfadingEnabled);const s=we.length;this._removeNodes(we,e);const r=we.length<s;return 0!==we.length&&(this._lodGlobalDirty=!0),we.clear(),r}_lodGlobalHandling(e,t,i,s){if(null==e)return!1;const r=e.index,o=this._index,a=this._layerView,d=o.nodeTraversalState(e),h=this._isChosenMaxLOD(d);if(h&&e.resources.isEmpty)return e.childrenLoaded>0&&this._removeChildrenRecursive(e),!0;const x=a.isNodeLoaded(r);if(s&&x&&h){const U=!i&&this.hasNoVisibleChildren(e);a.fadeNode(r,ut.B.FadeIn,!U)}const u=x&&(!a.isNodeFullyFadedIn||a.isNodeFullyFadedIn(r));if(x&&(a.updateNodeState(r,h?K.FE.Leaf:K.FE.Hole),h))return u&&this._removeChildrenRecursive(e),u;const p=e.childCount>0;let N=p;if(p)for(let U=0;U<e.childCount;U++){const V=o.getChildIndex(r,U),R=o.getNode(V);null!=R?o.isGeometryVisible(V)&&!this._lodGlobalHandling(R,t,i||u,s)&&this._isNodeInScaleBounds(R)&&(N=!1):o.isNodeVisible(V)&&(N=!1)}const D=x&&!h&&(N||we.length<t);return D&&we.push(r),!s||D||!x||i||N||a.fadeNode(r,ut.B.FadeIn,!1),N||u&&!D||e.resources.isEmpty}_removeChildrenRecursive(e){this._index.traverseDescendants(e,t=>((this._layerView.isNodeLoaded(t.index)||this._layerView.isNodeReloading(t.index))&&we.push(t.index),t.childrenLoaded>0))}hasNoVisibleChildren(e){let t=!0;return this._index.traverseDescendants(e,i=>!(!t||!this._index.isNodeVisible(i.index))&&(this._layerView.isNodeLoaded(i.index)?(t=!1,!1):i.childrenLoaded>0)),t}_childrenRequireLoading(e){let t=!1,i=!0;return this._index.traverseDescendants(e,s=>{if(!i||!this._index.isNodeVisible(s.index))return!1;const r=this._index.nodeTraversalState(s);return this._isChosenMaxLOD(r)&&this._index.isGeometryVisible(s.index)&&(t=!0),this._layerView.isNodeLoaded(s.index)?(i=!1,!1):s.childrenLoaded>0}),i&&t}_isChosenMaxLOD(e){return e.isChosen&&(!e.nodeHasLOD||e.lodLevel===this._maxLodLevel)}}const we=new Q.Z({deallocator:null});var ze=l(59213),kt=l(58817),xt=l(21726),Ct=l(92852),ct=l(42767);class tt{constructor(e,t,i,s,r,o){if(this._streamDataController=t,this._logger=i,this._defaultGeometrySchema=s,this._requiredAttributes=r,this._options=o,this._logLayer=e,this._layerUrl=e.parsedUrl.path,this._geometryDefinitions=e.geometryDefinitions,e.materialDefinitions){const a=e.textureSetDefinitions;this._materialAndTextures=e.materialDefinitions.map(d=>(0,ct.R0)(a,d,"integrated-mesh"===e.type))}}_load(e,t,i){return this._streamDataController.request(e,t,i)}_loadAttribute(e,t,i){return this._load(`${this._layerUrl}/nodes/${e.resources.attributes}/attributes/${t.key}/0`,"binary",i).then(r=>(0,Ct.qM)(t,r))}loadAttributes(e,t,i){var s=this;return(0,E.Z)(function*(){const r=yield Promise.allSettled(t.map(a=>s._loadAttribute(e,a.attributeStorageInfo,i))),o={};for(let a=0;a<t.length;++a){const d=r[a],h=t[a];if("fulfilled"===d.status)o[h.name]=d.value;else{const m=d.reason;(0,ie.r9)(m),s._logger.error("#loadAttributes",s._logLayer,`Failed to load attributeData for '${h.name}' on node '${e.id}'`,m)}}return o})()}loadNodeData(e,t){var i=this;return(0,E.Z)(function*(){const s=null!=i._requiredAttributes&&e.resources.attributes?(0,ze.q6)(i.loadAttributes(e,i._requiredAttributes,t)):null,{bufferDefinition:r,bufferIndex:o}=function ei(n,e){const t={bufferDefinition:null,bufferIndex:0},i=e.resources.geometryDefinition;if(null==n||null==i||i<0)return t;const s=i>=0?n[i].geometryBuffers:null;if(null==s)return t;for(let r=0;r<s.length;r++){const o=s[r];if(null==o.compressedAttributes)t.bufferIndex=r,t.bufferDefinition=s[r];else if("draco"===o.compressedAttributes.encoding&&!(0,he.Z)("disable-feature:i3s-draco"))return t.bufferIndex=r,t.bufferDefinition=o,t}return t}(i._geometryDefinitions,e),a=!!e.resources.geometry,d=a?(0,ze.q6)(i._loadGeometry(e.resources.geometry,o,t)):null,h=e.resources.hasSharedResource?yield i._loadShared(e,t):null,m=e.resources.materialDefinition,x=i._materialAndTextures&&null!=m&&m>=0?i._materialAndTextures[m]:null!=h?(0,ct.Pg)(h):null,u=x?.material,p=x?.textures??[],N=`${e.id}`,D=!a&&i._options.loadFeatureData,C=D?yield i._loadFeatureData(N,t):null,U=D?function Yt(n){if(!n)return null;for(const e of n.featureData){const t=e.geometries;if(null!=t)for(const i of t)return{featureIds:[e.id],featureDataPosition:e.position,geometries:[i]}}return null}(C):function Jt(n){return{featureIds:[],geometries:[{type:"ArrayBufferView",params:{material:n}}],featureDataPosition:[0,0,0]}}(u),V=null==U?function Xt(n){if(!n)return null;const e=new Array;for(const t of n.featureData)null!=t.position&&e.push({featureIds:[t.id],featureDataPosition:t.position,geometries:[]});return e}(C):null,R=p.length>0?(0,ze.q6)(i.loadTextures(e,p,t)):null;let ee=null,de=null;if(d){ee=(0,ze.w6)(yield d);const Ce=function qt(n,e){if(!n||!e?.materialDefinitions)return n;const t=Object.keys(e.materialDefinitions)[0];return!e.materialDefinitions[t].params.vertexRegions&&n.vertexAttributes.region&&delete(n=(0,kt.d9)(n)).vertexAttributes.region,n}(i._defaultGeometrySchema,h);de=(0,Ct.Es)(r,Ce)}const me=R?(0,ze.w6)(yield R):null,pe=s?(0,ze.w6)(yield s):{},be=pe?{attributeData:pe,loadedAttributes:i._requiredAttributes}:null;if(null!=U)return{geometryData:U,attributeDataInfo:be,geometryBuffer:ee,geometryDescriptor:de,requiredTextures:p,textureData:me};if(null!=V)return{pointData:V,attributeDataInfo:be,geometryBuffer:ee,geometryDescriptor:de,requiredTextures:p,textureData:me};throw new Error})()}static _addAbsoluteHrefTexture(e,t){const i=e.textureDefinitions;if(null!=i)for(const s of Object.keys(i))for(const r of i[s].images)r.hrefConcat=Array.isArray(r.href)?r.href.map(o=>(0,xt.hF)(o,t)):(0,xt.hF)(r.href,t)}static _fixTextureEncodings(e){const t=e.textureDefinitions;if(null!=t)for(const i in t){const s=t[i];if(Array.isArray(s.encoding))for(let r=0;r<s.encoding.length;r++){const o=s.encoding[r];"data:"===o.substring(0,5)&&(s.encoding[r]=o.substring(5))}else{const r=s.encoding;"data:"===r.substring(0,5)&&(s.encoding=r.substring(5))}}}_loadShared(e,t){var i=this;return(0,E.Z)(function*(){if(null==e.resources.geometry)return{};const s=`${i._layerUrl}/nodes/${e.resources.geometry}/shared`,r=yield i._load(s,"json",t);return tt._fixTextureEncodings(r),tt._addAbsoluteHrefTexture(r,s),r})()}_loadTexture(e,t,i,s,r,o){let a=!1;return r===L.j.DDS_S3TC||r===L.j.KTX2||r===L.j.Basis?this._load(e,"binary",o).then(d=>({id:t,usage:i,data:d,encoding:r,downsampled:a})):this._load(e,"image",o).then(d=>{let h=d;if(s&&d.width*d.height>=4096){const u=Math.ceil(d.width/2),p=Math.ceil(d.height/2),N=document.createElement("canvas");N.width=u,N.height=p,N.getContext("2d").drawImage(d,0,0,u,p),h=N,a=!0}return{id:t,usage:i,data:h,encoding:r,downsampled:a}})}loadTextures(e,t,i){const s=!!this._options.uncompressedTextureDownsamplingEnabled,r=this._options.textureUsageMask;return Promise.all(t.map(o=>{if(!(o.usage&r))return null;const a=(0,ct.nn)(o.encodings,this._options.textureEncodings);return null==a?(this._logger.error("#loadTextures",this._logLayer,`No known encoding for texture found on node ${e.id}`),Promise.reject()):this._loadTexture(`${this._layerUrl}/nodes/${e.resources.texture||e.id}/textures/${a.name}`,o.id,o.usage,s,a.encoding,i)}))}_loadFeatureData(e,t){return this._load(`${this._layerUrl}/nodes/${e}/features/0`,"json",t)}_loadGeometry(e,t,i){return this._load(`${this._layerUrl}/nodes/${e}/geometries/${t}`,"binary",i)}}class It{constructor(e,t,i){this._requester=e,this._customParameters=t,this._apiKey=i,this._activeRequests=new Set}get busy(){return this._requester.busy}request(e,t,i){const s=new AbortController,r=(0,ie.$F)(i,()=>s.abort()),o={signal:s.signal,query:{...this._customParameters,token:this._apiKey}},a=this._requester.request(e,t,o),d={response:a,abortController:s,abortHandle:r};return this._activeRequests.add(d),(0,ie.Bx)(a,()=>{d.abortController=null,d.abortHandle?.remove(),d.abortHandle=null,this._activeRequests.delete(d)}),a}cancelAll(){this._activeRequests.forEach(e=>{e.abortController?.abort(),e.abortController=null,e.abortHandle?.remove()}),this._activeRequests.clear()}}var it=l(63657),ti=l(1503),ii=l(92383),Nt=l(81863),si=l(94008),st=l(8834),ni=l(37053),St=l(81468),ri=l(79112),Dt=l(74746);class oi{constructor(e,t,i,s,r,o,a,d,h={}){this._indexSR=e,this._renderCoordsHelper=t,this._clippingArea=r,this._elevationProvider=o,this._viewingMode=a,this._options=h,this._frustum=(0,st.Ue)(),this._frustumMbs=(0,ti.Ue)(),this._useFrustumCulling=!1,this._poi=(0,g.Ue)(),this._elevationContext=null,this.minDistance=1/0,this.maxDistance=0,this.maxLodLevel=2,this._tmpObb=new Be.Oo,this._tmp1=(0,g.Ue)(),this._tmp2=(0,g.Ue)(),this._tmp3=(0,g.Ue)(),this._tmp0=(0,g.Ue)(),this._screenspaceErrorBias=h.screenspaceErrorBias||1,this._progressiveLoadFactor=h.progressiveLoadFactor||1,this.updateCamera(i,s);const m=this._renderCoordsHelper.spatialReference;this._renderSR=m,this._renderSRSphericalPCPF=(0,Nt.rS)(m),this._isGlobalMode=m===this._renderSRSphericalPCPF,this.updateElevationInfo(d),this._tmpPoint=(0,B.T)(0,0,0,e),this._isECEFOBBInLocalMode=this._indexSR.isWGS84&&(m.isWebMercator||(0,ni.QM)(m)),this._indexSREllipsoidRadius=(0,ii.Iu)(this._indexSR).radius,this._indexSRSphericalPCPF=(0,Nt.rS)(e),this._projectorIndexSRToIndexSRSphericalPCPF=(0,si.R8)(this._indexSR,this._indexSRSphericalPCPF)}updateElevationInfo(e){null!=e?(this._elevationContext=ri.o.fromElevationInfo(e),this._elevationContext.updateFeatureExpressionInfoContext((0,Dt.bw)((0,Dt.WI)(e,!1)))):this._elevationContext=null}updateCamera(e,t){if(this._useFrustumCulling=t,t){(0,st.q_)(e.viewMatrix,e.projectionMatrix,this._frustum,Mt);{const i=e.eye,s=ai;(0,y.n)(s,e.viewForward);const r=li;(0,y.z)(r,Mt[4],i);const o=.5*(0,y.k)(r,r)/(0,y.k)(s,r),a=this._frustumMbs;(0,y.r)(a,i,s,o),a[3]=1+o}}this._screenSizeFactor=1/(e.perScreenPixelRatio/2),this._camPos=e.eye,this.minDistance=1/0,this.maxDistance=0}setPointOfInterest(e){this._poi=e}updateScreenSpaceErrorBias(e){const t=this._screenspaceErrorBias;return this._screenspaceErrorBias=e,t}updateClippingArea(e){this._clippingArea=e}expandElevationRange(e,t,i){if(null==this._elevationContext)return;const s=e.serviceMbsInIndexSR;if(!s)return;const r="relative-to-scene"===this._elevationContext.mode?"scene":"ground";if(this._elevationProvider.getSphereElevationBounds){const x=this._elevationProvider.getSphereElevationBounds(s,this._indexSR,r);return void(x&&i.expandElevationRange(x))}const h=this._elevationProvider.getElevation(s[0],s[1],s[2],this._indexSR,r);h&&i.expandElevationRangeValues(h,h);const m=t?null:this._elevationProvider.getRootElevationBounds?.();m&&i.expandElevationRange(m)}getServiceMbsInRenderSR(e){const t=e.serviceMbsInRenderSR;if((0,Ee.c$)(t))return t;e.serviceMbsInIndexSR&&(0,it.c)(t,e.serviceMbsInIndexSR);const i=e.elevationRangeMin;if(this._elevationContext&&Number.isFinite(i)){let s=0,r=0;const o=e.elevationRangeMax;switch(this._elevationContext.mode){case"relative-to-ground":s=this._elevationContext.geometryZWithOffset(t[2],this._renderCoordsHelper)+i-t[2],r=o-i;break;case"on-the-ground":s=i-t[2],r=o-i}t[2]+=s+.5*r,t[3]+=.5*r}else this._elevationContext&&t[3]<1e5&&(this._tmpPoint.x=t[0],this._tmpPoint.y=t[1],this._tmpPoint.z=t[2],t[2]=(0,St.w7)(this._tmpPoint,this._elevationProvider,this._elevationContext,this._renderCoordsHelper));return(0,v.s)(t,this._indexSR,t,this._renderSR),t}getAndUpdateVisibilityObbInRenderSR(e){{const r=e.visibilityObbInRenderSR;if(r)return r}const t=.01*this._indexSREllipsoidRadius,{serviceMbsInIndexSR:i,serviceObbInIndexSR:s}=e;if(null==s||!i||!s.isValid||this._isECEFOBBInLocalMode&&(s.halfSizeX>t||s.halfSizeY>t||s.halfSizeZ>t))return null;{let r=e.serviceObbInRenderSR;if(null==r)r=new Be.Oo,e.serviceObbInRenderSR=r;else if(r.isValid)return r;const o=i[3];let a=0,d=0;const h=s.centerZ,m=this._renderCoordsHelper,x=this._elevationContext;if(x&&e.elevationRangeValid){const N=e.elevationRangeMin,D=e.elevationRangeMax;switch(x.mode){case"relative-to-ground":a=x.geometryZWithOffset(h,m)+N-h,d=D-N;break;case"on-the-ground":a=N-h,d=D-N}}else if(x&&o<1e5){const N=this._tmpPoint;N.x=s.centerX,N.y=s.centerY,N.z=h,a=(0,St.w7)(N,this._elevationProvider,x,m)-h}const u=d>0,p=u?this._tmpObb:r;return s.transform(p,this._indexSR,this._renderSR,a,this._renderSRSphericalPCPF,this._indexSRSphericalPCPF,this._projectorIndexSRToIndexSRSphericalPCPF),u&&(0,Be.gI)(p,0,d,this._viewingMode,r),r}}getNodeObbInRenderSRIndependentOfElevationOffset(e){{const i=e.visibilityObbInRenderSR??e.serviceObbInRenderSR??null;if(i?.isValid)return i}const t=e.serviceObbInIndexSR;return t?(t.transform(Rt,this._indexSR,this._renderSR,void 0,this._renderSRSphericalPCPF,this._indexSRSphericalPCPF,this._projectorIndexSRToIndexSRSphericalPCPF),Rt):null}ensureElevationAgnosticBoundingVolume(e,t){-1===e.elevationAgnosticBoundingVolume[3]&&(t===ue.JY.Global?this._updateElevationAgnosticBoundingVolumeGlobal(e):this._updateElevationAgnosticBoundingVolumeLocal(e))}_updateElevationAgnosticBoundingVolumeGlobal(e){const t=this.getNodeObbInRenderSRIndependentOfElevationOffset(e),i=e.elevationAgnosticBoundingVolume,s=nt;let r=-1;if(t){t.getCenter(s),(0,y.n)(s,s),t.getCorners(rt);for(const a of rt){(0,y.n)(a,a);const d=(0,y.k)(a,s);if(d<=0)return void(i[3]=-1);const h=Math.sqrt(1-d*d);r=Math.max(r,h)}}else{const a=e.serviceMbsInRenderSR;if(!(0,Ee.c$)(a))return void(i[3]=-1);{const d=(0,y.c)(nt,(0,w.g)(a)),h=a[3],m=(0,y.H)(d);r=0===h?0:m<h?-1:h/m,(0,y.n)(d,d)}}(0,it.h)(i,s),i[3]=r+.001}_updateElevationAgnosticBoundingVolumeLocal(e){const t=e.elevationAgnosticBoundingVolume,i=this.getNodeObbInRenderSRIndependentOfElevationOffset(e);if(i){const s=i.getCenter(nt);s[2]=0,(0,it.h)(t,s);let r=0;const o=di;i.getCorners(rt);for(const a of rt){a[2]=0;const d=(0,y.w)(o,a);r=Math.max(r,d)}t[3]=Math.sqrt(r)}else{const s=e.serviceMbsInRenderSR;if((0,Ee.c$)(s)){const r=(0,y.c)(nt,(0,w.g)(s));r[2]=0,(0,it.h)(t,r),t[3]=s[3]}}}isNodeVisible(e){const t=this.getServiceMbsInRenderSR(e);if(!this._isMBSinClippingArea(t))return!1;if(!this._useFrustumCulling)return!0;const i=this.getAndUpdateVisibilityObbInRenderSR(e);return i?i.isVisible(this._frustum):(0,st.hr)(this._frustum,(0,w.w)(t))}isElevationAgnosticBoundingVolumeVisible(e,t){return!this._useFrustumCulling||-1===t[3]||(e===ue.JY.Global?this._isConeVisibleInFrustum(t):this._isCylinderVisibleInFrustum(t))}_isConeVisibleInFrustum(e){const t=this._frustumMbs,i=t,s=(0,y.H)(i),r=t[3],o=e,a=(0,y.k)(o,i),d=e[3];if(d>.9||s<=r)return!0;{const u=(0,y.h)(Et,o,a);if((0,y.o)(u,i)<r)return!0}const h=a/s;if(a<=0)return-h<r;const m=Math.sqrt(1-h*h);if(m<d)return!0;const x=r/s;return m*Math.sqrt(1-x*x)-x*h<d}_isCylinderVisibleInFrustum(e){const t=this._frustumMbs,s=t[3],r=(0,y.c)(Et,t);r[2]=0;const o=e[3];return(0,y.o)(r,e)<=o+s}isGeometryVisible(e){return!this._useFrustumCulling||(e.geometryObbInRenderSR?.isVisible(this._frustum)??this.isNodeVisible(e))}_isMBSinClippingArea(e){return null==this._clippingArea||(0,Ee.cr)(this._clippingArea,e)!==Ee.pD.OUTSIDE}_screenSpaceDiameterMbs(e,t){const i=this.getServiceMbsInRenderSR(e),s=Math.sqrt((0,y.a)((0,w.g)(i),this._camPos)),r=s-i[3];return this._updateMinMaxDistance(s),r<0?.5*Number.MAX_VALUE:t/r*this._screenSizeFactor}calcCameraDistance(e){return this.calcCameraDistanceToCenter(e)-this.getServiceMbsInRenderSR(e)[3]}calcCameraDistanceToCenter(e){const t=this.getServiceMbsInRenderSR(e),i=(0,y.q)((0,w.g)(t),this._camPos);return this._updateMinMaxDistance(i),i}calcAngleDependentLoD(e){const t=this.getServiceMbsInRenderSR(e),i=t[3],s=(Math.abs(t[0]*(t[0]-this._camPos[0])+t[1]*(t[1]-this._camPos[1])+t[2]*(t[2]-this._camPos[2]))/(0,y.l)((0,w.g)(t))+i)/(0,y.q)((0,w.g)(t),this._camPos);return Math.min(1,s)}hasLOD(e){return e.lodMetric!==K.w5.None}_getDistancePlanarMode(e,t){const i=e[0]-t[0],s=e[1]-t[1],r=e[2]-t[2],o=i*i+s*s,a=t[3];if(o<=a*a)return Math.abs(r);const d=Math.sqrt(o)-a;return Math.sqrt(r*r+d*d)}_getDistanceGlobeMode(e,t){const i=(0,y.l)((0,w.g)(t)),s=(0,y.l)(e)-i;(0,y.h)(this._tmp0,e,(0,y.k)(e,(0,w.g)(t))/(0,y.p)(e));const r=(0,y.a)((0,w.g)(t),this._tmp0),o=t[3];if(r<=o*o)return Math.abs(s);{const a=(0,y.h)(this._tmp0,(0,w.g)(t),1/i),m=(0,y.h)(this._tmp1,a,i-o*o/2/i),x=e,u=(0,y.f)(this._tmp2,x,m),p=(0,y.f)(this._tmp2,u,(0,y.h)(this._tmp3,a,(0,y.k)(a,u))),N=(0,y.g)(this._tmp2,m,(0,y.h)(this._tmp2,p,o/(0,y.l)(p)));let D=(0,y.q)(x,N);if(s>=2e5){const C=(0,y.f)(this._tmp1,x,N);let U=(0,y.k)(C,a)/(0,y.l)(C);U<.08&&(U=1e-4),D/=U}return D}}_getDistance(e,t){return this._isGlobalMode?this._getDistanceGlobeMode(e,t):this._getDistancePlanarMode(e,t)}_updateMinMaxDistance(e){e>0?(this.minDistance=Math.min(this.minDistance,e),this.maxDistance=Math.max(this.maxDistance,e)):(this.minDistance=0,this.maxDistance=Math.max(this.maxDistance,-e))}getLodLevel(e){if(e.lodMetric===K.w5.None)return 0;if(0===e.childCount)return this.maxLodLevel;if(this._useFrustumCulling&&this._progressiveLoadFactor<1){const i=this._screenspaceErrorBias;return this.evaluateLODmetric(e,this._progressiveLoadFactor*this._screenspaceErrorBias)?this.evaluateLODmetric(e,i)?2:1:0}return this.evaluateLODmetric(e,this._screenspaceErrorBias)?this.maxLodLevel:0}evaluateLODmetric(e,t){switch(e.lodMetric){case K.w5.ScreenSpaceRelative:{const i=this.getServiceMbsInRenderSR(e),s=this._getDistance(this._camPos,i),r=2*s/this._screenSizeFactor;return this._updateMinMaxDistance(s+i[3]),e.maxError*t<=r}case K.w5.MaxScreenThreshold:{let i=this._screenSpaceDiameterMbs(e,e.serviceMbsInIndexSR[3]*t);return this._options.angleDependentLoD&&(i*=this.calcAngleDependentLoD(e)),i<e.maxError}case K.w5.RemovedFeatureDiameter:return this._screenSpaceDiameterMbs(e,e.maxError)*t<10;case K.w5.DistanceRangeFromDefaultCamera:return this.calcCameraDistance(e)>e.maxError*t}return!1}distToPOI(e){const t=this.getServiceMbsInRenderSR(e);return(0,y.q)((0,w.g)(t),this._poi)-t[3]}distCameraToPOI(){return(0,y.q)(this._camPos,this._poi)}}const ai=(0,g.Ue)(),Mt=(0,st.Hf)(),li=(0,g.Ue)(),Et=(0,g.Ue)(),Rt=new Be.Oo,nt=(0,g.Ue)(),rt=[(0,g.Ue)(),(0,g.Ue)(),(0,g.Ue)(),(0,g.Ue)(),(0,g.Ue)(),(0,g.Ue)(),(0,g.Ue)(),(0,g.Ue)()],di=(0,g.Ue)();var hi=l(55745),_t=l(39135),Ot=l(98467),gt=l(93579);const mt=1e-4;let ge=class extends((0,j.v)(c.Z)){get isMeshPyramid(){return"mesh-pyramids"===this.layer.profile||"MeshPyramid"===this.layer.store?.lodType}get isGraphics3D(){return"points"===this.layer.profile}get useMaximumNumberOfFeatures(){return!this.isMeshPyramid&&(null==this.layer.priority||"High"===this.layer.priority)}get indexStreamController(){const n=this.layerView.view.resourceController.createStreamDataRequester(_t.Bh.I3S_INDEX);return new It(n,this.layer.customParameters,this.layer.apiKey)}get dataStreamController(){const n=this.layerView.view.resourceController.createStreamDataRequester(_t.Bh.I3S_DATA);return new It(n,this.layer.customParameters,this.layer.apiKey)}get crsVertex(){return(0,Ee.T2)(this.layer)}get crsIndex(){return(0,Ee.tp)(this.layer)}get layer(){return this.layerView.i3slayer}get running(){return this.updating}get rootNodeVisible(){if(this._index){const n=this._index.rootNode;if(n)return this._updateViewData(),this._index.isNodeVisible(n.index)}return!0}get index(){return this._index}get requiredAttributes(){return this._requiredAttributes}constructor(n){super(n),this.screenSizeFactor=0,this.featureTarget=5e4,this.fixedFeatureTarget=!1,this.updating=!0,this.updatingProgress=1,this.leavesReached=!1,this.scaleVisibilityEnabled=!0,this.worker=null,this._featureLOD=1,this._stableFeatureLOD=!1,this._isIdle=!1,this._cameraDirty=!0,this._invisibleDirty=!1,this._idleStateCallbacks=null,this._newLoadingNodes=new Q.Z({deallocator:null}),this._loadedNodeScales=new Map,this._modificationsNodeFilteringArray=new Q.Z,this._downloadingCount=0,this._loadingNodes=new Map,this._updatingNodes=new Map,this._progressMaxNumNodes=1,this._requiredAttributes=new Array,this._requiredAttributesDirty=!0,this._updatesDisabled=!1,this.disableIDBCache=!1,this._disableMemCache=!1,this._restartNodeLoading=!1,this._fields=null,this._attributeStorageInfo=null,this._idleQueue=new fe.b,this._elevationUpdateNodes=new Q.Z({deallocator:null}),this._errorCount=0}initialize(){const{layerView:n,layer:e}=this;this._disableMemCache=!n.loadCachedGPUData||!n.addCachedGPUData,this._lodHandling=new Qt(n),this._defaultGeometrySchema=e.store.defaultGeometrySchema,this.disableIDBCache=(0,he.Z)("disable-feature:idb-cache"),"fields"in e&&(this._fields=e.fields,this._attributeStorageInfo=e.attributeStorageInfo),this.addResolvingPromise(Promise.all([e.indexInfo,e.when(),n.when()]).then(([t])=>{if(this.destroyed||!n||n.destroyed||!t)return;const{view:i,clientGeometry:s}=n,{resourceController:r}=i;if(this._setClippingArea(i.clippingArea),this.addHandles([(0,k.YP)(()=>i?.pointsOfInterest?.focus?.renderLocation,o=>this._pointOfInterestChanged(o),k.nn),(0,k.YP)(()=>i.quality,()=>this._setCameraDirty(),k.Z_),(0,k.YP)(()=>n.contentVisible,o=>{const a=o?()=>this._updateIdleState(!0):()=>this._updateViewData(),d=o?()=>this._updateIdleState(!1):()=>{};o&&null!=this._index&&this._index.invalidateAllElevationRanges(),this._idleStateCallbacks?(o||this.cancelNodeLoading(),this.restartNodeLoading(),this._idleStateCallbacks.idleBegin=a,this._idleStateCallbacks.idleEnd=d):this._idleStateCallbacks=r.scheduler.registerIdleStateCallbacks(a,d)},k.nn),Tt(n.view.resourceController.scheduler,this),(0,k.YP)(()=>n.uncompressedTextureDownsamplingEnabled,()=>this.restartNodeLoading()),(0,k.YP)(()=>[this.featureTarget,this.fixedFeatureTarget],()=>{this._setCameraDirty(),this._stableFeatureLOD=!1}),(0,k.YP)(()=>i.state?.contentCamera,()=>this._setCameraDirty()),(0,k.YP)(()=>e.elevationInfo,o=>this._elevationInfoChanged(o)),(0,k.YP)(()=>e.effectiveScaleRange,()=>this._scaleBoundsChanged()),(0,k.YP)(()=>n.lodFactor,()=>this._setCameraDirty()),(0,k.YP)(()=>n.availableFields,()=>this._requiredFieldsChange()),(0,k.YP)(()=>n.holeFilling,o=>null!=this._index&&(this._index.holeFilling=o))]),this._updateScaleHandles(),this._viewportQueries=new oi(this.crsIndex,i.renderCoordsHelper,i.state.contentCamera,!i.state.fixedContentCamera||this.isGraphics3D,this._clippingArea,this.isMeshPyramid?i.basemapTerrain:i.elevationProvider,(0,ue.wg)(i.viewingMode),this.layer.elevationInfo,{progressiveLoadFactor:this._getProgressiveLoadFactor(),screenspaceErrorBias:this._lod,angleDependentLoD:this._lod<.5}),this._clientNodeLoader=new se(this.layer.uid,{indexSR:this.crsIndex,vertexSR:this.crsVertex,renderSR:i.renderCoordsHelper.spatialReference,localMode:"local"===i.viewingMode},i.resourceController.memoryController,this.worker),this._index=new jt((0,ue.wg)(i.viewingMode),e,t,this.indexStreamController,this._clientNodeLoader,this._viewportQueries,te.Z.getLogger(this),n.holeFilling,o=>n.isNodeLoaded(o),o=>n.isNodeReloading(o),o=>this._shouldLoadNode(o),o=>this._enableFromGPUCache(o,K.FE.Leaf),o=>this._needsUpdate(o),()=>!this.indexStreamController.busy,o=>n.computeVisibilityObb?.(o)??null,n?.computeNodeFiltering?o=>n.computeNodeFiltering(o):void 0),this._index.updateElevationInfo(this.layer.elevationInfo,this.isMeshPyramid||this.isGraphics3D),this._index.imModificationsChanged(!!n.hasModifications),this._index.layerFilterChanged(!!n.hasGeometryFilter),null!=s){for(const o of s)this._addMesh(o.mesh,o.oid);this.addHandles(s.on("change",o=>{for(const a of o.removed)this._removeMesh(a.oid);for(const a of o.added)this._addMesh(a.mesh,a.oid)}))}this._startNodeLoading()})),this._tmpPoint=(0,B.T)(0,0,0,this.crsIndex)}updateNodeModificationStatus(n){const e=this._index,t=this.layerView;null!=e&&t?.updateNodeModificationStatus&&(this._modificationsNodeFilteringArray.clear(),n.forAll(i=>{const s=e.getNode(i);null!=s&&this._modificationsNodeFilteringArray.push(s)}),t.updateNodeModificationStatus(this._modificationsNodeFilteringArray),this._invisibleDirty=!0)}destroy(){this.cancelNodeLoading(),this._idleStateCallbacks&&(this._isIdle=!1,this._idleStateCallbacks.remove(),this._idleStateCallbacks=null),this._nodeLoader=null,Re.prune(),null!=ft&&(ft.hide(),ft=null)}get viewportQueries(){return this._viewportQueries}_getRequiredAttributes(){if(null==this._attributeStorageInfo||!this._fields||!this.layerView.availableFields)return[];const n=this._attributeStorageInfo,e=this._fields,t=this.layer.objectIdField;return this.layerView.availableFields.map(i=>{const s=vt(n,i),r=vt(e,i);return s>=0&&r>=0?{index:s,name:e[r].name,field:e[r],attributeStorageInfo:n[s]}:null}).filter(i=>null!=i&&i.name!==t)}_requiredFieldsChange(){const n=this._getRequiredAttributes();pt(this._requiredAttributes,n)||(this._requiredAttributes=n,this._requiredAttributesDirty=!1,this.restartNodeLoading())}requestUpdate(){this._requiredAttributesDirty=!0,this.restartNodeLoading()}_setClippingArea(n){const e=(0,z.Ue)();this._clippingArea=(0,hi.G)(n,e,this.layerView.view.renderSpatialReference)?e:null}_pointOfInterestChanged(n){null!=this._viewportQueries&&(this._viewportQueries.setPointOfInterest(n),null!=this._index&&(this._index.progressiveLoadPenalty=At.distancePenalty*this._viewportQueries.distCameraToPOI(),this._index.requestUpdate()))}updateClippingArea(n){this._setClippingArea(n),null!=this._viewportQueries&&null!=this._index&&(this._viewportQueries.updateClippingArea(this._clippingArea),this._index.invalidateVisibilityCache()),this._setCameraDirty()}_setCameraDirty(){this._cameraDirty=!0,this._lodHandling.setLodGlobalDirty(),this._evaluateUpdating()}_addMesh(n,e){if(null==this._index)return;const t=this._clientNodeLoader.createMeshNodeInfo(n,e),i=this._index.addClientNodeToIndex(t.id,t.mbs);this._clientNodeLoader.addMeshNode(i,t),this._evaluateUpdating(),this.notifyChange("rootNodeVisible")}_removeMesh(n){const e=this._clientNodeLoader.getMeshNodeIndex(n);if(null!=e){if(null==this._index)throw new Error("delayed removal of client side i3s node geometry not supported yet.");this._index.removeClientNodeFromIndex(e,(s,r)=>{this.layerView.removeNode(r),this._loadedNodeScales.delete(r),this._clientNodeLoader.removeNode(s),this.layerView.deleteCachedNodeData&&null!=s&&this.layerView.deleteCachedNodeData(s),this.layerView.deleteCachedGPUData?.(this.layerView.loadCachedGPUData?.(r))},(s,r,o)=>{this._clientNodeLoader.updateNodeIndex(s,r,o),this.layerView.updateNodeIndex&&this.layerView.updateNodeIndex(r,o)}),this.notifyChange("rootNodeVisible")}}updateElevationChanged(n,e){const t=this._index;if(null==t?.rootNode||null==e)return null;this.crsIndex.equals(e)||((0,S.d)(n,e,ot,this.crsIndex),n=ot);const i=this._elevationUpdateNodes;return i.clear(),(0,Ee.tS)(n,t.rootNode,t,s=>i.push(s.index)),i.length&&(i.forAll(s=>t.updateElevationChanged(s)),this._setCameraDirty()),i}removeAllGeometryObbs(){null!=this._index&&this._index.removeAllGeometryObbs()}getRenderMbs(n){return null!=this._viewportQueries?this._viewportQueries.getServiceMbsInRenderSR(n):null}_elevationInfoChanged(n){null!=this._index&&(this._index.updateElevationInfo(n,this.isMeshPyramid||this.isGraphics3D),this._setCameraDirty())}_updateScaleHandles(){const n="scale-bounds";this.removeHandles(n),this._areScaleBoundsActive&&this.addHandles(this.layerView.view.basemapTerrain.on("scale-change",e=>this._scaleUpdateHandler(e)),n)}_scaleBoundsChanged(){this._areScaleBoundsActive||this._loadedNodeScales.clear(),this._updateScaleHandles(),this._setCameraDirty()}_scaleUpdateHandler(n){this._updateScaleInBoundingRect(n.extent,n.spatialReference),this._setCameraDirty()}_updateScaleInBoundingRect(n,e){const t=this._index;null!=t&&null!=t.rootNode&&(0,S.d)(n,e,ot,this.crsIndex)&&this._loadedNodeScales.forEach((i,s)=>{const r=t.getNode(s);null!=r&&(0,z.hr)(ot,r.serviceMbsInIndexSR)&&this._loadedNodeScales.set(s,this._computeScale(r))})}restartNodeLoading(){this._restartNodeLoading=!0,this.cancelNodeLoading(),this._evaluateUpdating()}schedule(n,e){return this._idleQueue.push(n,e)}reschedule(n,e){return this._idleQueue.unshift(n,e)}get _isIntegratedMesh(){return"integrated-mesh"===this.layer.type}get _areScaleBoundsActive(){const{minScale:n,maxScale:e}=(0,gt.lu)(this.layer);return this.scaleVisibilityEnabled&&(n>0||e>0)}get unloadedMemoryEstimate(){return null!=this._index&&this.layerView.contentVisible?this._index.unloadedMemoryEstimate*this._lodDropFactor:0}_loadNodeData(n,e){var t=this;return(0,E.Z)(function*(){return n.index<0?t._clientNodeLoader.loadNodeData(n.id,e):t._nodeLoader.loadNodeData(n,e)})()}_loadAttributes(n,e,t){var i=this;return(0,E.Z)(function*(){return(n.index<0?i._clientNodeLoader:i._nodeLoader).loadAttributes(n,e,t)})()}get indexDepth(){return null!=this._index?this._index.maxLevel:0}set disableMemCache(n){this._disableMemCache=!this.layerView.loadCachedGPUData||!this.layerView.addCachedGPUData||n}runTask(n,e){return this.layerView.contentVisible?this.layerView.visible&&null!=this._index?(this._processWithErrorLogging(n,e),this._index.maxPriority):-1/0:(this._updateViewData(),this._evaluateUpdating(),-1/0)}_processWithErrorLogging(n,e){try{this._process(n,e)}catch(t){this._errorCount<50?te.Z.getLogger(this).error(`Error during processing: ${t} at ${t.stack}`):50===this._errorCount&&te.Z.getLogger(this).error("Too many errors for this layer. Further errors will not be displayed."),this._errorCount++}}_process(n,e){this._restartNodeLoading&&this._startNodeLoading(),null!=this._nodeLoader&&null!=this._index&&(this._updateViewData(),this._invisibleDirty&&this._removeInvisibleNodes(n)&&(this._invisibleDirty=!1),this._isIntegratedMesh&&(n.enabled=!1),n.run(()=>this._processIndex(n)),this._updateFeatureLOD(),n.run(()=>this._processCache(n)),this._isIntegratedMesh&&(n.enabled=!0),n.run(()=>this._processNodes(n,e)),this._idleQueue.runTask(n),n.run(()=>this._prefetchIndex()),e.numIndexLoading+=this._index.indexLoading,e.numNodesLoading+=this._downloadingCount,n.run(()=>this._lodHandling.lodGlobalHandling(n)),this._evaluateUpdating())}_processIndex(n){if(null==this._index)return!1;if(this._index.dirty){this._newLoadingNodes.clear(),this._index.update(Array.from(this._loadingNodes.keys()),n,t=>this.updateNodeModificationStatus(t)),this._disableMemCache||(this._newLoadingNodes.pushArray(this._index.updates.add.data,this._index.updates.add.length),this._newLoadingNodes.pushArray(this._index.updates.missing.data,this._index.updates.missing.length));const e=this._index.featureEstimate.leavesReached;this._index.isLoading||e===this._get("leavesReached")||this._set("leavesReached",e)}return this._index.load()}_prefetchIndex(){return!(null==this._index||this._loadingNodes.size>0||this._index.updates.add.length>0)&&this._index.prefetch()}_updateFeatureLOD(){if(!this.useMaximumNumberOfFeatures||null==this._index||null==this._viewportQueries)return;const n=!this._index.isLoading,e=this.featureTarget*this._baseLOD,t=this._index.featureEstimate;if(t.estimate=t.estimate||e/2,this._index.indexMissing>500){if(this._featureLOD<=mt)return;this._featureLOD/=1.5,this._stableFeatureLOD=!1}else if(n&&t.estimate<e){if(t.leavesReached||this._featureLOD>=1e4||this._stableFeatureLOD)return;const i=Math.min(10,Math.max(e/t.estimate,1.001));this._featureLOD*=i;const s=this._lod,r=this._index.checkFeatureTarget(e,s);r!==s&&(this._featureLOD=r/this._baseLOD,this._stableFeatureLOD=!0)}else{if(!(t.estimate>1.2*e||n&&t.estimate>e)||this._featureLOD<=mt)return;this._featureLOD/=1+.25*(t.estimate/e-1),this._stableFeatureLOD=!1}this._featureLOD=Math.min(1e4,Math.max(mt,this._featureLOD)),this._viewportQueries.updateScreenSpaceErrorBias(this._lod),this._index.requestUpdate()}_processCache(n){const e=this._index;if(null==e)return!1;for(;this._newLoadingNodes.length>0&&!n.done;){const t=this._newLoadingNodes.pop();for(let i=e.getParent(t);null!=i&&!this.layerView.isNodeLoaded(i.index)&&this._isNodeInScaleBounds(i);i=e.getParent(i.index))if(this._enableFromGPUCache(i,K.FE.Hole)){n.madeProgress();break}}return n.hasProgressed}_processNodes(n,e){if(null==this._index)return!1;let t=(this._isIdle?100:2)-this._loadingNodes.size;const i=this._index.updates;for(i.cancel.forEach(this._cancelNode,this),i.cancel=[];i.remove.length>0&&!n.done;)this.layerView.removeNode(i.remove.pop()),n.madeProgress();for(;i.update.length>0&&!n.done;){const s=this._index.getNode(i.update.pop());null!=s&&(this._updateLoadedNode(s),n.madeProgress())}for(;i.add.length>0&&!n.done&&t>0;){--t;const s=this._index.getNode(i.add.back());if(null==s||s.cacheState!==K.Hw.Cached&&!this._hasNodeLoadToken(e))break;i.add.pop(),this._loadNode(s),n.madeProgress()}return n.hasProgressed}_cancelAllNodes(){this._loadingNodes.forEach(n=>n.abort()),this._loadingNodes.clear(),this._updatingNodes.forEach(n=>n.abort()),this._updatingNodes.clear()}_cancelNode(n){const e=this._loadingNodes.get(n);e&&(e.abort(),this._loadingNodes.delete(n))}_hasNodeLoadToken(n){return!(!this._isIdle&&n.numNodesLoading+this._loadingNodes.size>=2)&&this._downloadingCount<_t.NT&&!this.dataStreamController.busy}_evaluateUpdating(){let n=!1,e=0;if(this.layerView){if(this.layerView.contentVisible){const t=(null!=this._index?this._index.indexMissing:0)+3*(null!=this._index?this._index.updates.add.length:0)+2*this._loadingNodes.size;n=!!(t>0||this._updatingNodes.size>0||this._restartNodeLoading||this._cameraDirty||this._idleQueue.running||this._lodHandling&&this._lodHandling.requiresLODGlobalHandling||null!=this._index&&this._index.isPrefetching),0===t&&(this._progressMaxNumNodes=1),this._progressMaxNumNodes=Math.max(t,this._progressMaxNumNodes),e=1-t/this._progressMaxNumNodes}else n=this._cameraDirty,e=n?0:1;this.updating=n,this.updatingProgress=e}}_updateViewData(){if(!this._cameraDirty||null==this._index||null==this._viewportQueries)return;const n=this.layerView.view,{contentCamera:e,fixedContentCamera:t}=n.state;this.screenSizeFactor=1/(e.perScreenPixelRatio/2),this._viewportQueries.updateCamera(e,!t||this.isGraphics3D),this._viewportQueries.setPointOfInterest(n.pointsOfInterest.focus.renderLocation),this._viewportQueries.updateScreenSpaceErrorBias(this._lod),this._index.invalidateVisibilityCache(),this._index.progressiveLoadPenalty=At.distancePenalty*this._viewportQueries.distCameraToPOI(),this._index.requestUpdate(),this._stableFeatureLOD=!1,this._invisibleDirty=!0,this._cameraDirty=!1,this.notifyChange("rootNodeVisible")}_getProgressiveLoadFactor(){return this.layerView.view.quality<1?1:this.layerView.progressiveLoadFactor}get _lod(){return this._featureLOD*this._baseLOD}get _baseLOD(){const n=this.layerView.lodFactor;return this.fixedFeatureTarget?1:(n>0?n:1)*this.layerView.view.quality}get _lodDropFactor(){return this.fixedFeatureTarget?1:(Math.min(this.layerView.view.quality,.5)-Ot.d)/(.5-Ot.d)}isGeometryVisible(n){return!!this._index?.isGeometryVisible(n.index)}updateVisibility(n){this._index?.invalidateNodeVisibilityCache(n)}invalidateGeometryVisibility(n){this._index?.invalidateGeometryVisibility(n)}invalidateVisibilityObbs(){this._index?.invalidateVisibilityObbs()}modificationsChanged(){this._index?.imModificationsChanged(!!this.layerView.hasModifications),this._invisibleDirty=!0}_shouldLoadNode(n){return!(!this._lodHandling.shouldLoadNode(n)||this._shouldDropNode(n))&&!(null==this._index||!this._index.isGeometryVisible(n.index))&&this._isNodeInScaleBounds(n)}_shouldDropNode(n){if(null==this._viewportQueries)return!1;const e=this._lodDropFactor;return!(e>=1||!this._lodHandling.hasNoVisibleChildren(n))&&Math.abs(this._viewportQueries.calcCameraDistanceToCenter(n))-this._viewportQueries.minDistance>(this._viewportQueries.maxDistance-this._viewportQueries.minDistance)*e}_startNodeLoading(){this._restartNodeLoading=!1;const n=this._index;if(this._updatesDisabled||null==n||null==this._viewportQueries)return;this._updateViewData(),this._requiredAttributesDirty&&(this._requiredAttributes=this._getRequiredAttributes(),this._requiredAttributesDirty=!1);const e={textureEncodings:this.layerView.supportedTextureEncodings,uncompressedTextureDownsamplingEnabled:this.layerView.uncompressedTextureDownsamplingEnabled,textureUsageMask:this.layerView.rendererTextureUsage,loadFeatureData:this.useMaximumNumberOfFeatures};this._nodeLoader=new tt(this.layer,this.dataStreamController,te.Z.getLogger(this),this._defaultGeometrySchema,this._requiredAttributes,e),n.requestUpdate(),this._lodHandling.startNodeLoading(t=>this._isNodeInScaleBounds(t),(t,i)=>this._removeNodes(t,i,$e.fadeout),n,{maxLodLevel:this._viewportQueries.maxLodLevel}),this._evaluateUpdating()}isNodeLoading(){return null!=this._nodeLoader&&null!=this._index}cancelNodeLoading(){this.isNodeLoading()&&(this.indexStreamController.cancelAll(),this.dataStreamController.cancelAll(),this._idleQueue.cancelAll(),this._cancelAllNodes(),this._nodeLoader=null,this._evaluateUpdating())}_removeInvisibleNodes(n){const e=this._index;if(null==e||null==this._viewportQueries)return!1;Re.clear(),this.layerView.getLoadedNodeIndices(Re);const t=0===this._viewportQueries.maxDistance,i=t?()=>!1:s=>this._shouldDropNode(s);return Re.filterInPlace(s=>{const r=e.getNode(s);return null==r||!e.isGeometryVisible(s)||i(r)||!this._isNodeInScaleBounds(r)}),Re.length>0&&this._lodHandling.setLodGlobalDirty(),this._removeNodes(Re,n,$e.pop),!(t&&this._lodDropFactor<1||0!==Re.length&&(Re.clear(),1))}markNodeToRemove(n){Re.push(n)}removeMarkedNodes(){this._removeNodes(Re,Je.G5,$e.pop)}_removeNodes(n,e,t){const i=n.length;if(0!==i&&!e.done){for(null!=this._index&&this._index.requestUpdate();n.length>0&&!e.done;){const s=n.pop(),r=this._index;t===$e.fadeout&&this.layerView.nodeFadeoutEnabled&&null!=r&&r.isGeometryVisible(s)?this.layerView.fadeNode(s,ut.B.FadeOut,!0):this.layerView.removeNode(s),e.madeProgress()}if(this._loadedNodeScales.size>0)for(let s=n.length;s<i;s++)this._loadedNodeScales.delete(n.data[s])}}_needsUpdate(n){if(n.resources.isEmpty||this._updatingNodes.has(n.index))return!1;const e=this.layerView.getLoadedAttributes(n.index);return null!=e&&e!==this._requiredAttributes}_updateLoadedNode(n){var e=this;return(0,E.Z)(function*(){const t=new AbortController;e._updatingNodes.set(n.index,t),e._evaluateUpdating();try{const i=pt(e.layerView.getLoadedAttributes(n.index),e._requiredAttributes);let s=null;s=i?e.layerView.getAttributeData(n.index):yield e._loadAttributes(n,e._requiredAttributes,t.signal),yield e.schedule(()=>e.layerView.updateAttributes(n.index,{loadedAttributes:e._requiredAttributes,attributeData:s},t.signal),t.signal)}catch(i){if(!(0,ie.D_)(i))return e.layerView.updateAttributes(n.index,{loadedAttributes:e._requiredAttributes,attributeData:{}},t.signal)}e._updatingNodes.delete(n.index),e._evaluateUpdating()})()}_loadNode(n){if(this._loadingNodes.has(n.index))return void te.Z.getLogger(this).error("already loading node "+n.index);const e=new AbortController;this._loadingNodes.set(n.index,e),this._evaluateUpdating(),this._loadAndAddNode(n,e.signal).then(t=>{t&&null!=this._index&&this._loadingNodes.get(n.index)===e&&(this._loadingNodes.delete(n.index),this._index.requestUpdate())}).catch(t=>{if(!(0,ie.D_)(t))throw t}).finally(()=>{this._loadingNodes.get(n.index)===e&&this._loadingNodes.delete(n.index),this._evaluateUpdating()})}_loadAndAddNode(n,e){return n.cacheState===K.Hw.Uncached?this._loadUncached(n,e).then(()=>!1):this._loadCached(n,e).then(t=>!t&&(n.cacheState=K.Hw.Uncached,!0)).catch(t=>!(0,ie.D_)(t)&&(n.cacheState=K.Hw.Uncached,!0))}_enableFromGPUCache(n,e){if(this._disableMemCache||null==this._index)return!1;if(e===K.FE.Hole&&!this._index.useNodeAsHole(n.index))return!0;const t=this._loadCachedGPUData(n);return!!t&&(this.layerView.addCachedGPUData(n,t,e),this._nodeAdded(),!0)}_loadCachedGPUData(n){const e=this.layerView.loadCachedGPUData(n.index);return null!=e?.attributeInfo&&pt(e.attributeInfo.loadedAttributes,this._requiredAttributes)?e:(this.layerView.deleteCachedGPUData(e),null)}_nodeAdded(){null!=this._index&&this._index.requestUpdate(),this._lodHandling.setLodGlobalDirty(),this._evaluateUpdating()}updateLoadStatus(n,e){this._index?.updateChildrenLoaded(n,e?1:-1)}_loadCached(n,e){var t=this;return(0,E.Z)(function*(){if(t._enableFromGPUCache(n,K.FE.Leaf))return!0;const i=t.layerView;if(t.disableIDBCache||!i.loadCachedNodeData||!i.addCachedNodeData)return!1;const o=n.index>=0?(m,x)=>t._nodeLoader.loadTextures(n,m,x):(m,x)=>t._clientNodeLoader.loadTextures(n,m,x),a=yield t.schedule(()=>i.loadCachedNodeData(n,e,o),e);if(null==a)return!1;const d=t._requiredAttributes,h=yield t.reschedule(()=>t._loadAttributes(n,d,e),e);return yield t.reschedule(()=>i.addCachedNodeData(n,a,{loadedAttributes:d,attributeData:h},e),e),t._nodeAdded(),!0})()}_loadUncached(n,e){return this._downloadingCount++,this._loadNodeData(n,e).catch(t=>{throw this._downloadingCount--,t}).then(t=>(this._downloadingCount--,this.schedule(()=>this.layerView.addNode(n,t,e),e))).then(()=>{this._nodeAdded(),n.cacheState=K.Hw.Cached}).catch(t=>{if(!(0,ie.D_)(t))throw te.Z.getLogger(this).error("#loadNodeData()",this.layer,`Failed to load node '${n.id}'`,t),n.failed=!0,null!=this._index&&this._index.requestUpdate(),t})}_updateIdleState(n){n!==this._isIdle&&(this._isIdle=n,this._evaluateUpdating(),n&&this._index&&null!=this._index&&this._index.resetFailedNodes())}_getScale(n){if(this._loadedNodeScales.has(n.index))return this._loadedNodeScales.get(n.index);const e=this._computeScale(n);return this.layerView.isNodeLoaded(n.index)&&this._loadedNodeScales.set(n.index,e),e}_computeScale(n){return this._tmpPoint.x=n.serviceMbsInIndexSR[0],this._tmpPoint.y=n.serviceMbsInIndexSR[1],this._tmpPoint.z=n.serviceMbsInIndexSR[2],this.layerView.view.basemapTerrain.getSphereScale(this._tmpPoint,n.serviceMbsInIndexSR[3])}_isNodeInScaleBounds(n){if(!this._areScaleBoundsActive)return!0;const e=this._getScale(n),{minScale:t,maxScale:i}=(0,gt.lu)(this.layer);return(0,gt.rs)(e,t,i)}get test(){const n=this;return{index:this._index,set disableUpdates(e){n._updatesDisabled=e,e?n.cancelNodeLoading():n.requestUpdate()},set disableIDBCache(e){n.disableIDBCache=e},set ignoreServiceObb(e){null!=n._index&&(n._index.ignoreServiceObb=e)},shouldLoadNode:e=>n._shouldLoadNode(e)}}notifyLODUpdate(){this._lodHandling.setLodGlobalDirty(),this._evaluateUpdating(),null!=this._index&&this._index.requestUpdate()}geometryFilterChanged(n){this._index?.layerFilterChanged(n),this._setCameraDirty()}};(0,I._)([(0,M.Cb)({readOnly:!0})],ge.prototype,"isMeshPyramid",null),(0,I._)([(0,M.Cb)({readOnly:!0})],ge.prototype,"isGraphics3D",null),(0,I._)([(0,M.Cb)({readOnly:!0})],ge.prototype,"useMaximumNumberOfFeatures",null),(0,I._)([(0,M.Cb)({readOnly:!0})],ge.prototype,"indexStreamController",null),(0,I._)([(0,M.Cb)({readOnly:!0})],ge.prototype,"dataStreamController",null),(0,I._)([(0,M.Cb)({readOnly:!0})],ge.prototype,"crsVertex",null),(0,I._)([(0,M.Cb)({readOnly:!0})],ge.prototype,"crsIndex",null),(0,I._)([(0,M.Cb)()],ge.prototype,"screenSizeFactor",void 0),(0,I._)([(0,M.Cb)()],ge.prototype,"featureTarget",void 0),(0,I._)([(0,M.Cb)()],ge.prototype,"fixedFeatureTarget",void 0),(0,I._)([(0,M.Cb)()],ge.prototype,"layerView",void 0),(0,I._)([(0,M.Cb)()],ge.prototype,"layer",null),(0,I._)([(0,M.Cb)()],ge.prototype,"updating",void 0),(0,I._)([(0,M.Cb)({readOnly:!0})],ge.prototype,"running",null),(0,I._)([(0,M.Cb)()],ge.prototype,"updatingProgress",void 0),(0,I._)([(0,M.Cb)({readOnly:!0})],ge.prototype,"leavesReached",void 0),(0,I._)([(0,M.Cb)({constructOnly:!0})],ge.prototype,"scaleVisibilityEnabled",void 0),(0,I._)([(0,M.Cb)({constructOnly:!0})],ge.prototype,"worker",void 0),(0,I._)([(0,M.Cb)({readOnly:!0,dependsOn:[]})],ge.prototype,"rootNodeVisible",null),ge=(0,I._)([(0,q.j)("esri.layers.graphics.controllers.I3SOnDemandController")],ge);const Re=new Q.Z({deallocator:null});let ft;function pt(n,e){return null!=n&&n.length===e.length&&n.every(t=>vt(e,t.name)>=0)}function vt(n,e){const t=e.toLowerCase();for(let i=0;i<n.length;i++)if(n[i].name.toLowerCase()===t)return i;return-1}const At={factorIM:.2,factor3dObject:.05,distancePenalty:10},ot=(0,z.Ue)();var $e,n;(n=$e||($e={}))[n.pop=0]="pop",n[n.fadeout=1]="fadeout";const mi=ge},35391:(De,le,l)=>{l.d(le,{$6:()=>oe,$z:()=>c,F7:()=>I,Ow:()=>j,S0:()=>Q,d1:()=>ie,dm:()=>k});const E=[["binary","application/octet-stream","bin",""]];function I(F,J){return null!=S(J.name,F?.supportedFormats??[])}function c(F,J){if(!F)return!1;const ce=k(J,F.supportedFormats??[]);return null!=ce&&F.editFormats.includes(ce)}function Q(F,J){return z(function q(F,J){const ce=F.toLowerCase();return M(J).find(P=>B(P)===ce)}(F,J))}function j(F,J){return z(S(F,J))}function ie(F,J){return B(function ve(F,J){return M(J).find(ce=>z(ce)===F)}(F,J))}function k(F,J){return j(F.name,J)??Q(F.type,J)}function M(F){return[...E,...F]}function S(F,J){const ce=F.toLowerCase();return M(J).find(P=>function fe(F){return F?.[2].split(",").map(J=>J.toLowerCase())??[]}(P).some(Y=>ce.endsWith(Y)))}function z(F){return F?.[0]}function B(F){return F?.[1].toLowerCase()}function oe(F){return F.tables?.find(J=>"assetMaps"===J.role)}},3740:(De,le,l)=>{l.r(le),l.d(le,{assetMapFromAssetMapsJSON:()=>F,extractMesh:()=>B,meshFeatureSetFromJSON:()=>S});var E=l(88879),I=l(63290),c=l(88159),he=l(2004),te=l(15453),Q=l(72642),j=l(65234),ie=l(99746),k=l(96603),M=l(35391),ve=l(17253);const q=()=>I.Z.getLogger("esri.rest.support.meshFeatureSet");function S(P,Y,y){const g=y.features;y.features=[],delete y.geometryType;const v=ve.Z.fromJSON(y);if(v.geometryType="mesh",!y.assetMaps)return v;const O=F(Y,y.assetMaps),w=P.sourceSpatialReference??j.Z.WGS84,W=y.globalIdFieldName,{outFields:T}=P,ne=null!=T&&T.length>0?function z(P){return({attributes:Y})=>{if(!Y)return{};if(!P)return Y;for(const y in Y)P.has(y)||delete Y[y];return Y}}(T.includes("*")?null:new Set(T)):()=>({});for(const L of g){const _=B(L,W,w,Y,O);null!=_&&v.features.push(new E.Z({geometry:_,attributes:ne(L)}))}return v}function B(P,Y,y,g,v){const w=v.get(P.attributes[Y]);if(null==w)return q().error("mesh-feature-set:asset-not-found","Service returned a feature which was not found in the asset map",P),null;if(!P.geometry)return q().error("mesh-feature-set:no-geometry","Service returned a feature without geometry",P),null;const W=function fe({attributes:P},Y,{transformFieldRoles:y}){return new Q.Z({x:P[y.originX],y:P[y.originY],z:P[y.originZ],spatialReference:Y})}(P,y,g),T=he.Z.fromJSON(P.geometry);T.spatialReference=y;const ne=function ue(P,{transformFieldRoles:Y}){return new ie.Z({translation:[P[Y.translationX],-P[Y.translationZ],P[Y.translationY]],rotationAxis:[P[Y.rotationX],-P[Y.rotationZ],P[Y.rotationY]],rotationAngle:P[Y.rotationDeg],scale:[P[Y.scaleX],P[Y.scaleZ],P[Y.scaleY]]})}(P.attributes,g),L=y.isGeographic?"local":"georeferenced",_=function J(P){const Y=Array.from(P.files.values()),y=new Array;for(const g of Y){if(g.status!==oe.COMPLETED)return null;const v=new Array;for(const O of g.parts){if(!O)return null;v.push(new k.LL(O.url,O.hash))}y.push(new k.CP(g.name,g.mimeType,v))}return y}(w);return _?te.Z.createWithExternalSource(W,_,{extent:T,transform:ne,vertexSpace:L}):te.Z.createIncomplete(W,{extent:T,transform:ne,vertexSpace:L})}var oe,P;function F(P,Y){const y=new Map;for(const g of Y){const v=g.parentGlobalId;if(null==v)continue;const O=g.assetName,w=g.assetType,W=g.assetHash,T=g.assetURL,ne=g.conversionStatus,L=g.seqNo,_=(0,M.d1)(w,P.supportedFormats);if(!_){q().error("mesh-feature-set:unknown-format",`Service returned an asset of type ${w}, but it does not list it as a supported type`);continue}const f=(0,c.s1)(y,v,()=>({files:new Map}));(0,c.s1)(f.files,O,()=>({name:O,type:w,mimeType:_,status:ce(ne),parts:[]})).parts[L]={hash:W,url:T}}return y}function ce(P){switch(P){case"COMPLETED":case"SUBMITTED":return oe.COMPLETED;case"INPROGRESS":return oe.PENDING;default:return oe.FAILED}}(P=oe||(oe={}))[P.FAILED=0]="FAILED",P[P.PENDING=1]="PENDING",P[P.COMPLETED=2]="COMPLETED"},16446:(De,le,l)=>{l.r(le),l.d(le,{default:()=>S});var E=l(17626),I=l(26584),c=l(77712),j=(l(8314),l(63290),l(4619),l(76898)),ie=l(55915),k=l(72469),M=l(35560),ve=l(40814);let q=class extends ve.Z{constructor(){super(...arguments),this.type="feature-3d",this.direct3DObjectFeatureLayerDisplayEnabled=(0,M.Vi)()}initialize(){const{layer:z,view:B}=this;(0,k.S1)(z)?.operations.supportsQuery||this.addResolvingPromise(Promise.reject(new I.Z("featurelayerview:query-not-supported","layer view requires a layer with query capability",{layer:z}))),null!=z.infoFor3D&&(this.direct3DObjectFeatureLayerDisplayEnabled?this._set("suspendResumeExtentMode","computed"):this.addResolvingPromise(Promise.reject(new I.Z("featurelayerview3d:unsupported-geometry-type",`Unsupported geometry type ${z.geometryType}`)))),"mesh"!==z.geometryType||(0,ie.canProjectWithoutEngine)(z.spatialReference,B.spatialReference)||this.addResolvingPromise(Promise.reject(new I.Z("layerview:spatial-reference-incompatible","The spatial references of the feature layer is incompatible with the spatial reference of the view")))}get featureSpatialReference(){return this.view.featureTiles?.tilingScheme?.spatialReference}};(0,E._)([(0,c.Cb)({constructOnly:!0})],q.prototype,"direct3DObjectFeatureLayerDisplayEnabled",void 0),(0,E._)([(0,c.Cb)()],q.prototype,"layer",void 0),q=(0,E._)([(0,j.j)("esri.views.3d.layers.FeatureLayerView3D")],q);const S=q},42767:(De,le,l)=>{l.d(le,{K0:()=>ce,Pg:()=>B,R0:()=>ve,RE:()=>J,cU:()=>ue,dY:()=>fe,nn:()=>P});var E=l(8314),I=l(21286),c=l(81937),he=l(52051),te=l(67022),Q=l(22799),j=l(42743),ie=l(81695),k=l(30395),M=l(67969);function ve(g,v,O){const w=new Map,W=($,se)=>{if(null==$)return-1;const X=w.get($.id);if(X)return X.usage|=se,X.id;const _e=w.size;return w.set($.id,{id:_e,usage:se}),_e},T=v.pbrMetallicRoughness,ne=T?.baseColorFactor,L=v.emissiveFactor,_=(0,E.Z)("disable-feature:diffuse-rendering-i3s")||O?(0,k.Ix)({normalTexture:v.normalTexture,emissiveTexture:v.emissiveTexture,emissiveFactor:v.emissiveFactor,occlusionTexture:v.occlusionTexture,metallicRoughnessTexture:T?.metallicRoughnessTexture,metallicFactor:T?.metallicFactor,roughnessFactor:T?.roughnessFactor}):(0,k.Ih)({normalTexture:v.normalTexture,emissiveTexture:v.emissiveTexture,emissiveFactor:v.emissiveFactor,occlusionTexture:v.occlusionTexture,metallicRoughnessTexture:T?.metallicRoughnessTexture,metallicFactor:T?.metallicFactor,roughnessFactor:T?.roughnessFactor}),f=_?k.yI[0]:T?.metallicFactor??k.ml[0],b=_?k.yI[1]:T?.roughnessFactor??k.ml[1],Z={baseColorFactor:ne?[ne[0],ne[1],ne[2],ne[3]]:[1,1,1,1],baseColorTextureId:W(T?.baseColorTexture,"mask"===v.alphaMode?c.v.Color|c.v.AlphaMask:c.v.Color),metallicRoughnessTextureId:W(T?.metallicRoughnessTexture,c.v.MetallicRoughness),metallicFactor:f,roughnessFactor:b},G={alphaMode:v.alphaMode,alphaCutoff:v.alphaCutoff,doubleSided:v.doubleSided,cullFace:"none"===v.cullFace?j.Vr.None:"back"===v.cullFace?j.Vr.Back:"front"===v.cullFace?j.Vr.Front:j.Vr.None,normalTextureId:W(v.normalTexture,c.v.Normal),emissiveTextureId:W(v.emissiveTexture,c.v.Emissive),occlusionTextureId:W(v.occlusionTexture,c.v.Occlusion),emissiveFactor:L?[L[0],L[1],L[2]]:[0,0,0],metallicRoughness:Z,wrapTextures:!1,hasParametersFromSource:_},H=[];return w.forEach(({usage:$},se)=>{const X=null!=g&&g[se]&&g[se].formats,_e=X?q(X.map(({name:re,format:xe})=>({name:re,encoding:S[xe]}))):[];H.push({id:se,usage:$,encodings:_e})}),{material:G,textures:H}}function q(g){return g.sort((v,O)=>v.encoding-O.encoding)}const S={ktx2:c.j.KTX2,basis:c.j.Basis,dds:c.j.DDS_S3TC,png:c.j.PNG,jpg:c.j.JPG,"ktx-etc2":c.j.KTX_ETC2},z={[j.Ti.KTX2_ENCODING]:c.j.Basis,[j.Ti.BASIS_ENCODING]:c.j.Basis,[j.Ti.DDS_ENCODING]:c.j.DDS_S3TC,"image/png":c.j.PNG,"image/jpg":c.j.JPG,"image/jpeg":c.j.JPG,"image/ktx":c.j.KTX_ETC2};function B(g){const v=g?.materialDefinitions?Object.keys(g.materialDefinitions)[0]:null,O=g?.textureDefinitions?Object.keys(g.textureDefinitions)[0]:null,w=v?g.materialDefinitions?.[v]:null,W=O?g.textureDefinitions?.[O]:null,T=fe();if(null!=w){const L=w.params;L.diffuse&&(T.metallicRoughness.baseColorFactor=[L.diffuse[0],L.diffuse[1],L.diffuse[2],1]),null!=L.doubleSided&&(T.doubleSided=L.doubleSided,T.cullFace=L.doubleSided?j.Vr.None:j.Vr.Back),"none"!==L.cullFace&&"front"!==L.cullFace&&"back"!==L.cullFace||(T.cullFace="none"===L.cullFace?j.Vr.None:"back"===L.cullFace?j.Vr.Back:j.Vr.Front),L.transparency&&(T.metallicRoughness.baseColorFactor[3]=(0,I.uZ)(1-L.transparency,0,1)),(L.useVertexColorAlpha||T.metallicRoughness.baseColorFactor[3]<1)&&(T.alphaMode="blend")}const ne=[];if(null!=W){!W.wrap||"repeat"!==W.wrap[0]&&"repeat"!==W.wrap[1]||(T.wrapTextures=!0);let _=c.v.Color;"rgba"===W.channels&&(T.alphaMode="blend",_|=c.v.AlphaMask);const b=W.images[W.images.length-1],A=G=>G?.split("/").pop(),Z=Array.isArray(W.encoding)?q(W.encoding.map((G,H)=>({name:A(b.href[H]),encoding:z[G]||0}))):[{name:A(b.href),encoding:z[W.encoding]||0}];ne.push({id:0,usage:_,encodings:Z}),T.metallicRoughness.baseColorTextureId=0}return{material:T,textures:ne}}const fe=()=>({alphaMode:"opaque",alphaCutoff:te.F,doubleSided:!0,cullFace:j.Vr.None,normalTextureId:-1,emissiveTextureId:-1,occlusionTextureId:-1,emissiveFactor:[0,0,0],metallicRoughness:{baseColorFactor:[.8,.8,.8,1],baseColorTextureId:-1,metallicRoughnessTextureId:-1,metallicFactor:0,roughnessFactor:.6},wrapTextures:!1,hasParametersFromSource:!0});function ue(g,v,O,w){if(null==g?.data)return null;const W=g.data,T=w.renderingContext.parameters.maxMaxAnisotropy,ne=T>1,L=O||!v.wrapTextures?oe:F,_=function y(g){switch(g){case c.j.KTX2:return j.Ti.KTX2_ENCODING;case c.j.Basis:return j.Ti.BASIS_ENCODING;case c.j.DDS_S3TC:return j.Ti.DDS_ENCODING;case c.j.PNG:return"image/png";case c.j.JPG:return"image/jpeg";case c.j.KTX_ETC2:return"image/ktx";default:return""}}(g.encoding);return new ie.x(W,{mipmap:ne,maxAnisotropy:T,encoding:_,wrap:L,components:g.usage&c.v.Color?"opaque"===v.alphaMode?3:4:3,noUnpackFlip:!0})}const oe={s:M.e8.CLAMP_TO_EDGE,t:M.e8.CLAMP_TO_EDGE},F={s:M.e8.REPEAT,t:M.e8.REPEAT};function J(g,v,O,w,W,T){const ne=T.rendererTextureUsage,L=se=>function Y(g,v,O){if(null==g||O===c.v.None)return null;for(let w=0;w<g.length;w++){const W=g[w];if(null!=W&&W.usage&O){const T=v[w];return null!=T?T.id:null}}return null}(w,O,se&ne),_=v.metallicRoughness.baseColorFactor,f=(0,I.uZ)(v.metallicRoughness.baseColorFactor[3],0,1);g.baseColor=[_[0],_[1],_[2],f],g.hasParametersFromSource=!!v.hasParametersFromSource,g.usePBR=T.usePBR,g.mrrFactors=[v.metallicRoughness.metallicFactor,v.metallicRoughness.roughnessFactor,v.hasParametersFromSource?k.yI[2]:k.ml[2]],g.emissiveFactor=v.emissiveFactor,g.isIntegratedMesh=T.isIntegratedMesh,g.textureAlphaCutoff="mask"===v.alphaMode?v.alphaCutoff:te.F,g.alphaDiscardMode="opaque"===v.alphaMode?j.JJ.Opaque:"mask"===v.alphaMode?j.JJ.Mask:j.JJ.MaskBlend;const b=[],A=L(c.v.Color|c.v.AlphaMask);null!=A&&(g.baseColorTexture=new he.T(W,A),b.push(g.baseColorTexture.loadPromise));const Z=L(c.v.MetallicRoughness);null!=Z&&(g.metallicRoughnessTexture=new he.T(W,Z),b.push(g.metallicRoughnessTexture.loadPromise));const G=L(c.v.Emissive);null!=G&&(g.emissionTexture=new he.T(W,G),b.push(g.emissionTexture.loadPromise));const H=L(c.v.Occlusion);null!=H&&(g.occlusionTexture=new he.T(W,H),b.push(g.occlusionTexture.loadPromise));const $=L(c.v.Normal);return null!=$&&(g.normalTexture=new he.T(W,$),b.push(g.normalTexture.loadPromise)),g.commonMaterialParameters.hasSlicePlane=T.slicePlaneEnabled,g.commonMaterialParameters.doubleSided=v.doubleSided,g.commonMaterialParameters.cullFace=v.cullFace,g.ellipsoidMode=(0,Q.j)(T.viewSpatialReference),Promise.all(b)}function ce(g){const v=!!g.compressedTextureS3TC,O=!!g.compressedTextureETC,w=(0,E.Z)("disable-feature:i3s-basis")?0:c.j.Basis|c.j.KTX2;return c.j.JPG|c.j.PNG|(v?w|c.j.DDS_S3TC:0)|(O?w:0)}function P(g,v){if(null!=v)return g.find(O=>0!=(O.encoding&v))}},52565:(De,le,l)=>{l.d(le,{$i:()=>te,FE:()=>M,Hw:()=>ie,NB:()=>ve,O4:()=>j,U_:()=>Q,oQ:()=>q,w5:()=>k});var Q,j,ie,k,M,S,E=l(1503),I=l(97126),c=l(42964),he=l(74993);class te extends he.r{constructor(z,B){super(NaN,NaN),this.id=z,this.serviceMbsInIndexSR=B,this.serviceMbsInRenderSR=(0,I.f)(0,0,0,-1)}invalidateServiceBVsInRenderSR(){(0,c.WD)(this.serviceMbsInRenderSR),this.serviceObbInRenderSR?.invalidate()}shareServiceBVsInRenderSRWith(z){this.serviceObbInRenderSR=z.serviceObbInRenderSR,this.serviceMbsInRenderSR=z.serviceMbsInRenderSR}}(S=Q||(Q={}))[S.Unmodified=0]="Unmodified",S[S.Culled=1]="Culled",S[S.NotChecked=2]="NotChecked",function(S){S[S.Unmodified=0]="Unmodified",S[S.PotentiallyModified=1]="PotentiallyModified",S[S.Culled=2]="Culled",S[S.Unknown=3]="Unknown",S[S.NotChecked=4]="NotChecked"}(j||(j={}));class ve extends te{constructor(z,B,fe,ue,oe,F,J,ce,P,Y){super(z,fe),this.index=B,this.childCount=ue,this.level=oe,this.resources=F,this.version=J,this.lodMetric=ce,this.maxError=P,this.numFeatures=Y,this.failed=!1,this.cacheState=ie.Unknown,this.vertexCount=0,this.memory=0,this.childrenLoaded=0,this.hasModifications=!1,this.imModificationImpact=j.NotChecked,this.elevationAgnosticBoundingVolume=(0,E.al)(0,0,0,-1)}invalidateServiceBVsInRenderSR(){super.invalidateServiceBVsInRenderSR(),this.elevationAgnosticBoundingVolume[3]=-1}}(function(S){S[S.Unknown=0]="Unknown",S[S.Uncached=1]="Uncached",S[S.Cached=2]="Cached"})(ie||(ie={})),function(S){S[S.None=0]="None",S[S.MaxScreenThreshold=1]="MaxScreenThreshold",S[S.ScreenSpaceRelative=2]="ScreenSpaceRelative",S[S.RemovedFeatureDiameter=3]="RemovedFeatureDiameter",S[S.DistanceRangeFromDefaultCamera=4]="DistanceRangeFromDefaultCamera"}(k||(k={})),function(S){S[S.Hole=0]="Hole",S[S.Leaf=1]="Leaf"}(M||(M={}));class q{constructor(z,B,fe,ue){this.nodeHasLOD=z,this.isChosen=B,this.lodLevel=fe,this.version=ue}}},39159:(De,le,l)=>{l.d(le,{v:()=>O});var E=l(15861),I=l(17626),c=l(84792),he=l(83761),te=l(85931),Q=l(59213),j=l(27306),ie=l(46160),k=l(54024),M=l(63290),ve=l(62208),q=l(10699),S=l(42763),z=l(32917),B=l(77712),ue=(l(8314),l(76898)),oe=l(37053),F=l(15348),J=l(24877),ce=l(3740),P=l(35560),Y=l(33899),y=l(59617),g=l(16446);const v="esri.views.3d.layers.i3s.I3SOverrides";let O=class extends he.Z{constructor(_){super(_),this._warnMaximumChangedObjectsExceeded=!1,this._maximumNumberOfEditOVerrides=T,this._original3DOFLDefinitionExpression=null,this._interactiveEditingSessions=new ie.Z,this.geometryOverrides=new ie.Z,this._clientGeometryCache=new Map,this._associatedLayerView=null,this._attributeChangedObjectIds=new S.Z,this._geometryChangedObjectIds=new S.Z,this._pendingFetchChangedObjectIds=null,this._pendingFetchAbortController=new AbortController,this._featureIdLocks=new Map}initialize(){this._memCache=this.memoryController.newCache(`i3s-attribute-overrides-${this.layer.uid}`),this._pendingFetchChangedObjectIds=this._fetchChangedObjectIds(this._pendingFetchAbortController?.signal),this._pendingFetchChangedObjectIds.finally(()=>{this._pendingFetchAbortController=null,this._pendingFetchChangedObjectIds=null}),this.is3DOFL&&null!=this._associatedLayer&&((0,P.Vi)()?this._associatedLayer.load().then(_=>{this.destroyed||(this._original3DOFLDefinitionExpression=_.definitionExpression,this.addHandles((0,z.YP)(()=>this._definitionExpression,f=>_.definitionExpression=f,z.nn)),this._associatedLayerView=new g.default({layer:this._associatedLayer,view:this.view}))}):(0,P.yA)())}destroy(){this.is3DOFL&&null!=this._associatedLayer&&((0,P.Vi)()?null!=this._associatedLayerView&&(this._associatedLayer.definitionExpression=this._original3DOFLDefinitionExpression):(0,P.yA)()),this._set("layer",null),this._memCache=(0,ve.SC)(this._memCache),this._pendingFetchAbortController=(0,ve.IM)(this._pendingFetchAbortController),this._pendingFetchChangedObjectIds=null,this._featureIdLocks.clear()}get is3DOFL(){return(0,P.Rx)()&&null!=this._associatedLayer?.infoFor3D}get sortedGeometryChangedObjectIds(){return this.is3DOFL?[...this._geometryChangedObjectIds].sort((_,f)=>_-f):[]}get _associatedLayer(){return null==this.layer?null:this.layer.associatedLayer}get hasGeometryChanges(){return this._geometryChangedObjectIds.size>0}get _definitionExpression(){const _=this.sortedGeometryChangedObjectIds;return 0===_.length?"1 = 0":`OBJECTID IN (${_.join(",")})`}get updating(){return!!this.is3DOFL&&(!!this._pendingFetchChangedObjectIds||!!(0,P.Vi)()&&(null==this._associatedLayerView||null!=this._associatedLayerView&&this._associatedLayerView.updating))}get isEmpty(){return null==this._pendingFetchChangedObjectIds&&0===this._attributeChangedObjectIds.size&&0===this._geometryChangedObjectIds.size}featureHasGeometryChanges(_){return this._geometryChangedObjectIds.has(_)}featureHasAttributeChanges(_){return this._attributeChangedObjectIds.has(_)}createInteractiveEditSession(_){this._attributeChangedObjectIds.add(_);const f=this._interactiveEditingSessions,b=new w(_,()=>{f.remove(b)});return f.unshift(b),b}applyAttributeOverrides(_,f,b,A=[]){var Z=this;return(0,E.Z)(function*(){if(Z._pendingFetchChangedObjectIds&&(yield(0,q.Hl)(Z._pendingFetchChangedObjectIds,b)),null==f)return;const{attributeData:G,loadedAttributes:H}=f;if(null==H||null==G||0===Z._attributeChangedObjectIds.size)return;const $=new Set;for(const X of H)$.add(X.index);for(const X of A)$.has(X.index)||(H.push(X),G[X.name]=new Array(_.length));const se=yield Z._lockFeatureIds(_);try{const X={attributeData:G,loadedAttributes:H},_e=Z._getOverridesFromCache(_,X,Z._attributeChangedObjectIds),{objectIds:re,fieldNames:xe}=_e;if(0===re.length||0===xe.length)return;const ae=yield Z._queryAttributeOverridesFromAssociatedLayer(re,xe,b);if(null==ae)return;Z._processOverridesFromAssociatedLayer(_,ae,xe,X)}finally{se.remove()}})()}updateGeometry(_,f){this._geometryChangedObjectIds.add(_);const b=this._clientGeometryCache.get(_);if(null!=b&&(this.geometryOverrides.remove(b),this._clientGeometryCache.delete(_)),null!=f){const A={oid:_,mesh:f};this.geometryOverrides.add(A),this._clientGeometryCache.set(_,A)}}updateAttributeValue(_,f,b){this._attributeChangedObjectIds.add(_),this._cacheAttributeValue(_,f,b)}featureAdded(_){this.is3DOFL&&(0,P.yA)()&&this._geometryChangedObjectIds.add(_),this._attributeChangedObjectIds.add(_)}_cacheAttributeValue(_,f,b){this._memCache.put(this._getAttributeCacheKey(_,f),b,this._memCacheAttributeValueSize(b))}_getOverridesFromCache(_,{loadedAttributes:f,attributeData:b},A){const Z=new Set,G=new Array;for(const $ of f)G[$.index]=b[$.name];const H=new Set;for(let $=0;$<_.length;$++){const se=_[$];if(A.has(se))for(const X of f){const _e=this._attributeFromCache(se,X.index);void 0===_e?(Z.add(se),H.add(X.name)):G[X.index][$]=_e}}return{objectIds:Array.from(Z),fieldNames:Array.from(H)}}_attributeFromCache(_,f){const b=this._fromInteractiveEditingSession(_,f);if(void 0!==b)return b;const A=this._getAttributeCacheKey(_,f);return this._memCache.get(A)}_fromInteractiveEditingSession(_,f){if(null!=this._interactiveEditingSessions)for(const b of this._interactiveEditingSessions){if(b.objectId!==_)continue;const A=b.getAttribute(f);if(void 0!==A)return A}}_getAttributeCacheKey(_,f){return`${_}-${f}`}_queryAttributeOverridesFromAssociatedLayer(_,f,b){var A=this;return(0,E.Z)(function*(){if(0===_.length)return null;A._logWarningIfMaximumObjectsExceeded();const{associatedLayer:Z}=A.layer;if(null==Z)return null;const G=Z.createQuery(),{objectIdField:H}=Z,$=[H,...f];G.where="1=1",G.returnGeometry=!1,G.outFields=$,G.cacheHint=!0;const se=yield A._executeBatchQuery(Z,_,G,b),X=[];for(const _e of se)if(_e.ok)for(const re of _e.value.features)X.push(re);return X})()}_queryGeometryOverridesFromAssociatedLayer(_,f){var b=this;return(0,E.Z)(function*(){if(0===_.length||!b.is3DOFL||!(0,P.yA)())return null;const A=b.layer.associatedLayer,Z=A.infoFor3D,{spatialReference:G}=A,{state:{viewingMode:H},spatialReference:$}=b.view,se=H===y.JY.Global,X=G.isGeographic;if(se&&!X)return M.Z.getLogger(v).warn("unsupported-pcs-edits-in-global-view",b.layer.title,L(G,$,b.view.viewingMode,ne.Mode)),null;if(!se&&X)return M.Z.getLogger(v).warn("unsupported-gcs-edits-in-local-view",b.layer.title,L(G,$,b.view.viewingMode,ne.Mode)),null;if(!((0,oe.fS)(G,$)||se&&$.isWebMercator&&G.isWGS84))return M.Z.getLogger(v).warn("unsupported-mismatched-spatial-reference-edits",b.layer.title,L(G,$,b.view.viewingMode,ne.SpatialReference)),null;b._logWarningIfMaximumObjectsExceeded();const{objectIdField:_e,globalIdField:re}=A,xe=[_e,...null!=re?[re]:[]],ae=A.createQuery();ae.where="1=1",ae.returnGeometry=!0,ae.outFields=xe,ae.cacheHint=!0,ae.returnZ=A.hasZ,ae.returnM=A.hasM;const Te=yield b._executeBatchQuery(A,_,ae,f),Ie=[];for(const Pe of Te){if(!Pe.ok)continue;const Ze=Pe.value,{assetMaps:He,features:Ne,globalIdFieldName:Me}=Ze;if(null==He)continue;const Je=(0,ce.assetMapFromAssetMapsJSON)(Z,He);for(const Ve of Ne){const Ye=(0,ce.extractMesh)(Ve,Me,G,Z,Je),je=Ve;null!=Ye?(je.geometry=Ye,Ie.push(je)):je.geometry=null}}return Ie})()}_logWarningIfMaximumObjectsExceeded(){if(!this._warnMaximumChangedObjectsExceeded)return;this._warnMaximumChangedObjectsExceeded=!1;let _=`The number of edited objects that are not yet cached in the scene service exceeds the maximum limit. Attribute changes will only be available for the first ${(0,F.uf)(this._maximumNumberOfEditOVerrides)} objects. Please consider re-caching the scene service`;const f=this.layer.portalItem;_+=f&&f.loaded?` (${f.portal.url}/home/item.html?id=${f.id}#settings)`:` (${this.layer.parsedUrl.path})`,M.Z.getLogger(v).warn("#queryOverrides()",this.layer.title,`${_}.`)}_executeBatchQuery(_,f,b,A){return(0,E.Z)(function*(){if(0===f.length)return[];const Z=(0,J.qo)(_);f=[...f].sort((H,$)=>H-$);const G=(0,te.vr)(f,Z).map(H=>{const $=b.clone();return $.objectIds=H,(0,Q.mt)((0,J.UK)(_,$,{signal:A}))});return Promise.all(G)})()}_processOverridesFromAssociatedLayer(_,f,b,{loadedAttributes:A,attributeData:Z}){const G=this._associatedLayer;if(null==G)return;const H=G.objectIdField,$=b.map(re=>(re in Z||(Z[re]=new Array(_.length)),Z[re])),se=new Map(A.map(re=>[re.name,re.index])),X=b.map(re=>se.get(re)),_e=new Map(Array.from(_,(re,xe)=>[re,xe]));for(const re of f){const xe=re.attributes[H];for(let ae=0;ae<b.length;ae++){const Te=X[ae],Ie=_e.get(xe),Pe=re.attributes[b[ae]];$[ae][Ie]=Pe,this._cacheAttributeValue(xe,Te,Pe)}}}_memCacheAttributeValueSize(_){return"string"==typeof _?(0,j.hH)(_):(0,j.G3)()}_fetchChangedObjectIds(_){var f=this;return(0,E.Z)(function*(){const b=f.layer;yield b.load({signal:_}),f._geometryChangedObjectIds.clear(),f._attributeChangedObjectIds.clear();const{associatedLayer:A}=b;if(null==A||!A.capabilities?.operations?.supportsChangeTracking)return;const Z=f._getFetchChangedObjectIdsServerGen();if(null==Z)return;const G=A.layerId,H=f.is3DOFL,$={f:"json",returnIdsOnly:!0,layers:`[${G}]`,returnUpdates:!0,returnDeletes:H,returnInserts:H,layerServerGens:JSON.stringify([{id:G,serverGen:Z}])};if(H){const X=A.infoFor3D;$.fieldsToCompare=JSON.stringify({fields:[...Object.values(X.transformFieldRoles),X.sourceHashField]})}const se=yield(0,Q.q6)((0,c.Z)(`${A.url}/extractChanges`,{method:"post",query:$,timeout:W,signal:_}));if(!se.ok&&(0,Y.q4)(se.error)){const X=f.layer.title;M.Z.getLogger(v).warn("extractChanges:timeout",X,`${X} could not obtain edited features that are not cached in the scene service. Display of features may not be up to date with the latest edits. Consider re-caching the scene service.`)}if(se.ok&&1===se.value.data?.edits?.length){const X=se.value.data.edits[0],_e=X?.objectIds,re=X?.fieldUpdates,xe=_e?.adds??[],ae=_e?.updates??[],Te=_e?.deletes??[],Ie=[...xe,...ae,...Te],Pe=H?[...xe,...re??ae,...Te]:[],Ze=Math.min(f._maximumNumberOfEditOVerrides,Ie.length);Ze<Ie.length&&(f._warnMaximumChangedObjectsExceeded=!0);const He=Ie.sort((Ne,Me)=>Ne-Me);for(let Ne=0;Ne<Ze;++Ne)f._attributeChangedObjectIds.add(He[Ne]);for(const Ne of Pe)f._geometryChangedObjectIds.add(Ne);if(f.is3DOFL&&(0,P.yA)()&&f._geometryChangedObjectIds.size>0){const Ne=yield f._queryGeometryOverridesFromAssociatedLayer(Array.from(f._geometryChangedObjectIds),_);if(null!=Ne)for(const Me of Ne)null!=Me.geometry&&f.updateGeometry(Me.attributes[A.objectIdField],Me.geometry)}}})()}_getFetchChangedObjectIdsServerGen(){const _=this.layer;if(null!=_.serviceUpdateTimeStamp?.lastUpdate)return _.serviceUpdateTimeStamp.lastUpdate;const f=_.associatedLayer;return null!=f?.serverGens?.minServerGen?f.serverGens.minServerGen:null}_lockFeatureIds(_){var f=this;return(0,E.Z)(function*(){const b=f._featureIdLocks;let A=!0;for(;A;){const H=new Array;for(const $ of _){const se=b.get($);se&&H.push(se)}0===H.length?A=!1:yield Promise.all(H)}const Z=(0,q.hh)(),G=Z.promise;for(const H of _)b.set(H,G);return(0,k.kB)(()=>{for(const H of _)b.delete(H);Z.resolve()})})()}get test(){const _=Array.from(this._attributeChangedObjectIds),b=this;return{changedObjectIds:_,pendingFetchChangedObjectIds:this._pendingFetchChangedObjectIds,get maximumNumberOfEditOVerrides(){return b._maximumNumberOfEditOVerrides},set maximumNumberOfEditOVerrides(A){b._maximumNumberOfEditOVerrides=A}}}};(0,I._)([(0,B.Cb)({constructOnly:!0})],O.prototype,"view",void 0),(0,I._)([(0,B.Cb)({constructOnly:!0})],O.prototype,"layer",void 0),(0,I._)([(0,B.Cb)({readOnly:!0})],O.prototype,"is3DOFL",null),(0,I._)([(0,B.Cb)()],O.prototype,"_interactiveEditingSessions",void 0),(0,I._)([(0,B.Cb)({readOnly:!0})],O.prototype,"sortedGeometryChangedObjectIds",null),(0,I._)([(0,B.Cb)({readOnly:!0})],O.prototype,"geometryOverrides",void 0),(0,I._)([(0,B.Cb)()],O.prototype,"_clientGeometryCache",void 0),(0,I._)([(0,B.Cb)()],O.prototype,"_associatedLayer",null),(0,I._)([(0,B.Cb)()],O.prototype,"_associatedLayerView",void 0),(0,I._)([(0,B.Cb)({constructOnly:!0})],O.prototype,"memoryController",void 0),(0,I._)([(0,B.Cb)()],O.prototype,"_attributeChangedObjectIds",void 0),(0,I._)([(0,B.Cb)()],O.prototype,"_geometryChangedObjectIds",void 0),(0,I._)([(0,B.Cb)()],O.prototype,"hasGeometryChanges",null),(0,I._)([(0,B.Cb)()],O.prototype,"_pendingFetchChangedObjectIds",void 0),(0,I._)([(0,B.Cb)()],O.prototype,"_pendingFetchAbortController",void 0),(0,I._)([(0,B.Cb)()],O.prototype,"_definitionExpression",null),(0,I._)([(0,B.Cb)()],O.prototype,"updating",null),(0,I._)([(0,B.Cb)()],O.prototype,"isEmpty",null),O=(0,I._)([(0,ue.j)(v)],O);class w{constructor(f,b){this.objectId=f,this._remove=b,this._updates=new Map,this._isActive=!0}getAttribute(f){return this._updates.get(f)}setAttribute(f,b){this.isActive&&this._updates.set(f,b)}remove(){this.isActive&&(this._isActive=!1,this._remove())}get isActive(){return this._isActive}}const W=1e4,T=5e4;var ne,_;function L(_,f,b,A){return`Displaying the edits of a SceneLayer with a${A===ne.Mode?_.isGeographic?" geographic ":" projected ":" "}spatial reference (wkid:${_.wkid}) in ${b} viewing mode${A===ne.SpatialReference?` with spatial reference (wkid:${f.wkid}) `:" "}is not supported. No geometry edits will be displayed for this layer.\nPlease consider re-caching the scene service or changing the ${A===ne.Mode?"viewing mode":"view spatial reference"} to display edits.`}(_=ne||(ne={}))[_.Mode=0]="Mode",_[_.SpatialReference=1]="SpatialReference"},81937:(De,le,l)=>{var E,I,c;l.d(le,{j:()=>E,v:()=>I}),(c=E||(E={}))[c.KTX2=1]="KTX2",c[c.Basis=2]="Basis",c[c.DDS_S3TC=4]="DDS_S3TC",c[c.PNG=8]="PNG",c[c.JPG=16]="JPG",c[c.KTX_ETC2=32]="KTX_ETC2",function(c){c[c.None=0]="None",c[c.Color=1]="Color",c[c.MetallicRoughness=2]="MetallicRoughness",c[c.Normal=4]="Normal",c[c.Occlusion=8]="Occlusion",c[c.Emissive=16]="Emissive",c[c.AlphaMask=32]="AlphaMask",c[c.ColorTextures=19]="ColorTextures",c[c.GeometryTextures=36]="GeometryTextures",c[c.GeometryTexturesPBR=44]="GeometryTexturesPBR",c[c.AllTextures=37]="AllTextures",c[c.AllTexturesPBR=63]="AllTexturesPBR"}(I||(I={}))},73683:(De,le,l)=>{var E,I;l.d(le,{B:()=>E}),(I=E||(E={}))[I.FadeIn=0]="FadeIn",I[I.FadeOut=1]="FadeOut"},52051:(De,le,l)=>{l.d(le,{T:()=>c});var E=l(62208),I=l(10699);class c{constructor(te,Q){this._textureRep=te,this.loadPromise=null,this._disposed=!1;const j=this._textureRep.acquire(Q);(0,I.y8)(j)?(j.then(ie=>{this._disposed?(0,E.RY)(ie):this._textureRef=ie}),this.loadPromise=j):this._textureRef=j}dispose(){this._textureRef=(0,E.RY)(this._textureRef),this._disposed=!0}get glTexture(){return null!=this._textureRef?this._textureRef.glTexture:null}}}}]);