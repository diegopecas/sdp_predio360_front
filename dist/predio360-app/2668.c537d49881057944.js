"use strict";(self.webpackChunkpredio360_app=self.webpackChunkpredio360_app||[]).push([[2668],{26268:(ge,Q,r)=>{r.d(Q,{Z:()=>j});var u=r(8314),w=r(39406),K=r(44589),$=r(8650),_=r(13382);const o=(A,p)=>A.key.level-p.key.level!=0?A.key.level-p.key.level:A.key.row-p.key.row!=0?A.key.row-p.key.row:A.key.col-p.key.col;class j extends K.Z{constructor(p){super(),this._tileInfoView=p}get requiresDedicatedFBO(){return!1}renderChildren(p){this.sortChildren(o),this.setStencilReference(p),super.renderChildren(p)}createRenderParams(p){const{state:I}=p,H=super.createRenderParams(p);return H.requiredLevel=this._tileInfoView.getClosestInfoForScale(I.scale).level,H.displayLevel=this._tileInfoView.tileInfo.scaleToZoom(I.scale),H}prepareRenderPasses(p){const I=super.prepareRenderPasses(p);return I.push(p.registerRenderPass({name:"stencil",brushes:[_.Z],drawPhase:w.jx.DEBUG|w.jx.MAP|w.jx.HIGHLIGHT,target:()=>this.getStencilTarget()})),(0,u.Z)("esri-tiles-debug")&&I.push(p.registerRenderPass({name:"tileInfo",brushes:[$.Z],drawPhase:w.jx.DEBUG,target:()=>this.children})),I}getStencilTarget(){return this.children}setStencilReference(p){let I=1;for(const H of this.children)H.stencilRef=I++}}},37384:(ge,Q,r)=>{r.d(Q,{y:()=>ue});var u=r(17626),w=r(46160),K=r(89726),$=r(26584),_=r(32917),o=r(77712),p=(r(90912),r(85931),r(76898)),I=r(1011),H=r(38093),ee=r(86810);let U=class extends ee.wq{get version(){return this.commitVersionProperties(),(this._get("version")||0)+1}};(0,u._)([(0,o.Cb)({readOnly:!0})],U.prototype,"version",null),U=(0,u._)([(0,p.j)("esri.views.layers.support.ClipArea")],U);const X=U;var R;let M=R=class extends X{constructor(O){super(O),this.type="rect",this.left=null,this.right=null,this.top=null,this.bottom=null}clone(){return new R({left:this.left,right:this.right,top:this.top,bottom:this.bottom})}commitVersionProperties(){this.commitProperty("left"),this.commitProperty("right"),this.commitProperty("top"),this.commitProperty("bottom")}};(0,u._)([(0,o.Cb)({type:[Number,String],json:{write:!0}})],M.prototype,"left",void 0),(0,u._)([(0,o.Cb)({type:[Number,String],json:{write:!0}})],M.prototype,"right",void 0),(0,u._)([(0,o.Cb)({type:[Number,String],json:{write:!0}})],M.prototype,"top",void 0),(0,u._)([(0,o.Cb)({type:[Number,String],json:{write:!0}})],M.prototype,"bottom",void 0),M=R=(0,u._)([(0,p.j)("esri.views.layers.support.ClipRect")],M);const le=M;r(29132);var k,Z=r(21674),te=r(91179),oe=r(2004),he=r(37118);const de={base:Z.Z,key:"type",typeMap:{extent:oe.Z,polygon:he.Z}};let G=k=class extends X{constructor(O){super(O),this.type="geometry",this.geometry=null}clone(){return new k({geometry:this.geometry?.clone()??null})}commitVersionProperties(){this.commitProperty("geometry")}};(0,u._)([(0,o.Cb)({types:de,json:{read:te.im,write:!0}})],G.prototype,"geometry",void 0),G=k=(0,u._)([(0,p.j)("esri.views.layers.support.Geometry")],G);const ce=G;let W=class extends X{constructor(O){super(O),this.type="path",this.path=[]}commitVersionProperties(){this.commitProperty("path")}};(0,u._)([(0,o.Cb)({type:[[[Number]]],json:{write:!0}})],W.prototype,"path",void 0),W=(0,u._)([(0,p.j)("esri.views.layers.support.Path")],W);const J=w.Z.ofType({key:"type",base:null,typeMap:{rect:le,path:W,geometry:ce}}),ue=O=>{let b=class extends O{constructor(){super(...arguments),this.attached=!1,this.clips=new J,this.lastUpdateId=-1,this.moving=!1,this.updateRequested=!1,this.visibleAtCurrentScale=!1,this.highlightOptions=null}initialize(){this.view?.spatialReference&&(this.view?.spatialReferenceLocked??1)&&!this.spatialReferenceSupported?this.addResolvingPromise(Promise.reject(new $.Z("layerview:spatial-reference-incompatible","The spatial reference of this layer does not meet the requirements of the view",{layer:this.layer}))):(this.container||(this.container=new I.W),this.container.fadeTransitionEnabled=!0,this.container.visible=!1,this.container.endTransitions(),this.addHandles([(0,_.YP)(()=>this.suspended,m=>{this.container&&(this.container.visible=!m),this.view&&!m&&this.updateRequested&&this.view.requestUpdate()},_.tX),(0,_.YP)(()=>this.layer?.opacity??1,m=>{this.container&&(this.container.opacity=m)},_.tX),(0,_.YP)(()=>this.layer&&"blendMode"in this.layer?this.layer.blendMode:"normal",m=>{this.container&&(this.container.blendMode=m)},_.tX),(0,_.YP)(()=>this.layer&&"effect"in this.layer?this.layer.effect:null,m=>{this.container&&(this.container.effect=m)},_.tX),(0,_.YP)(()=>this.highlightOptions,m=>this.container.highlightOptions=m,_.tX),(0,_.on)(()=>this.clips,"change",()=>{this.container&&(this.container.clips=this.clips)},_.tX),(0,_.YP)(()=>({scale:this.view?.scale,scaleRange:this.layer&&"effectiveScaleRange"in this.layer?this.layer.effectiveScaleRange:null}),({scale:m})=>{const F=null!=m&&this.isVisibleAtScale(m);F!==this.visibleAtCurrentScale&&this._set("visibleAtCurrentScale",F)},_.tX)],"constructor"),this.view?.whenLayerView?this.view.whenLayerView(this.layer).then(m=>{m===this&&this.processAttach()},()=>{}):this.when().then(()=>{this.processAttach()},()=>{}))}destroy(){this.processDetach(),this.updateRequested=!1}get spatialReferenceSupported(){const C=this.view?.spatialReference;return null==C||this.supportsSpatialReference(C)}get updating(){return this.spatialReferenceSupported&&(!this.attached||!this.suspended&&(this.updateRequested||this.isUpdating())||!!this.updatingHandles?.updating)}processAttach(){this.isResolved()&&!this.attached&&!this.destroyed&&this.spatialReferenceSupported&&(this.attach(),this.attached=!0,this.requestUpdate())}processDetach(){this.attached&&(this.attached=!1,this.removeHandles("attach"),this.detach(),this.updateRequested=!1)}isVisibleAtScale(C){const f=this.layer&&"effectiveScaleRange"in this.layer?this.layer.effectiveScaleRange:null;if(!f)return!0;const{minScale:m,maxScale:F}=f;return(0===m||C<=m)&&(0===F||C>=F)}requestUpdate(){this.destroyed||this.updateRequested||(this.updateRequested=!0,this.suspended||this.view.requestUpdate())}processUpdate(C){!this.isFulfilled()||this.isResolved()?(this._set("updateParameters",C),this.updateRequested&&!this.suspended&&(this.updateRequested=!1,this.update(C))):this.updateRequested=!1}hitTest(C,f){return Promise.resolve(null)}supportsSpatialReference(C){return!0}canResume(){return!!this.spatialReferenceSupported&&!!super.canResume()&&this.visibleAtCurrentScale}getSuspendInfo(){const C=super.getSuspendInfo(),f=!this.spatialReferenceSupported,m=this.visibleAtCurrentScale;return f&&(C.spatialReferenceNotSupported=f),m&&(C.outsideScaleRange=m),C}addAttachHandles(C){this.addHandles(C,"attach")}};return(0,u._)([(0,o.Cb)()],b.prototype,"attached",void 0),(0,u._)([(0,o.Cb)({type:J,set(C){const f=(0,K.Z)(C,this._get("clips"),J);this._set("clips",f)}})],b.prototype,"clips",void 0),(0,u._)([(0,o.Cb)()],b.prototype,"container",void 0),(0,u._)([(0,o.Cb)()],b.prototype,"moving",void 0),(0,u._)([(0,o.Cb)({readOnly:!0})],b.prototype,"spatialReferenceSupported",null),(0,u._)([(0,o.Cb)({readOnly:!0})],b.prototype,"updateParameters",void 0),(0,u._)([(0,o.Cb)()],b.prototype,"updateRequested",void 0),(0,u._)([(0,o.Cb)()],b.prototype,"updating",null),(0,u._)([(0,o.Cb)()],b.prototype,"view",void 0),(0,u._)([(0,o.Cb)({readOnly:!0})],b.prototype,"visibleAtCurrentScale",void 0),(0,u._)([(0,o.Cb)({type:H.Z})],b.prototype,"highlightOptions",void 0),b=(0,u._)([(0,p.j)("esri.views.2d.layers.LayerView2D")],b),b}},92668:(ge,Q,r)=>{r.r(Q),r.d(Q,{default:()=>Ue});var u=r(15861),w=r(17626),K=r(88879),$=r(58817),_=r(63290),o=r(62208),j=r(10699),A=r(32917),p=r(77712),H=(r(90912),r(76898)),ee=r(84682),U=r(65401),X=r(37053),R=r(919),M=r(63631),le=r(93961),ne=r(84378),Z=r(58098);const he=(s,e)=>s+1/(1<<2*e);class k{constructor(e,t){this._tiles=new Map,this._tileCache=new le.Z(40,i=>i.dispose()),this._viewSize=[0,0],this._visibleTiles=new Map,this.acquireTile=e.acquireTile,this.releaseTile=e.releaseTile,this.tileInfoView=e.tileInfoView,this._container=t}destroy(){for(const[e,t]of this._tiles)t.dispose();this._tiles=null,this._tileCache.clear(),this._tileCache=null}update(e){this._updateCacheSize(e);const t=this.tileInfoView,i=t.getTileCoverage(e.state,0,"smallest"),{spans:a,lodInfo:n}=i,{level:c}=n,l=this._tiles,g=new Set,h=new Set;for(const{row:d,colFrom:v,colTo:D}of a)for(let E=v;E<=D;E++){const x=Z.Z.getId(c,d,n.normalizeCol(E),n.getWorldForColumn(E)),P=this._getOrAcquireTile(x);g.add(x),P.processed()?this._addToContainer(P):h.add(new Z.Z(x))}for(const[d,v]of l)v.isCoverage=g.has(d);for(const d of h)this._findPlaceholdersForMissingTiles(d,g);let y=!1;for(const[d,v]of l)v.neededForCoverage=g.has(d),v.neededForCoverage||v.isHoldingForFade&&t.intersects(i,v.key)&&g.add(d),v.isFading&&(y=!0);for(const[d,v]of this._tiles)g.has(d)||this._releaseTile(d);return ne.Z.pool.release(i),!y}clear(){this._tiles.clear(),this._tileCache.clear(),this._visibleTiles.clear()}clearCache(){this._tileCache.clear()}_findPlaceholdersForMissingTiles(e,t){const i=[];for(const[n,c]of this._tiles)this._addPlaceholderChild(i,c,e,t);const a=i.reduce(he,0);Math.abs(1-a)<1e-6||this._addPlaceholderParent(e.id,t)}_addPlaceholderChild(e,t,i,a){t.key.level<=i.level||!t.hasData()||function G(s,e){const t=e.level-s.level;return s.row===e.row>>t&&s.col===e.col>>t&&s.world===e.world}(i,t.key)&&(this._addToContainer(t),a.add(t.id),e.push(t.key.level-i.level))}_addPlaceholderParent(e,t){const i=this._tiles;let a=e;for(;;){if(a=de(a),!a||t.has(a))return;const n=i.get(a);if(n&&n.hasData())return this._addToContainer(n),void t.add(n.id)}}_getOrAcquireTile(e){let t=this._tiles.get(e);return t||(t=this._tileCache.pop(e),t||(t=this.acquireTile(new Z.Z(e))),this._tiles.set(e,t),t)}_releaseTile(e){const t=this._tiles.get(e);this.releaseTile(t),this._removeFromContainer(t),this._tiles.delete(e),t.hasData()?this._tileCache.put(e,t,1):t.dispose()}_addToContainer(e){let t;const i=[],a=this._container;if(a.contains(e))return;const n=this._visibleTiles;for(const[c,l]of n)this._canConnectDirectly(e,l)&&i.push(l),(0,o.Wi)(t)&&this._canConnectDirectly(l,e)&&(t=l);if((0,o.pC)(t)){for(const c of i)t.childrenTiles.delete(c),e.childrenTiles.add(c),c.parentTile=e;t.childrenTiles.add(e),e.parentTile=t}else for(const c of i)e.childrenTiles.add(c),c.parentTile=e;n.set(e.id,e),a.addChild(e)}_removeFromContainer(e){if(this._visibleTiles.delete(e.id),this._container.removeChild(e),(0,o.pC)(e.parentTile)){e.parentTile.childrenTiles.delete(e);for(const t of e.childrenTiles)(0,o.pC)(e.parentTile)&&e.parentTile.childrenTiles.add(t)}for(const t of e.childrenTiles)t.parentTile=e.parentTile;e.parentTile=null,e.childrenTiles.clear()}_canConnectDirectly(e,t){const i=e.key;let{level:a,row:n,col:c,world:l}=t.key;const g=this._visibleTiles;for(;a>0;){if(a--,n>>=1,c>>=1,i.level===a&&i.row===n&&i.col===c&&i.world===l)return!0;if(g.has(`${a}/${n}/${c}/${l}`))return!1}return!1}_updateCacheSize(e){const t=e.state.size;if(t[0]===this._viewSize[0]&&t[1]===this._viewSize[1])return;const i=Math.ceil(t[0]/512)+1,a=Math.ceil(t[1]/512)+1;this._viewSize[0]=t[0],this._viewSize[1]=t[1],this._tileCache.maxSize=5*i*a}}function de(s){const[e,t,i,a]=s.split("/"),n=parseInt(e,10);return 0===n?null:`${n-1}/${parseInt(t,10)>>1}/${parseInt(i,10)>>1}/${parseInt(a,10)}`}var ce=r(40022),W=r(61885),se=r(47132),J=r(51200),ue=r(78224),O=r(12378),b=r(59047),C=r(76763),f=r(1268);const F=1e-6;class Se extends W.Z{constructor(e,t){super(),this.styleRepository=e,this._tileToHandle=new Map,this._viewState={scale:0,rotation:0,center:[0,0],size:[0,0]},this._declutterViewState={scale:0,rotation:0,center:[0,0],size:[0,0]},this._completed=!1,this._symbolRepository=new b.L(4096,t,()=>new J.J),this._symbolDeclutterer=new O.g(t,this._symbolRepository,(i,a,n)=>new ue.f(i,a,n,this.styleRepository,this._zoom,this._viewState.rotation),(i,a)=>{i.allSymbolsFadingOut=!0,i.lastOpacityUpdate=a,(0,C.C$)(i,a,!0),i.decluttered=!0,i.requestRender()},(i,a)=>this.styleRepository.getStyleLayerByUID(i.styleLayerUID).z-this.styleRepository.getStyleLayerByUID(a.styleLayerUID).z,i=>{const a=this.styleRepository.getStyleLayerByUID(i);if(this._zoom+F<a.minzoom||this._zoom-F>=a.maxzoom)return!1;const n=a.getLayoutProperty("visibility");return!n||n.getValue()!==f.EE.NONE})}addTile(e){e.decluttered=!1,this._tileToHandle.set(e,e.on("symbols-changed",()=>{this._symbolRepository.add(e),this.restartDeclutter()})),this._symbolRepository.add(e),this.restartDeclutter()}removeTile(e){const t=this._tileToHandle.get(e);t&&(this._symbolRepository.removeTile(e),this.restartDeclutter(),t.remove(),this._tileToHandle.delete(e))}update(e,t){return this._zoom=e,this._viewState={scale:t.scale,rotation:t.rotation,center:[t.center[0],t.center[1]],size:[t.size[0],t.size[1]]},this._continueDeclutter(),this._completed}restartDeclutter(){this._completed=!1,this._symbolDeclutterer.restart(),this._notifyUnstable()}clear(){this._completed=!1,this._symbolRepository=null,this._symbolDeclutterer.restart(),this._tileToHandle.forEach(e=>e.remove()),this._tileToHandle.clear()}get stale(){return this._zoom!==this._declutterZoom||this._viewState.size[0]!==this._declutterViewState.size[0]||this._viewState.size[1]!==this._declutterViewState.size[1]||this._viewState.scale!==this._declutterViewState.scale||this._viewState.rotation!==this._declutterViewState.rotation}deleteStyleLayers(e){this._symbolRepository.deleteStyleLayers(e)}_continueDeclutter(){this._completed&&!this.stale||(this._symbolDeclutterer.running||(this._declutterZoom=this._zoom,this._declutterViewState.center[0]=this._viewState.center[0],this._declutterViewState.center[1]=this._viewState.center[1],this._declutterViewState.rotation=this._viewState.rotation,this._declutterViewState.scale=this._viewState.scale,this._declutterViewState.size[0]=this._viewState.size[0],this._declutterViewState.size[1]=this._viewState.size[1],this._symbolDeclutterer.restart()),this._symbolDeclutterer.setScreenSize(this._viewState.size[0],this._viewState.size[1]),this._completed=this._symbolDeclutterer.continue(se.Ts),this._completed&&this._scheduleNotifyStable())}_scheduleNotifyStable(){(0,o.pC)(this._stableNotificationHandle)&&clearTimeout(this._stableNotificationHandle),this._stableNotificationHandle=setTimeout(()=>{this._stableNotificationHandle=null,this.emit("fade-complete")},1.5*se.nN)}_notifyUnstable(){(0,o.pC)(this._stableNotificationHandle)&&(clearTimeout(this._stableNotificationHandle),this._stableNotificationHandle=null),this.emit("fade-start")}}var N=r(39406),ye=r(49966),Re=r(43783);class be extends Re.I{_createTransforms(){return{dvs:(0,ye.c)(),tileMat3:(0,ye.c)()}}}var De=r(26268),T=r(67969);const ie=1e-6;function me(s,e){if(s){const t=s.getLayoutProperty("visibility");if(!t||t.getValue()!==f.EE.NONE&&(void 0===s.minzoom||s.minzoom<e+ie)&&(void 0===s.maxzoom||s.maxzoom>=e-ie))return!0}return!1}class Pe extends De.Z{constructor(e){super(e),this._backgroundTiles=[],this._pointToCallbacks=new Map}destroy(){this.removeAllChildren(),this._spriteMosaic?.dispose(),this._spriteMosaic=null,this._glyphMosaic?.dispose(),this._glyphMosaic=null,(0,o.pC)(this._symbolFader)&&(this._symbolFader.clear(),this._symbolFader=null),this._styleRepository=null,this._backgroundTiles=[],this._pointToCallbacks.clear()}setStyleResources(e,t,i){if(this._spriteMosaic=e,this._glyphMosaic=t,this._styleRepository=i,(0,o.Wi)(this._symbolFader)){const a=new Se(this._styleRepository,this.children);a.on("fade-start",()=>{this.emit("fade-start"),this.requestRender()}),a.on("fade-complete",()=>{this.emit("fade-complete"),this.requestRender()}),this._symbolFader=a}(0,o.Wg)(this._symbolFader).styleRepository=i}setSpriteMosaic(e){this._spriteMosaic?.dispose(),this._spriteMosaic=e}deleteStyleLayers(e){(0,o.pC)(this._symbolFader)&&this._symbolFader.deleteStyleLayers(e)}hitTest(e){var t=this;return(0,u.Z)(function*(){const i=(0,j.hh)();return t._pointToCallbacks.set(e,i),t.requestRender(),i.promise})()}enterTileInvalidation(){for(const e of this.children)e.invalidating=!0}createRenderParams(e){return{...super.createRenderParams(e),renderPass:null,styleLayer:null,styleLayerUID:-1,glyphMosaic:this._glyphMosaic,spriteMosaic:this._spriteMosaic,hasClipping:!!this._clippingInfos}}doRender(e){!this.visible||e.drawPhase!==N.jx.MAP&&e.drawPhase!==N.jx.DEBUG||void 0===this._spriteMosaic||super.doRender(e)}addChild(e){return super.addChild(e),(0,o.pC)(this._symbolFader)?this._symbolFader.addTile(e):e.decluttered=!0,this.requestRender(),e}removeChild(e){return(0,o.pC)(this._symbolFader)&&this._symbolFader.removeTile(e),this.requestRender(),super.removeChild(e)}renderChildren(e){const{drawPhase:t}=e;if(t!==N.jx.DEBUG){if(this._doRender(e),this._pointToCallbacks.size>0){e.drawPhase=N.jx.HITTEST;const i=e.painter.effects.hittestVTL;i.bind(e),this._doRender(e),i.draw(e,this._pointToCallbacks),i.unbind(e),e.drawPhase=t}}else super.renderChildren(e)}removeAllChildren(){for(let e=0;e<this.children.length;e++){const t=this.children[e];(0,o.pC)(this._symbolFader)&&this._symbolFader.removeTile(t),t.dispose()}super.removeAllChildren()}getStencilTarget(){return this.children.filter(e=>e.neededForCoverage&&e.hasData())}restartDeclutter(){(0,o.pC)(this._symbolFader)&&this._symbolFader.restartDeclutter()}_doRender(e){const{context:t}=e,i=this._styleRepository;if(!i)return;const a=i.layers;let n=!0;e.drawPhase===N.jx.HITTEST&&(n=!1),i.backgroundBucketIds.length>0&&(e.renderPass="background",this._renderBackgroundLayers(e,i.backgroundBucketIds)),super.renderChildren(e),e.drawPhase===N.jx.MAP&&this._fade(e.displayLevel,e.state);const c=this.children.filter(l=>l.visible&&l.hasData());if(!c||0===c.length)return t.bindVAO(),t.setStencilTestEnabled(!0),void t.setBlendingEnabled(!0);for(const l of c)l.triangleCount=0;t.setStencilWriteMask(0),t.setColorMask(!0,!0,!0,!0),t.setStencilOp(T.xS.KEEP,T.xS.KEEP,T.xS.REPLACE),t.setStencilTestEnabled(!0),t.setBlendingEnabled(!1),t.setDepthTestEnabled(!0),t.setDepthWriteEnabled(!0),t.setDepthFunction(T.wb.LEQUAL),t.setClearDepth(1),t.clear(t.gl.DEPTH_BUFFER_BIT),e.renderPass="opaque";for(let l=a.length-1;l>=0;l--)this._renderStyleLayer(a[l],e,c);t.setDepthWriteEnabled(!1),t.setBlendingEnabled(n),t.setBlendFunctionSeparate(T.zi.ONE,T.zi.ONE_MINUS_SRC_ALPHA,T.zi.ONE,T.zi.ONE_MINUS_SRC_ALPHA),e.renderPass="translucent";for(let l=0;l<a.length;l++)this._renderStyleLayer(a[l],e,c);t.bindVAO(),t.setStencilTestEnabled(!0),t.setBlendingEnabled(!0)}_fade(e,t){(0,o.pC)(this._symbolFader)&&(this._symbolFader.update(e,t)||this.requestRender())}_renderStyleLayer(e,t,i){const{painter:a,renderPass:n}=t;if(void 0===e)return;const c=e.getLayoutProperty("visibility");if(c&&c.getValue()===f.EE.NONE)return;let l;switch(e.type){case f.fR.BACKGROUND:return;case f.fR.FILL:if("opaque"!==n&&"translucent"!==t.renderPass)return;l="vtlFill";break;case f.fR.LINE:if("translucent"!==n)return;l="vtlLine";break;case f.fR.CIRCLE:if("translucent"!==n)return;l="vtlCircle";break;case f.fR.SYMBOL:if("translucent"!==n)return;l="vtlSymbol"}if(i=i.filter(e.type===f.fR.SYMBOL?h=>h.decluttered:h=>h.neededForCoverage),"vtlSymbol"!==l){const h=t.displayLevel;if(0===i.length||void 0!==e.minzoom&&e.minzoom>=h+ie||void 0!==e.maxzoom&&e.maxzoom<h-ie)return}const g=e.uid;t.styleLayerUID=g,t.styleLayer=e;for(const h of i)if(h.layerData.has(g)){a.renderObjects(t,i,l);break}}_renderBackgroundLayers(e,t){const{context:i,displayLevel:a,painter:n,state:c}=e,l=this._styleRepository;let g=!1;for(const L of t)if(l.getLayerById(L).type===f.fR.BACKGROUND&&me(l.getLayerById(L),a)){g=!0;break}if(!g)return;const h=this._tileInfoView.getTileCoverage(e.state,0,"smallest"),{spans:y,lodInfo:d}=h,{level:v}=d,D=(0,U.Ue)(),E=[];if(this._renderPasses){const L=this._renderPasses[0];(0,o.pC)(this._clippingInfos)&&(L.brushes[0].prepareState(e),L.brushes[0].drawMany(e,this._clippingInfos))}const x=this._backgroundTiles;let P,q=0;for(const{row:L,colFrom:V,colTo:Y}of y)for(let B=V;B<=Y;B++){if(q<x.length)P=x[q],P.key.set(v,L,d.normalizeCol(B),d.getWorldForColumn(B)),this._tileInfoView.getTileBounds(D,P.key,!1),P.x=D[0],P.y=D[3],P.resolution=this._tileInfoView.getTileResolution(v);else{const ae=new Z.Z(v,L,d.normalizeCol(B),d.getWorldForColumn(B)),S=this._tileInfoView.getTileBounds((0,U.Ue)(),ae),Fe=this._tileInfoView.getTileResolution(v);P=new be(ae,Fe,S[0],S[3],512,512,4096,4096),x.push(P)}P.setTransform(c),E.push(P),q++}i.setStencilWriteMask(0),i.setColorMask(!0,!0,!0,!0),i.setStencilOp(T.xS.KEEP,T.xS.KEEP,T.xS.REPLACE),i.setStencilFunction(T.wb.EQUAL,0,255);let re=!0;e.drawPhase===N.jx.HITTEST&&(re=!1),i.setStencilTestEnabled(re);for(const L of t){const V=l.getLayerById(L);V.type===f.fR.BACKGROUND&&me(V,a)&&(e.styleLayerUID=V.uid,e.styleLayer=V,n.renderObjects(e,E,"vtlBackground"))}ne.Z.pool.release(h)}}var Ce=r(78364),Ee=r(37384),pe=r(30217),_e=r(83994),we=(r(85775),r(85931),r(8314),r(68598),r(57596),r(20194),r(55086),r(49353)),Le=r(57477);const Ae={geometry:[new(r(40852).G)("a_PositionAndFlags",3,T.g.SHORT,0,6)]},fe=new Map;fe.set("a_PositionAndFlags",0);const He={vsPath:"debug/overlay",fsPath:"debug/overlay",attributes:fe};class ve extends Le.s{constructor(e){super(),this._conf=e}static makeFlags(e,t){return e|t<<2}_createTransforms(){return{dvs:(0,ye.c)()}}doRender(e){this._updateTransforms(e),this._ensureResources(e);const{context:t}=e;t.useProgram(this._program),this._program.setUniformMatrix3fv("u_dvsMat3",this.transforms.dvs),this._program.setUniform4fv("u_colors",this._conf.getColors(e)),this._program.setUniform1fv("u_opacities",this._conf.getOpacities(e));const{vertexData:i,indexData:a}=this._conf.getMesh(e);this._vertexBuffer.setData(i),this._indexBuffer.setData(a),t.bindVAO(this._vertexArray),t.setBlendingEnabled(!0),t.setBlendFunction(T.zi.ONE,T.zi.ONE_MINUS_SRC_ALPHA),t.setDepthTestEnabled(!1),t.setStencilTestEnabled(!1),t.setColorMask(!0,!0,!0,!0),t.drawElements(T.MX.TRIANGLES,a.length,T.g.UNSIGNED_INT,0)}onDetach(){this._vertexArray=(0,o.M2)(this._vertexArray)}_updateTransforms(e){(0,pe.g)(this.transforms.dvs),(0,pe.h)(this.transforms.dvs,this.transforms.dvs,[-1,1]),(0,pe.d)(this.transforms.dvs,this.transforms.dvs,[2/e.state.size[0],-2/e.state.size[1],1])}_ensureResources(e){const{context:t}=e;this._program||(this._program=e.painter.materialManager.getProgram(He)),this._vertexBuffer||(this._vertexBuffer=_e.f.createVertex(t,T.l1.STREAM_DRAW)),this._indexBuffer||(this._indexBuffer=_e.f.createIndex(t,T.l1.STREAM_DRAW)),this._vertexArray||(this._vertexArray=new we.U(t,fe,Ae,{geometry:this._vertexBuffer},this._indexBuffer))}}var Me=r(92862),Te=r(8480),Oe=r(45611);let z=class extends((0,Ee.y)(Oe.Z)){constructor(){super(...arguments),this._styleChanges=[],this._fetchQueue=null,this._parseQueue=null,this._tileHandlerPromise=null,this._isTileHandlerReady=!1,this._collisionOverlay=null,this.fading=!1,this._getCollidersMesh=s=>{const{pixelRatio:e}=s.state;let t=0;const i=[],a=[];for(const n of this._vectorTileContainer.children)if(n.symbols)for(const[c,l]of n.symbols)for(const g of l)for(const h of g.colliders){const y=(h.xScreen+h.dxScreen)*e,d=(h.yScreen+h.dyScreen)*e,v=h.width*e,D=h.height*e,E=g.unique.parts[h.partIndex].targetOpacity>.5;if(!E&&"all"!==this.layer.showCollisionBoxes)continue;const x=3,P=1,q=3,re=0,Y=ve.makeFlags(E?2:0,E?3:0);i.push(y,d,Y,y+v,d,Y,y,d+D,Y,y+v,d+D,Y),a.push(t+0,t+1,t+2,t+1,t+3,t+2),t+=4;const S=ve.makeFlags(E?x:P,E?q:re);i.push(y,d,S,y+v,d,S,y,d+1,S,y+v,d+1,S),a.push(t+0,t+1,t+2,t+1,t+3,t+2),t+=4,i.push(y,d+D-1,S,y+v,d+D-1,S,y,d+D,S,y+v,d+D,S),a.push(t+0,t+1,t+2,t+1,t+3,t+2),t+=4,i.push(y,d,S,y+1,d,S,y,d+D,S,y+1,d+D,S),a.push(t+0,t+1,t+2,t+1,t+3,t+2),t+=4,i.push(y+v-1,d,S,y+v,d,S,y+v-1,d+D,S,y+v,d+D,S),a.push(t+0,t+1,t+2,t+1,t+3,t+2),t+=4}return{vertexData:new Int16Array(i),indexData:new Uint32Array(a)}},this._getCollidersColors=()=>[1,.5,0,1,1,0,0,1,0,1,.5,1,0,.5,0,1],this._getCollidersOpacities=()=>[.05,.01,.15,.2]}hitTest(s,e){var t=this;return(0,u.Z)(function*(){if(!t._tileHandlerPromise)return null;yield t._tileHandlerPromise;const i=yield t._vectorTileContainer.hitTest(e);if(!i||0===i.length)return null;const a=i[0]-1,n=t._styleRepository,c=n.getStyleLayerByUID(a);if(!c)return null;const l=n.getStyleLayerIndex(c.id);return[{type:"graphic",mapPoint:s,layer:t.layer,graphic:new K.Z({attributes:{layerId:l,layerName:c.id,layerUID:a},layer:t.layer,sourceLayer:t.layer})}]})()}update(s){if(this._tileHandlerPromise&&this._isTileHandlerReady)return s.pixelRatio!==this._tileHandler.devicePixelRatio?(this._start(),void(this._tileHandler.devicePixelRatio=s.pixelRatio)):void(this._styleChanges.length>0?this._tileHandlerPromise=this._applyStyleChanges():(this._fetchQueue.pause(),this._parseQueue.pause(),this._fetchQueue.state=s.state,this._parseQueue.state=s.state,this._tileManager.update(s)||this.requestUpdate(),this._parseQueue.resume(),this._fetchQueue.resume()))}attach(){const{style:s}=this.layer.currentStyleInfo;this._styleRepository=new Ce.Z(s),this._tileInfoView=new Me.Z(this.layer.tileInfo,this.layer.fullExtent),this._vectorTileContainer=new Pe(this._tileInfoView),this._tileHandler=new M.m(this.layer,this._styleRepository,window.devicePixelRatio||1),this.container.addChild(this._vectorTileContainer),this._start(),this.addAttachHandles([this._vectorTileContainer.on("fade-start",()=>{this.fading=!0,this.notifyChange("updating"),this.requestUpdate()}),this._vectorTileContainer.on("fade-complete",()=>{this._collisionOverlay?.requestRender(),this.fading=!1,this.notifyChange("updating"),this.requestUpdate()}),(0,A.YP)(()=>this.layer.showCollisionBoxes,e=>{"none"!==e?this._collisionOverlay||(this._collisionOverlay=new ve({getMesh:this._getCollidersMesh,getColors:this._getCollidersColors,getOpacities:this._getCollidersOpacities}),this.container.addChild(this._collisionOverlay)):this._collisionOverlay&&(this.container.removeChild(this._collisionOverlay),this._collisionOverlay=null),this.container.requestRender()},A.nn),this.layer.on("paint-change",e=>{if(e.isDataDriven)this._styleChanges.push({type:R.Fr.PAINTER_CHANGED,data:e}),this.notifyChange("updating"),this.requestUpdate();else{const t=this._styleRepository,i=t.getLayerById(e.layer);if(!i)return;const a=i.type===f.fR.SYMBOL;t.setPaintProperties(e.layer,e.paint),a&&this._vectorTileContainer.restartDeclutter(),this._vectorTileContainer.requestRender()}}),this.layer.on("layout-change",e=>{const t=this._styleRepository,i=t.getLayerById(e.layer);if(!i)return;const a=(0,ee.Hg)(i.layout,e.layout);if(!(0,o.Wi)(a)){if((0,ee.uD)(a,"visibility")&&1===function xe(s){if((0,o.Wi)(s))return 0;switch(s.type){case"partial":return Object.keys(s.diff).length;case"complete":return Math.max(Object.keys(s.oldValue).length,Object.keys(s.newValue).length);case"collection":return Object.keys(s.added).length+Object.keys(s.changed).length+Object.keys(s.removed).length}}(a))return t.setLayoutProperties(e.layer,e.layout),i.type===f.fR.SYMBOL&&this._vectorTileContainer.restartDeclutter(),void this._vectorTileContainer.requestRender();this._styleChanges.push({type:R.Fr.LAYOUT_CHANGED,data:e}),this.notifyChange("updating"),this.requestUpdate()}}),this.layer.on("style-layer-visibility-change",e=>{const t=this._styleRepository,i=t.getLayerById(e.layer);i&&(t.setStyleLayerVisibility(e.layer,e.visibility),i.type===f.fR.SYMBOL&&this._vectorTileContainer.restartDeclutter(),this._vectorTileContainer.requestRender())}),this.layer.on("style-layer-change",e=>{this._styleChanges.push({type:R.Fr.LAYER_CHANGED,data:e}),this.notifyChange("updating"),this.requestUpdate()}),this.layer.on("delete-style-layer",e=>{this._styleChanges.push({type:R.Fr.LAYER_REMOVED,data:e}),this.notifyChange("updating"),this.requestUpdate()}),this.layer.on("load-style",()=>this._loadStyle()),this.layer.on("spriteSource-change",e=>{this._newSpriteSource=e.spriteSource,this._styleChanges.push({type:R.Fr.SPRITES_CHANGED,data:null});const t=this._styleRepository.layers;for(const i of t)switch(i.type){case f.fR.SYMBOL:i.getLayoutProperty("icon-image")&&this._styleChanges.push({type:R.Fr.LAYOUT_CHANGED,data:{layer:i.id,layout:i.layout}});break;case f.fR.LINE:i.getPaintProperty("line-pattern")&&this._styleChanges.push({type:R.Fr.PAINTER_CHANGED,data:{layer:i.id,paint:i.paint,isDataDriven:i.isPainterDataDriven()}});break;case f.fR.FILL:i.getLayoutProperty("fill-pattern")&&this._styleChanges.push({type:R.Fr.PAINTER_CHANGED,data:{layer:i.id,paint:i.paint,isDataDriven:i.isPainterDataDriven()}})}this.notifyChange("updating"),this.requestUpdate()})])}detach(){this._stop(),this.container.removeAllChildren(),this._vectorTileContainer=(0,o.SC)(this._vectorTileContainer),this._tileHandler=(0,o.SC)(this._tileHandler)}moveStart(){this.requestUpdate()}viewChange(){this.requestUpdate()}moveEnd(){this._collisionOverlay&&this._vectorTileContainer.restartDeclutter(),this.requestUpdate()}supportsSpatialReference(s){return(0,X.fS)(this.layer.tileInfo?.spatialReference,s)}canResume(){let s=super.canResume();const{currentStyleInfo:e}=this.layer;if(s&&e?.layerDefinition){const t=this.view.scale,{minScale:i,maxScale:a}=e.layerDefinition;e&&e.layerDefinition&&(i&&i<t&&(s=!1),a&&a>t&&(s=!1))}return s}isUpdating(){const s=this._vectorTileContainer.children;return!this._isTileHandlerReady||!this._fetchQueue||!this._parseQueue||this._fetchQueue.updating||this._parseQueue.updating||s.length>0&&s.some(e=>e.invalidating)||this.fading}acquireTile(s){const e=this._createVectorTile(s);return this._tileHandlerPromise?.then(()=>{this._fetchQueue.push(e.key).then(t=>this._parseQueue.push({key:e.key,data:t})).then(t=>{e.once("attach",()=>this.requestUpdate()),e.setData(t),this.requestUpdate(),this.notifyChange("updating")}).catch(t=>{this.notifyChange("updating"),(0,j.D_)(t)||_.Z.getLogger(this.declaredClass).error(t)})}),e}releaseTile(s){const e=s.key.id;this._fetchQueue.abort(e),this._parseQueue.abort(e),this.requestUpdate()}_start(){if(this._stop(),this._tileManager=new k({acquireTile:t=>this.acquireTile(t),releaseTile:t=>this.releaseTile(t),tileInfoView:this._tileInfoView},this._vectorTileContainer),!this.layer.currentStyleInfo)return;const s=new AbortController,e=this._tileHandler.start({signal:s.signal}).then(()=>{this._fetchQueue=new Te.Z({tileInfoView:this._tileInfoView,process:(t,i)=>this._getTileData(t,i),concurrency:15}),this._parseQueue=new Te.Z({tileInfoView:this._tileInfoView,process:(t,i)=>this._parseTileData(t,i),concurrency:8}),this.requestUpdate(),this._isTileHandlerReady=!0});this._tileHandler.spriteMosaic.then(t=>{this._vectorTileContainer.setStyleResources(t,this._tileHandler.glyphMosaic,this._styleRepository),this.requestUpdate()}),this._tileHandlerAbortController=s,this._tileHandlerPromise=e}_stop(){if(!this._tileHandlerAbortController||!this._vectorTileContainer)return;const s=this._tileHandlerAbortController;s&&s.abort(),this._tileHandlerPromise=null,this._isTileHandlerReady=!1,this._fetchQueue=(0,o.SC)(this._fetchQueue),this._parseQueue=(0,o.SC)(this._parseQueue),this._tileManager=(0,o.SC)(this._tileManager),this._vectorTileContainer.removeAllChildren()}_getTileData(s,e){var t=this;return(0,u.Z)(function*(){const i=yield t._tileHandler.fetchTileData(s,e);return t.notifyChange("updating"),i})()}_parseTileData(s,e){var t=this;return(0,u.Z)(function*(){return t._tileHandler.parseTileData(s,e)})()}_applyStyleChanges(){var s=this;return(0,u.Z)(function*(){s._isTileHandlerReady=!1,s._fetchQueue.pause(),s._parseQueue.pause(),s._fetchQueue.clear(),s._parseQueue.clear(),s._tileManager.clearCache();const e=s._styleChanges;try{yield s._tileHandler.updateStyle(e)}catch(l){_.Z.getLogger(s.declaredClass).error("error applying vector-tiles style update",l.message),s._fetchQueue.resume(),s._parseQueue.resume(),s._isTileHandlerReady=!0}const t=s._styleRepository,i=[];e.forEach(l=>{if(l.type!==R.Fr.LAYER_REMOVED)return;const h=t.getLayerById(l.data.layer);h&&i.push(h.uid)});const a=[];let n;e.forEach(l=>{const h=l.data;switch(l.type){case R.Fr.PAINTER_CHANGED:t.setPaintProperties(h.layer,h.paint),n=h.layer;break;case R.Fr.LAYOUT_CHANGED:t.setLayoutProperties(h.layer,h.layout),n=h.layer;break;case R.Fr.LAYER_REMOVED:return void t.deleteStyleLayer(h.layer);case R.Fr.LAYER_CHANGED:t.setStyleLayer(h.layer,h.index),n=h.layer.id;break;case R.Fr.SPRITES_CHANGED:s._vectorTileContainer.setSpriteMosaic(s._tileHandler.setSpriteSource(s._newSpriteSource)),s._newSpriteSource=null,n=null}const y=t.getLayerById(n);y&&a.push(y.uid)});const c=s._vectorTileContainer.children;if(i.length>0){s._vectorTileContainer.deleteStyleLayers(i);for(const l of c)l.deleteLayerData(i)}if(s._fetchQueue.resume(),s._parseQueue.resume(),a.length>0){const l=[];for(const g of c){const h=s._fetchQueue.push(g.key).then(y=>s._parseQueue.push({key:g.key,data:y,styleLayerUIDs:a})).then(y=>g.setData(y));l.push(h)}yield Promise.all(l)}s._styleChanges=[],s._isTileHandlerReady=!0,s.notifyChange("updating"),s.requestUpdate()})()}_loadStyle(){var s=this;return(0,u.Z)(function*(){const{style:e}=s.layer.currentStyleInfo,t=(0,$.d9)(e);s._isTileHandlerReady=!1,s._fetchQueue.pause(),s._parseQueue.pause(),s._fetchQueue.clear(),s._parseQueue.clear(),s.notifyChange("updating"),s._styleRepository=new Ce.Z(t),s._vectorTileContainer.destroy(),s._tileManager.clear(),s._tileHandlerAbortController.abort(),s._tileHandlerAbortController=new AbortController;const{signal:i}=s._tileHandlerAbortController;try{s._tileHandlerPromise=s._tileHandler.setStyle(s._styleRepository,t),yield s._tileHandlerPromise}catch(n){if(!(0,j.D_)(n))throw n}if(i.aborted)return s._fetchQueue.resume(),s._parseQueue.resume(),s._isTileHandlerReady=!0,s.notifyChange("updating"),void s.requestUpdate();const a=yield s._tileHandler.spriteMosaic;s._vectorTileContainer.setStyleResources(a,s._tileHandler.glyphMosaic,s._styleRepository),s._fetchQueue.resume(),s._parseQueue.resume(),s._isTileHandlerReady=!0,s.notifyChange("updating"),s.requestUpdate()})()}_createVectorTile(s){const e=this._tileInfoView.getTileBounds((0,U.Ue)(),s),t=this._tileInfoView.getTileResolution(s.level);return new ce.i(s,t,e[0],e[3],512,512,this._styleRepository)}};(0,w._)([(0,p.Cb)()],z.prototype,"_fetchQueue",void 0),(0,w._)([(0,p.Cb)()],z.prototype,"_parseQueue",void 0),(0,w._)([(0,p.Cb)()],z.prototype,"_isTileHandlerReady",void 0),(0,w._)([(0,p.Cb)()],z.prototype,"fading",void 0),z=(0,w._)([(0,H.j)("esri.views.2d.layers.VectorTileLayerView2D")],z);const Ue=z}}]);