"use strict";(self.webpackChunkpredio360_app=self.webpackChunkpredio360_app||[]).push([[6879,5611],{46668:(fe,ee,i)=>{i.d(ee,{a:()=>f});const F=2654435761,a=2246822519,U=3266489917,b=668265263,A=374761393;function l(w){const y=[];for(let u=0,p=w.length;u<p;u++){let v=w.charCodeAt(u);v<128?y.push(v):v<2048?y.push(192|v>>6,128|63&v):v<55296||v>=57344?y.push(224|v>>12,128|v>>6&63,128|63&v):(u++,v=65536+((1023&v)<<10|1023&w.charCodeAt(u)),y.push(240|v>>18,128|v>>12&63,128|v>>6&63,128|63&v))}return new Uint8Array(y)}class f{constructor(y){this._seed=y,this._totallen=0,this._bufs=[],this.init()}init(){return this._bufs=[],this._totallen=0,this}updateFloatArray(y){const u=[];for(const p of y)isNaN(p)?u.push("NaN"):u.push(p===1/0?"Infinity":p===-1/0?"-Infinity":0===p?"0":p.toString(16));this.update(l(u.join("")))}updateIntArray(y){const u=Int32Array.from(y);this.update(new Uint8Array(u.buffer))}updateUint8Array(y){this.update(Uint8Array.from(y))}updateWithString(y){return this.update(l(y))}update(y){return this._bufs.push(y),this._totallen+=y.length,this}digest(){const y=new Uint8Array(this._totallen);let u=0;for(const p of this._bufs)y.set(p,u),u+=p.length;return this.init(),this._xxHash32(y,this._seed)}_xxHash32(y,u=0){const p=y;let v=u+A&4294967295,L=0;if(p.length>=16){const h=[u+F+a&4294967295,u+a&4294967295,u+0&4294967295,u-F&4294967295],P=y,O=P.length-16;let j=0;for(L=0;(4294967280&L)<=O;L+=4){let R=h[j]+((P[L+0]+(P[L+1]<<8))*a+((P[L+2]+(P[L+3]<<8))*a<<16))&4294967295;R=R<<13|R>>>19,h[j]=(65535&R)*F+((R>>>16)*F<<16)&4294967295,j=j+1&3}v=(h[0]<<1|h[0]>>>31)+(h[1]<<7|h[1]>>>25)+(h[2]<<12|h[2]>>>20)+(h[3]<<18|h[3]>>>14)&4294967295}v=v+y.length&4294967295;const _=y.length-4;for(;L<=_;L+=4)v=v+((p[L+0]+(p[L+1]<<8))*U+((p[L+2]+(p[L+3]<<8))*U<<16))&4294967295,v=v<<17|v>>>15,v=(65535&v)*b+((v>>>16)*b<<16)&4294967295;for(;L<p.length;++L)v+=p[L]*A,v=v<<11|v>>>21,v=(65535&v)*F+((v>>>16)*F<<16)&4294967295;return v^=v>>>15,v=((65535&v)*a&4294967295)+((v>>>16)*a<<16),v^=v>>>13,v=((65535&v)*U&4294967295)+((v>>>16)*U<<16),v^=v>>>16,v<0?v+4294967296:v}}},88034:(fe,ee,i)=>{i.d(ee,{H:()=>w,b:()=>f});var F=i(39523),a=i(49480),U=i(65787),b=i(17625),A=i(22355),l=i(35387);function f(y){const u=new A.kG;u.include(F.k),u.include(a.f);const{usesHalfFloat:p}=y;return u.fragment.uniforms.add([new l.A("densityMap",v=>v.densityMap),new l.A("tex",v=>v.colorRamp),new U.p("densityNormalizer",v=>1/(v.maxDensity-v.minDensity)),new U.p("minDensity",v=>v.minDensity)]),u.fragment.uniforms.add(new U.p("densityMultiplier",v=>3/(v.searchRadius*v.searchRadius*Math.PI))),p&&u.constants.add("compressionFactor","float",4),u.fragment.code.add(b.H`
    void main() {
      float density = texture2D(densityMap, uv).r * densityMultiplier${p?b.H` * compressionFactor`:""};
      float densityRatio = (density - minDensity) * densityNormalizer;

      vec4 color = texture2D(tex, vec2(clamp(densityRatio, 0.0, 1.0), 0.5));

      discardOrAdjustAlpha(color);
      gl_FragColor = color;
    }
  `),u}const w=Object.freeze(Object.defineProperty({__proto__:null,build:f},Symbol.toStringTag,{value:"Module"}))},81768:(fe,ee,i)=>{i.d(ee,{H:()=>f,b:()=>l});var F=i(2166),a=i(65787),U=i(17625),b=i(22355),A=i(16396);function l(w){const y=new b.kG,{vertex:u,fragment:p}=y;(0,F.Sv)(u,w);const{isAttributeDriven:v,usesHalfFloat:L}=w;return y.attributes.add(A.T.POSITION,"vec3"),y.attributes.add(A.T.UV0,"vec2"),v&&(y.attributes.add(A.T.FEATUREATTRIBUTE,"float"),y.varyings.add("attributeValue","float")),L&&y.constants.add("compressionFactor","float",.25),y.varyings.add("unitCirclePos","vec2"),u.uniforms.add(new a.p("radius",({resolutionForScale:_,searchRadius:h},{camera:P,screenToWorldRatio:O})=>2*h*(0===_?1:_/O)*P.pixelRatio/P.fullViewport[2])),u.code.add(U.H`
    void main() {
      unitCirclePos = uv0;

      vec4 posProj = proj * (view * vec4(${A.T.POSITION}, 1.0));
      vec4 quadOffset = vec4(unitCirclePos * radius, 0.0, 0.0);

      ${v?U.H`attributeValue = ${A.T.FEATUREATTRIBUTE};`:""}
      gl_Position = posProj + quadOffset;
    }
  `),p.code.add(U.H`
    void main() {
      float radiusRatioSquared = dot(unitCirclePos, unitCirclePos);
      if (radiusRatioSquared > 1.0) {
        discard;
      }

      float oneMinusRadiusRatioSquared = 1.0 - radiusRatioSquared;
      float density = oneMinusRadiusRatioSquared * oneMinusRadiusRatioSquared ${v?U.H` * attributeValue`:""} ${L?U.H` * compressionFactor`:""};
      gl_FragColor = vec4(density);
    }
  `),y}const f=Object.freeze(Object.defineProperty({__proto__:null,build:l},Symbol.toStringTag,{value:"Module"}))},23010:(fe,ee,i)=>{i.d(ee,{g:()=>ie});var F=i(15861),a=i(17626),U=i(14517),b=i(59213),A=i(46160),f=(i(8314),i(26584)),w=i(72392),y=i(58817),u=i(63290),p=i(62208),v=i(60330),L=i(10699),_=i(32917),h=i(77712),O=(i(90912),i(76898)),j=i(17760),M=i(38305),Y=i(72469),K=i(35082),E=i(60776),R=i(54984),N=i(88879),J=i(37118),ne=i(9260),ue=i(69852),de=i(89673),he=i(21716),ge=i(23461);const Z=[[0,179,255],[117,62,128],[0,104,255],[215,189,166],[32,0,193],[98,162,206],[102,112,129],[52,125,0],[142,118,246],[138,83,0],[92,122,255],[122,55,83],[0,142,255],[81,40,179],[0,200,244],[13,24,127],[0,170,147],[19,58,241],[22,44,35]];class Re{constructor(d,V,te){this._loadingGraphics=new Map,this._loadedGraphics=new Map,this._pendingGraphics=new Map,this._dataExtentGraphic=null,this._enabled=!0,this._tileFetcher=d,this._view=te,this._tilingScheme=new ge.t(V),this._loadedSymbols=Z.map(X=>new de.Z(new ne.Z({material:{color:[X[0],X[1],X[2],.6]},outline:{color:"black",size:1}}))),this._loadingSymbols=[new de.Z(new ne.Z({material:{color:[200,200,200,.4]},outline:{color:[30,30,30],size:1}}))],this._pendingSymbols=[new de.Z(new ne.Z({material:{color:[100,100,100,.4]},outline:{color:[30,30,30],size:1}}))],this._dataExtentSymbol=new de.Z(new ne.Z({material:{color:[0,0,0,0]},outline:{color:"green",size:4}}))}destroy(){this.enabled=!1}get enabled(){return this._enabled}set enabled(d){this._enabled=d,this.update()}update(){this._enabled?(this._synchronizeMaps(this._loadingGraphics,{filter:d=>d.isFetching,symbols:this._loadingSymbols}),this._synchronizeMaps(this._loadedGraphics,{filter:d=>!d.isFetching,symbols:this._loadedSymbols}),this._synchronizeMaps(this._pendingGraphics,{filter:d=>!d.isFetching,symbols:this._pendingSymbols}),this.showDataExtent(this._tileFetcher.filterExtent)):(this._loadingGraphics.forEach(d=>{this._view.graphics.removeMany(d)}),this._loadingGraphics.clear(),this._loadedGraphics.forEach(d=>{this._view.graphics.removeMany(d)}),this._loadedGraphics.clear(),this._pendingGraphics.forEach(d=>{this._view.graphics.removeMany(d)}),this._pendingGraphics.clear(),this._dataExtentGraphic&&(this._view.graphics.remove(this._dataExtentGraphic),this._dataExtentGraphic=null))}showDataExtent(d){if(this._dataExtentGraphic&&(this._view.graphics.remove(this._dataExtentGraphic),this._dataExtentGraphic=null),(0,p.Wi)(d))return;const V=J.Z.fromExtent(d);this._dataExtentGraphic=new N.Z({geometry:V,symbol:this._dataExtentSymbol}),this._view.graphics.add(this._dataExtentGraphic)}_synchronizeMaps(d,V){const te=[];d.forEach((X,q)=>{const me=this._tileFetcher.test.getFeatureTileById(q);me&&V.filter(me)||(this._view.graphics.removeMany(X),te.push(q))}),te.forEach(X=>d.delete(X)),this._tileFetcher.test.forEachFeatureTile(X=>{if(V.filter(X)&&!d.has(X.id)){const[q,me,Ee]=X.descriptor.lij;this._tilingScheme.ensureMaxLod(q);const ae=this._tilingScheme.getExtentGeometry(q,me,Ee),ye=[new N.Z({geometry:ae,symbol:V.symbols[q%V.symbols.length]}),new N.Z({geometry:ae.center,symbol:new ue.Z({verticalOffset:{screenLength:40/.75},callout:{type:"line",color:"white",border:{color:"black"}},symbolLayers:[new he.Z({text:`${q}/${me}/${Ee}`,halo:{color:"white",size:1/.75},material:{color:"black"},size:16})]})})];d.set(X.id,ye),this._view.graphics.addMany(ye)}})}}var xe=i(93605);let ie=class extends((0,v.v)(U.Z)){set extent(C){if((0,p.pC)(C)&&!C.spatialReference.equals(this.layerView.view.spatialReference))return void u.Z.getLogger(this.declaredClass).error("#extent=","extent needs to be in the same spatial reference as the view");const d=this._get("extent");if(d===C||(0,p.pC)(d)&&C&&d.equals(C))return;const V=(0,p.pC)(C)?C.clone():null;this._set("extent",V)}get updating(){return!!((0,p.pC)(this._tileFetcher)&&this._tileFetcher.updating||null!=this._fetchDataInfoPromise||"tiles"===this.mode&&this.layerView.view.featureTiles&&this.layerView.view.featureTiles.updating||this._watchUpdatingTracking&&this._watchUpdatingTracking.updating)}get updatingTotal(){return this.updating&&(0,p.pC)(this._tileFetcher)?this._tileFetcher.updatingTotal:0}get updatingRemaining(){return this.updating&&(0,p.pC)(this._tileFetcher)?this._tileFetcher.updatingRemaining:0}get expectedFeatureDiff(){return this.updating&&(0,p.pC)(this._tileFetcher)?this._tileFetcher.expectedFeatureDiff:0}get memoryForUnusedFeatures(){return(0,p.pC)(this._tileFetcher)?this._tileFetcher.memoryForUnusedFeatures:0}get maximumNumberOfFeaturesExceeded(){return!(!(0,p.pC)(this._tileFetcher)||!this._tileFetcher.maximumNumberOfFeaturesExceeded)}get maximumNumberOfFeatures(){return(0,p.pC)(this.displayFeatureLimit)?this.displayFeatureLimit.maximumNumberOfFeatures:0}set maximumNumberOfFeatures(C){C!==this.maximumNumberOfFeatures&&this._overrideIfSome("maximumNumberOfFeatures",C)}get hasMaximumNumberOfFeaturesOverride(){return this._isOverridden("maximumNumberOfFeatures")}get mode(){const C=this.layerView.layer;if("feature"===C.type&&(0,p.pC)(C.infoFor3D))return"snapshot";if(!1===this.layerView.view.qualitySettings?.graphics3D?.snapshotAvailable||this.serviceDataCount===_e.NO_SERVICE_DATA_COUNT||this.vertexLimitExceeded)return"tiles";const d=this.layerView.view,V=d&&d.featureTiles,te=V&&V.tilingScheme;if(C&&C.minScale&&this.serviceDataExtent&&te){const X=this._approximateExtentSizeAtScale(C.minScale,te);if((this.serviceDataExtent.width/X+this.serviceDataExtent.height/X)/2>_e.MAX_SNAPSHOT_MIN_SCALE_FACTOR)return"tiles"}return!this.maximumNumberOfFeatures||this.serviceDataCount<=this.maximumNumberOfFeatures?"snapshot":"tiles"}get maxTotalSnapshotVertices(){const C=this._get("maxTotalSnapshotVertices")||0,d="snapshot"===this.mode&&(0,p.pC)(this._tileFetcher)&&this._tileFetcher.totalVertices||0;return Math.max(C,d)}_approximateExtentSizeAtScale(C,d){const V=this.layerView.view,te=Math.ceil((V.width/d.pixelSize+V.height/d.pixelSize)/2),X=d.levels[0];return te*((X.tileSize[0]/(X.scale/C)+X.tileSize[1]/(X.scale/C))/2)}get tileDescriptors(){return"snapshot"===this.mode?new A.Z([{id:"dummy-tile-full-extent",lij:[0,0,0]}]):this.layerView.view.featureTiles?this.layerView.view.featureTiles.tiles:new A.Z}get test(){return{fetchDataInfoPromise:this._fetchDataInfoPromise,tileFetcher:this._tileFetcher}}constructor(C){super(C),this.type="feature-tile-3d",this._watchUpdatingTracking=new j.t,this.serviceDataExtent=null,this.serviceDataCount=_e.NO_SERVICE_DATA_COUNT,this.vertexLimitExceeded=!1,this.displayFeatureLimit=null,this._suspended=!1,this._tileFetcher=null,this._handles=new w.Z,this._fetchDataInfoPromise=null,this._fetchDataInfoAbortController=null,this._lifeCycleAbortController=new AbortController}initialize(){this._watchUpdatingTracking.add(()=>this.vertexLimitInfo,()=>this._watchUpdatingTracking.addPromise(this._updateVertexLimitExceeded(null,this._lifeCycleAbortController.signal))),this._watchUpdatingTracking.add(()=>this.mode,()=>this._modeChanged(),_.nn),this.addResolvingPromise(Promise.resolve().then(()=>this._verifyCapabilities()).then(()=>this._watchUpdatingTracking.addPromise(this._fetchServiceDataInfo())).then(()=>this._initializeTileFetcher()))}_verifyCapabilities(){const C=this.layerView.layer;if("ogc-feature"!==C.type&&!(0,Y.S1)(C)?.operations.supportsQuery)throw new f.Z("graphicscontroller:query-capability-required","Service requires query capabilities to be used as a feature layer",{layer:C})}destroy(){this._cancelFetchServiceDataInfo(),this._tileFetcher=(0,p.SC)(this._tileFetcher),this._handles=(0,p.SC)(this._handles),this._tilesHandle=(0,p.hw)(this._tilesHandle),this._lifeCycleAbortController=(0,p.IM)(this._lifeCycleAbortController),this._watchUpdatingTracking.destroy(),this._set("watchUpdatingTracking",null)}suspend(){this._suspended||(this._suspended=!0,(0,p.pC)(this._tileFetcher)&&this._tileFetcher.suspend())}resume(){this._suspended&&(this._suspended=!1,(0,p.pC)(this._tileFetcher)&&this._tileFetcher.resume())}restart(){const C=()=>{(0,p.pC)(this._tileFetcher)&&this._tileFetcher.restart()};this._watchUpdatingTracking.addPromise(this._fetchServiceDataInfo().then(C,C))}refetch(){const C=()=>{(0,p.pC)(this._tileFetcher)&&this._tileFetcher.refetch()};this._watchUpdatingTracking.addPromise(this._fetchServiceDataInfo().then(C,C))}_initializeTileFetcher(){const C=this.layerView.view;if(!C)return;const d=(0,_.N1)(()=>C.featureTiles?.tilingScheme,this._lifeCycleAbortController.signal);this._watchUpdatingTracking.addPromise(d),d.then(()=>{const{layerView:V,tileDescriptors:te}=this,X=V.layer,q=new R.j({context:this.context,filterExtent:this.extent,tileDescriptors:te,features:this.graphics});this._tileFetcher=q,this._suspended?this._tileFetcher.suspend():this._tileFetcher.resume();const me=this.layerView.view.resourceController;me&&this._handles.add((0,_.YP)(()=>me.memoryController.memoryFactor,G=>q.memoryFactor=G,_.tX));const Ee="polygon"===this.context.geometryType?"polygonLodFactor":"polyline"===this.context.geometryType?"polylineLodFactor":null;Ee&&this._handles.add((0,_.YP)(()=>this.layerView.view?.qualitySettings?.graphics3D?.[Ee],G=>q.lodFactor=G||1,_.nn)),"ogc-feature"!==X.type&&this._watchUpdatingTracking.add(()=>X.createQueryVersion,()=>this._dataFilterChanged()),this._watchUpdatingTracking.add(()=>V.availableFields,(G,Te)=>this._availableFieldsChanged(Te,G)),this._watchUpdatingTracking.add(()=>V.requiredFields,(G,Te)=>this._requiredFieldsChanged(Te,G)),this._handles.add([X.on("apply-edits",G=>this._applyEdits(G)),(0,_.YP)(()=>this.extent,G=>q.filterExtent=G,_.Z_),(0,_.YP)(()=>this.tileDescriptors,G=>q.tileDescriptors=G,_.Z_),(0,_.YP)(()=>this.maximumNumberOfFeatures,G=>{q.maximumNumberOfFeatures=G,q.useTileCount=this.serviceDataCount>G},_.tX),(0,_.YP)(()=>this.serviceDataCount,G=>q.useTileCount=G>this.maximumNumberOfFeatures,_.tX),(0,_.YP)(()=>xe.Z.FEATURE_TILE_FETCH_SHOW_TILES,G=>{G&&q&&!q.debugger?(q.debugger=new Re(q,C.featureTiles.tilingScheme.toTileInfo(),C),q.debugger.update()):!G&&this._tileFetcher&&q.debugger&&(q.debugger.destroy(),q.debugger=null)},_.tX)]),this._supportsExceedsLimitQuery||this._watchUpdatingTracking.add(()=>this.maxTotalSnapshotVertices,()=>this._watchUpdatingTracking.addPromise(this._updateVertexLimitExceeded(null,this._lifeCycleAbortController.signal)))}).catch(()=>{})}_modeChanged(){switch(this.mode){case"tiles":this._tilesHandle||(this._tilesHandle=this.layerView.view.featureTiles.addClient());break;default:u.Z.getLogger(this.declaredClass).warn("Unhandled feature layer mode "+this.mode);case"snapshot":(0,p.pC)(this._tilesHandle)&&(this._tilesHandle.remove(),this._tilesHandle=null)}}_dataFilterChanged(){this._set("maxTotalSnapshotVertices",0),this.notifyChange("maxTotalSnapshotVertices"),this.refetch()}_applyEdits(C){(0,p.Wi)(this._tileFetcher)||this._tileFetcher.applyEdits(C).then(d=>{if(d){if(!this._lifeCycleAbortController)throw(0,L.zE)();(d.deletedFeatures.length||d.updatedFeatures.length||d.addedFeatures.length)&&this._watchUpdatingTracking.addPromise(this._updateServiceDataExtent(this._lifeCycleAbortController.signal))}}).catch(d=>{if(!(0,L.D_)(d))throw d})}_availableFieldsChanged(C,d){(0,p.pC)(this._tileFetcher)&&k(this._tileFetcher.availableFields,d)&&this.refetch()}_requiredFieldsChanged(C,d){(0,p.pC)(this._tileFetcher)&&k(this._tileFetcher.availableFields,d)&&this.restart()}_createVertexLimitExceededQuery(C){const d=this.layerView.layer,V=d.createQuery();return V.outStatistics=[new E.Z({statisticType:"exceedslimit",maxVertexCount:C,outStatisticFieldName:"exceedslimit",maxPointCount:1e8,maxRecordCount:1e8})],d.capabilities?.query.supportsCacheHint&&(V.cacheHint=!0),V}_createDataInfoQuery(){const C=this.layerView.layer,d=C.createQuery();return d.outSpatialReference=this.layerView.view.spatialReference,C.capabilities?.query.supportsCacheHint&&(d.cacheHint=!0),d}_fullExtentIsAccurate(){const C=this.layerView.layer;if(C.definitionExpression)return!1;switch(C.type){case"feature":case"oriented-imagery":return(0,M.M8)(C.url);case"csv":case"geojson":case"ogc-feature":case"wfs":return!0;default:return}}_updateServiceDataExtent(C){var d=this;return(0,F.Z)(function*(){try{yield d._tryUpdateServiceDataExtent(C)}catch(V){(0,L.D_)(V)||d._set("serviceDataExtent",(0,y.d9)(d.layerView.fullExtentInLocalViewSpatialReference))}})()}_tryUpdateServiceDataExtent(C){var d=this;return(0,F.Z)(function*(){const V=d.layerView,te=V.layer,X=te.capabilities?.query.supportsExtent??!1,q=(0,y.d9)(V.fullExtentInLocalViewSpatialReference),me=te.fullExtent,Ee=d._fullExtentIsAccurate();if(X&&d.serviceDataCount<=_e.MAX_FEATURE_COUNT_FOR_EXTENT&&(!q||!Ee)&&"queryExtent"in te){const ye=d._createDataInfoQuery(),G=yield te.queryExtent(ye,{timeout:_e.QUERY_EXTENT_TIMEOUT,signal:C});d._set("serviceDataExtent",G.extent)}else if(q)d._set("serviceDataExtent",q);else if((0,p.pC)(me)){const ye="portalItem"in te?te.portalItem:null,G=yield(0,K.projectGeometry)(me,V.view.spatialReference,ye,C);d._set("serviceDataExtent",G)}else d._set("serviceDataExtent",null)})()}_updateServiceDataCount(C){var d=this;return(0,F.Z)(function*(){const V=d.layerView.layer;if(!("queryFeatureCount"in V))return void d._set("serviceDataCount",_e.NO_SERVICE_DATA_COUNT);const te=yield(0,b.q6)(V.queryFeatureCount(d._createDataInfoQuery(),{timeout:_e.QUERY_STATISTICS_TIMEOUT,signal:C}));if(!0===te.ok)d._set("serviceDataCount",te.value);else{if((0,L.D_)(te.error))throw te.error;d._set("serviceDataCount",_e.NO_SERVICE_DATA_COUNT)}})()}get vertexLimitInfo(){if((0,p.Wi)(this.displayFeatureLimit)||(0,p.Wi)(this.displayFeatureLimit.averageSymbolComplexity))return null;const{averageSymbolComplexity:C,maximumTotalNumberOfPrimitives:d}=this.displayFeatureLimit,{primitivesPerCoordinate:V,primitivesPerFeature:te}=C,X=this._get("vertexLimitInfo");return(0,p.Wi)(X)||X.maximumTotalNumberOfPrimitives!==d||X.primitivesPerCoordinate!==V||X.primitivesPerFeature!==te?{primitivesPerCoordinate:V,primitivesPerFeature:te,maximumTotalNumberOfPrimitives:d}:X}get _supportsExceedsLimitQuery(){const C=this.layerView.layer;return null!=C.capabilities&&C.capabilities.operations&&C.capabilities.operations.supportsExceedsLimitStatistics}get _minimumNumberOfVerticesForGeometry(){switch(this.layerView.layer.geometryType){case"point":case"multipoint":return 1;case"polygon":return 4;case"polyline":return 2;case"multipatch":case"mesh":return 3;default:return 0}}_updateVertexLimitExceeded(C,d){var V=this;return(0,F.Z)(function*(){const te=V.vertexLimitInfo;if((0,p.Wi)(te))return void V._set("vertexLimitExceeded",!1);const q=V._minimumNumberOfVerticesForGeometry>1;if(!(te.primitivesPerFeature<=0||q))return void V._set("vertexLimitExceeded",!1);const{primitivesPerFeature:me,primitivesPerCoordinate:Ee,maximumTotalNumberOfPrimitives:ae}=te;let ye;0!==me&&(0,p.pC)(C)&&(yield C);const G=V.serviceDataCount,Te=G!==_e.NO_SERVICE_DATA_COUNT;if(ye=Math.ceil(Te?(ae-G*me)/(Ee||1):ae/(Ee||1)),q&&(ye=Math.min(ye,Q)),Te&&V._minimumNumberOfVerticesForGeometry*G>ye)return void V._set("vertexLimitExceeded",!0);if(!V._supportsExceedsLimitQuery)return void V._set("vertexLimitExceeded",V.maxTotalSnapshotVertices>ye);const Oe=yield(0,b.q6)(V.layerView.layer.queryFeatures(V._createVertexLimitExceededQuery(ye),{timeout:_e.QUERY_STATISTICS_TIMEOUT,signal:d}));if(!1===Oe.ok){if((0,L.D_)(Oe.error))throw Oe.error;return void V._set("vertexLimitExceeded",!1)}const be=Oe.value.features[0];V._set("vertexLimitExceeded",!(!be||!be.attributes||!be.attributes.exceedslimit))})()}_fetchServiceDataInfo(){var C=this;return(0,F.Z)(function*(){C._cancelFetchServiceDataInfo();let d=new AbortController;const V=d.signal,te=C._updateServiceDataCount(V),X=(0,L.as)([te,C._updateVertexLimitExceeded(te,V)]),q=X.then(()=>C._updateServiceDataExtent(V)).catch(me=>{(0,L.D_)(me)||u.Z.getLogger(C.declaredClass).error("#fetchServiceDataInfo()",me)}).then(()=>{q===C._fetchDataInfoPromise&&(C._fetchDataInfoPromise=null,C._fetchDataInfoAbortController=null),d=null});return d&&(C._fetchDataInfoPromise=q),C._fetchDataInfoAbortController=d,X.then(()=>{},()=>{})})()}_cancelFetchServiceDataInfo(){const C=this._fetchDataInfoAbortController;C&&(this._fetchDataInfoAbortController=null,this._fetchDataInfoPromise=null,C.abort())}get debug(){return{storedFeatures:(0,p.pC)(this._tileFetcher)?this._tileFetcher.storedFeatures:0,totalFeatures:(0,p.pC)(this._tileFetcher)?this._tileFetcher.totalFeatures:0,totalVertices:(0,p.pC)(this._tileFetcher)?this._tileFetcher.totalVertices:0,missingTiles:(0,p.pC)(this._tileFetcher)?this._tileFetcher.missingTiles:0}}};(0,a._)([(0,h.Cb)({readOnly:!0})],ie.prototype,"type",void 0),(0,a._)([(0,h.Cb)({constructOnly:!0})],ie.prototype,"graphics",void 0),(0,a._)([(0,h.Cb)({constructOnly:!0})],ie.prototype,"layerView",void 0),(0,a._)([(0,h.Cb)({constructOnly:!0})],ie.prototype,"context",void 0),(0,a._)([(0,h.Cb)()],ie.prototype,"extent",null),(0,a._)([(0,h.Cb)()],ie.prototype,"updating",null),(0,a._)([(0,h.Cb)({readOnly:!0})],ie.prototype,"_watchUpdatingTracking",void 0),(0,a._)([(0,h.Cb)()],ie.prototype,"updatingTotal",null),(0,a._)([(0,h.Cb)()],ie.prototype,"updatingRemaining",null),(0,a._)([(0,h.Cb)()],ie.prototype,"expectedFeatureDiff",null),(0,a._)([(0,h.Cb)()],ie.prototype,"memoryForUnusedFeatures",null),(0,a._)([(0,h.Cb)()],ie.prototype,"maximumNumberOfFeaturesExceeded",null),(0,a._)([(0,h.Cb)({readOnly:!0})],ie.prototype,"serviceDataExtent",void 0),(0,a._)([(0,h.Cb)({readOnly:!0})],ie.prototype,"serviceDataCount",void 0),(0,a._)([(0,h.Cb)({readOnly:!0})],ie.prototype,"vertexLimitExceeded",void 0),(0,a._)([(0,h.Cb)()],ie.prototype,"displayFeatureLimit",void 0),(0,a._)([(0,h.Cb)({type:Number})],ie.prototype,"maximumNumberOfFeatures",null),(0,a._)([(0,h.Cb)({readOnly:!0})],ie.prototype,"mode",null),(0,a._)([(0,h.Cb)({readOnly:!0})],ie.prototype,"maxTotalSnapshotVertices",null),(0,a._)([(0,h.Cb)({readOnly:!0,dependsOn:["mode"]})],ie.prototype,"tileDescriptors",null),(0,a._)([(0,h.Cb)()],ie.prototype,"_tileFetcher",void 0),(0,a._)([(0,h.Cb)()],ie.prototype,"_fetchDataInfoPromise",void 0),(0,a._)([(0,h.Cb)({readOnly:!0})],ie.prototype,"vertexLimitInfo",null),ie=(0,a._)([(0,O.j)("esri.layers.graphics.controllers.FeatureTileController3D")],ie);const Q=5e6;function k(C,d){if(!d)return!1;for(const V of d)if(!C.has(V))return!0;return!1}var _e,C;(C=_e||(_e={})).NO_SERVICE_DATA_COUNT=1/0,C.MAX_SNAPSHOT_MIN_SCALE_FACTOR=5,C.reset=function d(){C.MAX_FEATURE_COUNT_FOR_EXTENT=1e4,C.QUERY_STATISTICS_TIMEOUT=12e3,C.QUERY_EXTENT_TIMEOUT=1e4},_e.reset()},61256:(fe,ee,i)=>{i.d(ee,{H:()=>w});var F=i(8314),a=i(36592),U=i(65401);const A={minX:0,minY:0,maxX:0,maxY:0};class w{constructor(){this._indexInvalid=!1,this._boundsToLoad=[],this._boundsById=new Map,this._idByBounds=new Map,this._index=new a.Q(9,(0,F.Z)("esri-csp-restrictions")?u=>({minX:u[0],minY:u[1],maxX:u[2],maxY:u[3]}):["[0]","[1]","[2]","[3]"]),this._loadIndex=()=>{if(this._indexInvalid){const u=new Array(this._idByBounds.size);let p=0;this._idByBounds.forEach((v,L)=>{u[p++]=L}),this._indexInvalid=!1,this._index.clear(),this._index.load(u)}else this._boundsToLoad.length&&(this._index.load(Array.from(new Set(this._boundsToLoad.filter(u=>this._idByBounds.has(u))))),this._boundsToLoad.length=0)}}get fullBounds(){if(!this._boundsById.size)return null;const u=(0,U.cS)();for(const p of this._boundsById.values())p&&(u[0]=Math.min(p[0],u[0]),u[1]=Math.min(p[1],u[1]),u[2]=Math.max(p[2],u[2]),u[3]=Math.max(p[3],u[3]));return u}get valid(){return!this._indexInvalid}clear(){this._indexInvalid=!1,this._boundsToLoad.length=0,this._boundsById.clear(),this._idByBounds.clear(),this._index.clear()}delete(u){const p=this._boundsById.get(u);this._boundsById.delete(u),p&&(this._idByBounds.delete(p),this._indexInvalid||this._index.remove(p))}forEachInBounds(u,p){this._loadIndex(),function f(y,u,p){(function l(y){A.minX=y[0],A.minY=y[1],A.maxX=y[2],A.maxY=y[3]})(u),y.search(A,p)}(this._index,u,v=>p(this._idByBounds.get(v)))}get(u){return this._boundsById.get(u)}has(u){return this._boundsById.has(u)}invalidateIndex(){this._indexInvalid||(this._indexInvalid=!0,this._boundsToLoad.length=0)}set(u,p){if(!this._indexInvalid){const v=this._boundsById.get(u);v&&(this._index.remove(v),this._idByBounds.delete(v))}this._boundsById.set(u,p),p&&(this._idByBounds.set(p,u),this._indexInvalid||(this._boundsToLoad.push(p),this._boundsToLoad.length>5e4&&this._loadIndex()))}}},3579:(fe,ee,i)=>{i.d(ee,{Z:()=>v});var F=i(26584),a=i(61885),U=i(63290),b=i(62208),A=i(5548),l=i(65401),f=i(82054),w=i(61256),y=i(92794),u=i(6185);const p=(0,A.Ue)();class v{constructor(_){this.geometryInfo=_,this._boundsStore=new w.H,this._featuresById=new Map,this._markedIds=new Set,this.events=new a.Z,this.featureAdapter=y.n}get geometryType(){return this.geometryInfo.geometryType}get hasM(){return this.geometryInfo.hasM}get hasZ(){return this.geometryInfo.hasZ}get numFeatures(){return this._featuresById.size}get fullBounds(){return this._boundsStore.fullBounds}get storeStatistics(){let _=0;return this._featuresById.forEach(h=>{(0,b.pC)(h.geometry)&&h.geometry.coords&&(_+=h.geometry.coords.length)}),{featureCount:this._featuresById.size,vertexCount:_/(this.hasZ?this.hasM?4:3:this.hasM?3:2)}}getFullExtent(_){if((0,b.Wi)(this.fullBounds))return null;const[h,P,O,j]=this.fullBounds;return{xmin:h,ymin:P,xmax:O,ymax:j,spatialReference:(0,u.S2)(_)}}add(_){this._add(_),this._emitChanged()}addMany(_){for(const h of _)this._add(h);this._emitChanged()}clear(){this._featuresById.clear(),this._boundsStore.clear(),this._emitChanged()}removeById(_){const h=this._featuresById.get(_);return h?(this._remove(h),this._emitChanged(),h):null}removeManyById(_){this._boundsStore.invalidateIndex();for(const h of _){const P=this._featuresById.get(h);P&&this._remove(P)}this._emitChanged()}forEachBounds(_,h){for(const P of _){const O=this._boundsStore.get(P.objectId);O&&h((0,A.JR)(p,O))}}getFeature(_){return this._featuresById.get(_)}has(_){return this._featuresById.has(_)}forEach(_){this._featuresById.forEach(h=>_(h))}forEachInBounds(_,h){this._boundsStore.forEachInBounds(_,P=>{h(this._featuresById.get(P))})}startMarkingUsedFeatures(){this._boundsStore.invalidateIndex(),this._markedIds.clear()}sweep(){let _=!1;this._featuresById.forEach((h,P)=>{this._markedIds.has(P)||(_=!0,this._remove(h))}),this._markedIds.clear(),_&&this._emitChanged()}_emitChanged(){this.events.emit("changed",void 0)}_add(_){if(!_)return;const h=_.objectId;if(null==h)return void U.Z.getLogger("esri.layers.graphics.data.FeatureStore").error(new F.Z("featurestore:invalid-feature","feature id is missing",{feature:_}));const P=this._featuresById.get(h);let O;if(this._markedIds.add(h),P?(_.displayId=P.displayId,O=this._boundsStore.get(h),this._boundsStore.delete(h)):(0,b.pC)(this.onFeatureAdd)&&this.onFeatureAdd(_),(0,b.Wi)(_.geometry)||!_.geometry.coords||!_.geometry.coords.length)return this._boundsStore.set(h,null),void this._featuresById.set(h,_);O=(0,f.$)((0,b.pC)(O)?O:(0,l.Ue)(),_.geometry,this.geometryInfo.hasZ,this.geometryInfo.hasM),(0,b.pC)(O)&&this._boundsStore.set(h,O),this._featuresById.set(h,_)}_remove(_){(0,b.pC)(this.onFeatureRemove)&&this.onFeatureRemove(_);const h=_.objectId;return this._markedIds.delete(h),this._boundsStore.delete(h),this._featuresById.delete(h),_}}},60507:(fe,ee,i)=>{i.d(ee,{Jn:()=>f,RL:()=>y,VW:()=>l,W_:()=>j,jG:()=>M,tR:()=>Y,tq:()=>P,vQ:()=>L,zx:()=>_});var F=i(62208),a=i(29505);function U(E){return E?M:Y}function l(E,R){return function b(E,R){return(0,F.Wi)(R)||!R.mode?U(E).mode:R.mode}(!!(0,F.pC)(E)&&E.hasZ,R)}function f(E,R){return function A(E,R){return(0,F.pC)(R)?R:U(E)}(!!(0,F.pC)(E)&&!!E.hasZ,R)}function y(E){const R=function p(E){return E.layer&&"elevationInfo"in E.layer?E.layer.elevationInfo:null}(E),N=l(E.geometry,R);return{mode:N,offset:(0,F.pC)(R)&&"on-the-ground"!==N?(0,F.Pt)(R.offset,0)*(0,a.Z7)((0,F.Pt)(R.unit,"meters")):0}}function L(E,R,N,J=null){return h(E,R.x,R.y,R.hasZ?R.z:0,R.spatialReference,N,J)}function _(E,R,N,J,ne=null){return h(E,R[0],R[1],R.length>2?R[2]:0,N,J,ne)}function h(E,R,N,J,ne,ue,de=null){if((0,F.Wi)(ue))return;const he=(0,F.pC)(de)?de.mode:"absolute-height";if("on-the-ground"===he)return 0;const{absoluteZ:ge}=P(R,N,J,ne,E,ue);return function O(E,R,N,J,ne,ue,de,he){const ge=(0,F.pC)(de)&&(0,F.pC)(de.offset)?de.offset:0;switch(he){case"absolute-height":return E-ge;case"relative-to-ground":return E-((0,F.Pt)(ue.elevationProvider.getElevation(R,N,J,ne,"ground"),0)+ge);case"relative-to-scene":return E-((0,F.Pt)(ue.elevationProvider.getElevation(R,N,J,ne,"scene"),0)+ge)}}(ge,R,N,J,ne,E,de,he)}function P(E,R,N,J,ne,ue){const de=(0,F.pC)(ue.offset)?ue.offset:0;switch(ue.mode){case"absolute-height":return{absoluteZ:N+de,elevation:0};case"on-the-ground":{const he=(0,F.Pt)(ne.elevationProvider.getElevation(E,R,0,J,"ground"),0);return{absoluteZ:he,elevation:he}}case"relative-to-ground":{const he=(0,F.Pt)(ne.elevationProvider.getElevation(E,R,N,J,"ground"),0);return{absoluteZ:N+he+de,elevation:he}}case"relative-to-scene":{const he=(0,F.Pt)(ne.elevationProvider.getElevation(E,R,N,J,"scene"),0);return{absoluteZ:N+he+de,elevation:he}}}}function j(E,R){if((0,F.Wi)(R))return!1;const{mode:N}=R;return(0,F.pC)(N)&&("scene"===E&&"relative-to-scene"===N||"ground"===E&&"absolute-height"!==N)}const M={mode:"absolute-height",offset:0},Y={mode:"on-the-ground",offset:null}},79216:(fe,ee,i)=>{i.d(ee,{R:()=>nt});var F=i(15861),a=i(17626),U=i(26584),b=i(62208),A=i(32917),l=i(77712),y=(i(90912),i(85931),i(76898)),u=i(84786),p=i(23010),v=i(96854),L=i(86606),_=i(13191),h=i(33816),P=i(34675),O=i(46348),j=i(27306),M=i(80542),Y=i(54024),K=i(63290),E=i(23841),R=i(84161),N=i(28093),J=i(55915),ne=i(83137),ue=i(38114),de=i(82054),he=i(66385),ge=i(88071),Z=i(3579),Re=i(36630),xe=i(36859),ie=i(62600),m=i(98667),B=i(64835),oe=i(94255),Q=i(24425),k=i(59617),_e=i(19597),C=i(14411),d=i(17625),V=i(651),te=i(91056),X=i(87601),q=i(39114),me=i(88569),Ee=i(12407),ae=i(41528),ye=i(88034),G=i(67969),Te=i(2078);class Oe extends d.K{constructor(){super(...arguments),this.colorRamp=null,this.densityMap=null,this.searchRadius=1,this.fieldTotal=0,this.minDensity=0,this.maxDensity=100}}class be extends te.A{constructor(D,T){super(D,T,()=>this.destroy())}initializeProgram(D){return new Ee.$(D.rctx,be.shader.get().build(this.configuration),q.i)}initializePipeline(){return(0,Te.sm)({blending:me.wu,colorWrite:Te.BK,depthTest:null,depthWrite:null})}get primitiveType(){return G.MX.TRIANGLE_STRIP}}be.shader=new V.J(ye.H,()=>i.e(4194).then(i.bind(i,74194)));class Ue extends ae.W{constructor(){super(...arguments),this.usesHalfFloat=!1}}(0,a._)([(0,X.o)()],Ue.prototype,"usesHalfFloat",void 0);var Be=i(85775),je=i(55086),Ve=i(26906);let ve=class extends C.S{constructor(g){super(g),this.pixelRatio=1,this._colorRampData=new Uint8ClampedArray(4),this.type="draped-heatmap",this._heatmapParameters=new Oe}initialize(){this._densityMap=new Be.X(this.rctx,{colorTarget:G.Lm.TEXTURE,depthStencilTarget:G.OU.NONE,width:0,height:0},{target:G.No.TEXTURE_2D,pixelFormat:this.pixelFormat,internalFormat:this.internalFormat,dataType:this.dataType,samplingMode:this.samplingMode,wrapMode:G.e8.CLAMP_TO_EDGE,width:0,height:0}),this._quad=(0,_e.ow)(this.rctx);const T=this._colorRampData;this._colorRamp=new je.x(this.rctx,{target:G.No.TEXTURE_2D,pixelFormat:G.VI.RGBA,dataType:G.Br.UNSIGNED_BYTE,samplingMode:G.cw.LINEAR,wrapMode:G.e8.CLAMP_TO_EDGE,width:T.length/4,height:1},T);const $=new Ue;$.usesHalfFloat=this.dataType!==G.Br.FLOAT,this._technique=new be({rctx:this.rctx,viewingMode:k.JY.Local},$),this._heatmapParameters.densityMap=this._densityMap.colorTexture,this.addHandles((0,A.YP)(()=>[this.colorRampData,this.minDensity,this.maxDensity,this.fieldTotal,this.pixelRatio,this.searchRadius],()=>this.rendererContext.notifyContentChanged()))}destroy(){this._technique=(0,b.RY)(this._technique),this._densityMap=(0,b.M2)(this._densityMap),this._quad=(0,b.M2)(this._quad),this._colorRamp=(0,b.M2)(this._colorRamp)}get searchRadius(){return this._heatmapParameters.searchRadius}set searchRadius(g){g!==this._heatmapParameters.searchRadius&&(this._heatmapParameters.searchRadius=g,this.notifyChange("searchRadius"))}get minDensity(){return this._heatmapParameters.minDensity}set minDensity(g){g!==this._heatmapParameters.minDensity&&(this._heatmapParameters.minDensity=g,this.notifyChange("minDensity"))}get maxDensity(){return this._heatmapParameters.maxDensity}set maxDensity(g){g!==this._heatmapParameters.maxDensity&&(this._heatmapParameters.maxDensity=g,this.notifyChange("maxDensity"))}get fieldTotal(){return this._heatmapParameters.fieldTotal}set fieldTotal(g){this._heatmapParameters.fieldTotal=g,this.notifyChange("fieldTotal")}get colorRampData(){return this._colorRampData}set colorRampData(g){const{colorRamp:D}=this._heatmapParameters;if((0,b.pC)(D)&&g!==this._colorRampData){const x=g.length/4;x!==D.descriptor.width&&D.resize(x,1),D.setData(g)}this._colorRampData=g}get _colorRamp(){return this._heatmapParameters.colorRamp}set _colorRamp(g){this._heatmapParameters.colorRamp=g}get hasHighlights(){return!1}get hasWater(){return!1}get rendersOccluded(){return!1}render(g){const D=this._sortedMaterialRenderers;if(D.length<1)return;const T=this.rctx.getBoundFramebufferObject(),x=this.rctx.getViewport(),$=g.bindParameters,{pixelRatio:H}=this,se=Math.ceil(x.width*H),le=Math.ceil(x.height*H);this._densityMap.resize(se,le),this.rctx.bindFramebuffer(this._densityMap),this.rctx.setViewport(0,0,se,le),this.rctx.clear(G.lk.COLOR_BUFFER_BIT);let Fe=!1;D.forAll(Ie=>{Ie.material.shouldRender(g)&&(Fe=Ie.render(g.output,$)||Fe)}),this.rctx.bindFramebuffer(T),this.rctx.setViewport(x.x,x.y,x.width,x.height),Fe&&(this.rctx.bindVAO(this._quad),this.rctx.bindTechnique(this._technique,this._heatmapParameters,g.bindParameters),this.rctx.drawArrays(this._technique.primitiveType,0,(0,Ve._V)(this._quad,"geometry")))}};(0,a._)([(0,l.Cb)()],ve.prototype,"searchRadius",null),(0,a._)([(0,l.Cb)()],ve.prototype,"minDensity",null),(0,a._)([(0,l.Cb)()],ve.prototype,"maxDensity",null),(0,a._)([(0,l.Cb)()],ve.prototype,"fieldTotal",null),(0,a._)([(0,l.Cb)()],ve.prototype,"pixelRatio",void 0),(0,a._)([(0,l.Cb)()],ve.prototype,"colorRampData",null),(0,a._)([(0,l.Cb)({constructOnly:!0})],ve.prototype,"dataType",void 0),(0,a._)([(0,l.Cb)({constructOnly:!0})],ve.prototype,"samplingMode",void 0),(0,a._)([(0,l.Cb)({constructOnly:!0})],ve.prototype,"pixelFormat",void 0),(0,a._)([(0,l.Cb)({constructOnly:!0})],ve.prototype,"internalFormat",void 0),(0,a._)([(0,l.Cb)()],ve.prototype,"_colorRampData",void 0),ve=(0,a._)([(0,y.j)("esri.views.3d.webgl-engine.lib.DrapedHeatmapRenderer")],ve);var We=i(41120),Se=i(54840),s=i(64232),r=i(23147),o=i(16396),c=i(67831),S=i(99770),I=i(19625),W=i(13934),re=i(60881),ce=i(40723),Ce=i(5894),pe=i(42037),De=i(81768);class Pe extends ce.Mt{constructor(){super(...arguments),this.searchRadius=128,this.resolutionForScale=0}}class Me extends te.A{initializeProgram(D){return new Ee.$(D.rctx,Me.shader.get().build(this.configuration),q.i)}initializePipeline(){return(0,Te.sm)({blending:(0,Te.if)(G.zi.ONE,G.zi.ONE,G.db.ADD),colorWrite:Te.BK,depthTest:null,depthWrite:null})}destroy(){super.destroy()}}Me.shader=new V.J(De.H,()=>i.e(5795).then(i.bind(i,15795)));class Ae extends ae.W{constructor(){super(...arguments),this.isAttributeDriven=!1,this.usesHalfFloat=!1}}(0,a._)([(0,X.o)()],Ae.prototype,"isAttributeDriven",void 0),(0,a._)([(0,X.o)()],Ae.prototype,"usesHalfFloat",void 0);class ke extends Pe{constructor(){super(...arguments),this.isAttributeDriven=!1,this.usesHalfFloats=!1}}class Ke extends ce.F5{constructor(D){super(D,new ke),this._configuration=new Ae}requiresSlot(D,T){return D===Ce.r.DRAPED_MATERIAL&&T===W.H.Color}getConfiguration(){return this._configuration.isAttributeDriven=this.parameters.isAttributeDriven,this._configuration.usesHalfFloat=this.parameters.usesHalfFloats,this._configuration}createGLMaterial(D){return new qe(D)}intersect(){}intersectDraped(D,T,x,$,H,se){const le=D.vertexAttributes.get(o.T.POSITION),{parameters:Fe}=this,{searchRadius:Ie}=Fe,{screenToWorldRatio:Le}=D,Xe=Ie*Le+2*Le,ot=Xe*Xe,lt=le.data.length/le.size;for(let He=0;He<lt;He++){const Je=He*le.size,ut=(0,c.s)(st,le.data[Je],le.data[Je+1]);(0,c.k)(ut,$)<ot&&H(se.dist,se.normal,-1,!1)}}createBufferWriter(){return new et(this.parameters.isAttributeDriven?tt:Ze)}}class qe extends re.Z{beginSlot(D){return this.ensureTechnique(Me,D)}}class et{constructor(D){this.vertexBufferLayout=D}allocate(D){return this.vertexBufferLayout.createBuffer(D)}elementCount(D){return D.indices.get(o.T.POSITION).length*Ne}write(D,T,x,$,H){(0,pe.ho)(x.indices.get(o.T.POSITION),x.vertexAttributes.get(o.T.POSITION).data,D,$.position,H,Ne);const se=x.indices.get(o.T.POSITION).length,le=$.uv0;let Fe=H;for(let Le=0;Le<se;++Le)le.setValues(Fe++,-1,-1),le.setValues(Fe++,1,-1),le.setValues(Fe++,1,1),le.setValues(Fe++,1,1),le.setValues(Fe++,-1,1),le.setValues(Fe++,-1,-1);const Ie=o.T.FEATUREATTRIBUTE in $?$.featureAttribute:null;Ie&&(0,pe.XW)(x.indices.get(o.T.FEATUREATTRIBUTE),x.vertexAttributes.get(o.T.FEATUREATTRIBUTE).data,Ie,H,Ne)}}const Ze=(0,I.U$)().vec3f(o.T.POSITION).vec2f(o.T.UV0),tt=Ze.clone().f32(o.T.FEATUREATTRIBUTE),Ne=6,st=(0,S.a)();var ze=i(93579),it=i(3959);const Qe="esri.views.3d.layers.support.HeatmapFeatureProcessor",we=K.Z.getLogger(Qe);let z=class extends M.r{constructor(g){super(g),this.type="heatmap",this.preferredUpdatePolicy=r.j.ASYNC,this.dataExtent=null,this.drapeSourceType=ie.Lw.Features,this._renderGeometries=new Map,this._fieldTotal=0,this._drapeSourceRenderer=null,this._dataType=G.Br.HALF_FLOAT,this._pixelFormat=G.VI.RGBA,this.initializePromise=Promise.resolve()}initialize(){this._featureStore=new Z.Z({geometryType:"esriGeometryPoint",hasZ:this.hasZ,hasM:this.hasM});const{dataType:g,samplingMode:D,pixelFormat:T,internalFormat:x}=(0,it.v)(this._renderView.renderingContext,we);this._dataType=g,this._pixelFormat=T;const $=g!==G.Br.FLOAT;this._drapeSourceRenderer=this.view.basemapTerrain.overlayManager.registerDrapeSource(this,ve,{...this._rendererParameters,dataType:g,samplingMode:D,pixelFormat:T,internalFormat:x}),this._material=new Ke({usesHalfFloats:$}),this._materialWithField=new Ke({usesHalfFloats:$,isAttributeDriven:!0}),this._filterVisibility=new m.n({context:{layerView:this.owner,featureStore:this.featureStore,getFeatureCount:()=>this._loadedPointGraphics.length,setAllFeaturesVisibility:H=>this._setAllFeaturesVisibility(H),clearFeaturesVisibility:()=>this._setAllFeaturesVisibility(!0),updateFeatureVisibilities:H=>this._updateFeatureVisibilities(H)}}),this.updatingHandles.addOnCollectionChange(()=>this._loadedPointGraphics,H=>this._onLoadedFeaturesChange(H),A.nn),this.updatingHandles.addWhen(()=>this._materialParameters,H=>this._forEachMaterial(se=>se.setParameters(H)),A.nn),this.updatingHandles.add(()=>this._rendererParameters,H=>this._drapeSourceRenderer.set(H)),this.updatingHandles.add(()=>this._heatmapRendererField,()=>{this._recreate()},A.Z_),this.updatingHandles.add(()=>({fieldName:this._heatmapRendererFieldName,numeric:this._heatmapRendererFieldIsNumeric}),({fieldName:H,numeric:se})=>{if((0,b.pC)(H)&&se){let le=0;this._featureStore.forEach(Fe=>le+=Fe.attributes[H]??0),this._fieldTotal=le}else this._fieldTotal=this._featureStore.numFeatures},A.nn),this.handles.add([(0,A.YP)(()=>({fieldName:this._heatmapRendererFieldName,field:this._heatmapRendererField}),({fieldName:H,field:se})=>{H&&!se&&we.warn(`Heatmap renderer field '${H}' for layer '${this.layer.title??this.layer.id}' not found`)}),(0,A.YP)(()=>({field:this._heatmapRendererField,numeric:this._heatmapRendererFieldIsNumeric}),({field:H,numeric:se})=>{(0,b.pC)(H)&&!se&&we.warn(`Heatmap renderer field '${H.name}' for layer '${this.layer.title??this.layer.id}' does not contain numeric values and cannot be used to drive the heatmap density`)}),(0,Y.kB)(()=>this.view.basemapTerrain.overlayManager.unregisterDrapeSource(this))])}destroy(){this._renderGeometries.clear(),this._material=(0,b.M2)(this._material),this._materialWithField=(0,b.M2)(this._materialWithField),this._featureStore.clear(),this._featureStore=null}get layer(){return this.owner.layer}get featureStore(){return this._featureStore}get updating(){return this.updatingHandles.updating||this.filterVisibility.updating}get updatingRemaining(){return 0}get suspendInfo(){return{}}get legendEnabled(){return!0}get filterVisibility(){return this._filterVisibility}get displayFeatureLimit(){const D=this.owner?.view?.qualitySettings,T=D?Math.ceil(D.heatmap.maxTotalNumberOfFeatures*(this.owner?.view?.resourceController?.memoryController?.memoryFactor??1)):0;return{minimumTotalNumberOfFeatures:0,maximumTotalNumberOfFeatures:T,maximumTotalNumberOfPrimitives:2*T,maximumNumberOfFeatures:T}}get hasZ(){return"hasZ"in this.layer&&this.layer.hasZ}get hasM(){return"hasM"in this.layer&&this.layer.hasM}get view(){return this.owner.view}get fullOpacity(){return this.owner.fullOpacity}get updatePolicy(){return this.owner.updatePolicy}get scaleVisibilitySuspended(){if(!this._isScaleRangeActive)return!1;const{minScale:g,maxScale:D}=this.layer.effectiveScaleRange,{scale:T}=this.view;return!(0,ze.rs)(T,g??0,D??0)}get usedMemory(){const g=this.usedMemoryPerFeature*this._featureStore.numFeatures,D=this._pixelFormat===G.VI.RED?1:4,T=this._dataType===G.Br.FLOAT?4:2,x=Math.ceil((this._overlayRenderer?.overlays[0]?.resolution??0)*this._densityMapPixelRatio)??0;return x*x*D*T+g}get usedMemoryPerFeature(){const g=this._loadedPointGraphics.find(()=>!0);if((0,b.Wi)(g))return 0;const D=(0,j.f2)(g),T=(0,j.G3)();return 6*(0,j.do)([0,0,0],T)+6*(0,j.do)([0,0],T)+(this._heatmapRendererFieldIsNumeric?6*T:0)+D}get loadedFeatures(){return this._featureStore.numFeatures}get unprocessedMemoryEstimate(){return 0}get performanceInfo(){return{core:{visible:this._visibleFeatures,missing:0,pending:0},elevationUpdating:!1,visibilityFrustum:!0,visibilityScale:!0}}get renderer(){return this._heatmapRenderer}get _overlayRenderer(){return this.view.basemapTerrain.overlayManager.renderer}get _overlaySpatialReference(){return(0,b.Wg)(this._overlayRenderer.spatialReference)}get _rendererParameters(){return{...this._radiusParameter,...this._densityParameters,...this._colorRampParameter,...this._pixelRatioParameter}}get _materialParameters(){return{...this._radiusParameter,...this._resolutionForScaleParameter}}get _densityParameters(){const g=this._heatmapRenderer;if((0,b.Wi)(g))return null;const{minDensity:D,maxDensity:T}=g;return{minDensity:D,maxDensity:T,fieldTotal:this._fieldTotal}}get _radiusParameter(){return(0,b.yw)(this._heatmapRenderer,({radius:g})=>({searchRadius:(0,E.F2)(this._clampSearchRadius(g))}))}get _resolutionForScaleParameter(){return(0,b.yw)(this._heatmapRenderer,({referenceScale:g})=>({resolutionForScale:0===g?0:(0,ne.dp)(g,this.view.spatialReference)}))}get _colorRampParameter(){return(0,b.yw)(this._heatmapRenderer,g=>({colorRampData:(0,xe.uI)(g.colorStops)}))}get _pixelRatioParameter(){return{pixelRatio:this._densityMapPixelRatio}}get _densityMapPixelRatio(){return(this.owner?.view?.qualitySettings.heatmap.pixelRatio??1)*Math.sqrt(this.owner?.view?.resourceController?.memoryController?.memoryFactor??1)}get _renderView(){return this.view._stage.renderView}get _featuresArePoints(){return"point"===this.layer.geometryType}get _loadedPointGraphics(){return this.owner.loadedGraphics}get _heatmapRenderer(){const g=this.layer.renderer;return"heatmap"===g?.type?g:null}get _heatmapRendererFieldName(){return(0,b.yw)(this._heatmapRenderer,g=>g.field)}get _heatmapRendererField(){return(0,b.yw)(this._heatmapRendererFieldName,g=>this.layer.fieldsIndex.get(g))}get _heatmapRendererFieldIsNumeric(){const g=this._heatmapRendererField;return!(0,b.Wi)(g)&&(0,Re.H7)(g)}get _isScaleRangeActive(){const{layer:g}=this;if(!("effectiveScaleRange"in g))return!1;const{minScale:D,maxScale:T}=g.effectiveScaleRange;return(0,ze.Av)(D,T)}get _visibleFeatures(){let g=0;return this._renderGeometries.forEach(D=>{D.visible&&++g}),g}whenGraphicBounds(){return(0,F.Z)(function*(){return null})()}computeAttachmentOrigin(){return null}highlight(){return Ye}maskOccludee(){return Ye}setObjectIdVisibility(){}refreshFilter(){this.filterVisibility.reapply()}_onLoadedFeaturesChange(g){if(!this._featuresArePoints)return;const{objectIdField:D}=this.layer;this._featureStore.removeManyById(g.removed.map(se=>(0,ue.MS)(se,D))),this._featureStore.addMany(g.added.map(se=>{const le=new he.u_((0,de.dd)(new ge.Z,se.geometry),se.attributes,(0,b.yw)(se.centroid,Fe=>(0,de.dd)(new ge.Z,Fe)),(0,ue.MS)(se,D));return le.displayId=se.uid,le}));const T=g.added,x=g.removed;this._fieldTotal+=this._computeFieldTotalChange(T,x);const $=(0,b.e8)(x,({uid:se})=>{const le=this._renderGeometries.get(se);return this._renderGeometries.delete(se),le}),H=T.map(se=>{const le=this._pointGraphicToRenderGeometry(se);return this._renderGeometries.set(se.uid,le),le});$.length>0&&this._drapeSourceRenderer.removeGeometries($,Se.T.REMOVE),H.length>0&&this._drapeSourceRenderer.addGeometries(H,Se.T.ADD),(H.length>0||$.length>0)&&(this.filterVisibility.reapply(),this._renderView.requestRender())}_recreate(){if(!this._loadedPointGraphics)return;const g=this._loadedPointGraphics.toArray();this._onLoadedFeaturesChange({added:g,removed:g})}_pointGraphicToRenderGeometry(g){const D=this._heatmapRendererFieldName,T=(0,b.pC)(D)?this._materialWithField:this._material,x=(0,N.c)();(0,J.KC)(g.geometry,x,this._overlaySpatialReference),x[2]=B.Rn;const $=[[o.T.POSITION,new oe.a(x,x.length)]],H=this._heatmapRendererFieldIsNumeric;(0,b.pC)(D)&&$.push([o.T.FEATUREATTRIBUTE,new oe.a([H?g.attributes[D]??0:0],1)]);const se=new s.z(new We.Z(T,$,null,null,Q.U.Point),{layerUid:this.layer.uid,graphicUid:g.uid});return(0,R.c)(se.boundingSphere,x),se.visible=this.filterVisibility.defaultVisibility,se}_forEachMaterial(g){g(this._material),g(this._materialWithField)}_computeFieldTotalChange(g,D){if((0,b.Wi)(this._heatmapRendererFieldName)||!this._heatmapRendererFieldIsNumeric)return g.length-D.length;const T=this._heatmapRendererFieldName,x=($,H)=>$+(H.attributes[T]??0);return g.reduce(x,0)-D.reduce(x,0)}_clampSearchRadius(g){return g>112&&we.warnOnce("SceneView supports a maximum radius of 112 pt for HeatmapRenderer."),Math.min(g,112)}_updateFeatureVisibilities(g){const D=[];this._featureStore.forEach(({objectId:T,displayId:x})=>{const $=g(T),H=this._renderGeometries.get(x);H&&H.visible!==$&&(D.push(H),H.visible=$)}),this._drapeSourceRenderer.modifyGeometries(D,Se.$.VISIBILITY)}_setAllFeaturesVisibility(g){const D=[];for(const T of this._renderGeometries.values())T.visible!==g&&(D.push(T),T.visible=g);this._drapeSourceRenderer.modifyGeometries(D,Se.$.VISIBILITY)}get test(){return{visibleFeatureCount:this._visibleFeatures}}};(0,a._)([(0,l.Cb)()],z.prototype,"type",void 0),(0,a._)([(0,l.Cb)({constructOnly:!0})],z.prototype,"owner",void 0),(0,a._)([(0,l.Cb)()],z.prototype,"layer",null),(0,a._)([(0,l.Cb)()],z.prototype,"featureStore",null),(0,a._)([(0,l.Cb)()],z.prototype,"updating",null),(0,a._)([(0,l.Cb)()],z.prototype,"updatingRemaining",null),(0,a._)([(0,l.Cb)()],z.prototype,"suspendInfo",null),(0,a._)([(0,l.Cb)()],z.prototype,"legendEnabled",null),(0,a._)([(0,l.Cb)()],z.prototype,"filterVisibility",null),(0,a._)([(0,l.Cb)()],z.prototype,"displayFeatureLimit",null),(0,a._)([(0,l.Cb)()],z.prototype,"preferredUpdatePolicy",void 0),(0,a._)([(0,l.Cb)()],z.prototype,"hasZ",null),(0,a._)([(0,l.Cb)()],z.prototype,"hasM",null),(0,a._)([(0,l.Cb)()],z.prototype,"dataExtent",void 0),(0,a._)([(0,l.Cb)()],z.prototype,"view",null),(0,a._)([(0,l.Cb)()],z.prototype,"fullOpacity",null),(0,a._)([(0,l.Cb)()],z.prototype,"updatePolicy",null),(0,a._)([(0,l.Cb)()],z.prototype,"drapeSourceType",void 0),(0,a._)([(0,l.Cb)()],z.prototype,"scaleVisibilitySuspended",null),(0,a._)([(0,l.Cb)()],z.prototype,"renderer",null),(0,a._)([(0,l.Cb)()],z.prototype,"_featureStore",void 0),(0,a._)([(0,l.Cb)()],z.prototype,"_filterVisibility",void 0),(0,a._)([(0,l.Cb)()],z.prototype,"_overlayRenderer",null),(0,a._)([(0,l.Cb)()],z.prototype,"_overlaySpatialReference",null),(0,a._)([(0,l.Cb)()],z.prototype,"_rendererParameters",null),(0,a._)([(0,l.Cb)()],z.prototype,"_materialParameters",null),(0,a._)([(0,l.Cb)()],z.prototype,"_densityParameters",null),(0,a._)([(0,l.Cb)()],z.prototype,"_radiusParameter",null),(0,a._)([(0,l.Cb)()],z.prototype,"_resolutionForScaleParameter",null),(0,a._)([(0,l.Cb)()],z.prototype,"_colorRampParameter",null),(0,a._)([(0,l.Cb)()],z.prototype,"_pixelRatioParameter",null),(0,a._)([(0,l.Cb)()],z.prototype,"_densityMapPixelRatio",null),(0,a._)([(0,l.Cb)()],z.prototype,"_renderGeometries",void 0),(0,a._)([(0,l.Cb)()],z.prototype,"_material",void 0),(0,a._)([(0,l.Cb)()],z.prototype,"_materialWithField",void 0),(0,a._)([(0,l.Cb)()],z.prototype,"_renderView",null),(0,a._)([(0,l.Cb)()],z.prototype,"_featuresArePoints",null),(0,a._)([(0,l.Cb)()],z.prototype,"_loadedPointGraphics",null),(0,a._)([(0,l.Cb)()],z.prototype,"_heatmapRenderer",null),(0,a._)([(0,l.Cb)()],z.prototype,"_heatmapRendererFieldName",null),(0,a._)([(0,l.Cb)()],z.prototype,"_heatmapRendererField",null),(0,a._)([(0,l.Cb)()],z.prototype,"_heatmapRendererFieldIsNumeric",null),(0,a._)([(0,l.Cb)()],z.prototype,"_fieldTotal",void 0),(0,a._)([(0,l.Cb)()],z.prototype,"_drapeSourceRenderer",void 0),(0,a._)([(0,l.Cb)()],z.prototype,"_isScaleRangeActive",null),z=(0,a._)([(0,y.j)(Qe)],z);const Ye=(0,Y.kB)();var rt=i(89765),at=i(87091);const nt=g=>{let D=class extends g{constructor(){super(...arguments),this.controller=null,this.updatePolicy=r.j.SYNC,this.suspendResumeExtentMode="computed",this.slicePlaneEnabled=!1,this.fullExtentInLocalViewSpatialReference=null,this.suspendResumeExtent=null,this._controllerCreated=!1,this.supportsHeightUnitConversion=!0,this._pendingController=null,this.queryEngine=null}initialize(){var T=this;const x=this.layer;if("isTable"in x&&x.isTable)return void this.addResolvingPromise(Promise.reject(new U.Z("featurelayerview:table-not-supported","table feature layer can't be displayed",{layer:x})));this.addResolvingPromise(this._validateGeometryType()),this.updatingHandles.add(()=>this.layer.renderer,H=>this._recreateProcessor(H),A.nn),this.addResolvingPromise((0,F.Z)(function*(){const H=yield(0,rt.E)(T);T.fullExtentInLocalViewSpatialReference=H,yield T._initializeController()})()),this.updatingHandles.add(()=>this.updatePolicy,H=>this.processor.preferredUpdatePolicy=H);const $=()=>this.processor.featureStore;this.queryEngine=new P.q({context:{spatialReference:this.view.spatialReference,layer:this.layer,scheduler:this.view.resourceController.scheduler,get featureStore(){return $()},hasZ:this.hasZ,hasM:this.hasM},priority:at.T8.FEATURE_QUERY_ENGINE}),this.notifyChange("updating")}destroy(){this._destroyPendingController(),this.controller=(0,b.SC)(this.controller),this._set("processor",(0,b.SC)(this.processor)),this.queryEngine=(0,b.SC)(this.queryEngine),this.loadedGraphics=null}_destroyPendingController(){this._pendingController=(0,b.SC)(this._pendingController)}get legendEnabled(){return this.canResume()&&this.processor?.legendEnabled}get graphics3DProcessor(){return"graphics-3d"===this.processor?.type?this.processor:null}get heatmapProcessor(){return"heatmap"===this.processor?.type?this.processor:null}get symbologySnappingSupported(){return this.layer?.renderer?.getSymbols()?.some(L.QL)??!1}getHit(T){let x;return this.loadedGraphics?.forEach($=>{$.uid===T&&(x=(0,u.mW)($,this.layer))}),x?{type:"graphic",graphic:x,layer:x.layer}:null}whenGraphicBounds(T,x){return this.processor?.whenGraphicBounds(T,x)}computeAttachmentOrigin(T,x){return this.processor?.computeAttachmentOrigin(T,x)}elevationAlignPointsInFeatures(T,x){var $=this;return(0,F.Z)(function*(){const H=$.graphics3DProcessor;if((0,b.Wi)(H))throw new U.Z("featurelayerview3d:missing-processor","A Graphics3D processor is needed to resolve graphics elevation.");return(0,_.W)($.view,$.layer,se=>H.getGraphics3DGraphicByObjectId(se),T,x)})()}queryForSymbologySnapping(T,x){var $=this;return(0,F.Z)(function*(){return $.symbologySnappingSupported?(0,O.c)($.graphics3DProcessor,T,x):{candidates:[],sourceCandidateIndices:[]}})()}queryFeatures(T,x){return this.queryEngine.executeQuery(this._ensureQuery(T),(0,b.U2)(x,"signal"))}queryObjectIds(T,x){return this.queryEngine.executeQueryForIds(this._ensureQuery(T),(0,b.U2)(x,"signal"))}queryFeatureCount(T,x){return this.queryEngine.executeQueryForCount(this._ensureQuery(T),(0,b.U2)(x,"signal"))}queryExtent(T,x){return this.queryEngine.executeQueryForExtent(this._ensureQuery(T),(0,b.U2)(x,"signal"))}_ensureQuery(T){return(0,b.Wi)(T)?this.createQuery():v.Z.from(T)}highlight(T){return this.processor.highlight(T,this.layer.objectIdField)}maskOccludee(T){return this.processor.maskOccludee(T)}canResume(){return super.canResume()&&!this.processor?.scaleVisibilitySuspended}getSuspendInfo(){const T=super.getSuspendInfo();return this.processor?{...T,...this.processor.suspendInfo}:T}isUpdating(){return!(!this.processor||this.processor.destroyed||this._controllerCreated&&!this.controller?.updating&&this.view?.basemapTerrain?.ready&&!this.processor.updating)}_initializeController(){var T=this;return(0,F.Z)(function*(){const x=T.createController();T._pendingController=x,yield x.when(),T._setControllerWhenInitialized(x)})()}_setControllerWhenInitialized(T){var x=this;return(0,F.Z)(function*(){try{yield x.when()}catch{}x._controllerCreated=!0,x.notifyChange("updating"),x.isResolved()&&!x.destroyed?(yield(0,A.N1)(()=>x.view?.basemapTerrain?.ready),x.beforeSetController(T),x._pendingController=null,x.controller=T,x.loadedGraphics=T.graphics,x.notifyChange("updating")):x._destroyPendingController()})()}_updateClippingExtent(T){if(this.clippingExtent=T,!this.controller)return!1;switch(this.controller.type){case"stream":return!1;case"feature-tile-3d":return this.controller.extent=T,!0}}_validateGeometryType(){var T=this;return(0,F.Z)(function*(){switch(T.layer.geometryType){case"multipatch":case"multipoint":throw new U.Z("featurelayerview3d:unsupported-geometry-type","Unsupported geometry type ${geometryType}",{geometryType:T.layer.geometryType})}})()}_recreateProcessor(T){const x="heatmap"===T?.type,H=this.processor;if(H&&x===("heatmap"===this.processor?.type))return;const se=x?new z({owner:this}):new h.Z({owner:this,frustumVisibilityEnabled:!0,scaleVisibilityEnabled:!0,filterVisibilityEnabled:!0,timeExtentEnabled:!0,elevationAlignmentEnabled:!0,elevationFeatureExpressionEnabled:!0,preferredUpdatePolicy:this.updatePolicy,updateClippingExtent:le=>this._updateClippingExtent(le)});this._set("processor",se),H?.destroy(),this.queryEngine?.clear(),this.addResolvingPromise(se.initializePromise)}_getResourceInfo(){const T=this.controller instanceof p.g?this.controller:null;return{displayedNumberOfFeatures:this.loadedGraphics.length,maximumNumberOfFeatures:T?.maximumNumberOfFeatures??-1,totalNumberOfFeatures:T?.serviceDataCount??-1,nodes:0,...this.processor.performanceInfo}}get performanceInfo(){return this._getResourceInfo()}};return(0,a._)([(0,l.Cb)()],D.prototype,"loadedGraphics",void 0),(0,a._)([(0,l.Cb)()],D.prototype,"suspended",void 0),(0,a._)([(0,l.Cb)({readOnly:!0})],D.prototype,"legendEnabled",null),(0,a._)([(0,l.Cb)()],D.prototype,"updating",void 0),(0,a._)([(0,l.Cb)()],D.prototype,"controller",void 0),(0,a._)([(0,l.Cb)()],D.prototype,"processor",void 0),(0,a._)([(0,l.Cb)({readOnly:!0})],D.prototype,"updatePolicy",void 0),(0,a._)([(0,l.Cb)({readOnly:!0})],D.prototype,"suspendResumeExtentMode",void 0),(0,a._)([(0,l.Cb)({type:Boolean})],D.prototype,"slicePlaneEnabled",void 0),(0,a._)([(0,l.Cb)({readOnly:!0})],D.prototype,"suspendInfo",void 0),(0,a._)([(0,l.Cb)()],D.prototype,"graphics3DProcessor",null),(0,a._)([(0,l.Cb)()],D.prototype,"heatmapProcessor",null),(0,a._)([(0,l.Cb)()],D.prototype,"symbologySnappingSupported",null),D=(0,a._)([(0,y.j)("esri.views.3d.layers.FeatureLikeLayerView3D")],D),D}},19702:(fe,ee,i)=>{i.d(ee,{A:()=>p});var F=i(15861),a=i(17626),U=i(54024),b=i(10699),A=i(32917),l=i(77712),y=(i(90912),i(85931),i(76898)),u=i(36947);const p=v=>{let L=class extends v{constructor(){super(...arguments),this.slicePlaneEnabled=!1,this.supportsHeightUnitConversion=!1}postscript(_){super.postscript(_),(0,u.qC)(this.layer)&&this.addResolvingPromise(this._validateHeightModelInfo())}_validateHeightModelInfo(){var _=this;return(0,F.Z)(function*(){const h=new AbortController,P=h.signal;_.handles.add((0,U.kB)(()=>h.abort())),yield(0,A.N1)(()=>_.view.defaultsFromMap?.heightModelInfoReady,P),(0,b.k_)(P);const O=(0,u.Wt)(_.layer,_.view.heightModelInfo,_.supportsHeightUnitConversion);if(O)throw O})()}canResume(){const _=this.layer&&"effectiveScaleRange"in this.layer?this.layer.effectiveScaleRange:null;return super.canResume()&&(!_||!_.minScale||!_.maxScale||_.minScale>=_.maxScale)}getSuspendInfo(){const _=super.getSuspendInfo(),h=this.layer&&"effectiveScaleRange"in this.layer?this.layer.effectiveScaleRange:null;return h&&h.minScale&&h.maxScale&&h.minScale<h.maxScale&&(_.outsideScaleRange=!0),_}};return(0,a._)([(0,l.Cb)()],L.prototype,"view",void 0),(0,a._)([(0,l.Cb)()],L.prototype,"slicePlaneEnabled",void 0),L=(0,a._)([(0,y.j)("esri.views.3d.layers.LayerView3D")],L),L}},33816:(fe,ee,i)=>{i.d(ee,{Z:()=>Re});var F=i(15861),a=i(17626),U=i(88879),b=i(46668),A=i(94573),l=i(80542),f=i(62208),w=i(10699),y=i(32917),u=i(77712),L=(i(90912),i(85931),i(76898)),_=i(84682),h=i(46367),P=i(32028),O=i(39256),j=i(96854),M=i(62600),Y=i(80960),K=i(1191),E=i(94991),R=i(83518),N=i(14752),J=i(67873),ne=i(67225),ue=i(97445),de=i(98667),he=i(42743),ge=i(23147);let Z=class extends l.r{constructor(m){super(m),this.type="graphics-3d",this._randomRotationRenderers=null,this.elevationFeatureExpressionEnabled=!1,this.scaleVisibilityEnabled=!1,this.filterVisibilityEnabled=!1,this.frustumVisibilityEnabled=!1,this.elevationAlignmentEnabled=!1,this.timeExtentEnabled=!1,this.setUidToIdOnAdd=!0,this.dataExtent=null,this.drapeSourceType=M.Lw.Features,this.preferredUpdatePolicy=ge.j.ASYNC,this._suspendResumeExtent=null}initialize(){const m=this.owner,oe=new K.w({owner:this,layer:this.layer,preferredUpdatePolicy:this.preferredUpdatePolicy,elevationFeatureExpressionEnabled:this.elevationFeatureExpressionEnabled,graphicSymbolSupported:!1,hasZ:m.hasZ,hasM:m.hasM,setUidToIdOnAdd:this.setUidToIdOnAdd,componentFactories:{deconflictor:Q=>m.view.deconflictor.addGraphicsOwner(Q),labeler:(Q,k)=>m.view.labeler.addGraphicsOwner(Q,k),elevationAlignment:this.elevationAlignmentEnabled?(Q,k)=>new E.Z({graphicsCoreOwner:this,graphicsCore:Q,queryGraphicUIDsInExtent:k,elevationProvider:m.view.elevationProvider}):null,scaleVisibility:this.scaleVisibilityEnabled?(Q,k)=>new J.Z({graphicsCoreOwner:this,layer:this.layer,queryGraphicUIDsInExtent:k,graphicsCore:Q,basemapTerrain:m.view.basemapTerrain}):null,filterVisibility:(this.filterVisibilityEnabled||this.timeExtentEnabled)&&"multipatch"!==m.layer.geometryType?Q=>new de.n({context:{layerView:m,...Q}}):null,objectStates:Q=>new N.d(Q)}});this._set("graphicsCore",oe),this.frustumVisibilityEnabled&&this._set("frustumVisibility",new R.Z({graphicsCoreOwner:this})),this.elevationAlignment&&this.updatingHandles.add(()=>this.layer.elevationInfo,(Q,k)=>{(0,_.Hg)(Q,k)&&this.updatingHandles.addPromise(this.graphicsCore.elevationInfoChange())}),this.updatingHandles.add(()=>this.layer.labelsVisible,()=>this.graphicsCore.updateVisibilityInfo()),this.updatingHandles.add(()=>this.layer.labelingInfo,(Q,k)=>{(0,_.Hg)(Q,k)&&this.graphicsCore.updateLabelingInfo()}),this.updatingHandles.add(()=>this.preferredUpdatePolicy,Q=>this.graphicsCore.preferredUpdatePolicy=Q),this._set("initializePromise",this._initializeAsync()),this.updatingHandles.addPromise(this.initializePromise)}_initializeAsync(){var m=this;return(0,F.Z)(function*(){yield(0,w.U3)(m.graphicsCore.initializePromise);const B=m.owner;m.updatingHandles.add(()=>m.renderer,oe=>m.updatingHandles.addPromise(m.graphicsCore.rendererChange(oe))),m.updatingHandles.add(()=>B.fullOpacity,()=>m.graphicsCore.opacityChange()),m._setupSuspendResumeExtent(),m.updateClippingExtent&&(m.updatingHandles.add(()=>B.view.clippingArea,()=>m._updateClippingExtent()),m._updateClippingExtent()),m.graphicsCore.startCreateGraphics(),m.graphicsCore.labelsEnabled&&(yield(0,w.U3)(m.graphicsCore.updateLabelingInfo()))})()}destroy(){this.handles.removeAll(),this.updatingHandles.removeAll(),this._set("frustumVisibility",(0,f.SC)(this.frustumVisibility)),this._set("graphicsCore",(0,f.SC)(this.graphicsCore)),this._set("owner",null)}get layer(){return this.owner.layer}get renderer(){const{renderer:m,objectIdField:B}=this.layer;if(!m||!B||"heatmap"===m.type||!m.visualVariables)return m;const oe=m.visualVariables.findIndex(k=>"rotation"===k.type&&null!=k.valueExpression&&(0,P.v)(k.valueExpression)===B&&(null==k.axis||"heading"===k.axis)&&"geographic"===k.rotationType);if(oe<0)return m;const Q=m.clone();return Q.visualVariables.splice(oe,1),this._randomRotationRenderers||(this._randomRotationRenderers=new WeakMap),this._randomRotationRenderers.set(Q,B),Q}get scaleVisibility(){return this.graphicsCore?.scaleVisibility}get filterVisibility(){return this.graphicsCore?.filterVisibility}get elevationAlignment(){return this.graphicsCore?.elevationAlignment}get objectStates(){return this.graphicsCore?.objectStates}get suspendResumeExtentMode(){return"suspendResumeExtentMode"in this.owner?this.owner.suspendResumeExtentMode:"computed"}get scaleVisibilitySuspended(){return(0,f.pC)(this.scaleVisibility)&&this.scaleVisibility.suspended}get suspended(){return this.owner.suspended}get legendEnabled(){return(0,f.Wi)(this.frustumVisibility)||!this.frustumVisibility.suspended}get suspendInfo(){const m={};return this.scaleVisibilitySuspended&&(m.outsideScaleRange=!0),(0,f.pC)(this.frustumVisibility)&&this.frustumVisibility.suspended&&(m.outsideOfView=!0),m}get updating(){return!!(this.graphicsCore?.updating||(0,f.pC)(this.frustumVisibility)&&this.frustumVisibility.updating||this.updatingHandles?.updating)}get updatingRemaining(){return this.graphicsCore?.updatingRemaining??0}get featureStore(){return this.graphicsCore?.featureStore}get view(){return this.owner.view}get loadedGraphics(){return this.owner.loadedGraphics}get fullOpacity(){return this.owner?.fullOpacity}get filter(){return"filter"in this.owner?this.owner.filter:null}get slicePlaneEnabled(){return this.owner.slicePlaneEnabled}get updatePolicy(){return this.owner.updatePolicy}get featureSpatialReference(){return"featureSpatialReference"in this.owner?this.owner.featureSpatialReference:this.owner.view.spatialReference}get graphics3DGraphics(){return this.graphicsCore?.graphics3DGraphics}get graphics3DGraphicsByObjectID(){return this.graphicsCore?.graphics3DGraphicsByObjectID}get symbolUpdateType(){return this.graphicsCore?.symbolUpdateType}get displayFeatureLimit(){const m=this.view.resourceController.memoryController.memoryFactor,B=this.graphicsCore?.displayFeatureLimit;if(1===m)return B;const oe=Math.ceil(B.maximumNumberOfFeatures*m),Q=Math.ceil(B.maximumTotalNumberOfFeatures*m),k=Math.ceil(B.minimumTotalNumberOfFeatures*m);return{...B,maximumNumberOfFeatures:oe,maximumTotalNumberOfFeatures:Q,minimumTotalNumberOfFeatures:k}}get usedMemory(){return this.graphicsCore?.usedMemory??0}get loadedFeatures(){return this.graphicsCore?.numberOfGraphics??0}get usedMemoryPerFeature(){return this.graphicsCore?.usedMemoryPerGraphic??0}get unprocessedMemoryEstimate(){return this.graphicsCore?.unprocessedMemoryEstimate??0}get performanceInfo(){return{core:this.graphicsCore.performanceInfo,elevationUpdating:this.elevationAlignment.updating,visibilityFrustum:(0,f.Wi)(this.frustumVisibility)||!this.frustumVisibility.suspended,visibilityScale:!this.scaleVisibilitySuspended}}maskOccludee(m){const{set:B,handle:oe}=this.objectStates.acquireSet(he.V_.MaskOccludee,null);return this.objectStates.setUid(B,m.uid),oe}highlight(m,B){if(m instanceof j.Z){const{set:oe,handle:Q}=this.objectStates.acquireSet(he.V_.Highlight,B);return this.owner.queryObjectIds(m).then(k=>this.objectStates.setObjectIds(oe,k)),Q}if("number"==typeof m||"string"==typeof m)return this.highlight([m],B);if(m instanceof U.Z)return this.highlight([m],B);if("toArray"in m&&(m=m.toArray()),Array.isArray(m)&&m.length>0){if(m[0]instanceof U.Z){const oe=m;if(null==(0,ue.g)(this.layer.fieldsIndex,oe[0].attributes,B)){const Q=oe.map(C=>C.uid),{set:k,handle:_e}=this.objectStates.acquireSet(he.V_.Highlight,null);return this.objectStates.setUids(k,Q),_e}m=oe.map(Q=>(0,ue.g)(this.layer.fieldsIndex,Q.attributes,B))}if("number"==typeof m[0]||"string"==typeof m[0]){const oe=m,{set:Q,handle:k}=this.objectStates.acquireSet(he.V_.Highlight,B);return this.objectStates.setObjectIds(Q,oe),k}}return ie}resetObjectStates(){this.objectStates.reset()}whenGraphicBounds(m,B){return this.graphicsCore?.whenGraphicBounds(m,B)}computeAttachmentOrigin(m,B){return this.graphicsCore?.computeAttachmentOrigin(m,B)}notifyGraphicGeometryChanged(m){this.graphicsCore.notifyGraphicGeometryChanged(m)}notifyGraphicVisibilityChanged(m){this.graphicsCore.notifyGraphicVisibilityChanged(m)}getRenderingInfo(m,B,oe){const Q=(0,O.Kb)(m,{renderer:B,arcade:oe});if((0,f.pC)(Q)&&Q.color){const k=Q.color;k[0]=k[0]/255,k[1]=k[1]/255,k[2]=k[2]/255}if((0,f.pC)(Q)&&(0,f.pC)(B)&&this._randomRotationRenderers?.has(B)){const k=this._randomRotationRenderers.get(B),_e=m.attributes[k],C=new b.a(0);C.updateFloatArray([_e]),C.updateUint8Array([173]),Q.heading=8.381e-8*C.digest()}return Q}getRenderingInfoAsync(m,B,oe,Q){return(0,O.xn)(m,{renderer:B,arcade:oe,...Q})}getSymbolLayerSize(m,B){return this.graphicsCore?.getSymbolLayerSize(m,B)}setObjectIdVisibility(m,B){this.graphicsCore?.setObjectIdVisibility(m,B)}refreshFilter(){(0,f.pC)(this.filterVisibility)&&this.filterVisibility.reapply()}getGraphics3DGraphicByObjectId(m){return this.graphicsCore?.getGraphics3DGraphicByObjectId(m)}_updateClippingExtent(){const m=this.owner.view.clippingArea;this.graphicsCore.setClippingExtent(m,this.owner.view.spatialReference)&&(this.updateClippingExtent(m)||this.graphicsCore.recreateAllGraphics())}_setupSuspendResumeExtent(){(this.frustumVisibility||this.scaleVisibility)&&this.handles.add((0,y.YP)(()=>this.suspendResumeExtentMode,()=>{switch(this.handles.remove(xe),this.suspendResumeExtentMode){case"computed":this.handles.add([(0,y.YP)(()=>this.graphicsCore.computedExtent,m=>this._updateSuspendResumeExtent(m),y.nn),(0,y.YP)(()=>this.graphicsCore.extentPadding,()=>this._updateSuspendResumeExtent(this.graphicsCore.computedExtent))],xe);break;case"data":this.handles.add([(0,y.gx)(()=>this.dataExtent,m=>this._updateSuspendResumeExtent(m),y.nn),(0,y.YP)(()=>this.graphicsCore.extentPadding,()=>this._updateSuspendResumeExtent((0,f.Wg)(this.dataExtent)))],xe);break;default:(0,A.Bg)(this.suspendResumeExtentMode)}},y.nn))}_updateSuspendResumeExtent(m){this._suspendResumeExtentChanged(m?this._extentToSuspendResumeRect(m,this._suspendResumeExtent):null)}_extentToSuspendResumeRect(m,B){const oe=this.owner.view.spatialReference;if(!m.spatialReference.equals(oe)){if(!(0,h.Q8)(m,oe))return;m=(0,h.iV)(m,oe)}return(0,ne.Go)(m,B,Y.Z,this.graphicsCore.extentPadding)}_suspendResumeExtentChanged(m){(0,f.pC)(this.frustumVisibility)&&this.frustumVisibility.setExtent(m),(0,f.pC)(this.scaleVisibility)&&this.scaleVisibility.setExtent(m)}};(0,a._)([(0,u.Cb)()],Z.prototype,"type",void 0),(0,a._)([(0,u.Cb)({constructOnly:!0})],Z.prototype,"owner",void 0),(0,a._)([(0,u.Cb)()],Z.prototype,"layer",null),(0,a._)([(0,u.Cb)()],Z.prototype,"renderer",null),(0,a._)([(0,u.Cb)({constructOnly:!0})],Z.prototype,"updateClippingExtent",void 0),(0,a._)([(0,u.Cb)({constructOnly:!0})],Z.prototype,"elevationFeatureExpressionEnabled",void 0),(0,a._)([(0,u.Cb)({constructOnly:!0})],Z.prototype,"graphicsCore",void 0),(0,a._)([(0,u.Cb)({constructOnly:!0})],Z.prototype,"scaleVisibilityEnabled",void 0),(0,a._)([(0,u.Cb)({constructOnly:!0})],Z.prototype,"filterVisibilityEnabled",void 0),(0,a._)([(0,u.Cb)({constructOnly:!0})],Z.prototype,"frustumVisibilityEnabled",void 0),(0,a._)([(0,u.Cb)({constructOnly:!0})],Z.prototype,"elevationAlignmentEnabled",void 0),(0,a._)([(0,u.Cb)({constructOnly:!0})],Z.prototype,"timeExtentEnabled",void 0),(0,a._)([(0,u.Cb)({constructOnly:!0})],Z.prototype,"setUidToIdOnAdd",void 0),(0,a._)([(0,u.Cb)()],Z.prototype,"scaleVisibility",null),(0,a._)([(0,u.Cb)()],Z.prototype,"filterVisibility",null),(0,a._)([(0,u.Cb)()],Z.prototype,"elevationAlignment",null),(0,a._)([(0,u.Cb)({constructOnly:!0})],Z.prototype,"frustumVisibility",void 0),(0,a._)([(0,u.Cb)()],Z.prototype,"objectStates",null),(0,a._)([(0,u.Cb)()],Z.prototype,"initializePromise",void 0),(0,a._)([(0,u.Cb)()],Z.prototype,"suspendResumeExtentMode",null),(0,a._)([(0,u.Cb)()],Z.prototype,"dataExtent",void 0),(0,a._)([(0,u.Cb)()],Z.prototype,"scaleVisibilitySuspended",null),(0,a._)([(0,u.Cb)()],Z.prototype,"suspended",null),(0,a._)([(0,u.Cb)()],Z.prototype,"legendEnabled",null),(0,a._)([(0,u.Cb)()],Z.prototype,"suspendInfo",null),(0,a._)([(0,u.Cb)()],Z.prototype,"updating",null),(0,a._)([(0,u.Cb)()],Z.prototype,"updatingRemaining",null),(0,a._)([(0,u.Cb)()],Z.prototype,"featureStore",null),(0,a._)([(0,u.Cb)()],Z.prototype,"view",null),(0,a._)([(0,u.Cb)()],Z.prototype,"loadedGraphics",null),(0,a._)([(0,u.Cb)()],Z.prototype,"fullOpacity",null),(0,a._)([(0,u.Cb)()],Z.prototype,"filter",null),(0,a._)([(0,u.Cb)()],Z.prototype,"slicePlaneEnabled",null),(0,a._)([(0,u.Cb)()],Z.prototype,"drapeSourceType",void 0),(0,a._)([(0,u.Cb)()],Z.prototype,"updatePolicy",null),(0,a._)([(0,u.Cb)()],Z.prototype,"preferredUpdatePolicy",void 0),(0,a._)([(0,u.Cb)()],Z.prototype,"displayFeatureLimit",null),Z=(0,a._)([(0,L.j)("esri.views.3d.layers.graphics.Graphics3DFeatureProcessor")],Z);const Re=Z,xe="suspendResumeExtentMode",ie={remove(){},pause(){},resume(){}}},34675:(fe,ee,i)=>{i.d(ee,{q:()=>P});var F=i(15861),a=i(17626),b=(i(29132),i(14517)),A=i(62208),l=i(77712),y=(i(90912),i(85931),i(76898)),u=i(2004),p=i(58175),v=i(17253),L=i(96854),_=i(71774);const h=p.q;let P=class extends b.Z{get layer(){return this.context.layer}get spatialReference(){return this.context.spatialReference}get _queryGeometryType(){switch(this.layer.geometryType){case"multipoint":case"point":case"polygon":case"polyline":return this.layer.geometryType;case"mesh":return"polygon";default:return}}get defaultQueryJSON(){return new L.Z({outSpatialReference:this.spatialReference}).toJSON()}get _dataQueryEngine(){return this._ensureDataQueryEngine()}constructor(O){super(O),this._dataQueryEngineInstance=null}destroy(){this.clear()}clear(){return!!this._dataQueryEngineInstance&&(this._dataQueryEngineInstance.destroy(),this._dataQueryEngineInstance=null,!0)}executeQueryForIdSet(O,j,M){var Y=this;return(0,F.Z)(function*(){return Y._dataQueryEngine.executeQueryForIdSet(Y._ensureQueryJSON(O,j),M)})()}executeQueryForCount(O,j){var M=this;return(0,F.Z)(function*(){return M._dataQueryEngine.executeQueryForCount(M._ensureQueryJSON(O),j)})()}executeQueryForExtent(O,j){var M=this;return(0,F.Z)(function*(){const{count:Y,extent:K}=yield M._dataQueryEngine.executeQueryForExtent(M._ensureQueryJSON(O),j);return{count:Y,extent:u.Z.fromJSON(K)}})()}executeQueryForIds(O,j){var M=this;return(0,F.Z)(function*(){return M._dataQueryEngine.executeQueryForIds(M._ensureQueryJSON(O),j)})()}executeQueryForLatestObservations(O,j){var M=this;return(0,F.Z)(function*(){const Y=yield M._dataQueryEngine.executeQueryForLatestObservations(M._ensureQueryJSON(O),j),K=v.Z.fromJSON(Y);return K.features.forEach(E=>{E.layer=M.layer,E.sourceLayer=M.layer}),K})()}executeQuery(O,j){var M=this;return(0,F.Z)(function*(){const Y=yield M._dataQueryEngine.executeQuery(M._ensureQueryJSON(O),j),K=v.Z.fromJSON(Y);return K.features.forEach(E=>{E.layer=M.layer,E.sourceLayer=M.layer}),K})()}_ensureQueryJSON(O,j){let M=this.defaultQueryJSON;if((0,A.pC)(O)&&("outSpatialReference"in O&&!O.outSpatialReference&&(O.outSpatialReference=this.spatialReference),M=O.toJSON()),(0,A.pC)(j)){const Y=j.geometries.map(K=>K.toJSON()).reduce((K,E)=>(K.rings=K.rings.concat(E.rings),K));M={...M,sceneFilter:{...j,geometry:Y}}}return M}_ensureDataQueryEngine(){if(this._dataQueryEngineInstance)return this._dataQueryEngineInstance;const O="timeInfo"in this.layer&&this.layer.timeInfo&&this.layer.timeInfo.toJSON()||null,j=this.layer.objectIdField,M=_.M.toJSON(this._queryGeometryType),Y=this.layer.fields?.map(ue=>ue.toJSON())??[],K=this.priority,E=this.spatialReference.toJSON(),{hasZ:R,hasM:N,featureStore:J,scheduler:ne}=this.context;return this._dataQueryEngineInstance=new h({hasZ:R,hasM:N,geometryType:M,fields:Y,timeInfo:O,spatialReference:E,objectIdField:j,featureStore:J,scheduler:ne,priority:K}),this._dataQueryEngineInstance}};(0,a._)([(0,l.Cb)({constructOnly:!0})],P.prototype,"context",void 0),(0,a._)([(0,l.Cb)({constructOnly:!0})],P.prototype,"priority",void 0),(0,a._)([(0,l.Cb)()],P.prototype,"layer",null),(0,a._)([(0,l.Cb)()],P.prototype,"spatialReference",null),(0,a._)([(0,l.Cb)()],P.prototype,"_queryGeometryType",null),(0,a._)([(0,l.Cb)()],P.prototype,"defaultQueryJSON",null),P=(0,a._)([(0,y.j)("esri.views.3d.layers.graphics.QueryEngine")],P)},13191:(fe,ee,i)=>{i.d(ee,{W:()=>p});var F=i(15861),U=(i(29132),i(62208)),b=i(10699),A=i(38114),l=i(60507),f=i(81468),w=i(79112),y=i(74746),u=i(65234);function p(P,O,j,M,Y){return v.apply(this,arguments)}function v(){return(v=(0,F.Z)(function*(P,O,j,M,Y){const{elevationProvider:K,renderCoordsHelper:E,spatialReference:R}=P,{elevationInfo:N}=O,J=(0,y.WI)(N,!0),ne=yield(0,y.kr)(J,R,Y);(0,b.k_)(Y);const ue=[],de=new Set,he=new Set;for(const{objectId:ge,points:Z}of M){const Re=j(ge);if((0,U.Wi)(Re)){for(const ie of Z)ue.push(ie[2]);de.add(ge)}else{Re.isDraped&&he.add(ge),L.setFromElevationInfo((0,l.Jn)(Re.graphic.geometry,N)),L.updateFeatureExpressionInfoContext(ne,Re.graphic,O),_.spatialReference=P.spatialReference;for(const{x:ie,y:m,z:B}of Z)_.x=ie,_.y=m,_.z=B??0,(0,f.qZ)(_,K,L,E,h),ue.push(h.z)}}return{elevations:ue,drapedObjectIds:he,failedObjectIds:de}})).apply(this,arguments)}const L=new w.o,_=(0,A.Tx)(0,0,0,u.Z.WGS84),h=new f.Lm},46348:(fe,ee,i)=>{i.d(ee,{c:()=>A});var F=i(15861),a=i(62208),U=i(10699),b=i(46679);function A(w,y,u){return l.apply(this,arguments)}function l(){return l=(0,F.Z)(function*(w,y,u){if((0,a.Wi)(w)||0===y.candidates.length)return f;const p=w.graphics3DGraphicsByObjectID??w.graphics3DGraphics,v=[],L=[],{renderer:_}=w,h=(0,a.pC)(_)&&"arcadeRequired"in _&&_.arcadeRequired?(0,b.LC)():null,P=function(){var E=(0,F.Z)(function*(R,{graphic:N,graphics3DSymbol:J}){const ne=yield h,ue=yield w.getRenderingInfoAsync(N,_,ne,{signal:u});return(0,a.Wi)(ue)?[]:J.queryForSnapping(R,j,ue,u)});return function(N,J){return E.apply(this,arguments)}}(),{candidates:O,spatialReference:j}=y;for(let E=0;E<O.length;++E){const R=O[E],{objectId:N}=R,J="number"==typeof N?p?.get(N):void 0;if((0,a.Wi)(J))continue;const{graphics3DSymbol:ne}=J;ne.symbologySnappingSupported&&(v.push(P(R,J)),L.push(E))}if(0===v.length)return f;const M=yield Promise.all(v);(0,U.k_)(u);const Y=[],K=[];for(let E=0;E<M.length;++E){const R=M[E],N=L[E];for(const J of R)Y.push(J),K.push(N)}return{candidates:Y,sourceCandidateIndices:K}}),l.apply(this,arguments)}const f={candidates:[],sourceCandidateIndices:[]}},54984:(fe,ee,i)=>{i.d(ee,{j:()=>ae,A:()=>Te});var F=i(15861),a=i(17626),U=i(14517),b=i(72392),A=i(63290),l=i(88159),f=i(62208),w=i(10699),y=i(32917),u=i(50618),p=i(77712),L=(i(90912),i(85931)),_=i(76898),h=i(65401),P=i(38114),O=i(89621),j=i(96854),M=i(59617),xe=(i(27306),i(8314),i(65234),i(5548),i(21286),i(2004),i(21674),i(72854),i(72642),i(37118),i(55214),i(71774),i(36255),i(53639));class ie{get isReferenced(){return 0!==this.versions.length}get isSingle(){return 1===this.versions.length&&1===this.versions[0].refCount}constructor(r,o){this._highestResolutionVersion=null,this.versions=[],this.ref(r,o)}ref(r,o){const c=this.feature;B.oldVersion=c,this.feature&&Object.defineProperty(r,"uid",{value:this.feature.uid,configurable:!0});for(const I of this.versions)if(I.resolution===o){I.refCount++;const W=this._highestResolutionVersion===I&&!(0,xe.f)(r,I.feature);return(W||this._highestResolutionVersion!==I)&&(I.feature=r),B.newVersion=W?r:c,B}const S={feature:r,resolution:o,refCount:1};return this.versions.push(S),!this._highestResolutionVersion||o<this._highestResolutionVersion.resolution?(B.newVersion=r,this._highestResolutionVersion=S):B.newVersion=c,B}unref(r){for(let o=0;o<this.versions.length;o++){const c=this.versions[o];if(c.resolution===r)return c.refCount--,B.oldVersion=this.feature,0===c.refCount&&(this.versions[o]=this.versions[this.versions.length-1],this.versions.length--,this._highestResolutionVersion===c&&(this._recalculateHighestResolutionVersion(),B.oldVersion=c.feature)),B.newVersion=this.feature,B}return null}get feature(){return this._highestResolutionVersion?this._highestResolutionVersion.feature:null}_recalculateHighestResolutionVersion(){if(0===this.versions.length)return void(this._highestResolutionVersion=null);let r=this.versions[0];for(let o=1;o<this.versions.length;o++){const c=this.versions[o];c.resolution<r.resolution&&(r=c)}this._highestResolutionVersion=r}}class m{get isReferenced(){return 0!==this._refCount}get isSingle(){return 1===this._refCount}constructor(r){this._feature=r,this._refCount=1}ref(r){return++this._refCount,B.oldVersion=this._feature,this.feature&&Object.defineProperty(r,"uid",{value:this.feature.uid,configurable:!0}),(0,xe.f)(this._feature,r)||(this._feature=r),B.newVersion=this._feature,B}unref(){return B.oldVersion=this._feature,this._refCount>0&&(this._refCount--,!this.isReferenced)?(B.newVersion=null,B):(B.newVersion=this._feature,B)}get feature(){return this._feature}}const B={oldVersion:null,newVersion:null},Q=new Set;class k{get displayingFeatures(){return this._displayingFeatures}set displayingFeatures(r){this._displayingFeatures=r,this.extentIncludingBorrowedFeatures=null}get perTileMaximumNumberOfFeaturesExceeded(){return!this.filtered&&(this.featuresMissing||this.features&&this.featureLimit!==this.features.length)}get features(){return this._features}get featureLimit(){return this._featureLimit}set featureLimit(r){this._featureLimit!==r&&(this._featureLimit=r,this._estimatedUnusedSizeDirty=!0)}get availableFields(){return this._availableFields}setFeatures(r,o,c){this._availableFields=(0,f.Pt)(c,Q),this._features=r,this._shuffled=!1,this._estimatedSize=-1,this._estimatedUnusedSizeDirty=!0,r&&r.length>0?(this._emptyFeatureRatio=o/(r.length+o),this._numVertices=r.reduce((S,I)=>S+(0,P.R3)(I.geometry),0)):(this._emptyFeatureRatio=0,this._numVertices=0)}get emptyFeatureRatio(){return this._emptyFeatureRatio}get numFeatures(){return this.hasPreciseFeatureCount?this._numFeatures:this._features?this._features.length:0}set numFeatures(r){this._numFeatures=r}get hasPreciseFeatureCount(){return this._numFeatures>_e}get needsFeatureCount(){return this._numFeatures===_e}get numVertices(){return this._numVertices}constructor(r){this.descriptor=r,this.fetchStatus=d.FETCH_NEEDED,this._features=null,this._numVertices=0,this._featureLimit=0,this.featuresMissing=!0,this._shuffled=!1,this._numFeatures=_e,this._emptyFeatureRatio=0,this._estimatedSize=-1,this._estimatedUnusedSize=0,this._estimatedUnusedSizeDirty=!1,this._availableFields=Q,this._displayingFeatures=null,this.alive=!0,this.filtered=!1}get id(){return this.descriptor.id}get estimatedSize(){return this.updateMemoryEstimates(),this._estimatedSize}get estimatedUnusedSize(){return this._estimatedUnusedSize}updateMemoryEstimates(){if(this._estimatedSize<0){if(this._estimatedSize=0,this._estimatedUnusedSize=0,this._features)for(let r=0;r<this._features.length;++r){const o=(0,P.Xw)(this._features[r]);this._estimatedSize+=o,r>=this.featureLimit&&(this._estimatedUnusedSize+=o)}return!0}if(this._estimatedUnusedSizeDirty){if(this._estimatedUnusedSize=0,this._estimatedUnusedSizeDirty=!1,this._features)for(let r=this.featureLimit;r<this._features.length;++r)this._estimatedUnusedSize+=(0,P.Xw)(this._features[r]);return!0}return!1}get isFetching(){return this.fetchStatus===d.FETCHING||this.fetchStatus===d.REFETCHING}get isRefetching(){return this.fetchStatus===d.REFETCHING}get needsFetching(){return this.fetchStatus===d.FETCH_NEEDED||this.fetchStatus===d.REFETCH_NEEDED}get needsRefetching(){return this.fetchStatus===d.REFETCH_NEEDED}get isFetched(){return this.fetchStatus===d.DONE||this.fetchStatus===d.FULL}resetFetching(){this.fetchStatus=this.fetchStatus===d.REFETCHING?d.REFETCH_NEEDED:d.FETCH_NEEDED}get needsDisplayUpdate(){return!!this._features&&!function V(s,r,o){if((0,f.Wi)(r)||(0,f.Wi)(s)||o!==r.length||o>s.length)return!1;for(let c=0;c<o;++c)if(s[c]!==r[c])return!1;return!0}(this._features,this.displayingFeatures,this.featureLimit)}intersects(r){return!(!(0,f.Wi)(r)&&this.descriptor.extent)||((0,h.oJ)(r,te),(0,h.kK)(this.descriptor.extent,te))}intersectionIncludingBorrowed(r,o){const c=(0,f.pC)(this.extentIncludingBorrowedFeatures)?this.extentIncludingBorrowedFeatures:this.descriptor.extent;return r||c?((0,f.pC)(r)?((0,h.oJ)(r,o),(0,h.jV)(o,c,o)):(0,h.JG)(o,c),o):((0,h.JG)(o,h.bd),o)}_shuffle(r){this._features.sort((o,c)=>(0,P.MS)(o,r)-(0,P.MS)(c,r)),(0,L.TV)(this._features,16438),this._shuffled=!0,this._estimatedUnusedSizeDirty=!0}reduceFeatures(r,o,c){if(r<=0)return!1;if(!this._features)return this.featureLimit=0,!1;let S=!1;this.featureLimit=Math.ceil(this.numFeatures*r),this.featureLimit>this._features.length&&(this.featureLimit=this._features.length,this.fetchStatus===d.DONE&&this._features.length>0&&(this.fetchStatus=d.REFETCH_NEEDED,S=!0)),!this._shuffled&&r<1&&this._shuffle(c);const I=Math.max(this.featureLimit,Math.ceil(o*this.numFeatures));return this._features.length>I&&(this._features.length=I,this.featuresMissing=!0,this.fetchStatus===d.FULL&&(this.fetchStatus=d.DONE)),S}get cache(){return{availableFields:this._availableFields,features:this._features,numFeatures:this._numFeatures,emptyFeatureRatio:this._emptyFeatureRatio,fetchStatus:this.fetchStatus,featuresMissing:this.featuresMissing}}set cache(r){this.requestController=null,this._availableFields=r.availableFields,this._features=r.features,this._numFeatures=r.numFeatures,this._emptyFeatureRatio=r.emptyFeatureRatio,this.fetchStatus=r.fetchStatus,this.featuresMissing=r.featuresMissing,this._estimatedSize=-1,this._estimatedUnusedSizeDirty=!0}}const _e=-1;var d,s;(s=d||(d={}))[s.FETCH_NEEDED=0]="FETCH_NEEDED",s[s.REFETCH_NEEDED=1]="REFETCH_NEEDED",s[s.FETCHING=2]="FETCHING",s[s.REFETCHING=3]="REFETCHING",s[s.DONE=4]="DONE",s[s.FULL=5]="FULL";const te=(0,h.Ue)();var X=i(15076),q=i(87091);const me="esri.views.3d.layers.support.FeatureTileFetcher3D",Ee=A.Z.getLogger(me);let ae=class extends U.Z{set maximumNumberOfFeatures(s){s=s||1/0;const r=this._get("maximumNumberOfFeatures");s===r||s<1||(this._set("maximumNumberOfFeatures",s),this._maximumFeaturesUpdated(r,s))}set memoryFactor(s){this.memoryFactor!==s&&(this._set("memoryFactor",s),this._setDirty())}set lodFactor(s){this.lodFactor!==s&&(this._set("lodFactor",s),this._supportsResolution&&this.refetch())}get useTileCount(){return this._useTileCount&&(0,f.pC)(this.context.query.queryFeatureCount)}set useTileCount(s){this._useTileCount=s,this.notifyChange("useTileCount")}get memoryForUnusedFeatures(){let s=0;return this._featureTiles.forEach(r=>s+=r.estimatedUnusedSize),s}get totalVertices(){let s=0;return this._featureTiles.forEach(r=>s+=r.numVertices),s}get totalFeatures(){let s=0;return this._featureTiles.forEach(r=>s+=r.numFeatures),s}set filterExtent(s){if((0,f.pC)(s)&&this.context.tilingScheme&&!s.spatialReference.equals(this.context.tilingScheme.spatialReference))return void Ee.error("#filterExtent=","extent needs to be in the same spatial reference as the tiling scheme");const r=this._get("filterExtent");if(r===s||(0,f.pC)(r)&&s&&r.equals(s))return;const o=(0,f.pC)(s)?s.clone():null;this._set("filterExtent",o),this._reclip(o,r)}constructor(s){super(s),this._useTileCount=!1,this.updating=!1,this.running=!1,this.updatingTotal=0,this.updatingRemaining=0,this.expectedFeatureDiff=0,this.maximumNumberOfFeaturesExceeded=!1,this.maximumNumberOfFeaturesExceededThrottle=1e3,this._fullRatio=1,this._farRatio=1,this._changes={updates:{adds:new Array,removes:new Array},adds:new Array,removes:new Array},this._handles=new b.Z,this._frameTask=q.sq,this._dirty=!1,this._featureTiles=new Map,this._displayingFeatureReferences=new Map,this._numDisplayingFeatureReferences=0,this._suspended=!0,this._pendingEdits=null}initialize(){this._handles.add((0,y.on)(()=>this.tileDescriptors,"change",()=>this._setDirty(),{onListenerAdd:()=>this._setDirty()})),this._objectIdField=this.context.objectIdField,this.FeatureReferenceClass=this.context.capabilities.supportsMultipleResolutions?ie:m;const s=this.context.scheduler;(0,f.pC)(s)&&(this._frameTask=s.registerTask(q.T8.FEATURE_TILE_FETCHER,this)),this._setDirty()}destroy(){this._frameTask.remove(),this._handles=(0,f.SC)(this._handles),this._featureTiles.forEach(s=>{this._cancelFetchTile(s),this._removeTile(s)}),this._featureTiles.clear(),this._displayingFeatureReferences.clear(),this._pendingEdits?.controller.abort(),this._pendingEdits=null}get _paused(){return this._suspended||!!this._pendingEdits}restart(){this._featureTiles.forEach(s=>{this._cancelFetchTile(s),this._clearTile(s),this._resetFetchTile(s)}),(0,f.pC)(this.context.memoryCache)&&this.context.memoryCache.clear(),this._setDirty()}refetch(){this._featureTiles.forEach(s=>{this._cancelFetchTile(s),this._resetFetchTile(s)}),(0,f.pC)(this.context.memoryCache)&&this.context.memoryCache.clear(),this._setDirty()}suspend(){this._suspended||(this._suspended=!0,this._pause(),this._setDirty())}resume(){this._suspended&&(this._suspended=!1,this._unpause())}_pause(){this._paused&&(this._featureTiles.forEach(s=>this._cancelFetchTile(s)),this._updated())}_unpause(){this._paused||(this._setDirty(),this._updated())}get availableFields(){let s=null;return this._featureTiles.forEach(r=>{(0,f.Wi)(r.displayingFeatures)||0===r.displayingFeatures.length||((0,f.Wi)(s)?s=new Set(r.availableFields):s.forEach(o=>{r.availableFields.has(o)||(0,f.Wg)(s).delete(o)}))}),(0,f.pC)(s)?s:new Set}applyEdits(s){this._pendingEdits||(this._pendingEdits={edits:Promise.resolve(),count:0,controller:new AbortController},this._pause());const r=this._pendingEdits;r.count++;const o=r.edits.then(()=>s.result.catch(c=>{if((0,w.D_)(c))throw c;return null}).then(c=>c&&(this._applyEditsDeleteFeatures(c.deletedFeatures),this._applyEditsAddUpdateFeatures(c.addedFeatures,c.updatedFeatures,r.controller.signal).then(()=>c))).then(c=>(0==--r.count&&(this._pendingEdits===r&&(this._pendingEdits=null),(0,f.pC)(this.context.memoryCache)&&this.context.memoryCache.clear(),this._unpause(),this._updated()),c)));return r.edits=o,this._updated(),o}_applyEditsDeleteFeatures(s){if(0===s.length)return;const r=this.context.globalIdField,o=r&&this.availableFields.has(r),c=new Set,S=this._objectIdField;s.forEach(({objectId:I,globalId:W})=>{if((!I||I<0)&&r){o||Ee.errorOncePerTick(`Editing the specified service requires the layer's globalIdField, ${r} to be included the layer's outFields for updates to be reflected in the view`);const re=this.features.find(ce=>ce.attributes&&ce.attributes[r]===W);re&&c.add((0,P.MS)(re,S))}else c.add(I)}),this._featureTiles.forEach(I=>{if(!I.features)return;const W=I.features.filter(re=>!c.has((0,P.MS)(re,this._objectIdField)));W.length!==I.features.length&&(I.setFeatures(W,0,I.availableFields),this._invalidateCounts())})}_applyEditsAddUpdateFeatures(s,r,o){var c=this;return(0,F.Z)(function*(){const S=[],I=new Set;if(s.forEach(re=>S.push(re.objectId)),r.forEach(re=>{S.push(re.objectId),I.add(re.objectId)}),0===S.length)return;const W=[];c._featureTiles.forEach(re=>{const ce=c._applyEditsAddUpdateTile(re,S,I,o);ce&&W.push(ce)}),yield(0,w.as)(W)})()}_applyEditsAddUpdateTile(s,r,o,c){var S=this;return(0,F.Z)(function*(){if(!s.features)return;const I=S._createQuery(s);I.resultType=void 0,I.cacheHint=!1,I.objectIds=r;const W=yield S._queryFeatures(I,c);let re=null;if(o.size>0){const ce=s.features.filter(Ce=>!o.has((0,P.MS)(Ce,S._objectIdField)));ce.length!==s.features.length&&(re=ce)}if(W.features.length>0){re||(re=s.features.slice());for(const ce of W.features)re.push(ce)}re&&(s.hasPreciseFeatureCount&&(s.numFeatures=Math.max(s.numFeatures,re.length)),s.setFeatures(re,0,Be(s.availableFields,W.fields)),S._invalidateCounts())})()}_queryFeatures(s,r){return this.context.query.queryFeaturesDehydrated(s,{signal:r,timeout:We})}_setDirty(){this._dirty=!0,this._updated()}runTask(s){if(this._frameTask.processQueue(s),!this._dirty||!this.initialized)return;this._dirty=!1;const r=this._getListOfTiles();if(this._markTilesNotAlive(r),!s.run(()=>this._addTiles(r,s))||!s.run(()=>this._filterExtentTiles(r,s))||!s.run(()=>this._removeTiles(r,s))||s.done)return void this._setDirty();const o=this._sortTiles(r);s.run(()=>this._showTiles(o,s))&&s.run(()=>this._fetchTiles(o,s))&&s.run(()=>this._updateMemoryEstimates(o,s))||this._setDirty(),this._updated(),this.updating||this._updateMaximumNumberOfFeaturesExceeded()}_markTilesNotAlive(s){for(const r of s)r.alive=!1}_addTiles(s,r){return!this._suspended&&(this.tileDescriptors.forEach(o=>{const c=this._featureTiles.get(o.id);c?c.alive=!0:r.done||(s.push(this._addTile(o)),r.madeProgress())}),r.hasProgressed)}_filterExtentTiles(s,r){for(const o of s){if(r.done)break;o.alive&&(o.filtered=!o.intersects(this.filterExtent),o.filtered&&(this._clearTile(o),r.madeProgress()))}return r.hasProgressed}_removeTiles(s,r){for(let o=s.length-1;o>=0&&!r.done;o--){const c=s[o];c.alive||(this._removeTile(c),o!==s.length-1&&(s[o]=s[s.length-1]),s.pop(),r.madeProgress())}return r.hasProgressed}_sortTiles(s){return s.sort((r,o)=>(r.descriptor.loadPriority??0)-(o.descriptor.loadPriority??0)),s}_showTiles(s,r){const o=this._updateRatio(s),c=S=>{const I=this._fullRatio<1?o(S)*this._farRatio:1;return S.reduceFeatures(I,this.memoryFactor,this._objectIdField)&&this._setDirty(),this._showTile(S)};for(const S of s)if(!r.run(()=>c(S))){this._setDirty();break}return r.hasProgressed}_fetchTiles(s,r){if(this._paused)return!1;let o=!1;for(const c of s){if(!c.needsFetching)continue;const S=(0,f.pC)(this.context.memoryCache)?this.context.memoryCache.pop(c.id):null;if((0,f.pC)(S))c.cache=S,this._setDirty(),this._scheduleUpdated(),r.madeProgress();else{if(this._needsNumFeatures(c)){const I=new AbortController,W=this._fetchTileCount(c,I.signal);this._handleRequest(c,W,I,()=>c.numFeatures=-2),o=!0,r.madeProgress()}if(r.done)return!0}}if(o)return r.hasProgressed;for(const c of s)if(c.needsFetching){const S=new AbortController,I=this._fetchTile(c,S.signal);if(this._handleRequest(c,I,S,W=>{c.setFeatures([],0,null),this._invalidateCounts(),c.featuresMissing=!1,this.context.logFetchError(Ee,W)}),r.madeProgress())return!0}return r.hasProgressed}_updateMemoryEstimates(s,r){return s.some(o=>!r.run(()=>o.updateMemoryEstimates())&&(this._setDirty(),!0)),r.hasProgressed}_reclip(s,r){if(!this.initialized)return;const o=new Array;this._featureTiles.forEach(c=>{(0,f.Wi)(c.displayingFeatures)||0===c.displayingFeatures.length||(c.intersectionIncludingBorrowed(r,Ve),c.intersectionIncludingBorrowed(s,ve),(0,h.fS)(Ve,ve)||o.push(c))}),this._refreshDisplayingFeatures(o),this._updated()}_refreshDisplayingFeatures(s){const r=new Set,o=this._changes.updates;for(const c of s)if(!(0,f.Wi)(c.displayingFeatures))for(const S of c.displayingFeatures){const I=(0,P.MS)(S,this._objectIdField);if(r.has(I))continue;r.add(I);const W=this._displayingFeatureReferences.get(I).feature;o.removes.push(W),o.adds.push(W)}this._applyChanges()}_updated(){let s=0;this._paused||this._featureTiles.forEach(o=>o.isFetching?++s:0);const r=this._dirty||!!this._pendingEdits||s>0;if(this._set("running",this._dirty),this._set("updating",r),r){let o=0,c=0,S=0,I=0,W=0;const re=this._displayingFeatureReferences.size/this._numDisplayingFeatureReferences;this._featureTiles.forEach(pe=>{if(++c,pe.isFetching&&pe.hasPreciseFeatureCount){const De=this._maximumFeaturesForTile(pe)*(1-pe.emptyFeatureRatio),Pe=(0,f.pC)(pe.displayingFeatures)?pe.displayingFeatures.length*re:0;W+=De-Pe}pe.needsFetching?++I:pe.numFeatures>0&&(++S,o+=pe.numFeatures)}),I+=s;let ce=0,Ce=0;o?(Ce=o,ce=Math.min(I*o/S,o)):(Ce=c,ce=I),W=Math.min(this.maximumNumberOfFeatures-this.features.length,W),this._set("updatingTotal",Ce),this._set("updatingRemaining",ce),this._set("expectedFeatureDiff",W)}else this._set("updatingTotal",0),this._set("updatingRemaining",0),this._set("expectedFeatureDiff",0);this.debugger&&this.debugger.update()}_updateMaximumNumberOfFeaturesExceeded(){const s=(0,l.oE)(this._featureTiles,r=>r.perTileMaximumNumberOfFeaturesExceeded);this._set("maximumNumberOfFeaturesExceeded",s)}_updateRatio(s){const r=function G(s){let r=0;for(const o of s)o.features&&o.features.length>0&&o.alive&&(r=Math.max(r,o.descriptor.lij[0]));return r}(s),o=I=>1/(1<<Math.max(0,r-I.descriptor.lij[0]));let c=0,S=0;for(const I of s){const W=I.numFeatures;c+=W,S+=W*o(I)}return this._fullRatio=Math.min(1,this.maximumNumberOfFeatures/c),this._farRatio=this.maximumNumberOfFeatures/S,this._scheduleUpdated(),o}_maximumFeaturesUpdated(s,r){s!==r&&(r>s&&this._featureTiles.forEach(o=>{if(!o.featuresMissing)return;const c=this._maximumFeaturesForTile(o);o.features&&(o.features.length>=c||o.fetchStatus===d.FULL)||(this._cancelFetchTile(o),this._resetFetchTile(o))}),this._setDirty())}_addTile(s){const r=new k(s);return this._featureTiles.set(r.id,r),this._resetFetchTile(r),this._referenceDisplayingFeaturesFromRelatedTiles(r),r}_referenceDisplayingFeaturesFromRelatedTiles(s){const r=s.descriptor.resolution;this._featureTiles.forEach(o=>{if(!((0,f.Wi)(o.displayingFeatures)||s===o||s.descriptor.lij&&o.descriptor.lij&&!(0,X.E9)(s.descriptor.lij,o.descriptor.lij))){(0,f.Wi)(s.displayingFeatures)&&(s.displayingFeatures=[]),s.descriptor.extent&&o.descriptor.extent&&((0,f.Wi)(s.extentIncludingBorrowedFeatures)&&(s.extentIncludingBorrowedFeatures=(0,h.d9)(s.descriptor.extent)),(0,h.jn)(s.extentIncludingBorrowedFeatures,o.descriptor.extent,s.extentIncludingBorrowedFeatures));for(const c of o.displayingFeatures){s.displayingFeatures.push(c);const S=this._displayingFeatureReferences.get((0,P.MS)(c,this._objectIdField));S.ref(S.feature,r),this._numDisplayingFeatureReferences++}}}),s.featureLimit=(0,f.pC)(s.displayingFeatures)?s.displayingFeatures.length:0}_removeTile(s){this._clearTile(s),this._featureTiles.delete(s.id)}_resetFetchTile(s){s.filtered=!s.intersects(this.filterExtent),s.filtered?s.needsFetching&&(s.fetchStatus=d.DONE):s.fetchStatus=d.FETCH_NEEDED}_cancelFetchTile(s){const r=s.requestController;(0,f.pC)(r)&&(s.requestController=null,s.resetFetching(),r.abort())}_fetchTileCount(s,r){var o=this;return(0,F.Z)(function*(){return s.numFeatures=yield o._fetchCount(s,r),o._updateRatio(o._getListOfTiles()),s.fetchStatus===d.REFETCHING?d.REFETCH_NEEDED:d.FETCH_NEEDED})()}_fetchTile(s,r){var o=this;return(0,F.Z)(function*(){const c=o._maximumFeaturesForTile(s);if(c<=0)return function be(s){return s.setFeatures([],0,null),s.featuresMissing=!1,d.DONE}(s);const S=o._getMaxRecordCount(s),I=Math.ceil(c/S);if(ye(s)||!o.context.capabilities.supportsMaxRecordCountFactor||s.numFeatures<=c&&I>j.Z.MAX_MAX_RECORD_COUNT_FACTOR)return o._fetchPagedTile(s,r);const W=o._createQuery(s);if(W.maxRecordCountFactor=Math.ceil(c/S),s.isRefetching&&s.features&&s.features.length>0){const De=Math.ceil(s.features.length/(1-s.emptyFeatureRatio)/S);W.maxRecordCountFactor=Math.max(De+1,W.maxRecordCountFactor)}const{features:re,exceededTransferLimit:ce,fields:Ce}=yield o._queryFeatures(W,r),pe=ce?W.maxRecordCountFactor>=j.Z.MAX_MAX_RECORD_COUNT_FACTOR?d.FULL:d.DONE:d.FULL;return yield o._frameTask.schedule(()=>{s.featuresMissing=re.length<s.numFeatures||!!ce;const De=o._removeEmptyFeatures(re);s.setFeatures(re,De,Ue(Ce))},r),(0,w.k_)(r),o._invalidateCounts(),pe})()}_fetchCount(s,r){var o=this;return(0,F.Z)(function*(){return o.context.query.queryFeatureCount(o._createFeatureCountQuery(s),{signal:r})})()}_fetchPagedTile(s,r){var o=this;return(0,F.Z)(function*(){let c,S=0,I=0,W=0,re=o._maximumFeaturesForTile(s)-W;const ce=o._getMaxRecordCount(s);let Ce=null;for(;;){const pe=o._createQuery(s),De=o._setPagingParameters(pe,S,re,ce),{features:Pe,exceededTransferLimit:Me,fields:Ae}=yield o._queryFeatures(pe,r);if(yield o._frameTask.schedule(()=>{De&&(S+=(0,f.Wg)(pe.num)),W+=Pe.length,I+=o._removeEmptyFeatures(Pe),s.featuresMissing=S<s.numFeatures||!!Me,c=c?c.concat(Pe):Pe,Ce=Be(Ce,Ae),s.setFeatures(c,I,Ce)},r),(0,w.k_)(r),o._invalidateCounts(),o._setDirty(),re=o._maximumFeaturesForTile(s)-W,!De||!Me||re<=0)return Me?d.DONE:d.FULL}})()}_createFeatureCountQuery(s){const r=this._createQuery(s);return this.context.capabilities.supportsCacheHint&&(r.resultType=void 0,r.cacheHint=!0),r}_createQuery(s){const r=this.context.createQuery(),o=s.descriptor.extent;return o&&(r.geometry=(0,h.HH)(o,this.context.tilingScheme.spatialReference)),this._setResolutionParams(r,s),this._useTileQuery(s)?r.resultType="tile":this.context.capabilities.supportsCacheHint&&(r.cacheHint=!0),r}_setPagingParameters(s,r,o,c){return!!this.context.capabilities.supportsPagination&&(s.start=r,o>0&&this.context.capabilities.supportsMaxRecordCountFactor?(s.maxRecordCountFactor=Math.ceil(o/c),s.num=Math.min(s.maxRecordCountFactor*c,o)):s.num=Math.min(c),!0)}_getEffectiveTileResolution(s){if(null==s.descriptor.resolution)return null;const r=this.context.viewingMode===M.JY.Global?this.context.tilingScheme.resolutionAtLevel(3):1/0;return Math.min(s.descriptor.resolution,r)/this.lodFactor}get _supportsResolution(){return this.context.capabilities.supportsMultipleResolutions&&"point"!==this.context.geometryType}_setResolutionParams(s,r){if(!this._supportsResolution)return;const o=this._getEffectiveTileResolution(r);null!=o&&(this.context.capabilities.supportsQuantization?s.quantizationParameters=new O.Z({mode:"view",originPosition:"upper-left",tolerance:o,extent:this.context.fullExtent}):"polyline"===this.context.geometryType&&(s.maxAllowableOffset=o))}_removeEmptyFeatures(s){const r=s.length;for(let o=0;o<s.length;)(0,P.dF)(s[o].geometry)?++o:(s[o]=s[s.length-1],--s.length);return r-s.length}_needsNumFeatures(s){return this.useTileCount&&s.needsFeatureCount&&!ye(s)}_getMaxRecordCount(s){const{tileMaxRecordCount:r,maxRecordCount:o}=this.context;return this._useTileQuery(s)&&(0,f.pC)(r)&&r>0&&this.context.capabilities.supportsResultType?r:(0,f.pC)(o)&&o>0?o:je}_useTileQuery(s){return(!ye(s)||!this.context.capabilities.supportsCacheHint)&&this.context.capabilities.supportsResultType}_handleRequest(s,r,o,c){s.fetchStatus=s.needsRefetching?d.REFETCHING:d.FETCHING,s.requestController=o;let S=!1;r.then(I=>{s.requestController=null,s.fetchStatus=I}).catch(I=>{s.requestController===o&&(s.requestController=null,s.fetchStatus=d.DONE),(0,w.D_)(I)?S=!0:c(I)}).then(()=>{S||this._setDirty(),this._scheduleUpdated()})}_scheduleUpdated(){this._handles&&!this._handles.has("scheduleUpdated")&&this._handles.add((0,u.Os)(()=>{this._handles.remove("scheduleUpdated"),this._updated()}),"scheduleUpdated")}_showTile(s){if((0,f.pC)(s.displayingFeatures)&&!s.needsDisplayUpdate)return!1;const r=s.features;if(0===s.featureLimit||!r){const W=(0,f.pC)(s.displayingFeatures)&&s.displayingFeatures.length>0;return this._hideTileFeatures(s),s.displayingFeatures=[],W}const o=s.descriptor.resolution,c=this._changes.updates,S=this._changes.adds,I=Math.min(s.featureLimit,r.length);s.featureLimit=I;for(let W=0;W<I;++W){const re=r[W],ce=(0,P.MS)(re,this._objectIdField),Ce=this._displayingFeatureReferences.get(ce);if(Ce){const pe=Ce.ref(re,o);pe.oldVersion!==pe.newVersion&&(pe.oldVersion&&c.removes.push(pe.oldVersion),pe.newVersion&&c.adds.push(pe.newVersion))}else this._displayingFeatureReferences.set(ce,new this.FeatureReferenceClass(re,o)),S.push(re);this._numDisplayingFeatureReferences++}return this._hideTileFeatures(s),this._applyChanges(),s.displayingFeatures=r.slice(0,I),!0}_hideTile(s){this._cancelFetchTile(s),this._hideTileFeatures(s)}_hideTileFeatures(s){if((0,f.Wi)(s.displayingFeatures))return;const r=this._changes.updates,o=this._changes.removes;for(const c of s.displayingFeatures){const S=(0,P.MS)(c,this._objectIdField),I=this._displayingFeatureReferences.get(S);if(!I)continue;const W=I.unref(s.descriptor.resolution);this._numDisplayingFeatureReferences--,W?W.oldVersion!==W.newVersion&&(null==W.newVersion?(this._displayingFeatureReferences.delete(S),W.oldVersion&&o.push(W.oldVersion)):(r.adds.push(W.newVersion),W.oldVersion&&r.removes.push(W.oldVersion))):console.error("Hiding unreferenced feature")}this._applyChanges(),s.displayingFeatures=null}_applyChanges(){const s=this._changes.updates;s.removes.length>0&&(this.features.removeMany(s.removes),s.removes.length=0),s.adds.length>0&&(this.features.addMany(s.adds),s.adds.length=0);const r=this._changes.adds,o=this._changes.removes,c=Math.min(r.length,o.length);let S=0;for(;S<c;){const I=Math.min(S+Se,c);this.features.addMany(r.slice(S,I)),this.features.removeMany(o.slice(S,I)),S=I}r.length>c&&this.features.addMany(0===S?r:r.slice(S)),o.length>c&&this.features.removeMany(0===S?o:o.slice(S)),r.length=0,o.length=0}_clearTile(s){this._hideTile(s),s.features&&(0,f.pC)(this.context.memoryCache)&&this.context.memoryCache.put(s.id,s.cache,16+s.estimatedSize),s.setFeatures(null,0,null),this._invalidateCounts()}_invalidateCounts(){this.notifyChange("totalVertices"),this.notifyChange("totalFeatures"),this.notifyChange("memoryForUnusedFeatures")}_getListOfTiles(){return Array.from(this._featureTiles.values())}get storedFeatures(){return this._getListOfTiles().reduce((s,r)=>s+(r.features?r.features.length:0),0)}get missingTiles(){return Array.from(this._featureTiles.values()).reduce((s,r)=>s+(r.needsFetching||r.isFetching?1:0),0)}_maximumFeaturesForTile(s){const r=s.hasPreciseFeatureCount?s.numFeatures:1/0;return Math.min(Math.ceil((s.hasPreciseFeatureCount?r:this.maximumNumberOfFeatures)*(this._fullRatio<1?this._farRatio:1)/(1-s.emptyFeatureRatio)),r)}get test(){return{process:s=>this.runTask(s),getFeatureTileById:s=>this._featureTiles.get(s),forEachFeatureTile:s=>this._featureTiles.forEach(s)}}};function ye(s){return"dummy-tile-full-extent"===s.id}function Te(s){const r=s.capabilities.query;return{supportsMultipleResolutions:Oe(s),supportsPagination:!(!r||!r.supportsPagination),supportsResultType:!(!r||!r.supportsResultType),supportsCacheHint:!(!r||!r.supportsCacheHint),supportsQuantization:!(!r||!r.supportsQuantization),supportsQuantizationEditMode:!(!r||!r.supportsQuantizationEditMode),supportsMaxRecordCountFactor:!(!r||!r.supportsMaxRecordCountFactor),supportsFormatPBF:!(!r||!r.supportsFormatPBF)}}function Oe(s){switch(s.geometryType){case"polyline":return!0;case"polygon":return s.capabilities&&s.capabilities.query&&s.capabilities.query.supportsQuantization;default:return!1}}function Ue(s){return(0,f.Wi)(s)?new Set:new Set(s.map(r=>r.name))}function Be(s,r){if((0,f.Wi)(s)||(0,f.Wi)(r))return Ue(r);const o=new Set;for(const{name:c}of r)s.has(c)&&o.add(c);return o}(0,a._)([(0,p.Cb)({constructOnly:!0})],ae.prototype,"features",void 0),(0,a._)([(0,p.Cb)()],ae.prototype,"tileDescriptors",void 0),(0,a._)([(0,p.Cb)({value:1/0})],ae.prototype,"maximumNumberOfFeatures",null),(0,a._)([(0,p.Cb)({value:1})],ae.prototype,"memoryFactor",null),(0,a._)([(0,p.Cb)({value:1})],ae.prototype,"lodFactor",null),(0,a._)([(0,p.Cb)()],ae.prototype,"useTileCount",null),(0,a._)([(0,p.Cb)({readOnly:!0})],ae.prototype,"updating",void 0),(0,a._)([(0,p.Cb)({readOnly:!0})],ae.prototype,"running",void 0),(0,a._)([(0,p.Cb)({readOnly:!0})],ae.prototype,"updatingTotal",void 0),(0,a._)([(0,p.Cb)({readOnly:!0})],ae.prototype,"updatingRemaining",void 0),(0,a._)([(0,p.Cb)({readOnly:!0})],ae.prototype,"expectedFeatureDiff",void 0),(0,a._)([(0,p.Cb)({readOnly:!0})],ae.prototype,"memoryForUnusedFeatures",null),(0,a._)([(0,p.Cb)({readOnly:!0})],ae.prototype,"maximumNumberOfFeaturesExceeded",void 0),(0,a._)([(0,p.Cb)({constructOnly:!0})],ae.prototype,"maximumNumberOfFeaturesExceededThrottle",void 0),(0,a._)([(0,p.Cb)({readOnly:!0})],ae.prototype,"totalVertices",null),(0,a._)([(0,p.Cb)({readOnly:!0})],ae.prototype,"totalFeatures",null),(0,a._)([(0,p.Cb)()],ae.prototype,"filterExtent",null),(0,a._)([(0,p.Cb)({constructOnly:!0})],ae.prototype,"context",void 0),ae=(0,a._)([(0,_.j)(me)],ae);const je=2e3,Ve=(0,h.Ue)(),ve=(0,h.Ue)(),We=6e5,Se=200},98667:(fe,ee,i)=>{i.d(ee,{n:()=>O});var F=i(15861),a=i(17626),U=i(59213),b=i(80542),A=i(63290),l=i(62208),f=i(10699),w=i(32917),y=i(77712),v=(i(90912),i(85931),i(76898)),L=i(98624),_=i(59990),h=i(34675),P=i(87091);let O=class extends b.r{constructor(j){var M;super(j),M=this,this._updateTask=null,this._frameTask=null,this._queryEngine=null,this._updateRequested=!0,this._updateVisibility=function(){var Y=(0,F.Z)(function*(K){if((0,l.Wi)(M._compositedFeatureFilter)&&(0,l.Wi)(M._sceneFilter)||0===M.context.getFeatureCount())return M._frameTask.schedule(()=>M.clear(),K);try{const E=yield M._queryEngine.executeQueryForIdSet(M._compositedFeatureFilter,M._sceneFilter,K);return M._frameTask.schedule(()=>{M.context.updateFeatureVisibilities(R=>E.has(R))},K)}catch(E){return(0,f.r9)(E),A.Z.getLogger(M.declaredClass).warn(`FeatureFilter query failed: ${E}`,{error:E}),M._frameTask.schedule(()=>{M.context.setAllFeaturesVisibility(!0)},K)}});return function(K){return Y.apply(this,arguments)}}()}initialize(){const j=P.T8.FILTER_VISIBILITY,{layer:M,view:Y}=this._layerView,{featureStore:K}=this.context;this._queryEngine=new h.q({context:{spatialReference:Y.spatialReference,layer:M,scheduler:Y.resourceController.scheduler,featureStore:K,hasM:"hasM"in this._layerView&&this._layerView.hasM,hasZ:"hasZ"in this._layerView&&this._layerView.hasZ},priority:j}),this._frameTask=this._layerView.view.resourceController.scheduler.registerTask(j,this),this.updatingHandles.add(()=>[this._compositedFeatureFilter,this._sceneFilter],()=>this.reapply(),w.nn)}destroy(){this._updateRequested=!1,this.handles.removeAll(),this.updatingHandles.removeAll(),this.clear(),this._updateTask=(0,l.IM)(this._updateTask),this._frameTask=(0,l.hw)(this._frameTask),this._queryEngine=(0,l.SC)(this._queryEngine),this._set("context",null)}get updating(){return this.running||this.updatingHandles.updating||(0,l.pC)(this._updateTask)&&!this._updateTask.finished}get running(){return this._updateRequested||this._frameTask.updating}get defaultVisibility(){return(0,l.Wi)(this._compositedFeatureFilter)&&(0,l.Wi)(this._sceneFilter)}get _featureFilter(){return"filter"in this._layerView?this._layerView.filter:null}get _sceneFilter(){return"layerFilter"in this._layerView?this._layerView.layerFilter:null}get _floorFilter(){return(0,_.c)(this._layerView)}get _timeExtent(){return"timeExtent"in this._layerView?this._layerView.timeExtent:null}get _compositedFeatureFilter(){const{_featureFilter:j,_timeExtent:M,_floorFilter:Y}=this;if((0,l.Wi)(M)&&(0,l.Wi)(Y))return j;const K=(0,l.pC)(j)?j.clone():new L.Z;if((0,l.pC)(M)&&(K.timeExtent=(0,l.pC)(K.timeExtent)?K.timeExtent.intersection(M):M),(0,l.pC)(Y)){const E=(0,l.Wi)(K.where)||""===K.where;K.where=E?Y:`(${K.where}) AND (${Y})`}return K}get _layerView(){return this.context.layerView}reapply(){this._updateRequested=!0}clear(){this._queryEngine.clear(),this.context.clearFeaturesVisibility()}runTask(j){this._updateRequested&&(this._updateTask=(0,l.IM)(this._updateTask),this._updateTask=(0,U.vr)(this._updateVisibility),this._updateRequested=!1,j.madeProgress()),this._frameTask.processQueue(j)}};(0,a._)([(0,y.Cb)({constructOnly:!0})],O.prototype,"context",void 0),(0,a._)([(0,y.Cb)()],O.prototype,"updating",null),(0,a._)([(0,y.Cb)()],O.prototype,"running",null),(0,a._)([(0,y.Cb)()],O.prototype,"defaultVisibility",null),(0,a._)([(0,y.Cb)()],O.prototype,"_featureFilter",null),(0,a._)([(0,y.Cb)()],O.prototype,"_sceneFilter",null),(0,a._)([(0,y.Cb)()],O.prototype,"_floorFilter",null),(0,a._)([(0,y.Cb)()],O.prototype,"_timeExtent",null),(0,a._)([(0,y.Cb)()],O.prototype,"_compositedFeatureFilter",null),(0,a._)([(0,y.Cb)()],O.prototype,"_layerView",null),(0,a._)([(0,y.Cb)()],O.prototype,"_updateTask",void 0),(0,a._)([(0,y.Cb)()],O.prototype,"_updateRequested",void 0),O=(0,a._)([(0,v.j)("esri.views.3d.layers.support.FeatureVisibilityFilter")],O)},97445:(fe,ee,i)=>{function F(U,b,A){if(!A||null==b)return null;if(!U)return function a(U,b){const A=b.toLowerCase();for(const l in U)if(l.toLowerCase()===A)return U[l];return null}(b,A);const l=U.get(A);return l?b[l.name]:null}i.d(ee,{g:()=>F})},89765:(fe,ee,i)=>{i.d(ee,{E:()=>b});var F=i(62208),a=i(46367),U=i(35082);function b(A){const l=A.view.spatialReference,f=A.layer.fullExtent,w=(0,F.pC)(f)&&f.spatialReference;if((0,F.Wi)(f)||!w)return Promise.resolve(null);if(w.equals(l))return Promise.resolve(f.clone());const y=(0,a.iV)(f,l);return(0,F.pC)(y)?Promise.resolve(y):A.view.state.isLocal?(0,U.projectGeometry)(f,l,A.layer.portalItem).then(u=>!A.destroyed&&u?u:null).catch(()=>null):Promise.resolve(null)}},36967:(fe,ee,i)=>{i.d(ee,{g:()=>b});var F=i(61885),a=i(73234),U=i(28862);class b extends F.Z{constructor(){super(...arguments),this._set=new Set}clear(){if(this._set.size>0){const l=this.toArray();this._set.clear(),this.emit("after-changes",{type:a.y.REMOVE}),this.emit("change",{added:[],removed:l})}}get length(){return this._set.size}addMany(l){if(0!==l.length){for(const f of l)this._set.add(f);this.emit("after-changes",{type:a.y.ADD}),this.emit("change",{added:l,removed:[]})}}remove(l){this._set.delete(l)&&(this.emit("after-changes",{type:a.y.REMOVE}),this.emit("change",{added:[],removed:[l]}))}removeMany(l){const f=[];for(const w of l)this._set.delete(w)&&f.push(w);f.length>0&&(this.emit("after-changes",{type:a.y.REMOVE}),this.emit("change",{added:[],removed:f}))}toArray(){return[...this._set]}find(l){let f;return(0,U.f)(this._set,w=>!!l(w)&&(f=w,!0)),f}forEach(l){this._set.forEach(f=>l(f))}}},45611:(fe,ee,i)=>{i.d(ee,{Z:()=>_});var F=i(17626),a=i(14517),U=i(61885),b=i(80542),A=i(61996),l=i(63290),f=i(62208),w=i(60330),y=i(77712),v=(i(90912),i(85931),i(76898));let L=class extends((0,b.p)((0,A.IG)((0,w.v)(U.Z.EventedMixin(a.Z))))){constructor(h){super(h),this.layer=null,this.parent=null}initialize(){this.when().catch(h=>{if("layerview:create-error"!==h.name){const P=this.layer&&this.layer.id||"no id",O=this.layer&&this.layer.title||"no title";l.Z.getLogger(this.declaredClass).error("#resolve()",`Failed to resolve layer view (layer title: '${O}', id: '${P}')`,h)}})}get fullOpacity(){return(0,f.Pt)(this.get("layer.opacity"),1)*(0,f.Pt)(this.get("parent.fullOpacity"),1)}get suspended(){return!this.canResume()}get suspendInfo(){return this.getSuspendInfo()}get legendEnabled(){return!this.suspended&&!0===this.layer?.legendEnabled}get updating(){return!(!this.updatingHandles?.updating&&!this.isUpdating())}get updatingProgress(){return this.updating?0:1}get visible(){return!0===this.layer?.visible}set visible(h){this._overrideIfSome("visible",h)}canResume(){return this.visible&&this.layer?.loaded&&!this.parent?.suspended&&this.view?.ready||!1}getSuspendInfo(){const h=this.parent&&this.parent.suspended?this.parent.suspendInfo:{};return this.view&&this.view.ready||(h.viewNotReady=!0),this.layer&&this.layer.loaded||(h.layerNotLoaded=!0),this.visible||(h.layerInvisible=!0),h}isUpdating(){return!1}};(0,F._)([(0,y.Cb)()],L.prototype,"fullOpacity",null),(0,F._)([(0,y.Cb)()],L.prototype,"layer",void 0),(0,F._)([(0,y.Cb)()],L.prototype,"parent",void 0),(0,F._)([(0,y.Cb)({readOnly:!0})],L.prototype,"suspended",null),(0,F._)([(0,y.Cb)({readOnly:!0})],L.prototype,"suspendInfo",null),(0,F._)([(0,y.Cb)({readOnly:!0})],L.prototype,"legendEnabled",null),(0,F._)([(0,y.Cb)({type:Boolean,readOnly:!0})],L.prototype,"updating",null),(0,F._)([(0,y.Cb)({readOnly:!0})],L.prototype,"updatingProgress",null),(0,F._)([(0,y.Cb)()],L.prototype,"visible",null),(0,F._)([(0,y.Cb)()],L.prototype,"view",void 0),L=(0,F._)([(0,v.j)("esri.views.layers.LayerView")],L);const _=L},3959:(fe,ee,i)=>{i.d(ee,{v:()=>b});var F=i(26584),a=i(62208),U=i(67969);function b(A,l){const{textureFloat:f,colorBufferFloat:w}=A.capabilities,y=f?.textureFloat,u=f?.textureFloatLinear,p=f?.textureHalfFloat,v=f?.textureHalfFloatLinear,L=f?.HALF_FLOAT,_=w?.textureFloat,h=w?.textureHalfFloat,P=w?.floatBlend,O=(0,a.s3)(A.driverTest).floatBufferBlend.result;if(!y&&!p)throw new F.Z("heatmap:missing-texture-float","HeatmapRenderer requires WebGL2 or the WebGL1 extension OES_texture_float or OES_texture_half_float.");if(!_&&!h)throw new F.Z("heatmap:missing-color-buffer-float","HeatmapRenderer requires the WebGL extension EXT_color_buffer_float or EXT_color_buffer_half_float or WEBGL_color_buffer_float.");if(!(P&&O||h))throw new F.Z("heatmap:missing-float-blend","HeatmapRenderer requires the WebGL extension EXT_float_blend or EXT_color_buffer_half_float."+(O?"":" This device claims support for EXT_float_blend, but does not actually support it."));const M=p&&h,Y=u,K=v,E=!!w?.R32F,R=!!w?.R16F;if(y&&_&&P&&O&&(Y||!K))return Y||l.warnOnce("Missing WebGL extension OES_texture_float_linear. Heatmap quality may be reduced."),{dataType:U.Br.FLOAT,samplingMode:Y?U.cw.LINEAR:U.cw.NEAREST,pixelFormat:E?U.VI.RED:U.VI.RGBA,internalFormat:E?U.lP.R32F:U.VI.RGBA};if(M)return K||l.warnOnce("Missing WebGL extension OES_texture_half_float_linear. Heatmap quality may be reduced."),{dataType:L,samplingMode:K?U.cw.LINEAR:U.cw.NEAREST,pixelFormat:R?U.VI.RED:U.VI.RGBA,internalFormat:R?U.lP.R16F:U.VI.RGBA};throw new F.Z("heatmap:missing-hardware-support","HeatmapRenderer requires WebGL extensions that allow it to render and blend to float or half float textures.")}}}]);