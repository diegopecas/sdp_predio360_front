"use strict";(self.webpackChunkpredio360_app=self.webpackChunkpredio360_app||[]).push([[8203],{46668:(fe,se,i)=>{i.d(se,{a:()=>E});const T=2654435761,a=2246822519,w=3266489917,R=668265263,L=374761393;function l(H){const f=[];for(let u=0,p=H.length;u<p;u++){let C=H.charCodeAt(u);C<128?f.push(C):C<2048?f.push(192|C>>6,128|63&C):C<55296||C>=57344?f.push(224|C>>12,128|C>>6&63,128|63&C):(u++,C=65536+((1023&C)<<10|1023&H.charCodeAt(u)),f.push(240|C>>18,128|C>>12&63,128|C>>6&63,128|63&C))}return new Uint8Array(f)}class E{constructor(f){this._seed=f,this._totallen=0,this._bufs=[],this.init()}init(){return this._bufs=[],this._totallen=0,this}updateFloatArray(f){const u=[];for(const p of f)isNaN(p)?u.push("NaN"):u.push(p===1/0?"Infinity":p===-1/0?"-Infinity":0===p?"0":p.toString(16));this.update(l(u.join("")))}updateIntArray(f){const u=Int32Array.from(f);this.update(new Uint8Array(u.buffer))}updateUint8Array(f){this.update(Uint8Array.from(f))}updateWithString(f){return this.update(l(f))}update(f){return this._bufs.push(f),this._totallen+=f.length,this}digest(){const f=new Uint8Array(this._totallen);let u=0;for(const p of this._bufs)f.set(p,u),u+=p.length;return this.init(),this._xxHash32(f,this._seed)}_xxHash32(f,u=0){const p=f;let C=u+L&4294967295,V=0;if(p.length>=16){const h=[u+T+a&4294967295,u+a&4294967295,u+0&4294967295,u-T&4294967295],M=f,O=M.length-16;let W=0;for(V=0;(4294967280&V)<=O;V+=4){let D=h[W]+((M[V+0]+(M[V+1]<<8))*a+((M[V+2]+(M[V+3]<<8))*a<<16))&4294967295;D=D<<13|D>>>19,h[W]=(65535&D)*T+((D>>>16)*T<<16)&4294967295,W=W+1&3}C=(h[0]<<1|h[0]>>>31)+(h[1]<<7|h[1]>>>25)+(h[2]<<12|h[2]>>>20)+(h[3]<<18|h[3]>>>14)&4294967295}C=C+f.length&4294967295;const m=f.length-4;for(;V<=m;V+=4)C=C+((p[V+0]+(p[V+1]<<8))*w+((p[V+2]+(p[V+3]<<8))*w<<16))&4294967295,C=C<<17|C>>>15,C=(65535&C)*R+((C>>>16)*R<<16)&4294967295;for(;V<p.length;++V)C+=p[V]*L,C=C<<11|C>>>21,C=(65535&C)*T+((C>>>16)*T<<16)&4294967295;return C^=C>>>15,C=((65535&C)*a&4294967295)+((C>>>16)*a<<16),C^=C>>>13,C=((65535&C)*w&4294967295)+((C>>>16)*w<<16),C^=C>>>16,C<0?C+4294967296:C}}},88034:(fe,se,i)=>{i.d(se,{H:()=>H,b:()=>E});var T=i(39523),a=i(49480),w=i(65787),R=i(17625),L=i(22355),l=i(35387);function E(f){const u=new L.kG;u.include(T.k),u.include(a.f);const{usesHalfFloat:p}=f;return u.fragment.uniforms.add([new l.A("densityMap",C=>C.densityMap),new l.A("tex",C=>C.colorRamp),new w.p("densityNormalizer",C=>1/(C.maxDensity-C.minDensity)),new w.p("minDensity",C=>C.minDensity)]),u.fragment.uniforms.add(new w.p("densityMultiplier",C=>3/(C.searchRadius*C.searchRadius*Math.PI))),p&&u.constants.add("compressionFactor","float",4),u.fragment.code.add(R.H`
    void main() {
      float density = texture2D(densityMap, uv).r * densityMultiplier${p?R.H` * compressionFactor`:""};
      float densityRatio = (density - minDensity) * densityNormalizer;

      vec4 color = texture2D(tex, vec2(clamp(densityRatio, 0.0, 1.0), 0.5));

      discardOrAdjustAlpha(color);
      gl_FragColor = color;
    }
  `),u}const H=Object.freeze(Object.defineProperty({__proto__:null,build:E},Symbol.toStringTag,{value:"Module"}))},81768:(fe,se,i)=>{i.d(se,{H:()=>E,b:()=>l});var T=i(2166),a=i(65787),w=i(17625),R=i(22355),L=i(16396);function l(H){const f=new R.kG,{vertex:u,fragment:p}=f;(0,T.Sv)(u,H);const{isAttributeDriven:C,usesHalfFloat:V}=H;return f.attributes.add(L.T.POSITION,"vec3"),f.attributes.add(L.T.UV0,"vec2"),C&&(f.attributes.add(L.T.FEATUREATTRIBUTE,"float"),f.varyings.add("attributeValue","float")),V&&f.constants.add("compressionFactor","float",.25),f.varyings.add("unitCirclePos","vec2"),u.uniforms.add(new a.p("radius",({resolutionForScale:m,searchRadius:h},{camera:M,screenToWorldRatio:O})=>2*h*(0===m?1:m/O)*M.pixelRatio/M.fullViewport[2])),u.code.add(w.H`
    void main() {
      unitCirclePos = uv0;

      vec4 posProj = proj * (view * vec4(${L.T.POSITION}, 1.0));
      vec4 quadOffset = vec4(unitCirclePos * radius, 0.0, 0.0);

      ${C?w.H`attributeValue = ${L.T.FEATUREATTRIBUTE};`:""}
      gl_Position = posProj + quadOffset;
    }
  `),p.code.add(w.H`
    void main() {
      float radiusRatioSquared = dot(unitCirclePos, unitCirclePos);
      if (radiusRatioSquared > 1.0) {
        discard;
      }

      float oneMinusRadiusRatioSquared = 1.0 - radiusRatioSquared;
      float density = oneMinusRadiusRatioSquared * oneMinusRadiusRatioSquared ${C?w.H` * attributeValue`:""} ${V?w.H` * compressionFactor`:""};
      gl_FragColor = vec4(density);
    }
  `),f}const E=Object.freeze(Object.defineProperty({__proto__:null,build:l},Symbol.toStringTag,{value:"Module"}))},23010:(fe,se,i)=>{i.d(se,{g:()=>ie});var T=i(15861),a=i(17626),w=i(14517),R=i(59213),L=i(46160),E=(i(8314),i(26584)),H=i(72392),f=i(58817),u=i(63290),p=i(62208),C=i(60330),V=i(10699),m=i(32917),h=i(77712),O=(i(90912),i(76898)),W=i(17760),I=i(38305),J=i(72469),z=i(35082),F=i(60776),D=i(54984),N=i(88879),$=i(37118),ne=i(9260),ue=i(69852),de=i(89673),he=i(21716),Ee=i(23461);const K=[[0,179,255],[117,62,128],[0,104,255],[215,189,166],[32,0,193],[98,162,206],[102,112,129],[52,125,0],[142,118,246],[138,83,0],[92,122,255],[122,55,83],[0,142,255],[81,40,179],[0,200,244],[13,24,127],[0,170,147],[19,58,241],[22,44,35]];class be{constructor(d,B,te){this._loadingGraphics=new Map,this._loadedGraphics=new Map,this._pendingGraphics=new Map,this._dataExtentGraphic=null,this._enabled=!0,this._tileFetcher=d,this._view=te,this._tilingScheme=new Ee.t(B),this._loadedSymbols=K.map(X=>new de.Z(new ne.Z({material:{color:[X[0],X[1],X[2],.6]},outline:{color:"black",size:1}}))),this._loadingSymbols=[new de.Z(new ne.Z({material:{color:[200,200,200,.4]},outline:{color:[30,30,30],size:1}}))],this._pendingSymbols=[new de.Z(new ne.Z({material:{color:[100,100,100,.4]},outline:{color:[30,30,30],size:1}}))],this._dataExtentSymbol=new de.Z(new ne.Z({material:{color:[0,0,0,0]},outline:{color:"green",size:4}}))}destroy(){this.enabled=!1}get enabled(){return this._enabled}set enabled(d){this._enabled=d,this.update()}update(){this._enabled?(this._synchronizeMaps(this._loadingGraphics,{filter:d=>d.isFetching,symbols:this._loadingSymbols}),this._synchronizeMaps(this._loadedGraphics,{filter:d=>!d.isFetching,symbols:this._loadedSymbols}),this._synchronizeMaps(this._pendingGraphics,{filter:d=>!d.isFetching,symbols:this._pendingSymbols}),this.showDataExtent(this._tileFetcher.filterExtent)):(this._loadingGraphics.forEach(d=>{this._view.graphics.removeMany(d)}),this._loadingGraphics.clear(),this._loadedGraphics.forEach(d=>{this._view.graphics.removeMany(d)}),this._loadedGraphics.clear(),this._pendingGraphics.forEach(d=>{this._view.graphics.removeMany(d)}),this._pendingGraphics.clear(),this._dataExtentGraphic&&(this._view.graphics.remove(this._dataExtentGraphic),this._dataExtentGraphic=null))}showDataExtent(d){if(this._dataExtentGraphic&&(this._view.graphics.remove(this._dataExtentGraphic),this._dataExtentGraphic=null),(0,p.Wi)(d))return;const B=$.Z.fromExtent(d);this._dataExtentGraphic=new N.Z({geometry:B,symbol:this._dataExtentSymbol}),this._view.graphics.add(this._dataExtentGraphic)}_synchronizeMaps(d,B){const te=[];d.forEach((X,ee)=>{const me=this._tileFetcher.test.getFeatureTileById(ee);me&&B.filter(me)||(this._view.graphics.removeMany(X),te.push(ee))}),te.forEach(X=>d.delete(X)),this._tileFetcher.test.forEachFeatureTile(X=>{if(B.filter(X)&&!d.has(X.id)){const[ee,me,ve]=X.descriptor.lij;this._tilingScheme.ensureMaxLod(ee);const ae=this._tilingScheme.getExtentGeometry(ee,me,ve),ye=[new N.Z({geometry:ae,symbol:B.symbols[ee%B.symbols.length]}),new N.Z({geometry:ae.center,symbol:new ue.Z({verticalOffset:{screenLength:40/.75},callout:{type:"line",color:"white",border:{color:"black"}},symbolLayers:[new he.Z({text:`${ee}/${me}/${ve}`,halo:{color:"white",size:1/.75},material:{color:"black"},size:16})]})})];d.set(X.id,ye),this._view.graphics.addMany(ye)}})}}var xe=i(93605);let ie=class extends((0,C.v)(w.Z)){set extent(v){if((0,p.pC)(v)&&!v.spatialReference.equals(this.layerView.view.spatialReference))return void u.Z.getLogger(this.declaredClass).error("#extent=","extent needs to be in the same spatial reference as the view");const d=this._get("extent");if(d===v||(0,p.pC)(d)&&v&&d.equals(v))return;const B=(0,p.pC)(v)?v.clone():null;this._set("extent",B)}get updating(){return!!((0,p.pC)(this._tileFetcher)&&this._tileFetcher.updating||null!=this._fetchDataInfoPromise||"tiles"===this.mode&&this.layerView.view.featureTiles&&this.layerView.view.featureTiles.updating||this._watchUpdatingTracking&&this._watchUpdatingTracking.updating)}get updatingTotal(){return this.updating&&(0,p.pC)(this._tileFetcher)?this._tileFetcher.updatingTotal:0}get updatingRemaining(){return this.updating&&(0,p.pC)(this._tileFetcher)?this._tileFetcher.updatingRemaining:0}get expectedFeatureDiff(){return this.updating&&(0,p.pC)(this._tileFetcher)?this._tileFetcher.expectedFeatureDiff:0}get memoryForUnusedFeatures(){return(0,p.pC)(this._tileFetcher)?this._tileFetcher.memoryForUnusedFeatures:0}get maximumNumberOfFeaturesExceeded(){return!(!(0,p.pC)(this._tileFetcher)||!this._tileFetcher.maximumNumberOfFeaturesExceeded)}get maximumNumberOfFeatures(){return(0,p.pC)(this.displayFeatureLimit)?this.displayFeatureLimit.maximumNumberOfFeatures:0}set maximumNumberOfFeatures(v){v!==this.maximumNumberOfFeatures&&this._overrideIfSome("maximumNumberOfFeatures",v)}get hasMaximumNumberOfFeaturesOverride(){return this._isOverridden("maximumNumberOfFeatures")}get mode(){const v=this.layerView.layer;if("feature"===v.type&&(0,p.pC)(v.infoFor3D))return"snapshot";if(!1===this.layerView.view.qualitySettings?.graphics3D?.snapshotAvailable||this.serviceDataCount===_e.NO_SERVICE_DATA_COUNT||this.vertexLimitExceeded)return"tiles";const d=this.layerView.view,B=d&&d.featureTiles,te=B&&B.tilingScheme;if(v&&v.minScale&&this.serviceDataExtent&&te){const X=this._approximateExtentSizeAtScale(v.minScale,te);if((this.serviceDataExtent.width/X+this.serviceDataExtent.height/X)/2>_e.MAX_SNAPSHOT_MIN_SCALE_FACTOR)return"tiles"}return!this.maximumNumberOfFeatures||this.serviceDataCount<=this.maximumNumberOfFeatures?"snapshot":"tiles"}get maxTotalSnapshotVertices(){const v=this._get("maxTotalSnapshotVertices")||0,d="snapshot"===this.mode&&(0,p.pC)(this._tileFetcher)&&this._tileFetcher.totalVertices||0;return Math.max(v,d)}_approximateExtentSizeAtScale(v,d){const B=this.layerView.view,te=Math.ceil((B.width/d.pixelSize+B.height/d.pixelSize)/2),X=d.levels[0];return te*((X.tileSize[0]/(X.scale/v)+X.tileSize[1]/(X.scale/v))/2)}get tileDescriptors(){return"snapshot"===this.mode?new L.Z([{id:"dummy-tile-full-extent",lij:[0,0,0]}]):this.layerView.view.featureTiles?this.layerView.view.featureTiles.tiles:new L.Z}get test(){return{fetchDataInfoPromise:this._fetchDataInfoPromise,tileFetcher:this._tileFetcher}}constructor(v){super(v),this.type="feature-tile-3d",this._watchUpdatingTracking=new W.t,this.serviceDataExtent=null,this.serviceDataCount=_e.NO_SERVICE_DATA_COUNT,this.vertexLimitExceeded=!1,this.displayFeatureLimit=null,this._suspended=!1,this._tileFetcher=null,this._handles=new H.Z,this._fetchDataInfoPromise=null,this._fetchDataInfoAbortController=null,this._lifeCycleAbortController=new AbortController}initialize(){this._watchUpdatingTracking.add(()=>this.vertexLimitInfo,()=>this._watchUpdatingTracking.addPromise(this._updateVertexLimitExceeded(null,this._lifeCycleAbortController.signal))),this._watchUpdatingTracking.add(()=>this.mode,()=>this._modeChanged(),m.nn),this.addResolvingPromise(Promise.resolve().then(()=>this._verifyCapabilities()).then(()=>this._watchUpdatingTracking.addPromise(this._fetchServiceDataInfo())).then(()=>this._initializeTileFetcher()))}_verifyCapabilities(){const v=this.layerView.layer;if("ogc-feature"!==v.type&&!(0,J.S1)(v)?.operations.supportsQuery)throw new E.Z("graphicscontroller:query-capability-required","Service requires query capabilities to be used as a feature layer",{layer:v})}destroy(){this._cancelFetchServiceDataInfo(),this._tileFetcher=(0,p.SC)(this._tileFetcher),this._handles=(0,p.SC)(this._handles),this._tilesHandle=(0,p.hw)(this._tilesHandle),this._lifeCycleAbortController=(0,p.IM)(this._lifeCycleAbortController),this._watchUpdatingTracking.destroy(),this._set("watchUpdatingTracking",null)}suspend(){this._suspended||(this._suspended=!0,(0,p.pC)(this._tileFetcher)&&this._tileFetcher.suspend())}resume(){this._suspended&&(this._suspended=!1,(0,p.pC)(this._tileFetcher)&&this._tileFetcher.resume())}restart(){const v=()=>{(0,p.pC)(this._tileFetcher)&&this._tileFetcher.restart()};this._watchUpdatingTracking.addPromise(this._fetchServiceDataInfo().then(v,v))}refetch(){const v=()=>{(0,p.pC)(this._tileFetcher)&&this._tileFetcher.refetch()};this._watchUpdatingTracking.addPromise(this._fetchServiceDataInfo().then(v,v))}_initializeTileFetcher(){const v=this.layerView.view;if(!v)return;const d=(0,m.N1)(()=>v.featureTiles?.tilingScheme,this._lifeCycleAbortController.signal);this._watchUpdatingTracking.addPromise(d),d.then(()=>{const{layerView:B,tileDescriptors:te}=this,X=B.layer,ee=new D.j({context:this.context,filterExtent:this.extent,tileDescriptors:te,features:this.graphics});this._tileFetcher=ee,this._suspended?this._tileFetcher.suspend():this._tileFetcher.resume();const me=this.layerView.view.resourceController;me&&this._handles.add((0,m.YP)(()=>me.memoryController.memoryFactor,A=>ee.memoryFactor=A,m.tX));const ve="polygon"===this.context.geometryType?"polygonLodFactor":"polyline"===this.context.geometryType?"polylineLodFactor":null;ve&&this._handles.add((0,m.YP)(()=>this.layerView.view?.qualitySettings?.graphics3D?.[ve],A=>ee.lodFactor=A||1,m.nn)),"ogc-feature"!==X.type&&this._watchUpdatingTracking.add(()=>X.createQueryVersion,()=>this._dataFilterChanged()),this._watchUpdatingTracking.add(()=>B.availableFields,(A,Te)=>this._availableFieldsChanged(Te,A)),this._watchUpdatingTracking.add(()=>B.requiredFields,(A,Te)=>this._requiredFieldsChanged(Te,A)),this._handles.add([X.on("apply-edits",A=>this._applyEdits(A)),(0,m.YP)(()=>this.extent,A=>ee.filterExtent=A,m.Z_),(0,m.YP)(()=>this.tileDescriptors,A=>ee.tileDescriptors=A,m.Z_),(0,m.YP)(()=>this.maximumNumberOfFeatures,A=>{ee.maximumNumberOfFeatures=A,ee.useTileCount=this.serviceDataCount>A},m.tX),(0,m.YP)(()=>this.serviceDataCount,A=>ee.useTileCount=A>this.maximumNumberOfFeatures,m.tX),(0,m.YP)(()=>xe.Z.FEATURE_TILE_FETCH_SHOW_TILES,A=>{A&&ee&&!ee.debugger?(ee.debugger=new be(ee,v.featureTiles.tilingScheme.toTileInfo(),v),ee.debugger.update()):!A&&this._tileFetcher&&ee.debugger&&(ee.debugger.destroy(),ee.debugger=null)},m.tX)]),this._supportsExceedsLimitQuery||this._watchUpdatingTracking.add(()=>this.maxTotalSnapshotVertices,()=>this._watchUpdatingTracking.addPromise(this._updateVertexLimitExceeded(null,this._lifeCycleAbortController.signal)))}).catch(()=>{})}_modeChanged(){switch(this.mode){case"tiles":this._tilesHandle||(this._tilesHandle=this.layerView.view.featureTiles.addClient());break;default:u.Z.getLogger(this.declaredClass).warn("Unhandled feature layer mode "+this.mode);case"snapshot":(0,p.pC)(this._tilesHandle)&&(this._tilesHandle.remove(),this._tilesHandle=null)}}_dataFilterChanged(){this._set("maxTotalSnapshotVertices",0),this.notifyChange("maxTotalSnapshotVertices"),this.refetch()}_applyEdits(v){(0,p.Wi)(this._tileFetcher)||this._tileFetcher.applyEdits(v).then(d=>{if(d){if(!this._lifeCycleAbortController)throw(0,V.zE)();(d.deletedFeatures.length||d.updatedFeatures.length||d.addedFeatures.length)&&this._watchUpdatingTracking.addPromise(this._updateServiceDataExtent(this._lifeCycleAbortController.signal))}}).catch(d=>{if(!(0,V.D_)(d))throw d})}_availableFieldsChanged(v,d){(0,p.pC)(this._tileFetcher)&&q(this._tileFetcher.availableFields,d)&&this.refetch()}_requiredFieldsChanged(v,d){(0,p.pC)(this._tileFetcher)&&q(this._tileFetcher.availableFields,d)&&this.restart()}_createVertexLimitExceededQuery(v){const d=this.layerView.layer,B=d.createQuery();return B.outStatistics=[new F.Z({statisticType:"exceedslimit",maxVertexCount:v,outStatisticFieldName:"exceedslimit",maxPointCount:1e8,maxRecordCount:1e8})],d.capabilities?.query.supportsCacheHint&&(B.cacheHint=!0),B}_createDataInfoQuery(){const v=this.layerView.layer,d=v.createQuery();return d.outSpatialReference=this.layerView.view.spatialReference,v.capabilities?.query.supportsCacheHint&&(d.cacheHint=!0),d}_fullExtentIsAccurate(){const v=this.layerView.layer;if(v.definitionExpression)return!1;switch(v.type){case"feature":case"oriented-imagery":return(0,I.M8)(v.url);case"csv":case"geojson":case"ogc-feature":case"wfs":return!0;default:return}}_updateServiceDataExtent(v){var d=this;return(0,T.Z)(function*(){try{yield d._tryUpdateServiceDataExtent(v)}catch(B){(0,V.D_)(B)||d._set("serviceDataExtent",(0,f.d9)(d.layerView.fullExtentInLocalViewSpatialReference))}})()}_tryUpdateServiceDataExtent(v){var d=this;return(0,T.Z)(function*(){const B=d.layerView,te=B.layer,X=te.capabilities?.query.supportsExtent??!1,ee=(0,f.d9)(B.fullExtentInLocalViewSpatialReference),me=te.fullExtent,ve=d._fullExtentIsAccurate();if(X&&d.serviceDataCount<=_e.MAX_FEATURE_COUNT_FOR_EXTENT&&(!ee||!ve)&&"queryExtent"in te){const ye=d._createDataInfoQuery(),A=yield te.queryExtent(ye,{timeout:_e.QUERY_EXTENT_TIMEOUT,signal:v});d._set("serviceDataExtent",A.extent)}else if(ee)d._set("serviceDataExtent",ee);else if((0,p.pC)(me)){const ye="portalItem"in te?te.portalItem:null,A=yield(0,z.projectGeometry)(me,B.view.spatialReference,ye,v);d._set("serviceDataExtent",A)}else d._set("serviceDataExtent",null)})()}_updateServiceDataCount(v){var d=this;return(0,T.Z)(function*(){const B=d.layerView.layer;if(!("queryFeatureCount"in B))return void d._set("serviceDataCount",_e.NO_SERVICE_DATA_COUNT);const te=yield(0,R.q6)(B.queryFeatureCount(d._createDataInfoQuery(),{timeout:_e.QUERY_STATISTICS_TIMEOUT,signal:v}));if(!0===te.ok)d._set("serviceDataCount",te.value);else{if((0,V.D_)(te.error))throw te.error;d._set("serviceDataCount",_e.NO_SERVICE_DATA_COUNT)}})()}get vertexLimitInfo(){if((0,p.Wi)(this.displayFeatureLimit)||(0,p.Wi)(this.displayFeatureLimit.averageSymbolComplexity))return null;const{averageSymbolComplexity:v,maximumTotalNumberOfPrimitives:d}=this.displayFeatureLimit,{primitivesPerCoordinate:B,primitivesPerFeature:te}=v,X=this._get("vertexLimitInfo");return(0,p.Wi)(X)||X.maximumTotalNumberOfPrimitives!==d||X.primitivesPerCoordinate!==B||X.primitivesPerFeature!==te?{primitivesPerCoordinate:B,primitivesPerFeature:te,maximumTotalNumberOfPrimitives:d}:X}get _supportsExceedsLimitQuery(){const v=this.layerView.layer;return null!=v.capabilities&&v.capabilities.operations&&v.capabilities.operations.supportsExceedsLimitStatistics}get _minimumNumberOfVerticesForGeometry(){switch(this.layerView.layer.geometryType){case"point":case"multipoint":return 1;case"polygon":return 4;case"polyline":return 2;case"multipatch":case"mesh":return 3;default:return 0}}_updateVertexLimitExceeded(v,d){var B=this;return(0,T.Z)(function*(){const te=B.vertexLimitInfo;if((0,p.Wi)(te))return void B._set("vertexLimitExceeded",!1);const ee=B._minimumNumberOfVerticesForGeometry>1;if(!(te.primitivesPerFeature<=0||ee))return void B._set("vertexLimitExceeded",!1);const{primitivesPerFeature:me,primitivesPerCoordinate:ve,maximumTotalNumberOfPrimitives:ae}=te;let ye;0!==me&&(0,p.pC)(v)&&(yield v);const A=B.serviceDataCount,Te=A!==_e.NO_SERVICE_DATA_COUNT;if(ye=Math.ceil(Te?(ae-A*me)/(ve||1):ae/(ve||1)),ee&&(ye=Math.min(ye,Q)),Te&&B._minimumNumberOfVerticesForGeometry*A>ye)return void B._set("vertexLimitExceeded",!0);if(!B._supportsExceedsLimitQuery)return void B._set("vertexLimitExceeded",B.maxTotalSnapshotVertices>ye);const Me=yield(0,R.q6)(B.layerView.layer.queryFeatures(B._createVertexLimitExceededQuery(ye),{timeout:_e.QUERY_STATISTICS_TIMEOUT,signal:d}));if(!1===Me.ok){if((0,V.D_)(Me.error))throw Me.error;return void B._set("vertexLimitExceeded",!1)}const Re=Me.value.features[0];B._set("vertexLimitExceeded",!(!Re||!Re.attributes||!Re.attributes.exceedslimit))})()}_fetchServiceDataInfo(){var v=this;return(0,T.Z)(function*(){v._cancelFetchServiceDataInfo();let d=new AbortController;const B=d.signal,te=v._updateServiceDataCount(B),X=(0,V.as)([te,v._updateVertexLimitExceeded(te,B)]),ee=X.then(()=>v._updateServiceDataExtent(B)).catch(me=>{(0,V.D_)(me)||u.Z.getLogger(v.declaredClass).error("#fetchServiceDataInfo()",me)}).then(()=>{ee===v._fetchDataInfoPromise&&(v._fetchDataInfoPromise=null,v._fetchDataInfoAbortController=null),d=null});return d&&(v._fetchDataInfoPromise=ee),v._fetchDataInfoAbortController=d,X.then(()=>{},()=>{})})()}_cancelFetchServiceDataInfo(){const v=this._fetchDataInfoAbortController;v&&(this._fetchDataInfoAbortController=null,this._fetchDataInfoPromise=null,v.abort())}get debug(){return{storedFeatures:(0,p.pC)(this._tileFetcher)?this._tileFetcher.storedFeatures:0,totalFeatures:(0,p.pC)(this._tileFetcher)?this._tileFetcher.totalFeatures:0,totalVertices:(0,p.pC)(this._tileFetcher)?this._tileFetcher.totalVertices:0,missingTiles:(0,p.pC)(this._tileFetcher)?this._tileFetcher.missingTiles:0}}};(0,a._)([(0,h.Cb)({readOnly:!0})],ie.prototype,"type",void 0),(0,a._)([(0,h.Cb)({constructOnly:!0})],ie.prototype,"graphics",void 0),(0,a._)([(0,h.Cb)({constructOnly:!0})],ie.prototype,"layerView",void 0),(0,a._)([(0,h.Cb)({constructOnly:!0})],ie.prototype,"context",void 0),(0,a._)([(0,h.Cb)()],ie.prototype,"extent",null),(0,a._)([(0,h.Cb)()],ie.prototype,"updating",null),(0,a._)([(0,h.Cb)({readOnly:!0})],ie.prototype,"_watchUpdatingTracking",void 0),(0,a._)([(0,h.Cb)()],ie.prototype,"updatingTotal",null),(0,a._)([(0,h.Cb)()],ie.prototype,"updatingRemaining",null),(0,a._)([(0,h.Cb)()],ie.prototype,"expectedFeatureDiff",null),(0,a._)([(0,h.Cb)()],ie.prototype,"memoryForUnusedFeatures",null),(0,a._)([(0,h.Cb)()],ie.prototype,"maximumNumberOfFeaturesExceeded",null),(0,a._)([(0,h.Cb)({readOnly:!0})],ie.prototype,"serviceDataExtent",void 0),(0,a._)([(0,h.Cb)({readOnly:!0})],ie.prototype,"serviceDataCount",void 0),(0,a._)([(0,h.Cb)({readOnly:!0})],ie.prototype,"vertexLimitExceeded",void 0),(0,a._)([(0,h.Cb)()],ie.prototype,"displayFeatureLimit",void 0),(0,a._)([(0,h.Cb)({type:Number})],ie.prototype,"maximumNumberOfFeatures",null),(0,a._)([(0,h.Cb)({readOnly:!0})],ie.prototype,"mode",null),(0,a._)([(0,h.Cb)({readOnly:!0})],ie.prototype,"maxTotalSnapshotVertices",null),(0,a._)([(0,h.Cb)({readOnly:!0,dependsOn:["mode"]})],ie.prototype,"tileDescriptors",null),(0,a._)([(0,h.Cb)()],ie.prototype,"_tileFetcher",void 0),(0,a._)([(0,h.Cb)()],ie.prototype,"_fetchDataInfoPromise",void 0),(0,a._)([(0,h.Cb)({readOnly:!0})],ie.prototype,"vertexLimitInfo",null),ie=(0,a._)([(0,O.j)("esri.layers.graphics.controllers.FeatureTileController3D")],ie);const Q=5e6;function q(v,d){if(!d)return!1;for(const B of d)if(!v.has(B))return!0;return!1}var _e,v;(v=_e||(_e={})).NO_SERVICE_DATA_COUNT=1/0,v.MAX_SNAPSHOT_MIN_SCALE_FACTOR=5,v.reset=function d(){v.MAX_FEATURE_COUNT_FOR_EXTENT=1e4,v.QUERY_STATISTICS_TIMEOUT=12e3,v.QUERY_EXTENT_TIMEOUT=1e4},_e.reset()},61256:(fe,se,i)=>{i.d(se,{H:()=>H});var T=i(8314),a=i(36592),w=i(65401);const L={minX:0,minY:0,maxX:0,maxY:0};class H{constructor(){this._indexInvalid=!1,this._boundsToLoad=[],this._boundsById=new Map,this._idByBounds=new Map,this._index=new a.Q(9,(0,T.Z)("esri-csp-restrictions")?u=>({minX:u[0],minY:u[1],maxX:u[2],maxY:u[3]}):["[0]","[1]","[2]","[3]"]),this._loadIndex=()=>{if(this._indexInvalid){const u=new Array(this._idByBounds.size);let p=0;this._idByBounds.forEach((C,V)=>{u[p++]=V}),this._indexInvalid=!1,this._index.clear(),this._index.load(u)}else this._boundsToLoad.length&&(this._index.load(Array.from(new Set(this._boundsToLoad.filter(u=>this._idByBounds.has(u))))),this._boundsToLoad.length=0)}}get fullBounds(){if(!this._boundsById.size)return null;const u=(0,w.cS)();for(const p of this._boundsById.values())p&&(u[0]=Math.min(p[0],u[0]),u[1]=Math.min(p[1],u[1]),u[2]=Math.max(p[2],u[2]),u[3]=Math.max(p[3],u[3]));return u}get valid(){return!this._indexInvalid}clear(){this._indexInvalid=!1,this._boundsToLoad.length=0,this._boundsById.clear(),this._idByBounds.clear(),this._index.clear()}delete(u){const p=this._boundsById.get(u);this._boundsById.delete(u),p&&(this._idByBounds.delete(p),this._indexInvalid||this._index.remove(p))}forEachInBounds(u,p){this._loadIndex(),function E(f,u,p){(function l(f){L.minX=f[0],L.minY=f[1],L.maxX=f[2],L.maxY=f[3]})(u),f.search(L,p)}(this._index,u,C=>p(this._idByBounds.get(C)))}get(u){return this._boundsById.get(u)}has(u){return this._boundsById.has(u)}invalidateIndex(){this._indexInvalid||(this._indexInvalid=!0,this._boundsToLoad.length=0)}set(u,p){if(!this._indexInvalid){const C=this._boundsById.get(u);C&&(this._index.remove(C),this._idByBounds.delete(C))}this._boundsById.set(u,p),p&&(this._idByBounds.set(p,u),this._indexInvalid||(this._boundsToLoad.push(p),this._boundsToLoad.length>5e4&&this._loadIndex()))}}},3579:(fe,se,i)=>{i.d(se,{Z:()=>C});var T=i(26584),a=i(61885),w=i(63290),R=i(62208),L=i(5548),l=i(65401),E=i(82054),H=i(61256),f=i(92794),u=i(6185);const p=(0,L.Ue)();class C{constructor(m){this.geometryInfo=m,this._boundsStore=new H.H,this._featuresById=new Map,this._markedIds=new Set,this.events=new a.Z,this.featureAdapter=f.n}get geometryType(){return this.geometryInfo.geometryType}get hasM(){return this.geometryInfo.hasM}get hasZ(){return this.geometryInfo.hasZ}get numFeatures(){return this._featuresById.size}get fullBounds(){return this._boundsStore.fullBounds}get storeStatistics(){let m=0;return this._featuresById.forEach(h=>{(0,R.pC)(h.geometry)&&h.geometry.coords&&(m+=h.geometry.coords.length)}),{featureCount:this._featuresById.size,vertexCount:m/(this.hasZ?this.hasM?4:3:this.hasM?3:2)}}getFullExtent(m){if((0,R.Wi)(this.fullBounds))return null;const[h,M,O,W]=this.fullBounds;return{xmin:h,ymin:M,xmax:O,ymax:W,spatialReference:(0,u.S2)(m)}}add(m){this._add(m),this._emitChanged()}addMany(m){for(const h of m)this._add(h);this._emitChanged()}clear(){this._featuresById.clear(),this._boundsStore.clear(),this._emitChanged()}removeById(m){const h=this._featuresById.get(m);return h?(this._remove(h),this._emitChanged(),h):null}removeManyById(m){this._boundsStore.invalidateIndex();for(const h of m){const M=this._featuresById.get(h);M&&this._remove(M)}this._emitChanged()}forEachBounds(m,h){for(const M of m){const O=this._boundsStore.get(M.objectId);O&&h((0,L.JR)(p,O))}}getFeature(m){return this._featuresById.get(m)}has(m){return this._featuresById.has(m)}forEach(m){this._featuresById.forEach(h=>m(h))}forEachInBounds(m,h){this._boundsStore.forEachInBounds(m,M=>{h(this._featuresById.get(M))})}startMarkingUsedFeatures(){this._boundsStore.invalidateIndex(),this._markedIds.clear()}sweep(){let m=!1;this._featuresById.forEach((h,M)=>{this._markedIds.has(M)||(m=!0,this._remove(h))}),this._markedIds.clear(),m&&this._emitChanged()}_emitChanged(){this.events.emit("changed",void 0)}_add(m){if(!m)return;const h=m.objectId;if(null==h)return void w.Z.getLogger("esri.layers.graphics.data.FeatureStore").error(new T.Z("featurestore:invalid-feature","feature id is missing",{feature:m}));const M=this._featuresById.get(h);let O;if(this._markedIds.add(h),M?(m.displayId=M.displayId,O=this._boundsStore.get(h),this._boundsStore.delete(h)):(0,R.pC)(this.onFeatureAdd)&&this.onFeatureAdd(m),(0,R.Wi)(m.geometry)||!m.geometry.coords||!m.geometry.coords.length)return this._boundsStore.set(h,null),void this._featuresById.set(h,m);O=(0,E.$)((0,R.pC)(O)?O:(0,l.Ue)(),m.geometry,this.geometryInfo.hasZ,this.geometryInfo.hasM),(0,R.pC)(O)&&this._boundsStore.set(h,O),this._featuresById.set(h,m)}_remove(m){(0,R.pC)(this.onFeatureRemove)&&this.onFeatureRemove(m);const h=m.objectId;return this._markedIds.delete(h),this._boundsStore.delete(h),this._featuresById.delete(h),m}}},60507:(fe,se,i)=>{i.d(se,{Jn:()=>E,RL:()=>f,VW:()=>l,W_:()=>W,jG:()=>I,tR:()=>J,tq:()=>M,vQ:()=>V,zx:()=>m});var T=i(62208),a=i(29505);function w(F){return F?I:J}function l(F,D){return function R(F,D){return(0,T.Wi)(D)||!D.mode?w(F).mode:D.mode}(!!(0,T.pC)(F)&&F.hasZ,D)}function E(F,D){return function L(F,D){return(0,T.pC)(D)?D:w(F)}(!!(0,T.pC)(F)&&!!F.hasZ,D)}function f(F){const D=function p(F){return F.layer&&"elevationInfo"in F.layer?F.layer.elevationInfo:null}(F),N=l(F.geometry,D);return{mode:N,offset:(0,T.pC)(D)&&"on-the-ground"!==N?(0,T.Pt)(D.offset,0)*(0,a.Z7)((0,T.Pt)(D.unit,"meters")):0}}function V(F,D,N,$=null){return h(F,D.x,D.y,D.hasZ?D.z:0,D.spatialReference,N,$)}function m(F,D,N,$,ne=null){return h(F,D[0],D[1],D.length>2?D[2]:0,N,$,ne)}function h(F,D,N,$,ne,ue,de=null){if((0,T.Wi)(ue))return;const he=(0,T.pC)(de)?de.mode:"absolute-height";if("on-the-ground"===he)return 0;const{absoluteZ:Ee}=M(D,N,$,ne,F,ue);return function O(F,D,N,$,ne,ue,de,he){const Ee=(0,T.pC)(de)&&(0,T.pC)(de.offset)?de.offset:0;switch(he){case"absolute-height":return F-Ee;case"relative-to-ground":return F-((0,T.Pt)(ue.elevationProvider.getElevation(D,N,$,ne,"ground"),0)+Ee);case"relative-to-scene":return F-((0,T.Pt)(ue.elevationProvider.getElevation(D,N,$,ne,"scene"),0)+Ee)}}(Ee,D,N,$,ne,F,de,he)}function M(F,D,N,$,ne,ue){const de=(0,T.pC)(ue.offset)?ue.offset:0;switch(ue.mode){case"absolute-height":return{absoluteZ:N+de,elevation:0};case"on-the-ground":{const he=(0,T.Pt)(ne.elevationProvider.getElevation(F,D,0,$,"ground"),0);return{absoluteZ:he,elevation:he}}case"relative-to-ground":{const he=(0,T.Pt)(ne.elevationProvider.getElevation(F,D,N,$,"ground"),0);return{absoluteZ:N+he+de,elevation:he}}case"relative-to-scene":{const he=(0,T.Pt)(ne.elevationProvider.getElevation(F,D,N,$,"scene"),0);return{absoluteZ:N+he+de,elevation:he}}}}function W(F,D){if((0,T.Wi)(D))return!1;const{mode:N}=D;return(0,T.pC)(N)&&("scene"===F&&"relative-to-scene"===N||"ground"===F&&"absolute-height"!==N)}const I={mode:"absolute-height",offset:0},J={mode:"on-the-ground",offset:null}},78448:(fe,se,i)=>{i.d(se,{R:()=>dt});var T=i(15861),a=i(17626),w=i(26584),R=i(62208),L=i(32917),l=i(77712),f=(i(90912),i(85931),i(76898)),u=i(84786),p=i(23010),C=i(96854),V=i(86606),m=i(13191),h=i(33816),M=i(34675),O=i(46348),W=i(27306),I=i(80542),J=i(54024),z=i(63290),F=i(23841),D=i(84161),N=i(28093),$=i(55915),ne=i(83137),ue=i(38114),de=i(82054),he=i(66385),Ee=i(88071),K=i(3579),be=i(36630),xe=i(36859),ie=i(62600),_=i(98667),U=i(64835),oe=i(94255),Q=i(24425),q=i(59617),_e=i(19597),v=i(14411),d=i(17625),B=i(651),te=i(91056),X=i(87601),ee=i(39114),me=i(88569),ve=i(12407),ae=i(41528),ye=i(88034),A=i(67969),Te=i(2078);class Me extends d.K{constructor(){super(...arguments),this.colorRamp=null,this.densityMap=null,this.searchRadius=1,this.fieldTotal=0,this.minDensity=0,this.maxDensity=100}}class Re extends te.A{constructor(b,g){super(b,g,()=>this.destroy())}initializeProgram(b){return new ve.$(b.rctx,Re.shader.get().build(this.configuration),ee.i)}initializePipeline(){return(0,Te.sm)({blending:me.wu,colorWrite:Te.BK,depthTest:null,depthWrite:null})}get primitiveType(){return A.MX.TRIANGLE_STRIP}}Re.shader=new B.J(ye.H,()=>i.e(4194).then(i.bind(i,74194)));class Le extends ae.W{constructor(){super(...arguments),this.usesHalfFloat=!1}}(0,a._)([(0,X.o)()],Le.prototype,"usesHalfFloat",void 0);var Ne=i(85775),Ke=i(55086),Ge=i(26906);let Ce=class extends v.S{constructor(y){super(y),this.pixelRatio=1,this._colorRampData=new Uint8ClampedArray(4),this.type="draped-heatmap",this._heatmapParameters=new Me}initialize(){this._densityMap=new Ne.X(this.rctx,{colorTarget:A.Lm.TEXTURE,depthStencilTarget:A.OU.NONE,width:0,height:0},{target:A.No.TEXTURE_2D,pixelFormat:this.pixelFormat,internalFormat:this.internalFormat,dataType:this.dataType,samplingMode:this.samplingMode,wrapMode:A.e8.CLAMP_TO_EDGE,width:0,height:0}),this._quad=(0,_e.ow)(this.rctx);const g=this._colorRampData;this._colorRamp=new Ke.x(this.rctx,{target:A.No.TEXTURE_2D,pixelFormat:A.VI.RGBA,dataType:A.Br.UNSIGNED_BYTE,samplingMode:A.cw.LINEAR,wrapMode:A.e8.CLAMP_TO_EDGE,width:g.length/4,height:1},g);const Y=new Le;Y.usesHalfFloat=this.dataType!==A.Br.FLOAT,this._technique=new Re({rctx:this.rctx,viewingMode:q.JY.Local},Y),this._heatmapParameters.densityMap=this._densityMap.colorTexture,this.addHandles((0,L.YP)(()=>[this.colorRampData,this.minDensity,this.maxDensity,this.fieldTotal,this.pixelRatio,this.searchRadius],()=>this.rendererContext.notifyContentChanged()))}destroy(){this._technique=(0,R.RY)(this._technique),this._densityMap=(0,R.M2)(this._densityMap),this._quad=(0,R.M2)(this._quad),this._colorRamp=(0,R.M2)(this._colorRamp)}get searchRadius(){return this._heatmapParameters.searchRadius}set searchRadius(y){y!==this._heatmapParameters.searchRadius&&(this._heatmapParameters.searchRadius=y,this.notifyChange("searchRadius"))}get minDensity(){return this._heatmapParameters.minDensity}set minDensity(y){y!==this._heatmapParameters.minDensity&&(this._heatmapParameters.minDensity=y,this.notifyChange("minDensity"))}get maxDensity(){return this._heatmapParameters.maxDensity}set maxDensity(y){y!==this._heatmapParameters.maxDensity&&(this._heatmapParameters.maxDensity=y,this.notifyChange("maxDensity"))}get fieldTotal(){return this._heatmapParameters.fieldTotal}set fieldTotal(y){this._heatmapParameters.fieldTotal=y,this.notifyChange("fieldTotal")}get colorRampData(){return this._colorRampData}set colorRampData(y){const{colorRamp:b}=this._heatmapParameters;if((0,R.pC)(b)&&y!==this._colorRampData){const x=y.length/4;x!==b.descriptor.width&&b.resize(x,1),b.setData(y)}this._colorRampData=y}get _colorRamp(){return this._heatmapParameters.colorRamp}set _colorRamp(y){this._heatmapParameters.colorRamp=y}get hasHighlights(){return!1}get hasWater(){return!1}get rendersOccluded(){return!1}render(y){const b=this._sortedMaterialRenderers;if(b.length<1)return;const g=this.rctx.getBoundFramebufferObject(),x=this.rctx.getViewport(),Y=y.bindParameters,{pixelRatio:G}=this,k=Math.ceil(x.width*G),le=Math.ceil(x.height*G);this._densityMap.resize(k,le),this.rctx.bindFramebuffer(this._densityMap),this.rctx.setViewport(0,0,k,le),this.rctx.clear(A.lk.COLOR_BUFFER_BIT);let ge=!1;b.forAll(Oe=>{Oe.material.shouldRender(y)&&(ge=Oe.render(y.output,Y)||ge)}),this.rctx.bindFramebuffer(g),this.rctx.setViewport(x.x,x.y,x.width,x.height),ge&&(this.rctx.bindVAO(this._quad),this.rctx.bindTechnique(this._technique,this._heatmapParameters,y.bindParameters),this.rctx.drawArrays(this._technique.primitiveType,0,(0,Ge._V)(this._quad,"geometry")))}};(0,a._)([(0,l.Cb)()],Ce.prototype,"searchRadius",null),(0,a._)([(0,l.Cb)()],Ce.prototype,"minDensity",null),(0,a._)([(0,l.Cb)()],Ce.prototype,"maxDensity",null),(0,a._)([(0,l.Cb)()],Ce.prototype,"fieldTotal",null),(0,a._)([(0,l.Cb)()],Ce.prototype,"pixelRatio",void 0),(0,a._)([(0,l.Cb)()],Ce.prototype,"colorRampData",null),(0,a._)([(0,l.Cb)({constructOnly:!0})],Ce.prototype,"dataType",void 0),(0,a._)([(0,l.Cb)({constructOnly:!0})],Ce.prototype,"samplingMode",void 0),(0,a._)([(0,l.Cb)({constructOnly:!0})],Ce.prototype,"pixelFormat",void 0),(0,a._)([(0,l.Cb)({constructOnly:!0})],Ce.prototype,"internalFormat",void 0),(0,a._)([(0,l.Cb)()],Ce.prototype,"_colorRampData",void 0),Ce=(0,a._)([(0,f.j)("esri.views.3d.webgl-engine.lib.DrapedHeatmapRenderer")],Ce);var Ze=i(41120),Ue=i(54840),s=i(64232),r=i(23147),o=i(16396),c=i(67831),S=i(99770),P=i(19625),j=i(13934),re=i(60881),ce=i(40723),Fe=i(5894),pe=i(42037),De=i(81768);class Ie extends ce.Mt{constructor(){super(...arguments),this.searchRadius=128,this.resolutionForScale=0}}class Se extends te.A{initializeProgram(b){return new ve.$(b.rctx,Se.shader.get().build(this.configuration),ee.i)}initializePipeline(){return(0,Te.sm)({blending:(0,Te.if)(A.zi.ONE,A.zi.ONE,A.db.ADD),colorWrite:Te.BK,depthTest:null,depthWrite:null})}destroy(){super.destroy()}}Se.shader=new B.J(De.H,()=>i.e(5795).then(i.bind(i,15795)));class Ve extends ae.W{constructor(){super(...arguments),this.isAttributeDriven=!1,this.usesHalfFloat=!1}}(0,a._)([(0,X.o)()],Ve.prototype,"isAttributeDriven",void 0),(0,a._)([(0,X.o)()],Ve.prototype,"usesHalfFloat",void 0);class it extends Ie{constructor(){super(...arguments),this.isAttributeDriven=!1,this.usesHalfFloats=!1}}class Xe extends ce.F5{constructor(b){super(b,new it),this._configuration=new Ve}requiresSlot(b,g){return b===Fe.r.DRAPED_MATERIAL&&g===j.H.Color}getConfiguration(){return this._configuration.isAttributeDriven=this.parameters.isAttributeDriven,this._configuration.usesHalfFloat=this.parameters.usesHalfFloats,this._configuration}createGLMaterial(b){return new rt(b)}intersect(){}intersectDraped(b,g,x,Y,G,k){const le=b.vertexAttributes.get(o.T.POSITION),{parameters:ge}=this,{searchRadius:Oe}=ge,{screenToWorldRatio:Pe}=b,Be=Oe*Pe+2*Pe,we=Be*Be,Ye=le.data.length/le.size;for(let je=0;je<Ye;je++){const Ae=je*le.size,We=(0,c.s)(ot,le.data[Ae],le.data[Ae+1]);(0,c.k)(We,Y)<we&&G(k.dist,k.normal,-1,!1)}}createBufferWriter(){return new at(this.parameters.isAttributeDriven?nt:Je)}}class rt extends re.Z{beginSlot(b){return this.ensureTechnique(Se,b)}}class at{constructor(b){this.vertexBufferLayout=b}allocate(b){return this.vertexBufferLayout.createBuffer(b)}elementCount(b){return b.indices.get(o.T.POSITION).length*ze}write(b,g,x,Y,G){(0,pe.ho)(x.indices.get(o.T.POSITION),x.vertexAttributes.get(o.T.POSITION).data,b,Y.position,G,ze);const k=x.indices.get(o.T.POSITION).length,le=Y.uv0;let ge=G;for(let Pe=0;Pe<k;++Pe)le.setValues(ge++,-1,-1),le.setValues(ge++,1,-1),le.setValues(ge++,1,1),le.setValues(ge++,1,1),le.setValues(ge++,-1,1),le.setValues(ge++,-1,-1);const Oe=o.T.FEATUREATTRIBUTE in Y?Y.featureAttribute:null;Oe&&(0,pe.XW)(x.indices.get(o.T.FEATUREATTRIBUTE),x.vertexAttributes.get(o.T.FEATUREATTRIBUTE).data,Oe,G,ze)}}const Je=(0,P.U$)().vec3f(o.T.POSITION).vec2f(o.T.UV0),nt=Je.clone().f32(o.T.FEATUREATTRIBUTE),ze=6,ot=(0,S.a)();var $e=i(93579);const ke="esri.views.3d.layers.support.HeatmapFeatureProcessor",He=z.Z.getLogger(ke);let Z=class extends I.r{constructor(y){super(y),this.type="heatmap",this.preferredUpdatePolicy=r.j.ASYNC,this.dataExtent=null,this.drapeSourceType=ie.Lw.Features,this._renderGeometries=new Map,this._fieldTotal=0,this._drapeSourceRenderer=null,this._dataType=A.Br.HALF_FLOAT,this._pixelFormat=A.VI.RGBA,this.initializePromise=Promise.resolve()}initialize(){this._featureStore=new K.Z({geometryType:"esriGeometryPoint",hasZ:this.hasZ,hasM:this.hasM});const{dataType:y,samplingMode:b,pixelFormat:g,internalFormat:x}=function lt(y,b){const{textureFloat:g,colorBufferFloat:x}=y.capabilities,Y=g?.textureFloat,G=g?.textureFloatLinear,k=g?.textureHalfFloat,le=g?.textureHalfFloatLinear,ge=g?.HALF_FLOAT,Oe=x?.textureFloat,Pe=x?.textureHalfFloat,Be=x?.floatBlend,we=(0,R.s3)(y.driverTest).floatBufferBlend.result;if(!Y&&!k)throw new w.Z("heatmap:missing-texture-float","HeatmapRenderer requires WebGL2 or the WebGL1 extension OES_texture_float or OES_texture_half_float.");if(!Oe&&!Pe)throw new w.Z("heatmap:missing-color-buffer-float","HeatmapRenderer requires the WebGL extension EXT_color_buffer_float or EXT_color_buffer_half_float or WEBGL_color_buffer_float.");if(!(Be&&we||Pe))throw new w.Z("heatmap:missing-float-blend","HeatmapRenderer requires the WebGL extension EXT_float_blend or EXT_color_buffer_half_float."+(we?"":" This device claims support for EXT_float_blend, but does not actually support it."));const je=k&&Pe,Ae=G,We=le,et=!!x?.R32F,tt=!!x?.R16F;if(Y&&Oe&&Be&&we&&(Ae||!We))return Ae||b.warnOnce("Missing WebGL extension OES_texture_float_linear. Heatmap quality may be reduced."),{dataType:A.Br.FLOAT,samplingMode:Ae?A.cw.LINEAR:A.cw.NEAREST,pixelFormat:et?A.VI.RED:A.VI.RGBA,internalFormat:et?A.lP.R32F:A.VI.RGBA};if(je)return We||b.warnOnce("Missing WebGL extension OES_texture_half_float_linear. Heatmap quality may be reduced."),{dataType:ge,samplingMode:We?A.cw.LINEAR:A.cw.NEAREST,pixelFormat:tt?A.VI.RED:A.VI.RGBA,internalFormat:tt?A.lP.R16F:A.VI.RGBA};throw new w.Z("heatmap:missing-hardware-support","HeatmapRenderer requires WebGL extensions that allow it to render and blend to float or half float textures.")}(this._renderView.renderingContext,He);this._dataType=y,this._pixelFormat=g;const Y=y!==A.Br.FLOAT;this._drapeSourceRenderer=this.view.basemapTerrain.overlayManager.registerDrapeSource(this,Ce,{...this._rendererParameters,dataType:y,samplingMode:b,pixelFormat:g,internalFormat:x}),this._material=new Xe({usesHalfFloats:Y}),this._materialWithField=new Xe({usesHalfFloats:Y,isAttributeDriven:!0}),this._filterVisibility=new _.n({context:{layerView:this.owner,featureStore:this.featureStore,getFeatureCount:()=>this._loadedPointGraphics.length,setAllFeaturesVisibility:G=>this._setAllFeaturesVisibility(G),clearFeaturesVisibility:()=>this._setAllFeaturesVisibility(!0),updateFeatureVisibilities:G=>this._updateFeatureVisibilities(G)}}),this.updatingHandles.addOnCollectionChange(()=>this._loadedPointGraphics,G=>this._onLoadedFeaturesChange(G),L.nn),this.updatingHandles.addWhen(()=>this._materialParameters,G=>this._forEachMaterial(k=>k.setParameters(G)),L.nn),this.updatingHandles.add(()=>this._rendererParameters,G=>this._drapeSourceRenderer.set(G)),this.updatingHandles.add(()=>this._heatmapRendererField,()=>{this._recreate()},L.Z_),this.updatingHandles.add(()=>({fieldName:this._heatmapRendererFieldName,numeric:this._heatmapRendererFieldIsNumeric}),({fieldName:G,numeric:k})=>{if((0,R.pC)(G)&&k){let le=0;this._featureStore.forEach(ge=>le+=ge.attributes[G]??0),this._fieldTotal=le}else this._fieldTotal=this._featureStore.numFeatures},L.nn),this.handles.add([(0,L.YP)(()=>({fieldName:this._heatmapRendererFieldName,field:this._heatmapRendererField}),({fieldName:G,field:k})=>{G&&!k&&He.warn(`Heatmap renderer field '${G}' for layer '${this.layer.title??this.layer.id}' not found`)}),(0,L.YP)(()=>({field:this._heatmapRendererField,numeric:this._heatmapRendererFieldIsNumeric}),({field:G,numeric:k})=>{(0,R.pC)(G)&&!k&&He.warn(`Heatmap renderer field '${G.name}' for layer '${this.layer.title??this.layer.id}' does not contain numeric values and cannot be used to drive the heatmap density`)}),(0,J.kB)(()=>this.view.basemapTerrain.overlayManager.unregisterDrapeSource(this))])}destroy(){this._renderGeometries.clear(),this._material=(0,R.M2)(this._material),this._materialWithField=(0,R.M2)(this._materialWithField),this._featureStore.clear(),this._featureStore=null}get layer(){return this.owner.layer}get featureStore(){return this._featureStore}get updating(){return this.updatingHandles.updating||this.filterVisibility.updating}get updatingRemaining(){return 0}get suspendInfo(){return{}}get legendEnabled(){return!0}get filterVisibility(){return this._filterVisibility}get displayFeatureLimit(){const b=this.owner?.view?.qualitySettings,g=b?Math.ceil(b.heatmap.maxTotalNumberOfFeatures*(this.owner?.view?.resourceController?.memoryController?.memoryFactor??1)):0;return{minimumTotalNumberOfFeatures:0,maximumTotalNumberOfFeatures:g,maximumTotalNumberOfPrimitives:2*g,maximumNumberOfFeatures:g}}get hasZ(){return"hasZ"in this.layer&&this.layer.hasZ}get hasM(){return"hasM"in this.layer&&this.layer.hasM}get view(){return this.owner.view}get fullOpacity(){return this.owner.fullOpacity}get updatePolicy(){return this.owner.updatePolicy}get scaleVisibilitySuspended(){if(!this._isScaleRangeActive)return!1;const{minScale:y,maxScale:b}=this.layer.effectiveScaleRange,{scale:g}=this.view;return!(0,$e.rs)(g,y??0,b??0)}get usedMemory(){const y=this.usedMemoryPerFeature*this._featureStore.numFeatures,b=this._pixelFormat===A.VI.RED?1:4,g=this._dataType===A.Br.FLOAT?4:2,x=Math.ceil((this._overlayRenderer?.overlays[0]?.resolution??0)*this._densityMapPixelRatio)??0;return x*x*b*g+y}get usedMemoryPerFeature(){const y=this._loadedPointGraphics.find(()=>!0);if((0,R.Wi)(y))return 0;const b=(0,W.f2)(y),g=(0,W.G3)();return 6*(0,W.do)([0,0,0],g)+6*(0,W.do)([0,0],g)+(this._heatmapRendererFieldIsNumeric?6*g:0)+b}get loadedFeatures(){return this._featureStore.numFeatures}get unprocessedMemoryEstimate(){return 0}get performanceInfo(){return{core:{visible:this._visibleFeatures,missing:0,pending:0},elevationUpdating:!1,visibilityFrustum:!0,visibilityScale:!0}}get renderer(){return this._heatmapRenderer}get _overlayRenderer(){return this.view.basemapTerrain.overlayManager.renderer}get _overlaySpatialReference(){return(0,R.Wg)(this._overlayRenderer.spatialReference)}get _rendererParameters(){return{...this._radiusParameter,...this._densityParameters,...this._colorRampParameter,...this._pixelRatioParameter}}get _materialParameters(){return{...this._radiusParameter,...this._resolutionForScaleParameter}}get _densityParameters(){const y=this._heatmapRenderer;if((0,R.Wi)(y))return null;const{minDensity:b,maxDensity:g}=y;return{minDensity:b,maxDensity:g,fieldTotal:this._fieldTotal}}get _radiusParameter(){return(0,R.yw)(this._heatmapRenderer,({radius:y})=>({searchRadius:(0,F.F2)(this._clampSearchRadius(y))}))}get _resolutionForScaleParameter(){return(0,R.yw)(this._heatmapRenderer,({referenceScale:y})=>({resolutionForScale:0===y?0:(0,ne.dp)(y,this.view.spatialReference)}))}get _colorRampParameter(){return(0,R.yw)(this._heatmapRenderer,y=>({colorRampData:(0,xe.uI)(y.colorStops)}))}get _pixelRatioParameter(){return{pixelRatio:this._densityMapPixelRatio}}get _densityMapPixelRatio(){return(this.owner?.view?.qualitySettings.heatmap.pixelRatio??1)*Math.sqrt(this.owner?.view?.resourceController?.memoryController?.memoryFactor??1)}get _renderView(){return this.view._stage.renderView}get _featuresArePoints(){return"point"===this.layer.geometryType}get _loadedPointGraphics(){return this.owner.loadedGraphics}get _heatmapRenderer(){const y=this.layer.renderer;return"heatmap"===y?.type?y:null}get _heatmapRendererFieldName(){return(0,R.yw)(this._heatmapRenderer,y=>y.field)}get _heatmapRendererField(){return(0,R.yw)(this._heatmapRendererFieldName,y=>this.layer.fieldsIndex.get(y))}get _heatmapRendererFieldIsNumeric(){const y=this._heatmapRendererField;return!(0,R.Wi)(y)&&(0,be.H7)(y)}get _isScaleRangeActive(){const{layer:y}=this;if(!("effectiveScaleRange"in y))return!1;const{minScale:b,maxScale:g}=y.effectiveScaleRange;return(0,$e.Av)(b,g)}get _visibleFeatures(){let y=0;return this._renderGeometries.forEach(b=>{b.visible&&++y}),y}whenGraphicBounds(){return(0,T.Z)(function*(){return null})()}computeAttachmentOrigin(){return null}highlight(){return qe}maskOccludee(){return qe}setObjectIdVisibility(){}refreshFilter(){this.filterVisibility.reapply()}_onLoadedFeaturesChange(y){if(!this._featuresArePoints)return;const{objectIdField:b}=this.layer;this._featureStore.removeManyById(y.removed.map(k=>(0,ue.MS)(k,b))),this._featureStore.addMany(y.added.map(k=>{const le=new he.u_((0,de.dd)(new Ee.Z,k.geometry),k.attributes,(0,R.yw)(k.centroid,ge=>(0,de.dd)(new Ee.Z,ge)),(0,ue.MS)(k,b));return le.displayId=k.uid,le}));const g=y.added,x=y.removed;this._fieldTotal+=this._computeFieldTotalChange(g,x);const Y=(0,R.e8)(x,({uid:k})=>{const le=this._renderGeometries.get(k);return this._renderGeometries.delete(k),le}),G=g.map(k=>{const le=this._pointGraphicToRenderGeometry(k);return this._renderGeometries.set(k.uid,le),le});Y.length>0&&this._drapeSourceRenderer.removeGeometries(Y,Ue.T.REMOVE),G.length>0&&this._drapeSourceRenderer.addGeometries(G,Ue.T.ADD),(G.length>0||Y.length>0)&&(this.filterVisibility.reapply(),this._renderView.requestRender())}_recreate(){if(!this._loadedPointGraphics)return;const y=this._loadedPointGraphics.toArray();this._onLoadedFeaturesChange({added:y,removed:y})}_pointGraphicToRenderGeometry(y){const b=this._heatmapRendererFieldName,g=(0,R.pC)(b)?this._materialWithField:this._material,x=(0,N.c)();(0,$.KC)(y.geometry,x,this._overlaySpatialReference),x[2]=U.Rn;const Y=[[o.T.POSITION,new oe.a(x,x.length)]],G=this._heatmapRendererFieldIsNumeric;(0,R.pC)(b)&&Y.push([o.T.FEATUREATTRIBUTE,new oe.a([G?y.attributes[b]??0:0],1)]);const k=new s.z(new Ze.Z(g,Y,null,null,Q.U.Point),{layerUid:this.layer.uid,graphicUid:y.uid});return(0,D.c)(k.boundingSphere,x),k.visible=this.filterVisibility.defaultVisibility,k}_forEachMaterial(y){y(this._material),y(this._materialWithField)}_computeFieldTotalChange(y,b){if((0,R.Wi)(this._heatmapRendererFieldName)||!this._heatmapRendererFieldIsNumeric)return y.length-b.length;const g=this._heatmapRendererFieldName,x=(Y,G)=>Y+(G.attributes[g]??0);return y.reduce(x,0)-b.reduce(x,0)}_clampSearchRadius(y){return y>112&&He.warnOnce("SceneView supports a maximum radius of 112 pt for HeatmapRenderer."),Math.min(y,112)}_updateFeatureVisibilities(y){const b=[];this._featureStore.forEach(({objectId:g,displayId:x})=>{const Y=y(g),G=this._renderGeometries.get(x);G&&G.visible!==Y&&(b.push(G),G.visible=Y)}),this._drapeSourceRenderer.modifyGeometries(b,Ue.$.VISIBILITY)}_setAllFeaturesVisibility(y){const b=[];for(const g of this._renderGeometries.values())g.visible!==y&&(b.push(g),g.visible=y);this._drapeSourceRenderer.modifyGeometries(b,Ue.$.VISIBILITY)}get test(){return{visibleFeatureCount:this._visibleFeatures}}};(0,a._)([(0,l.Cb)()],Z.prototype,"type",void 0),(0,a._)([(0,l.Cb)({constructOnly:!0})],Z.prototype,"owner",void 0),(0,a._)([(0,l.Cb)()],Z.prototype,"layer",null),(0,a._)([(0,l.Cb)()],Z.prototype,"featureStore",null),(0,a._)([(0,l.Cb)()],Z.prototype,"updating",null),(0,a._)([(0,l.Cb)()],Z.prototype,"updatingRemaining",null),(0,a._)([(0,l.Cb)()],Z.prototype,"suspendInfo",null),(0,a._)([(0,l.Cb)()],Z.prototype,"legendEnabled",null),(0,a._)([(0,l.Cb)()],Z.prototype,"filterVisibility",null),(0,a._)([(0,l.Cb)()],Z.prototype,"displayFeatureLimit",null),(0,a._)([(0,l.Cb)()],Z.prototype,"preferredUpdatePolicy",void 0),(0,a._)([(0,l.Cb)()],Z.prototype,"hasZ",null),(0,a._)([(0,l.Cb)()],Z.prototype,"hasM",null),(0,a._)([(0,l.Cb)()],Z.prototype,"dataExtent",void 0),(0,a._)([(0,l.Cb)()],Z.prototype,"view",null),(0,a._)([(0,l.Cb)()],Z.prototype,"fullOpacity",null),(0,a._)([(0,l.Cb)()],Z.prototype,"updatePolicy",null),(0,a._)([(0,l.Cb)()],Z.prototype,"drapeSourceType",void 0),(0,a._)([(0,l.Cb)()],Z.prototype,"scaleVisibilitySuspended",null),(0,a._)([(0,l.Cb)()],Z.prototype,"renderer",null),(0,a._)([(0,l.Cb)()],Z.prototype,"_featureStore",void 0),(0,a._)([(0,l.Cb)()],Z.prototype,"_filterVisibility",void 0),(0,a._)([(0,l.Cb)()],Z.prototype,"_overlayRenderer",null),(0,a._)([(0,l.Cb)()],Z.prototype,"_overlaySpatialReference",null),(0,a._)([(0,l.Cb)()],Z.prototype,"_rendererParameters",null),(0,a._)([(0,l.Cb)()],Z.prototype,"_materialParameters",null),(0,a._)([(0,l.Cb)()],Z.prototype,"_densityParameters",null),(0,a._)([(0,l.Cb)()],Z.prototype,"_radiusParameter",null),(0,a._)([(0,l.Cb)()],Z.prototype,"_resolutionForScaleParameter",null),(0,a._)([(0,l.Cb)()],Z.prototype,"_colorRampParameter",null),(0,a._)([(0,l.Cb)()],Z.prototype,"_pixelRatioParameter",null),(0,a._)([(0,l.Cb)()],Z.prototype,"_densityMapPixelRatio",null),(0,a._)([(0,l.Cb)()],Z.prototype,"_renderGeometries",void 0),(0,a._)([(0,l.Cb)()],Z.prototype,"_material",void 0),(0,a._)([(0,l.Cb)()],Z.prototype,"_materialWithField",void 0),(0,a._)([(0,l.Cb)()],Z.prototype,"_renderView",null),(0,a._)([(0,l.Cb)()],Z.prototype,"_featuresArePoints",null),(0,a._)([(0,l.Cb)()],Z.prototype,"_loadedPointGraphics",null),(0,a._)([(0,l.Cb)()],Z.prototype,"_heatmapRenderer",null),(0,a._)([(0,l.Cb)()],Z.prototype,"_heatmapRendererFieldName",null),(0,a._)([(0,l.Cb)()],Z.prototype,"_heatmapRendererField",null),(0,a._)([(0,l.Cb)()],Z.prototype,"_heatmapRendererFieldIsNumeric",null),(0,a._)([(0,l.Cb)()],Z.prototype,"_fieldTotal",void 0),(0,a._)([(0,l.Cb)()],Z.prototype,"_drapeSourceRenderer",void 0),(0,a._)([(0,l.Cb)()],Z.prototype,"_isScaleRangeActive",null),Z=(0,a._)([(0,f.j)(ke)],Z);const qe=(0,J.kB)();var ut=i(89765),ht=i(87091);const dt=y=>{let b=class extends y{constructor(){super(...arguments),this.controller=null,this.updatePolicy=r.j.SYNC,this.suspendResumeExtentMode="computed",this.slicePlaneEnabled=!1,this.fullExtentInLocalViewSpatialReference=null,this.suspendResumeExtent=null,this._controllerCreated=!1,this.supportsHeightUnitConversion=!0,this._pendingController=null,this.queryEngine=null}initialize(){var g=this;const x=this.layer;if("isTable"in x&&x.isTable)return void this.addResolvingPromise(Promise.reject(new w.Z("featurelayerview:table-not-supported","table feature layer can't be displayed",{layer:x})));this.addResolvingPromise(this._validateGeometryType()),this.updatingHandles.add(()=>this.layer.renderer,G=>this._recreateProcessor(G),L.nn),this.addResolvingPromise((0,T.Z)(function*(){const G=yield(0,ut.E)(g);g.fullExtentInLocalViewSpatialReference=G,yield g._initializeController()})()),this.updatingHandles.add(()=>this.updatePolicy,G=>this.processor.preferredUpdatePolicy=G);const Y=()=>this.processor.featureStore;this.queryEngine=new M.q({context:{spatialReference:this.view.spatialReference,layer:this.layer,scheduler:this.view.resourceController.scheduler,get featureStore(){return Y()},hasZ:this.hasZ,hasM:this.hasM},priority:ht.T8.FEATURE_QUERY_ENGINE}),this.notifyChange("updating")}destroy(){this._destroyPendingController(),this.controller=(0,R.SC)(this.controller),this._set("processor",(0,R.SC)(this.processor)),this.queryEngine=(0,R.SC)(this.queryEngine),this.loadedGraphics=null}_destroyPendingController(){this._pendingController=(0,R.SC)(this._pendingController)}get legendEnabled(){return this.canResume()&&this.processor?.legendEnabled}get graphics3DProcessor(){return"graphics-3d"===this.processor?.type?this.processor:null}get heatmapProcessor(){return"heatmap"===this.processor?.type?this.processor:null}get symbologySnappingSupported(){return this.layer?.renderer?.getSymbols()?.some(V.QL)??!1}getHit(g){let x;return this.loadedGraphics?.forEach(Y=>{Y.uid===g&&(x=(0,u.mW)(Y,this.layer))}),x?{type:"graphic",graphic:x,layer:x.layer}:null}whenGraphicBounds(g,x){return this.processor?.whenGraphicBounds(g,x)}computeAttachmentOrigin(g,x){return this.processor?.computeAttachmentOrigin(g,x)}elevationAlignPointsInFeatures(g,x){var Y=this;return(0,T.Z)(function*(){const G=Y.graphics3DProcessor;if((0,R.Wi)(G))throw new w.Z("featurelayerview3d:missing-processor","A Graphics3D processor is needed to resolve graphics elevation.");return(0,m.W)(Y.view,Y.layer,k=>G.getGraphics3DGraphicByObjectId(k),g,x)})()}queryForSymbologySnapping(g,x){var Y=this;return(0,T.Z)(function*(){return Y.symbologySnappingSupported?(0,O.c)(Y.graphics3DProcessor,g,x):{candidates:[],sourceCandidateIndices:[]}})()}queryFeatures(g,x){return this.queryEngine.executeQuery(this._ensureQuery(g),(0,R.U2)(x,"signal"))}queryObjectIds(g,x){return this.queryEngine.executeQueryForIds(this._ensureQuery(g),(0,R.U2)(x,"signal"))}queryFeatureCount(g,x){return this.queryEngine.executeQueryForCount(this._ensureQuery(g),(0,R.U2)(x,"signal"))}queryExtent(g,x){return this.queryEngine.executeQueryForExtent(this._ensureQuery(g),(0,R.U2)(x,"signal"))}_ensureQuery(g){return(0,R.Wi)(g)?this.createQuery():C.Z.from(g)}highlight(g){return this.processor.highlight(g,this.layer.objectIdField)}maskOccludee(g){return this.processor.maskOccludee(g)}canResume(){return super.canResume()&&!this.processor?.scaleVisibilitySuspended}getSuspendInfo(){const g=super.getSuspendInfo();return this.processor?{...g,...this.processor.suspendInfo}:g}isUpdating(){return!(!this.processor||this.processor.destroyed||this._controllerCreated&&!this.controller?.updating&&this.view?.basemapTerrain?.ready&&!this.processor.updating)}_initializeController(){var g=this;return(0,T.Z)(function*(){const x=g.createController();g._pendingController=x,yield x.when(),g._setControllerWhenInitialized(x)})()}_setControllerWhenInitialized(g){var x=this;return(0,T.Z)(function*(){try{yield x.when()}catch{}x._controllerCreated=!0,x.notifyChange("updating"),x.isResolved()&&!x.destroyed?(yield(0,L.N1)(()=>x.view?.basemapTerrain?.ready),x.beforeSetController(g),x._pendingController=null,x.controller=g,x.loadedGraphics=g.graphics,x.notifyChange("updating")):x._destroyPendingController()})()}_updateClippingExtent(g){if(this.clippingExtent=g,!this.controller)return!1;switch(this.controller.type){case"stream":return!1;case"feature-tile-3d":return this.controller.extent=g,!0}}_validateGeometryType(){var g=this;return(0,T.Z)(function*(){switch(g.layer.geometryType){case"multipatch":case"multipoint":throw new w.Z("featurelayerview3d:unsupported-geometry-type","Unsupported geometry type ${geometryType}",{geometryType:g.layer.geometryType})}})()}_recreateProcessor(g){const x="heatmap"===g?.type,G=this.processor;if(G&&x===("heatmap"===this.processor?.type))return;const k=x?new Z({owner:this}):new h.Z({owner:this,frustumVisibilityEnabled:!0,scaleVisibilityEnabled:!0,filterVisibilityEnabled:!0,timeExtentEnabled:!0,elevationAlignmentEnabled:!0,elevationFeatureExpressionEnabled:!0,preferredUpdatePolicy:this.updatePolicy,updateClippingExtent:le=>this._updateClippingExtent(le)});this._set("processor",k),G?.destroy(),this.queryEngine?.clear(),this.addResolvingPromise(k.initializePromise)}_getResourceInfo(){const g=this.controller instanceof p.g?this.controller:null;return{displayedNumberOfFeatures:this.loadedGraphics.length,maximumNumberOfFeatures:g?.maximumNumberOfFeatures??-1,totalNumberOfFeatures:g?.serviceDataCount??-1,nodes:0,...this.processor.performanceInfo}}get performanceInfo(){return this._getResourceInfo()}};return(0,a._)([(0,l.Cb)()],b.prototype,"loadedGraphics",void 0),(0,a._)([(0,l.Cb)()],b.prototype,"suspended",void 0),(0,a._)([(0,l.Cb)({readOnly:!0})],b.prototype,"legendEnabled",null),(0,a._)([(0,l.Cb)()],b.prototype,"updating",void 0),(0,a._)([(0,l.Cb)()],b.prototype,"controller",void 0),(0,a._)([(0,l.Cb)()],b.prototype,"processor",void 0),(0,a._)([(0,l.Cb)({readOnly:!0})],b.prototype,"updatePolicy",void 0),(0,a._)([(0,l.Cb)({readOnly:!0})],b.prototype,"suspendResumeExtentMode",void 0),(0,a._)([(0,l.Cb)({type:Boolean})],b.prototype,"slicePlaneEnabled",void 0),(0,a._)([(0,l.Cb)({readOnly:!0})],b.prototype,"suspendInfo",void 0),(0,a._)([(0,l.Cb)()],b.prototype,"graphics3DProcessor",null),(0,a._)([(0,l.Cb)()],b.prototype,"heatmapProcessor",null),(0,a._)([(0,l.Cb)()],b.prototype,"symbologySnappingSupported",null),b=(0,a._)([(0,f.j)("esri.views.3d.layers.FeatureLikeLayerView3D")],b),b}},19702:(fe,se,i)=>{i.d(se,{A:()=>p});var T=i(15861),a=i(17626),w=i(54024),R=i(10699),L=i(32917),l=i(77712),f=(i(90912),i(85931),i(76898)),u=i(36947);const p=C=>{let V=class extends C{constructor(){super(...arguments),this.slicePlaneEnabled=!1,this.supportsHeightUnitConversion=!1}postscript(m){super.postscript(m),(0,u.qC)(this.layer)&&this.addResolvingPromise(this._validateHeightModelInfo())}_validateHeightModelInfo(){var m=this;return(0,T.Z)(function*(){const h=new AbortController,M=h.signal;m.handles.add((0,w.kB)(()=>h.abort())),yield(0,L.N1)(()=>m.view.defaultsFromMap?.heightModelInfoReady,M),(0,R.k_)(M);const O=(0,u.Wt)(m.layer,m.view.heightModelInfo,m.supportsHeightUnitConversion);if(O)throw O})()}canResume(){const m=this.layer&&"effectiveScaleRange"in this.layer?this.layer.effectiveScaleRange:null;return super.canResume()&&(!m||!m.minScale||!m.maxScale||m.minScale>=m.maxScale)}getSuspendInfo(){const m=super.getSuspendInfo(),h=this.layer&&"effectiveScaleRange"in this.layer?this.layer.effectiveScaleRange:null;return h&&h.minScale&&h.maxScale&&h.minScale<h.maxScale&&(m.outsideScaleRange=!0),m}};return(0,a._)([(0,l.Cb)()],V.prototype,"view",void 0),(0,a._)([(0,l.Cb)()],V.prototype,"slicePlaneEnabled",void 0),V=(0,a._)([(0,f.j)("esri.views.3d.layers.LayerView3D")],V),V}},33816:(fe,se,i)=>{i.d(se,{Z:()=>be});var T=i(15861),a=i(17626),w=i(88879),R=i(46668),L=i(94573),l=i(80542),E=i(62208),H=i(10699),f=i(32917),u=i(77712),V=(i(90912),i(85931),i(76898)),m=i(84682),h=i(46367),M=i(32028),O=i(39256),W=i(96854),I=i(62600),J=i(80960),z=i(1191),F=i(94991),D=i(83518),N=i(14752),$=i(67873),ne=i(67225),ue=i(97445),de=i(98667),he=i(42743),Ee=i(23147);let K=class extends l.r{constructor(_){super(_),this.type="graphics-3d",this._randomRotationRenderers=null,this.elevationFeatureExpressionEnabled=!1,this.scaleVisibilityEnabled=!1,this.filterVisibilityEnabled=!1,this.frustumVisibilityEnabled=!1,this.elevationAlignmentEnabled=!1,this.timeExtentEnabled=!1,this.setUidToIdOnAdd=!0,this.dataExtent=null,this.drapeSourceType=I.Lw.Features,this.preferredUpdatePolicy=Ee.j.ASYNC,this._suspendResumeExtent=null}initialize(){const _=this.owner,oe=new z.w({owner:this,layer:this.layer,preferredUpdatePolicy:this.preferredUpdatePolicy,elevationFeatureExpressionEnabled:this.elevationFeatureExpressionEnabled,graphicSymbolSupported:!1,hasZ:_.hasZ,hasM:_.hasM,setUidToIdOnAdd:this.setUidToIdOnAdd,componentFactories:{deconflictor:Q=>_.view.deconflictor.addGraphicsOwner(Q),labeler:(Q,q)=>_.view.labeler.addGraphicsOwner(Q,q),elevationAlignment:this.elevationAlignmentEnabled?(Q,q)=>new F.Z({graphicsCoreOwner:this,graphicsCore:Q,queryGraphicUIDsInExtent:q,elevationProvider:_.view.elevationProvider}):null,scaleVisibility:this.scaleVisibilityEnabled?(Q,q)=>new $.Z({graphicsCoreOwner:this,layer:this.layer,queryGraphicUIDsInExtent:q,graphicsCore:Q,basemapTerrain:_.view.basemapTerrain}):null,filterVisibility:(this.filterVisibilityEnabled||this.timeExtentEnabled)&&"multipatch"!==_.layer.geometryType?Q=>new de.n({context:{layerView:_,...Q}}):null,objectStates:Q=>new N.d(Q)}});this._set("graphicsCore",oe),this.frustumVisibilityEnabled&&this._set("frustumVisibility",new D.Z({graphicsCoreOwner:this})),this.elevationAlignment&&this.updatingHandles.add(()=>this.layer.elevationInfo,(Q,q)=>{(0,m.Hg)(Q,q)&&this.updatingHandles.addPromise(this.graphicsCore.elevationInfoChange())}),this.updatingHandles.add(()=>this.layer.labelsVisible,()=>this.graphicsCore.updateVisibilityInfo()),this.updatingHandles.add(()=>this.layer.labelingInfo,(Q,q)=>{(0,m.Hg)(Q,q)&&this.graphicsCore.updateLabelingInfo()}),this.updatingHandles.add(()=>this.preferredUpdatePolicy,Q=>this.graphicsCore.preferredUpdatePolicy=Q),this._set("initializePromise",this._initializeAsync()),this.updatingHandles.addPromise(this.initializePromise)}_initializeAsync(){var _=this;return(0,T.Z)(function*(){yield(0,H.U3)(_.graphicsCore.initializePromise);const U=_.owner;_.updatingHandles.add(()=>_.renderer,oe=>_.updatingHandles.addPromise(_.graphicsCore.rendererChange(oe))),_.updatingHandles.add(()=>U.fullOpacity,()=>_.graphicsCore.opacityChange()),_._setupSuspendResumeExtent(),_.updateClippingExtent&&(_.updatingHandles.add(()=>U.view.clippingArea,()=>_._updateClippingExtent()),_._updateClippingExtent()),_.graphicsCore.startCreateGraphics(),_.graphicsCore.labelsEnabled&&(yield(0,H.U3)(_.graphicsCore.updateLabelingInfo()))})()}destroy(){this.handles.removeAll(),this.updatingHandles.removeAll(),this._set("frustumVisibility",(0,E.SC)(this.frustumVisibility)),this._set("graphicsCore",(0,E.SC)(this.graphicsCore)),this._set("owner",null)}get layer(){return this.owner.layer}get renderer(){const{renderer:_,objectIdField:U}=this.layer;if(!_||!U||"heatmap"===_.type||!_.visualVariables)return _;const oe=_.visualVariables.findIndex(q=>"rotation"===q.type&&null!=q.valueExpression&&(0,M.v)(q.valueExpression)===U&&(null==q.axis||"heading"===q.axis)&&"geographic"===q.rotationType);if(oe<0)return _;const Q=_.clone();return Q.visualVariables.splice(oe,1),this._randomRotationRenderers||(this._randomRotationRenderers=new WeakMap),this._randomRotationRenderers.set(Q,U),Q}get scaleVisibility(){return this.graphicsCore?.scaleVisibility}get filterVisibility(){return this.graphicsCore?.filterVisibility}get elevationAlignment(){return this.graphicsCore?.elevationAlignment}get objectStates(){return this.graphicsCore?.objectStates}get suspendResumeExtentMode(){return"suspendResumeExtentMode"in this.owner?this.owner.suspendResumeExtentMode:"computed"}get scaleVisibilitySuspended(){return(0,E.pC)(this.scaleVisibility)&&this.scaleVisibility.suspended}get suspended(){return this.owner.suspended}get legendEnabled(){return(0,E.Wi)(this.frustumVisibility)||!this.frustumVisibility.suspended}get suspendInfo(){const _={};return this.scaleVisibilitySuspended&&(_.outsideScaleRange=!0),(0,E.pC)(this.frustumVisibility)&&this.frustumVisibility.suspended&&(_.outsideOfView=!0),_}get updating(){return!!(this.graphicsCore?.updating||(0,E.pC)(this.frustumVisibility)&&this.frustumVisibility.updating||this.updatingHandles?.updating)}get updatingRemaining(){return this.graphicsCore?.updatingRemaining??0}get featureStore(){return this.graphicsCore?.featureStore}get view(){return this.owner.view}get loadedGraphics(){return this.owner.loadedGraphics}get fullOpacity(){return this.owner?.fullOpacity}get filter(){return"filter"in this.owner?this.owner.filter:null}get slicePlaneEnabled(){return this.owner.slicePlaneEnabled}get updatePolicy(){return this.owner.updatePolicy}get featureSpatialReference(){return"featureSpatialReference"in this.owner?this.owner.featureSpatialReference:this.owner.view.spatialReference}get graphics3DGraphics(){return this.graphicsCore?.graphics3DGraphics}get graphics3DGraphicsByObjectID(){return this.graphicsCore?.graphics3DGraphicsByObjectID}get symbolUpdateType(){return this.graphicsCore?.symbolUpdateType}get displayFeatureLimit(){const _=this.view.resourceController.memoryController.memoryFactor,U=this.graphicsCore?.displayFeatureLimit;if(1===_)return U;const oe=Math.ceil(U.maximumNumberOfFeatures*_),Q=Math.ceil(U.maximumTotalNumberOfFeatures*_),q=Math.ceil(U.minimumTotalNumberOfFeatures*_);return{...U,maximumNumberOfFeatures:oe,maximumTotalNumberOfFeatures:Q,minimumTotalNumberOfFeatures:q}}get usedMemory(){return this.graphicsCore?.usedMemory??0}get loadedFeatures(){return this.graphicsCore?.numberOfGraphics??0}get usedMemoryPerFeature(){return this.graphicsCore?.usedMemoryPerGraphic??0}get unprocessedMemoryEstimate(){return this.graphicsCore?.unprocessedMemoryEstimate??0}get performanceInfo(){return{core:this.graphicsCore.performanceInfo,elevationUpdating:this.elevationAlignment.updating,visibilityFrustum:(0,E.Wi)(this.frustumVisibility)||!this.frustumVisibility.suspended,visibilityScale:!this.scaleVisibilitySuspended}}maskOccludee(_){const{set:U,handle:oe}=this.objectStates.acquireSet(he.V_.MaskOccludee,null);return this.objectStates.setUid(U,_.uid),oe}highlight(_,U){if(_ instanceof W.Z){const{set:oe,handle:Q}=this.objectStates.acquireSet(he.V_.Highlight,U);return this.owner.queryObjectIds(_).then(q=>this.objectStates.setObjectIds(oe,q)),Q}if("number"==typeof _||"string"==typeof _)return this.highlight([_],U);if(_ instanceof w.Z)return this.highlight([_],U);if("toArray"in _&&(_=_.toArray()),Array.isArray(_)&&_.length>0){if(_[0]instanceof w.Z){const oe=_;if(null==(0,ue.g)(this.layer.fieldsIndex,oe[0].attributes,U)){const Q=oe.map(v=>v.uid),{set:q,handle:_e}=this.objectStates.acquireSet(he.V_.Highlight,null);return this.objectStates.setUids(q,Q),_e}_=oe.map(Q=>(0,ue.g)(this.layer.fieldsIndex,Q.attributes,U))}if("number"==typeof _[0]||"string"==typeof _[0]){const oe=_,{set:Q,handle:q}=this.objectStates.acquireSet(he.V_.Highlight,U);return this.objectStates.setObjectIds(Q,oe),q}}return ie}resetObjectStates(){this.objectStates.reset()}whenGraphicBounds(_,U){return this.graphicsCore?.whenGraphicBounds(_,U)}computeAttachmentOrigin(_,U){return this.graphicsCore?.computeAttachmentOrigin(_,U)}notifyGraphicGeometryChanged(_){this.graphicsCore.notifyGraphicGeometryChanged(_)}notifyGraphicVisibilityChanged(_){this.graphicsCore.notifyGraphicVisibilityChanged(_)}getRenderingInfo(_,U,oe){const Q=(0,O.Kb)(_,{renderer:U,arcade:oe});if((0,E.pC)(Q)&&Q.color){const q=Q.color;q[0]=q[0]/255,q[1]=q[1]/255,q[2]=q[2]/255}if((0,E.pC)(Q)&&(0,E.pC)(U)&&this._randomRotationRenderers?.has(U)){const q=this._randomRotationRenderers.get(U),_e=_.attributes[q],v=new R.a(0);v.updateFloatArray([_e]),v.updateUint8Array([173]),Q.heading=8.381e-8*v.digest()}return Q}getRenderingInfoAsync(_,U,oe,Q){return(0,O.xn)(_,{renderer:U,arcade:oe,...Q})}getSymbolLayerSize(_,U){return this.graphicsCore?.getSymbolLayerSize(_,U)}setObjectIdVisibility(_,U){this.graphicsCore?.setObjectIdVisibility(_,U)}refreshFilter(){(0,E.pC)(this.filterVisibility)&&this.filterVisibility.reapply()}getGraphics3DGraphicByObjectId(_){return this.graphicsCore?.getGraphics3DGraphicByObjectId(_)}_updateClippingExtent(){const _=this.owner.view.clippingArea;this.graphicsCore.setClippingExtent(_,this.owner.view.spatialReference)&&(this.updateClippingExtent(_)||this.graphicsCore.recreateAllGraphics())}_setupSuspendResumeExtent(){(this.frustumVisibility||this.scaleVisibility)&&this.handles.add((0,f.YP)(()=>this.suspendResumeExtentMode,()=>{switch(this.handles.remove(xe),this.suspendResumeExtentMode){case"computed":this.handles.add([(0,f.YP)(()=>this.graphicsCore.computedExtent,_=>this._updateSuspendResumeExtent(_),f.nn),(0,f.YP)(()=>this.graphicsCore.extentPadding,()=>this._updateSuspendResumeExtent(this.graphicsCore.computedExtent))],xe);break;case"data":this.handles.add([(0,f.gx)(()=>this.dataExtent,_=>this._updateSuspendResumeExtent(_),f.nn),(0,f.YP)(()=>this.graphicsCore.extentPadding,()=>this._updateSuspendResumeExtent((0,E.Wg)(this.dataExtent)))],xe);break;default:(0,L.Bg)(this.suspendResumeExtentMode)}},f.nn))}_updateSuspendResumeExtent(_){this._suspendResumeExtentChanged(_?this._extentToSuspendResumeRect(_,this._suspendResumeExtent):null)}_extentToSuspendResumeRect(_,U){const oe=this.owner.view.spatialReference;if(!_.spatialReference.equals(oe)){if(!(0,h.Q8)(_,oe))return;_=(0,h.iV)(_,oe)}return(0,ne.Go)(_,U,J.Z,this.graphicsCore.extentPadding)}_suspendResumeExtentChanged(_){(0,E.pC)(this.frustumVisibility)&&this.frustumVisibility.setExtent(_),(0,E.pC)(this.scaleVisibility)&&this.scaleVisibility.setExtent(_)}};(0,a._)([(0,u.Cb)()],K.prototype,"type",void 0),(0,a._)([(0,u.Cb)({constructOnly:!0})],K.prototype,"owner",void 0),(0,a._)([(0,u.Cb)()],K.prototype,"layer",null),(0,a._)([(0,u.Cb)()],K.prototype,"renderer",null),(0,a._)([(0,u.Cb)({constructOnly:!0})],K.prototype,"updateClippingExtent",void 0),(0,a._)([(0,u.Cb)({constructOnly:!0})],K.prototype,"elevationFeatureExpressionEnabled",void 0),(0,a._)([(0,u.Cb)({constructOnly:!0})],K.prototype,"graphicsCore",void 0),(0,a._)([(0,u.Cb)({constructOnly:!0})],K.prototype,"scaleVisibilityEnabled",void 0),(0,a._)([(0,u.Cb)({constructOnly:!0})],K.prototype,"filterVisibilityEnabled",void 0),(0,a._)([(0,u.Cb)({constructOnly:!0})],K.prototype,"frustumVisibilityEnabled",void 0),(0,a._)([(0,u.Cb)({constructOnly:!0})],K.prototype,"elevationAlignmentEnabled",void 0),(0,a._)([(0,u.Cb)({constructOnly:!0})],K.prototype,"timeExtentEnabled",void 0),(0,a._)([(0,u.Cb)({constructOnly:!0})],K.prototype,"setUidToIdOnAdd",void 0),(0,a._)([(0,u.Cb)()],K.prototype,"scaleVisibility",null),(0,a._)([(0,u.Cb)()],K.prototype,"filterVisibility",null),(0,a._)([(0,u.Cb)()],K.prototype,"elevationAlignment",null),(0,a._)([(0,u.Cb)({constructOnly:!0})],K.prototype,"frustumVisibility",void 0),(0,a._)([(0,u.Cb)()],K.prototype,"objectStates",null),(0,a._)([(0,u.Cb)()],K.prototype,"initializePromise",void 0),(0,a._)([(0,u.Cb)()],K.prototype,"suspendResumeExtentMode",null),(0,a._)([(0,u.Cb)()],K.prototype,"dataExtent",void 0),(0,a._)([(0,u.Cb)()],K.prototype,"scaleVisibilitySuspended",null),(0,a._)([(0,u.Cb)()],K.prototype,"suspended",null),(0,a._)([(0,u.Cb)()],K.prototype,"legendEnabled",null),(0,a._)([(0,u.Cb)()],K.prototype,"suspendInfo",null),(0,a._)([(0,u.Cb)()],K.prototype,"updating",null),(0,a._)([(0,u.Cb)()],K.prototype,"updatingRemaining",null),(0,a._)([(0,u.Cb)()],K.prototype,"featureStore",null),(0,a._)([(0,u.Cb)()],K.prototype,"view",null),(0,a._)([(0,u.Cb)()],K.prototype,"loadedGraphics",null),(0,a._)([(0,u.Cb)()],K.prototype,"fullOpacity",null),(0,a._)([(0,u.Cb)()],K.prototype,"filter",null),(0,a._)([(0,u.Cb)()],K.prototype,"slicePlaneEnabled",null),(0,a._)([(0,u.Cb)()],K.prototype,"drapeSourceType",void 0),(0,a._)([(0,u.Cb)()],K.prototype,"updatePolicy",null),(0,a._)([(0,u.Cb)()],K.prototype,"preferredUpdatePolicy",void 0),(0,a._)([(0,u.Cb)()],K.prototype,"displayFeatureLimit",null),K=(0,a._)([(0,V.j)("esri.views.3d.layers.graphics.Graphics3DFeatureProcessor")],K);const be=K,xe="suspendResumeExtentMode",ie={remove(){},pause(){},resume(){}}},34675:(fe,se,i)=>{i.d(se,{q:()=>M});var T=i(15861),a=i(17626),R=(i(29132),i(14517)),L=i(62208),l=i(77712),f=(i(90912),i(85931),i(76898)),u=i(2004),p=i(58175),C=i(17253),V=i(96854),m=i(71774);const h=p.q;let M=class extends R.Z{get layer(){return this.context.layer}get spatialReference(){return this.context.spatialReference}get _queryGeometryType(){switch(this.layer.geometryType){case"multipoint":case"point":case"polygon":case"polyline":return this.layer.geometryType;case"mesh":return"polygon";default:return}}get defaultQueryJSON(){return new V.Z({outSpatialReference:this.spatialReference}).toJSON()}get _dataQueryEngine(){return this._ensureDataQueryEngine()}constructor(O){super(O),this._dataQueryEngineInstance=null}destroy(){this.clear()}clear(){return!!this._dataQueryEngineInstance&&(this._dataQueryEngineInstance.destroy(),this._dataQueryEngineInstance=null,!0)}executeQueryForIdSet(O,W,I){var J=this;return(0,T.Z)(function*(){return J._dataQueryEngine.executeQueryForIdSet(J._ensureQueryJSON(O,W),I)})()}executeQueryForCount(O,W){var I=this;return(0,T.Z)(function*(){return I._dataQueryEngine.executeQueryForCount(I._ensureQueryJSON(O),W)})()}executeQueryForExtent(O,W){var I=this;return(0,T.Z)(function*(){const{count:J,extent:z}=yield I._dataQueryEngine.executeQueryForExtent(I._ensureQueryJSON(O),W);return{count:J,extent:u.Z.fromJSON(z)}})()}executeQueryForIds(O,W){var I=this;return(0,T.Z)(function*(){return I._dataQueryEngine.executeQueryForIds(I._ensureQueryJSON(O),W)})()}executeQueryForLatestObservations(O,W){var I=this;return(0,T.Z)(function*(){const J=yield I._dataQueryEngine.executeQueryForLatestObservations(I._ensureQueryJSON(O),W),z=C.Z.fromJSON(J);return z.features.forEach(F=>{F.layer=I.layer,F.sourceLayer=I.layer}),z})()}executeQuery(O,W){var I=this;return(0,T.Z)(function*(){const J=yield I._dataQueryEngine.executeQuery(I._ensureQueryJSON(O),W),z=C.Z.fromJSON(J);return z.features.forEach(F=>{F.layer=I.layer,F.sourceLayer=I.layer}),z})()}_ensureQueryJSON(O,W){let I=this.defaultQueryJSON;if((0,L.pC)(O)&&("outSpatialReference"in O&&!O.outSpatialReference&&(O.outSpatialReference=this.spatialReference),I=O.toJSON()),(0,L.pC)(W)){const J=W.geometries.map(z=>z.toJSON()).reduce((z,F)=>(z.rings=z.rings.concat(F.rings),z));I={...I,sceneFilter:{...W,geometry:J}}}return I}_ensureDataQueryEngine(){if(this._dataQueryEngineInstance)return this._dataQueryEngineInstance;const O="timeInfo"in this.layer&&this.layer.timeInfo&&this.layer.timeInfo.toJSON()||null,W=this.layer.objectIdField,I=m.M.toJSON(this._queryGeometryType),J=this.layer.fields?.map(ue=>ue.toJSON())??[],z=this.priority,F=this.spatialReference.toJSON(),{hasZ:D,hasM:N,featureStore:$,scheduler:ne}=this.context;return this._dataQueryEngineInstance=new h({hasZ:D,hasM:N,geometryType:I,fields:J,timeInfo:O,spatialReference:F,objectIdField:W,featureStore:$,scheduler:ne,priority:z}),this._dataQueryEngineInstance}};(0,a._)([(0,l.Cb)({constructOnly:!0})],M.prototype,"context",void 0),(0,a._)([(0,l.Cb)({constructOnly:!0})],M.prototype,"priority",void 0),(0,a._)([(0,l.Cb)()],M.prototype,"layer",null),(0,a._)([(0,l.Cb)()],M.prototype,"spatialReference",null),(0,a._)([(0,l.Cb)()],M.prototype,"_queryGeometryType",null),(0,a._)([(0,l.Cb)()],M.prototype,"defaultQueryJSON",null),M=(0,a._)([(0,f.j)("esri.views.3d.layers.graphics.QueryEngine")],M)},13191:(fe,se,i)=>{i.d(se,{W:()=>p});var T=i(15861),w=(i(29132),i(62208)),R=i(10699),L=i(38114),l=i(60507),E=i(81468),H=i(79112),f=i(74746),u=i(65234);function p(M,O,W,I,J){return C.apply(this,arguments)}function C(){return(C=(0,T.Z)(function*(M,O,W,I,J){const{elevationProvider:z,renderCoordsHelper:F,spatialReference:D}=M,{elevationInfo:N}=O,$=(0,f.WI)(N,!0),ne=yield(0,f.kr)($,D,J);(0,R.k_)(J);const ue=[],de=new Set,he=new Set;for(const{objectId:Ee,points:K}of I){const be=W(Ee);if((0,w.Wi)(be)){for(const ie of K)ue.push(ie[2]);de.add(Ee)}else{be.isDraped&&he.add(Ee),V.setFromElevationInfo((0,l.Jn)(be.graphic.geometry,N)),V.updateFeatureExpressionInfoContext(ne,be.graphic,O),m.spatialReference=M.spatialReference;for(const{x:ie,y:_,z:U}of K)m.x=ie,m.y=_,m.z=U??0,(0,E.qZ)(m,z,V,F,h),ue.push(h.z)}}return{elevations:ue,drapedObjectIds:he,failedObjectIds:de}})).apply(this,arguments)}const V=new H.o,m=(0,L.Tx)(0,0,0,u.Z.WGS84),h=new E.Lm},46348:(fe,se,i)=>{i.d(se,{c:()=>L});var T=i(15861),a=i(62208),w=i(10699),R=i(46679);function L(H,f,u){return l.apply(this,arguments)}function l(){return l=(0,T.Z)(function*(H,f,u){if((0,a.Wi)(H)||0===f.candidates.length)return E;const p=H.graphics3DGraphicsByObjectID??H.graphics3DGraphics,C=[],V=[],{renderer:m}=H,h=(0,a.pC)(m)&&"arcadeRequired"in m&&m.arcadeRequired?(0,R.LC)():null,M=function(){var F=(0,T.Z)(function*(D,{graphic:N,graphics3DSymbol:$}){const ne=yield h,ue=yield H.getRenderingInfoAsync(N,m,ne,{signal:u});return(0,a.Wi)(ue)?[]:$.queryForSnapping(D,W,ue,u)});return function(N,$){return F.apply(this,arguments)}}(),{candidates:O,spatialReference:W}=f;for(let F=0;F<O.length;++F){const D=O[F],{objectId:N}=D,$="number"==typeof N?p?.get(N):void 0;if((0,a.Wi)($))continue;const{graphics3DSymbol:ne}=$;ne.symbologySnappingSupported&&(C.push(M(D,$)),V.push(F))}if(0===C.length)return E;const I=yield Promise.all(C);(0,w.k_)(u);const J=[],z=[];for(let F=0;F<I.length;++F){const D=I[F],N=V[F];for(const $ of D)J.push($),z.push(N)}return{candidates:J,sourceCandidateIndices:z}}),l.apply(this,arguments)}const E={candidates:[],sourceCandidateIndices:[]}},54984:(fe,se,i)=>{i.d(se,{j:()=>ae,A:()=>Te});var T=i(15861),a=i(17626),w=i(14517),R=i(72392),L=i(63290),l=i(88159),E=i(62208),H=i(10699),f=i(32917),u=i(50618),p=i(77712),V=(i(90912),i(85931)),m=i(76898),h=i(65401),M=i(38114),O=i(89621),W=i(96854),I=i(59617),xe=(i(27306),i(8314),i(65234),i(5548),i(21286),i(2004),i(21674),i(72854),i(72642),i(37118),i(55214),i(71774),i(36255),i(53639));class ie{get isReferenced(){return 0!==this.versions.length}get isSingle(){return 1===this.versions.length&&1===this.versions[0].refCount}constructor(r,o){this._highestResolutionVersion=null,this.versions=[],this.ref(r,o)}ref(r,o){const c=this.feature;U.oldVersion=c,this.feature&&Object.defineProperty(r,"uid",{value:this.feature.uid,configurable:!0});for(const P of this.versions)if(P.resolution===o){P.refCount++;const j=this._highestResolutionVersion===P&&!(0,xe.f)(r,P.feature);return(j||this._highestResolutionVersion!==P)&&(P.feature=r),U.newVersion=j?r:c,U}const S={feature:r,resolution:o,refCount:1};return this.versions.push(S),!this._highestResolutionVersion||o<this._highestResolutionVersion.resolution?(U.newVersion=r,this._highestResolutionVersion=S):U.newVersion=c,U}unref(r){for(let o=0;o<this.versions.length;o++){const c=this.versions[o];if(c.resolution===r)return c.refCount--,U.oldVersion=this.feature,0===c.refCount&&(this.versions[o]=this.versions[this.versions.length-1],this.versions.length--,this._highestResolutionVersion===c&&(this._recalculateHighestResolutionVersion(),U.oldVersion=c.feature)),U.newVersion=this.feature,U}return null}get feature(){return this._highestResolutionVersion?this._highestResolutionVersion.feature:null}_recalculateHighestResolutionVersion(){if(0===this.versions.length)return void(this._highestResolutionVersion=null);let r=this.versions[0];for(let o=1;o<this.versions.length;o++){const c=this.versions[o];c.resolution<r.resolution&&(r=c)}this._highestResolutionVersion=r}}class _{get isReferenced(){return 0!==this._refCount}get isSingle(){return 1===this._refCount}constructor(r){this._feature=r,this._refCount=1}ref(r){return++this._refCount,U.oldVersion=this._feature,this.feature&&Object.defineProperty(r,"uid",{value:this.feature.uid,configurable:!0}),(0,xe.f)(this._feature,r)||(this._feature=r),U.newVersion=this._feature,U}unref(){return U.oldVersion=this._feature,this._refCount>0&&(this._refCount--,!this.isReferenced)?(U.newVersion=null,U):(U.newVersion=this._feature,U)}get feature(){return this._feature}}const U={oldVersion:null,newVersion:null},Q=new Set;class q{get displayingFeatures(){return this._displayingFeatures}set displayingFeatures(r){this._displayingFeatures=r,this.extentIncludingBorrowedFeatures=null}get perTileMaximumNumberOfFeaturesExceeded(){return!this.filtered&&(this.featuresMissing||this.features&&this.featureLimit!==this.features.length)}get features(){return this._features}get featureLimit(){return this._featureLimit}set featureLimit(r){this._featureLimit!==r&&(this._featureLimit=r,this._estimatedUnusedSizeDirty=!0)}get availableFields(){return this._availableFields}setFeatures(r,o,c){this._availableFields=(0,E.Pt)(c,Q),this._features=r,this._shuffled=!1,this._estimatedSize=-1,this._estimatedUnusedSizeDirty=!0,r&&r.length>0?(this._emptyFeatureRatio=o/(r.length+o),this._numVertices=r.reduce((S,P)=>S+(0,M.R3)(P.geometry),0)):(this._emptyFeatureRatio=0,this._numVertices=0)}get emptyFeatureRatio(){return this._emptyFeatureRatio}get numFeatures(){return this.hasPreciseFeatureCount?this._numFeatures:this._features?this._features.length:0}set numFeatures(r){this._numFeatures=r}get hasPreciseFeatureCount(){return this._numFeatures>_e}get needsFeatureCount(){return this._numFeatures===_e}get numVertices(){return this._numVertices}constructor(r){this.descriptor=r,this.fetchStatus=d.FETCH_NEEDED,this._features=null,this._numVertices=0,this._featureLimit=0,this.featuresMissing=!0,this._shuffled=!1,this._numFeatures=_e,this._emptyFeatureRatio=0,this._estimatedSize=-1,this._estimatedUnusedSize=0,this._estimatedUnusedSizeDirty=!1,this._availableFields=Q,this._displayingFeatures=null,this.alive=!0,this.filtered=!1}get id(){return this.descriptor.id}get estimatedSize(){return this.updateMemoryEstimates(),this._estimatedSize}get estimatedUnusedSize(){return this._estimatedUnusedSize}updateMemoryEstimates(){if(this._estimatedSize<0){if(this._estimatedSize=0,this._estimatedUnusedSize=0,this._features)for(let r=0;r<this._features.length;++r){const o=(0,M.Xw)(this._features[r]);this._estimatedSize+=o,r>=this.featureLimit&&(this._estimatedUnusedSize+=o)}return!0}if(this._estimatedUnusedSizeDirty){if(this._estimatedUnusedSize=0,this._estimatedUnusedSizeDirty=!1,this._features)for(let r=this.featureLimit;r<this._features.length;++r)this._estimatedUnusedSize+=(0,M.Xw)(this._features[r]);return!0}return!1}get isFetching(){return this.fetchStatus===d.FETCHING||this.fetchStatus===d.REFETCHING}get isRefetching(){return this.fetchStatus===d.REFETCHING}get needsFetching(){return this.fetchStatus===d.FETCH_NEEDED||this.fetchStatus===d.REFETCH_NEEDED}get needsRefetching(){return this.fetchStatus===d.REFETCH_NEEDED}get isFetched(){return this.fetchStatus===d.DONE||this.fetchStatus===d.FULL}resetFetching(){this.fetchStatus=this.fetchStatus===d.REFETCHING?d.REFETCH_NEEDED:d.FETCH_NEEDED}get needsDisplayUpdate(){return!!this._features&&!function B(s,r,o){if((0,E.Wi)(r)||(0,E.Wi)(s)||o!==r.length||o>s.length)return!1;for(let c=0;c<o;++c)if(s[c]!==r[c])return!1;return!0}(this._features,this.displayingFeatures,this.featureLimit)}intersects(r){return!(!(0,E.Wi)(r)&&this.descriptor.extent)||((0,h.oJ)(r,te),(0,h.kK)(this.descriptor.extent,te))}intersectionIncludingBorrowed(r,o){const c=(0,E.pC)(this.extentIncludingBorrowedFeatures)?this.extentIncludingBorrowedFeatures:this.descriptor.extent;return r||c?((0,E.pC)(r)?((0,h.oJ)(r,o),(0,h.jV)(o,c,o)):(0,h.JG)(o,c),o):((0,h.JG)(o,h.bd),o)}_shuffle(r){this._features.sort((o,c)=>(0,M.MS)(o,r)-(0,M.MS)(c,r)),(0,V.TV)(this._features,16438),this._shuffled=!0,this._estimatedUnusedSizeDirty=!0}reduceFeatures(r,o,c){if(r<=0)return!1;if(!this._features)return this.featureLimit=0,!1;let S=!1;this.featureLimit=Math.ceil(this.numFeatures*r),this.featureLimit>this._features.length&&(this.featureLimit=this._features.length,this.fetchStatus===d.DONE&&this._features.length>0&&(this.fetchStatus=d.REFETCH_NEEDED,S=!0)),!this._shuffled&&r<1&&this._shuffle(c);const P=Math.max(this.featureLimit,Math.ceil(o*this.numFeatures));return this._features.length>P&&(this._features.length=P,this.featuresMissing=!0,this.fetchStatus===d.FULL&&(this.fetchStatus=d.DONE)),S}get cache(){return{availableFields:this._availableFields,features:this._features,numFeatures:this._numFeatures,emptyFeatureRatio:this._emptyFeatureRatio,fetchStatus:this.fetchStatus,featuresMissing:this.featuresMissing}}set cache(r){this.requestController=null,this._availableFields=r.availableFields,this._features=r.features,this._numFeatures=r.numFeatures,this._emptyFeatureRatio=r.emptyFeatureRatio,this.fetchStatus=r.fetchStatus,this.featuresMissing=r.featuresMissing,this._estimatedSize=-1,this._estimatedUnusedSizeDirty=!0}}const _e=-1;var d,s;(s=d||(d={}))[s.FETCH_NEEDED=0]="FETCH_NEEDED",s[s.REFETCH_NEEDED=1]="REFETCH_NEEDED",s[s.FETCHING=2]="FETCHING",s[s.REFETCHING=3]="REFETCHING",s[s.DONE=4]="DONE",s[s.FULL=5]="FULL";const te=(0,h.Ue)();var X=i(15076),ee=i(87091);const me="esri.views.3d.layers.support.FeatureTileFetcher3D",ve=L.Z.getLogger(me);let ae=class extends w.Z{set maximumNumberOfFeatures(s){s=s||1/0;const r=this._get("maximumNumberOfFeatures");s===r||s<1||(this._set("maximumNumberOfFeatures",s),this._maximumFeaturesUpdated(r,s))}set memoryFactor(s){this.memoryFactor!==s&&(this._set("memoryFactor",s),this._setDirty())}set lodFactor(s){this.lodFactor!==s&&(this._set("lodFactor",s),this._supportsResolution&&this.refetch())}get useTileCount(){return this._useTileCount&&(0,E.pC)(this.context.query.queryFeatureCount)}set useTileCount(s){this._useTileCount=s,this.notifyChange("useTileCount")}get memoryForUnusedFeatures(){let s=0;return this._featureTiles.forEach(r=>s+=r.estimatedUnusedSize),s}get totalVertices(){let s=0;return this._featureTiles.forEach(r=>s+=r.numVertices),s}get totalFeatures(){let s=0;return this._featureTiles.forEach(r=>s+=r.numFeatures),s}set filterExtent(s){if((0,E.pC)(s)&&this.context.tilingScheme&&!s.spatialReference.equals(this.context.tilingScheme.spatialReference))return void ve.error("#filterExtent=","extent needs to be in the same spatial reference as the tiling scheme");const r=this._get("filterExtent");if(r===s||(0,E.pC)(r)&&s&&r.equals(s))return;const o=(0,E.pC)(s)?s.clone():null;this._set("filterExtent",o),this._reclip(o,r)}constructor(s){super(s),this._useTileCount=!1,this.updating=!1,this.running=!1,this.updatingTotal=0,this.updatingRemaining=0,this.expectedFeatureDiff=0,this.maximumNumberOfFeaturesExceeded=!1,this.maximumNumberOfFeaturesExceededThrottle=1e3,this._fullRatio=1,this._farRatio=1,this._changes={updates:{adds:new Array,removes:new Array},adds:new Array,removes:new Array},this._handles=new R.Z,this._frameTask=ee.sq,this._dirty=!1,this._featureTiles=new Map,this._displayingFeatureReferences=new Map,this._numDisplayingFeatureReferences=0,this._suspended=!0,this._pendingEdits=null}initialize(){this._handles.add((0,f.on)(()=>this.tileDescriptors,"change",()=>this._setDirty(),{onListenerAdd:()=>this._setDirty()})),this._objectIdField=this.context.objectIdField,this.FeatureReferenceClass=this.context.capabilities.supportsMultipleResolutions?ie:_;const s=this.context.scheduler;(0,E.pC)(s)&&(this._frameTask=s.registerTask(ee.T8.FEATURE_TILE_FETCHER,this)),this._setDirty()}destroy(){this._frameTask.remove(),this._handles=(0,E.SC)(this._handles),this._featureTiles.forEach(s=>{this._cancelFetchTile(s),this._removeTile(s)}),this._featureTiles.clear(),this._displayingFeatureReferences.clear(),this._pendingEdits?.controller.abort(),this._pendingEdits=null}get _paused(){return this._suspended||!!this._pendingEdits}restart(){this._featureTiles.forEach(s=>{this._cancelFetchTile(s),this._clearTile(s),this._resetFetchTile(s)}),(0,E.pC)(this.context.memoryCache)&&this.context.memoryCache.clear(),this._setDirty()}refetch(){this._featureTiles.forEach(s=>{this._cancelFetchTile(s),this._resetFetchTile(s)}),(0,E.pC)(this.context.memoryCache)&&this.context.memoryCache.clear(),this._setDirty()}suspend(){this._suspended||(this._suspended=!0,this._pause(),this._setDirty())}resume(){this._suspended&&(this._suspended=!1,this._unpause())}_pause(){this._paused&&(this._featureTiles.forEach(s=>this._cancelFetchTile(s)),this._updated())}_unpause(){this._paused||(this._setDirty(),this._updated())}get availableFields(){let s=null;return this._featureTiles.forEach(r=>{(0,E.Wi)(r.displayingFeatures)||0===r.displayingFeatures.length||((0,E.Wi)(s)?s=new Set(r.availableFields):s.forEach(o=>{r.availableFields.has(o)||(0,E.Wg)(s).delete(o)}))}),(0,E.pC)(s)?s:new Set}applyEdits(s){this._pendingEdits||(this._pendingEdits={edits:Promise.resolve(),count:0,controller:new AbortController},this._pause());const r=this._pendingEdits;r.count++;const o=r.edits.then(()=>s.result.catch(c=>{if((0,H.D_)(c))throw c;return null}).then(c=>c&&(this._applyEditsDeleteFeatures(c.deletedFeatures),this._applyEditsAddUpdateFeatures(c.addedFeatures,c.updatedFeatures,r.controller.signal).then(()=>c))).then(c=>(0==--r.count&&(this._pendingEdits===r&&(this._pendingEdits=null),(0,E.pC)(this.context.memoryCache)&&this.context.memoryCache.clear(),this._unpause(),this._updated()),c)));return r.edits=o,this._updated(),o}_applyEditsDeleteFeatures(s){if(0===s.length)return;const r=this.context.globalIdField,o=r&&this.availableFields.has(r),c=new Set,S=this._objectIdField;s.forEach(({objectId:P,globalId:j})=>{if((!P||P<0)&&r){o||ve.errorOncePerTick(`Editing the specified service requires the layer's globalIdField, ${r} to be included the layer's outFields for updates to be reflected in the view`);const re=this.features.find(ce=>ce.attributes&&ce.attributes[r]===j);re&&c.add((0,M.MS)(re,S))}else c.add(P)}),this._featureTiles.forEach(P=>{if(!P.features)return;const j=P.features.filter(re=>!c.has((0,M.MS)(re,this._objectIdField)));j.length!==P.features.length&&(P.setFeatures(j,0,P.availableFields),this._invalidateCounts())})}_applyEditsAddUpdateFeatures(s,r,o){var c=this;return(0,T.Z)(function*(){const S=[],P=new Set;if(s.forEach(re=>S.push(re.objectId)),r.forEach(re=>{S.push(re.objectId),P.add(re.objectId)}),0===S.length)return;const j=[];c._featureTiles.forEach(re=>{const ce=c._applyEditsAddUpdateTile(re,S,P,o);ce&&j.push(ce)}),yield(0,H.as)(j)})()}_applyEditsAddUpdateTile(s,r,o,c){var S=this;return(0,T.Z)(function*(){if(!s.features)return;const P=S._createQuery(s);P.resultType=void 0,P.cacheHint=!1,P.objectIds=r;const j=yield S._queryFeatures(P,c);let re=null;if(o.size>0){const ce=s.features.filter(Fe=>!o.has((0,M.MS)(Fe,S._objectIdField)));ce.length!==s.features.length&&(re=ce)}if(j.features.length>0){re||(re=s.features.slice());for(const ce of j.features)re.push(ce)}re&&(s.hasPreciseFeatureCount&&(s.numFeatures=Math.max(s.numFeatures,re.length)),s.setFeatures(re,0,Ne(s.availableFields,j.fields)),S._invalidateCounts())})()}_queryFeatures(s,r){return this.context.query.queryFeaturesDehydrated(s,{signal:r,timeout:Ze})}_setDirty(){this._dirty=!0,this._updated()}runTask(s){if(this._frameTask.processQueue(s),!this._dirty||!this.initialized)return;this._dirty=!1;const r=this._getListOfTiles();if(this._markTilesNotAlive(r),!s.run(()=>this._addTiles(r,s))||!s.run(()=>this._filterExtentTiles(r,s))||!s.run(()=>this._removeTiles(r,s))||s.done)return void this._setDirty();const o=this._sortTiles(r);s.run(()=>this._showTiles(o,s))&&s.run(()=>this._fetchTiles(o,s))&&s.run(()=>this._updateMemoryEstimates(o,s))||this._setDirty(),this._updated(),this.updating||this._updateMaximumNumberOfFeaturesExceeded()}_markTilesNotAlive(s){for(const r of s)r.alive=!1}_addTiles(s,r){return!this._suspended&&(this.tileDescriptors.forEach(o=>{const c=this._featureTiles.get(o.id);c?c.alive=!0:r.done||(s.push(this._addTile(o)),r.madeProgress())}),r.hasProgressed)}_filterExtentTiles(s,r){for(const o of s){if(r.done)break;o.alive&&(o.filtered=!o.intersects(this.filterExtent),o.filtered&&(this._clearTile(o),r.madeProgress()))}return r.hasProgressed}_removeTiles(s,r){for(let o=s.length-1;o>=0&&!r.done;o--){const c=s[o];c.alive||(this._removeTile(c),o!==s.length-1&&(s[o]=s[s.length-1]),s.pop(),r.madeProgress())}return r.hasProgressed}_sortTiles(s){return s.sort((r,o)=>(r.descriptor.loadPriority??0)-(o.descriptor.loadPriority??0)),s}_showTiles(s,r){const o=this._updateRatio(s),c=S=>{const P=this._fullRatio<1?o(S)*this._farRatio:1;return S.reduceFeatures(P,this.memoryFactor,this._objectIdField)&&this._setDirty(),this._showTile(S)};for(const S of s)if(!r.run(()=>c(S))){this._setDirty();break}return r.hasProgressed}_fetchTiles(s,r){if(this._paused)return!1;let o=!1;for(const c of s){if(!c.needsFetching)continue;const S=(0,E.pC)(this.context.memoryCache)?this.context.memoryCache.pop(c.id):null;if((0,E.pC)(S))c.cache=S,this._setDirty(),this._scheduleUpdated(),r.madeProgress();else{if(this._needsNumFeatures(c)){const P=new AbortController,j=this._fetchTileCount(c,P.signal);this._handleRequest(c,j,P,()=>c.numFeatures=-2),o=!0,r.madeProgress()}if(r.done)return!0}}if(o)return r.hasProgressed;for(const c of s)if(c.needsFetching){const S=new AbortController,P=this._fetchTile(c,S.signal);if(this._handleRequest(c,P,S,j=>{c.setFeatures([],0,null),this._invalidateCounts(),c.featuresMissing=!1,this.context.logFetchError(ve,j)}),r.madeProgress())return!0}return r.hasProgressed}_updateMemoryEstimates(s,r){return s.some(o=>!r.run(()=>o.updateMemoryEstimates())&&(this._setDirty(),!0)),r.hasProgressed}_reclip(s,r){if(!this.initialized)return;const o=new Array;this._featureTiles.forEach(c=>{(0,E.Wi)(c.displayingFeatures)||0===c.displayingFeatures.length||(c.intersectionIncludingBorrowed(r,Ge),c.intersectionIncludingBorrowed(s,Ce),(0,h.fS)(Ge,Ce)||o.push(c))}),this._refreshDisplayingFeatures(o),this._updated()}_refreshDisplayingFeatures(s){const r=new Set,o=this._changes.updates;for(const c of s)if(!(0,E.Wi)(c.displayingFeatures))for(const S of c.displayingFeatures){const P=(0,M.MS)(S,this._objectIdField);if(r.has(P))continue;r.add(P);const j=this._displayingFeatureReferences.get(P).feature;o.removes.push(j),o.adds.push(j)}this._applyChanges()}_updated(){let s=0;this._paused||this._featureTiles.forEach(o=>o.isFetching?++s:0);const r=this._dirty||!!this._pendingEdits||s>0;if(this._set("running",this._dirty),this._set("updating",r),r){let o=0,c=0,S=0,P=0,j=0;const re=this._displayingFeatureReferences.size/this._numDisplayingFeatureReferences;this._featureTiles.forEach(pe=>{if(++c,pe.isFetching&&pe.hasPreciseFeatureCount){const De=this._maximumFeaturesForTile(pe)*(1-pe.emptyFeatureRatio),Ie=(0,E.pC)(pe.displayingFeatures)?pe.displayingFeatures.length*re:0;j+=De-Ie}pe.needsFetching?++P:pe.numFeatures>0&&(++S,o+=pe.numFeatures)}),P+=s;let ce=0,Fe=0;o?(Fe=o,ce=Math.min(P*o/S,o)):(Fe=c,ce=P),j=Math.min(this.maximumNumberOfFeatures-this.features.length,j),this._set("updatingTotal",Fe),this._set("updatingRemaining",ce),this._set("expectedFeatureDiff",j)}else this._set("updatingTotal",0),this._set("updatingRemaining",0),this._set("expectedFeatureDiff",0);this.debugger&&this.debugger.update()}_updateMaximumNumberOfFeaturesExceeded(){const s=(0,l.oE)(this._featureTiles,r=>r.perTileMaximumNumberOfFeaturesExceeded);this._set("maximumNumberOfFeaturesExceeded",s)}_updateRatio(s){const r=function A(s){let r=0;for(const o of s)o.features&&o.features.length>0&&o.alive&&(r=Math.max(r,o.descriptor.lij[0]));return r}(s),o=P=>1/(1<<Math.max(0,r-P.descriptor.lij[0]));let c=0,S=0;for(const P of s){const j=P.numFeatures;c+=j,S+=j*o(P)}return this._fullRatio=Math.min(1,this.maximumNumberOfFeatures/c),this._farRatio=this.maximumNumberOfFeatures/S,this._scheduleUpdated(),o}_maximumFeaturesUpdated(s,r){s!==r&&(r>s&&this._featureTiles.forEach(o=>{if(!o.featuresMissing)return;const c=this._maximumFeaturesForTile(o);o.features&&(o.features.length>=c||o.fetchStatus===d.FULL)||(this._cancelFetchTile(o),this._resetFetchTile(o))}),this._setDirty())}_addTile(s){const r=new q(s);return this._featureTiles.set(r.id,r),this._resetFetchTile(r),this._referenceDisplayingFeaturesFromRelatedTiles(r),r}_referenceDisplayingFeaturesFromRelatedTiles(s){const r=s.descriptor.resolution;this._featureTiles.forEach(o=>{if(!((0,E.Wi)(o.displayingFeatures)||s===o||s.descriptor.lij&&o.descriptor.lij&&!(0,X.E9)(s.descriptor.lij,o.descriptor.lij))){(0,E.Wi)(s.displayingFeatures)&&(s.displayingFeatures=[]),s.descriptor.extent&&o.descriptor.extent&&((0,E.Wi)(s.extentIncludingBorrowedFeatures)&&(s.extentIncludingBorrowedFeatures=(0,h.d9)(s.descriptor.extent)),(0,h.jn)(s.extentIncludingBorrowedFeatures,o.descriptor.extent,s.extentIncludingBorrowedFeatures));for(const c of o.displayingFeatures){s.displayingFeatures.push(c);const S=this._displayingFeatureReferences.get((0,M.MS)(c,this._objectIdField));S.ref(S.feature,r),this._numDisplayingFeatureReferences++}}}),s.featureLimit=(0,E.pC)(s.displayingFeatures)?s.displayingFeatures.length:0}_removeTile(s){this._clearTile(s),this._featureTiles.delete(s.id)}_resetFetchTile(s){s.filtered=!s.intersects(this.filterExtent),s.filtered?s.needsFetching&&(s.fetchStatus=d.DONE):s.fetchStatus=d.FETCH_NEEDED}_cancelFetchTile(s){const r=s.requestController;(0,E.pC)(r)&&(s.requestController=null,s.resetFetching(),r.abort())}_fetchTileCount(s,r){var o=this;return(0,T.Z)(function*(){return s.numFeatures=yield o._fetchCount(s,r),o._updateRatio(o._getListOfTiles()),s.fetchStatus===d.REFETCHING?d.REFETCH_NEEDED:d.FETCH_NEEDED})()}_fetchTile(s,r){var o=this;return(0,T.Z)(function*(){const c=o._maximumFeaturesForTile(s);if(c<=0)return function Re(s){return s.setFeatures([],0,null),s.featuresMissing=!1,d.DONE}(s);const S=o._getMaxRecordCount(s),P=Math.ceil(c/S);if(ye(s)||!o.context.capabilities.supportsMaxRecordCountFactor||s.numFeatures<=c&&P>W.Z.MAX_MAX_RECORD_COUNT_FACTOR)return o._fetchPagedTile(s,r);const j=o._createQuery(s);if(j.maxRecordCountFactor=Math.ceil(c/S),s.isRefetching&&s.features&&s.features.length>0){const De=Math.ceil(s.features.length/(1-s.emptyFeatureRatio)/S);j.maxRecordCountFactor=Math.max(De+1,j.maxRecordCountFactor)}const{features:re,exceededTransferLimit:ce,fields:Fe}=yield o._queryFeatures(j,r),pe=ce?j.maxRecordCountFactor>=W.Z.MAX_MAX_RECORD_COUNT_FACTOR?d.FULL:d.DONE:d.FULL;return yield o._frameTask.schedule(()=>{s.featuresMissing=re.length<s.numFeatures||!!ce;const De=o._removeEmptyFeatures(re);s.setFeatures(re,De,Le(Fe))},r),(0,H.k_)(r),o._invalidateCounts(),pe})()}_fetchCount(s,r){var o=this;return(0,T.Z)(function*(){return o.context.query.queryFeatureCount(o._createFeatureCountQuery(s),{signal:r})})()}_fetchPagedTile(s,r){var o=this;return(0,T.Z)(function*(){let c,S=0,P=0,j=0,re=o._maximumFeaturesForTile(s)-j;const ce=o._getMaxRecordCount(s);let Fe=null;for(;;){const pe=o._createQuery(s),De=o._setPagingParameters(pe,S,re,ce),{features:Ie,exceededTransferLimit:Se,fields:Ve}=yield o._queryFeatures(pe,r);if(yield o._frameTask.schedule(()=>{De&&(S+=(0,E.Wg)(pe.num)),j+=Ie.length,P+=o._removeEmptyFeatures(Ie),s.featuresMissing=S<s.numFeatures||!!Se,c=c?c.concat(Ie):Ie,Fe=Ne(Fe,Ve),s.setFeatures(c,P,Fe)},r),(0,H.k_)(r),o._invalidateCounts(),o._setDirty(),re=o._maximumFeaturesForTile(s)-j,!De||!Se||re<=0)return Se?d.DONE:d.FULL}})()}_createFeatureCountQuery(s){const r=this._createQuery(s);return this.context.capabilities.supportsCacheHint&&(r.resultType=void 0,r.cacheHint=!0),r}_createQuery(s){const r=this.context.createQuery(),o=s.descriptor.extent;return o&&(r.geometry=(0,h.HH)(o,this.context.tilingScheme.spatialReference)),this._setResolutionParams(r,s),this._useTileQuery(s)?r.resultType="tile":this.context.capabilities.supportsCacheHint&&(r.cacheHint=!0),r}_setPagingParameters(s,r,o,c){return!!this.context.capabilities.supportsPagination&&(s.start=r,o>0&&this.context.capabilities.supportsMaxRecordCountFactor?(s.maxRecordCountFactor=Math.ceil(o/c),s.num=Math.min(s.maxRecordCountFactor*c,o)):s.num=Math.min(c),!0)}_getEffectiveTileResolution(s){if(null==s.descriptor.resolution)return null;const r=this.context.viewingMode===I.JY.Global?this.context.tilingScheme.resolutionAtLevel(3):1/0;return Math.min(s.descriptor.resolution,r)/this.lodFactor}get _supportsResolution(){return this.context.capabilities.supportsMultipleResolutions&&"point"!==this.context.geometryType}_setResolutionParams(s,r){if(!this._supportsResolution)return;const o=this._getEffectiveTileResolution(r);null!=o&&(this.context.capabilities.supportsQuantization?s.quantizationParameters=new O.Z({mode:"view",originPosition:"upper-left",tolerance:o,extent:this.context.fullExtent}):"polyline"===this.context.geometryType&&(s.maxAllowableOffset=o))}_removeEmptyFeatures(s){const r=s.length;for(let o=0;o<s.length;)(0,M.dF)(s[o].geometry)?++o:(s[o]=s[s.length-1],--s.length);return r-s.length}_needsNumFeatures(s){return this.useTileCount&&s.needsFeatureCount&&!ye(s)}_getMaxRecordCount(s){const{tileMaxRecordCount:r,maxRecordCount:o}=this.context;return this._useTileQuery(s)&&(0,E.pC)(r)&&r>0&&this.context.capabilities.supportsResultType?r:(0,E.pC)(o)&&o>0?o:Ke}_useTileQuery(s){return(!ye(s)||!this.context.capabilities.supportsCacheHint)&&this.context.capabilities.supportsResultType}_handleRequest(s,r,o,c){s.fetchStatus=s.needsRefetching?d.REFETCHING:d.FETCHING,s.requestController=o;let S=!1;r.then(P=>{s.requestController=null,s.fetchStatus=P}).catch(P=>{s.requestController===o&&(s.requestController=null,s.fetchStatus=d.DONE),(0,H.D_)(P)?S=!0:c(P)}).then(()=>{S||this._setDirty(),this._scheduleUpdated()})}_scheduleUpdated(){this._handles&&!this._handles.has("scheduleUpdated")&&this._handles.add((0,u.Os)(()=>{this._handles.remove("scheduleUpdated"),this._updated()}),"scheduleUpdated")}_showTile(s){if((0,E.pC)(s.displayingFeatures)&&!s.needsDisplayUpdate)return!1;const r=s.features;if(0===s.featureLimit||!r){const j=(0,E.pC)(s.displayingFeatures)&&s.displayingFeatures.length>0;return this._hideTileFeatures(s),s.displayingFeatures=[],j}const o=s.descriptor.resolution,c=this._changes.updates,S=this._changes.adds,P=Math.min(s.featureLimit,r.length);s.featureLimit=P;for(let j=0;j<P;++j){const re=r[j],ce=(0,M.MS)(re,this._objectIdField),Fe=this._displayingFeatureReferences.get(ce);if(Fe){const pe=Fe.ref(re,o);pe.oldVersion!==pe.newVersion&&(pe.oldVersion&&c.removes.push(pe.oldVersion),pe.newVersion&&c.adds.push(pe.newVersion))}else this._displayingFeatureReferences.set(ce,new this.FeatureReferenceClass(re,o)),S.push(re);this._numDisplayingFeatureReferences++}return this._hideTileFeatures(s),this._applyChanges(),s.displayingFeatures=r.slice(0,P),!0}_hideTile(s){this._cancelFetchTile(s),this._hideTileFeatures(s)}_hideTileFeatures(s){if((0,E.Wi)(s.displayingFeatures))return;const r=this._changes.updates,o=this._changes.removes;for(const c of s.displayingFeatures){const S=(0,M.MS)(c,this._objectIdField),P=this._displayingFeatureReferences.get(S);if(!P)continue;const j=P.unref(s.descriptor.resolution);this._numDisplayingFeatureReferences--,j?j.oldVersion!==j.newVersion&&(null==j.newVersion?(this._displayingFeatureReferences.delete(S),j.oldVersion&&o.push(j.oldVersion)):(r.adds.push(j.newVersion),j.oldVersion&&r.removes.push(j.oldVersion))):console.error("Hiding unreferenced feature")}this._applyChanges(),s.displayingFeatures=null}_applyChanges(){const s=this._changes.updates;s.removes.length>0&&(this.features.removeMany(s.removes),s.removes.length=0),s.adds.length>0&&(this.features.addMany(s.adds),s.adds.length=0);const r=this._changes.adds,o=this._changes.removes,c=Math.min(r.length,o.length);let S=0;for(;S<c;){const P=Math.min(S+Ue,c);this.features.addMany(r.slice(S,P)),this.features.removeMany(o.slice(S,P)),S=P}r.length>c&&this.features.addMany(0===S?r:r.slice(S)),o.length>c&&this.features.removeMany(0===S?o:o.slice(S)),r.length=0,o.length=0}_clearTile(s){this._hideTile(s),s.features&&(0,E.pC)(this.context.memoryCache)&&this.context.memoryCache.put(s.id,s.cache,16+s.estimatedSize),s.setFeatures(null,0,null),this._invalidateCounts()}_invalidateCounts(){this.notifyChange("totalVertices"),this.notifyChange("totalFeatures"),this.notifyChange("memoryForUnusedFeatures")}_getListOfTiles(){return Array.from(this._featureTiles.values())}get storedFeatures(){return this._getListOfTiles().reduce((s,r)=>s+(r.features?r.features.length:0),0)}get missingTiles(){return Array.from(this._featureTiles.values()).reduce((s,r)=>s+(r.needsFetching||r.isFetching?1:0),0)}_maximumFeaturesForTile(s){const r=s.hasPreciseFeatureCount?s.numFeatures:1/0;return Math.min(Math.ceil((s.hasPreciseFeatureCount?r:this.maximumNumberOfFeatures)*(this._fullRatio<1?this._farRatio:1)/(1-s.emptyFeatureRatio)),r)}get test(){return{process:s=>this.runTask(s),getFeatureTileById:s=>this._featureTiles.get(s),forEachFeatureTile:s=>this._featureTiles.forEach(s)}}};function ye(s){return"dummy-tile-full-extent"===s.id}function Te(s){const r=s.capabilities.query;return{supportsMultipleResolutions:Me(s),supportsPagination:!(!r||!r.supportsPagination),supportsResultType:!(!r||!r.supportsResultType),supportsCacheHint:!(!r||!r.supportsCacheHint),supportsQuantization:!(!r||!r.supportsQuantization),supportsQuantizationEditMode:!(!r||!r.supportsQuantizationEditMode),supportsMaxRecordCountFactor:!(!r||!r.supportsMaxRecordCountFactor),supportsFormatPBF:!(!r||!r.supportsFormatPBF)}}function Me(s){switch(s.geometryType){case"polyline":return!0;case"polygon":return s.capabilities&&s.capabilities.query&&s.capabilities.query.supportsQuantization;default:return!1}}function Le(s){return(0,E.Wi)(s)?new Set:new Set(s.map(r=>r.name))}function Ne(s,r){if((0,E.Wi)(s)||(0,E.Wi)(r))return Le(r);const o=new Set;for(const{name:c}of r)s.has(c)&&o.add(c);return o}(0,a._)([(0,p.Cb)({constructOnly:!0})],ae.prototype,"features",void 0),(0,a._)([(0,p.Cb)()],ae.prototype,"tileDescriptors",void 0),(0,a._)([(0,p.Cb)({value:1/0})],ae.prototype,"maximumNumberOfFeatures",null),(0,a._)([(0,p.Cb)({value:1})],ae.prototype,"memoryFactor",null),(0,a._)([(0,p.Cb)({value:1})],ae.prototype,"lodFactor",null),(0,a._)([(0,p.Cb)()],ae.prototype,"useTileCount",null),(0,a._)([(0,p.Cb)({readOnly:!0})],ae.prototype,"updating",void 0),(0,a._)([(0,p.Cb)({readOnly:!0})],ae.prototype,"running",void 0),(0,a._)([(0,p.Cb)({readOnly:!0})],ae.prototype,"updatingTotal",void 0),(0,a._)([(0,p.Cb)({readOnly:!0})],ae.prototype,"updatingRemaining",void 0),(0,a._)([(0,p.Cb)({readOnly:!0})],ae.prototype,"expectedFeatureDiff",void 0),(0,a._)([(0,p.Cb)({readOnly:!0})],ae.prototype,"memoryForUnusedFeatures",null),(0,a._)([(0,p.Cb)({readOnly:!0})],ae.prototype,"maximumNumberOfFeaturesExceeded",void 0),(0,a._)([(0,p.Cb)({constructOnly:!0})],ae.prototype,"maximumNumberOfFeaturesExceededThrottle",void 0),(0,a._)([(0,p.Cb)({readOnly:!0})],ae.prototype,"totalVertices",null),(0,a._)([(0,p.Cb)({readOnly:!0})],ae.prototype,"totalFeatures",null),(0,a._)([(0,p.Cb)()],ae.prototype,"filterExtent",null),(0,a._)([(0,p.Cb)({constructOnly:!0})],ae.prototype,"context",void 0),ae=(0,a._)([(0,m.j)(me)],ae);const Ke=2e3,Ge=(0,h.Ue)(),Ce=(0,h.Ue)(),Ze=6e5,Ue=200},98667:(fe,se,i)=>{i.d(se,{n:()=>O});var T=i(15861),a=i(17626),w=i(59213),R=i(80542),L=i(63290),l=i(62208),E=i(10699),H=i(32917),f=i(77712),C=(i(90912),i(85931),i(76898)),V=i(98624),m=i(59990),h=i(34675),M=i(87091);let O=class extends R.r{constructor(W){var I;super(W),I=this,this._updateTask=null,this._frameTask=null,this._queryEngine=null,this._updateRequested=!0,this._updateVisibility=function(){var J=(0,T.Z)(function*(z){if((0,l.Wi)(I._compositedFeatureFilter)&&(0,l.Wi)(I._sceneFilter)||0===I.context.getFeatureCount())return I._frameTask.schedule(()=>I.clear(),z);try{const F=yield I._queryEngine.executeQueryForIdSet(I._compositedFeatureFilter,I._sceneFilter,z);return I._frameTask.schedule(()=>{I.context.updateFeatureVisibilities(D=>F.has(D))},z)}catch(F){return(0,E.r9)(F),L.Z.getLogger(I.declaredClass).warn(`FeatureFilter query failed: ${F}`,{error:F}),I._frameTask.schedule(()=>{I.context.setAllFeaturesVisibility(!0)},z)}});return function(z){return J.apply(this,arguments)}}()}initialize(){const W=M.T8.FILTER_VISIBILITY,{layer:I,view:J}=this._layerView,{featureStore:z}=this.context;this._queryEngine=new h.q({context:{spatialReference:J.spatialReference,layer:I,scheduler:J.resourceController.scheduler,featureStore:z,hasM:"hasM"in this._layerView&&this._layerView.hasM,hasZ:"hasZ"in this._layerView&&this._layerView.hasZ},priority:W}),this._frameTask=this._layerView.view.resourceController.scheduler.registerTask(W,this),this.updatingHandles.add(()=>[this._compositedFeatureFilter,this._sceneFilter],()=>this.reapply(),H.nn)}destroy(){this._updateRequested=!1,this.handles.removeAll(),this.updatingHandles.removeAll(),this.clear(),this._updateTask=(0,l.IM)(this._updateTask),this._frameTask=(0,l.hw)(this._frameTask),this._queryEngine=(0,l.SC)(this._queryEngine),this._set("context",null)}get updating(){return this.running||this.updatingHandles.updating||(0,l.pC)(this._updateTask)&&!this._updateTask.finished}get running(){return this._updateRequested||this._frameTask.updating}get defaultVisibility(){return(0,l.Wi)(this._compositedFeatureFilter)&&(0,l.Wi)(this._sceneFilter)}get _featureFilter(){return"filter"in this._layerView?this._layerView.filter:null}get _sceneFilter(){return"layerFilter"in this._layerView?this._layerView.layerFilter:null}get _floorFilter(){return(0,m.c)(this._layerView)}get _timeExtent(){return"timeExtent"in this._layerView?this._layerView.timeExtent:null}get _compositedFeatureFilter(){const{_featureFilter:W,_timeExtent:I,_floorFilter:J}=this;if((0,l.Wi)(I)&&(0,l.Wi)(J))return W;const z=(0,l.pC)(W)?W.clone():new V.Z;if((0,l.pC)(I)&&(z.timeExtent=(0,l.pC)(z.timeExtent)?z.timeExtent.intersection(I):I),(0,l.pC)(J)){const F=(0,l.Wi)(z.where)||""===z.where;z.where=F?J:`(${z.where}) AND (${J})`}return z}get _layerView(){return this.context.layerView}reapply(){this._updateRequested=!0}clear(){this._queryEngine.clear(),this.context.clearFeaturesVisibility()}runTask(W){this._updateRequested&&(this._updateTask=(0,l.IM)(this._updateTask),this._updateTask=(0,w.vr)(this._updateVisibility),this._updateRequested=!1,W.madeProgress()),this._frameTask.processQueue(W)}};(0,a._)([(0,f.Cb)({constructOnly:!0})],O.prototype,"context",void 0),(0,a._)([(0,f.Cb)()],O.prototype,"updating",null),(0,a._)([(0,f.Cb)()],O.prototype,"running",null),(0,a._)([(0,f.Cb)()],O.prototype,"defaultVisibility",null),(0,a._)([(0,f.Cb)()],O.prototype,"_featureFilter",null),(0,a._)([(0,f.Cb)()],O.prototype,"_sceneFilter",null),(0,a._)([(0,f.Cb)()],O.prototype,"_floorFilter",null),(0,a._)([(0,f.Cb)()],O.prototype,"_timeExtent",null),(0,a._)([(0,f.Cb)()],O.prototype,"_compositedFeatureFilter",null),(0,a._)([(0,f.Cb)()],O.prototype,"_layerView",null),(0,a._)([(0,f.Cb)()],O.prototype,"_updateTask",void 0),(0,a._)([(0,f.Cb)()],O.prototype,"_updateRequested",void 0),O=(0,a._)([(0,C.j)("esri.views.3d.layers.support.FeatureVisibilityFilter")],O)},97445:(fe,se,i)=>{function T(w,R,L){if(!L||null==R)return null;if(!w)return function a(w,R){const L=R.toLowerCase();for(const l in w)if(l.toLowerCase()===L)return w[l];return null}(R,L);const l=w.get(L);return l?R[l.name]:null}i.d(se,{g:()=>T})},89765:(fe,se,i)=>{i.d(se,{E:()=>R});var T=i(62208),a=i(46367),w=i(35082);function R(L){const l=L.view.spatialReference,E=L.layer.fullExtent,H=(0,T.pC)(E)&&E.spatialReference;if((0,T.Wi)(E)||!H)return Promise.resolve(null);if(H.equals(l))return Promise.resolve(E.clone());const f=(0,a.iV)(E,l);return(0,T.pC)(f)?Promise.resolve(f):L.view.state.isLocal?(0,w.projectGeometry)(E,l,L.layer.portalItem).then(u=>!L.destroyed&&u?u:null).catch(()=>null):Promise.resolve(null)}},36967:(fe,se,i)=>{i.d(se,{g:()=>R});var T=i(61885),a=i(73234),w=i(28862);class R extends T.Z{constructor(){super(...arguments),this._set=new Set}clear(){if(this._set.size>0){const l=this.toArray();this._set.clear(),this.emit("after-changes",{type:a.y.REMOVE}),this.emit("change",{added:[],removed:l})}}get length(){return this._set.size}addMany(l){if(0!==l.length){for(const E of l)this._set.add(E);this.emit("after-changes",{type:a.y.ADD}),this.emit("change",{added:l,removed:[]})}}remove(l){this._set.delete(l)&&(this.emit("after-changes",{type:a.y.REMOVE}),this.emit("change",{added:[],removed:[l]}))}removeMany(l){const E=[];for(const H of l)this._set.delete(H)&&E.push(H);E.length>0&&(this.emit("after-changes",{type:a.y.REMOVE}),this.emit("change",{added:[],removed:E}))}toArray(){return[...this._set]}find(l){let E;return(0,w.f)(this._set,H=>!!l(H)&&(E=H,!0)),E}forEach(l){this._set.forEach(E=>l(E))}}},45611:(fe,se,i)=>{i.d(se,{Z:()=>m});var T=i(17626),a=i(14517),w=i(61885),R=i(80542),L=i(61996),l=i(63290),E=i(62208),H=i(60330),f=i(77712),C=(i(90912),i(85931),i(76898));let V=class extends((0,R.p)((0,L.IG)((0,H.v)(w.Z.EventedMixin(a.Z))))){constructor(h){super(h),this.layer=null,this.parent=null}initialize(){this.when().catch(h=>{if("layerview:create-error"!==h.name){const M=this.layer&&this.layer.id||"no id",O=this.layer&&this.layer.title||"no title";l.Z.getLogger(this.declaredClass).error("#resolve()",`Failed to resolve layer view (layer title: '${O}', id: '${M}')`,h)}})}get fullOpacity(){return(0,E.Pt)(this.get("layer.opacity"),1)*(0,E.Pt)(this.get("parent.fullOpacity"),1)}get suspended(){return!this.canResume()}get suspendInfo(){return this.getSuspendInfo()}get legendEnabled(){return!this.suspended&&!0===this.layer?.legendEnabled}get updating(){return!(!this.updatingHandles?.updating&&!this.isUpdating())}get updatingProgress(){return this.updating?0:1}get visible(){return!0===this.layer?.visible}set visible(h){this._overrideIfSome("visible",h)}canResume(){return this.visible&&this.layer?.loaded&&!this.parent?.suspended&&this.view?.ready||!1}getSuspendInfo(){const h=this.parent&&this.parent.suspended?this.parent.suspendInfo:{};return this.view&&this.view.ready||(h.viewNotReady=!0),this.layer&&this.layer.loaded||(h.layerNotLoaded=!0),this.visible||(h.layerInvisible=!0),h}isUpdating(){return!1}};(0,T._)([(0,f.Cb)()],V.prototype,"fullOpacity",null),(0,T._)([(0,f.Cb)()],V.prototype,"layer",void 0),(0,T._)([(0,f.Cb)()],V.prototype,"parent",void 0),(0,T._)([(0,f.Cb)({readOnly:!0})],V.prototype,"suspended",null),(0,T._)([(0,f.Cb)({readOnly:!0})],V.prototype,"suspendInfo",null),(0,T._)([(0,f.Cb)({readOnly:!0})],V.prototype,"legendEnabled",null),(0,T._)([(0,f.Cb)({type:Boolean,readOnly:!0})],V.prototype,"updating",null),(0,T._)([(0,f.Cb)({readOnly:!0})],V.prototype,"updatingProgress",null),(0,T._)([(0,f.Cb)()],V.prototype,"visible",null),(0,T._)([(0,f.Cb)()],V.prototype,"view",void 0),V=(0,T._)([(0,C.j)("esri.views.layers.LayerView")],V);const m=V}}]);