"use strict";(self.webpackChunkpredio360_app=self.webpackChunkpredio360_app||[]).push([[4749,5611],{34749:(ie,K,s)=>{s.r(K),s.d(K,{default:()=>Ue});var n=s(15861),u=s(17626),L=s(88879),g=s(77712),C=(s(90912),s(85931),s(76898));let P=class extends L.Z{constructor(){super(...arguments),this.isAggregate=!0}getEffectivePopupTemplate(e=!1){if(this.popupTemplate)return this.popupTemplate;const t=this.sourceLayer&&this.sourceLayer.featureReduction;return t&&"popupTemplate"in t&&t.popupEnabled?t.popupTemplate:null}getObjectId(){return this.attributes.aggregateId}};(0,u._)([(0,g.Cb)({type:Boolean})],P.prototype,"isAggregate",void 0),P=(0,u._)([(0,C.j)("esri.AggregateGraphic")],P);const x=P;s(29132);var j=s(46160),N=s(26584),m=s(8314),H=s(58817),f=s(63290),c=s(62208),I=s(10699),q=s(32917),G=s(14517),k=s(52884);let A=class extends G.Z{constructor(e){super(e),this._filter=null,this.duration=(0,m.Z)("mapview-transitions-duration"),this._excludedEffectView=new k.AM(e),this._includedEffectView=new k.AM(e)}get excludedEffects(){return this._excludedEffectView.effects}set featureEffect(e){this._get("featureEffect")!==e&&this._transitionTo(e)}get filter(){return this._filter||(0,c.Wg)(this.featureEffect)?.filter||null}get hasEffects(){return this._excludedEffectView.hasEffects||this._includedEffectView.hasEffects}get includedEffects(){return this._includedEffectView.effects}set scale(e){this._set("scale",e),this._excludedEffectView.scale=e,this._includedEffectView.scale=e}get transitioning(){return this._excludedEffectView.transitioning||this._includedEffectView.transitioning}transitionStep(e,t){this._set("scale",t),this.transitioning?(this._includedEffectView.transitionStep(e,t),this._excludedEffectView.transitionStep(e,t),this.transitioning||(this._filter=null)):(this._excludedEffectView.scale=t,this._includedEffectView.scale=t)}endTransitions(){this._includedEffectView.endTransitions(),this._excludedEffectView.endTransitions(),this._filter=null}_transitionTo(e){const t=this._get("featureEffect"),r=(0,c.Wg)(e),i=(0,c.Wg)(r?.includedEffect),o=(0,c.Wg)(r?.excludedEffect),d=this._includedEffectView.canTransitionTo(i)&&this._excludedEffectView.canTransitionTo(o);this._includedEffectView.effect=i,this._excludedEffectView.effect=o,this._set("featureEffect",r),this._filter=r?.filter||t?.filter||null,d||this.endTransitions()}};(0,u._)([(0,g.Cb)()],A.prototype,"_filter",void 0),(0,u._)([(0,g.Cb)()],A.prototype,"_excludedEffectView",void 0),(0,u._)([(0,g.Cb)()],A.prototype,"_includedEffectView",void 0),(0,u._)([(0,g.Cb)()],A.prototype,"duration",void 0),(0,u._)([(0,g.Cb)()],A.prototype,"excludedEffects",null),(0,u._)([(0,g.Cb)()],A.prototype,"featureEffect",null),(0,u._)([(0,g.Cb)()],A.prototype,"filter",null),(0,u._)([(0,g.Cb)()],A.prototype,"hasEffects",null),(0,u._)([(0,g.Cb)()],A.prototype,"includedEffects",null),(0,u._)([(0,g.Cb)({value:0})],A.prototype,"scale",null),(0,u._)([(0,g.Cb)()],A.prototype,"transitioning",null),A=(0,u._)([(0,C.j)("esri.layers.effects.FeatureEffectView")],A);const se=A;var ee=s(98624),M=s(72469),a=s(68653),h=s(17253),l=s(65234);let b=class extends h.Z{constructor(){super(...arguments),this.features=[]}readFeatures(e,t){const r=l.Z.fromJSON(t.spatialReference),i=[];for(let o=0;o<e.length;o++){const d=e[o],y=x.fromJSON(d),R=d.geometry&&d.geometry.spatialReference;(0,c.pC)(y.geometry)&&!R&&(y.geometry.spatialReference=r);const S=d.aggregateGeometries,F=y.aggregateGeometries;if(S&&(0,c.pC)(F))for(const T in F){const V=F[T],J=S[T]?.spatialReference;(0,c.pC)(V)&&!J&&(V.spatialReference=r)}i.push(y)}return i}};(0,u._)([(0,g.Cb)({type:[x],json:{write:!0}})],b.prototype,"features",void 0),(0,u._)([(0,a.r)("features")],b.prototype,"readFeatures",null),b=(0,u._)([(0,C.j)("esri.rest.support.AggregateFeatureSet")],b);const D=b;var W=s(96854),O=s(39351),v=s(37384),p=s(49391);function E(){return(E=(0,n.Z)(function*(e,t){if(!e)return null;switch(e.type){case"symbol":return new((yield Promise.all([s.e(5023),s.e(4589),s.e(8592),s.e(978)]).then(s.bind(s,58803))).default)(t);case"heatmap":return new((yield Promise.all([s.e(5023),s.e(4589),s.e(8592),s.e(2900)]).then(s.bind(s,32900))).default)(t)}})).apply(this,arguments)}var w=s(22418),Y=s(62192),ye=s(71251);function ue(e){return e.some(t=>t.globalId)}function ne(e){return e.filter(t=>!t.error).map(t=>t.objectId??t.globalId).filter(t=>null!=t)}function de(e,t){const r=new Set(e);for(const i of t.values())r.add(i);return r}function ce(e,t){const r=new Set(e);for(const i of t.values())r.delete(i);return r}let oe=class extends G.Z{constructor(e){super(e),this._hasGlobalIds=!1,this._notifyUpdating=()=>{this.notifyChange("updating")}}normalizeCtorArgs(e){return this._queueProcessor=new ye.e({concurrency:1,process:e.process}),{}}destroy(){this.clear()}get updating(){return this._queueProcessor.length>0}clear(){this._queueProcessor.clear()}push(e){const t=this._queueProcessor,r=t.last();switch(e.type){case"update":case"refresh":if(r?.type===e.type)return;t.push(e).then(this._notifyUpdating,this._notifyUpdating);break;case"edit":{const i="processed-edit"===r?.type?r:null;i&&t.popLast();const o=this._mergeEdits(i,e);for(const d of o)d&&t.push(d).then(this._notifyUpdating,this._notifyUpdating);break}}this.notifyChange("updating")}_mergeEdits(e,t){const{addedFeatures:r,deletedFeatures:i,updatedFeatures:o}=t.edits;if(this._hasGlobalIds=this._hasGlobalIds||ue(r)||ue(o)||ue(i),this._hasGlobalIds)return[e,{type:"processed-edit",edits:{addOrModified:[...r,...o],removed:i}}];const d=new Set(ne(e?.edits.addOrModified??[])),y=new Set(ne(e?.edits.removed??[])),R=new Set([...ne(r),...ne(o)]),S=new Set(ne(i));return[{type:"processed-edit",edits:{addOrModified:Array.from(de(ce(d,S),R)).map(F=>({objectId:F})),removed:Array.from(de(ce(y,R),S)).map(F=>({objectId:F}))}}]}};(0,u._)([(0,g.Cb)({readOnly:!0})],oe.prototype,"updating",null),(0,u._)([(0,g.Cb)()],oe.prototype,"process",void 0),oe=(0,u._)([(0,C.j)("esri.views.2d.layers.support.FeatureCommandQueue")],oe);const fe=oe;var ge=s(60330),_e=s(59289);let te=class extends ge.D{constructor(e){super(e),this._startupResolver=(0,I.hh)(),this.isReady=!1}initialize(){this._controller=new AbortController,this.addResolvingPromise(this._startWorker(this._controller.signal))}destroy(){this._controller.abort(),this._connection&&this._connection.close()}set tileRenderer(e){this.client.tileRenderer=e}get closed(){return this._connection.closed}startup(e,t,r,i){var o=this;return(0,n.Z)(function*(){yield o.when();const d=o._controller.signal,y=function ve(e){return Array.isArray(e)}(r.source)?{transferList:r.source,signal:d}:void 0,R={service:r,config:t,tileInfo:e.tileInfo.toJSON(),tiles:i};yield o._connection.invoke("startup",R,y),o._startupResolver.resolve(),o._set("isReady",!0)})()}updateTiles(e){var t=this;return(0,n.Z)(function*(){return yield t._startupResolver.promise,(0,I.R8)(t._connection.invoke("updateTiles",e))})()}update(e){var t=this;return(0,n.Z)(function*(){const r={config:e};return yield t._startupResolver.promise,t._connection.invoke("update",r)})()}applyUpdate(e){var t=this;return(0,n.Z)(function*(){return yield t._startupResolver.promise,t._connection.invoke("applyUpdate",e)})()}setHighlight(e){var t=this;return(0,n.Z)(function*(){return yield t._startupResolver.promise,(0,I.R8)(t._connection.invoke("controller.setHighlight",e))})()}stop(){var e=this;return(0,n.Z)(function*(){if(yield e._startupResolver.promise,!e.closed)return(0,I.R8)(e._connection.invoke("stop"))})()}refresh(e){var t=this;return(0,n.Z)(function*(){return yield t._startupResolver.promise,(0,I.R8)(t._connection.invoke("controller.refresh",e))})()}querySummaryStatistics(e,t,r){var i=this;return(0,n.Z)(function*(){return yield i._startupResolver.promise,i._connection.invoke("controller.querySummaryStatistics",{query:e.toJSON(),params:t},r)})()}queryAggregateSummaryStatistics(e,t,r){var i=this;return(0,n.Z)(function*(){return yield i._startupResolver.promise,i._connection.invoke("controller.queryAggregateSummaryStatistics",{query:e.toJSON(),params:t},r)})()}queryUniqueValues(e,t,r){var i=this;return(0,n.Z)(function*(){return yield i._startupResolver.promise,i._connection.invoke("controller.queryUniqueValues",{query:e.toJSON(),params:t},r)})()}queryAggregateUniqueValues(e,t,r){var i=this;return(0,n.Z)(function*(){return yield i._startupResolver.promise,i._connection.invoke("controller.queryAggregateUniqueValues",{query:e.toJSON(),params:t},r)})()}queryClassBreaks(e,t,r){var i=this;return(0,n.Z)(function*(){return yield i._startupResolver.promise,i._connection.invoke("controller.queryClassBreaks",{query:e.toJSON(),params:t},r)})()}queryAggregateClassBreaks(e,t,r){var i=this;return(0,n.Z)(function*(){return yield i._startupResolver.promise,i._connection.invoke("controller.queryAggregateClassBreaks",{query:e.toJSON(),params:t},r)})()}queryHistogram(e,t,r){var i=this;return(0,n.Z)(function*(){return yield i._startupResolver.promise,i._connection.invoke("controller.queryHistogram",{query:e.toJSON(),params:t},r)})()}queryAggregateHistogram(e,t,r){var i=this;return(0,n.Z)(function*(){return yield i._startupResolver.promise,i._connection.invoke("controller.queryAggregateHistogram",{query:e.toJSON(),params:t},r)})()}queryFeatures(e,t){var r=this;return(0,n.Z)(function*(){return yield r._startupResolver.promise,r._connection.invoke("controller.queryFeatures",e?.toJSON(),t)})()}queryVisibleFeatures(e,t){var r=this;return(0,n.Z)(function*(){return yield r._startupResolver.promise,r._connection.invoke("controller.queryVisibleFeatures",e?.toJSON(),t)})()}queryObjectIds(e,t){var r=this;return(0,n.Z)(function*(){return yield r._startupResolver.promise,r._connection.invoke("controller.queryObjectIds",e?.toJSON(),t)})()}queryFeatureCount(e,t){var r=this;return(0,n.Z)(function*(){return yield r._startupResolver.promise,r._connection.invoke("controller.queryFeatureCount",e?.toJSON(),t)})()}queryExtent(e,t){var r=this;return(0,n.Z)(function*(){return r._connection.invoke("controller.queryExtent",e.toJSON(),t)})()}queryLatestObservations(e,t){var r=this;return(0,n.Z)(function*(){return yield r._startupResolver.promise,r._connection.invoke("controller.queryLatestObservations",e.toJSON(),t)})()}queryStatistics(e){var t=this;return(0,n.Z)(function*(){return yield t._startupResolver.promise,t._connection.invoke("controller.queryStatistics",e)})()}queryAggregates(e,t){var r=this;return(0,n.Z)(function*(){return yield r._startupResolver.promise,r._connection.invoke("controller.queryAggregates",e?.toJSON(),t)})()}queryAggregateCount(e,t){var r=this;return(0,n.Z)(function*(){return yield r._startupResolver.promise,r._connection.invoke("controller.queryAggregateCount",e?.toJSON(),t)})()}queryAggregateIds(e,t){var r=this;return(0,n.Z)(function*(){return yield r._startupResolver.promise,r._connection.invoke("controller.queryAggregateIds",e?.toJSON(),t)})()}getObjectId(e){var t=this;return(0,n.Z)(function*(){return yield t._startupResolver.promise,t._connection.invoke("controller.getObjectId",e)})()}getDisplayId(e){var t=this;return(0,n.Z)(function*(){return yield t._startupResolver.promise,t._connection.invoke("controller.getDisplayId",e)})()}getFeatures(e){var t=this;return(0,n.Z)(function*(){return yield t._startupResolver.promise,t._connection.invoke("controller.getFeatures",e)})()}getAggregates(){var e=this;return(0,n.Z)(function*(){return yield e._startupResolver.promise,e._connection.invoke("controller.getAggregates")})()}getAggregateValueRanges(){var e=this;return(0,n.Z)(function*(){return yield e._startupResolver.promise,e._connection.invoke("controller.getAggregateValueRanges")})()}mapValidDisplayIds(e){var t=this;return(0,n.Z)(function*(){return yield t._startupResolver.promise,t._connection.invoke("controller.mapValidDisplayIds",e)})()}onEdits(e){var t=this;return(0,n.Z)(function*(){return yield t._startupResolver.promise,(0,I.R8)(t._connection.invoke("controller.onEdits",e))})()}enableEvent(e,t){var r=this;return(0,n.Z)(function*(){return yield r._startupResolver.promise,(0,I.R8)(r._connection.invoke("controller.enableEvent",{name:e,value:t}))})()}pauseStream(){var e=this;return(0,n.Z)(function*(){return yield e._startupResolver.promise,(0,I.R8)(e._connection.invoke("controller.pauseStream"))})()}resumeStream(){var e=this;return(0,n.Z)(function*(){return yield e._startupResolver.promise,(0,I.R8)(e._connection.invoke("controller.resumeStream"))})()}sendMessageToSocket(e){var t=this;return(0,n.Z)(function*(){return yield t._startupResolver.promise,(0,I.R8)(t._connection.invoke("controller.sendMessageToSocket",e))})()}sendMessageToClient(e){var t=this;return(0,n.Z)(function*(){return yield t._startupResolver.promise,(0,I.R8)(t._connection.invoke("controller.sendMessageToClient",e))})()}updateCustomParameters(e){var t=this;return(0,n.Z)(function*(){return yield t._startupResolver.promise,(0,I.R8)(t._connection.invoke("controller.updateCustomParameters",e))})()}_startWorker(e){var t=this;return(0,n.Z)(function*(){try{t._connection=yield(0,_e.bA)("Pipeline",{client:t.client,strategy:"dedicated",signal:e})}catch(r){(0,I.H9)(r)}})()}};(0,u._)([(0,g.Cb)()],te.prototype,"isReady",void 0),(0,u._)([(0,g.Cb)({constructOnly:!0})],te.prototype,"client",void 0),(0,u._)([(0,g.Cb)()],te.prototype,"tileRenderer",null),te=(0,u._)([(0,C.j)("esri.views.2d.layers.support.FeatureLayerProxy")],te);const me=te;var Ee=s(43930),Re=s(84378),he=s(58098);class be{constructor(t){this._tiles=new Map,this.buffer=0,this.acquireTile=t.acquireTile,this.releaseTile=t.releaseTile,this.tileInfoView=t.tileInfoView,this.buffer=t.buffer}destroy(){}clear(){this._tiles.forEach(t=>this._releaseTile(t))}tileKeys(){const t=[];return this._tiles.forEach((r,i)=>t.push(i)),t}update(t){const r=this.tileInfoView.getTileCoverage(t.state,this.buffer,"closest"),{spans:i,lodInfo:o}=r,{level:d}=o,y=[],R=[],S=new Set,F=new Set;for(const{row:T,colFrom:V,colTo:J}of i)for(let Q=V;Q<=J;Q++){const X=he.Z.getId(d,T,o.normalizeCol(Q),o.getWorldForColumn(Q)),z=this._getOrAcquireTile(y,X);S.add(X),z.isReady?z.visible=!0:F.add(z.key)}return F.forEach(T=>this._addPlaceholders(S,T)),this._tiles.forEach(T=>{S.has(T.key.id)||(R.push(T.key.id),this._releaseTile(T))}),Re.Z.pool.release(r),{hasMissingTiles:F.size>0,added:y,removed:R}}_getOrAcquireTile(t,r){if(!this._tiles.has(r)){const i=this.acquireTile(new he.Z(r));t.push(r),this._tiles.set(r,i),i.visible=!1}return this._tiles.get(r)}_getTile(t){return this._tiles.get(t)}_releaseTile(t){this._tiles.delete(t.key.id),this.releaseTile(t)}_addPlaceholders(t,r){const i=this._addPlaceholderChildren(t,r);Math.abs(1-i)<1e-6||this._addPlaceholderParent(t,r)||(this._getTile(r.id).visible=!0)}_addPlaceholderChildren(t,r){let i=0;return this._tiles.forEach(o=>{i+=this._addPlaceholderChild(t,o,r)}),i}_addPlaceholderChild(t,r,i){return r.key.level<=i.level||!r.hasData||!i.contains(r.key)?0:(r.visible=!0,t.add(r.key.id),1/(1<<2*(r.key.level-i.level)))}_addPlaceholderParent(t,r){let i=r.getParentKey(),o=0,d=null;for(;(0,c.pC)(i);){if(t.has(i.id))return!0;const y=this._getTile(i.id);if(y?.isReady){for(const R of t){const S=this._getTile(R);S&&i.contains(S.key)&&(S.visible=!1)}return y.visible=!0,t.add(y.key.id),!0}y?.hasData&&y.patchCount>o&&(o=y.patchCount,d=y),i=i.getParentKey()}return!!d&&(d.visible=!0,t.add(d.key.id),!0)}}var Oe=s(56482),Se=s(45611),Pe=s(94421),Ie=s(31637),Fe=s(2004);function pe(e){return e&&"openPorts"in e}let B=class extends((0,Oe.Z)((0,Pe.Z)((0,v.y)(Se.Z)))){constructor(){var e;super(...arguments),e=this,this._pipelineIsUpdating=!0,this._commandsQueue=new fe({process:t=>{switch(t.type){case"processed-edit":return this._doEdit(t);case"refresh":return this._doRefresh(t.dataChanged);case"update":return this._doUpdate()}}}),this._visibilityOverrides=new Set,this._highlightIds=new Map,this._updateHighlight=(0,I.Ds)((0,n.Z)(function*(){return e._proxy.setHighlight(Array.from(e._highlightIds.keys()))})),this._uploadsLocked=!1,this._needsClusterSizeUpdate=!1,this.featureEffectView=new se,this._lastDefinitionExpression=null}destroy(){(0,c.yw)(this._updateClusterSizeTask,e=>e.remove()),this._proxy?.destroy(),this._commandsQueue.destroy()}initialize(){this.addResolvingPromise(Promise.all([this._initProxy(),this._initServiceOptions()])),this.addHandles([this.on("valueRangesChanged",e=>{this._set("_aggregateValueRanges",e.valueRanges)}),(0,q.YP)(()=>this.featureEffect,e=>{this.featureEffectView.featureEffect=e},q.tX)],"constructor"),this.featureEffectView.endTransitions()}_initProxy(){var e=this;return(0,n.Z)(function*(){const t=e.layer;if("isTable"in t&&t.isTable)throw new N.Z("featurelayerview:table-not-supported","table feature layer can't be displayed",{layer:e.layer});if(("feature"===t.type||"subtype-group"===t.type)&&!(0,M.S1)(t)?.operations.supportsQuery)throw new N.Z("featurelayerview:query-not-supported","layer view requires a layer with query capability",{layer:t});e._proxy&&e._proxy.destroy();const r=e._createClientOptions();return e._set("_proxy",new me({client:r})),e._proxy.when()})()}_initServiceOptions(){var e=this;return(0,n.Z)(function*(){return e._set("_serviceOptions",yield e._createServiceOptions()),e._serviceOptions})()}get _effectiveFeatureReduction(){if(!("featureReduction"in this.layer))return null;const e=this.layer.featureReduction;return e&&(!("maxScale"in e)||!e.maxScale||e.maxScale<this.view.scale)?e:null}get orderByFields(){return"stream"!==this._serviceOptions?.type?this._serviceOptions?.orderByFields:void 0}get labelsVisible(){return!this.suspended&&("subtype-group"===this.layer.type?this.layer.sublayers.items:[this.layer]).some(t=>t.labelingInfo&&t.labelsVisible)}get queryMode(){return this._serviceOptions?.type}get renderingConfigHash(){if(!this.layer)return null;const e=this.availableFields,t=this.layer,r=this.view.floors,{definitionExpression:i}=t,o="subtype-group"!==this.layer.type&&this.layer.labelsVisible&&this.layer.labelingInfo,d="renderer"in t&&t.renderer,y="gdbVersion"in t?t.gdbVersion:void 0,R="historicMoment"in t?t.historicMoment?.getTime():void 0,{timeExtent:S}=this,F="customParameters"in t?JSON.stringify(t.customParameters):void 0,T="apiKey"in t?t.apiKey:void 0,V="stream"===t.type?`${JSON.stringify(t.geometryDefinition)}${t.definitionExpression}`:null,J=JSON.stringify(this.clips),Q=this._effectiveFeatureReduction?.toJSON(),X="orderBy"in this.layer&&JSON.stringify(this.layer.orderBy),z="sublayers"in this.layer&&this.layer.sublayers.items.reduce((re,le)=>re+`${le.visible?1:0}.${JSON.stringify(le.renderer)}.${le.labelsVisible}\n.${JSON.stringify(le.labelingInfo)}`,"");return JSON.stringify({orderBy:X,sublayerHash:z,subtypeCode:"subtypeCode"in this.layer&&this.layer.subtypeCode,filterHash:(0,c.pC)(this.filter)&&this.filter.toJSON(),effectHash:(0,c.pC)(this.featureEffect)&&this.featureEffect.toJSON(),streamFilter:V,gdbVersion:y,definitionExpression:i,historicMoment:R,availableFields:e,renderer:d,labelingInfo:o,timeExtent:S,floors:r,clipsHash:J,featureReduction:Q,customParameters:F,apiKey:T})}highlight(e){let t;e instanceof L.Z?t=[e.getObjectId()]:"number"==typeof e||"string"==typeof e?t=[e]:j.Z.isCollection(e)&&e.length>0?t=e.map(i=>i?.getObjectId()).toArray():Array.isArray(e)&&e.length>0&&(t="number"==typeof e[0]||"string"==typeof e[0]?e:e.map(i=>i?.getObjectId()));const r=t?.filter(c.pC);return r&&r.length?(this._addHighlight(r),{remove:()=>this._removeHighlight(r)}):{remove:()=>{}}}hasHighlight(){return!!this._highlightIds.size}hitTest(e,t){var r=this;return(0,n.Z)(function*(){if(!r.tileRenderer)return null;const i=yield r.tileRenderer.hitTest(t);if(0===i.length)return null;const{features:o,aggregates:d}=yield r._proxy.getFeatures(i);return[...d.map(y=>r._createGraphicHit(e,x.fromJSON(y))),...o.map(y=>r._createGraphicHit(e,L.Z.fromJSON(y)))]})()}queryStatistics(){return this._proxy.queryStatistics()}querySummaryStatistics(e,t,r){var i=this;return(0,n.Z)(function*(){const o={...t,scale:i.view.scale};return i._proxy.querySummaryStatistics(i._cleanUpQuery(e),o,r)})()}queryAggregateSummaryStatistics(e,t,r){var i=this;return(0,n.Z)(function*(){const o={...t,scale:i.view.scale};return i._proxy.queryAggregateSummaryStatistics(i._cleanUpAggregateQuery(e),o,r)})()}queryUniqueValues(e,t,r){var i=this;return(0,n.Z)(function*(){const o={...t,scale:i.view.scale};return i._proxy.queryUniqueValues(i._cleanUpQuery(e),o,r)})()}queryAggregateUniqueValues(e,t,r){var i=this;return(0,n.Z)(function*(){const o={...t,scale:i.view.scale};return i._proxy.queryAggregateUniqueValues(i._cleanUpAggregateQuery(e),o,r)})()}queryClassBreaks(e,t,r){var i=this;return(0,n.Z)(function*(){const o={...t,scale:i.view.scale};return i._proxy.queryClassBreaks(i._cleanUpQuery(e),o,r)})()}queryAggregateClassBreaks(e,t,r){var i=this;return(0,n.Z)(function*(){const o={...t,scale:i.view.scale};return i._proxy.queryAggregateClassBreaks(i._cleanUpAggregateQuery(e),o,r)})()}queryHistogram(e,t,r){var i=this;return(0,n.Z)(function*(){const o={...t,scale:i.view.scale};return i._proxy.queryHistogram(i._cleanUpQuery(e),o,r)})()}queryAggregateHistogram(e,t,r){var i=this;return(0,n.Z)(function*(){const o={...t,scale:i.view.scale};return i._proxy.queryAggregateHistogram(i._cleanUpAggregateQuery(e),o,r)})()}queryFeatures(e,t){return this.queryFeaturesJSON(e,t).then(r=>{const i=h.Z.fromJSON(r);return i.features.forEach(o=>this._setLayersForFeature(o)),i})}queryVisibleFeatures(e,t){return this._proxy.queryVisibleFeatures(this._cleanUpQuery(e),t).then(r=>{const i=h.Z.fromJSON(r);return i.features.forEach(o=>this._setLayersForFeature(o)),i})}queryAggregates(e,t){var r=this;return(0,n.Z)(function*(){const i=yield r._proxy.queryAggregates(r._cleanUpAggregateQuery(e),t),o=D.fromJSON(i);return o.features.forEach(d=>r._setLayersForFeature(d)),o})()}queryAggregateIds(e,t){return this._proxy.queryAggregateIds(this._cleanUpAggregateQuery(e),t)}queryAggregateCount(e,t){return this._proxy.queryAggregateCount(this._cleanUpAggregateQuery(e),t)}queryAggregateJSON(e,t){return this._proxy.queryAggregates(this._cleanUpAggregateQuery(e),t)}queryFeaturesJSON(e,t){return this._proxy.queryFeatures(this._cleanUpQuery(e),t)}queryObjectIds(e,t){return this._proxy.queryObjectIds(this._cleanUpQuery(e),t)}queryFeatureCount(e,t){return this._proxy.queryFeatureCount(this._cleanUpQuery(e),t)}queryExtent(e,t){return this._proxy.queryExtent(this._cleanUpQuery(e),t).then(r=>({count:r.count,extent:Fe.Z.fromJSON(r.extent)}))}setVisibility(e,t){t?this._visibilityOverrides.delete(e):this._visibilityOverrides.add(e),this._update()}update(e){if(!this._tileStrategy||!this.tileRenderer)return;const{hasMissingTiles:t,added:r,removed:i}=this._tileStrategy.update(e);(r.length||i.length)&&this._proxy.updateTiles({added:r,removed:i}),t&&this.requestUpdate(),this.notifyChange("updating")}attach(){this.view.timeline.record(`${this.layer.title} (FeatureLayer) Attach`),this._tileStrategy=new be({acquireTile:e=>this._acquireTile(e),releaseTile:e=>this._releaseTile(e),tileInfoView:this.view.featuresTilingScheme,buffer:0}),this.addAttachHandles((0,q.YP)(()=>this.renderingConfigHash,()=>this._update(),q.nn)),"stream"!==this.layer.type&&this.addAttachHandles(this.layer.on("edits",e=>this._edit(e)))}detach(){this._commandsQueue.clear(),this._proxy?.stop(),this.container.removeAllChildren(),this.tileRenderer?.uninstall(this.container),this.tileRenderer=null,this._tileStrategy=(0,c.SC)(this._tileStrategy),this._tileRendererHash=null}moveStart(){this.requestUpdate()}viewChange(){this.requestUpdate()}moveEnd(){this.requestUpdate()}isUpdating(){const e="renderer"in this.layer&&null!=this.layer.renderer,t=this._commandsQueue.updating,r=null!=this._updatingRequiredFieldsPromise,i=!this._proxy||!this._proxy.isReady,o=this._pipelineIsUpdating,d=null==this.tileRenderer||this.tileRenderer?.updating,y=e&&(t||r||i||o||d);return(0,m.Z)("esri-2d-log-updating")&&console.log(`Updating FLV2D: ${y}\n  -> hasRenderer ${e}\n  -> hasPendingCommand ${t}\n  -> updatingRequiredFields ${r}\n  -> updatingProxy ${i}\n  -> updatingPipeline ${o}\n  -> updatingTileRenderer ${d}\n`),y}_createClientOptions(){return{setUpdating:e=>{this._set("_pipelineIsUpdating",e)},emitEvent:e=>{this.emit(e.name,e.event)}}}_detectQueryMode(e){var t=this;return(0,n.Z)(function*(){const r="path"in e,{layer:i}=t,y=!("editingInfo"in i&&i.editingInfo?.lastEditDate)&&"refreshInterval"in i&&!!i.refreshInterval,R=(0,M.S1)(i);if(r&&("feature"===i.type||"subtype-group"===i.type)&&"point"===i.geometryType&&R?.query.supportsPagination&&!R?.operations.supportsEditing&&!y&&(0,m.Z)("featurelayer-snapshot-enabled"))try{const S=yield i.queryFeatureCount();if(S<=(0,m.Z)("featurelayer-snapshot-point-min-threshold"))return{mode:"snapshot",featureCount:S};const F=(0,m.Z)("featurelayer-snapshot-point-max-threshold"),T=(0,m.Z)("featurelayer-snapshot-point-coverage"),V=t.view.extent,J=(0,c.Wg)(i.fullExtent),Q=J?.clone().intersection(V),X=(0,c.pC)(Q)?Q.width*Q.height:0,z=J?.width*J?.height;if(S<=F&&(0===z?0:X/z)>=T)return{mode:"snapshot",featureCount:S}}catch(S){f.Z.getLogger(t.declaredClass).warn("mapview-feature-layer","Encountered an error when querying for featureCount",{error:S})}return{mode:"on-demand"}})()}_createServiceOptions(){var e=this;return(0,n.Z)(function*(){const t=e.layer;if("stream"===t.type)return null;const r=(0,M.S1)(t),{capabilities:i,objectIdField:o}=t,d=t.fields.map(re=>re.toJSON()),y=(0,c.pC)(t.fullExtent)?t.fullExtent.toJSON():null,R=(0,Ee.oq)(t.geometryType),S="timeInfo"in t&&t.timeInfo&&t.timeInfo.toJSON()||null,F=t.spatialReference?t.spatialReference.toJSON():null,T="feature"===t.type?t.globalIdField:null;let V;"ogc-feature"===t.type?V=t.source.getSource():pe(t.source)?V=yield t.source.openPorts():t.parsedUrl&&(V=(0,H.d9)(t.parsedUrl),"dynamicDataSource"in t&&t.dynamicDataSource&&(V.query={layer:JSON.stringify({source:t.dynamicDataSource})}));const J="datesInUnknownTimezone"in e.layer&&e.layer.datesInUnknownTimezone,Q=("subtypeField"in e.layer?e.layer.subtypeField:null)??null,{mode:X,featureCount:z}=yield e._detectQueryMode(V);let ae=e.layer.objectIdField;if("feature"===e.layer.type&&(0,c.pC)(e.layer.orderBy)&&e.layer.orderBy.length){const re=!e.layer.orderBy[0].valueExpression&&e.layer.orderBy[0].field;re&&(ae=re)}return{type:X,timeReferenceUnknownClient:J,subtypeField:Q,featureCount:z,globalIdField:T,maxRecordCount:i.query.maxRecordCount,tileMaxRecordCount:i.query.tileMaxRecordCount,capabilities:i,effectiveCapabilities:r,fields:d,fullExtent:y,geometryType:R,objectIdField:o,source:V,timeInfo:S,spatialReference:F,orderByFields:ae,datesInUnknownTimezone:J,dateFieldsTimeReference:("dateFieldsTimeReference"in e.layer?e.layer.dateFieldsTimeReference?.toJSON():null)||null,preferredTimeReference:("preferredTimeReference"in e.layer?e.layer.preferredTimeReference?.toJSON():null)||null,editFieldsInfo:"editFieldsInfo"in e.layer?e.layer.editFieldsInfo?.toJSON():null}})()}_createMemoryServiceOptions(e){var t=this;return(0,n.Z)(function*(){const r=yield e.openPorts();return{...t._createServiceOptions(),type:"memory",source:r}})()}_cleanUpQuery(e){const t=W.Z.from(e)||this.createQuery();return t.outSpatialReference||(t.outSpatialReference=this.view.spatialReference),t}_cleanUpAggregateQuery(e){const t=W.Z.from(e)||this.createAggregateQuery();return t.outSpatialReference||(t.outSpatialReference=this.view.spatialReference),t}_update(){var e=this;return(0,n.Z)(function*(){return e._commandsQueue.push({type:"update"})})()}_edit(e){var t=this;return(0,n.Z)(function*(){return t.suspended?void t._clearTiles():t._validateEdit(e)?t._commandsQueue.push({type:"edit",edits:e}):void 0})()}doRefresh(e){var t=this;return(0,n.Z)(function*(){if(t.attached&&t._tileStrategy.tileKeys().length)return t.suspended&&e?void t._clearTiles():t._commandsQueue.push({type:"refresh",dataChanged:e})})()}_clearTiles(){this._tileStrategy.tileKeys().length&&(this._proxy.updateTiles({added:[],removed:this._tileStrategy.tileKeys()}),this._tileStrategy.clear(),this.requestUpdate(),this._commandsQueue.clear(),this._update())}_validateEdit(e){const t="globalIdField"in this.layer&&this.layer.globalIdField,r=e.deletedFeatures.some(o=>-1===o.objectId||!o.objectId),i=t&&this.availableFields.includes(t);return r&&!i?(f.Z.getLogger(this.declaredClass).error(new N.Z("mapview-apply-edits",`Editing the specified service requires the layer's globalIdField, ${t} to be included the layer's outFields for updates to be reflected on the map`)),null):e}_doUpdate(){var e=this;return(0,n.Z)(function*(){try{if(e.destroyed||!e._hasRequiredSupport(e.layer)||!e._tileStrategy)return;const{featureEffectView:t,filter:r}=e;if(yield e._updateRequiredFields(),e.destroyed)return;const{renderer:i}=e._getEffectiveRenderer();e._set("_effectiveRenderer",i);const o=e._createSchemaConfig(),d=e._createConfiguration(o,r,t.filter),y=e._lastDefinitionExpression!==d.schema.source.definitionExpression;e._lastDefinitionExpression=d.schema.source.definitionExpression;const R=d.schema.tileRenderer,S=e._createTileRendererHash(R);if("snapshot"===e._serviceOptions.type&&(d.schema.source.initialFeatureCount=e._serviceOptions.featureCount),S!==e._tileRendererHash){yield e._initTileRenderer(R,i);const F=e.layer,T="stream"===F.type?yield e._initServiceOptions():e._serviceOptions;e.tileRenderer.onConfigUpdate(i),"stream"!==F.type&&pe(F.source)&&(T.source=yield F.source.openPorts());const V={added:e._tileStrategy.tileKeys(),removed:[]};yield e._proxy.startup(e.view.featuresTilingScheme,d,T,V),e.hasHighlight()&&(yield e._proxy.setHighlight(Array.from(e._highlightIds.keys()))),yield e._onceTilesUpdated(),e.tileRenderer.onConfigUpdate(i)}else{"snapshot"===e._serviceOptions.type&&y&&(d.schema.source.changedFeatureCount=yield e.layer.queryFeatureCount());const F=yield e._proxy.update(d);(F.mesh||F.targets?.aggregate)&&e._lockGPUUploads();try{yield e._proxy.applyUpdate(F)}catch(T){(0,I.D_)(T)||f.Z.getLogger(e.declaredClass).error(T)}(F.mesh||F.targets?.aggregate)&&e._unlockGPUUploads(),e.tileRenderer.onConfigUpdate(i),e._updateClusterSizeVariable(),e._forceAttributeTextureUpload()}e._tileRendererHash=S,e.tileRenderer.invalidateLabels(),e.requestUpdate()}catch{}})()}_doEdit(e){var t=this;return(0,n.Z)(function*(){try{yield t._proxy.onEdits(e)}catch(r){(0,I.D_)(r)}})()}_doRefresh(e){var t=this;return(0,n.Z)(function*(){t._lockGPUUploads();try{let r;e&&"snapshot"===t.queryMode&&"queryFeatureCount"in t.layer&&(r=yield t.layer.queryFeatureCount()),yield t._proxy.refresh({dataChanged:e,featureCount:r})}catch(r){(0,I.D_)(r)}t._unlockGPUUploads(),t._effectiveFeatureReduction&&t._updateClusterSizeVariable()})()}_updateClusterSizeVariable(){this._needsClusterSizeUpdate&&(this.tileRenderer.onConfigUpdate(this._effectiveRenderer),this._needsClusterSizeUpdate=!1)}_createUpdateClusterSizeTask(e,t){return(0,q.YP)(()=>this._aggregateValueRanges,r=>{this._updateClusterEffectiveRendererSizeVariable(e,t,r),this._needsClusterSizeUpdate=!0,this._uploadsLocked||this._updateClusterSizeVariable()})}_updateClusterEffectiveRendererSizeVariable(e,t,r){var i=this;return(0,n.Z)(function*(){if(e.dynamicClusterSize&&"visualVariables"in e&&e.visualVariables){const o=(0,Y.os)(e.visualVariables);if((0,c.pC)(o)&&"cluster_count"===o.field){const d=e.visualVariables.indexOf(o);e.visualVariables[d]=(0,Y.aV)(t,r);const y=e.clone();y.dynamicClusterSize=!0,i._set("_effectiveRenderer",y)}}})()}_getEffectiveRenderer(){const e=this.layer,t="renderer"in e?e.renderer:null,r=this._effectiveFeatureReduction;if(this._updateClusterSizeTask=(0,c.hw)(this._updateClusterSizeTask),r&&"renderer"in r&&r.renderer&&!r.renderer.authoringInfo?.isAutoGenerated){const i=r.fields;if("cluster"===r.type){const{renderer:o,didInject:d}=(0,Y.st)(r.renderer,r,this._aggregateValueRanges);return d&&(this._updateClusterSizeTask=this._createUpdateClusterSizeTask(o,r)),{renderer:o,aggregateFields:i,featureReduction:r}}return{renderer:r.renderer,aggregateFields:i,featureReduction:r}}if(r&&"cluster"===r.type&&t&&(0,Y.yR)(t)){const i=r,o=[],d=(0,Y.S1)(o,t,i,this._aggregateValueRanges,!0);return this._updateClusterSizeTask=this._createUpdateClusterSizeTask(d,i),{renderer:d,aggregateFields:o,featureReduction:r}}return{renderer:t,aggregateFields:[],featureReduction:null}}_acquireTile(e){const t=this.tileRenderer.acquireTile(e);return t.once("attach",()=>{this.requestUpdate()}),t}_releaseTile(e){this.tileRenderer.releaseTile(e)}_initTileRenderer(e,t){var r=this;return(0,n.Z)(function*(){const i=yield function Z(e,t){return E.apply(this,arguments)}(e,{layerView:r,tileInfoView:r.view.featuresTilingScheme,layer:r.layer});return r.tileRenderer&&(r._tileStrategy.clear(),r.tileRenderer.uninstall(r.container),r.tileRenderer=(0,c.SC)(r.tileRenderer)),r.destroyed?null:(r._proxy.tileRenderer=i,r._set("tileRenderer",i),r.tileRenderer.install(r.container),r.tileRenderer.onConfigUpdate(t),r.requestUpdate(),r.tileRenderer)})()}_createTileRendererHash(e){return`${e.type}`}get hasFilter(){return!!(this.filter||"floorInfo"in this.layer&&this.layer.floorInfo&&this.view.floors&&this.view.floors.length||this._visibilityOverrides.size||this.timeExtent)}_injectOverrides(e){const t=(0,c.pC)(e)?e.timeExtent:null,r=(0,c.pC)(this.timeExtent)&&(0,c.pC)(t)?this.timeExtent.intersection(t):this.timeExtent||t;let i=null;const o="floorInfo"in this.layer&&this.layer.floorInfo;if(o){const y=(0,c.pC)(e)?e.where:null;i=this._addFloorFilterClause(y)}if(!this._visibilityOverrides.size&&!r&&!o)return(0,c.pC)(e)?e.toJSON():null;(e=(0,c.pC)(e)&&e.clone()||new ee.Z).timeExtent=r,i&&(e.where=i);const d=e.toJSON();return d.hiddenIds=Array.from(this._visibilityOverrides),d}_addFloorFilterClause(e){const t=this.layer;let r=e||"";if("floorInfo"in t&&t.floorInfo){let i=this.view.floors;if(!i||!i.length)return r;t.floorInfo.viewAllLevelIds?.length&&(i=t.floorInfo.viewAllLevelIds);const o=i.filter(R=>""!==R).map(R=>"'"+R+"'");o.push("''");const d=t.floorInfo.floorField;let y="("+d+" IN ({ids}) OR "+d+" IS NULL)";if(y=y.replace("{ids}",o.join(", ")),(0,c.pC)(r)&&r.includes(d)){let R=new RegExp("AND \\("+d+".*NULL\\)","g");r=r.replace(R,""),R=new RegExp("\\("+d+".*NULL\\)","g"),r=r.replace(R,""),r=r.replace(/\s+/g," ").trim()}r=""!==r?"("+r+") AND "+y:y}return""!==r?r:null}_createConfiguration(e,t,r){const i="feature"===this.layer.type&&this.layer.historicMoment?this.layer.historicMoment.getTime():void 0,o="feature"===this.layer.type?this.layer.gdbVersion??void 0:void 0,d=new Array(O.m4),y=this._injectOverrides(t);d[0]=y,d[1]=(0,c.pC)(r)?r.toJSON():null;const R=(0,p.Ew)(e);if((0,c.Wi)(R))return null;const S=(0,Ie.hc)("2d");return{availableFields:this.availableFields,gdbVersion:o,historicMoment:i,devicePixelRatio:window.devicePixelRatio||1,filters:d,schema:R,supportsTextureFloat:S.supportsTextureFloat,maxTextureSize:S.maxTextureSize}}_hasRequiredSupport(e){return!("renderer"in e)||(0,w.TT)(e.renderer)}_onceTilesUpdated(){return this.requestUpdate(),(0,q.N1)(()=>!this._pipelineIsUpdating)}_lockGPUUploads(){this.tileRenderer&&(this._uploadsLocked=!0,this.tileRenderer.lockGPUUploads())}_unlockGPUUploads(){this.tileRenderer&&(this._uploadsLocked=!1,this.tileRenderer.unlockGPUUploads())}_forceAttributeTextureUpload(){this.tileRenderer&&this.tileRenderer.forceAttributeTextureUpload()}_createSchemaConfig(){const e=this.layer;return{renderer:"renderer"in e?e.renderer:null,spatialReference:e.spatialReference,timeExtent:"timeExtent"in e?e.timeExtent:null,definitionExpression:e.definitionExpression,featureReduction:this._effectiveFeatureReduction,fields:e.fields,geometryType:e.geometryType,historicMoment:"historicMoment"in e?e.historicMoment:null,labelsVisible:"labelsVisible"in e&&e.labelsVisible,labelingInfo:"labelingInfo"in e?e.labelingInfo:null,availableFields:this.availableFields,featureEffect:this.featureEffect,filter:this.filter,gdbVersion:"gdbVersion"in e?e.gdbVersion:null,pixelBuffer:0,orderBy:"orderBy"in e&&e.orderBy?e.orderBy:null,customParameters:{..."customParameters"in e?e.customParameters:void 0,token:"apiKey"in e?e.apiKey??void 0:void 0},subtypeCode:"subtypeCode"in e?e.subtypeCode:void 0,subtypeField:"subtypeField"in e?e.subtypeField:void 0}}_addHighlight(e){for(const t of e)if(this._highlightIds.has(t)){const r=this._highlightIds.get(t);this._highlightIds.set(t,r+1)}else this._highlightIds.set(t,1);this._updateHighlight().catch(t=>{(0,I.D_)(t)||f.Z.getLogger(this.declaredClass).error(t)})}_removeHighlight(e){for(const t of e)if(this._highlightIds.has(t)){const r=this._highlightIds.get(t)-1;0===r?this._highlightIds.delete(t):this._highlightIds.set(t,r)}this._updateHighlight().catch(t=>{(0,I.D_)(t)||f.Z.getLogger(this.declaredClass).error(t)})}_setLayersForFeature(e){const t=this.layer;e.layer=t,e.sourceLayer=t}_createGraphicHit(e,t){return this._setLayersForFeature(t),(0,c.pC)(t.geometry)&&(t.geometry.spatialReference=this.view.spatialReference),{type:"graphic",graphic:t,layer:this.layer,mapPoint:e}}};(0,u._)([(0,g.Cb)()],B.prototype,"_serviceOptions",void 0),(0,u._)([(0,g.Cb)()],B.prototype,"_proxy",void 0),(0,u._)([(0,g.Cb)()],B.prototype,"_pipelineIsUpdating",void 0),(0,u._)([(0,g.Cb)()],B.prototype,"_effectiveRenderer",void 0),(0,u._)([(0,g.Cb)()],B.prototype,"_effectiveFeatureReduction",null),(0,u._)([(0,g.Cb)()],B.prototype,"_aggregateValueRanges",void 0),(0,u._)([(0,g.Cb)()],B.prototype,"_commandsQueue",void 0),(0,u._)([(0,g.Cb)()],B.prototype,"featureEffectView",void 0),(0,u._)([(0,g.Cb)()],B.prototype,"labelsVisible",null),(0,u._)([(0,g.Cb)({readOnly:!0})],B.prototype,"queryMode",null),(0,u._)([(0,g.Cb)()],B.prototype,"renderingConfigHash",null),(0,u._)([(0,g.Cb)()],B.prototype,"tileRenderer",void 0),(0,u._)([(0,g.Cb)()],B.prototype,"updating",void 0),B=(0,u._)([(0,C.j)("esri.views.2d.layers.FeatureLayerView2D")],B);const Ue=B},37384:(ie,K,s)=>{s.d(K,{y:()=>W});var n=s(17626),u=s(46160),L=s(89726),g=s(26584),_=s(32917),U=s(77712),x=(s(90912),s(85931),s(76898)),$=s(1011),j=s(38093),N=s(86810);let m=class extends N.wq{get version(){return this.commitVersionProperties(),(this._get("version")||0)+1}};(0,n._)([(0,U.Cb)({readOnly:!0})],m.prototype,"version",null),m=(0,n._)([(0,x.j)("esri.views.layers.support.ClipArea")],m);const H=m;var f;let c=f=class extends H{constructor(O){super(O),this.type="rect",this.left=null,this.right=null,this.top=null,this.bottom=null}clone(){return new f({left:this.left,right:this.right,top:this.top,bottom:this.bottom})}commitVersionProperties(){this.commitProperty("left"),this.commitProperty("right"),this.commitProperty("top"),this.commitProperty("bottom")}};(0,n._)([(0,U.Cb)({type:[Number,String],json:{write:!0}})],c.prototype,"left",void 0),(0,n._)([(0,U.Cb)({type:[Number,String],json:{write:!0}})],c.prototype,"right",void 0),(0,n._)([(0,U.Cb)({type:[Number,String],json:{write:!0}})],c.prototype,"top",void 0),(0,n._)([(0,U.Cb)({type:[Number,String],json:{write:!0}})],c.prototype,"bottom",void 0),c=f=(0,n._)([(0,x.j)("esri.views.layers.support.ClipRect")],c);const I=c;s(29132);var ee,G=s(21674),k=s(91179),A=s(2004),se=s(37118);const M={base:G.Z,key:"type",typeMap:{extent:A.Z,polygon:se.Z}};let a=ee=class extends H{constructor(O){super(O),this.type="geometry",this.geometry=null}clone(){return new ee({geometry:this.geometry?.clone()??null})}commitVersionProperties(){this.commitProperty("geometry")}};(0,n._)([(0,U.Cb)({types:M,json:{read:k.im,write:!0}})],a.prototype,"geometry",void 0),a=ee=(0,n._)([(0,x.j)("esri.views.layers.support.Geometry")],a);const h=a;let l=class extends H{constructor(O){super(O),this.type="path",this.path=[]}commitVersionProperties(){this.commitProperty("path")}};(0,n._)([(0,U.Cb)({type:[[[Number]]],json:{write:!0}})],l.prototype,"path",void 0),l=(0,n._)([(0,x.j)("esri.views.layers.support.Path")],l);const D=u.Z.ofType({key:"type",base:null,typeMap:{rect:I,path:l,geometry:h}}),W=O=>{let v=class extends O{constructor(){super(...arguments),this.attached=!1,this.clips=new D,this.lastUpdateId=-1,this.moving=!1,this.updateRequested=!1,this.visibleAtCurrentScale=!1,this.highlightOptions=null}initialize(){this.view?.spatialReference&&(this.view?.spatialReferenceLocked??1)&&!this.spatialReferenceSupported?this.addResolvingPromise(Promise.reject(new g.Z("layerview:spatial-reference-incompatible","The spatial reference of this layer does not meet the requirements of the view",{layer:this.layer}))):(this.container||(this.container=new $.W),this.container.fadeTransitionEnabled=!0,this.container.visible=!1,this.container.endTransitions(),this.addHandles([(0,_.YP)(()=>this.suspended,E=>{this.container&&(this.container.visible=!E),this.view&&!E&&this.updateRequested&&this.view.requestUpdate()},_.tX),(0,_.YP)(()=>this.layer?.opacity??1,E=>{this.container&&(this.container.opacity=E)},_.tX),(0,_.YP)(()=>this.layer&&"blendMode"in this.layer?this.layer.blendMode:"normal",E=>{this.container&&(this.container.blendMode=E)},_.tX),(0,_.YP)(()=>this.layer&&"effect"in this.layer?this.layer.effect:null,E=>{this.container&&(this.container.effect=E)},_.tX),(0,_.YP)(()=>this.highlightOptions,E=>this.container.highlightOptions=E,_.tX),(0,_.on)(()=>this.clips,"change",()=>{this.container&&(this.container.clips=this.clips)},_.tX),(0,_.YP)(()=>({scale:this.view?.scale,scaleRange:this.layer&&"effectiveScaleRange"in this.layer?this.layer.effectiveScaleRange:null}),({scale:E})=>{const w=null!=E&&this.isVisibleAtScale(E);w!==this.visibleAtCurrentScale&&this._set("visibleAtCurrentScale",w)},_.tX)],"constructor"),this.view?.whenLayerView?this.view.whenLayerView(this.layer).then(E=>{E===this&&this.processAttach()},()=>{}):this.when().then(()=>{this.processAttach()},()=>{}))}destroy(){this.processDetach(),this.updateRequested=!1}get spatialReferenceSupported(){const p=this.view?.spatialReference;return null==p||this.supportsSpatialReference(p)}get updating(){return this.spatialReferenceSupported&&(!this.attached||!this.suspended&&(this.updateRequested||this.isUpdating())||!!this.updatingHandles?.updating)}processAttach(){this.isResolved()&&!this.attached&&!this.destroyed&&this.spatialReferenceSupported&&(this.attach(),this.attached=!0,this.requestUpdate())}processDetach(){this.attached&&(this.attached=!1,this.removeHandles("attach"),this.detach(),this.updateRequested=!1)}isVisibleAtScale(p){const Z=this.layer&&"effectiveScaleRange"in this.layer?this.layer.effectiveScaleRange:null;if(!Z)return!0;const{minScale:E,maxScale:w}=Z;return(0===E||p<=E)&&(0===w||p>=w)}requestUpdate(){this.destroyed||this.updateRequested||(this.updateRequested=!0,this.suspended||this.view.requestUpdate())}processUpdate(p){!this.isFulfilled()||this.isResolved()?(this._set("updateParameters",p),this.updateRequested&&!this.suspended&&(this.updateRequested=!1,this.update(p))):this.updateRequested=!1}hitTest(p,Z){return Promise.resolve(null)}supportsSpatialReference(p){return!0}canResume(){return!!this.spatialReferenceSupported&&!!super.canResume()&&this.visibleAtCurrentScale}getSuspendInfo(){const p=super.getSuspendInfo(),Z=!this.spatialReferenceSupported,E=this.visibleAtCurrentScale;return Z&&(p.spatialReferenceNotSupported=Z),E&&(p.outsideScaleRange=E),p}addAttachHandles(p){this.addHandles(p,"attach")}};return(0,n._)([(0,U.Cb)()],v.prototype,"attached",void 0),(0,n._)([(0,U.Cb)({type:D,set(p){const Z=(0,L.Z)(p,this._get("clips"),D);this._set("clips",Z)}})],v.prototype,"clips",void 0),(0,n._)([(0,U.Cb)()],v.prototype,"container",void 0),(0,n._)([(0,U.Cb)()],v.prototype,"moving",void 0),(0,n._)([(0,U.Cb)({readOnly:!0})],v.prototype,"spatialReferenceSupported",null),(0,n._)([(0,U.Cb)({readOnly:!0})],v.prototype,"updateParameters",void 0),(0,n._)([(0,U.Cb)()],v.prototype,"updateRequested",void 0),(0,n._)([(0,U.Cb)()],v.prototype,"updating",null),(0,n._)([(0,U.Cb)()],v.prototype,"view",void 0),(0,n._)([(0,U.Cb)({readOnly:!0})],v.prototype,"visibleAtCurrentScale",void 0),(0,n._)([(0,U.Cb)({type:j.Z})],v.prototype,"highlightOptions",void 0),v=(0,n._)([(0,x.j)("esri.views.2d.layers.LayerView2D")],v),v}},56482:(ie,K,s)=>{s.d(K,{Z:()=>se});var n=s(15861),u=s(17626),L=s(26584),g=s(63290),_=s(62208),U=s(10699),C=s(32917),P=s(77712),j=(s(90912),s(85931),s(76898)),N=s(13812),m=s(2319),H=s(98624),f=s(36630),c=s(59990),I=s(96854),q=s(46679),G=s(10023);const k="esri.views.layers.FeatureLayerView",A=g.Z.getLogger(k),se=ee=>{let M=class extends ee{constructor(...a){super(...a),this._updatingRequiredFieldsPromise=null,this.filter=null,this.timeExtent=null,this.layer=null,this.requiredFields=[],this.view=null}initialize(){this.handles.add([(0,C.YP)(()=>{const a=this.layer;return[a?.elevationInfo?.featureExpressionInfo,a&&"displayField"in a?a.displayField:null,a&&"timeInfo"in a&&a.timeInfo,a&&"renderer"in a&&a.renderer,a&&"labelingInfo"in a&&a.labelingInfo,a&&"floorInfo"in a&&a.floorInfo,this.filter,this.featureEffect,this.timeExtent]},()=>this._handleRequiredFieldsChange(),C.tX),(0,C.on)(()=>this.view?.floors,"change",()=>this._handleRequiredFieldsChange()),(0,C.on)(()=>{const a=this.layer;return a&&"sublayers"in a?a.sublayers:null},"change",()=>this._handleRequiredFieldsChange())])}get availableFields(){const{layer:a,layer:{fieldsIndex:h},requiredFields:l}=this;return(0,f.Q0)(h,"outFields"in a&&a.outFields?[...(0,f.Lk)(h,a.outFields),...l]:l)}get featureEffect(){return this.layer&&"featureEffect"in this.layer?this.layer.featureEffect:null}set featureEffect(a){this._override("featureEffect",a)}get maximumNumberOfFeatures(){return 0}set maximumNumberOfFeatures(a){A.error("#maximumNumberOfFeatures=","Setting maximum number of features is not supported")}get maximumNumberOfFeaturesExceeded(){return!1}highlight(a){throw new Error("missing implementation")}createQuery(){const a={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference},h=(0,_.pC)(this.filter)?this.filter.createQuery(a):new I.Z(a);if("feature"===this.layer.type){const l=(0,c.c)(this);(0,_.pC)(l)&&(h.where=h.where?`(${h.where}) AND (${l})`:l)}return(0,_.pC)(this.timeExtent)&&(h.timeExtent=(0,_.pC)(h.timeExtent)?h.timeExtent.intersection(this.timeExtent):this.timeExtent.clone()),h}createAggregateQuery(){return new I.Z({outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference})}queryFeatures(a,h){throw new Error("missing implementation")}queryObjectIds(a,h){throw new Error("missing implementation")}queryFeatureCount(a,h){throw new Error("missing implementation")}queryExtent(a,h){throw new Error("missing implementation")}fetchPopupFeatures(a,h){var l=this;return(0,n.Z)(function*(){const b=l.validateFetchPopupFeatures(h);if(b)throw b;return l.fetchClientPopupFeatures(h)})()}_loadArcadeModules(a){return a.get("expressionInfos.length")||Array.isArray(a.content)&&a.content.some(h=>"expression"===h.type)?(0,q.LC)():Promise.resolve()}_handleRequiredFieldsChange(){const a=this._updateRequiredFields();this._set("_updatingRequiredFieldsPromise",a),a.then(()=>{this._updatingRequiredFieldsPromise===a&&this._set("_updatingRequiredFieldsPromise",null)})}_updateRequiredFields(){var a=this;return(0,n.Z)(function*(){if(!a.layer||!a.view)return;const h="3d"===a.view.type,{layer:l,layer:{fieldsIndex:b,objectIdField:D}}=a,W="renderer"in l&&l.renderer,O="orderBy"in l&&l.orderBy,v="featureReduction"in l?l.featureReduction:null,p=new Set,Z=yield(0,U.as)([W?W.collectRequiredFields(p,b):null,(0,f.Mu)(p,l),h?(0,f.vl)(p,l):null,(0,_.pC)(a.filter)?(0,f.Ll)(p,l,a.filter):null,(0,_.pC)(a.featureEffect)?(0,f.Ll)(p,l,a.featureEffect.filter):null,v?(0,f.ZV)(p,l,v):null,O?(0,f.Qj)(p,l,O):null]);if("timeInfo"in l&&l.timeInfo&&a.timeExtent&&(0,f.gd)(p,l.fieldsIndex,[l.timeInfo.startField,l.timeInfo.endField]),"feature"===l.type&&(l.floorInfo&&(0,f.gd)(p,l.fieldsIndex,[l.floorInfo.floorField]),h&&(0,_.pC)(l.infoFor3D)&&(null==l.globalIdField&&A.error("globalIdField missing on 3DObjectFeatureLayer"),(0,f.gd)(p,l.fieldsIndex,[l.globalIdField]))),"subtype-group"===l.type){(0,f.AB)(p,b,l.subtypeField);const w=l.sublayers.map(Y=>Promise.all([Y.renderer?.collectRequiredFields(p,b),(0,f.Mu)(p,Y)]));yield(0,U.as)(w)}for(const w of Z)w.error&&A.error(w.error);(0,f.AB)(p,b,D),h&&"displayField"in l&&l.displayField&&(0,f.AB)(p,b,l.displayField);const E=Array.from(p).sort();a._set("requiredFields",E)})()}validateFetchPopupFeatures(a){if((0,_.Wi)(a))return null;for(const h of a.clientGraphics??[]){const l=h.layer;if("popupEnabled"in l&&!l.popupEnabled)return new L.Z("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:l});if(h.isAggregate){const b="featureReduction"in l?l.featureReduction:null;if(!(b&&"popupTemplate"in b&&b.popupEnabled&&b.popupTemplate))return new L.Z("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:l})}else if("popupTemplate"in l&&!(0,G.V)(l,a))return new L.Z("featurelayerview:fetchPopupFeatures","Layer does not define a popup template",{layer:l})}}fetchClientPopupFeatures(a){var h=this;return(0,n.Z)(function*(){const l=(0,_.pC)(a)?a.clientGraphics:null;if(!l||0===l.length)return[];const b=new Array(l.length),D=new Map,W=yield h.createPopupQuery(a);for(let O=0;O<l.length;O++){const v=l[O];if(v.isAggregate){b[O]=v;continue}const p=v.layer;if(!("popupEnabled"in p))continue;const Z=(0,f.Lk)(h.layer.fieldsIndex,W.outFields),E=(0,G.V)(p,a);if((0,_.Wi)(E))continue;const w=yield h._loadArcadeModules(E);w&&w.arcadeUtils.hasGeometryOperations(E)||!(0,f.R9)(Z,v)?D.set(v.getObjectId(),{graphic:v,index:O}):b[O]=v}if("stream"===h.layer.type||0===D.size)return b.filter(Boolean);W.objectIds=Array.from(D.keys());try{const O=yield h.layer.queryFeatures(W);for(const v of O.features){const{graphic:{geometry:p},index:Z}=D.get(v.getObjectId());v.geometry||(v.geometry=p),b[Z]=v}}catch{}return b.filter(Boolean)})()}createPopupQuery(a){var h=this;return(0,n.Z)(function*(){const l=h.layer.createQuery(),b=new Set;let D=!1;const W=(0,_.pC)(a)&&a.clientGraphics?a.clientGraphics.map(O=>O.layer):[h.layer];for(const O of W){if(!("popupEnabled"in O))continue;const v=(0,G.V)(O,a);if((0,_.Wi)(v))continue;const p=yield h._loadArcadeModules(v),Z=p&&p.arcadeUtils.hasGeometryOperations(v);D=!("point"!==h.layer.geometryType&&!Z);const E=yield(0,G.e)(h.layer,v);for(const w of E)b.add(w)}if(l.returnGeometry=D,l.returnZ=D,l.returnM=D,l.outFields=Array.from(b),l.outSpatialReference=h.view.spatialReference,"feature"===h.layer.type){const O=(0,c.c)(h);(0,_.pC)(O)&&(l.where=l.where?`(${l.where}) AND (${O})`:O)}return l})()}canResume(){return!(!super.canResume()||(0,_.pC)(this.timeExtent)&&this.timeExtent.isEmpty)}};return(0,u._)([(0,P.Cb)()],M.prototype,"_updatingRequiredFieldsPromise",void 0),(0,u._)([(0,P.Cb)({readOnly:!0})],M.prototype,"availableFields",null),(0,u._)([(0,P.Cb)({type:m.Z})],M.prototype,"featureEffect",null),(0,u._)([(0,P.Cb)({type:H.Z})],M.prototype,"filter",void 0),(0,u._)([(0,P.Cb)(N.qG)],M.prototype,"timeExtent",void 0),(0,u._)([(0,P.Cb)()],M.prototype,"layer",void 0),(0,u._)([(0,P.Cb)({type:Number})],M.prototype,"maximumNumberOfFeatures",null),(0,u._)([(0,P.Cb)({readOnly:!0,type:Boolean})],M.prototype,"maximumNumberOfFeaturesExceeded",null),(0,u._)([(0,P.Cb)({readOnly:!0})],M.prototype,"requiredFields",void 0),(0,u._)([(0,P.Cb)()],M.prototype,"suspended",void 0),(0,u._)([(0,P.Cb)()],M.prototype,"view",void 0),M=(0,u._)([(0,j.j)(k)],M),M}},45611:(ie,K,s)=>{s.d(K,{Z:()=>H});var n=s(17626),u=s(14517),L=s(61885),g=s(80542),_=s(61996),U=s(63290),C=s(62208),P=s(60330),x=s(77712),N=(s(90912),s(85931),s(76898));let m=class extends((0,g.p)((0,_.IG)((0,P.v)(L.Z.EventedMixin(u.Z))))){constructor(f){super(f),this.layer=null,this.parent=null}initialize(){this.when().catch(f=>{if("layerview:create-error"!==f.name){const c=this.layer&&this.layer.id||"no id",I=this.layer&&this.layer.title||"no title";U.Z.getLogger(this.declaredClass).error("#resolve()",`Failed to resolve layer view (layer title: '${I}', id: '${c}')`,f)}})}get fullOpacity(){return(0,C.Pt)(this.get("layer.opacity"),1)*(0,C.Pt)(this.get("parent.fullOpacity"),1)}get suspended(){return!this.canResume()}get suspendInfo(){return this.getSuspendInfo()}get legendEnabled(){return!this.suspended&&!0===this.layer?.legendEnabled}get updating(){return!(!this.updatingHandles?.updating&&!this.isUpdating())}get updatingProgress(){return this.updating?0:1}get visible(){return!0===this.layer?.visible}set visible(f){this._overrideIfSome("visible",f)}canResume(){return this.visible&&this.layer?.loaded&&!this.parent?.suspended&&this.view?.ready||!1}getSuspendInfo(){const f=this.parent&&this.parent.suspended?this.parent.suspendInfo:{};return this.view&&this.view.ready||(f.viewNotReady=!0),this.layer&&this.layer.loaded||(f.layerNotLoaded=!0),this.visible||(f.layerInvisible=!0),f}isUpdating(){return!1}};(0,n._)([(0,x.Cb)()],m.prototype,"fullOpacity",null),(0,n._)([(0,x.Cb)()],m.prototype,"layer",void 0),(0,n._)([(0,x.Cb)()],m.prototype,"parent",void 0),(0,n._)([(0,x.Cb)({readOnly:!0})],m.prototype,"suspended",null),(0,n._)([(0,x.Cb)({readOnly:!0})],m.prototype,"suspendInfo",null),(0,n._)([(0,x.Cb)({readOnly:!0})],m.prototype,"legendEnabled",null),(0,n._)([(0,x.Cb)({type:Boolean,readOnly:!0})],m.prototype,"updating",null),(0,n._)([(0,x.Cb)({readOnly:!0})],m.prototype,"updatingProgress",null),(0,n._)([(0,x.Cb)()],m.prototype,"visible",null),(0,n._)([(0,x.Cb)()],m.prototype,"view",void 0),m=(0,n._)([(0,N.j)("esri.views.layers.LayerView")],m);const H=m},94421:(ie,K,s)=>{s.d(K,{Z:()=>x});var n=s(17626),u=s(63290),L=s(10699),g=s(32917),_=s(77712),P=(s(90912),s(85931),s(76898));const x=$=>{let j=class extends ${initialize(){this.handles.add((0,g.on)(()=>this.layer,"refresh",N=>{this.doRefresh(N.dataChanged).catch(m=>{(0,L.D_)(m)||u.Z.getLogger(this.declaredClass).error(m)})}),"RefreshableLayerView")}};return(0,n._)([(0,_.Cb)()],j.prototype,"layer",void 0),j=(0,n._)([(0,P.j)("esri.layers.mixins.RefreshableLayerView")],j),j}},10023:(ie,K,s)=>{s.d(K,{V:()=>U,e:()=>g});var n=s(15861),u=s(62208),L=s(36630);function g(C){return _.apply(this,arguments)}function _(){return(_=(0,n.Z)(function*(C,P=C.popupTemplate){if((0,u.Wi)(P))return[];const x=yield P.getRequiredFields(C.fieldsIndex),{lastEditInfoEnabled:$}=P,{objectIdField:j,typeIdField:N,globalIdField:m,relationships:H}=C;if(x.includes("*"))return["*"];const f=$?yield(0,L.CH)(C):[],c=(0,L.Q0)(C.fieldsIndex,[...x,...f]);return N&&c.push(N),c&&j&&C.fieldsIndex?.has(j)&&!c.includes(j)&&c.push(j),c&&m&&C.fieldsIndex?.has(m)&&!c.includes(m)&&c.push(m),H&&H.forEach(I=>{const{keyField:q}=I;c&&q&&C.fieldsIndex?.has(q)&&!c.includes(q)&&c.push(q)}),c})).apply(this,arguments)}function U(C,P){return C.popupTemplate?C.popupTemplate:(0,u.pC)(P)&&P.defaultPopupTemplateEnabled&&(0,u.pC)(C.defaultPopupTemplate)?C.defaultPopupTemplate:null}}}]);