"use strict";(self.webpackChunkpredio360_app=self.webpackChunkpredio360_app||[]).push([[8460],{18716:(rr,he,w)=>{w.d(he,{CA:()=>_i,Gq:()=>Mt,Xp:()=>at,a:()=>Ut,dk:()=>Y,hF:()=>de,jj:()=>pi,jy:()=>Rt,m2:()=>rt,mE:()=>At,qr:()=>Ot});var B=w(26584),N=w(40028),E=w(39406);const kt=Object.keys(E.mD).filter(k=>"number"==typeof E.mD[k]).reduce((k,S)=>({...k,[S]:E.mD[S]}),{});function Rt(k){return k===E.mD.OUTLINE_FILL||k===E.mD.OUTLINE_FILL_SIMPLE}function at(k){return function vt(k){return k===E.mD.SIMPLE||k===E.mD.OUTLINE_FILL_SIMPLE}(k.symbologyType)}function _i(k){return Rt(k.symbologyType)}function pi(k,S){switch(k){case E.LW.FILL:return Y.from(S);case E.LW.LINE:return Ut.from(S);case E.LW.MARKER:return At.from(S);case E.LW.TEXT:return Ot.from(S);case E.LW.LABEL:return Mt.from(S);default:throw new Error(`Unable to createMaterialKey for unknown geometryType ${k}`)}}function de(k){switch(rt.load(k).geometryType){case E.LW.MARKER:return new At(k);case E.LW.FILL:return new Y(k);case E.LW.LINE:return new Ut(k);case E.LW.TEXT:return new Ot(k);case E.LW.LABEL:return new Mt(k)}}class rt{static load(S){const T=this.shared;return T.data=S,T}constructor(S){this._data=0,this._data=S}set data(S){this._data=S??0}get data(){return this._data}get geometryType(){return this.bits(8,11)}set geometryType(S){this.setBits(S,8,11)}get mapAligned(){return!!this.bit(20)}set mapAligned(S){this.setBit(20,S)}get sdf(){return!!this.bit(11)}set sdf(S){this.setBit(11,S??!1)}get pattern(){return!!this.bit(12)}set pattern(S){this.setBit(12,S)}get textureBinding(){return this.bits(0,8)}set textureBinding(S){this.setBits(S,0,8)}get symbologyType(){return this.bits(21,26)}set symbologyType(S){this.setBits(S,21,26)}get geometryTypeString(){switch(this.geometryType){case E.LW.FILL:return"fill";case E.LW.MARKER:return"marker";case E.LW.LINE:return"line";case E.LW.TEXT:return"text";case E.LW.LABEL:return"label";default:throw new B.Z(`Unable to handle unknown geometryType: ${this.geometryType}`)}}setBit(S,T){const D=1<<S;T?this._data|=D:this._data&=~D}bit(S){return(this._data&1<<S)>>S}setBits(S,T,D){for(let Z=T,Dt=0;Z<D;Z++,Dt++)this.setBit(Z,0!=(S&1<<Dt))}bits(S,T){let D=0;for(let Z=S,Dt=0;Z<T;Z++,Dt++)D|=this.bit(Z)<<Dt;return D}hasVV(){return!1}setVV(S,T){}getVariation(){return{mapAligned:this.mapAligned,pattern:this.pattern,sdf:this.sdf,symbologyType:{value:E.mD[this.symbologyType],options:kt,namespace:"SYMBOLOGY_TYPE"}}}getVariationHash(){return this._data&~(7&this.textureBinding)}}rt.shared=new rt(0);const _t=k=>class extends k{get vvSizeMinMaxValue(){return 0!==this.bit(16)}set vvSizeMinMaxValue(S){this.setBit(16,S)}get vvSizeScaleStops(){return 0!==this.bit(17)}set vvSizeScaleStops(S){this.setBit(17,S)}get vvSizeFieldStops(){return 0!==this.bit(18)}set vvSizeFieldStops(S){this.setBit(18,S)}get vvSizeUnitValue(){return 0!==this.bit(19)}set vvSizeUnitValue(S){this.setBit(19,S)}hasVV(){return super.hasVV()||this.vvSizeMinMaxValue||this.vvSizeScaleStops||this.vvSizeFieldStops||this.vvSizeUnitValue}setVV(S,T){super.setVV(S,T);const D=function ft(k,S,T){const D=E.X.SIZE_FIELD_STOPS|E.X.SIZE_MINMAX_VALUE|E.X.SIZE_SCALE_STOPS|E.X.SIZE_UNIT_VALUE,Z=(S&(E.mf.FIELD_TARGETS_OUTLINE|E.mf.MINMAX_TARGETS_OUTLINE|E.mf.SCALE_TARGETS_OUTLINE|E.mf.UNIT_TARGETS_OUTLINE))>>>4;return k===E.LW.LINE&&T.isOutline||k===E.LW.FILL&&Rt(T.symbologyType)?D&Z:D&~Z}(this.geometryType,S,T)&S;this.vvSizeMinMaxValue=!!(D&E.X.SIZE_MINMAX_VALUE),this.vvSizeFieldStops=!!(D&E.X.SIZE_FIELD_STOPS),this.vvSizeUnitValue=!!(D&E.X.SIZE_UNIT_VALUE),this.vvSizeScaleStops=!!(D&E.X.SIZE_SCALE_STOPS)}},It=k=>class extends k{get vvRotation(){return 0!==this.bit(15)}set vvRotation(S){this.setBit(15,S)}hasVV(){return super.hasVV()||this.vvRotation}setVV(S,T){super.setVV(S,T),this.vvRotation=!T.isOutline&&!!(S&E.X.ROTATION)}},st=k=>class extends k{get vvColor(){return 0!==this.bit(13)}set vvColor(S){this.setBit(13,S)}hasVV(){return super.hasVV()||this.vvColor}setVV(S,T){super.setVV(S,T),this.vvColor=!T.isOutline&&!!(S&E.X.COLOR)}},wt=k=>class extends k{get vvOpacity(){return 0!==this.bit(14)}set vvOpacity(S){this.setBit(14,S)}hasVV(){return super.hasVV()||this.vvOpacity}setVV(S,T){super.setVV(S,T),this.vvOpacity=!T.isOutline&&!!(S&E.X.OPACITY)}};class Y extends(st(wt(_t(rt)))){static load(S){const T=this.shared;return T.data=S,T}static from(S){const{symbologyType:T,vvFlags:D}=S,Z=this.load(0);return Z.geometryType=E.LW.FILL,Z.symbologyType=T,T!==E.mD.DOT_DENSITY&&Z.setVV(D,S),Z.data}getVariation(){return{...super.getVariation(),vvColor:this.vvColor,vvOpacity:this.vvOpacity,vvSizeFieldStops:this.vvSizeFieldStops,vvSizeMinMaxValue:this.vvSizeMinMaxValue,vvSizeScaleStops:this.vvSizeScaleStops,vvSizeUnitValue:this.vvSizeUnitValue}}}Y.shared=new Y(0);class At extends(st(wt(It(_t(rt))))){static load(S){const T=this.shared;return T.data=S,T}static from(S){const{symbologyType:T,vvFlags:D}=S,Z=this.load(0);return Z.geometryType=E.LW.MARKER,Z.symbologyType=T,T!==E.mD.HEATMAP&&Z.setVV(D,S),Z.data}getVariation(){return{...super.getVariation(),vvColor:this.vvColor,vvRotation:this.vvRotation,vvOpacity:this.vvOpacity,vvSizeFieldStops:this.vvSizeFieldStops,vvSizeMinMaxValue:this.vvSizeMinMaxValue,vvSizeScaleStops:this.vvSizeScaleStops,vvSizeUnitValue:this.vvSizeUnitValue}}}At.shared=new At(0);class Ut extends(st(wt(_t(rt)))){static load(S){const T=this.shared;return T.data=S,T}static from(S){const T=this.load(0);return T.geometryType=E.LW.LINE,T.symbologyType=S.symbologyType,T.setVV(S.vvFlags,S),T.data}getVariation(){return{...super.getVariation(),vvColor:this.vvColor,vvOpacity:this.vvOpacity,vvSizeFieldStops:this.vvSizeFieldStops,vvSizeMinMaxValue:this.vvSizeMinMaxValue,vvSizeScaleStops:this.vvSizeScaleStops,vvSizeUnitValue:this.vvSizeUnitValue}}}Ut.shared=new Ut(0);class Ot extends(st(wt(It(_t(rt))))){static load(S){const T=this.shared;return T.data=S,T}static from(S){const T=this.load(0);return T.geometryType=E.LW.TEXT,T.symbologyType=S.symbologyType,T.setVV(S.vvFlags,S),T.data}getVariation(){return{...super.getVariation(),vvColor:this.vvColor,vvOpacity:this.vvOpacity,vvRotation:this.vvRotation,vvSizeFieldStops:this.vvSizeFieldStops,vvSizeMinMaxValue:this.vvSizeMinMaxValue,vvSizeScaleStops:this.vvSizeScaleStops,vvSizeUnitValue:this.vvSizeUnitValue}}}Ot.shared=new Ot(0);class Mt extends(_t(rt)){static load(S){const T=this.shared;return T.data=S,T}static from(S){const T=this.load(0);return T.geometryType=E.LW.LABEL,T.symbologyType=S.symbologyType,T.setVV(S.vvFlags,S),T.mapAligned=(0,N.NS)(S.placement),T.data}getVariation(){return{...super.getVariation(),vvSizeFieldStops:this.vvSizeFieldStops,vvSizeMinMaxValue:this.vvSizeMinMaxValue,vvSizeScaleStops:this.vvSizeScaleStops,vvSizeUnitValue:this.vvSizeUnitValue}}}Mt.shared=new Mt(0)},28460:(rr,he,w)=>{w.r(he),w.d(he,{default:()=>Ps});var B=w(15861),N=w(17626),E=w(986),ft=w(26584),mt=(w(8314),w(63290)),z=w(62208),J=w(10699),Et=(w(90912),w(85931),w(76898)),Ft=w(84682),ce=w(65234),Vt=w(99666),A=w(39406),qt=w(14517),j=w(77712),q=w(67831),te=w(71251);const Bt=new Set,kt=[],vt=new Map,Rt=[0,0];let at=class extends qt.Z{constructor(l){super(l),this._keyToItem=new Map,this.concurrency=6,this.strategy="scale-first",this.tileInfoView=null}initialize(){const{concurrency:l,process:r}=this;this._queue=new te.e({concurrency:l,process:(n,o)=>{const a=this._keyToItem.get(n);return r(a,{signal:o})},peeker:n=>n.values().next().value})}destroy(){this.clear(),this._queue=(0,z.SC)(this._queue)}get length(){return this._queue?this._queue.length:0}get onGoingCount(){return this._keyToItem.size}get updating(){return this.length>0||this.onGoingCount>0}abort(l){this._queue.abort("string"==typeof l?l:l.id)}clear(){this._queue.clear(),this._keyToItem.clear(),this.notifyChange("updating")}has(l){return this._keyToItem.has("string"==typeof l?l:l.id)}isOngoing(l){const r="string"==typeof l?l:l.id;return this.has(r)&&this._queue.isOngoing(r)}pause(){this._queue.pause()}push(l,r){const n=l.key.id+"-"+r;if(this.has(n))return this.get(n);const o=this._queue.push(n),a=()=>{this._keyToItem.delete(n),this.notifyChange("updating")};return this._keyToItem.set(n,l),o.then(a,a),this.notifyChange("updating"),o}reset(){this._queue.reset(),this.notifyChange("updating")}resume(){this._queue.resume()}_peekByScaleFirst(l){if(!this.state)return l.values().next().value;const r=this.tileInfoView;let n=Number.NEGATIVE_INFINITY,o=Number.POSITIVE_INFINITY;l.forEach(f=>{const m=this._keyToItem.get(f),_=this.tileInfoView.getTileScale(m.key);vt.has(_)||(vt.set(_,[]),n=Math.max(_,n),o=Math.min(_,o)),vt.get(_).push(m.key),Bt.add(_)});let a=this.state.scale;vt.has(a)||(function ue(l,r){l.length=0,r.forEach(n=>l.push(n))}(kt,Bt),kt.sort((f,m)=>f-m),a=kt.reduce((f,m)=>Math.abs(m-a)<Math.abs(f-a)?m:f,kt[0])),a=Math.min(a,n),a=Math.max(a,o);const h=vt.get(a),c=r.getClosestInfoForScale(a),u=c.getColumnForX(this.state.center[0]),d=c.getRowForY(this.state.center[1]);return h.sort((f,m)=>{const _=c.denormalizeCol(f.col,f.world),p=c.denormalizeCol(m.col,m.world);return Math.sqrt((u-_)*(u-_)+(d-f.row)*(d-f.row))-Math.sqrt((u-p)*(u-p)+(d-m.row)*(d-m.row))}),Bt.clear(),vt.clear(),h[0].id}_peekByCenterFirst(l){if(!this.state)return l.values().next().value;const r=this.tileInfoView,n=this.state.center;let o,a=Number.POSITIVE_INFINITY;return l.forEach(h=>{const c=this._keyToItem.get(h);r.getTileCoords(Rt,c.key);const u=(0,q.d)(Rt,n);u<a&&(a=u,o=c.key)}),o.id}};(0,N._)([(0,j.Cb)({constructOnly:!0})],at.prototype,"concurrency",void 0),(0,N._)([(0,j.Cb)({constructOnly:!0})],at.prototype,"process",void 0),(0,N._)([(0,j.Cb)()],at.prototype,"state",void 0),(0,N._)([(0,j.Cb)({constructOnly:!0})],at.prototype,"strategy",void 0),(0,N._)([(0,j.Cb)({constructOnly:!0})],at.prototype,"tileInfoView",void 0),(0,N._)([(0,j.Cb)({readOnly:!0})],at.prototype,"updating",null),at=(0,N._)([(0,Et.j)("esri.views.2d.tiling.PagedTileQueue")],at),w(9598);var de=w(58098);const _t=new Set,It=[],st=new Map,wt=[0,0];let Y=class extends qt.Z{constructor(l){super(l),this._keyToItem=new Map,this.concurrency=6,this.strategy="scale-first",this.tileInfoView=null}initialize(){const{concurrency:l,process:r,strategy:n}=this;this._queue=new te.e({concurrency:l,process:(o,a)=>{const h=this._keyToItem.get(o);return r(h,{signal:a})},peeker:"scale-first"===n?o=>this._peekByScaleFirst(o):o=>this._peekByCenterFirst(o)})}destroy(){this.clear(),this._queue=(0,z.SC)(this._queue)}get length(){return this._queue?this._queue.length:0}get onGoingCount(){return this._keyToItem.size}get updating(){return this.length>0||this.onGoingCount>0}abort(l){this._queue.abort("string"==typeof l?l:l.id)}clear(){this._queue.clear(),this._keyToItem.clear(),this.notifyChange("updating")}has(l){return this._keyToItem.has("string"==typeof l?l:l.id)}isOngoing(l){const r="string"==typeof l?l:l.id;return this.has(r)&&this._queue.isOngoing(r)}pause(){this._queue.pause()}push(l){const r=l.key.id;if(this._queue.has(r))return this._queue.get(r);const n=this._queue.push(r),o=()=>{this._keyToItem.delete(r),this.notifyChange("updating")};return this._keyToItem.set(r,l),n.then(o,o),this.notifyChange("updating"),n}reset(){this._queue.reset()}resume(){this._queue.resume()}_peekByScaleFirst(l){if(!this.state)return l.values().next().value;const r=this.tileInfoView;let n=Number.NEGATIVE_INFINITY,o=Number.POSITIVE_INFINITY;l.forEach(f=>{const m=this._keyToItem.get(f),_=this.tileInfoView.getTileScale(m.key);st.has(_)||(st.set(_,[]),n=Math.max(_,n),o=Math.min(_,o)),st.get(_).push(m.key),_t.add(_)});let a=this.state.scale;st.has(a)||(function rt(l,r){l.length=0,r.forEach(n=>l.push(n))}(It,_t),It.sort((f,m)=>f-m),a=It.reduce((f,m)=>Math.abs(m-a)<Math.abs(f-a)?m:f,It[0])),a=Math.min(a,n),a=Math.max(a,o);const h=st.get(a),c=r.getClosestInfoForScale(a),u=c.getColumnForX(this.state.center[0]),d=c.getRowForY(this.state.center[1]);return h.sort((f,m)=>{const _=c.denormalizeCol(f.col,f.world),p=c.denormalizeCol(m.col,m.world);return Math.sqrt((u-_)*(u-_)+(d-f.row)*(d-f.row))-Math.sqrt((u-p)*(u-p)+(d-m.row)*(d-m.row))}),_t.clear(),st.clear(),h[0].id}_peekByCenterFirst(l){if(!this.state)return l.values().next().value;const r=this.tileInfoView,n=this.state.center;let o,a=Number.POSITIVE_INFINITY;return l.forEach(h=>{const c=this._keyToItem.get(h);r.getTileCoords(wt,c.key);const u=(0,q.d)(wt,n);u<a&&(a=u,o=c.key)}),o.id}};(0,N._)([(0,j.Cb)({constructOnly:!0})],Y.prototype,"concurrency",void 0),(0,N._)([(0,j.Cb)({constructOnly:!0})],Y.prototype,"process",void 0),(0,N._)([(0,j.Cb)()],Y.prototype,"state",void 0),(0,N._)([(0,j.Cb)({constructOnly:!0})],Y.prototype,"strategy",void 0),(0,N._)([(0,j.Cb)({constructOnly:!0})],Y.prototype,"tileInfoView",void 0),(0,N._)([(0,j.Cb)({readOnly:!0})],Y.prototype,"updating",null),Y=(0,N._)([(0,Et.j)("esri.views.2d.tiling.TileQueue")],Y),w(65401),w(84378),new de.Z(0,0,0,0);var I=w(39351),ee=w(87526);const Zt=new Map;Zt.set(A.LW.MARKER,{multiplier:1,indicesPerRecord:6,verticesPerRecord:4}),Zt.set(A.LW.LINE,{multiplier:1,indicesPerRecord:24,verticesPerRecord:8}),Zt.set(A.LW.FILL,{multiplier:1,indicesPerRecord:10,verticesPerRecord:10}),Zt.set(A.LW.TEXT,{multiplier:8,indicesPerRecord:6,verticesPerRecord:4}),Zt.set(A.LW.LABEL,{multiplier:8,indicesPerRecord:6,verticesPerRecord:4});class fe{get length(){return this._pos}constructor(r,n){this._pos=0;const o=n?this._roundToNearest(n,r.BYTES_PER_ELEMENT):40;this._array=new ArrayBuffer(o),this._buffer=new r(this._array),this._ctor=r,this._i16View=new Int16Array(this._array)}_roundToNearest(r,n){const o=Math.round(r);return o+(n-o%n)}_ensureSize(r){if(this._pos+r>=this._buffer.length){const n=this._roundToNearest(1.25*(this._array.byteLength+r*this._buffer.BYTES_PER_ELEMENT),this._buffer.BYTES_PER_ELEMENT),o=new ArrayBuffer(n),a=new this._ctor(o);a.set(this._buffer,0),this._array=o,this._buffer=a,this._i16View=new Int16Array(this._array)}}ensureSize(r){this._ensureSize(r)}writeF32(r){this._ensureSize(1);const n=this._pos;return new Float32Array(this._array,4*this._pos,1)[0]=r,this._pos++,n}push(r){this._ensureSize(1);const n=this._pos;return this._buffer[this._pos++]=r,n}writeFixed(r){this._buffer[this._pos++]=r}setValue(r,n){this._buffer[r]=n}i1616Add(r,n,o){this._i16View[2*r]+=n,this._i16View[2*r+1]+=o}getValue(r){return this._buffer[r]}incr(r){if(this._buffer.length<r)throw new Error("Increment index overflows the target buffer");this._buffer[r]++}decr(r){this._buffer[r]--}writeRegion(r){this._ensureSize(r.length);const n=this._pos;return this._buffer.set(r,this._pos),this._pos+=r.length,n}writeManyFrom(r,n,o){this._ensureSize(o-n);for(let a=n;a!==o;a++)this.writeFixed(r._buffer[a])}buffer(){const r=this._array.slice(0,4*this._pos);return this.destroy(),r}toArray(){const r=this._array,n=[];for(let o=0;o<r.byteLength/4;o++)n.push(r[o]);return n}seek(r){this._pos=r}destroy(){this._array=null,this._buffer=null}}class yi{constructor(r,n,o){this._start={index:0,vertex:0};const a=function sr(l,r,n){const{indicesPerRecord:o,multiplier:a,verticesPerRecord:h}=Zt.get(l);return{recordBytes:n*I.XJ*Uint32Array.BYTES_PER_ELEMENT,indexBytes:a*o*n*Uint32Array.BYTES_PER_ELEMENT,vertexBytes:a*h*n*r}}(r,n,o),h=n/4;this.geometryType=r,this._records=new fe(Int32Array,a.recordBytes),this._indices=new fe(Uint32Array,a.indexBytes),this._vertices=new fe(Uint32Array,a.vertexBytes),this._metrics=new fe(Float32Array,0),this._strideInt=h}serialize(r){const n=this._records.buffer(),o=this._indices.buffer(),a=this._vertices.buffer(),h=this._metrics.length?this._metrics.buffer():null,c=4*this._strideInt;return r.push(n,o,a),{stride:c,records:n,indices:o,vertices:a,metrics:h}}get strideInt(){return this._strideInt}get recordCount(){return this._records.length/I.XJ}get vertexCount(){return this._vertices.length/this._strideInt}get indexCount(){return this._indices.length}get indexWriter(){return this._indices}get vertexWriter(){return this._vertices}get metricWriter(){return this._metrics}vertexEnsureSize(r){this._vertices.ensureSize(r)}indexEnsureSize(r){this._indices.ensureSize(r)}recordStart(){this._start.index=this._indices.length,this._start.vertex=this._vertices.length}recordEnd(r,n,o,a,h,c,u,d){this._records.push(r),this._records.push(n??0),this._records.push(o),this._records.push(a),this._records.push(h),this._records.push(c),this._records.push(u),this._records.writeF32(d)}writeIndex(r){this._indices.push(r)}writeVertex(r){this._vertices.push(r)}writeVertexF32(r){this._vertices.writeF32(r)}copyLastFrom(r,n,o){const a=r._records.length-I.XJ,h=r._records.getValue(a),c=r._records.getValue(a+1),u=r._records.getValue(a+2),d=r._records.getValue(a+4),f=r._records.getValue(a+6),m=r._records.getValue(a+7),_=this._vertices.length,p=(r._start.vertex-this._vertices.length)/this._strideInt,y=this._indices.length,g=this.vertexCount;for(let x=r._start.index;x!==r._indices.length;x++){const M=r._indices.getValue(x);this._indices.push(M-p)}for(let x=r._start.vertex;x!==r._vertices.length;x++){const M=r._vertices.getValue(x);this._vertices.push(M)}for(let x=_;x<=this._vertices.length;x+=this._strideInt)this._vertices.i1616Add(x,n,o);this._records.push(h),this._records.push(c),this._records.push(u),this._records.push(y),this._records.push(d),this._records.push(g),this._records.push(f),this._records.push(m)}}var or=w(55376);const me=1,Fe=2,_e=4,Ve=8,Be=16,pe=32,ke=64,ye=128;function gi(l){switch(l){case me:case Ve:case pe:return-1;case Fe:case ke:return 0;case _e:case Be:case ye:return 1}}function xi(l){switch(l){case me:case Fe:case _e:return-1;case Ve:case Be:return 0;case pe:case ke:case ye:return 1}}const vi=me|Ve|pe,Mi=_e|Be|ye,Si=me|Fe|_e,bi=pe|ke|ye;class ar{constructor(r,n,o,a,h,c=0){this._hasAggregate=!1,this.hasRecords=!1,this._data={self:new Map,neighbors:new Array},this._version=0,this._current={geometryType:0,writer:null,overlaps:0,start:0,insertAfter:0,sortKey:0,id:0,materialKey:0,indexStart:0,vertStart:0,isDotDensity:!1,bufferingEnabled:!1,metricBoxLenPointer:0},this.hint=n,this.tileKey=r,this._hasAggregate=a,this._pixelBufferEnabled=h,this._version=c,this._symbologyType=o}get hasAggregates(){return this._hasAggregate}get hasPixelBufferEnabled(){return this._pixelBufferEnabled}serialize(r){const n=[];return n.push(this._serializeTileVertexData(this.tileKey,this.tileKey,this._data.self)),this._data.neighbors.forEach((o,a)=>{const h=1<<a,c=gi(h),u=xi(h),d=(0,or.M)(new de.Z(this.tileKey),c,u,r),f=this._serializeTileVertexData(this.tileKey,d.id,o.vertexData);f.message.bufferIds=o.displayIds,n.push(f)}),n}_serializeTileVertexData(r,n,o){const a=new Array;return{message:{tileKeyOrigin:r,tileKey:n,data:{[A.LW.MARKER]:o.get(A.LW.MARKER)?.serialize(a),[A.LW.FILL]:o.get(A.LW.FILL)?.serialize(a),[A.LW.LINE]:o.get(A.LW.LINE)?.serialize(a),[A.LW.TEXT]:o.get(A.LW.TEXT)?.serialize(a),[A.LW.LABEL]:o.get(A.LW.LABEL)?.serialize(a)},version:this._version},transferList:a}}featureStart(r,n){this._current.insertAfter=r,this._current.sortKey=n}featureEnd(){}recordStart(r,n,o,a){this._current.writer=this._getVertexWriter(o),this._current.overlaps=0,this._current.indexStart=this._current.writer.indexCount,this._current.vertStart=this._current.writer.vertexCount,this._current.bufferingEnabled=a,this._current.id=r,this._current.materialKey=n,this._current.geometryType=o,this._current.isDotDensity=!1,this._current.writer.recordStart()}recordCount(){return this._current.writer.recordCount}vertexCount(){return this._current.writer.vertexCount}indexCount(){return this._current.writer.indexCount}vertexEnsureSize(r){this._current.writer.vertexEnsureSize(r)}indexEnsureSize(r){this._current.writer.indexEnsureSize(r)}vertexBounds(r,n,o,a){this._current.bufferingEnabled&&this._addOverlap(r,n,o,a)}vertexWrite(r){this._current.writer.writeVertex(r)}vertexWriteF32(r){this._current.writer.writeVertexF32(r)}vertexEnd(){}vertexWriter(){return this._current.writer.vertexWriter}indexWrite(r){this._current.writer.writeIndex(r)}indexWriter(){return this._current.writer.indexWriter}metricWriter(){return this._current.writer.metricWriter}metricStart(r,n,o,a,h,c,u,d){this._current.writer=this._getVertexWriter(A.LW.LABEL);const f=this._current.writer.metricWriter;f.push((0,Vt.jL)(r)),f.push(n),f.push(o),f.push(a),f.push(h),f.push(c),f.push(u),f.push(d),f.push(255),this._current.metricBoxLenPointer=f.push(0)}metricEnd(){const r=this._current.writer.metricWriter;0===r.getValue(this._current.metricBoxLenPointer)&&r.seek(r.length-10)}metricBoxWrite(r,n,o,a){const h=this._current.writer.metricWriter;h.incr(this._current.metricBoxLenPointer),h.push(0),h.push(0),h.push(r),h.push(n),h.push(o),h.push(a)}recordEnd(){const r=this._current.vertStart,n=this._current.writer.vertexCount-r;if(!n)return!1;this.hasRecords=!0;const o=this._current.indexStart;if(this._current.writer.recordEnd(this._current.id,this._current.materialKey,this._current.insertAfter,o,this._current.writer.indexCount-o,r,n,this._current.sortKey),!this._pixelBufferEnabled||this._hasAggregate||0===this._current.overlaps||this._current.geometryType===A.LW.LABEL)return!0;const h=this._current.writer;for(let c=0;c<8;c++){const u=1<<c;if(this._current.overlaps&u){this._data.neighbors[c]||(this._data.neighbors[c]={vertexData:new Map,displayIds:new Set});const d=this._data.neighbors[c],f=this._current.geometryType;if(!d.vertexData.has(f)){const g=(0,ee.$_)(f,this._symbologyType).geometry,x=new yi(f,g,I.Ip);d.vertexData.set(f,x)}const m=d.vertexData.get(this._current.geometryType),_=8,p=512*-gi(u)*_,y=512*-xi(u)*_;m?.copyLastFrom(h,p,y),d.displayIds.add(this._current.id)}}return!0}_addOverlap(r,n,o,a){this._current.overlaps|=255^((r<0+o?Mi:r>=I.I_-o?vi:Mi|vi)|(n<0+a?bi:n>=I.I_-a?Si:bi|Si))}_getVertexWriter(r){if(!this._data.self.has(r)){const n=this._data.self,o=(0,ee.$_)(r,this._symbologyType).geometry;n.set(r,new yi(r,o,this.hint.records))}return this._data.self.get(r)}}var Li=w(58774),Ti=w(21286),W=w(23841),Re=w(31478),ge=w(12225),X=w(7547),pt=w(40028),U=w(81295),L=w(5254),O=w(18716);const lt=0,ht=100;function Ii(l,r,n){return l[0]=r[0]-n[0],l[1]=r[1]-n[1],l}function wi(l,r){return Math.sqrt(l*l+r*r)}function Wi(l){const r=wi(l[0],l[1]);l[0]/=r,l[1]/=r}function lr(l,r){return wi(l[0]-r[0],l[1]-r[1])}function R(l){return"function"==typeof l}function Ae(l=2){return 1/Math.max(l,1)}function St(l,r){return[!!l?.minScale&&r.scaleToZoom(l.minScale)||lt,!!l?.maxScale&&r.scaleToZoom(l.maxScale)||ht]}function zi(l){return l.length-1}function cr(l,r,n=1){const[o,a]=function hr(l,r){return l[r+1]}(l,r);return Math.sqrt(o*o+a*a)*n}class ie{constructor(r,n,o,a,h){this._segments=r,this._index=n,this._distance=o,this._xStart=a,this._yStart=h,this._done=!1}static create(r){return new ie(r,0,0,r[0][0],r[0][1])}clone(){return new ie(this._segments,this._index,this._distance,this.xStart,this.yStart)}equals(r){return this._index===r._index||r._index===this._index-1&&(0===this._distance||1===r._distance)||r._index===this._index+1&&(1===this._distance||0===r._distance)}leq(r){return this._index<r._index||this._index===r._index&&this._distance<=r._distance}geq(r){return this._index>r._index||this._index===r._index&&this._distance>=r._distance}get _segment(){return this._segments[this._index+1]}get angle(){const r=this.dy;let o=Math.acos((0*r+-1*-this.dx)/(1*this.length));return r>0&&(o=2*Math.PI-o),o}get xStart(){return this._xStart}get yStart(){return this._yStart}get x(){return this.xStart+this.distance*this.dx}get y(){return this.yStart+this.distance*this.dy}get dx(){return this._segment[0]}get dy(){return this._segment[1]}get xMidpoint(){return this.xStart+.5*this.dx}get yMidpoint(){return this.yStart+.5*this.dy}get xEnd(){return this.xStart+this.dx}get yEnd(){return this.yStart+this.dy}get length(){const{dx:r,dy:n}=this;return Math.sqrt(r*r+n*n)}get remainingLength(){return this.length*(1-this._distance)}get backwardLength(){return this.length*this._distance}get distance(){return this._distance}get done(){return this._done}hasPrev(){return this._index-1>=0}hasNext(){return this._index+1<zi(this._segments)}next(){return this.hasNext()?(this._xStart+=this.dx,this._yStart+=this.dy,this._distance=0,this._index+=1,this):null}prev(){return this.hasPrev()?(this._index-=1,this._xStart-=this.dx,this._yStart-=this.dy,this._distance=1,this):(this._done=!0,null)}_seekBackwards(r,n){const o=this.backwardLength;if(r<=o)return this._distance=(o-r)/this.length,this;let a=this.backwardLength;for(;this.prev();){if(a+this.length>r)return this._seekBackwards(r-a);a+=this.length}return this._distance=0,n?this:null}seek(r,n=!1){if(r<0)return this._seekBackwards(Math.abs(r),n);if(r<=this.remainingLength)return this._distance=(this.backwardLength+r)/this.length,this;let o=this.remainingLength;for(;this.next();){if(o+this.length>r)return this.seek(r-o,n);o+=this.length}return this._distance=1,n?this:null}}function ur(l,r,n,o=!0){const a=function Ci(l){let r=0;for(let n=0;n<zi(l);n++)r+=cr(l,n);return r}(l),h=ie.create(l),c=a/2;if(!o)return h.seek(c),void n(h.clone(),0,c+0*r,a);const u=Math.max((a-r)/2,0),d=Math.floor(u/r);h.seek(c-d*r);for(let m=-d;m<=d;m++)h.x<512&&h.x>=0&&h.y<512&&h.y>=0&&n(h.clone(),m,c+m*r,a),h.seek(r)}function fr(l,r){if(r<=0)return;const o=l.length;if(o<3)return;const a=[];let h=0;a.push(0);for(let _=1;_<o;_++)h+=lr(l[_],l[_-1]),a.push(h);r=Math.min(r,.2*h);const c=[];c.push(l[0][0]),c.push(l[0][1]);const u=l[o-1][0],d=l[o-1][1],f=Ii([0,0],l[0],l[1]);Wi(f),l[0][0]+=r*f[0],l[0][1]+=r*f[1],Ii(f,l[o-1],l[o-2]),Wi(f),l[o-1][0]+=r*f[0],l[o-1][1]+=r*f[1];for(let _=1;_<o;_++)a[_]+=r;a[o-1]+=r;const m=.5*r;for(let _=1;_<o-1;_++){let p=0,y=0,g=0;for(let x=_-1;x>=0&&!(a[x+1]<a[_]-m);x--){const M=m+a[x+1]-a[_],v=a[x+1]-a[x],b=a[_]-a[x]<m?1:M/v;if(Math.abs(b)<1e-6)break;const C=b*b,P=b*M-.5*C*v,F=b*v/r,V=l[x+1],G=l[x][0]-V[0],K=l[x][1]-V[1];p+=F/P*(V[0]*b*M+.5*C*(M*G-v*V[0])-C*b*v*G/3),y+=F/P*(V[1]*b*M+.5*C*(M*K-v*V[1])-C*b*v*K/3),g+=F}for(let x=_+1;x<o&&!(a[x-1]>a[_]+m);x++){const M=m-a[x-1]+a[_],v=a[x]-a[x-1],b=a[x]-a[_]<m?1:M/v;if(Math.abs(b)<1e-6)break;const C=b*b,P=b*M-.5*C*v,F=b*v/r,V=l[x-1],G=l[x][0]-V[0],K=l[x][1]-V[1];p+=F/P*(V[0]*b*M+.5*C*(M*G-v*V[0])-C*b*v*G/3),y+=F/P*(V[1]*b*M+.5*C*(M*K-v*V[1])-C*b*v*K/3),g+=F}c.push(p/g),c.push(y/g)}c.push(u),c.push(d);for(let _=0,p=0;_<o;_++)l[_][0]=c[p++],l[_][1]=c[p++]}var Gt=w(82054),mr=w(72283),_r=w(95727);class Pi{static getPlacement(r,n,o,a,h){const c=(0,_r.W)(n);if(!c)return null;const u=(0,mr.GP)(r);return c.execute(u,n,o,a,h)}}var pr=w(25797);const et=(0,L.UJ)(4,4),xe=(0,L.UJ)(4,2),it=(0,L.UJ)(4,6),Ei=[xe,xe,it,it],Fi=[xe,it,xe,it],yr=[it,it,et,et],gr=[et,et,it,it],xr=[it,et,it,et],vr=[et,it,et,it],Vi=l=>class extends l{constructor(...r){super(...r),this._isCIM=!1,this._vertexBoundsScale=1,this.geometryType=A.LW.TEXT,this._aux=(0,L.Jz)(0,0,this._referenceSize,this._bitset)}bindTextInfo(r,n){this._shapingInfo=r&&r.length?(0,z.yw)(r,o=>(0,pr.Nr)(o,n,{scale:this._scale,angle:this._angle,xOffset:this._xOffset,yOffset:this._yOffset,hAlign:this._xAlignD,vAlign:this._yAlignD,maxLineWidth:Math.max(32,Math.min(this._lineWidth,512)),lineHeight:I.xm*Math.max(.25,Math.min(this._lineHeight,4)),decoration:this._decoration,isCIM:this._isCIM,hasBackground:!!this._backgroundColor,borderLineSize:this._borderLineSize})):null}_write(r,n,o,a){const h=n.getDisplayId();this._writeGeometry(r,n,h,o,a)}_writeGeometry(r,n,o,a,h){const c=this._shapingInfo;if((0,z.Wi)(c))return;if((0,z.pC)(this._textPlacement)){const d=h??n.readLegacyGeometryForDisplay();return this._writePlacedText(r,o,d,c,a)}const u=h?(0,Gt.oB)((0,Gt.GH)(h),2):"esriGeometryPolygon"===n.geometryType?n.readCentroid():n.readGeometryForDisplay();if(!(0,z.Wi)(u)){if(u.isPoint){const[d,f]=u.coords;return!r.hasAggregates&&r.hasPixelBufferEnabled&&(d<0||d>=512||f<0||f>=512)?void 0:this._writeGlyphs(r,o,{x:d,y:f},c)}u.forEachVertex((d,f)=>this._writeGlyphs(r,o,{x:d,y:f},c))}}_writePlacedText(r,n,o,a,h){const c=(0,z.Wg)(this._textPlacement),u=Pi.getPlacement(o,c,(0,W.F2)(1),r.tileKey,h.geometryEngine);if(!u)return;let d=u.next();for(;null!=d;){const f=-d.getAngle();a.setRotation(f);const m=d.tx,_=-d.ty;m<0||m>=512||_<0||_>=512||(this._writeGlyphs(r,n,{x:m,y:_},a),a.setRotation(-f)),d=u.next()}}_writeGlyphs(r,n,o,a){const h=O.m2.load(this._materialKey),c=(0,L.UJ)(Math.round(8*o.x),Math.round(8*o.y)),u=this._vertexBoundsScale,{bounds:d,background:f,glyphs:m}=a;m.length>0&&(this._borderLineColor||this._backgroundColor)&&(h.textureBinding=m[0].textureBinding,r.recordStart(n,h.data,this.geometryType,!0),this._writeBackgroundGeometry(r,n,o,d,f),r.recordEnd());const _=2*Math.max(d.width,d.height);for(const p of a.glyphs)h.textureBinding=p.textureBinding,r.recordStart(n,h.data,this.geometryType,!0),r.vertexBounds(o.x+d.x+this._xOffset,o.y+d.y-this._yOffset,_*u,_*u),this._writeVertices(r,n,c,p),r.recordEnd()}_writeGlyph(r,n,o,a,h){const c=O.m2.load(this._materialKey),u=(0,L.UJ)(Math.round(8*o),Math.round(8*a));c.textureBinding=h.textureBinding,r.recordStart(n,c.data,this.geometryType,!0);const d=h.bounds,f=this._vertexBoundsScale;r.vertexBounds(o+d.x*f,a+d.y*f,d.width*f,d.height*f),this._writeVertices(r,n,u,h),r.recordEnd()}_writeVertices(r,n,o,a){const h=r.vertexCount();this._writeVertexCommon(r,n,o,a),r.vertexWrite(a.offsets.upperLeft),r.vertexWrite(a.texcoords.upperLeft),r.vertexEnd(),this._writeVertexCommon(r,n,o,a),r.vertexWrite(a.offsets.upperRight),r.vertexWrite(a.texcoords.upperRight),r.vertexEnd(),this._writeVertexCommon(r,n,o,a),r.vertexWrite(a.offsets.lowerLeft),r.vertexWrite(a.texcoords.lowerLeft),r.vertexEnd(),this._writeVertexCommon(r,n,o,a),r.vertexWrite(a.offsets.lowerRight),r.vertexWrite(a.texcoords.lowerRight),r.vertexEnd(),r.indexWrite(h+0),r.indexWrite(h+1),r.indexWrite(h+2),r.indexWrite(h+1),r.indexWrite(h+3),r.indexWrite(h+2)}_writeVertexCommon(r,n,o,a){const h=this._color,c=this._haloColor,u=(0,L.Jz)(0,0,this._referenceSize,this._bitset),d=(0,L.Jz)(0,0,this._size,this._haloSize);r.vertexWrite(o),r.vertexWrite(n),r.vertexWrite(h),r.vertexWrite(c),r.vertexWrite(d),r.vertexWrite(u),r.vertexWrite(this._minMaxZoom)}_writeBackgroundVertex(r,n,o,a,h,c){const u=(0,L.Jz)(0,1,this._referenceSize,this._bitset),d=(0,L.Jz)(0,0,this._size,this._haloSize),f=(0,L.Jz)(0,0,0,0);r.vertexWrite(o),r.vertexWrite(n),r.vertexWrite(a),r.vertexWrite(f),r.vertexWrite(d),r.vertexWrite(u),r.vertexWrite(this._minMaxZoom),r.vertexWrite(h),r.vertexWrite(c),r.vertexEnd()}_writeBackgroundQuad(r,n,o,a,h,c){const u=r.vertexCount();this._writeBackgroundVertex(r,n,o,a,h.upperLeft,c[0]),this._writeBackgroundVertex(r,n,o,a,h.upperRight,c[1]),this._writeBackgroundVertex(r,n,o,a,h.lowerLeft,c[2]),this._writeBackgroundVertex(r,n,o,a,h.lowerRight,c[3]),r.indexWrite(u+0),r.indexWrite(u+1),r.indexWrite(u+2),r.indexWrite(u+1),r.indexWrite(u+3),r.indexWrite(u+2)}_writeBackgroundGeometry(r,n,o,a,h){const c=(0,L.UJ)(Math.round(8*o.x),Math.round(8*o.y)),{x:u,y:d,width:f,height:m}=a,_=2*Math.max(f,m);if(r.vertexBounds(o.x+u+this._xOffset,o.y+d-this._yOffset,_*this._vertexBoundsScale,_*this._vertexBoundsScale),this._backgroundColor&&this._writeBackgroundQuad(r,n,c,this._backgroundColor,h.main,[et,et,et,et]),this._borderLineColor||this._backgroundColor){const p=!!this._borderLineColor&&!!this._borderLineSize&&this._borderLineSize>0,[y,g,x,M,v]=p?[Ei,Ei,Fi,Fi,this._borderLineColor]:[yr,gr,xr,vr,this._backgroundColor];this._writeBackgroundQuad(r,n,c,v,h.top,y),this._writeBackgroundQuad(r,n,c,v,h.bot,g),this._writeBackgroundQuad(r,n,c,v,h.left,x),this._writeBackgroundQuad(r,n,c,v,h.right,M)}}};var Oe=w(73608);class re{constructor(){this._materialKey=null}bindFeature(r,n,o){}write(r,n,o,a){if((0,z.Wi)(this._effects)||0===this._effects?.length)return this._write(r,n,a);const h=Oe.j.executeEffects(this._effects,n.readLegacyGeometryForDisplay(),r.tileKey,a.geometryEngine);let c=Oe.j.next(h);for(;c;)this._write(r,n,a,c),c=Oe.j.next(h)}_write(r,n,o,a){}}class Nt extends(Vi(re)){constructor(r,n,o,a,h,c,u,d,f,m,_,p,y,g,x,M,v,b,C,P,F,V,G,K){super(),this._xOffset=(0,W.F2)(y),this._yOffset=(0,W.F2)(g),this._decoration=m||"none",this._backgroundColor=V,this._borderLineColor=G,this._borderLineSize=K,this._color=h,this._haloColor=c,this._haloSize=Math.min(Math.floor(5*(0,W.F2)((0,W.t_)(o))),127),this._size=Math.min(Math.round((0,W.F2)(n)),127);const nt=Math.min(Math.round((0,W.F2)(a||n)),127);this._referenceSize=Math.round(Math.sqrt(256*nt)),this._scale=this._size/I.Ex,this._angle=p,this._justify=(0,pt.Hd)(u||"center"),this._xAlignD=(0,pt.kH)(u||"center"),this._yAlignD=(0,pt.b7)(d||"baseline"),this._baseline="baseline"===(d||"baseline"),this._bitset=(f===X.v2.MAP?1:0)|(_?1:0)<<1;const ot=O.m2.load(r);ot.sdf=!0,this._materialKey=ot.data,this._lineWidth=(0,W.F2)(x)||512,this._lineHeight=M||1,this._textPlacement=v,this._effects=b,this._isCIM=C??!1,this._minMaxZoom=(0,L.UJ)(Math.round(P*I.MI),Math.round(F*I.MI))}static fromText(r,n){const o=r.font?.size,a=new Nt(r.materialKey,o,r.haloSize||0,o,r.color&&(0,U.aH)(r.color)||0,r.haloColor&&(0,U.aH)(r.haloColor)||0,r.horizontalAlignment,r.verticalAlignment,X.v2.SCREEN,r.font?.decoration,!1,r.angle||0,r.xoffset||0,r.yoffset||0,r.lineWidth||0,r.lineHeight||0,null,null,!1,lt,ht,r.backgroundColor&&(0,U.aH)(r.backgroundColor),r.borderLineColor&&(0,U.aH)(r.borderLineColor),r.borderLineSize),[,h]=(0,E.E)(r.text);return a.bindTextInfo(n??[],h),a._vertexBoundsScale=r.maxVVSize&&o?r.maxVVSize/o:1,a}static fromCIMText(r,n,o){const a=r.scaleFactor||1,h=r.size*r.sizeRatio*a,[c,u]=St(r.scaleInfo,o),d=new Nt(r.materialKey,h,r.outlineSize*r.sizeRatio,r.referenceSize,(0,U.t2)(r.color),(0,U.t2)(r.outlineColor),r.horizontalAlignment,r.verticalAlignment,r.alignment,r.decoration,r.colorLocked??!1,r.angle,r.offsetX*r.sizeRatio*a,r.offsetY*r.sizeRatio*a,512,1,r.markerPlacement,r.effects,!0,c,u,r.backgroundColor?(0,U.t2)(r.backgroundColor):void 0,r.borderLineColor?(0,U.t2)(r.borderLineColor):void 0,r.borderLineWidth),[,f]=(0,E.E)(r.text);return d.bindTextInfo(n,f),d._vertexBoundsScale=r.maxVVSize?r.maxVVSize/h:1,d}}const Bi=mt.Z.getLogger("esri.views.2d.engine.webgl.WGLLabelTemplate"),wr=function Ir(l){const r=new Map;return n=>(r.has(n)||r.set(n,l(n)),r.get(n))}(l=>{let r=0;if(0===l)return 1/0;for(;!(l%2);)r++,l/=2;return r}),Me=l=>Math.floor(127*l+127),Wt=l=>Math.floor(10*l),bt=l=>Math.round(l*(254/360));class Se extends Nt{constructor(r,n,o,a){super(r,o.font?.size,o.haloSize||0,o.font?.size,o.color&&(0,U.aH)(o.color)||0,o.haloColor&&(0,U.aH)(o.haloColor)||0,o.horizontalAlignment,o.verticalAlignment,(0,pt.NS)(n.labelPlacement)?X.v2.MAP:X.v2.SCREEN,o.font?.decoration,!1,o.angle||0,o.xoffset,o.yoffset,o.lineWidth,o.lineHeight,null,null,!1,null,null,o.backgroundColor&&(0,U.aH)(o.backgroundColor),o.borderLineColor&&(0,U.aH)(o.borderLineColor),o.borderLineSize),this._outLineLabelAngle=0,this._refPlacementPadding=0,this._refPlacementDirX=0,this._refPlacementDirY=0,this._refOffsetX=0,this._refOffsetY=0,this._zoomLevel=0,this.geometryType=A.LW.LABEL,this._allowOverrun=n.allowOverrun??!1,this._repeatLabel=n.repeatLabel??!0,this._labelPosition=n.labelPosition??"curved";const h=function Lr(l,r){const n=!!l.minScale&&r.scaleToZoom(l.minScale)||0;return(0,Ti.uZ)(n,0,25.5)}(n,a),c=function Tr(l,r){const n=!!l.maxScale&&r.scaleToZoom(l.maxScale)||255;return(0,Ti.uZ)(n,0,25.5)}(n,a),u=n.labelPlacement,[d,f]=(0,pt.qv)(u);this._xAlignD=d,this._yAlignD=f,this._minZoom=h,this._maxZoom=c,this._minBackgroundZoom=h,this._maxBackgroundZoom=c,this._refPlacementPadding=(0,W.F2)(o.haloSize)+I.Iw,this._repeatLabelDistance=n.repeatLabelDistance?(0,W.F2)(n.repeatLabelDistance):128;const m=O.Gq.load(r);m.sdf=!0,this._materialKey=m.data}static fromLabelClass(r,n){if("esriServerLinePlacementCenterAlong"===r.labelPlacement){const o=r.symbol;o.xoffset=0,o.yoffset=0,o.angle=0,o.font.decoration="none"}return new Se(r.materialKey,r,r.symbol,n)}get _shapedBox(){return(0,z.Wg)(this._shapingInfo).bounds}setZoomLevel(r){this._zoomLevel=r}bindReferenceTemplate(r){let n=(0,pt.g)(this._xAlignD),o=(0,pt.tf)(this._yAlignD);if(this._refOffsetX=0,this._refOffsetY=0,(0,z.Wi)(r))return void(this._refSymbolAndPlacementOffset=(0,L.Jz)(0,0,Me(n),Me(o)));if("circle"===r.boundsType&&(n||o)){const c=Math.sqrt(n*n+o*o);n/=c,o/=c}const a=Math.max(r.height,r.width);this._refSymbolAndPlacementOffset=(0,L.Jz)(4*this._refPlacementPadding,a,Me(n),Me(o)),this._referenceSize=a,this._refPlacementDirX=n,this._refPlacementDirY=o,this._refOffsetX=r.xOffset,this._refOffsetY=r.yOffset}_write(r,n){if((0,z.Wi)(this._shapingInfo))return;const o=this._shapingInfo,a=n.getDisplayId(),h="esriGeometryPolygon"===n.geometryType?n.readLegacyCentroid():n.readLegacyGeometry();if(h)switch(this._current={out:r,inId:a,inShaping:o,zoomLevel:this._zoomLevel},"esriGeometryPolyline"===n.geometryType&&"curved"===this._labelPosition&&(this._borderLineColor||this._backgroundColor)&&Bi.warnOnce("TextSymbol properties 'borderLineColor', 'borderLineSize', and 'backgroundColor' are not supported in curved labels"),n.geometryType){case"esriGeometryPolyline":this._placeLineLabels(h);break;case"esriGeometryPoint":case"esriGeometryPolygon":this._placePointLabels(h);break;default:((l,r="mapview-labeling")=>{Bi.error(new ft.Z(r,l))})(`Geometry of type ${n.geometryType} is not supported`)}}_isVisible(r,n){const o=Wt(this._current.zoomLevel);return Wt(r)<=o&&o<=Wt(n)}_placePointLabels(r){const{out:n,inId:o,inShaping:a}=this._current;this._writeGlyphs(n,o,r,a)}_placeLineLabels(r){const n=function dr(l,r){const n=r;for(let o=0;o<l.length;o++){let a=l[o];const h=[];h.push(a[0]);for(let u=1;u<a.length;u++){let[d,f]=h[u-1];d+=a[u][0],f+=a[u][1],h.push([d,f])}fr(h,n);const c=[];c.push(h[0]);for(let u=1;u<h.length;u++){const[d,f]=h[u-1],[m,_]=h[u],p=Math.round(m-d),y=Math.round(_-f);c.push([p,y])}l[o]=c,a=c}return l}(r.paths,this._current.inShaping.bounds.width),o=this._placeSubdivGlyphs.bind(this),a=(this._shapedBox.width+this._repeatLabelDistance)/2;for(const h of n)ur(h,a,o,this._repeatLabel)}_placeSubdivGlyphs(r,n,o,a){const h=wr(n),c=this._shapedBox.width/2,u=Math.sqrt(this._repeatLabelDistance)/2,d=Math.min(o,a-o),f=this._current.inShaping.isMultiline?25:Math.log2(d/(u+c/2)),m=0===n?f:Math.min(h,f),_=Math.max(this._minZoom,this._current.zoomLevel+1-m),p=this._current.zoomLevel-_,y=this._shapedBox.width/2*2**p;this._current.inShaping.isMultiline?0===n&&this._placeStraight(r,_):this._allowOverrun&&p<0?this._placeStraightAlong(r,this._minZoom):"parallel"===this._labelPosition?this._placeStraightAlong(r,_):"curved"===this._labelPosition&&this._placeCurved(r,_,y)}_placeStraight(r,n){const{out:o,inId:a,inShaping:h}=this._current,c=Math.ceil(r.angle*(180/Math.PI)%360),u=Math.ceil((r.angle*(180/Math.PI)+180)%360);this._outLineLabelAngle=bt(c),this._writeGlyphs(o,a,r,h,n),this._outLineLabelAngle=bt(u),this._writeGlyphs(o,a,r,h,n)}_placeCurved(r,n,o){const{out:a,inId:h}=this._current;a.metricStart(h,n,r.x,r.y,0,0,0,0);const c=r.clone(),u=r.angle*(180/Math.PI)%360,d=(r.angle*(180/Math.PI)+180)%360;this._outLineLabelAngle=bt(u),this._placeFirst(c,n,1),this._placeBack(r,c,n,o,1),this._placeForward(r,c,n,o,1),this._outLineLabelAngle=bt(d),this._placeFirst(c,n,0),this._placeBack(r,c,n,o,0),this._placeForward(r,c,n,o,0),a.metricEnd()}_placeStraightAlong(r,n){const{out:o,inId:a,inShaping:h}=this._current;o.metricStart(a,n,r.x,r.y,0,0,0,0);const c=r.clone(),u=r.angle*(180/Math.PI)%360,d=(r.angle*(180/Math.PI)+180)%360,f=h.glyphs.length>0&&(this._borderLineColor||this._backgroundColor);if(this._maxBackgroundZoom=25,this._minBackgroundZoom=Math.max(n,0),f){const m=O.Gq.load(this._materialKey);m.textureBinding=h.glyphs[0].textureBinding;const _=(0,Re.b)((0,ge.c)(),-r.angle),[p,y]=h.shapeBackground(_);this._outLineLabelAngle=bt(u),o.recordStart(a,m.data,this.geometryType,!0),this._writeBackgroundGeometry(o,a,r,p,y),o.recordEnd(),this._outLineLabelAngle=bt(d),o.recordStart(a,m.data,this.geometryType,!0),this._writeBackgroundGeometry(o,a,r,p,y),o.recordEnd()}this._outLineLabelAngle=bt(u),this._placeFirst(c,n,1,!0),this._outLineLabelAngle=bt(d),this._placeFirst(c,n,0,!0),o.metricEnd()}_placeBack(r,n,o,a,h){const c=r.clone();let u=r.backwardLength+0;for(;c.prev()&&!(u>=a);)this._placeOnSegment(c,n,u,o,-1,h),u+=c.length+0}_placeForward(r,n,o,a,h){const c=r.clone();let u=r.remainingLength+0;for(;c.next()&&!(u>=a);)this._placeOnSegment(c,n,u,o,1,h),u+=c.length+0}_placeFirst(r,n,o,a=!1){const h=r,c=this._current.inShaping,u=c.glyphs,d=this._current.zoomLevel,{out:f,inId:m}=this._current;for(const _ of u){const p=_.x>c.bounds.x?o:1-o,y=p*r.remainingLength+(1-p)*r.backwardLength,g=Math.abs(_.x+_.width/2-c.bounds.x),x=Math.max(0,d+Math.log2(g/(y+0))),M=Math.max(n,a?0:x);if(_.maxZoom=25,_.angle=r.angle+(1-o)*Math.PI,_.minZoom=M,this._writeGlyph(f,m,h.x,h.y,_),o&&this._isVisible(_.minZoom,_.maxZoom)){const v=_.bounds;f.metricBoxWrite(v.center[0],v.center[1],v.width,v.height)}}}_placeOnSegment(r,n,o,a,h,c){const u=this._current.inShaping.glyphs,{out:d,inId:f}=this._current,m=this._current.inShaping,_=this._current.zoomLevel,g={x:r.x+o*-h*(r.dx/r.length),y:r.y+o*-h*(r.dy/r.length)};for(const x of u){const M=x.x>m.bounds.x?c:1-c;if(!(M&&1===h||!M&&-1===h))continue;const v=Math.abs(x.x+x.width/2-m.bounds.x),b=Math.max(0,_+Math.log2(v/o)-.1),C=Math.max(a,_+Math.log2(v/(o+r.length+0)));if(0!==b&&(x.angle=r.angle+(1-c)*Math.PI,x.minZoom=C,x.maxZoom=b,this._writeGlyph(d,f,g.x,g.y,x),c&&this._isVisible(x.minZoom,x.maxZoom))){const P=x.bounds;d.metricBoxWrite(P.center[0]+(r.x-n.x),P.center[1]+(r.y-n.y),P.width,P.height)}}}_writeGlyphs(r,n,o,a,h=this._minZoom){if(o.x<0||o.x>=512||o.y<0||o.y>=512)return;if(a.glyphs.length>0&&(this._borderLineColor||this._backgroundColor)){const _=O.Gq.load(this._materialKey);_.textureBinding=a.glyphs[0].textureBinding,r.recordStart(n,_.data,this.geometryType,!0),this._writeBackgroundGeometry(r,n,o,a.bounds,a.background),r.recordEnd()}const c=o.x+this._refOffsetX,u=o.y-this._refOffsetY;for(const _ of a.glyphs)_.minZoom=h,_.maxZoom=this._maxZoom,this._writeGlyph(r,n,c,u,_);const m=a.boundsT;r.metricStart(n,h,c,u,this._refPlacementDirX,this._refPlacementDirY,this._referenceSize,this._materialKey),r.metricBoxWrite(m.center[0],m.center[1],m.width,m.height),r.metricEnd()}_writeVertexCommon(r,n,o,a){const h=this._color,c=this._haloColor,u=(0,L.Jz)(0,0,this._size,this._haloSize),d=Math.max(a.minZoom,this._minZoom),f=Math.min(a.maxZoom,this._maxZoom),m=(0,L.Jz)(Wt(d),Wt(f),this._outLineLabelAngle,0);r.vertexWrite(o),r.vertexWrite(n),r.vertexWrite(h),r.vertexWrite(c),r.vertexWrite(u),r.vertexWrite(this._refSymbolAndPlacementOffset),r.vertexWrite(m)}_writeBackgroundVertex(r,n,o,a,h,c){const u=(0,L.Jz)(0,0,this._size,this._haloSize),d=(0,L.Jz)(0,0,0,0),f=(0,L.Jz)(Wt(this._minBackgroundZoom),Wt(this._maxBackgroundZoom),this._outLineLabelAngle,1);r.vertexWrite(o),r.vertexWrite(n),r.vertexWrite(a),r.vertexWrite(d),r.vertexWrite(u),r.vertexWrite(this._refSymbolAndPlacementOffset),r.vertexWrite(f),r.vertexWrite(h),r.vertexWrite(c),r.vertexEnd()}}var be=w(9545);const ki=3.14159265359/180,Ai=l=>class extends l{constructor(...r){super(...r),this.angle=0,this.xOffset=0,this.yOffset=0,this.width=0,this.height=0,this.boundsType="square",this._anchorX=0,this._anchorY=0,this._computedWidth=0,this._computedHeight=0,this._allowBorrowing=!0,this._vertexBoundsScaleX=1,this._vertexBoundsScaleY=1,this._offsets={xUpperLeft:0,yUpperLeft:0,xUpperRight:0,yUpperRight:0,xBottomLeft:0,yBottomLeft:0,xBottomRight:0,yBottomRight:0},this.geometryType=A.LW.MARKER}_write(r,n,o,a){const h=n.getDisplayId();r.recordStart(h,this._materialKey,this.geometryType,!0),this._writeGeometry(r,n,h,o,a),r.recordEnd()}_writeGeometry(r,n,o,a,h){if((0,z.pC)(this._markerPlacement))return this._writePlacedMarkers(r,n,a,h);if(this._allowBorrowing=!0,!h&&"esriGeometryPoint"===n.geometryType){const u=n.getX(),d=n.getY();return!r.hasAggregates&&r.hasPixelBufferEnabled&&(u<0||u>=513||d<0||d>=513)?void 0:this._writeVertices(r,o,this._getPos(u,d),u,d)}const c=h?(0,Gt.oB)((0,Gt.GH)(h),2):"esriGeometryPolygon"===n.geometryType?n.readCentroid():n.readGeometryForDisplay();if(!(0,z.Wi)(c)){if(c.isPoint){const[u,d]=c.coords;return!r.hasAggregates&&r.hasPixelBufferEnabled&&(u<0||u>=512||d<0||d>=512)?void 0:this._writeVertices(r,o,this._getPos(u,d),u,d)}c.forEachVertex((u,d)=>{const f=2*I.I_;u<-f||u>=f||d<-f||d>=f||this._writeVertices(r,o,this._getPos(u,d),u,d)})}}_writePlacedMarkers(r,n,o,a){const h=a??n.readLegacyGeometryForDisplay(),c=Pi.getPlacement(h,(0,z.Wg)(this._markerPlacement),(0,W.F2)(1),r.tileKey,o.geometryEngine);if(!c)return;this._allowBorrowing="esriGeometryPolygon"!==n.geometryType;const u=n.getDisplayId(),d=(0,be.c)(),f=(0,ge.c)();let p=c.next();for(;null!=p;){const y=p.tx,g=-p.ty;y>=-128&&y<=640&&g>=-128&&g<=640&&(this._applyTransformation(f,d,-p.getAngle()/ki),this._writeVertices(r,u,this._getPos(y,g),y,g)),p=c.next()}}_writeVertices(r,n,o,a,h){const c=O.mE.load(this._materialKey);return c.symbologyType===A.mD.HEATMAP?this._writeHeatmapVertices(r,n,o):this._writeMarkerVertices(r,n,c,o,a,h)}_writeMarkerVertices(r,n,o,a,h,c){const u=o.vvRotation,d=r.vertexCount();let f=this._computedWidth*this._vertexBoundsScaleX,m=this._computedHeight*this._vertexBoundsScaleY;if(this.angle){const _=Math.max(f,m);f=_,m=_}if(u){const _=Math.max(this.xOffset,this.yOffset);f+=_,m+=_}this._allowBorrowing&&r.vertexBounds(h+this.xOffset,c-this.yOffset,f,m),r.vertexWrite(a),r.vertexWrite(this._offsetUpperLeft),r.vertexWrite(this._texUpperLeft),r.vertexWrite(this._bitestAndDistRatio),r.vertexWrite(n),r.vertexWrite(this._fillColor),r.vertexWrite(this._outlineColor),r.vertexWrite(this._sizeOutlineWidth),r.vertexWrite(this._minMaxZoom),r.vertexEnd(),r.vertexWrite(a),r.vertexWrite(this._offsetUpperRight),r.vertexWrite(this._texUpperRight),r.vertexWrite(this._bitestAndDistRatio),r.vertexWrite(n),r.vertexWrite(this._fillColor),r.vertexWrite(this._outlineColor),r.vertexWrite(this._sizeOutlineWidth),r.vertexWrite(this._minMaxZoom),r.vertexEnd(),r.vertexWrite(a),r.vertexWrite(this._offsetBottomLeft),r.vertexWrite(this._texBottomLeft),r.vertexWrite(this._bitestAndDistRatio),r.vertexWrite(n),r.vertexWrite(this._fillColor),r.vertexWrite(this._outlineColor),r.vertexWrite(this._sizeOutlineWidth),r.vertexWrite(this._minMaxZoom),r.vertexEnd(),r.vertexWrite(a),r.vertexWrite(this._offsetBottomRight),r.vertexWrite(this._texBottomRight),r.vertexWrite(this._bitestAndDistRatio),r.vertexWrite(n),r.vertexWrite(this._fillColor),r.vertexWrite(this._outlineColor),r.vertexWrite(this._sizeOutlineWidth),r.vertexWrite(this._minMaxZoom),r.vertexEnd(),this._writeIndices(r,d)}_writeHeatmapVertices(r,n,o){const a=r.vertexCount();r.vertexWrite(o),r.vertexWrite(this._offsetUpperLeft),r.vertexWrite(n),r.vertexEnd(),r.vertexWrite(o),r.vertexWrite(this._offsetUpperRight),r.vertexWrite(n),r.vertexEnd(),r.vertexWrite(o),r.vertexWrite(this._offsetBottomLeft),r.vertexWrite(n),r.vertexEnd(),r.vertexWrite(o),r.vertexWrite(this._offsetBottomRight),r.vertexWrite(n),r.vertexEnd(),this._writeIndices(r,a)}_writeIndices(r,n){r.indexWrite(n+0),r.indexWrite(n+1),r.indexWrite(n+2),r.indexWrite(n+1),r.indexWrite(n+3),r.indexWrite(n+2)}_applyTransformation(r,n,o=0){(0,Re.a)(r,(0,be.f)(this.xOffset,-this.yOffset)),null!=this.angle&&this.angle+o!==0&&(0,Re.r)(r,r,ki*(this.angle+o));const a=this._computedWidth,h=this._computedHeight,c=-(.5+this._anchorX)*a,u=-(.5-this._anchorY)*h;(0,q.s)(n,c,u),(0,q.t)(n,n,r),this._offsetUpperLeft=(0,L.UJ)(16*n[0],16*n[1]),this._offsets.xUpperLeft=n[0],this._offsets.yUpperLeft=n[1],(0,q.s)(n,c+a,u),(0,q.t)(n,n,r),this._offsetUpperRight=(0,L.UJ)(16*n[0],16*n[1]),this._offsets.xUpperRight=n[0],this._offsets.yUpperRight=n[1],(0,q.s)(n,c,u+h),(0,q.t)(n,n,r),this._offsetBottomLeft=(0,L.UJ)(16*n[0],16*n[1]),this._offsets.xBottomLeft=n[0],this._offsets.yBottomLeft=n[1],(0,q.s)(n,c+a,u+h),(0,q.t)(n,n,r),this._offsetBottomRight=(0,L.UJ)(16*n[0],16*n[1]),this._offsets.xBottomRight=n[0],this._offsets.yBottomRight=n[1]}_getPos(r,n){return(0,L.UJ)(Math.round(8*r),Math.round(8*n))}};class ct extends(Ai(re)){constructor(r,n,o,a,h,c,u,d,f,m,_,p,y,g,x,M,v,b,C,P,F,V,G){super(),this.angle=a,this.height=u,this.width=c,this.xOffset=n*C,this.yOffset=o*C,this._markerPlacement=P,this._effects=F,this._anchorX=M,this._anchorY=v,this._minMaxZoom=(0,L.UJ)(Math.round(V*I.MI),Math.round(G*I.MI));const K=(g===X.v2.MAP?I.Tz:I.CQ)|(_?I.Uh:0)|(y?I.oK:0)|(p?I.e0:0),nt=x&&x.sdf,ot=O.mE.load(r);ot.sdf=nt,ot.pattern=!0,ot.textureBinding=x.textureBinding,this._materialKey=ot.data,this._fillColor=h,this._outlineColor=f,this._sizeOutlineWidth=(0,L.Jz)(Math.round(Math.min(Math.sqrt(128*c),255)),Math.round(Math.min(Math.sqrt(128*u),255)),Math.round(Math.min(Math.sqrt(128*m),255)),Math.round(Math.min(Math.sqrt(128*d),255)));const Tt=x.rect.x+I.fL,dt=x.rect.y+I.fL,Qt=Tt+x.width,$t=dt+x.height;this._offsets.xUpperLeft=Tt,this._offsets.yUpperLeft=dt,this._offsets.xUpperRight=Qt,this._offsets.yUpperRight=dt,this._offsets.xBottomLeft=Tt,this._offsets.yBottomLeft=$t,this._offsets.xBottomRight=Qt,this._offsets.yBottomRight=$t,ot.symbologyType===A.mD.PIE_CHART?(this._texUpperLeft=(0,L.UJ)(0,1),this._texUpperRight=(0,L.UJ)(1,1),this._texBottomLeft=(0,L.UJ)(0,0),this._texBottomRight=(0,L.UJ)(1,0)):(this._texUpperLeft=(0,L.UJ)(Tt,dt),this._texUpperRight=(0,L.UJ)(Qt,dt),this._texBottomLeft=(0,L.UJ)(Tt,$t),this._texBottomRight=(0,L.UJ)(Qt,$t)),c*=b,u*=b,c*=C,u*=C;const Es=Math.round(64*b);this._bitestAndDistRatio=(0,L.UJ)(K,Es),this._computedWidth=c,this._computedHeight=u;const Fs=(0,be.c)(),Vs=(0,ge.c)();this._applyTransformation(Vs,Fs)}static fromCIMMarker(r,n,o){const c=r.size,u=(n&&n.width||1)/(n&&n.height||1)*r.scaleX,d=r.scaleSymbolsProportionally&&r.frameHeight?c/r.frameHeight:1,f=(0,U.t2)(r.color),m=(0,U.t2)(r.outlineColor),_=(0,W.F2)(c),p=_*u,y=(0,W.F2)(r.offsetX||0),g=(0,W.F2)(r.offsetY||0),x=(0,W.F2)(r.outlineWidth||0)*d,M=r.alignment||X.v2.SCREEN,v=(0,W.F2)(r.referenceSize),[b,C]=St(r.scaleInfo,o);let P=r.rotation||0;r.rotateClockwise||(P=-P);let F=0,V=0;const G=r.anchorPoint;G&&(r.isAbsoluteAnchorPoint?c&&(F=G.x/(c*u),V=G.y/c):(F=G.x,V=G.y));const K=new ct(r.materialKey,y,g,P,f,p,_,v,m,x,r.colorLocked,r.scaleSymbolsProportionally,!1,M,n,F,V,r.sizeRatio,(0,z.Pt)(r.scaleFactor,1),r.markerPlacement,r.effects,b,C);return K._vertexBoundsScaleX=r.maxVVSize?r.maxVVSize/p:1,K._vertexBoundsScaleY=r.maxVVSize?r.maxVVSize/_:1,K}static fromPictureMarker(r,n){const o=Math.round((0,W.F2)(r.width)),a=Math.round((0,W.F2)(r.height)),h=I.ru,c=Math.round((0,W.F2)(r.xoffset||0)),u=Math.round((0,W.F2)(r.yoffset||0)),d=new ct(r.materialKey,c,u,r.angle,h,o,a,a,0,0,!1,!1,!1,X.v2.SCREEN,n,0,0,1,1,null,null,lt,ht);return d._vertexBoundsScaleX=r.maxVVSize?r.maxVVSize/r.width:1,d._vertexBoundsScaleY=r.maxVVSize?r.maxVVSize/r.height:1,d}static fromSimpleMarker(r,n){const o=(0,U.aH)(r.color),a=Math.round((0,W.F2)(r.size)),h=a,c=Math.round((0,W.F2)(r.xoffset||0)),u=Math.round((0,W.F2)(r.yoffset||0)),d=r.style,f=r.outline,m=0|(f?.color&&(0,U.aH)(f.color)),_=0|(f?.width&&Math.round((0,W.F2)(f.width))),p=new ct(r.materialKey,c,u,r.angle,o,a,h,h,m,_,!1,!1,"esriSMSCross"===d||"esriSMSX"===d,X.v2.SCREEN,n,0,0,126/64,1,null,null,lt,ht);return p.boundsType="esriSMSCircle"===d?"circle":"square",p._vertexBoundsScaleX=r.maxVVSize?r.maxVVSize/r.size:1,p._vertexBoundsScaleY=r.maxVVSize?r.maxVVSize/r.size:1,p}static fromLineSymbolMarker(r,n){const o=(0,U.aH)(r.color),h=Math.round((0,W.F2)(6*r.lineWidth)),c=h,u="cross"===r.style||"x"===r.style;let d;switch(r.placement){case"begin-end":d=X.Tx.Both;break;case"begin":d=X.Tx.JustBegin;break;case"end":d=X.Tx.JustEnd;break;default:d=X.Tx.None}const f={type:"CIMMarkerPlacementAtExtremities",angleToLine:!0,offset:0,extremityPlacement:d,offsetAlongLine:0},m=new ct(r.materialKey,0,0,0,o,h,c,c/6,o,u?Math.round((0,W.F2)(r.lineWidth)):0,!1,!1,u,X.v2.MAP,n,0,0,126/64,1,f,null,lt,ht);return m.boundsType="circle"===r.style?"circle":"square",m}}var Xt=w(24837),Ze=w(43289),Le=(w(11915),w(13160)),Wr=w(88071);function zr(l,r,n,o,a,h,c){Ne=0;const u=(o-n)*h,d=a&&a.length,f=d?(a[0]-n)*h:u;let m,_,p,y,g,x=Ui(r,n,0,0,f,h,!0);if(x&&x.next!==x.prev){if(d&&(x=function Fr(l,r,n,o,a,h){const c=new Array;for(let u=0,d=o.length;u<d;u++){const f=Ui(l,r,0,o[u]*h,u<d-1?o[u+1]*h:n*h,h,!1);f===f.next&&(f.steiner=!0),c.push(Er(f))}c.sort(Ur);for(const u of c)a=Vr(u,a);return a}(r,n,o,a,x,h)),u>80*h){m=p=r[0+n*h],_=y=r[1+n*h];for(let M=h;M<f;M+=h){const v=r[M+n*h],b=r[M+1+n*h];m=Math.min(m,v),_=Math.min(_,b),p=Math.max(p,v),y=Math.max(y,b)}g=Math.max(p-m,y-_),g=0!==g?1/g:0}ne(x,l,h,m,_,g,c,0)}}function Ui(l,r,n,o,a,h,c){let u;if(c===function Ar(l,r,n,o,a,h){let c=0;for(let u=o,d=a-h;u<a;u+=h)c+=(l[d+r*h]-l[u+r*h])*(l[u+1+r*h]+l[d+1+r*h]),d=u;return c}(l,r,0,o,a,h)>0)for(let d=o;d<a;d+=h)u=Oi(d+r*h,l[d+r*h],l[d+1+r*h],u);else for(let d=a-h;d>=o;d-=h)u=Oi(d+r*h,l[d+r*h],l[d+1+r*h],u);return u&&zt(u,u.next)&&(oe(u),u=u.next),u}function se(l,r=l){if(!l)return l;let n,o=l;do{if(n=!1,o.steiner||!zt(o,o.next)&&0!==H(o.prev,o,o.next))o=o.next;else{if(oe(o),o=r=o.prev,o===o.next)break;n=!0}}while(n||o!==r);return r}function ne(l,r,n,o,a,h,c,u){if(!l)return;!u&&h&&(l=Di(l,o,a,h));let d=l;for(;l.prev!==l.next;){const f=l.prev,m=l.next;if(h?Pr(l,o,a,h):Cr(l))r.push(f.index/n+c),r.push(l.index/n+c),r.push(m.index/n+c),oe(l),l=m.next,d=m.next;else if((l=m)===d){u?1===u?ne(l=Or(l,r,n,c),r,n,o,a,h,c,2):2===u&&Dr(l,r,n,o,a,h,c):ne(se(l),r,n,o,a,h,c,1);break}}}function Cr(l){const r=l.prev,n=l,o=l.next;if(H(r,n,o)>=0)return!1;let a=l.next.next;const h=a;let c=0;for(;a!==l.prev&&(0===c||a!==h);){if(c++,Ht(r.x,r.y,n.x,n.y,o.x,o.y,a.x,a.y)&&H(a.prev,a,a.next)>=0)return!1;a=a.next}return!0}function Pr(l,r,n,o){const a=l.prev,h=l,c=l.next;if(H(a,h,c)>=0)return!1;const f=a.x>h.x?a.x>c.x?a.x:c.x:h.x>c.x?h.x:c.x,m=a.y>h.y?a.y>c.y?a.y:c.y:h.y>c.y?h.y:c.y,_=Ge(a.x<h.x?a.x<c.x?a.x:c.x:h.x<c.x?h.x:c.x,a.y<h.y?a.y<c.y?a.y:c.y:h.y<c.y?h.y:c.y,r,n,o),p=Ge(f,m,r,n,o);let y=l.prevZ,g=l.nextZ;for(;y&&y.z>=_&&g&&g.z<=p;){if(y!==l.prev&&y!==l.next&&Ht(a.x,a.y,h.x,h.y,c.x,c.y,y.x,y.y)&&H(y.prev,y,y.next)>=0||(y=y.prevZ,g!==l.prev&&g!==l.next&&Ht(a.x,a.y,h.x,h.y,c.x,c.y,g.x,g.y)&&H(g.prev,g,g.next)>=0))return!1;g=g.nextZ}for(;y&&y.z>=_;){if(y!==l.prev&&y!==l.next&&Ht(a.x,a.y,h.x,h.y,c.x,c.y,y.x,y.y)&&H(y.prev,y,y.next)>=0)return!1;y=y.prevZ}for(;g&&g.z<=p;){if(g!==l.prev&&g!==l.next&&Ht(a.x,a.y,h.x,h.y,c.x,c.y,g.x,g.y)&&H(g.prev,g,g.next)>=0)return!1;g=g.nextZ}return!0}function Oi(l,r,n,o){const a=jt.create(l,r,n);return o?(a.next=o.next,a.prev=o,o.next.prev=a,o.next=a):(a.prev=a,a.next=a),a}function oe(l){l.next.prev=l.prev,l.prev.next=l.next,l.prevZ&&(l.prevZ.nextZ=l.nextZ),l.nextZ&&(l.nextZ.prevZ=l.prevZ)}function Er(l){let r=l,n=l;do{(r.x<n.x||r.x===n.x&&r.y<n.y)&&(n=r),r=r.next}while(r!==l);return n}function Vr(l,r){const n=function Br(l,r){let n=r;const o=l.x,a=l.y;let h,c=-1/0;do{if(a<=n.y&&a>=n.next.y&&n.next.y!==n.y){const p=n.x+(a-n.y)*(n.next.x-n.x)/(n.next.y-n.y);if(p<=o&&p>c){if(c=p,p===o){if(a===n.y)return n;if(a===n.next.y)return n.next}h=n.x<n.next.x?n:n.next}}n=n.next}while(n!==r);if(!h)return null;if(o===c)return h.prev;const u=h,d=h.x,f=h.y;let m,_=1/0;for(n=h.next;n!==u;)o>=n.x&&n.x>=d&&o!==n.x&&Ht(a<f?o:c,a,d,f,a<f?c:o,a,n.x,n.y)&&(m=Math.abs(a-n.y)/(o-n.x),(m<_||m===_&&n.x>h.x)&&ae(n,l)&&(h=n,_=m)),n=n.next;return h}(l,r);if(!n)return r;const o=Gi(n,l);return se(o,o.next),se(n,n.next)}function Di(l,r,n,o){let a;for(;a!==l;a=a.next){if(a=a||l,null===a.z&&(a.z=Ge(a.x,a.y,r,n,o)),a.prev.next!==a||a.next.prev!==a)return a.prev.next=a,a.next.prev=a,Di(l,r,n,o);a.prevZ=a.prev,a.nextZ=a.next}return l.prevZ.nextZ=null,l.prevZ=null,function kr(l){let r,n=1;for(;;){let o,a=l;l=null,r=null;let h=0;for(;a;){h++,o=a;let c=0;for(;c<n&&o;c++)o=o.nextZ;let u=n;for(;c>0||u>0&&o;){let d;0===c?(d=o,o=o.nextZ,u--):0!==u&&o?a.z<=o.z?(d=a,a=a.nextZ,c--):(d=o,o=o.nextZ,u--):(d=a,a=a.nextZ,c--),r?r.nextZ=d:l=d,d.prevZ=r,r=d}a=o}if(r.nextZ=null,n*=2,h<2)return l}}(l)}function H(l,r,n){return(r.y-l.y)*(n.x-r.x)-(r.x-l.x)*(n.y-r.y)}function Zi(l,r,n,o){return!!(zt(l,r)&&zt(n,o)||zt(l,o)&&zt(n,r))||H(l,r,n)>0!=H(l,r,o)>0&&H(n,o,l)>0!=H(n,o,r)>0}function Ht(l,r,n,o,a,h,c,u){return(a-c)*(r-u)-(l-c)*(h-u)>=0&&(l-c)*(o-u)-(n-c)*(r-u)>=0&&(n-c)*(h-u)-(a-c)*(o-u)>=0}function ae(l,r){return H(l.prev,l,l.next)<0?H(l,r,l.next)>=0&&H(l,l.prev,r)>=0:H(l,r,l.prev)<0||H(l,l.next,r)<0}function Ge(l,r,n,o,a){return(l=1431655765&((l=858993459&((l=252645135&((l=16711935&((l=32767*(l-n)*a)|l<<8))|l<<4))|l<<2))|l<<1))|(r=1431655765&((r=858993459&((r=252645135&((r=16711935&((r=32767*(r-o)*a)|r<<8))|r<<4))|r<<2))|r<<1))<<1}function zt(l,r){return l.x===r.x&&l.y===r.y}function Ur(l,r){return l.x-r.x}function Or(l,r,n,o){let a=l;do{const h=a.prev,c=a.next.next;!zt(h,c)&&Zi(h,a,a.next,c)&&ae(h,c)&&ae(c,h)&&(r.push(h.index/n+o),r.push(a.index/n+o),r.push(c.index/n+o),oe(a),oe(a.next),a=l=c),a=a.next}while(a!==l);return a}function Dr(l,r,n,o,a,h,c){let u=l;do{let d=u.next.next;for(;d!==u.prev;){if(u.index!==d.index&&Zr(u,d)){let f=Gi(u,d);return u=se(u,u.next),f=se(f,f.next),ne(u,r,n,o,a,h,c,0),void ne(f,r,n,o,a,h,c,0)}d=d.next}u=u.next}while(u!==l)}function Zr(l,r){return l.next.index!==r.index&&l.prev.index!==r.index&&!function Rr(l,r){let n=l;do{if(n.index!==l.index&&n.next.index!==l.index&&n.index!==r.index&&n.next.index!==r.index&&Zi(n,n.next,l,r))return!0;n=n.next}while(n!==l);return!1}(l,r)&&ae(l,r)&&ae(r,l)&&function Gr(l,r){let n=l,o=!1;const a=(l.x+r.x)/2,h=(l.y+r.y)/2;do{n.y>h!=n.next.y>h&&n.next.y!==n.y&&a<(n.next.x-n.x)*(h-n.y)/(n.next.y-n.y)+n.x&&(o=!o),n=n.next}while(n!==l);return o}(l,r)}function Gi(l,r){const n=jt.create(l.index,l.x,l.y),o=jt.create(r.index,r.x,r.y),a=l.next,h=r.prev;return l.next=r,r.prev=l,n.next=a,a.prev=n,o.next=n,n.prev=o,h.next=o,o.prev=h,o}class jt{constructor(){this.index=0,this.x=0,this.y=0,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}static create(r,n,o){const a=Ne<Ke.length?Ke[Ne++]:new jt;return a.index=r,a.x=n,a.y=o,a.prev=null,a.next=null,a.z=null,a.prevZ=null,a.nextZ=null,a.steiner=!1,a}}const Ke=new Array;let Ne=0;for(let l=0;l<8096;l++)Ke.push(new jt);const Ct=new Le.bN(0,0,0,1,0),Je=new Le.bN(0,0,0,1,0);function Xe(l,r,n){let o=0;for(let a=1;a<n;a++)o+=(l[2*(r+a)]-l[2*(r+a-1)])*(l[2*(r+a)+1]+l[2*(r+a-1)+1]);return o}function Jr(l,r,n,o,a){let h=0;for(let u=n;u<o;u+=3){const d=2*(l[u]-a),f=2*(l[u+1]-a),m=2*(l[u+2]-a);h+=Math.abs((r[d]-r[m])*(r[f+1]-r[d+1])-(r[d]-r[f])*(r[m+1]-r[d+1]))}return h}Ct.setExtent(I.I_),Je.setExtent(I.I_);var $r=w(46519);const Q=16,Ni=l=>class extends l{constructor(...r){super(...r),this.tessellationProperties={},this._tessellationOptions={halfWidth:0,pixelCoordRatio:1,offset:0},this.geometryType=A.LW.LINE}writeGeometry(r,n,o,a){this._writeGeometry(r,n,o,a)}_initializeTessellator(r){const n=O.a.load(this._materialKey),o=O.dk.load(this._materialKey),a=this._tessellationOptions,c=this.tessellationProperties._halfWidth<I.tQ&&!r&&!(n.vvSizeFieldStops||n.vvSizeMinMaxValue||n.vvSizeScaleStops||n.vvSizeUnitValue);this.tessellationProperties.minMaxZoom=this._minMaxZoom,a.wrapDistance=65535,a.textured=this._isDashed||this._hasPattern,a.offset=this.tessellationProperties.offset,a.halfWidth=this.tessellationProperties._halfWidth;const u=c?0:1,d=(0,O.CA)(o)?ts:qr;this._lineTessellator=new $r.z(d(this.tessellationProperties,u,u),es(this.tessellationProperties),c)}_write(r,n,o,a){const h="esriGeometryPoint"===n.geometryType;r.recordStart(n.getDisplayId(),this._materialKey,this.geometryType,h),this._writeGeometry(r,n,a,h),r.recordEnd()}_writeGeometry(r,n,o,a){const h=o??n.readLegacyGeometryForDisplay(),c=this._getLines(h,a);(0,z.Wi)(c)||this._writeVertices(r,n,c)}_getLines(r,n){if((0,z.Wi)(r))return null;const o=r.paths||r.rings;return(0,z.Wi)(o)?null:function Qr(l,r){Je.setPixelMargin(r);const n=Je,o=-r,a=I.I_+r;let h=[],c=!1,u=0;for(;u<l.length;){const d=[],f=l[u];if(!f)return null;n.reset(Le.Vl.LineString);let[m,_]=f[0];if(c)n.moveTo(m,_);else{if(m<o||m>a||_<o||_>a){c=!0;continue}d.push({x:m,y:_})}let p=!1;const y=f.length;for(let g=1;g<y;++g)if(m+=f[g][0],_+=f[g][1],c)n.lineTo(m,_);else{if(m<o||m>a||_<o||_>a){p=!0;break}d.push({x:m,y:_})}if(p)c=!0;else{if(c){const g=n.resultWithStarts();if(g)for(const x of g)h.push(x)}else h.push({line:d,start:0});u++,c=!1}}return h=h.filter(d=>d.line.length>1),0===h.length?null:h}(o,n?256:16)}_writeVertices(r,n,o){const a=n.getDisplayId(),h=r.vertexCount(),c=this.tessellationProperties,u=this._tessellationOptions;c.out=r,c.id=a,c.indexCount=0,c.vertexCount=0,c.offset=h,u.capType=this._capType,u.joinType=this._joinType;const d=O.dk.load(this._materialKey);this.tessellationProperties.key=(0,O.CA)(d)?d:O.a.load(this._materialKey);for(const{line:f,start:m}of o)u.initialDistance=m%65535,this._lineTessellator.tessellate(f,u)}},qr=(l,r,n)=>(o,a,h,c,u,d,f,m,_,p,y)=>{const g=(0,L.UJ)(y,Math.ceil(Q*l._halfWidth)),x=(0,L.Jz)(Math.round(Q*f),Math.round(Q*m),Math.round(Q*_),Math.round(Q*p)),M=(0,L.Jz)(Q*u,Q*d,0,l._bitset),v=l.out;return v.vertexBounds(o,a,r,n),v.vertexWrite((0,L.UJ)(8*o,8*a)),v.vertexWrite(l.id),v.vertexWrite(l._fillColor),v.vertexWrite(x),v.vertexWrite(g),v.vertexWrite(l._tl),v.vertexWrite(l._br),v.vertexWrite(M),v.vertexWrite((0,L.UJ)(Math.ceil(Q*l._halfReferenceWidth),0)),v.vertexWrite(l.minMaxZoom),v.vertexEnd(),l.offset+l.vertexCount++},ts=(l,r,n)=>(o,a,h,c,u,d,f,m,_,p,y)=>{const g=(0,L.UJ)(Q*l._halfWidth,Q*l._halfReferenceWidth),x=(0,L.Jz)(Q*f+128,Q*m+128,Q*_+128,Q*p+128),M=l.out,v=l._bitset<<24|l.id;M.vertexBounds(o,a,r,n),M.vertexWrite((0,L.UJ)(8*o,8*a)),M.vertexWrite(v),M.vertexWrite(l._fillColor);const b=(0,O.Xp)(l.key);return b||(M.vertexWrite(0),M.vertexWrite(0)),M.vertexWrite(0),M.vertexWrite(g),M.vertexWrite(x),b||M.vertexWrite(l.minMaxZoom),M.vertexEnd(),l.offset+l.vertexCount++},es=l=>(r,n,o)=>{const a=l.out;a.indexWrite(r),a.indexWrite(n),a.indexWrite(o),l.indexCount+=3};class yt extends(Ni(re)){constructor(r,n,o,a,h,c,u,d,f,m,_,p,y,g,x,M,v,b,C,P){super();const F=O.a.load(r);n&&(F.sdf=n.sdf,F.pattern=!0,F.textureBinding=n.textureBinding),this._capType=a,this._joinType=h,this._miterLimitCosine=Ae(c),this.tessellationProperties._fillColor=u,this.tessellationProperties._tl=d,this.tessellationProperties._br=f,this._hasPattern=m,this._isDashed=_,this._zOrder=v,this._effects=b,this._minMaxZoom=(0,L.UJ)(Math.round(C*I.MI),Math.round(P*I.MI)),this._materialKey=F.data,this.tessellationProperties._bitset=(y?I.Uh:0)|(g?I.SD:0)|(p?I._6:0)|(x?I.Iv:0),this.tessellationProperties._halfWidth=.5*o,this.tessellationProperties._halfReferenceWidth=.5*M,this.tessellationProperties.offset=0,this._initializeTessellator(!1)}static fromCIMLine(r,n,o){const a=r.color,h=r.scaleFactor||1,c=!!r.dashTemplate;let u=r.cap;c&&u===X.RL.ROUND&&(u=X.RL.SQUARE);const d=r.join,f=(0,W.F2)(r.width)*h,m=(0,W.F2)(r.referenceWidth),_=(0,W.F2)(r.miterLimit),p=a&&(0,U.t2)(a)||0,[y,g]=St(r.scaleInfo,o);if(!n)return new yt(r.materialKey,n,f,u,d,_,p,0,0,!1,c,r.scaleDash??!1,r.colorLocked??!1,!1,r.sampleAlphaOnly,m,r.zOrder,r.effects,y,g);const{rect:M,width:v,height:b}=n,C=M.x+I.fL,P=M.y+I.fL,F=C+v,V=P+b,G=(0,L.UJ)(C,P),K=(0,L.UJ)(F,V);return new yt(r.materialKey,n,f,u,d,_,p,G,K,!0,c,r.scaleDash??!1,r.colorLocked??!1,!1,r.sampleAlphaOnly,m,r.zOrder,r.effects,y,g)}static fromFillOutline(r){const n=O.dk.load(r.materialKey);return(0,O.CA)(n)&&r.outline&&"esriSLSSolid"===r.outline?.style?yt.fromSimpleLine({hash:"",materialKey:r.materialKey,...r.outline},null,!0):null}static fromSimpleLine(r,n,o=!1){const{color:a}=r,h="esriSLSSolid"!==r.style&&"esriSLSNull"!==r.style,c=(0,ee.ws)(r.cap||"round"),u=(0,ee.xV)(r.join||"round");let d=a&&"esriSLSNull"!==r.style&&(0,U.aH)(a)||0;"esriSLSNull"===r.style&&(d=0);const f=(0,W.F2)(r.width),m=r.miterLimit;if(!n)return new yt(r.materialKey,n,f,c,u,m,d,0,0,!1,h,!0,!1,o,!1,f,0,null,lt,ht);const{rect:_,width:p,height:y}=n,g=_.x+I.fL,x=_.y+I.fL,M=g+p,v=x+y,b=(0,L.UJ)(g,x),C=(0,L.UJ)(M,v);return new yt(r.materialKey,n,f,c,u,m,d,b,C,!0,h,!0,!1,o,!1,f,0,null,lt,ht)}static fromPictureLineSymbol(r,n,o,a){return mt.Z.getLogger("esri.views.2d.engine.webgl.WGLLineTemplate").error("PictureLineSymbol support does not exist!"),null}}const Xi=l=>class extends l{constructor(...r){super(...r),this.forceLibtess=!1,this._bitset=0,this._lineTemplate=null,this.geometryType=A.LW.FILL}_maybeAddLineTemplate(r){this._lineTemplate=yt.fromFillOutline(r)}_write(r,n,o,a){const h="esriGeometryPoint"===n.geometryType,c=O.dk.load(this._materialKey);r.recordStart(n.getDisplayId(),this._materialKey,this.geometryType,h),this._writeGeometry(r,n,c,a,h),(0,O.CA)(c)&&(0,z.pC)(this._lineTemplate)&&this._lineTemplate.writeGeometry(r,n,a,h),r.recordEnd()}_writeGeometry(r,n,o,a,h){const c=this._getGeometry(n,a,h);if((0,z.Wi)(c))return;const u=[];if(!(c.maxLength>100)&&!this.forceLibtess&&function Xr(l,r){const{coords:n,lengths:o,hasIndeterminateRingOrder:a}=r,c=l;if(a)return!1;let u=0;for(let d=0;d<o.length;){let f=d,m=o[d],_=Xe(n,u,m);const p=[];for(;++f<o.length;){const M=o[f],v=Xe(n,u+m,M);if(!(v>0))break;_+=v,p.push(u+m),m+=M}const y=c.length;zr(c,n,u,u+m,p,2,0);const g=Jr(c,n,y,c.length,0),x=Math.abs(_);if(Math.abs((g-x)/Math.max(1e-7,x))>1e-5)return c.length=0,!1;d=f,u+=m}return!0}(u,c))return void(u.length&&this._writeVertices(r,n,c.coords,c.lengths,o,u));const d=function Hr(l){const{coords:r,lengths:n}=l,{buffer:o}=(0,Li.b)(r,n);return o}(c);this._writeVertices(r,n,d,[d.length/2],o)}_writeVertex(r,n,o,a,h,c){const u=(0,L.UJ)(1*a,1*h);if(r.vertexBounds(a,h,0,0),r.vertexWrite(u),r.vertexWrite(n),o.symbologyType===A.mD.DOT_DENSITY)r.vertexWriteF32(1/Math.abs(c.readGeometryArea()));else{r.vertexWrite(this.fillColor);const d=(0,O.Xp)(o);d||(r.vertexWrite(this.tl),r.vertexWrite(this.br)),r.vertexWrite(this.aux21),r.vertexWrite(this.aux22),r.vertexWrite(this.aux3),d||r.vertexWrite(this._minMaxZoom)}}_writeVertices(r,n,o,a,h,c){const u=n.getDisplayId(),d=this._bitset<<24|u,f=a.reduce((y,g)=>y+g),m=(0,ee.$_)(h.geometryType,h.symbologyType).geometry/4,_=r.vertexCount();r.vertexEnsureSize(m*f);let p=0;if(c)for(const y of c)this._writeVertex(r,d,h,o[2*y],o[2*y+1],n),p++;else for(let y=0;y<o.length;y+=2){const g=Math.round(o[y]),x=Math.round(o[y+1]);this._writeVertex(r,d,h,g,x,n),p++}r.indexEnsureSize(p);for(let y=0;y<p;y++)r.indexWrite(y+_)}_getGeometry(r,n,o){const a=n?(0,Gt.oB)((0,Gt.GH)(n),2):r.readGeometryForDisplay();return a?function Yr(l,r){if((0,z.Wi)(l))return null;if(!function jr(l,r,n){let o=0;for(let a=0;a<l.lengths.length;a++){const h=l.lengths[a];for(let c=0;c<h;c++){const u=l.coords[2*(c+o)],d=l.coords[2*(c+o)+1];if(u<r||u>n||d<r||d>n)return!0}o+=h}return!1}(l,-128,I.I_+128))return l;Ct.setPixelMargin(r),Ct.reset(Le.Vl.Polygon);let n=0;for(let c=0;c<l.lengths.length;c++){const u=l.lengths[c];let d=l.coords[2*(0+n)],f=l.coords[2*(0+n)+1];Ct.moveTo(d,f);for(let m=1;m<u;m++)d=l.coords[2*(m+n)],f=l.coords[2*(m+n)+1],Ct.lineTo(d,f);Ct.close(),n+=u}const o=Ct.result(!1);if(!o)return null;const a=[],h=[];for(const c of o){let u=0;for(const d of c)h.push(d.x),h.push(d.y),u++;a.push(u)}return new Wr.Z(a,h)}(a,o?256:8):null}};var Hi=w(93678),Ie=w(80991);const ji=mt.Z.getLogger("esri.views.2d.engine.webgl.WGLDynamicMeshTemplate");class we extends re{constructor(r){super(),this._ongoingMaterialRequestMap=new Map,this._materialCache=new Map,this._dynamicPropertyMap=new Map,this._cimLayer=r}analyze(r,n,o,a,h){if(h&&0===h.length)return null;const c=h&&h.length>0,u=n.readLegacyFeature(),d=n.getObjectId(),f=this._materialCache,m=this._cimLayer.materialHash;if(!m)return ji.error("A Dynamic mesh template must have a material hash value or function!"),Promise.reject(null);const _="function"==typeof m?m(u,o,a,d):m,p=f.get(_);if(null!=p)return Promise.resolve(p);const y=this._ongoingMaterialRequestMap.get(_);if(y)return y;const g=this._cimLayer,x=(0,Hi.S)(g.cim,this._cimLayer.materialOverrides);x.mosaicHash=_;const{type:M,url:v}=g,b={cim:x,type:M,mosaicHash:_,url:v,size:null,dashTemplate:null,text:null,fontName:null,objectId:d,animatedSymbolProperties:null};switch(M){case"marker":b.size=(0,Ie.hf)(g.size,u,o,a),b.animatedSymbolProperties=(0,Ie.hf)(g.animatedSymbolProperties,u,o,a);break;case"line":b.dashTemplate=g.dashTemplate;break;case"text":b.text=(0,Ie.hf)(g.text,u,o,a),b.fontName=(0,Ie.hf)(g.fontName,u,o,a)}const C=r.getMosaicItem(b,h).then(P=>(c||(this._ongoingMaterialRequestMap.delete(_),f.set(_,P)),P)).catch(P=>(this._ongoingMaterialRequestMap.delete(_),ji.error(".analyze()",P.message),null));return c||this._ongoingMaterialRequestMap.set(_,C),C}}function tt(l,r){return!l||!("name"in l)||(r&&r.error(new ft.Z(l.name,l.message,l.details)),!1)}class He extends(Xi(we)){constructor(r,n,o){if(super(r),this._minMaxZoom=(0,L.UJ)(Math.round(n*I.MI),Math.round(o*I.MI)),R(r.color))this._dynamicPropertyMap.set("fillColor",(_,p,y)=>{const g=r.color(_,p,y);return g&&(0,U.t2)(g)||0});else{const m=r.color;this.fillColor=m&&(0,U.t2)(m)||0}const a="CIMMarkerPlacementInsidePolygon"===r.cim.placement?.type&&r.cim.placement.shiftOddRows?2:1,h=r.height;R(h)?this._dynamicPropertyMap.set("_height",(_,p,y)=>h(_,p,y)*a):this._height=(h||0)*a;const c=r.offsetX;R(c)?this._dynamicPropertyMap.set("_offsetX",(_,p,y)=>(0,W.F2)(c(_,p,y))):this._offsetX=(0,W.F2)(c||0);const u=r.offsetY;R(u)?this._dynamicPropertyMap.set("_offsetY",(_,p,y)=>(0,W.F2)(-u(_,p,y))):this._offsetY=(0,W.F2)(-u||0);const d=r.scaleX;R(d)?this._dynamicPropertyMap.set("_scaleX",d):this._scaleX=d||1;const f=r.angle;if(R(f)?this._dynamicPropertyMap.set("_angle",(_,p,y)=>(0,Ze.s5)(f(_,p,y))):this._angle=(0,Ze.s5)(f)||0,(0,z.pC)(r.effects)){const m=r.effects;R(m)?this._dynamicPropertyMap.set("_effects",m):this._effects=m}this._cimFillLayer=r,this._bitset=(r.colorLocked?I.Uh:0)|(r.applyRandomOffset?I.jk:0)|(r.sampleAlphaOnly?I.Iv:0)|(r.hasUnresolvedReplacementColor?I.vw:0),this._fillMaterialKey=r.materialKey}static fromCIMFill(r,n){const[o,a]=St(r.scaleInfo,n);return new He(r,o,a)}bindFeature(r,n,o){const a=r.readLegacyFeature();this._dynamicPropertyMap.forEach((m,_)=>{this[_]=m(a,n,o)});const h=O.dk.load(this._fillMaterialKey),c=this._materialCache,u=(0,this._cimFillLayer.materialHash)(a,n,o),d=c.get(u);let f=null;if(d&&tt(d.spriteMosaicItem)&&(f=d.spriteMosaicItem),f){const{rect:m,width:_,height:p}=f,y=m.x+I.fL,g=m.y+I.fL,x=y+_,M=g+p;let v=Math.round((0,W.F2)(this._height));v<=0&&(v=M-g);let b=Math.round((0,W.F2)(this._height/p*_||0));b<=0&&(b=x-y);const C=this._scaleX,P=1;this.tl=(0,L.UJ)(y,g),this.br=(0,L.UJ)(x,M),this.aux21=(0,L.UJ)(b,v),this.aux22=(0,L.UJ)(this._offsetX,this._offsetY),this.aux3=(0,L.Jz)(128*C,128*P,this._angle,0),h.sdf=f.sdf,h.pattern=!0,h.textureBinding=f.textureBinding}else this.tl=0,this.br=0,this.aux21=0,this.aux22=0,this.aux3=0,h.sdf=!1,h.pattern=!1,h.textureBinding=0;this._materialKey=h.data}}class je extends(Ni(we)){constructor(r,n,o){super(r),this._minMaxZoom=(0,L.UJ)(Math.round(n*I.MI),Math.round(o*I.MI)),this._cimLineLayer=r;let a=0;R(r.width)||(a=.5*(0,W.F2)(r.width)),this._dynamicPropertyMap.set("_halfWidth",(_,p,y)=>R(r.width)?.5*(0,W.F2)(r.width(_,p,y)):a),R(r.cap)?this._dynamicPropertyMap.set("_capType",r.cap):this._capType=r.cap,R(r.join)?this._dynamicPropertyMap.set("_joinType",r.join):this._joinType=r.join;const c=r.color;R(c)?this._dynamicPropertyMap.set("_fillColor",(p,y,g)=>(0,U.t2)(c(p,y,g))):this._fillColor=c&&(0,U.t2)(c)||0;const u=r.miterLimit;if(R(u)?this._dynamicPropertyMap.set("_miterLimitCosine",(p,y,g)=>Ae(u(p,y,g))):this._miterLimitCosine=Ae(u),(0,z.pC)(r.effects)){const _=r.effects;R(_)?this._dynamicPropertyMap.set("_effects",_):this._effects=_}this._scaleFactor=r.scaleFactor||1,this._isDashed=null!=r.dashTemplate,this.tessellationProperties._bitset=(r.colorLocked?I.Uh:0)|(r.scaleDash?I._6:0)|(r.sampleAlphaOnly?I.Iv:0),this._materialKey=r.materialKey,this._initializeTessellator(!0)}static fromCIMLine(r,n){const[o,a]=St(r.scaleInfo,n);return new je(r,o,a)}bindFeature(r,n,o){const a=r.readLegacyFeature();this._dynamicPropertyMap.forEach((m,_)=>{this[_]=m(a,n,o)}),this._halfWidth*=this._scaleFactor;const h=this._materialCache,c=(0,this._cimLineLayer.materialHash)(a,n,o),u=h.get(c);let d=null;if(u&&tt(u.spriteMosaicItem)&&(d=u.spriteMosaicItem),d){this._hasPattern=!0;const{rect:m,width:_,height:p}=d,y=m.x+I.fL,g=m.y+I.fL,x=y+_,M=g+p;this.tessellationProperties._tl=(0,L.UJ)(y,g),this.tessellationProperties._br=(0,L.UJ)(x,M)}else this._hasPattern=!1,this.tessellationProperties._tl=0,this.tessellationProperties._br=0;this.tessellationProperties._fillColor=this._fillColor,this.tessellationProperties._halfWidth=this._halfWidth,this.tessellationProperties.offset=0,this.tessellationProperties._halfReferenceWidth=this.tessellationProperties._halfWidth;const f=O.a.load(this._materialKey);d&&(f.sdf=d.sdf,f.pattern=!0,f.textureBinding=d.textureBinding),this._materialKey=f.data}}const rs=(0,be.c)(),ss=(0,ge.c)();class Ye extends(Ai(we)){constructor(r,n,o){super(r),this._cimMarkerLayer=r,this._minMaxZoom=(0,L.UJ)(Math.round(n*I.MI),Math.round(o*I.MI));const a=r.color;R(a)?this._dynamicPropertyMap.set("_fillColor",(y,g,x)=>(0,U.t2)(a(y,g,x))):this._fillColor=(0,U.t2)(a);const h=r.outlineColor;R(h)?this._dynamicPropertyMap.set("_outlineColor",(y,g,x)=>(0,U.t2)(h(y,g,x))):this._outlineColor=(0,U.t2)(h);const c=r.size;R(c)?this._dynamicPropertyMap.set("_size",(y,g,x)=>(0,W.F2)(c(y,g,x))):this._size=(0,W.F2)(c)||0;const u=r.scaleX;R(u)?this._dynamicPropertyMap.set("_scaleX",u):this._scaleX=u;const d=r.offsetX;R(d)?this._dynamicPropertyMap.set("xOffset",(y,g,x)=>(0,W.F2)(d(y,g,x))):this.xOffset=(0,W.F2)(d)||0;const f=r.offsetY;R(f)?this._dynamicPropertyMap.set("yOffset",(y,g,x)=>(0,W.F2)(f(y,g,x))):this.yOffset=(0,W.F2)(f)||0;const m=r.outlineWidth;R(m)?this._dynamicPropertyMap.set("_outlineWidth",(y,g,x)=>(0,W.F2)(m(y,g,x))):this._outlineWidth=(0,W.F2)(m)||0;const _=r.rotation;if(R(_)?this._dynamicPropertyMap.set("_angle",_):this._angle=_||0,(0,z.pC)(r.effects)){const p=r.effects;R(p)?this._dynamicPropertyMap.set("_effects",p):this._effects=p}if((0,z.pC)(r.markerPlacement)){const p=r.markerPlacement;R(p)?this._dynamicPropertyMap.set("_markerPlacement",p):this._markerPlacement=p}this._scaleFactor=(0,z.Pt)(r.scaleFactor,1),this._bitSet=(r.alignment===X.v2.MAP?1:0)|(r.colorLocked?1:0)<<1|(r.scaleSymbolsProportionally?1:0)<<3,this._materialKey=r.materialKey}static fromCIMMarker(r,n){const[o,a]=St(r.scaleInfo,n);return new Ye(r,o,a)}bindFeature(r,n,o){const a=r.readLegacyFeature(),h=r.getObjectId();this._dynamicPropertyMap.forEach((Qt,$t)=>{this[$t]=Qt(a,n,o)});const c=this._cimMarkerLayer.materialHash,u="function"==typeof c?c(a,n,o,h):c,d=this._materialCache.get(u);if(!d||!tt(d.spriteMosaicItem)||!d.spriteMosaicItem)return void mt.Z.getLogger("esri.views.2d.engine.webgl.WGLDynamicMarkerTemplate").error(new ft.Z("mapview-cim","Encountered an error when binding feature"));const f=d.spriteMosaicItem,m=this._cimMarkerLayer.sizeRatio,_=f.width/f.height*this._scaleX,p=this._cimMarkerLayer.rotateClockwise?this._angle:-this._angle;let y=this._size,g=y*_;const x=this.xOffset,M=this.yOffset;this.xOffset*=this._scaleFactor,this.yOffset*=this._scaleFactor;const v=this._cimMarkerLayer.scaleSymbolsProportionally&&this._cimMarkerLayer.frameHeight?this._size/(0,W.F2)(this._cimMarkerLayer.frameHeight):1,b=this._outlineWidth*v,C=(0,W.F2)(this._cimMarkerLayer.referenceSize);let P=0,F=0;const V=this._cimMarkerLayer.anchorPoint;V&&(this._cimMarkerLayer.isAbsoluteAnchorPoint?this._size&&(P=(0,W.F2)(V.x)/(this._size*_),F=(0,W.F2)(V.y)/this._size):(P=V.x,F=V.y)),this._anchorX=P,this._anchorY=F,this._sizeOutlineWidth=(0,L.Jz)(Math.round(Math.min(Math.sqrt(128*g),255)),Math.round(Math.min(Math.sqrt(128*y),255)),Math.round(Math.min(Math.sqrt(128*b),255)),Math.round(Math.min(Math.sqrt(128*C),255))),this.angle=p;const G=Math.round(64*m);this._bitestAndDistRatio=(0,L.UJ)(this._bitSet,G);const K=f.rect.x+I.fL,nt=f.rect.y+I.fL,ot=K+f.width,Tt=nt+f.height;this._texUpperLeft=(0,L.UJ)(K,nt),this._texUpperRight=(0,L.UJ)(ot,nt),this._texBottomLeft=(0,L.UJ)(K,Tt),this._texBottomRight=(0,L.UJ)(ot,Tt);const dt=O.mE.load(this._materialKey);dt.sdf=f.sdf,dt.pattern=!0,dt.textureBinding=f.textureBinding,this._materialKey=dt.data,g*=m,y*=m,g*=this._scaleFactor,y*=this._scaleFactor,g*=f.rect.width/f.width,y*=f.rect.height/f.height,this._computedWidth=g,this._computedHeight=y,this._applyTransformation(ss,rs),this.xOffset=x,this.yOffset=M}}function Qe(l){if(null==l)return[];const r=new Array(l.length);for(let n=0;n<l.length;n++)r[n]=l.charCodeAt(n);return r}class $e extends(Vi(we)){constructor(r,n,o){super(r),this._horizontalAlignment="center",this._verticalAlignment="middle",this._textToGlyphs=new Map,this._minMaxZoom=(0,L.UJ)(Math.round(n*I.MI),Math.round(o*I.MI));const a=r.scaleFactor||1;this._cimTextLayer=r;const h=r.color;R(h)?this._dynamicPropertyMap.set("_color",(M,v,b)=>(0,U.t2)(h(M,v,b))):this._color=(0,U.t2)(h);const c=r.outlineColor;let u,f,_;if(R(c)?this._dynamicPropertyMap.set("_haloColor",(M,v,b)=>(0,U.t2)(c(M,v,b))):this._haloColor=(0,U.t2)(c),R(r.size)||(u=Math.min(Math.round((0,W.F2)(r.size*r.sizeRatio)),127)),this._dynamicPropertyMap.set("_size",(x,M,v)=>R(r.size)?Math.min(Math.round((0,W.F2)(r.size(x,M,v)*r.sizeRatio)),127):u),R(r.outlineSize)?this._dynamicPropertyMap.set("_haloSize",(M,v,b)=>Math.min(Math.floor(5*(0,W.F2)(r.outlineSize(M,v,b)*r.sizeRatio)),127)):this._haloSize=Math.min(Math.floor(5*(0,W.F2)(r.outlineSize*r.sizeRatio)),127),R(r.offsetX)||(f=Math.round((0,W.F2)(r.offsetX*r.sizeRatio))),this._dynamicPropertyMap.set("_xOffset",(x,M,v)=>R(r.offsetX)?Math.round((0,W.F2)(r.offsetX(x,M,v)*r.sizeRatio)):f),R(r.offsetY)||(_=Math.round((0,W.F2)(r.offsetY*r.sizeRatio))),this._dynamicPropertyMap.set("_yOffset",(x,M,v)=>R(r.offsetY)?Math.round((0,W.F2)(r.offsetY(x,M,v)*r.sizeRatio)):_),R(r.angle)?this._dynamicPropertyMap.set("_angle",r.angle):this._angle=r.angle,R(r.horizontalAlignment)?this._dynamicPropertyMap.set("_horizontalAlignment",r.horizontalAlignment):this._horizontalAlignment=r.horizontalAlignment,R(r.verticalAlignment)?this._dynamicPropertyMap.set("_verticalAlignment",r.verticalAlignment):this._verticalAlignment=r.verticalAlignment,(0,z.pC)(r.effects)){const x=r.effects;R(x)?this._dynamicPropertyMap.set("_effects",x):this._effects=x}if((0,z.pC)(r.markerPlacement)){const x=r.markerPlacement;R(x)?this._dynamicPropertyMap.set("_markerPlacement",x):this._textPlacement=x}R(r.text)?this._dynamicPropertyMap.set("_text",r.text):this._text=r.text,this._backgroundColor=r.backgroundColor&&(0,U.t2)(r.backgroundColor),this._borderLineColor=r.borderLineColor&&(0,U.t2)(r.borderLineColor),this._borderLineSize=r.borderLineWidth,this._scaleFactor=a;const y=Math.min(Math.round((0,W.F2)(r.referenceSize*r.sizeRatio)),127);this._referenceSize=Math.round(Math.sqrt(256*y)),this._materialKey=r.materialKey;const g=O.qr.load(this._materialKey);g.sdf=!0,this._bitset=(r.alignment===X.v2.MAP?1:0)|(r.colorLocked?1:0)<<1,this._materialKey=g.data,this._decoration="none",this._lineHeight=1,this._lineWidth=512,this._isCIM=!0}static fromCIMText(r,n){const[o,a]=St(r.scaleInfo,n);return new $e(r,o,a)}analyze(r,n,o,a){var h=()=>super.analyze,c=this;return(0,B.Z)(function*(){const u=n.readLegacyFeature(),d=function ns(l,r,n,o){return"string"==typeof l.text?l.text:"function"==typeof l.text?l.text(r,n,o)??"":""}(c._cimTextLayer,u,o,a),f=yield h().call(c,r,n,o,a,Qe(d));return f&&f.glyphMosaicItems&&c._textToGlyphs.set(d,f.glyphMosaicItems),f})()}bindFeature(r,n,o){const a=r.readLegacyFeature();if(this._dynamicPropertyMap.forEach((c,u)=>{this[u]=c(a,n,o)}),!this._text||0===this._text.length)return void(this._shapingInfo=null);this._size*=this._scaleFactor,this._scale=this._size/I.Ex,this._xOffset*=this._scaleFactor,this._yOffset*=this._scaleFactor,this._xAlignD=(0,pt.kH)((0,z.Pt)(this._horizontalAlignment,"center")),this._yAlignD=(0,pt.b7)((0,z.Pt)(this._verticalAlignment,"baseline"));const h=this._textToGlyphs.get(this._text)??[];this.bindTextInfo(h,!1)}}class gt extends(Xi(re)){constructor(r,n,o,a,h,c,u,d,f,m,_,p,y,g,x,M){super(),this._effects=g;const v=O.dk.load(r);n&&(v.sdf=n.sdf,v.pattern=!0,v.textureBinding=n.textureBinding),this.fillColor=o,this.tl=a,this.br=h,this.aux21=(0,L.UJ)(c,u),this.aux22=(0,L.UJ)(d,f),this.aux3=(0,L.Jz)(m,_,p,0),this._bitset=y,this._minMaxZoom=(0,L.UJ)(Math.round(x*I.MI),Math.round(M*I.MI)),this._materialKey=v.data}static fromCIMFill(r,n,o){const a=r.color,h=a&&(0,U.t2)(a)||0,c=r.materialKey,[u,d]=St(r.scaleInfo,o),f=(r.colorLocked?I.Uh:0)|(r.applyRandomOffset?I.jk:0)|(r.sampleAlphaOnly?I.Iv:0)|(r.hasUnresolvedReplacementColor?I.vw:0);if(!n)return new gt(c,null,h,0,0,0,0,0,0,0,0,0,f,r.effects,u,d);const{rect:m,width:_,height:p}=n,y=r.scaleX||1,g=m.x+I.fL,x=m.y+I.fL,M=g+_,v=x+p,b=(0,W.F2)(r.height);let C=y*b;"CIMHatchFill"===r.cim.type&&(C*=_/p);let P=Math.round(b);P<=0&&(P=v-x);let F=Math.round(C);F<=0&&(F=M-g);const V=(0,W.F2)(r.offsetX||0),G=(0,W.F2)(-r.offsetY||0),K=(0,L.UJ)(g,x),nt=(0,L.UJ)(M,v);return new gt(c,n,h,K,nt,F,P,V,G,128,128,(0,Ze.s5)(r.angle),f,r.effects,u,d)}static fromSimpleFill(r,n,o=!1){const{color:a}=r,h=a&&"esriSFSNull"!==r.style&&(0,U.aH)(a)||0,c=o?I.Uh:0,u=r.materialKey;let d;if(n){const{rect:f,width:m,height:_,pixelRatio:p}=n,y=f.x+I.fL,g=f.y+I.fL,x=y+m,M=g+_,v=(0,L.UJ)(y,g),b=(0,L.UJ)(x,M);d=new gt(u,n,h,v,b,m/p,_/p,0,0,128,128,0,c,null,lt,ht)}else d=new gt(u,null,h,0,0,0,0,0,0,0,0,0,c,null,lt,ht);return d._maybeAddLineTemplate(r),d}static fromPictureFill(r,n,o=!1){const a=I.ru,{rect:h,width:c,height:u}=n,d=h.x+I.fL,f=h.y+I.fL,m=d+c,_=f+u,p=(0,L.UJ)(d,f),y=(0,L.UJ)(m,_),g=Math.round((0,W.F2)(r.width)),x=Math.round((0,W.F2)(r.height)),M=(0,W.F2)(r.xoffset),v=(0,W.F2)(-r.yoffset),P=new gt(r.materialKey,n,a,p,y,g,x,M,v,128*r.xscale,128*r.yscale,0,o?I.Uh:0,null,lt,ht);return P._maybeAddLineTemplate(r),P}}class os{constructor(){this._resolver=null}isHeld(){return!!this._resolver}acquire(){var r=this;return(0,B.Z)(function*(){r._resolver?(yield r._resolver.promise,yield r.acquire()):r._resolver=(0,J.hh)()})()}release(){const r=this._resolver;this._resolver=null,r?.resolve()}}function qe(){return(qe=(0,B.Z)(function*(l,r,n){try{yield l.acquire(),yield r(n),l.release()}catch(o){throw l.release(),o}})).apply(this,arguments)}const ls={marker:A.LW.MARKER,fill:A.LW.FILL,line:A.LW.LINE,text:A.LW.TEXT};class hs{constructor(r,n,o,a){const h={minScale:n?.minScale,maxScale:n?.maxScale},c=function cs(l){return l.minScale||l.maxScale?l.minScale+"-"+l.maxScale:""}(h);this.layers=r,this.data=n,this.hash=this._createHash()+c,this.rendererKey=o;const u={isOutline:!1,placement:null,symbologyType:A.mD.DEFAULT,vvFlags:o};for(const d of r){const f=ls[d.type];u.isOutline="line"===d.type&&d.isOutline,d.materialKey=(0,O.jj)(f,u),d.maxVVSize=a,d.scaleInfo=h,d.templateHash+=c}}get type(){return"expanded-cim"}_createHash(){let r="";for(const n of this.layers)r+=n.templateHash;return r}}var $i=w(83100),us=w(21726),ds=w(84687),fs=w(29840),Pt=w(71937);function ms(l,r,n){return ti.apply(this,arguments)}function ti(){return ti=(0,B.Z)(function*(l,r,n){if(!l.name)throw new ft.Z("style-symbol-reference-name-missing","Missing name in style symbol reference");if(l.styleName&&"Esri2DPointSymbolsStyle"===l.styleName)return function _s(l,r){return ei.apply(this,arguments)}(l,n);try{return function ps(l,r,n,o){return ii.apply(this,arguments)}(yield(0,Pt.n2)(l,r,n),l.name,r,n)}catch(o){return(0,J.k_)(o),null}}),ti.apply(this,arguments)}function ei(){return(ei=(0,B.Z)(function*(l,r){const n=Pt.wm.replace(/\{SymbolName\}/gi,l.name);try{const o=yield(0,Pt.EJ)(n,r);return(0,Pt.KV)(o.data)}catch(o){return(0,J.k_)(o),null}})).apply(this,arguments)}function ii(){return(ii=(0,B.Z)(function*(l,r,n,o){const a=l.data,h={portal:n&&(0,z.pC)(n.portal)?n.portal:ds.Z.getDefault(),url:(0,us.mN)(l.baseUrl),origin:"portal-item"},c=a.items.find(d=>d.name===r);if(!c)throw new ft.Z("symbolstyleutils:symbol-name-not-found",`The symbol name '${r}' could not be found`,{symbolName:r});let u=(0,fs.f)((0,Pt.v9)(c,"cimRef"),h);(0,$i.XO)()&&(u=(0,$i.pJ)(u));try{const d=yield(0,Pt.EJ)(u,o);return(0,Pt.KV)(d.data)}catch(d){return(0,J.k_)(d),null}})).apply(this,arguments)}const qi=function(){var l=(0,B.Z)(function*(r,n,o){return new hs(yield(0,Hi.c)(r.data,n,o),r.data,r.rendererKey,r.maxVVSize)});return function(n,o,a){return l.apply(this,arguments)}}();function ut(l,r,n,o){return ri.apply(this,arguments)}function ri(){return(ri=(0,B.Z)(function*(l,r,n,o){if(!l)return null;if("cim"===l.type)return qi(l,r,n);if("web-style"===l.type){const a={type:"cim",data:(yield ms(l,null,o))??void 0,rendererKey:l.rendererKey,maxVVSize:l.maxVVSize};return qi(a,r,n)}return l})).apply(this,arguments)}function We(l){if(!l)return null;const{avoidSDFRasterization:r,type:n,cim:o,url:a,materialHash:h}=l,c={cim:o,type:n,mosaicHash:h,url:a,size:null,dashTemplate:null,path:null,text:null,fontName:null,animatedSymbolProperties:null,avoidSDFRasterization:r};switch(n){case"marker":c.size=l.size,c.path=l.path,c.animatedSymbolProperties=l.animatedSymbolProperties;break;case"line":c.dashTemplate=l.dashTemplate;break;case"text":c.text=l.text,c.fontName=l.fontName}return c}const $=mt.Z.getLogger("esri.views.2d.engine.webgl.mesh.templates.WGLTemplateStore"),tr={sortKey:null,templates:new Array},si={isOutline:!1,placement:null,symbologyType:A.mD.DEFAULT,vvFlags:0},ys={...Xt.eG,hash:JSON.stringify(Xt.eG),materialKey:(0,O.jj)(A.LW.MARKER,si)},gs={...Xt.wW,hash:JSON.stringify(Xt.wW),materialKey:(0,O.jj)(A.LW.LINE,si)},xs={...Xt.lj,hash:JSON.stringify(Xt.lj),materialKey:(0,O.jj)(A.LW.FILL,si)};function xt(l,r){const n=l.length;return l.push(null),r.then(o=>l[n]=o),l}function le(l){return null!=l&&!!(1&l)}class Ms{constructor(r,n){this._idCounter=1,this._templateIdCounter=1,this._idToTemplateGroup=new Map,this._symbolToTemplate=new Map,this._fetchQueue=[],this._idToResolver=new Map,this._cimTemplateCache=new Map,this._cimAnalyses=[],this._lock=new os,this._fetchResource=r,this._tileInfo=n}get _markerError(){return this._errorTemplates.marker[0]}get _fillError(){return this._errorTemplates.fill[0]}get _lineError(){return this._errorTemplates.line[0]}get _textError(){return this._errorTemplates.line[0]}createTemplateGroup(r,n,o=null){this._initErrorTemplates();const a=r.hash,h=this._symbolToTemplate.get(a);if(null!=h)return h;const c=new Array,u={sortKey:o,templates:c};n&&this._createMeshTemplates(c,n,!0),this._createMeshTemplates(c,r,!1);const d=this._createGroupId("expanded-cim"===r.type&&Ss(r));return this._idToTemplateGroup.set(d,u),this._symbolToTemplate.set(a,d),d}getTemplateGroup(r){return this._idToTemplateGroup.get(r)??tr}getDynamicTemplateGroup(r){return this._idToTemplateGroup.has(r)?(le(r)||$.error("mapview-template-store",`Id ${r} does not refer to a dynamic template`),this._idToTemplateGroup.get(r)):tr}getMosaicItem(r,n){const o=this._createTemplateId(),a=new Promise(h=>this._idToResolver.set(o,h));return this._fetchQueue.push({symbol:r,id:o,glyphIds:n}),a}finalize(r){return this._fetchQueue.length||this._lock.isHeld()?function as(l,r,n){return qe.apply(this,arguments)}(this._lock,this._fetchAllQueuedResources.bind(this),r):Promise.resolve()}_initErrorTemplates(){this._errorTemplates||(this._errorTemplates={fill:this._createMeshTemplates([],xs,!1),marker:this._createMeshTemplates([],ys,!1),line:this._createMeshTemplates([],gs,!1)})}_fetchAllQueuedResources(r){if(!this._fetchQueue.length)return Promise.resolve();const n=this._fetchQueue,o=this._cimAnalyses;return this._fetchQueue=[],this._cimAnalyses=[],Promise.all(o).then(()=>this._fetchResource(n,r).then(a=>{for(const{id:h,mosaicItem:c}of a)this._idToResolver.get(h)(c),this._idToResolver.delete(h)})).catch(a=>{(0,J.D_)(a)?this._fetchQueue=this._fetchQueue.concat(n):function vs(l){return"worker:port-closed"===l.name}(a)||$.error(new ft.Z("mapview-template-store","Unable to fetch requested texture resources",a))})}_createGroupId(r){return this._idCounter++<<1|(r?1:0)}_createTemplateId(){return this._templateIdCounter++}_createSMS(r){var n=this;return(0,B.Z)(function*(){const{spriteMosaicItem:o}=yield n.getMosaicItem(r);return tt(o,$)?ct.fromSimpleMarker(r,o):n._markerError})()}_createPMS(r){var n=this;return(0,B.Z)(function*(){const{spriteMosaicItem:o}=yield n.getMosaicItem(r);return tt(o,$)?ct.fromPictureMarker(r,o):n._markerError})()}_createSFS(r,n){var o=this;return(0,B.Z)(function*(){const{spriteMosaicItem:a}=yield o.getMosaicItem(r);return tt(a,$)?gt.fromSimpleFill(r,a,n):o._fillError})()}_createPFS(r,n){var o=this;return(0,B.Z)(function*(){const{spriteMosaicItem:a}=yield o.getMosaicItem(r);return tt(a,$)?gt.fromPictureFill(r,a,n):o._fillError})()}_createSLS(r,n){var o=this;return(0,B.Z)(function*(){const{spriteMosaicItem:a}=yield o.getMosaicItem(r);return tt(a,$)?yt.fromSimpleLine(r,a):o._lineError})()}_createLMS(r){var n=this;return(0,B.Z)(function*(){const{spriteMosaicItem:o}=yield n.getMosaicItem(r);return tt(o,$)?ct.fromLineSymbolMarker(r,o):n._markerError})()}_createTS(r){var n=this;return(0,B.Z)(function*(){const{glyphMosaicItems:o}=yield n.getMosaicItem(r);return Nt.fromText(r,o??[])})()}_createCIMText(r){var n=this;return(0,B.Z)(function*(){const{glyphMosaicItems:o}=yield n.getMosaicItem(We(r),Qe(r.text));return tt(o,$)?Nt.fromCIMText(r,o,n._tileInfo):n._textError})()}_createCIMFill(r){var n=this;return(0,B.Z)(function*(){const{spriteMosaicItem:o}=yield n.getMosaicItem(We(r));return tt(o,$)?gt.fromCIMFill(r,o,n._tileInfo):n._fillError})()}_createCIMLine(r){var n=this;return(0,B.Z)(function*(){const{spriteMosaicItem:o}=yield n.getMosaicItem(We(r));return tt(o,$)?yt.fromCIMLine(r,o,n._tileInfo):n._lineError})()}_createCIMMarker(r){var n=this;return(0,B.Z)(function*(){const{spriteMosaicItem:o}=yield n.getMosaicItem(We(r));return tt(o,$)?ct.fromCIMMarker(r,o,n._tileInfo):n._markerError})()}_createCIM(r){var n=this;return(0,B.Z)(function*(){const o=r.templateHash;let a=n._cimTemplateCache.get(o);if(null!=a)return a;switch(r.type){case"marker":a=yield n._createCIMMarker(r);break;case"line":a=yield n._createCIMLine(r);break;case"fill":a=yield n._createCIMFill(r);break;case"text":a=yield n._createCIMText(r)}return n._cimTemplateCache.set(o,a),a})()}_createDynamicCIM(r){var n=this;return(0,B.Z)(function*(){const o=r.templateHash;let a=n._cimTemplateCache.get(o);if(null!=a)return a;switch(r.type){case"marker":a=Ye.fromCIMMarker(r,n._tileInfo);break;case"line":a=je.fromCIMLine(r,n._tileInfo);break;case"fill":a=He.fromCIMFill(r,n._tileInfo);break;case"text":a=$e.fromCIMText(r,n._tileInfo)}return n._cimTemplateCache.set(o,a),a})()}_createPrimitiveMeshTemplates(r,n,o){switch(n.type){case"esriSMS":return xt(r,this._createSMS(n));case"esriPMS":return xt(r,this._createPMS(n));case"esriSFS":return xt(r,this._createSFS(n,o));case"line-marker":return xt(r,this._createLMS(n));case"esriPFS":return xt(r,this._createPFS(n,o));case"esriSLS":return xt(r,this._createSLS(n,!1));case"esriTS":return xt(r,this._createTS(n));default:return $.error("Unable to create mesh template for unknown symbol type {: $ }{symbol.type}"),r}}_createMeshTemplates(r,n,o){if(n.type.includes("3d"))return $.error("3D symbols are not supported with MapView"),r;if("expanded-cim"===n.type){for(const a of n.layers)xt(r,"function"==typeof a.materialHash?this._createDynamicCIM(a):this._createCIM(a));return r}if("composite-symbol"===n.type){for(const a of n.layers)this._createPrimitiveMeshTemplates(r,a,o);return r}return"cim"===n.type||"label"===n.type||"web-style"===n.type?r:this._createPrimitiveMeshTemplates(r,n,o)}}const Ss=l=>{if(!l.layers)return!1;for(const r of l.layers)if("function"==typeof r.materialHash)return!0;return!1};class bs{constructor(r,n,o){this._loadPromise=(0,Li.j)(),this._geometryType=r,this._idField=n,this._templateStore=o}update(r,n){(0,z.pC)(r.mesh.labels)&&(this._labelTemplates=this._createLabelTemplates(r.mesh.labels,n)),this._schema=r}_createLabelTemplates(r,n){const o=new Map;if("simple"===r.type){for(const a of r.classes){const h=Se.fromLabelClass(a,n);o.set(a.index,h)}return o}for(const a in r.classes){const h=r.classes[a];for(const c of h){const u=Se.fromLabelClass(c,n);o.set(c.index,u)}}return o}get templates(){return this._templateStore}analyze(r,n,o,a,h,c,u){var d=this;return(0,B.Z)(function*(){if((0,J.Hc)(u))return;let f;"dictionary"===o?.type&&(f=yield o.analyze(d._idField,r.copy(),n,h,c,u));let m=0;for(;r.next();){let _=null;if(_=f?f[m++]:(0,z.pC)(a)&&(0,Vt.nE)(r.getDisplayId())&&1!==r.readAttribute("cluster_count")?a.match(d._idField,r,d._geometryType,h,c):o.match(d._idField,r,d._geometryType,h,c),r.setGroupId(_),le(_)){const p=d._templateStore.getDynamicTemplateGroup(_).templates;for(const y of p)y&&y.analyze&&y.analyze(d._templateStore,r,h,c)}}return yield d._loadPromise,d._templateStore.finalize(u)})()}analyzeGraphics(r,n,o,a,h,c){var u=this;return(0,B.Z)(function*(){if((0,J.Hc)(c))return;const d=r.getCursor();for(o&&(yield o.analyze(u._idField,d.copy(),n,a,h,c));d.next();){let f=d.getGroupId();if(null!=f&&-1!==f||(f=o?.match(u._idField,d,d.geometryType,a,h),d.setGroupId(f)),le(f)){const m=u._templateStore.getDynamicTemplateGroup(f).templates;for(const _ of m)_&&_.analyze&&_.analyze(u._templateStore,d,a,h)}d.setGroupId(f)}return yield u._loadPromise,u._templateStore.finalize(c)})()}writeGraphic(r,n,o,a){const h=n.getGroupId(),c=n.getDisplayId(),u=this._templateStore.getTemplateGroup(h);if(r.featureStart(n.insertAfter,0),null!=c){if(le(h))for(const d of u.templates)d&&d.bindFeature(n,null,null);if(u){for(const d of u.templates)d&&d.write(r,n,o,a);r.featureEnd()}}}writeCursor(r,n,o,a,h,c,u){const d=n.getGroupId(),f=n.getDisplayId(),m=this._templateStore.getTemplateGroup(d),_=m.templates,p=this._getSortKeyValue(n,m);if(r.featureStart(0,p),null!=f&&_){if(le(d))for(const y of _)y.bindFeature(n,o,a);for(const y of _)y.write(r,n,h,u);if((0,z.pC)(c)&&r.hasRecords){const y=c&&this._findLabelRef(_);this._writeLabels(r,n,c,y,h,u)}r.featureEnd()}}_getSortKeyValue(r,n){const o=this._schema.mesh.sortKey;if((0,z.Wi)(o))return 0;let a=0;return a=!0===o.byRenderer&&null!=n.sortKey?n.sortKey:null!=o.fieldIndex?r.getComputedNumericAtIndex(o.fieldIndex):r.readAttribute(null!=o.field?o.field:this._idField),a*="asc"===o.order?1:-1,null==a||isNaN(a)?0:a}_findLabelRef(r){for(const n of r)if(n instanceof ct)return n;return null}_writeLabels(r,n,o,a,h,c){for(const u of o)if((0,z.pC)(u)&&u){const{glyphs:d,rtl:f,index:m}=u,_=this._labelTemplates.get(m);if(!_)continue;_.setZoomLevel(h),_.bindReferenceTemplate(a),_.bindTextInfo(d,f),_.write(r,n,null,c)}}}var Ls=w(93961),Ts=w(46679),Is=w(39236);const ni=mt.Z.getLogger("esri/views/2d/engine/webgl/util/Matcher");function oi(l,r,n,o){return ai.apply(this,arguments)}function ai(){return(ai=(0,B.Z)(function*(l,r,n,o){switch(l.type){case"simple":case"heatmap":return Lt.fromBasicRenderer(l,r,n,o);case"map":return hi.fromUVRenderer(l,r,n,o);case"interval":return li.fromCBRenderer(l,r,n,o);case"dictionary":return fi.fromDictionaryRenderer(l,r,n,o);case"pie-chart":return ze.fromPieChartRenderer(l,r,n,o);case"subtype":return ze.fromSubtypes(l,r,n,o)}})).apply(this,arguments)}class Lt{constructor(){this.type="feature",this._defaultResult=null}static fromBasicRenderer(r,n,o,a){return(0,B.Z)(function*(){const h=new Lt;if(r.symbol){const c=yield ut(r.symbol,o,a),u=n.createTemplateGroup(c,null);h.setDefault(u)}return h})()}static fromPieChartRenderer(r,n,o,a){return(0,B.Z)(function*(){const h=new Lt;if(r.markerSymbol){const c=yield ut(r.markerSymbol,o,a);let u;r.fillSymbol&&(u=yield ut(r.fillSymbol,o,a));const d=n.createTemplateGroup(c,u);h.setDefault(d)}return h})()}size(){return 1}getDefault(){return this._defaultResult}setDefault(r){this._defaultResult=r}match(r,n,o,a,h){return this.getDefault()}analyze(r,n,o,a,h,c){return(0,B.Z)(function*(){return null})()}}class ze extends Lt{constructor(r,n){super(),this._subMatchers=r,this._subtypeField=n}static fromSubtypes(r,n,o,a){return(0,B.Z)(function*(){const h=new Map,c=[];for(const u in r.renderers){const d=parseInt(u,10),f=oi(r.renderers[u],n,o,a).then(m=>h.set(d,m));c.push(f)}return yield Promise.all(c),new ze(h,r.subtypeField)})()}match(r,n,o,a,h){const c=n.readAttribute(this._subtypeField),u=this._subMatchers.get(c);return u?u.match(r,n,o,a,h):null}}class li extends Lt{constructor(r,n,o,a){super(),this.type="interval",this._intervals=[],this._isMaxInclusive=n,this._fieldIndex=a,this._field=r,this._normalizationInfo=o}static fromCBRenderer(r,n,o,a){return(0,B.Z)(function*(){const{isMaxInclusive:h,normalizationField:c,normalizationTotal:u,normalizationType:d}=r,m=new li(r.field,h,{normalizationField:c,normalizationTotal:u,normalizationType:d},r.fieldIndex),_=yield ut(r.backgroundFillSymbol,o,a);yield Promise.all(r.intervals.map(function(){var y=(0,B.Z)(function*(g){const x=yield ut(g.symbol,o,a),M=yield n.createTemplateGroup(x,_);m.add({min:g.min,max:g.max},M)});return function(g){return y.apply(this,arguments)}}()));const p=yield ut(r.defaultSymbol,o,a);if(p){const y=yield n.createTemplateGroup(p,_);m.setDefault(y)}return m})()}add(r,n){this._intervals.push({interval:r,result:n}),this._intervals.sort((o,a)=>o.interval.min-a.interval.min)}size(){return super.size()+this._intervals.length}match(r,n,o,a,h){if(null==this._fieldIndex&&!this._field)return this.getDefault();const c=null!=this._fieldIndex?n.getComputedNumericAtIndex(this._fieldIndex):this._getValueFromField(n);if(null==c||isNaN(c)||c===1/0||c===-1/0)return this.getDefault();for(let u=0;u<this._intervals.length;u++){const{interval:d,result:f}=this._intervals[u];if(c>=d.min&&(this._isMaxInclusive?c<=d.max:c<d.max))return f}return this.getDefault()}_needsNormalization(){const r=this._normalizationInfo;return r&&(r.normalizationField||r.normalizationTotal||r.normalizationType)}_getValueFromField(r){const n=r.readAttribute(this._field);if(!this._needsNormalization()||null==n)return n;const{normalizationField:o,normalizationTotal:a,normalizationType:h}=this._normalizationInfo,c=r.readAttribute(o)??1;if(h)switch(h){case"esriNormalizeByField":return c?n/c:void 0;case"esriNormalizeByLog":return Math.log(n)*Math.LOG10E;case"esriNormalizeByPercentOfTotal":return n/a*100;default:return void ni.error(`Found unknown normalization type: ${h}`)}else ni.error("Normalization is required, but no type was set!")}}class hi extends Lt{constructor(r,n,o){super(),this.type="map",this._nullResult=null,this._resultsMap=new Map,this._fields=[],this._fieldsIndex=o,this._fields=r,this._seperator=n||""}static fromUVRenderer(r,n,o,a){return(0,B.Z)(function*(){const h=r.fieldDelimiter,c=[r.field];r.field2&&c.push(r.field2),r.field3&&c.push(r.field3);const u=yield ut(r.backgroundFillSymbol,o,a),d=new hi(c,h,r.fieldIndex);yield Promise.all(r.map.map(function(){var m=(0,B.Z)(function*(_,p){const y=yield ut(_.symbol,o,a),g=p+1,x=yield n.createTemplateGroup(y,u,g);"<Null>"===_.value?d.setNullResult(x):d.add(_.value,x)});return function(_,p){return m.apply(this,arguments)}}()));const f=yield ut(r.defaultSymbol,o,a);if(f){const m=Number.MAX_SAFE_INTEGER,_=yield n.createTemplateGroup(f,u,m);d.setDefault(_)}return d})()}setNullResult(r){this._nullResult=r}add(r,n){this._resultsMap.set(r.toString(),n)}size(){return super.size()+this._resultsMap.size}match(r,n,o,a,h){if(null==this._fieldsIndex&&!this._fields)return this.getDefault();const c=null!=this._fieldsIndex?n.getComputedStringAtIndex(this._fieldsIndex):this._getValueFromFields(n);if(null!==this._nullResult&&(null==c||""===c||"<Null>"===c))return this._nullResult;if(null==c)return this.getDefault();const u=c.toString();return this._resultsMap.has(u)?this._resultsMap.get(u):this.getDefault()}_getValueFromFields(r){const n=[];for(const o of this._fields){const a=r.readAttribute(o);n.push(null==a||""===a?"<Null>":a)}return n.join(this._seperator)}}function ci(){return(ci=(0,B.Z)(function*(l,r){const n=l||1;if("number"==typeof n)return(a,h,c)=>n;const o=yield(0,Ts.Yi)(n,r.spatialReference,r.fields);return(a,h,c)=>(0,Is.Z)(o,a,{$view:c},r.geometryType,h)||1})).apply(this,arguments)}let ui;function Ws(){return di.apply(this,arguments)}function di(){return(di=(0,B.Z)(function*(){return ui||(ui=w.e(3250).then(w.bind(w,3250))),ui})).apply(this,arguments)}class fi extends Lt{constructor(r,n,o,a,h,c){super(),this.type="dictionary",this._groupIdCache=new Ls.Z(100),this._loader=r,this._fieldMap=r.fieldMap,this._symbolFields=r.getSymbolFields(),this._templates=n,this._info=o,this._scaleFn=a,this._schemaUtilsModule=h,this._symbolOptions=c}static fromDictionaryRenderer(r,n,o,a){return(0,B.Z)(function*(){const[{DictionaryLoader:h},c]=yield Promise.all([Promise.resolve().then(w.bind(w,29996)),Ws()]),u=new h(r.url,r.config,r.fieldMap);yield u.fetchResources({spatialReference:o.spatialReference,fields:o.fields});const d=yield function ws(l,r){return ci.apply(this,arguments)}(r.scaleExpression,o);return new fi(u,n,o,d,c,r.symbolOptions)})()}_analyzeFeature(r,n,o,a,h){var c=this;return(0,B.Z)(function*(){const u=r.readLegacyFeature(),d=c._scaleFn(u,o,a),f=c._attributeHash(u)+"-"+d,m=c._groupIdCache.get(f);if(m)return m;const _={...a,spatialReference:c._info.spatialReference,abortOptions:h,fields:c._info.fields},p=yield c._loader.getSymbolAsync(u,_),g=ut(c._schemaUtilsModule.createSymbolSchema(p,c._symbolOptions),c._info,n,h).then(x=>{if("expanded-cim"!==x?.type)return ni.error(new ft.Z("mapview-bad-type",`Found unexpected type ${x?.type} in dictionary response`)),null;x.hash+="-"+d;for(const M of x.layers)M.scaleFactor=d,M.templateHash+="-"+d;return c._templates.createTemplateGroup(x,null)});return c._groupIdCache.put(f,g,1),g})()}analyze(r,n,o,a,h,c){var u=this;return(0,B.Z)(function*(){const d=n.getCursor(),f=[];for(;d.next();)f.push(u._analyzeFeature(d,o,a,h,c));return Promise.all(f).then(m=>m.filter(z.pC))})()}match(r,n,o,a,h){return null}_attributeHash(r){let n="";for(const o of this._symbolFields){const a=this._fieldMap?.[o];a&&(n+=r.attributes[a]+"-")}return n}}var zs=w(13112);class Cs{constructor(r){this._remoteClient=r,this._resourceMap=new Map,this._inFlightResourceMap=new Map,this.geometryEngine=null,this.geometryEnginePromise=null}destroy(){}fetchResource(r,n){var o=this;return(0,B.Z)(function*(){const a=o._resourceMap,h=a.get(r);if(h)return h;let c=o._inFlightResourceMap.get(r);if(c)return c;try{c=o._remoteClient.invoke("tileRenderer.fetchResource",{url:r},{...n}),o._inFlightResourceMap.set(r,c),c.then(u=>(o._inFlightResourceMap.delete(r),a.set(r,u),u))}catch(u){return(0,J.D_)(u)?null:{width:0,height:0}}return c})()}getResource(r){return this._resourceMap.get(r)??null}}function er(l,r){return(!l.minScale||l.minScale>=r)&&(!l.maxScale||l.maxScale<=r)}function ir(l){const r=l.message,n={message:{data:{},tileKey:r.tileKey,tileKeyOrigin:r.tileKeyOrigin,version:r.version},transferList:new Array};for(const o in r.data){const a=r.data[o];if(n.message.data[o]=null,(0,z.pC)(a)){const h=a.stride,c=a.indices.slice(0),u=a.vertices.slice(0),d=a.records.slice(0),f={stride:h,indices:c,vertices:u,records:d,metrics:(0,z.yw)(a.metrics,m=>m.slice(0))};n.transferList.push(c,u,d),n.message.data[o]=f}}return n}let mi=class extends zs.Z{constructor(){super(...arguments),this.type="symbol",this._matchers={feature:null,aggregate:null},this._bufferData=new Map,this._bufferIds=new Map}initialize(){this.handles.add([this.tileStore.on("update",this.onTileUpdate.bind(this))]),this._resourceManagerProxy=new Cs(this.remoteClient)}destroy(){this._resourceManagerProxy.destroy()}get supportsTileUpdates(){return!0}forEachBufferId(l){this._bufferIds.forEach(r=>{r.forEach(l)})}update(l,r){var n=this;return(0,B.Z)(function*(){const o=r.schema.processors[0];if("symbol"!==o.type)return;const a=(0,Ft.Hg)(n._schema,o);((0,Ft.uD)(a,"mesh")||(0,Ft.uD)(a,"target"))&&(l.mesh=!0,l.why?.mesh.push("Symbology changed"),n._schema=o,n._factory=n._createFactory(o),n._factory.update(o,n.tileStore.tileScheme.tileInfo))})()}onTileMessage(l,r,n,o){return(0,J.k_)(o),this._onTileData(l,r,n,o)}onTileClear(l){return this._bufferData.delete(l.key.id),this._bufferIds.delete(l.key.id),this.remoteClient.invoke("tileRenderer.onTileData",{tileKey:l.id,data:{clear:!0}})}onTileError(l,r,n){return this.remoteClient.invoke("tileRenderer.onTileError",{tileKey:l.id,error:r},{signal:n.signal})}onTileUpdate(l){for(const r of l.removed)this._bufferData.has(r.key.id)&&this._bufferData.delete(r.key.id),this._bufferIds.has(r.key.id)&&this._bufferIds.delete(r.key.id);for(const r of l.added)this._bufferData.forEach(n=>{for(const o of n)o.message.tileKey===r.id&&this._updateTileMesh("append",r,ir(o),[],!1,!1,null)})}_addBufferData(l,r){this._bufferData.has(l)||this._bufferData.set(l,[]),this._bufferData.get(l)?.push(ir(r))}_createFactory(l){const{geometryType:r,objectIdField:n,fields:o}=this.service,h={geometryType:r,fields:o,spatialReference:ce.Z.fromJSON(this.spatialReference)},c=new Ms((f,m)=>this.remoteClient.invoke("tileRenderer.getMaterialItems",f,m),this.tileStore.tileScheme.tileInfo),{matcher:u,aggregateMatcher:d}=l.mesh;return this._store=c,this._matchers.feature=oi(u,c,h,this._resourceManagerProxy),this._matchers.aggregate=(0,z.yw)(d,f=>oi(f,c,h,this._resourceManagerProxy)),new bs(r,n,c)}_onTileData(l,r,n,o){var a=this;return(0,B.Z)(function*(){(0,J.k_)(o);const{type:h,addOrUpdate:c,remove:u,clear:d,end:f}=r,m=!!a._schema.mesh.sortKey;if(!c)return a.remoteClient.invoke("tileRenderer.onTileData",{tileKey:l.id,data:{type:h,addOrUpdate:null,remove:u,clear:d,end:f,sort:m}},o);const _=a._processFeatures(l,c,n,o,r.status?.version);try{const p=yield _;if((0,z.Wi)(p))return a.remoteClient.invoke("tileRenderer.onTileData",{tileKey:l.id,data:{type:h,addOrUpdate:null,remove:u,clear:d,end:f,sort:m}},o);const y=[];for(const g of p){let x=!1;const M=g.message.bufferIds,v=l.key.id,b=g.message.tileKey;if(v!==b&&(0,z.pC)(M)){if(!a.tileStore.get(b)){a._addBufferData(v,g),y.push(g);continue}let C=a._bufferIds.get(b);C||(C=new Set,a._bufferIds.set(b,C));const P=Array.from(M);for(const F of P){if(C.has(F)){x=!0;break}C.add(F)}}x||(a._addBufferData(v,g),y.push(g))}yield Promise.all(y.map(g=>{const x=l.key.id===g.message.tileKey;return a._updateTileMesh(h,l,g,x?r.remove:[],x&&r.end,!!r.clear,o.signal)}))}catch(p){a._handleError(l,p,o)}})()}_updateTileMesh(l,r,n,o,a,h,c){var u=this;return(0,B.Z)(function*(){const d=l,f=n.message.tileKey,m=!!u._schema.mesh.sortKey;f!==r.key.id&&(a=!1);const _=(0,z.yw)(n,x=>x.message),p=(0,z.yw)(n,x=>x.transferList)||[],y={type:d,addOrUpdate:_,remove:o,clear:h,end:a,sort:m},g={transferList:(0,z.Wg)(p)||[],signal:c};return(0,J.k_)(g),u.remoteClient.invoke("tileRenderer.onTileData",{tileKey:f,data:y},g)})()}_processFeatures(l,r,n,o,a){var h=this;return(0,B.Z)(function*(){if((0,z.Wi)(r)||!r.hasFeatures)return null;const c={transform:l.transform,hasZ:!1,hasM:!1},u=h._factory,d={viewingMode:"",scale:l.scale},f=yield h._matchers.feature,m=yield h._matchers.aggregate;(0,J.k_)(o);const _=h._getLabelInfos(l,r);return yield u.analyze(r.getCursor(),h._resourceManagerProxy,f,m,c,d),(0,J.k_)(o),h._writeFeatureSet(l,r,c,_,u,n,a)})()}_writeFeatureSet(l,r,n,o,a,h,c){const u=r.getSize(),d=this._schema.mesh.matcher.symbologyType,f=new ar(l.key.id,{features:u,records:u,metrics:0},d,h,d!==A.mD.HEATMAP,c),m={viewingMode:"",scale:l.scale},_=r.getCursor();for(;_.next();)try{const y=_.getDisplayId(),g=(0,z.pC)(o)?o.get(y):null;a.writeCursor(f,_,n,m,l.level,g,this._resourceManagerProxy)}catch{}return f.serialize(l.tileInfoView.tileInfo.isWrappable)}_handleError(l,r,n){return(0,J.D_)(r)?Promise.resolve():this.remoteClient.invoke("tileRenderer.onTileError",{tileKey:l.id,error:r.message},{signal:n.signal})}_getLabelingSchemaForScale(l){const r=this._schema.mesh.labels;if((0,z.Wi)(r))return null;if("subtype"===r.type){const o={type:"subtype",classes:{}};let a=!1;for(const h in r.classes){const c=r.classes[h].filter(u=>er(u,l.scale));a=a||!!c.length,o.classes[h]=c}return a?o:null}const n=r.classes.filter(o=>er(o,l.scale));return n.length?{type:"simple",classes:n}:null}_getLabels(l,r){if("subtype"===r.type){const o=(0,z.s3)(this.service.subtypeField,"Expected to find subtype Field"),a=l.readAttribute(o);return null==a?[]:r.classes[a]??[]}return r.classes}_getLabelInfos(l,r){const n=this._getLabelingSchemaForScale(l);if((0,z.Wi)(n))return null;const o=new Map,a=r.getCursor();for(;a.next();){const h=a.getDisplayId(),c=[],u=(0,Vt.nE)(h),d=u&&1!==a.readAttribute("cluster_count")?"aggregate":"feature",f=this._getLabels(a,n);for(const m of f){if(m.target!==d)continue;const p=a.getStorage().getComputedStringAtIndex(u&&"feature"===d?a.readAttribute("referenceId"):h,m.fieldIndex);if(!p)continue;const y=(0,E.E)(p.toString()),x=y[1];this._store.getMosaicItem(m.symbol,Qe(y[0])).then(M=>{c[m.index]={glyphs:M.glyphMosaicItems??[],rtl:x,index:m.index}})}o.set(h,c)}return o}};mi=(0,N._)([(0,Et.j)("esri.views.2d.layers.features.processors.SymbolProcessor")],mi);const Ps=mi}}]);