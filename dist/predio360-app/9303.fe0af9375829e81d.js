"use strict";(self.webpackChunkpredio360_app=self.webpackChunkpredio360_app||[]).push([[9303],{30750:(_t,$,n)=>{n.d($,{S:()=>R,b:()=>b});var p=n(2166),A=n(69960),l=n(65787),g=n(17625),H=n(22355),J=n(16396);function b(w){const F=new H.kG;F.extensions.add("GL_OES_standard_derivatives");const{vertex:N,fragment:et,attributes:j,varyings:K}=F;return(0,p.Sv)(N,w),j.add(J.T.POSITION,"vec3"),j.add(J.T.UV0,"vec2"),K.add("vUV","vec2"),N.code.add(g.H`void main(void) {
vUV = uv0;
gl_Position = proj * view * vec4(position, 1.0);
}`),et.uniforms.add([new A.N("backgroundColor",k=>k.backgroundColor),new A.N("gridColor",k=>k.gridColor),new l.p("gridWidth",k=>k.gridWidth)]),et.code.add(g.H`void main() {
const float LINE_WIDTH = 1.0;
vec2 uvScaled = vUV * gridWidth;
vec2 gridUV = (fract(uvScaled + 0.5) - 0.5) / (LINE_WIDTH * fwidth(uvScaled));
vec2 grid = (1.0 - step(0.5, gridUV)) * step(-0.5, gridUV);
grid.x *= step(0.5, uvScaled.x) * step(uvScaled.x, gridWidth - 0.5);
grid.y *= step(0.5, uvScaled.y) * step(uvScaled.y, gridWidth - 0.5);
float gridFade = max(grid.x, grid.y);
float gridAlpha = gridColor.a * gridFade;
gl_FragColor =
vec4(backgroundColor.rgb * backgroundColor.a, backgroundColor.a) * (1.0 - gridAlpha) +
vec4(gridColor.rgb, 1.0) * gridAlpha;
}`),F}const R=Object.freeze(Object.defineProperty({__proto__:null,build:b},Symbol.toStringTag,{value:"Module"}))},128:(_t,$,n)=>{n.d($,{B:()=>F});var p=n(15861),A=n(22558),l=n(21726),g=n(35948),H=n(34117),J=n(31283),b=n(77712),R=n(61556),w=n(29840);function F(y){const T=y?.origins??[void 0];return(W,x)=>{const C=function N(y,T,W){if("resource"===y?.type)return function et(y,T,W){const x=(0,H.Oe)(T,W);return{type:String,read:(C,f,B)=>{const V=(0,w.r)(C,f,B);return x.type===String?V:"function"==typeof x.type?new x.type({url:V}):void 0},write:{writer(C,f,B,V){if(!V||!V.resources)return"string"==typeof C?void(f[B]=(0,w.t)(C,V)):void(f[B]=C.write({},V));const r=function z(y){return null==y?null:"string"==typeof y?y:y.url}(C),D=(0,w.t)(r,{...V,verifyItemRelativeUrls:V&&V.verifyItemRelativeUrls?{writtenUrls:V.verifyItemRelativeUrls.writtenUrls,rootPath:void 0}:void 0},w.M.NO),ct=x.type!==String&&(!(0,A.l)(this)||V&&V.origin&&this.originIdOf(W)>(0,J.M9)(V.origin)),lt={object:this,propertyName:W,value:C,targetUrl:D,dest:f,targetPropertyName:B,context:V,params:y};V&&V.portalItem&&D&&!(0,l.YP)(D)?ct?function K(y){const{context:T,targetUrl:W,params:x,value:C,dest:f,targetPropertyName:B}=y;if(!T.portalItem)return;const V=T.portalItem.resourceFromPath(W),r=rt(C,W,T),D=(0,R.B)(r),ct=(0,l.Ml)(V.path),lt=x?.compress??!1;D===ct?(T.resources&&O({...y,resource:V,content:r,compress:lt,updates:T.resources.toUpdate}),f[B]=W):j(y)}(lt):function k({context:y,targetUrl:T,dest:W,targetPropertyName:x}){y.portalItem&&y.resources&&(y.resources.toKeep.push({resource:y.portalItem.resourceFromPath(T),compress:!1}),W[x]=T)}(lt):V&&V.portalItem&&(null==D||null!=(0,w.i)(D)||(0,l.jc)(D)||ct)?j(lt):f[B]=D}}}}(y,T,W);switch(y?.type??"other"){case"other":return{read:!0,write:!0};case"url":{const{read:x,write:C}=w.a;return{read:x,write:C}}}}(y,W,x);for(const f of T){const B=(0,b.CJ)(W,f,x);for(const V in C)B[V]=C[V]}}}function j(y){const{targetUrl:T,params:W,value:x,context:C,dest:f,targetPropertyName:B}=y;if(!C.portalItem)return;const V=(0,w.p)(T),r=V?.filename??(0,g.D)(),D=W?.prefix??V?.prefix,ct=rt(x,T,C),lt=(0,l.v_)(D,r),G=`${lt}.${(0,R.B)(ct)}`,vt=C.portalItem.resourceFromPath(G);(0,l.jc)(T)&&C.resources&&C.resources.pendingOperations.push(function q(y){return wt.apply(this,arguments)}(T).then(h=>{vt.path=`${lt}.${(0,R.B)(h)}`,f[B]=vt.itemRelativeUrl}).catch(()=>{}));const Kt=W?.compress??!1;C.resources&&O({...y,resource:vt,content:ct,compress:Kt,updates:C.resources.toAdd}),f[B]=vt.itemRelativeUrl}function O({object:y,propertyName:T,updates:W,resource:x,content:C,compress:f}){W.push({resource:x,content:C,compress:f,finish:B=>{!function v(y,T,W){"string"==typeof y[T]?y[T]=W.url:y[T].url=W.url}(y,T,B)}})}function rt(y,T,W){return"string"==typeof y?{url:T}:new Blob([JSON.stringify(y.toJSON(W))],{type:"application/json"})}function wt(){return(wt=(0,p.Z)(function*(y){const T=(yield Promise.resolve().then(n.bind(n,84792))).default,{data:W}=yield T(y,{responseType:"blob"});return W})).apply(this,arguments)}},22558:(_t,$,n)=>{function p(A){return A&&"getAtOrigin"in A&&"originOf"in A}n.d($,{l:()=>p})},60595:(_t,$,n)=>{n.d($,{T:()=>H});var p=n(15861),A=n(84792),l=n(26584),g=n(62208);function H(b,R,w,F,N,et){return J.apply(this,arguments)}function J(){return(J=(0,p.Z)(function*(b,R,w,F,N,et){let j=null;if((0,g.pC)(w)){const O=`${b}/nodepages/`,rt=O+Math.floor(w.rootIndex/w.nodesPerPage);try{return{type:"page",rootPage:(yield(0,A.default)(rt,{query:{f:"json",token:F},responseType:"json",signal:et})).data,rootIndex:w.rootIndex,pageSize:w.nodesPerPage,lodMetric:w.lodSelectionMetricType,urlPrefix:O}}catch(q){(0,g.pC)(N)&&N.warn("#fetchIndexInfo()","Failed to load root node page. Falling back to node documents.",rt,q),j=q}}if(!R)return null;const K=`${b}/nodes/`,k=K+(R&&R.split("/").pop());try{return{type:"node",rootNode:(yield(0,A.default)(k,{query:{f:"json",token:F},responseType:"json",signal:et})).data,urlPrefix:K}}catch(O){throw new l.Z("sceneservice:root-node-missing","Root node missing.",{pageError:j,nodeError:O,url:k})}})).apply(this,arguments)}},61556:(_t,$,n)=>{n.d($,{B:()=>A});var p=n(21726);function A(w){return H[function l(w){return w instanceof Blob?w.type:function g(w){const F=(0,p.Ml)(w);return R[F]||J}(w.url)}(w)]||b}const H={},J="text/plain",b=H[J],R={png:"image/png",jpeg:"image/jpeg",jpg:"image/jpg",bmp:"image/bmp",gif:"image/gif",json:"application/json",txt:"text/plain",xml:"application/xml",svg:"image/svg+xml",zip:"application/zip",pbf:"application/vnd.mapbox-vector-tile",gz:"application/gzip","bin.gz":"application/octet-stream"};for(const w in R)H[R[w]]=w},47351:(_t,$,n)=>{n.r($),n.d($,{default:()=>sa});var p=n(17626),A=n(14517),l=n(62208),g=n(77712),H=n(90912),b=(n(85931),n(76898)),R=n(1437),F=(n(29132),n(79608)),N=n(23719),et=n(86810),j=n(66656),K=n(128),k=n(72642);let O=class extends((0,F.J)(et.wq)){constructor(t){super(t),this.type="plane",this.position=null,this.heading=0,this.tilt=0,this.width=10,this.height=10}equals(t){return this.heading===t.heading&&this.tilt===t.tilt&&(0,l._W)(this.position,t.position)&&this.width===t.width&&this.height===t.height}};(0,p._)([(0,g.Cb)({readOnly:!0,json:{read:!1,write:!0}})],O.prototype,"type",void 0),(0,p._)([(0,g.Cb)({type:k.Z}),(0,K.B)()],O.prototype,"position",void 0),(0,p._)([(0,g.Cb)({type:Number,nonNullable:!0,range:{min:0,max:360}}),(0,K.B)(),(0,j.p)(t=>N.BV.normalize((0,H.q9)(t),0,!0))],O.prototype,"heading",void 0),(0,p._)([(0,g.Cb)({type:Number,nonNullable:!0,range:{min:0,max:360}}),(0,K.B)(),(0,j.p)(t=>N.BV.normalize((0,H.q9)(t),0,!0))],O.prototype,"tilt",void 0),(0,p._)([(0,g.Cb)({type:Number,nonNullable:!0}),(0,K.B)()],O.prototype,"width",void 0),(0,p._)([(0,g.Cb)({type:Number,nonNullable:!0}),(0,K.B)()],O.prototype,"height",void 0),O=(0,p._)([(0,b.j)("esri.analysis.SlicePlane")],O);const rt=O;var q=n(72392),wt=n(63290),z=n(32917),v=n(41743),y=n(44917),T=n(49410),W=n(8314),x=n(21286),C=n(23841),f=n(28347),B=n(43703),V=n(48977),r=n(84161),D=n(28093),ct=n(55915),lt=n(78172),G=n(90014),vt=n(70562),Kt=n(34054),h=n(26242),it=n(4794);const Zt=(0,W.Z)("mac")?"Meta":"Control",Yt="Shift",Le=2,Ae=1.15,Ue=1.15,Ne=Math.cos((0,x.Vl)(45)),re=Math.cos((0,x.Vl)(5)),Ot=(0,D.f)(1,.5,0),oe=1,Ct=(0,it.b)([...Ot,.7]),Et=[0,0,0,.04],de=(0,it.b)([...Ot,.5]),Ke=(0,it.f)(1,1,1,1),Ze=(0,it.f)(1,.8,.6,1),Ye=(0,it.f)(1,.93,.86,1),Xe=(0,it.b)([...Ot,1]),Qe=(0,it.b)([...Ot,1]),$e=3,ce=11,Xt=22.5,Rt=40,he=48,Je=2.25,ke=(0,it.b)([...Ot,1]),qe=4,ue=1,ti=.3,ei=6,ii=4;var ge=n(54865),ve=n(45403),xt=n(19142),ht=n(40345),si=n(87469),ye=n(993),ni=n(53928),ut=n(57521),ot=n(40723),ri=n(13934),li=n(87601),oi=n(60881),di=n(5894),ci=n(2770),hi=n(66131),ui=n(15842),pi=n(17625),gi=n(651),vi=n(91056),yi=n(39114),fi=n(12407),mi=n(30750),St=n(67969),Qt=n(2078);class Pi extends pi.K{constructor(){super(...arguments),this.backgroundColor=(0,it.f)(1,0,0,.5),this.gridColor=(0,it.f)(0,1,0,.5),this.gridWidth=4}}class Lt extends vi.A{initializeProgram(e){return new fi.$(e.rctx,Lt.shader.get().build(this.configuration),yi.i)}initializePipeline(){return(0,Qt.sm)({blending:(0,Qt.wK)(St.zi.ONE,St.zi.ONE,St.zi.ONE_MINUS_SRC_ALPHA,St.zi.ONE_MINUS_SRC_ALPHA),depthTest:{func:St.wb.LESS},colorWrite:Qt.BK})}}Lt.shader=new gi.J(mi.S,()=>n.e(5175).then(n.bind(n,15175)));class Mi extends ui.c{constructor(e){super(e,new wi),this._configuration=new li.m}createBufferWriter(){return new ci.G(hi.W1)}requiresSlot(e,i){return i===ri.H.Color&&e===di.r.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL}createGLMaterial(e){return new _i(e)}getConfiguration(){return this._configuration}}class _i extends oi.Z{constructor(e){super(e),this.ensureTechnique(Lt,null)}beginSlot(){return(0,l.Wg)(this.technique)}}class wi extends Pi{constructor(){super(...arguments),this.renderOccluded=ot.yD.Occlude}}class Ci extends ni._{constructor(e){super(e),this._material=null,this._renderOccluded=ot.yD.OccludeAndTransparent,this._gridWidth=1,this._gridColor=(0,it.f)(1,0,0,1),this._backgroundColor=(0,it.f)(1,0,0,1),this.applyProps(e)}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial())}get gridWidth(){return this._gridWidth}set gridWidth(e){this._gridWidth!==e&&(this._gridWidth=e,this._updateMaterial())}get gridColor(){return this._gridColor}set gridColor(e){(0,ye.c)(this._gridColor,e),this._updateMaterial()}get backgroundColor(){return this._backgroundColor}set backgroundColor(e){(0,ye.c)(this._backgroundColor,e),this._updateMaterial()}createExternalResources(){this._material=new Mi(this._materialParameters)}destroyExternalResources(){this._material=null}forEachExternalMaterial(e){(0,l.pC)(this._material)&&e(this._material)}createGeometries(e){if((0,l.pC)(this._material)){const i=(0,ut.g7)(this._material);e.addGeometry(i)}}get _materialParameters(){return{backgroundColor:this._backgroundColor,gridWidth:this._gridWidth,gridColor:this._gridColor,renderOccluded:this._renderOccluded}}_updateMaterial(){(0,l.pC)(this._material)&&this._material.setParameters(this._materialParameters)}}var pt,t,fe=n(13986),me=n(26046),At=n(42743),Ut=n(92972),Pe=n(49580),Ei=n(92222),st=n(33786);function Me(t,e){return(0,xt.Aq)(t.basis1,t.basis2,t.origin,e)}function _e(t,e,i,a){const s=e.worldUpAtPosition(t.origin,h.WM.get()),c=h.WM.get();switch(i){case bt.HEADING:(0,r.c)(c,s);break;case bt.TILT:(0,r.c)(c,t.basis1)}return(0,G.Yq)(t.origin,c,a)}function $t(t,e){switch(e){case pt.POSITIVE_X:return{basis:t.basis1,direction:1,position:(0,r.a)(h.WM.get(),t.origin,t.basis1),edge:e};case pt.POSITIVE_Y:return{basis:t.basis2,direction:1,position:(0,r.a)(h.WM.get(),t.origin,t.basis2),edge:e};case pt.NEGATIVE_X:return{basis:t.basis1,direction:-1,position:(0,r.b)(h.WM.get(),t.origin,t.basis1),edge:e};case pt.NEGATIVE_Y:return{basis:t.basis2,direction:-1,position:(0,r.b)(h.WM.get(),t.origin,t.basis2),edge:e}}}function we(t,e,i){const a=i.projectToRenderScreen((0,r.a)(h.WM.get(),t,e),(0,C.Wv)(h.WM.get())),s=i.projectToRenderScreen((0,r.b)(h.WM.get(),t,e),(0,C.Wv)(h.WM.get()));return(0,r.p)((0,r.b)(a,a,s))}function Ce(t){const e=(0,r.l)(t.basis1),i=(0,r.l)(t.basis2);return ti*Math.min(e,i)}function Jt(t){return Ce(t)}function kt(t){return 0!==t.direction[0]&&0!==t.direction[1]}function Ee(t,e){const i=(0,xt.Ju)(t,{customStateMask:Z,texture:e});return i.state=Z,i}function be(t){return new si.r({view:t,attached:!1,color:Ct,width:oe,writeDepthEnabled:!1,renderOccluded:ot.yD.OccludeAndTransparent,geometry:[[[-1,-1,0],[1,-1,0],[1,1,0],[-1,1,0],[-1,-1,0]]]})}function Te(t){return new Ci({view:t,attached:!1,backgroundColor:[...Et],gridColor:de,gridWidth:4,renderOccluded:ot.yD.OccludeAndTransparent})}function Ve(t,e,i,a=new rt){if((0,l.Wi)(t))return null;const{renderCoordsHelper:s}=e,c=s.fromRenderCoords(t.origin,e.spatialReference);if((0,l.Wi)(c))return null;const d=(0,ct.fM)(c,i);if((0,l.Wi)(d))return null;a.position=d;const u=2*(0,r.l)(t.basis1),m=2*(0,r.l)(t.basis2),E=fe.Z.renderUnitScaleFactor(e.spatialReference,i);a.width=u*E,a.height=m*E;const P=s.worldUpAtPosition(t.origin,h.WM.get());return a.tilt=(0,x.BV)(qt(t,P)),a.heading=s.headingAtPosition(t.origin,t.basis1)-90,a}function qt(t,e){return(0,Kt.cp)(e,t.basis2,t.basis1)+Tt}n(2004),(t=pt||(pt={}))[t.POSITIVE_X=0]="POSITIVE_X",t[t.POSITIVE_Y=1]="POSITIVE_Y",t[t.NEGATIVE_X=2]="NEGATIVE_X",t[t.NEGATIVE_Y=3]="NEGATIVE_Y";const Z=st.jg.Custom1;var bt,nt;(function(t){t[t.HEADING=1]="HEADING",t[t.TILT=2]="TILT"})(bt||(bt={})),function(t){t[t.HORIZONTAL_OR_VERTICAL=0]="HORIZONTAL_OR_VERTICAL",t[t.HORIZONTAL=1]="HORIZONTAL",t[t.VERTICAL=2]="VERTICAL",t[t.TILTED=3]="TILTED"}(nt||(nt={}));const Bt=st.jg.Custom2,Ht=(0,vt.Ue)(),Tt=Math.PI/2,te=st.jg.Custom1,zi=st.jg.Custom2;var Nt;function Gi(t){return(0,l.pC)("building-scene-3d"===t.type?t:null)}!function(t){t[t.CENTER_ON_CALLOUT=0]="CENTER_ON_CALLOUT",t[t.CENTER_ON_ARROW=1]="CENTER_ON_ARROW"}(Nt||(Nt={}));var Fi=n(94573);const Se="esri.views.3d.analysis.Slice.SliceController",ee=wt.Z.getLogger(Se);let yt=class extends A.Z{constructor(t){super(t),this._handles=new q.Z,this._internalChange=!1,this._currentSlicePlane=null}initialize(){this._handles.add(this.analysis.excludedLayers.on("before-add",t=>{const e=t.item;null!=e&&(e instanceof y.Z||e instanceof T.Z)?e instanceof y.Z&&function Ki(t){switch(t.type){case"building-scene":case"csv":case"dimension":case"feature":case"geo-rss":case"geojson":case"graphics":case"group":case"integrated-mesh":case"kml":case"knowledge-graph":case"link-chart":case"knowledge-graph-sublayer":case"line-of-sight":case"map-notes":case"ogc-feature":case"oriented-imagery":case"point-cloud":case"route":case"scene":case"stream":case"voxel":case"subtype-group":case"unknown":case"unsupported":case"wfs":case null:return!1;case"base-dynamic":case"base-elevation":case"base-tile":case"bing-maps":case"elevation":case"imagery":case"imagery-tile":case"map-image":case"media":case"open-street-map":case"tile":case"vector-tile":case"wcs":case"web-tile":case"wms":case"wmts":return!0;default:return(0,Fi.Bg)(t.type),!1}}(e)?(ee.error("excludedLayers",`Layer '${e.title}, id:${e.id}' of type '${e.type}' can not be individually excluded from slicing. Use 'excludeGroundSurface' instead.`),t.preventDefault()):this.analysis.excludedLayers.includes(e)&&t.preventDefault():(ee.error("excludedLayers","Invalid layer type, layer must derive from Layer or BuildingComponentSublayer"),t.preventDefault())})),function Yi(t,e){ft.has(t)||ft.set(t,{all:[],activeController:null}),ft.get(t)?.all.push(e)}(this.view,this),this._handles.add([(0,z.YP)(()=>this.analysisViewData.plane,()=>{this._internalChange||this._updateSlicePlaneFromBoundedPlane(),this._updateLayerViews()},{sync:!0}),(0,z.YP)(()=>this.analysis.excludeGroundSurface,()=>this._updateLayerViews(),{sync:!0}),this.analysis.excludedLayers.on("change",()=>this._updateLayerViews()),(0,z.YP)(()=>[this.analysisViewData.active,this.analysisViewData.visible],()=>{this._updateActiveController(),this._updateViewSlicePlane()},{sync:!0}),(0,z.YP)(()=>this._allLayerAndSubLayerViews,()=>this._updateLayerViews())]),this._handles.add([(0,z.YP)(()=>this.analysis.shape,()=>{this._internalChange||(this._updateBoundedPlaneFromSlicePlane(),this._updateViewSlicePlane())},{sync:!0})],"analysis"),this._updateActiveController(),this._updateBoundedPlaneFromSlicePlane(),this._updateViewSlicePlane()}destroy(){this.analysisViewData.active&&(this.analysisViewData.active=!1,this.view.slicePlane=null),function Xi(t,e){if(!ft.has(t))throw new Error("view expected in global slice register");const i=ft.get(t),a=i?.all.lastIndexOf(e)??-1;if(!i||-1===a)throw new Error("controller expected in global slice register");i.all.splice(a,1),0===i.all.length&&ft.delete(t)}(this.view,this),this._handles.destroy(),this.set("view",null)}get _allLayerAndSubLayerViews(){const t=this.view.allLayerViews.items;return t.concat(t.filter(Gi).flatMap(({sublayerViews:e})=>e.items))}_updateBoundedPlaneFromSlicePlane(){const t=this.analysis.shape,e=this._currentSlicePlane;if((0,l.Wi)(e)&&(0,l.Wi)(t)||(0,l.pC)(e)&&(0,l.pC)(t)&&t.equals(e))return;let i=null,a=null;if((0,l.pC)(t)&&(0,l.pC)(t.position)){const s=t.position.spatialReference,c=function De(t,e){if((0,l.Wi)(t)||(0,l.Wi)(t.position))return null;const i=(0,ge.G)(t.position,e.spatialReference,e.elevationProvider);if((0,l.Wi)(i))return null;const a=fe.Z.renderUnitScaleFactor(t.position.spatialReference,e.spatialReference);return{position:i,heading:t.heading,tilt:t.tilt,renderWidth:t.width*a,renderHeight:t.height*a}}(t,this.view);(0,l.Wi)(c)&&(0,ge.e)(this.analysis,s,ee),i=function Oe(t,e,i,a=(0,v.a)()){if((0,l.Wi)(t))return null;const s=function ji(t,e,i,a,s,c,d=(0,v.a)()){return c.toRenderCoords(t,d.origin)?(c.worldBasisAtPosition(d.origin,lt.R.X,d.basis1),c.worldBasisAtPosition(d.origin,lt.R.Y,d.basis2),(0,G.my)(d.basis2,d.basis1,d.origin,d.plane),(0,v.r)(d,-(0,x.Vl)(e),(0,v.n)(d),d),(0,v.r)(d,(0,x.Vl)(i),d.basis1,d),(0,r.g)(d.basis1,d.basis1,a/2),(0,r.g)(d.basis2,d.basis2,s/2),(0,v.u)(d),d):(wt.Z.getLogger("esri.views.3d.analysis.Slice.sliceToolUtils").error(`Failed to project slice plane position, projection from ${t.spatialReference.wkid} is not supported`),null)}(t.position,t.heading,t.tilt,t.renderWidth,t.renderHeight,e.renderCoordsHelper,a);return!i.tiltEnabled&&(0,l.pC)(s)&&function Vi(t,e,i){const a=e.worldUpAtPosition(t.origin,h.WM.get()),s=t.basis1,c=qt(t,a),d=Math.round(c/Tt)*Tt;(0,v.r)(t,d-c,s,i)}(s,e.renderCoordsHelper,s),s}(c,this.view,{tiltEnabled:this.analysis.tiltEnabled},(0,v.a)()),(0,l.pC)(i)&&(a={heading:t.heading,tilt:t.tilt,position:t.position,width:t.width,height:t.height})}this._currentSlicePlane=a,this._internalChange=!0,this.analysisViewData.plane=i,this._internalChange=!1}_updateSlicePlaneFromBoundedPlane(){const e=Ve(this.analysisViewData.plane,this.view,this.view.spatialReference,new rt);let i=null;(0,l.pC)(e)&&(i={heading:e.heading,tilt:e.tilt,position:e.position,width:e.width,height:e.height}),this._currentSlicePlane=i,this._internalChange=!0,this.analysis.shape=e,this._internalChange=!1,this._updateViewSlicePlane()}_updateActiveController(){if(ie)return;const t=Ie(this.view);if(t)if(this.analysisViewData.active)(0,l.pC)(t.activeController)&&t.activeController!==this?(ie=!0,t.activeController.analysisViewData.active=!1,ie=!1):(0,l.pC)(t.activeController),this._updateLayerViews(),t.activeController=this;else{if((0,l.pC)(t.activeController)&&t.activeController!==this)return;(0,l.pC)(t.activeController)&&t.activeController===this&&(t.activeController=null,this._updateLayerViews())}}_updateViewSlicePlane(){!function Zi(t){const e=Ie(t)?.activeController;t.slicePlane=(0,l.pC)(e)&&(0,l.pC)(e.analysisViewData.plane)&&e.analysisViewData.visible?e.analysisViewData.plane:null}(this.view)}_updateLayerViews(){const t=(0,l.pC)(this.analysisViewData.plane)&&this.analysisViewData.visible&&this.analysisViewData.active,e=[],i=a=>{"layers"in a?a.layers.forEach(i):e.push(a)};this.analysis.excludedLayers.forEach(i),this.view.allLayerViews.forEach(a=>{a.destroyed||("slicePlaneEnabled"in a&&(a.slicePlaneEnabled=t&&!e.includes(a.layer)),"sublayerViews"in a&&a.sublayerViews.forEach(s=>{s.slicePlaneEnabled=t&&!e.includes(s.sublayer)}))}),null!=this.view.basemapTerrain&&(this.view.basemapTerrain.slicePlaneEnabled=t&&!this.analysis.excludeGroundSurface)}};(0,p._)([(0,g.Cb)()],yt.prototype,"view",void 0),(0,p._)([(0,g.Cb)()],yt.prototype,"analysis",void 0),(0,p._)([(0,g.Cb)()],yt.prototype,"analysisViewData",void 0),(0,p._)([(0,g.Cb)()],yt.prototype,"_allLayerAndSubLayerViews",null),yt=(0,p._)([(0,b.j)(Se)],yt);const ft=new Map;let ie=!1;function Ie(t){return ft.get(t)}var ae,Qi=n(84244),$i=n(50618),We=n(25601),jt=n(8859),Ji=n(62483),ki=n(67857),qi=n(58997),zt=n(30260),It=n(41900);let Y=ae=class extends qi.f{constructor(t){super(t),this._clock=Qi.m,this._previewPlaneOpacity=1,this.removeIncompleteOnCancel=!1,this.layersMode="none",this.shiftManipulator=null,this.rotateHeadingManipulator=null,this.rotateTiltManipulator=null,this.resizeManipulators=null,this._handles=new q.Z,this._viewHandles=new q.Z,this._frameTask=null,this._pointerMoveTimerMs=2500,this._prevPointerMoveTimeout=null,this._previewPlaneGridVisualElement=null,this._previewPlaneOutlineVisualElement=null,this._startPlane=(0,v.a)(),this._previewPlane=null,this._activeKeyModifiers={},this._lastCursorPosition=(0,C.vW)(),this._resizeHandles=[{direction:[1,0]},{direction:[1,1]},{direction:[0,1]},{direction:[-1,1]},{direction:[-1,0]},{direction:[-1,-1]},{direction:[0,-1]},{direction:[1,-1]}],this._intersector=(0,Ji.Z8)(t.view.state.viewingMode),this._intersector.options.store=ki.eC.MIN}initialize(){if(null==this.analysis)throw new Error("SliceTool requires valid analysis, but null was provided.");this._rotateHeadingImage=(0,We.O)(this.view.toolViewManager.textures),this._rotateTiltImage=(0,We.s)(this.view.toolViewManager.textures);const t=i=>{this._updateManipulatorsInteractive(i),i.grabbing||((0,l.pC)(this.analysisViewData.plane)&&(0,v.c)(this.analysisViewData.plane,this._startPlane),this.inputState=null)};this.shiftManipulator=function Ai(t,e=Nt.CENTER_ON_ARROW){const i=e===Nt.CENTER_ON_CALLOUT?Rt:0,a=[(0,D.f)(i,0,-he/2),(0,D.f)(i,0,he/2)],s=function Ni(t,e){const i=(0,r.b)((0,D.c)(),t[t.length-1],t[t.length-2]);if((0,r.n)(i,i),(0,r.g)(i,i,Xt),(0,r.a)(i,i,t[t.length-1]),e){const a=(0,r.b)((0,D.c)(),t[0],t[1]);return(0,r.n)(a,a),(0,r.g)(a,a,Xt),(0,r.a)(a,a,t[0]),[a,...t,i]}return[...t,i]}(a,!0),c=(M,L)=>function Bi(t,e,i){const a=new Ut.E({color:Ke,cullFace:At.Vr.Back,renderOccluded:ot.yD.Opaque}),s=new Ut.E({color:Ze,cullFace:At.Vr.Back,renderOccluded:ot.yD.Opaque}),c=new Ut.E({color:Ye,cullFace:At.Vr.Back,renderOccluded:ot.yD.Opaque}),d=new Ut.E({color:Qe,transparent:!0,writeDepth:!1,cullFace:At.Vr.Front,renderOccluded:ot.yD.Transparent}),u=m=>{t=t.slice(0);const E=(0,r.b)(h.WM.get(),t[0],t[1]);(0,r.n)(E,E);const P=(0,r.b)(h.WM.get(),t[t.length-1],t[t.length-2]);if((0,r.n)(P,P),e>0){const Wt=(0,r.g)((0,D.c)(),P,-e);t[t.length-1]=(0,r.a)(Wt,Wt,t[t.length-1]);const Dt=(0,r.g)((0,D.c)(),E,-e);t[0]=(0,r.a)(Dt,Dt,t[0])}const M=m?Ue:1,L=Xt*M,Q=ce*M,tt=(0,f.i)(h.MP.get());if(e>0){const Wt=L/4,Dt=(0,r.s)(h.WM.get(),0,Wt,0),Ft=1+e/Wt;(0,f.w)(tt,tt,Dt),(0,f.k)(tt,tt,(0,r.s)(h.WM.get(),Ft,Ft,Ft)),(0,f.w)(tt,tt,(0,r.g)(Dt,Dt,-1/Ft))}const U=(0,f.i)((0,B.c)()),mt=(0,D.f)(0,1,0),at=(0,f.F)((0,B.c)(),(0,V.r)(h.vD.get(),mt,P));at[12]=t[t.length-1][0],at[13]=t[t.length-1][1],at[14]=t[t.length-1][2],(0,f.m)(at,at,tt);const Gt=function Hi(t,e,i){const a=[];for(let c=0;c<12;c++){const d=c/12*2*Math.PI;a.push([Math.cos(d)*t,Math.sin(d)*t])}return(0,ut.x2)(i,a,e,[],[],!1)}($e*(m?Ae:1)+e,t,i?d:c);Gt.transformation=U;const Pt=[Gt],Vt=(0,ut.QL)(i?d:a,L,Q,24,!1,!1,!0);Vt.transformation=at,Pt.push(Vt);const ne=(0,ut.QL)(i?d:s,L,Q,24,!1,!0,!1);ne.transformation=at,Pt.push(ne);const Mt=(0,f.F)((0,B.c)(),(0,V.r)(h.vD.get(),mt,E));return Mt[12]=t[0][0],Mt[13]=t[0][1],Mt[14]=t[0][2],(0,f.m)(Mt,Mt,tt),Pt.push(Vt.instantiate({transformation:Mt})),Pt.push(ne.instantiate({transformation:Mt})),Pt};return{normal:u(!1),focused:u(!0)}}(a,M,L),d=c(0,!1),u=c(Je,!0),m=new Pe.Y({color:Xe,renderOccluded:ot.yD.OccludeAndTransparent}),E=(0,ut.rh)(m,[[i,0,0],[i-Rt,0,0]]),P=(0,ut.rh)(m,[[i,0,0],[i-Rt,0,0]]);return new ve.Z({view:t,renderObjects:[...d.normal.map(M=>new ht.r(M,st.Q9.Unfocused|Z)),...u.normal.map(M=>new ht.r(M,st.Q9.Unfocused|Z)),new ht.r(E,st.Q9.Unfocused|Z|Bt),...d.focused.map(M=>new ht.r(M,st.Q9.Focused|Z)),...u.focused.map(M=>new ht.r(M,st.Q9.Focused|Z)),new ht.r(P,st.Q9.Focused|Z|Bt)],autoScaleRenderObjects:!1,collisionType:{type:"line",paths:[s]},collisionPriority:1,radius:ce,state:Z})}(this.view),this.manipulators.add(this.shiftManipulator),this.shiftManipulator.events.on("grab-changed",i=>{this._onShiftGrab(i),t(this.shiftManipulator)}),this._handles.add(this._createShiftDragPipeline(this.shiftManipulator)),this.rotateHeadingManipulator=Ee(this.view,this._rotateHeadingImage.texture),this.manipulators.add(this.rotateHeadingManipulator),this.rotateHeadingManipulator.events.on("grab-changed",i=>{this._onRotateHeadingGrab(i),t(this.rotateHeadingManipulator)}),this._handles.add(this._createRotateHeadingDragPipeline(this.rotateHeadingManipulator)),this.rotateTiltManipulator=Ee(this.view,this._rotateTiltImage.texture),this.manipulators.add(this.rotateTiltManipulator),this.rotateTiltManipulator.events.on("grab-changed",i=>{this._onRotateTiltGrab(i),t(this.rotateTiltManipulator)}),this._handles.add(this._createRotateTiltDragPipeline(this.rotateTiltManipulator)),this.resizeManipulators=this._resizeHandles.map((i,a)=>{const s=function Ui(t,e){const i=kt(e),a=i?[(0,D.f)(1,0,0),(0,D.f)(0,0,0),(0,D.f)(0,1,0)]:[(0,D.f)(1,0,0),(0,D.f)(-1,0,0)],s=ke,u=i?qe:ue,m=u*Le,E=ue,P=Q=>Q>1?(Q=>new Ei.U({color:s,width:Q,renderOccluded:ot.yD.OccludeAndTransparent}))(Q):new Pe.Y({color:s,renderOccluded:ot.yD.OccludeAndTransparent}),M=[new ht.r((0,ut.rh)(P(u),a),st.Q9.Unfocused|te),new ht.r((0,ut.rh)(P(m),a),st.Q9.Focused|te),new ht.r((0,ut.rh)(P(E),a),zi)],L=new ve.Z({view:t,renderObjects:M,collisionType:{type:"line",paths:[a]},radius:i?ei:ii,...xt.X9});return L.state=te,L}(this.view,i);return s.events.on("grab-changed",c=>{this._onResizeGrab(c,a),t(s)}),this._handles.add(this._createResizeDragPipeline(s)),s}),this.manipulators.addMany(this.resizeManipulators),this._previewPlaneGridVisualElement=Te(this.view),this._previewPlaneOutlineVisualElement=be(this.view),this._previewPlaneOutlineVisualElement.width=2,this._handles.add((0,z.YP)(()=>this.analysisViewData.plane,()=>this._updateManipulators(),z.Z_));const e=(0,z.YP)(()=>this.state,i=>{"sliced"===i&&this.finishToolCreation()},z.tX);this._handles.add([e,(0,z.YP)(()=>this.view.state.camera,()=>this._onCameraChange())])}destroy(){this._rotateHeadingImage=(0,l.RY)(this._rotateHeadingImage),this._rotateTiltImage=(0,l.RY)(this._rotateTiltImage),this._handles=(0,l.SC)(this._handles),this._viewHandles=(0,l.SC)(this._viewHandles),this._removeFrameTask(),this._clearPointerMoveTimeout(),this._previewPlaneOutlineVisualElement=(0,l.SC)(this._previewPlaneOutlineVisualElement),this._previewPlaneGridVisualElement=(0,l.SC)(this._previewPlaneGridVisualElement)}get state(){const t=!!this.analysisViewData.plane,e=!!this.inputState;return t?t&&e?"slicing":t&&!e?"sliced":"ready":"ready"}get cursor(){return this._isPlacingSlicePlane||"exclude"===this.layersMode?"crosshair":(0,l.pC)(this._creatingPointerId)?"grabbing":null}set analysis(t){if(null==t)throw new Error("SliceTool requires valid analysis, but null was provided.");this._handles.remove("analysis"),this._set("analysis",t)}get inputState(){return this._get("inputState")}set inputState(t){this._set("inputState",t),this.analysisViewData.showGrid=(0,l.pC)(t)&&"resize"===t.type,this._updateMaterials()}get _isPlacingSlicePlane(){return!this.inputState&&!this.analysisViewData.plane&&this.active}get _creatingPointerId(){return(0,l.pC)(this.inputState)&&"shift"===this.inputState.type?this.inputState.creatingPointerId:null}enterExcludeLayerMode(){(0,l.Wi)(this.analysisViewData.plane)||(this._set("layersMode","exclude"),this.active||(this.view.activeTool=this))}exitExcludeLayerMode(){(0,l.Wi)(this.analysisViewData.plane)||(this._set("layersMode","none"),this.active&&(this.view.activeTool=null))}onDeactivate(){this._set("layersMode","none"),this._updatePreviewPlane(null)}onShow(){this._updateVisibility(!0)}onHide(){this._updateVisibility(!1)}_updateVisibility(t){this._updateManipulators(),t||this._clearPointerMoveTimeout()}onInputEvent(t){switch(t.type){case"pointer-drag":if(!se(t))return;this._isPlacingSlicePlane?this._onClickPlacePlane(t)&&t.stopPropagation():this._onPointerDrag(t)&&t.stopPropagation();break;case"pointer-move":this._onPointerMove(t);break;case"pointer-up":this._onPointerUp(t)&&t.stopPropagation();break;case"immediate-click":if(!se(t))return;this._onClickPlacePlane(t)&&t.stopPropagation();break;case"click":if(!se(t))return;this._onClickExcludeLayer(t)&&t.stopPropagation();break;case"drag":this.inputState&&t.stopPropagation();break;case"key-down":this._onKeyDown(t)&&t.stopPropagation();break;case"key-up":this._onKeyUp(t)&&t.stopPropagation()}}onEditableChange(){this.analysisViewData.editable=this.internallyEditable}_onPointerDrag(t){const e=this.inputState;if(t.pointerId===this._creatingPointerId&&(0,l.pC)(e)&&"shift"===e.type){const i=(0,It.vT)(t);return this.shiftManipulator.events.emit("drag",{action:e.hasBeenDragged?"update":"start",pointerType:t.pointerType,start:i,screenPoint:i}),e.hasBeenDragged=!0,!0}return!1}_onPointerMove(t){this._lastCursorPosition.x=t.x,this._lastCursorPosition.y=t.y,this._resetPointerMoveTimeout(),"touch"!==t.pointerType&&this._updatePreviewPlane((0,It.vT)(t),this._activeKeyModifiers)}_onCameraChange(){this._updatePreviewPlane(this._lastCursorPosition,this._activeKeyModifiers),this._updateManipulators()}_onPointerUp(t){if(t.pointerId===this._creatingPointerId&&(0,l.pC)(this.analysisViewData.plane)){const e=(0,It.vT)(t);return this.shiftManipulator.events.emit("drag",{action:"end",start:e,screenPoint:e}),(0,v.c)(this.analysisViewData.plane,this._startPlane),this.inputState=null,!0}return!1}_onClickPlacePlane(t){if("exclude"===this.layersMode)return!1;if(this._isPlacingSlicePlane){const e=(0,It.vT)(t),i=(0,v.a)();if(this._pickPlane(e,!1,this._activeKeyModifiers,i)){if((0,v.c)(i,this._startPlane),this.analysis.shape=Ve(i,this.view,this.view.spatialReference,new rt),"pointer-drag"===t.type){const a=this._calculatePickRay(e);this.inputState=Re(a,t.pointerId,i.origin,i)}return!0}}return!1}_onClickExcludeLayer(t){return!("exclude"!==this.layersMode||!this.created||(this.view.hitTest((0,It.vT)(t)).then(e=>{if(e.results.length){const i=e.results[0],a="graphic"===i?.type&&i.graphic;if(a){const s=a.sourceLayer||a.layer;s&&this.analysis.excludedLayers.push(s)}}else e.ground.layer?this.analysis.excludedLayers.push(e.ground.layer):this.analysis.excludeGroundSurface=!0}),this._set("layersMode","none"),this.active&&(this.view.activeTool=null),0))}_onKeyDown(t){return(t.key===Yt||t.key===Zt)&&(this._activeKeyModifiers[t.key]=!0,(0,l.pC)(this._previewPlane)&&this._updatePreviewPlane(this._lastCursorPosition,this._activeKeyModifiers),!0)}_onKeyUp(t){return!(t.key!==Yt&&t.key!==Zt||!this._activeKeyModifiers[t.key]||(delete this._activeKeyModifiers[t.key],(0,l.pC)(this._previewPlane)&&this._updatePreviewPlane(this._lastCursorPosition,this._activeKeyModifiers),0))}_onShiftGrab(t){if("start"!==t.action||(0,l.Wi)(this.analysisViewData.plane)||!t.screenPoint)return;const e=this._calculatePickRay(t.screenPoint);(0,v.c)(this.analysisViewData.plane,this._startPlane),this.inputState=Re(e,null,this.shiftManipulator.renderLocation,this.analysisViewData.plane)}_createShiftDragPipeline(t){return(0,zt.Xd)(t,(e,i,a)=>{const s=this.inputState;if((0,l.Wi)(s)||"shift"!==s.type)return;const c=(0,l.pC)(this.analysisViewData.plane)?(0,v.c)(this.analysisViewData.plane,(0,v.a)()):null;i.next((0,jt._N)(this.view,s.shiftPlane)).next(this._shiftDragAdjustSensitivity(s)).next(this._shiftDragUpdatePlane(s)),a.next(()=>{(0,l.pC)(c)&&this._updateBoundedPlane(c)})})}_shiftDragAdjustSensitivity(t){return e=>{if((0,l.Wi)(this.analysisViewData.plane))return null;const a=Math.min((1-Math.abs((0,r.e)((0,v.n)(this.analysisViewData.plane),e.ray.direction)/(0,r.l)(e.ray.direction)))/.001,1),s=-(0,G.jH)(this._startPlane.plane,e.renderEnd),c=-(0,G.jH)(this._startPlane.plane,t.startPoint);return t.depth=t.depth*(1-a)+s*a-c,e}}_shiftDragUpdatePlane(t){return()=>{if((0,l.Wi)(this.analysisViewData.plane))return;const e=(0,r.c)(h.WM.get(),this._startPlane.origin),i=(0,r.c)(h.WM.get(),(0,v.n)(this._startPlane));(0,r.g)(i,i,-t.depth),(0,r.a)(i,i,e);const a=(0,v.f)(i,this.analysisViewData.plane.basis1,this.analysisViewData.plane.basis2,(0,v.a)());this._updateBoundedPlane(a)}}_onRotateHeadingGrab(t){if("start"!==t.action||(0,l.Wi)(this.analysisViewData.plane)||!t.screenPoint)return;const e=_e(this.analysisViewData.plane,this.view.renderCoordsHelper,bt.HEADING,(0,G.Ue)()),i=this._calculatePickRay(t.screenPoint),a=(0,D.c)();(0,G.BR)(e,i,a)&&((0,v.c)(this.analysisViewData.plane,this._startPlane),this.inputState={type:"rotate",rotatePlane:e,startPoint:a})}_createRotateHeadingDragPipeline(t){return(0,zt.Xd)(t,(e,i,a)=>{const s=this.inputState;if((0,l.Wi)(s)||"rotate"!==s.type)return;const c=(0,l.pC)(this.analysisViewData.plane)?(0,v.c)(this.analysisViewData.plane,(0,v.a)()):null;i.next((0,jt._N)(this.view,s.rotatePlane)).next(this._rotateDragRenderPlaneToRotate(s)).next(this._rotateDragUpdatePlaneFromRotate()),a.next(()=>{(0,l.pC)(c)&&this._updateBoundedPlane(c)})})}_onRotateTiltGrab(t){if("start"!==t.action||(0,l.Wi)(this.analysisViewData.plane)||!t.screenPoint)return;const e=_e(this.analysisViewData.plane,this.view.renderCoordsHelper,bt.TILT,(0,G.Ue)()),i=this._calculatePickRay(t.screenPoint),a=(0,D.c)();(0,G.BR)(e,i,a)&&((0,v.c)(this.analysisViewData.plane,this._startPlane),this.inputState={type:"rotate",rotatePlane:e,startPoint:a})}_createRotateTiltDragPipeline(t){return(0,zt.Xd)(t,(e,i,a)=>{const s=this.inputState;if((0,l.Wi)(s)||"rotate"!==s.type)return;const c=(0,l.pC)(this.analysisViewData.plane)?(0,v.c)(this.analysisViewData.plane,(0,v.a)()):null;i.next((0,jt._N)(this.view,s.rotatePlane)).next(this._rotateDragRenderPlaneToRotate(s)).next(this._rotateDragUpdatePlaneFromRotate()),a.next(()=>{(0,l.pC)(c)&&this._updateBoundedPlane(c)})})}_rotateDragRenderPlaneToRotate(t){return e=>{if((0,l.Wi)(this.analysisViewData.plane))return null;const i=(0,G.mJ)(t.rotatePlane),a=(0,xt.Gd)(t.startPoint,e.renderEnd,this.analysisViewData.plane.origin,i);return{...e,rotateAxis:i,rotateAngle:a}}}_rotateDragUpdatePlaneFromRotate(){return t=>{if((0,l.Wi)(this.analysisViewData.plane))return;const e=(0,f.d)(h.MP.get(),t.rotateAngle,t.rotateAxis);if((0,l.Wi)(e))return;const i=(0,r.m)(h.WM.get(),this._startPlane.basis1,e),a=(0,r.m)(h.WM.get(),this._startPlane.basis2,e),s=(0,v.f)(this.analysisViewData.plane.origin,i,a,(0,v.a)());this._updateBoundedPlane(s)}}_onResizeGrab(t,e){if("start"!==t.action||(0,l.Wi)(this.analysisViewData.plane)||!t.screenPoint)return;const i=this._calculatePickRay(t.screenPoint),a=h.WM.get();(0,G.BR)(this.analysisViewData.plane.plane,i,a)&&((0,v.c)(this.analysisViewData.plane,this._startPlane),this.inputState={type:"resize",activeHandleIdx:e,startPoint:(0,D.a)(a)})}_createResizeDragPipeline(t){return(0,zt.Xd)(t,(e,i,a)=>{const s=this.inputState;if((0,l.Wi)(s)||"resize"!==s.type||(0,l.Wi)(this.analysisViewData.plane))return;const c=(0,v.c)(this.analysisViewData.plane,(0,v.a)());i.next((0,jt._N)(this.view,this.analysisViewData.plane.plane)).next(this._resizeDragUpdatePlane(s)),a.next(()=>{this._updateBoundedPlane(c)})})}_resizeDragUpdatePlane(t){return e=>{if((0,l.Wi)(this.analysisViewData.plane))return;const a=function Di(t,e,i,a,s,c){const d=(0,r.c)(h.WM.get(),s.origin);(0,r.a)(d,d,(0,r.g)(h.WM.get(),s.basis1,t.direction[0]<0?1:-1)),(0,r.a)(d,d,(0,r.g)(h.WM.get(),s.basis2,t.direction[1]<0?1:-1));const u=(0,r.l)(s.basis1),m=(0,r.l)(s.basis2),E=(0,r.b)(h.WM.get(),i,d),P=(0,r.b)(h.WM.get(),e,d);let M=0,L=0;if(kt(t)){const Gt=Jt(s),Pt=Jt(c);M=u-.5*t.direction[0]*(0,r.e)(s.basis1,P)/u,L=m-.5*t.direction[1]*(0,r.e)(s.basis2,P)/m;const Vt=Pt/Gt;M*=Vt,L*=Vt}const Q=M+.5*t.direction[0]*(0,r.e)(s.basis1,E)/u,tt=L+.5*t.direction[1]*(0,r.e)(s.basis2,E)/m,U=(0,r.g)(h.WM.get(),s.basis1,Q/u),mt=(0,r.g)(h.WM.get(),s.basis2,tt/m);(Q<=0||we(c.origin,U,a)<=1600)&&(0,r.c)(U,c.basis1),(tt<=0||we(c.origin,mt,a)<=1600)&&(0,r.c)(mt,c.basis2);const at=(0,r.c)(h.WM.get(),d);return(0,r.a)(at,at,(0,r.g)(h.WM.get(),U,t.direction[0]<0?-1:1)),(0,r.a)(at,at,(0,r.g)(h.WM.get(),mt,t.direction[1]<0?-1:1)),(0,v.f)(at,U,mt,c)}(this._resizeHandles[t.activeHandleIdx],t.startPoint,e.renderEnd,this.view.state.camera,this._startPlane,(0,v.c)(this.analysisViewData.plane));this._updateBoundedPlane(a)}}_updateBoundedPlane(t){const e=this.analysisViewData;if(!(0,l.pC)(e))throw new Error("valid internal object expected");e.plane=t}_updatePreviewPlane(t,e={}){let i=this._previewPlane;if(this._previewPlane=null,(0,l.Wi)(t))return this._removeFrameTask(),void this._updateManipulators();if(!this.analysisViewData.plane&&this.active){const a=(0,l.pC)(i)?i:(0,v.a)();if(i=(0,l.pC)(i)?(0,v.c)(i,ta):null,this._pickPlane(t,!0,e,a)){const s=.95;let c=!1;(0,l.pC)(i)&&(c=(0,r.e)(i.plane,a.plane)<s||(0,r.e)((0,r.n)(h.WM.get(),i.basis1),(0,r.n)(h.WM.get(),a.basis1))<s),c&&(this._previewPlaneOpacity=0),this._previewPlane=a}}(0,l.pC)(this._previewPlane)&&(0,l.Wi)(this._frameTask)&&0===this._previewPlaneOpacity?this._frameTask=(0,$i.A)({update:({deltaTime:a})=>{this._previewPlaneOpacity=Math.min(this._previewPlaneOpacity+a/300,1),this._updateManipulators(),1===this._previewPlaneOpacity&&this._removeFrameTask()}}):(0,l.Wi)(this._previewPlane)&&(0,l.pC)(this._frameTask)?this._removeFrameTask():(0,l.pC)(this._previewPlane)&&this._updateManipulators()}_removeFrameTask(){this._frameTask=(0,l.hw)(this._frameTask)}_calculatePickRay(t){const e=(0,vt.Ue)(),i=(0,C.md)(t,ea);return(0,me.u4)(this.view.state.camera,i,e),(0,r.n)(e.direction,e.direction),e}_pickMinResult(t){const e=(0,C.md)(t,h.qW.get());return this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(e,this._intersector),this._intersector.results.min}_pickPlane(t,e,i,a){const s=this._pickMinResult(t),c=h.WM.get();if(!s.getIntersectionPoint(c))return!1;const d=s.getTransformedNormal(h.WM.get()),u=this.view.state.camera;(0,r.e)(d,u.viewForward)>0&&(0,r.g)(d,d,-1);const m=function Oi(t,e){return.4*Math.min(e.width,e.height)*e.computeRenderPixelSizeAt(t)}(c,u),E=(e?1:-1)*m*.02,P=(0,r.g)(h.WM.get(),d,E);return(0,r.a)(P,P,c),function bi(t,e,i,a,s,c,d,u){return function Ti(t,e,i,a,s,c){const d=(0,r.e)(t,e),u=h.WM.get(),m=h.WM.get();switch(a===nt.HORIZONTAL_OR_VERTICAL?Math.abs(d)>Ne?nt.HORIZONTAL:nt.VERTICAL:a){case nt.VERTICAL:{const P=Math.abs(d)<=re?t:i.viewUp;(0,r.f)(u,P,e),(0,r.c)(m,e);break}case nt.HORIZONTAL:(0,r.f)(u,i.viewUp,e),(0,r.f)(m,e,u);break;case nt.TILTED:{const P=Math.abs(d)<=re?e:i.viewUp;(0,r.f)(u,P,t),(0,r.f)(m,t,u);break}}const E=(0,r.f)(h.WM.get(),u,m);(0,r.e)(E,i.viewForward)>0&&(0,r.g)(m,m,-1),(0,r.n)(s,u),(0,r.n)(c,m)}(e,d.worldUpAtPosition(t,h.WM.get()),s,c,u.basis1,u.basis2),(0,r.g)(u.basis1,u.basis1,i),(0,r.g)(u.basis2,u.basis2,a),(0,r.c)(u.origin,t),(0,G.my)(u.basis2,u.basis1,u.origin,u.plane),u}(P,d,m,m,u,i[Yt]?nt.VERTICAL:i[Zt]?nt.HORIZONTAL:this.analysis.tiltEnabled?nt.TILTED:nt.HORIZONTAL_OR_VERTICAL,this.view.renderCoordsHelper,a),!0}_clearPointerMoveTimeout(){this._prevPointerMoveTimeout=(0,l.hw)(this._prevPointerMoveTimeout)}_resetPointerMoveTimeout(){this._clearPointerMoveTimeout(),this.shiftManipulator.state|=Z,this.rotateHeadingManipulator.state|=Z,this.rotateTiltManipulator.state|=Z,this._prevPointerMoveTimeout=this._clock.setTimeout(()=>{this.shiftManipulator.state&=~Z,this.rotateHeadingManipulator.state&=~Z,this.rotateTiltManipulator.state&=~Z},this._pointerMoveTimerMs)}_updateManipulators(){if(ae.disableEngineLayers)return;let t,e=!1;if((0,l.pC)(this.analysisViewData.plane))t=this.analysisViewData.plane,e=!1;else{if(!(0,l.pC)(this._previewPlane))return this.shiftManipulator.available=!1,this.rotateHeadingManipulator.available=!1,this.rotateTiltManipulator.available=!1,this.resizeManipulators.forEach(d=>d.available=!1),this._previewPlaneOutlineVisualElement.visible=!1,void(this._previewPlaneGridVisualElement.visible=!1);t=this._previewPlane,e=!0}const i=Me(t,h.MP.get());e?(this.shiftManipulator.available=!1,this.rotateHeadingManipulator.available=!1,this.rotateTiltManipulator.available=!1,this.resizeManipulators.forEach(d=>d.available=!1),this._previewPlaneOutlineVisualElement.attached=!0,this._previewPlaneGridVisualElement.attached=!0,this._previewPlaneOutlineVisualElement.visible=!0,this._previewPlaneGridVisualElement.visible=!0):(this.shiftManipulator.available=!0,this.rotateHeadingManipulator.available=!0,this.rotateTiltManipulator.available=this.analysis.tiltEnabled,this.resizeManipulators.forEach(d=>d.available=!0),function Ii(t,e,i,a){const s=$t(i,pt.NEGATIVE_X),c=h.MP.get();(0,f.o)(c,e,s.edge*Math.PI/2);const d=(0,r.n)(h.WM.get(),s.basis);let u=(0,r.g)(h.WM.get(),d,s.direction*a.computeScreenPixelSizeAt(s.position)*Rt);(0,r.a)(u,u,s.position);const m=a.projectToRenderScreen(u,(0,C.Wv)(h.WM.get())),E=function Wi(t,e){const[i,a,s,c]=t.viewport,d=Math.min(s,c)/16;let u=!0;return e[0]<i+d?(e[0]=i+d,u=!1):e[0]>i+s-d&&(e[0]=i+s-d,u=!1),e[1]<a+d?(e[1]=a+d,u=!1):e[1]>a+c-d&&(e[1]=a+c-d,u=!1),u}(a,m);(0,me.Bh)(a,m,Ht),(0,r.n)(Ht.direction,Ht.direction);const P=h.WM.get();!E&&(0,v.i)(i,Ht,P)&&(u=P),c[12]=0,c[13]=0,c[14]=0,t.modelTransform=c,t.renderLocation=(0,D.a)(u),E?t.state|=Bt:t.state&=~Bt}(this.shiftManipulator,i,t,this.view.state.camera),function xi(t,e,i,a){const s=a.worldUpAtPosition(i.origin,h.WM.get()),c=$t(i,pt.POSITIVE_X),d=(0,f.b)(h.MP.get(),c.edge*Math.PI/2);(0,f.r)(d,d,-qt(i,s)),(0,f.m)(d,e,d),d[12]=0,d[13]=0,d[14]=0,t.modelTransform=d,t.renderLocation=c.position}(this.rotateHeadingManipulator,i,t,this.view.renderCoordsHelper),function Li(t,e,i){const a=$t(i,pt.POSITIVE_Y),s=(0,f.b)(h.MP.get(),a.edge*Math.PI/2);(0,f.r)(s,s,Tt),(0,f.m)(s,e,s),s[12]=0,s[13]=0,s[14]=0,t.modelTransform=s,t.renderLocation=a.position}(this.rotateTiltManipulator,i,t),this.resizeManipulators.forEach((d,u)=>function Ri(t,e,i,a){const s=(0,r.l)(a.basis1),c=(0,r.l)(a.basis2),d=Ce(a),u=Jt(a),m=(0,r.s)(h.WM.get(),0,0,0);(0,r.a)(m,(0,r.g)(h.WM.get(),a.basis1,e.direction[0]),(0,r.g)(h.WM.get(),a.basis2,e.direction[1])),(0,r.a)(m,a.origin,m);let E=0,P=1;if(kt(e))1===e.direction[0]&&-1===e.direction[1]?E=Tt:1===e.direction[0]&&1===e.direction[1]?E=Math.PI:-1===e.direction[0]&&1===e.direction[1]&&(E=3*Math.PI/2),P=u;else{const L=0!==e.direction[0]?1:2;E=1===L?Tt:0,P=(1===L?c:s)-d}const M=(0,f.b)(h.MP.get(),E);(0,f.k)(M,M,(0,r.s)(h.WM.get(),P,P,P)),(0,f.m)(M,i,M),M[12]=0,M[13]=0,M[14]=0,t.modelTransform=M,t.renderLocation=m}(d,this._resizeHandles[u],i,t)),this._previewPlaneOutlineVisualElement.visible=!1,this._previewPlaneGridVisualElement.visible=!1);const a=(0,r.s)(h.WM.get(),(0,r.l)(t.basis1),(0,r.l)(t.basis2),1),s=(0,f.E)(h.MP.get(),a),c=(0,f.m)(s,i,s);this._previewPlaneOutlineVisualElement.transform=c,this._previewPlaneGridVisualElement.transform=c,this._updateMaterials()}_updateMaterials(){this._previewPlaneOutlineVisualElement.color=[Ct[0],Ct[1],Ct[2],Ct[3]*this._previewPlaneOpacity],this._previewPlaneGridVisualElement.backgroundColor=[Et[0],Et[1],Et[2],Et[3]*this._previewPlaneOpacity],this._previewPlaneGridVisualElement.gridColor=[0,0,0,0]}_updateManipulatorsInteractive(t){if(!t.grabbing)return this.shiftManipulator.interactive=!0,this.rotateHeadingManipulator.interactive=!0,this.rotateTiltManipulator.interactive=!0,void this.resizeManipulators.forEach(e=>{e.interactive=!0});this.shiftManipulator.interactive=this.shiftManipulator===t,this.rotateHeadingManipulator.interactive=this.rotateHeadingManipulator===t,this.rotateTiltManipulator.interactive=this.rotateTiltManipulator===t,this.resizeManipulators.forEach(e=>{e.interactive=e===t})}testData(){return{plane:this.analysisViewData.plane,setPointerMoveTimerMs:t=>{this._pointerMoveTimerMs=t}}}};function Re(t,e,i,a){const s=function Si(t,e,i,a){const s=(0,r.f)(h.WM.get(),e,i);return(0,r.f)(s,s,e),(0,G.Yq)(t,s,a)}(i,(0,v.n)(a),t.direction,(0,G.Ue)()),c=(0,D.c)();return(0,G.BR)(s,t,c)?{type:"shift",creatingPointerId:e,hasBeenDragged:!1,shiftPlane:s,depth:0,startPoint:c}:null}function se(t){return"mouse"!==t.pointerType||0===t.button}Y.disableEngineLayers=!1,(0,p._)([(0,g.Cb)()],Y.prototype,"_clock",void 0),(0,p._)([(0,g.Cb)({constructOnly:!0})],Y.prototype,"view",void 0),(0,p._)([(0,g.Cb)()],Y.prototype,"analysisViewData",void 0),(0,p._)([(0,g.Cb)({readOnly:!0})],Y.prototype,"state",null),(0,p._)([(0,g.Cb)({readOnly:!0})],Y.prototype,"cursor",null),(0,p._)([(0,g.Cb)()],Y.prototype,"analysis",null),(0,p._)([(0,g.Cb)()],Y.prototype,"removeIncompleteOnCancel",void 0),(0,p._)([(0,g.Cb)({readOnly:!0})],Y.prototype,"layersMode",void 0),(0,p._)([(0,g.Cb)({value:null})],Y.prototype,"inputState",null),(0,p._)([(0,g.Cb)()],Y.prototype,"_isPlacingSlicePlane",null),(0,p._)([(0,g.Cb)()],Y.prototype,"_creatingPointerId",null),Y=ae=(0,p._)([(0,b.j)("esri.views.3d.analysis.Slice.SliceTool")],Y);const ta=(0,v.a)(),ea=(0,C.s1)(),ia=Y;var aa=n(54889);let gt=class extends A.Z{constructor(t){super(t),this._handles=new q.Z,this._gridVisualElement=null,this._outlineVisualElement=null,this.showGrid=!1,this.preview=!0}initialize(){const t=this.analysisViewData;if((0,l.Wi)(t))throw new Error("expected internal object to be valid");this._gridVisualElement=Te(this.view),this._outlineVisualElement=be(this.view),this._handles.add([(0,z.YP)(()=>({visible:(0,l.pC)(t.plane)&&this.analysisViewData.visible,active:this.analysisViewData.active,preview:this.preview,showGrid:this.showGrid}),e=>this._updateMaterials(e),z.tX),(0,z.YP)(()=>t.plane,e=>this._updatePlane(e),z.tX)],"internal")}destroy(){this._handles.destroy(),this._gridVisualElement=(0,l.SC)(this._gridVisualElement),this._outlineVisualElement=(0,l.SC)(this._outlineVisualElement),this.set("view",null)}_updatePlane(t){if((0,l.Wi)(t))return;this._gridVisualElement.attached=!0,this._outlineVisualElement.attached=!0;const e=(0,r.s)(h.WM.get(),(0,r.l)(t.basis1),(0,r.l)(t.basis2),1),i=(0,f.E)(h.MP.get(),e),a=Me(t,h.MP.get()),s=(0,f.m)(i,a,i);this._outlineVisualElement.transform=s,this._gridVisualElement.transform=s}_updateMaterials({visible:t,active:e,preview:i,showGrid:a}){this._outlineVisualElement.color=Ct,this._outlineVisualElement.width=i?2:oe,this._outlineVisualElement.stipplePattern=e?null:(0,aa.z5)(5),this._gridVisualElement.backgroundColor=Et,this._gridVisualElement.gridColor=a?de:it.Z,this._gridVisualElement.visible=t,this._outlineVisualElement.visible=t}};(0,p._)([(0,g.Cb)()],gt.prototype,"view",void 0),(0,p._)([(0,g.Cb)()],gt.prototype,"analysis",void 0),(0,p._)([(0,g.Cb)()],gt.prototype,"analysisViewData",void 0),(0,p._)([(0,g.Cb)()],gt.prototype,"showGrid",void 0),(0,p._)([(0,g.Cb)()],gt.prototype,"preview",void 0),gt=(0,p._)([(0,b.j)("esri.views.3d.analysis.Slice.SliceVisualization")],gt);var xe=n(95925);let dt=class extends((0,R.p)(A.Z)){constructor(t){super(t),this.type="slice-view-3d",this.analysis=null,this.tool=null,this.analysisVisualization=null,this.analysisController=null,this.plane=null,this.active=!0}initialize(){this.analysisVisualization=new gt({view:this.view,analysis:this.analysis,analysisViewData:this}),this.analysisController=new yt({view:this.view,analysis:this.analysis,analysisViewData:this}),this.addHandles((0,xe.Lp)(this,ia))}destroy(){(0,xe.Yq)(this),this.analysisVisualization=(0,l.SC)(this.analysisVisualization),this.analysisController=(0,l.SC)(this.analysisController)}get showGrid(){return this.analysisVisualization?.showGrid??!1}set showGrid(t){this.analysisVisualization&&(this.analysisVisualization.showGrid=t)}get editable(){return!this.analysisVisualization.preview}set editable(t){this.analysisVisualization.preview=!t}get testData(){return{visualization:this.analysisVisualization,controller:this.analysisController,tool:(0,l.Wg)(this.tool)}}};(0,p._)([(0,g.Cb)({readOnly:!0})],dt.prototype,"type",void 0),(0,p._)([(0,g.Cb)({constructOnly:!0,nonNullable:!0})],dt.prototype,"analysis",void 0),(0,p._)([(0,g.Cb)()],dt.prototype,"tool",void 0),(0,p._)([(0,g.Cb)()],dt.prototype,"plane",void 0),(0,p._)([(0,g.Cb)()],dt.prototype,"active",void 0),(0,p._)([(0,g.Cb)()],dt.prototype,"showGrid",null),(0,p._)([(0,g.Cb)()],dt.prototype,"editable",null),dt=(0,p._)([(0,b.j)("esri.views.3d.analysis.SliceAnalysisView3D")],dt);const sa=dt},10023:(_t,$,n)=>{n.d($,{V:()=>J,e:()=>g});var p=n(15861),A=n(62208),l=n(36630);function g(b){return H.apply(this,arguments)}function H(){return(H=(0,p.Z)(function*(b,R=b.popupTemplate){if((0,A.Wi)(R))return[];const w=yield R.getRequiredFields(b.fieldsIndex),{lastEditInfoEnabled:F}=R,{objectIdField:N,typeIdField:et,globalIdField:j,relationships:K}=b;if(w.includes("*"))return["*"];const k=F?yield(0,l.CH)(b):[],O=(0,l.Q0)(b.fieldsIndex,[...w,...k]);return et&&O.push(et),O&&N&&b.fieldsIndex?.has(N)&&!O.includes(N)&&O.push(N),O&&j&&b.fieldsIndex?.has(j)&&!O.includes(j)&&O.push(j),K&&K.forEach(rt=>{const{keyField:q}=rt;O&&q&&b.fieldsIndex?.has(q)&&!O.includes(q)&&O.push(q)}),O})).apply(this,arguments)}function J(b,R){return b.popupTemplate?b.popupTemplate:(0,A.pC)(R)&&R.defaultPopupTemplateEnabled&&(0,A.pC)(b.defaultPopupTemplate)?b.defaultPopupTemplate:null}}}]);