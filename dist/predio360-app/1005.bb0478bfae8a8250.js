"use strict";(self.webpackChunkpredio360_app=self.webpackChunkpredio360_app||[]).push([[1005],{65629:(Te,ce,f)=>{f.d(ce,{SR:()=>ye,Ui:()=>he});var R=f(86810),E=f(65401),me=f(32442),pe=f(25748),T=f(91179),W=f(74618),ae=f(37053);function he(y){return z(y,!0)}function ye(y){return z(y,!1)}function z(y,u){if(null==y)return null;const p=y.spatialReference,c=(0,ae.C5)(p),g=(0,R.AK)(y)?y.toJSON():y;if(!c)return g;const _=(0,ae.sS)(p)?102100:4326,S=W.UZ[_].maxX,G=W.UZ[_].minX;if((0,T.wp)(g))return le(g,S,G);if((0,T.aW)(g))return g.points=g.points.map(C=>le(C,S,G)),g;if((0,T.YX)(g))return function be(y,u){if(!u)return y;const p=function D(y,u){const p=[],{ymin:c,ymax:g,xmin:_,xmax:S}=y,G=y.xmax-y.xmin,[C,U]=u.valid,{x:P,frameId:Z}=$(y.xmin,u),{x:H,frameId:F}=$(y.xmax,u),X=P===H&&G>0;if(G>2*U){const re={xmin:_<S?P:H,ymin:c,xmax:U,ymax:g},N={xmin:C,ymin:c,xmax:_<S?H:P,ymax:g},K={xmin:0,ymin:c,xmax:U,ymax:g},ne={xmin:C,ymin:c,xmax:0,ymax:g},te=[],se=[];ee(re,K)&&te.push(Z),ee(re,ne)&&se.push(Z),ee(N,K)&&te.push(F),ee(N,ne)&&se.push(F);for(let ie=Z+1;ie<F;ie++)te.push(ie),se.push(ie);p.push(new j(re,[Z]),new j(N,[F]),new j(K,te),new j(ne,se))}else P>H||X?p.push(new j({xmin:P,ymin:c,xmax:U,ymax:g},[Z]),new j({xmin:C,ymin:c,xmax:H,ymax:g},[F])):p.push(new j({xmin:P,ymin:c,xmax:H,ymax:g},[Z]));return p}(y,u).map(c=>c.extent);return p.length<2?p[0]||y:p.length>2?(y.xmin=u.valid[0],y.xmax=u.valid[1],y):{rings:p.map(c=>[[c.xmin,c.ymin],[c.xmin,c.ymax],[c.xmax,c.ymax],[c.xmax,c.ymin],[c.xmin,c.ymin]])}}(g,c);if((0,T.oU)(g)||(0,T.l9)(g)){const C=(0,me.$P)(L,g),U={xmin:C[0],ymin:C[1],xmax:C[2],ymax:C[3]},P=(0,W.XZ)(U.xmin,G)*(2*S),Z=0===P?g:(0,W.Sy)(g,P);return U.xmin+=P,U.xmax+=P,U.xmax>S?de(Z,S,u):U.xmin<G?de(Z,G,u):Z}return g}function le(y,u,p){if(Array.isArray(y)){const c=y[0];if(c>u){const g=(0,W.XZ)(c,u);y[0]=c+g*(-2*u)}else if(c<p){const g=(0,W.XZ)(c,p);y[0]=c+g*(-2*p)}}else{const c=y.x;if(c>u){const g=(0,W.XZ)(c,u);y.x+=g*(-2*u)}else if(c<p){const g=(0,W.XZ)(c,p);y.x+=g*(-2*p)}}return y}function $(y,u){const[p,c]=u.valid,g=2*c;let _,S=0;return y>c?(_=Math.ceil(Math.abs(y-c)/g),y-=_*g,S=_):y<p&&(_=Math.ceil(Math.abs(y-p)/g),y+=_*g,S=-_),{x:y,frameId:S}}function ee(y,u){const{xmin:p,ymin:c,xmax:g,ymax:_}=u;return B(y,p,c)&&B(y,p,_)&&B(y,g,_)&&B(y,g,c)}function B(y,u,p){return u>=y.xmin&&u<=y.xmax&&p>=y.ymin&&p<=y.ymax}function de(y,u,p=!0){const c=!(0,T.l9)(y);if(c&&(0,pe.Zy)(y),p)return(new fe).cut(y,u);const g=c?y.rings:y.paths,_=c?4:2,S=g.length,G=-2*u;for(let C=0;C<S;C++){const U=g[C];if(U&&U.length>=_){const P=[];for(const Z of U)P.push([Z[0]+G,Z[1]]);g.push(P)}}return c?y.rings=g:y.paths=g,y}class j{constructor(u,p){this.extent=u,this.frameIds=p}}const L=(0,E.Ue)();class fe{constructor(){this._linesIn=[],this._linesOut=[]}cut(u,p){let c;if(this._xCut=p,u.rings)this._closed=!0,c=u.rings,this._minPts=4;else{if(!u.paths)return null;this._closed=!1,c=u.paths,this._minPts=2}for(const _ of c){if(!_||_.length<this._minPts)continue;let S=!0;for(const G of _)S?(this.moveTo(G),S=!1):this.lineTo(G);this._closed&&this.close()}this._pushLineIn(),this._pushLineOut(),c=[];for(const _ of this._linesIn)_&&_.length>=this._minPts&&c.push(_);const g=-2*this._xCut;for(const _ of this._linesOut)if(_&&_.length>=this._minPts){for(const S of _)S[0]+=g;c.push(_)}return this._closed?u.rings=c:u.paths=c,u}moveTo(u){this._pushLineIn(),this._pushLineOut(),this._prevSide=this._side(u[0]),this._moveTo(u[0],u[1],this._prevSide),this._prevPt=u,this._firstPt=u}lineTo(u){const p=this._side(u[0]);if(p*this._prevSide==-1){const c=this._intersect(this._prevPt,u);this._lineTo(this._xCut,c,0),this._prevSide=0,this._lineTo(u[0],u[1],p)}else this._lineTo(u[0],u[1],p);this._prevSide=p,this._prevPt=u}close(){const u=this._firstPt,p=this._prevPt;u[0]===p[0]&&u[1]===p[1]||this.lineTo(u),this._checkClosingPt(this._lineIn),this._checkClosingPt(this._lineOut)}_moveTo(u,p,c){this._closed?(this._lineIn.push([c<=0?u:this._xCut,p]),this._lineOut.push([c>=0?u:this._xCut,p])):(c<=0&&this._lineIn.push([u,p]),c>=0&&this._lineOut.push([u,p]))}_lineTo(u,p,c){this._closed?(this._addPolyVertex(this._lineIn,c<=0?u:this._xCut,p),this._addPolyVertex(this._lineOut,c>=0?u:this._xCut,p)):c<0?(0===this._prevSide&&this._pushLineOut(),this._lineIn.push([u,p])):c>0?(0===this._prevSide&&this._pushLineIn(),this._lineOut.push([u,p])):this._prevSide<0?(this._lineIn.push([u,p]),this._lineOut.push([u,p])):this._prevSide>0&&(this._lineOut.push([u,p]),this._lineIn.push([u,p]))}_addPolyVertex(u,p,c){const g=u.length;g>1&&u[g-1][0]===p&&u[g-2][0]===p?u[g-1][1]=c:u.push([p,c])}_checkClosingPt(u){const p=u.length;p>3&&u[0][0]===this._xCut&&u[p-2][0]===this._xCut&&u[1][0]===this._xCut&&(u[0][1]=u[p-2][1],u.pop())}_side(u){return u<this._xCut?-1:u>this._xCut?1:0}_intersect(u,p){return u[1]+(this._xCut-u[0])/(p[0]-u[0])*(p[1]-u[1])}_pushLineIn(){this._lineIn&&this._lineIn.length>=this._minPts&&this._linesIn.push(this._lineIn),this._lineIn=[]}_pushLineOut(){this._lineOut&&this._lineOut.length>=this._minPts&&this._linesOut.push(this._lineOut),this._lineOut=[]}}},61005:(Te,ce,f)=>{f.d(ce,{Z:()=>ze});var R=f(15861),E=f(17626),me=f(83761),pe=f(85931),T=f(8314),W=f(61996),ae=f(62208),he=f(10699),ye=f(32917),z=f(77712),le=(f(63290),f(76898)),D=f(65401),$=f(91179),ee=f(60466),B=f(35909),de=f(2648),j=f(8080),L=f(39351),fe=f(96552),y=f(86207),u=f(8380),p=f(31201),c=f(80095);function _(){return(_=(0,R.Z)(function*(a,n,l){const h=[],d={scaleInfo:(0,c.UX)(a),scaleExpression:null};for(const m of n)switch(m.type){case"marker":h.push(...(0,c.zw)(l.instances.marker,m,p.Jh,d));break;case"fill":null==m.spriteRasterizationParam?h.push(...(0,c.U9)(l.instances.fill,m,d)):h.push(...(0,c.ep)(l.instances.complexFill,m,!1,d));break;case"line":m.spriteRasterizationParam?h.push(...(0,c.cs)(l.instances.texturedLine,m,!1,d)):h.push(...(0,c.KR)(l.instances.line,m,!1,d));break;case"text":h.push(...(0,c.QA)(l.instances.text,m,p.Jh,d))}return h})).apply(this,arguments)}var S=f(24464),G=f(24055),C=f(958),U=f(28269),P=f(46836),Z=f(44222),H=f(27105),F=f(82054),X=f(88071),re=f(25208);class N extends re.s{static from(n,l,h){return new N(n,l,h)}constructor(n,l,h){super(h),this._items=n,this._tile=l,this._index=-1,this._cachedGeometry=null;const d=l.lod;d.wrap&&(this._wrappingInfo={worldSizeX:d.worldSize[0]})}get _current(){return this._items[this._index]}getItem(){return this._current}getZOrder(){return this._current.zOrder}getMeshWriters(){return this._current.symbolResource?.symbolInfo.meshWriters??[]}hasField(n){return null!=this._current.attributes[n]}field(n){return this.readAttribute(n)}get geometryType(){const n=(0,$.Ji)(this._current.geometry);return"esriGeometryPoint"===n?"esriGeometryMultipoint":n}getCursor(){return this.copy()}copy(){const n=new N(this._items,this._tile,this.metadata);return this.copyInto(n),n}copyInto(n){super.copyInto(n),n._cachedGeometry=this._cachedGeometry,n._index=this._index}get fields(){throw new Error("Fields reading not supported to graphics.")}get hasFeatures(){return!!this._items.length}get hasNext(){return this._index+1<this._items.length}get exceededTransferLimit(){throw new Error("InternalError: exceededTransferLimit not implemented for graphics.")}get hasZ(){return!1}get hasM(){return!1}getInTransform(){return this._tile.transform}getSize(){return this._items.length}getAttributeHash(){let n="";for(const l in this._current.attributes)n+=this._current.attributes[l];return n}getObjectId(){return this._items[this._index].objectId}getDisplayId(){return this._current.displayId}setDisplayId(n){throw new Error("InternalError: Setting displayId not supported for graphics.")}setIndex(n){this._index=n}getIndex(){return this._index}next(){for(this._cachedGeometry=null;++this._index<this._items.length&&!this._getExists(););return this._index<this._items.length}readGeometryArea(){throw new Error("InternalError: readGeometryArea not supported for graphics.")}_readGeometry(){if(!this._cachedGeometry){let n=(0,F.GH)(this._current.projectedGeometry,this.hasZ,this.hasM);if("esriGeometryPolyline"===this.geometryType&&(n=(0,F.zj)(new X.Z,n,this.hasZ,this.hasM,this.geometryType,this._tile.transform.scale[0])),this._cachedGeometry=(0,F.Nh)(new X.Z,n,this.hasZ,this.hasM,this.geometryType,this._tile.transform),!this._cachedGeometry)return null;this._wrapGeometry(this._cachedGeometry)}return this._cachedGeometry}_wrapGeometry(n){if(!this._wrappingInfo)return;const{worldSizeX:l}=this._wrappingInfo;if(n.isPoint)return 1===l?(n.coords.push(L.i9,0),n.coords.push(2*-L.i9,0),void n.lengths.push(3)):2===l?(n.coords.push(2*L.i9,0),n.coords.push(4*-L.i9,0),void n.lengths.push(3)):void this._wrapVertex(n.coords,0,2,l);if("esriGeometryMultipoint"===this.geometryType){if(1===l){const h=n.coords.slice();h[0]-=512;const d=n.coords.slice();d[0]+=512,n.coords.push(...h,...d);const m=n.lengths[0];return void n.lengths.push(m,m)}this._wrapVertex(n.coords,0,2,l)}}_wrapVertex(n,l,h,d){const m=l*h,x=n[m];x<-L.i9*(d-2)?n[m]=x+L.i9*d:x>L.i9*(d-1)&&(n[m]=x-L.i9*d)}_readX(){const n=this._readGeometry();return null!=n?n.coords[0]:0}_readY(){const n=this._readGeometry();return null!=n?n.coords[1]:0}_readServerCentroid(){switch(this.geometryType){case"esriGeometryPolygon":{const n=(0,H.tO)(this._current.projectedGeometry),l=new X.Z([],n);return(0,F.Nh)(new X.Z,l,this.hasZ,this.hasM,this.geometryType,this._tile.transform)}case"esriGeometryPolyline":{const l=(0,H.a)(this._current.projectedGeometry.paths,this.hasZ),h=new X.Z([],l);return(0,F.Nh)(new X.Z,h,this.hasZ,this.hasM,this.geometryType,this._tile.transform)}}return null}_readAttribute(n,l){const h=this._current.attributes[n];if(void 0!==h)return h;const d=n.toLowerCase();for(const m in this._current.attributes)if(m.toLowerCase()===d)return this._current.attributes[m]}_readAttributes(){return this._current.attributes}}var K=f(23841),ne=f(76279),te=f(32442),se=f(93555),ie=f(37053),Me=f(93886),Re=f(25748),Ce=f(65629),Ie=f(82959),Ue=f(37118);function Se(a){if(!a)return null;const{xmin:n,ymin:l,xmax:h,ymax:d,spatialReference:m}=a;return new Ue.Z({rings:[[[n,l],[n,d],[h,d],[h,l],[n,l]]],spatialReference:m})}f(58626);class _e{static fromGraphic(n,l,h,d){return new _e(n.geometry,l,n.attributes,n.visible,n.uid,h,d)}constructor(n,l,h,d,m,x,b){this.geometry=n,this.symbol=l,this.attributes=h,this.visible=d,this.objectId=m,this.zOrder=x,this.displayId=b,this.bounds=(0,D.Ue)(),this.prevBounds=(0,D.Ue)(),this.size=[0,0,0,0]}get linearCIM(){return this.symbolResource?.symbolInfo.linearCIM}update(n,l,h){return(this.geometry!==n.geometry||this.attributes!==n.attributes||this.symbol!==l||this.zOrder!==h||this.visible!==n.visible)&&(this.prevBounds=this.bounds,this.bounds=(0,D.Ue)(),this.zOrder=h,this.geometry=n.geometry,this.attributes=n.attributes,this.symbol=l,this.visible=n.visible,this.symbolResource=null,this.projectedGeometry=null,!0)}projectAndNormalize(n){var l=this;return(0,R.Z)(function*(){let h=l.geometry;if(!h||!h.spatialReference||"mesh"===h.type)return;"extent"===h.type&&(h=Se(h)),yield(0,Ie._W)(h.spatialReference,n);const d=(0,Ce.SR)(h);if(!d)return;const m=(0,Ie.iV)(d,h.spatialReference,n);m&&(0,Re.pW)(m),l.projectedGeometry=(0,$.YX)(m)?Se(m):m})()}}class Pe{constructor(n,l,h){this.added=n,this.updated=l,this.removed=h}hasAnyUpdate(){return!!(this.added.length||this.updated.length||this.removed.length)}}function Oe(a,n){return n.zOrder-a.zOrder}class Ge{constructor(n,l,h,d,m){this._items=new Map,this._boundsDirty=!1,this._outSpatialReference=n,this._cimResourceManager=l,this._hittestDrawHelper=new Me.Tu(l),this._tileInfoView=h,this._store=m;const x=h.getClosestInfoForScale(d);this._resolution=this._tileInfoView.getTileResolution(x.level)}items(){return this._items.values()}getItem(n){return this._items.get(n)}update(n,l,h){var d=this;return(0,R.Z)(function*(){const m=[],x=[],b=[],w=new Set,M=[];let v=0;for(const I of n.items){v++;const O=I.uid,V=d._items.get(O),Q=l(I);if(w.add(O),V){V.update(I,Q,v)&&(x.push(V),M.push(d._updateItem(V,h)));continue}const J=d._store.createDisplayIdForObjectId(O),q=_e.fromGraphic(I,Q,v,J);M.push(d._updateItem(q,h)),d._items.set(q.objectId,q),m.push(q)}for(const[I,O]of d._items.entries())w.has(I)||(d._store.releaseDisplayIdForObjectId(I),d._items.delete(I),b.push(O));return yield Promise.all(M),d._index=null,new Pe(m,x,b)})()}updateLevel(n){this._resolution!==n&&(this._index=null,this._boundsDirty=!0,this._resolution=n)}hitTest(n,l,h,d,m){const x=(0,T.Z)("esri-mobile"),b=(0,T.Z)(x?"hittest-2d-mobile-tolerance":"hittest-2d-desktop-tolerance"),w=b+(x?0:(0,T.Z)("hittest-2d-small-symbol-tolerance"));n=(0,se.or)(n,this._tileInfoView.spatialReference);const M=d*window.devicePixelRatio*w,v=(0,D.Ue)();v[0]=n-M,v[1]=l-M,v[2]=n+M,v[3]=l+M;const I=d*window.devicePixelRatio*b,O=(0,D.Ue)();O[0]=n-I,O[1]=l-I,O[2]=n+I,O[3]=l+I;const V=.5*d*(w+50),Q=this._searchIndex(n-V,l-V,n+V,l+V);if(!Q||0===Q.length)return[];const J=[],q=(0,D.Ue)(),oe=(0,D.Ue)();for(const k of Q){if(!k.visible)continue;const{projectedGeometry:ve,symbolResource:ue}=k;this._getSymbolBounds(q,ue,ve,oe,m),oe[3]=oe[2]=oe[1]=oe[0]=0,(0,D.kK)(q,v)&&J.push(k)}if(0===J.length)return[];const Ae=this._hittestDrawHelper,xe=[];for(const k of J){const{projectedGeometry:ve,symbolResource:ue}=k;if(!ue)continue;const{textInfo:De,symbolInfo:je}=ue;Ae.hitTest(O,je.cimSymbol.symbol,ve,De,m,d)&&xe.push(k)}return xe.sort(Oe),xe.map(k=>k.objectId)}queryItems(n){return 0===this._items.size?[]:this._searchForItems(n)}clear(){this._items.clear(),this._index=null}_updateItem(n,l){var h=this;return(0,R.Z)(function*(){yield n.projectAndNormalize(h._outSpatialReference),yield l(n);const{size:d}=n;d[0]=d[1]=d[2]=d[3]=0,h._getSymbolBounds(n.bounds,n.symbolResource,n.projectedGeometry,n.size,0)})()}_searchIndex(n,l,h,d){return this._boundsDirty&&(this._items.forEach(m=>this._getSymbolBounds(m.bounds,m.symbolResource,m.projectedGeometry,m.size,0)),this._boundsDirty=!1),this._index||(this._index=(0,ne.r)(9,m=>({minX:m.bounds[0],minY:m.bounds[1],maxX:m.bounds[2],maxY:m.bounds[3]})),this._index.load(Array.from(this._items.values()))),this._index.search({minX:n,minY:l,maxX:h,maxY:d})}_searchForItems(n){const l=this._tileInfoView.spatialReference,h=n.bounds,d=(0,ie.C5)(l);if(d&&l.isWrappable){const[m,x]=d.valid,b=Math.abs(h[2]-x)<1e-5,w=Math.abs(h[0]-m)<1e-5;if((!b||!w)&&(b||w)){const M=n.resolution;let v;v=(0,D.Ue)(b?[m,h[1],m+50*M,h[3]]:[x-50*M,h[1],x,h[3]]);const I=this._searchIndex(h[0],h[1],h[2],h[3]),O=this._searchIndex(v[0],v[1],v[2],v[3]);return[...new Set([...I,...O])]}}return this._searchIndex(h[0],h[1],h[2],h[3])}_getSymbolBounds(n,l,h,d,m){if(!l||!l.symbolInfo.linearCIM||!h)return null;if(n||(n=(0,D.Ue)()),(0,te.$P)(n,h),!d||0===d[0]&&0===d[1]&&0===d[2]&&0===d[3]){const{textInfo:w,symbolInfo:M}=l;d||(d=[0,0,0,0]);const I=B.bP.getSymbolInflateSize(d,M.cimSymbol.symbol,this._cimResourceManager,m,w);d[0]=(0,K.F2)(I[0]),d[1]=(0,K.F2)(I[1]),d[2]=(0,K.F2)(I[2]),d[3]=(0,K.F2)(I[3])}const x=this._resolution,b=B.bP.safeSize(d);return n[0]-=b*x,n[1]-=b*x,n[2]+=b*x,n[3]+=b*x,n}}var Ze=f(74738),Ee=f(25596);class Y{static getOrCreate(n,l,h){let d=l.get(n.id);return d||(d=new Y(n,h),l.set(n.id,d)),d}static fromItems(n,l,h){const d=new Y(n,h);return d.addedOrModified.push(...l),d}constructor(n,l){this.tile=n,this.metadata=l,this.addedOrModified=[],this.removed=[]}get reader(){return this._reader||(this._reader=N.from(this.addedOrModified,this.tile,this.metadata)),this._reader}}let A=class extends((0,W.IG)(me.Z)){constructor(a){super(a),this._attached=!1,this._tiles=new Map,this._controller=new AbortController,this._hashToSymbolInfo=new Map,this._lastCleanup=performance.now(),this._cleanupRequired=!0,this.lastUpdateId=-1,this.renderer=null,this._updateTracking=new Ee.x({debugName:"GraphicsView2D"}),this.updateRequested=!1,this.defaultPointSymbolEnabled=!0,this._commandQueue=new Ze.Z({process:n=>{switch(n.type){case"processed-edit":throw new Error("InternalError: Unsupported command");case"update":return this._update()}}}),this.graphicUpdateHandler=this.graphicUpdateHandler.bind(this)}destroy(){this.container.destroy(),this.view=null,this.renderer=null,this._set("graphics",null),this._controller.abort(),this._graphicStore.clear(),this._attributeStore=null,this._hashToSymbolInfo.clear(),this._updateTracking.destroy(),this._commandQueue.destroy()}_initAttributeStore(){var l,a=this;this._storage=new P.O({spatialReference:this.view.spatialReference,fields:new ee.Z}),this._attributeStore=new U.p({isLocal:!0,update:(l=(0,R.Z)(function*(h){(0,T.Z)("esri-2d-update-debug")&&console.debug(`[Id: ${a.layerId}] GraphicsView2D.AttributeStoreView.updateStart`,{message:h});const d=a.container.attributeView.requestUpdate(h);a.container.requestRender(),yield d,(0,T.Z)("esri-2d-update-debug")&&console.debug(`[Id: ${a.layerId}] GraphicsView2D.AttributeStoreView.updateEnd`,{message:h})}),function(d){return l.apply(this,arguments)})});const n=(0,C.$F)(null,[]);this._attributeStore.update(n,this._storage,null),this.container.checkHighlight=()=>this._attributeStore.hasHighlight}initialize(){this._initAttributeStore(),this._metadata=Z.m.create(this.view.spatialReference),this._resourceProxy=new u.f({fetch:n=>Promise.all(n.map(l=>this.view.stage.textureManager.rasterizeItem(l))),fetchDictionary:n=>{throw new Error("InternalError: Graphics do not support Dictionary requests")}}),this.addHandles([(0,ye.YP)(()=>this._effectiveRenderer,()=>this._pushUpdate()),this.view.graphicsTileStore.on("update",this._onTileUpdate.bind(this)),this.container.on("attach",()=>{this.addHandles([this.graphics.on("change",()=>this._pushUpdate())]),this._graphicStore=new Ge(this.view.spatialReference,this._cimResourceManager,this.view.featuresTilingScheme,this.view.state.scale,this._attributeStore),this._attached=!0,this.requestUpdate(),this._pushUpdate()})]),this._updateTracking.addUpdateTracking("CommandQueue",this._commandQueue.updateTracking),this._onTileUpdate({added:this.view.graphicsTileStore.tiles,removed:[]})}get _effectiveRenderer(){return"function"==typeof this.renderer?this.renderer():this.renderer}get _cimResourceManager(){return this.view.stage.textureManager.resourceManager}get updating(){const a=!this._attached||this._updateTracking.updating;return(0,T.Z)("esri-2d-log-updating")&&console.log(`Updating GraphicsView2D: ${a}\n  -> attaching ${!this._attached}\n  -> updateTracking ${this._updateTracking.updating}`),a}hitTest(a){if(!this.view||this.view.suspended)return[];const{resolution:n,rotation:l}=this.view.state,h=this._graphicStore.hitTest(a.x,a.y,2,n,l),d=new Set(h),m=this.graphics.items.reduce((x,b)=>(d.has(b.uid)&&x.set(b.uid,b),x),new Map);return h.map(x=>m.get(x)).filter(pe.pC)}requestUpdate(){this.updateRequested||(this.updateRequested=!0,this.requestUpdateCallback()),this.notifyChange("updating")}processUpdate(a){this.updateRequested&&(this.updateRequested=!1,this.update(a))}viewChange(){this.requestUpdate()}setHighlight(a){const n=[];for(const{objectId:l,highlightFlags:h}of a){const d=this._graphicStore.getItem(l)?.displayId;n.push({objectId:l,highlightFlags:h,displayId:d})}this._attributeStore.setHighlight(n,a),this._pushUpdate()}graphicUpdateHandler(a){this._pushUpdate()}update(a){this.updateRequested=!1,this._attached&&this._graphicStore.updateLevel(a.state.resolution)}_pushUpdate(){(0,he.R8)(this._commandQueue.push({type:"update"}))}_update(){var a=this;return(0,R.Z)(function*(){try{(0,T.Z)("esri-2d-update-debug")&&console.debug(`[Id: ${a.layerId}] GraphicsView._update start`);const n=yield a._graphicStore.update(a.graphics,h=>a._getSymbolForGraphic(h),h=>a._ensureSymbolResource(h));if(!n.hasAnyUpdate())return void(yield a._attributeStore.sendUpdates());n.removed.length&&(a._cleanupRequired=!0),(0,T.Z)("esri-2d-update-debug")&&console.debug(`[Id: ${a.layerId}] GraphicsView updateMessage`,n);const l=a._createTileMessages(n);yield a._fetchResources(l),a._write(l);for(const h of n.added)a._setFilterState(h);for(const h of n.updated)a._setFilterState(h);(0,T.Z)("esri-2d-update-debug")&&console.debug(`[Id: ${a.layerId}] GraphicsView sendUpdate`,n),yield a._attributeStore.sendUpdates(),(0,T.Z)("esri-2d-update-debug")&&console.debug(`[Id: ${a.layerId}] GraphicsView sendUpdate.await`,n)}catch{}a._cleanupSharedResources()})()}_createTileMessages(a){const n=new Map;for(const l of a.added){const h=this.view.graphicsTileStore.getIntersectingTiles(l.bounds);for(const d of h)Y.getOrCreate(d,n,this._metadata).addedOrModified.push(l)}for(const l of a.updated){const h=this.view.graphicsTileStore.getIntersectingTiles(l.prevBounds),d=this.view.graphicsTileStore.getIntersectingTiles(l.bounds);for(const m of h)Y.getOrCreate(m,n,this._metadata).removed.push(l.displayId);for(const m of d)Y.getOrCreate(m,n,this._metadata).addedOrModified.push(l)}for(const l of a.removed){const h=this.view.graphicsTileStore.getIntersectingTiles(l.bounds);for(const d of h)Y.getOrCreate(d,n,this._metadata).removed.push(l.displayId)}return Array.from(n.values())}_fetchResources(a){var n=this;return(0,R.Z)(function*(){for(const{tile:l,reader:h}of a){(0,T.Z)("esri-2d-update-debug")&&console.debug(`Id[${n.layerId}] Tile[${l.id}] GraphicsView fetchResources`,a);const d=h.getCursor();for(;d.next();)for(const m of d.getMeshWriters())m.enqueueRequest(n._resourceProxy,d,l.createArcadeEvaluationOptions(n.view.timeZone))}yield n._resourceProxy.fetchEnqueuedResources()})()}_write(a){for(const n of a){(0,T.Z)("esri-2d-update-debug")&&console.debug(`Id[${this.layerId}] Tile[${n.tile.id}] GraphicsView write`,n);const l=this._writeMeshes(n);let h=this._tiles.get(n.tile.key);h||(h=this._createFeatureTile(n.tile.key)),(0,T.Z)("esri-2d-update-debug")&&console.debug(`Id[${this.layerId}] Tile[${n.tile.id}] GraphicsView onTileData`,n),this.container.onTileData(h,{type:"update",modify:l,remove:n.removed,end:!1,attributeEpoch:this._attributeStore.epoch}),this.container.requestRender()}}_writeMeshes(a){const n=new y._(a.tile.id),l=a.reader.getCursor();for(;l.next();){n.entityStart(l.getDisplayId(),l.getZOrder());for(const h of l.getMeshWriters())h.write(n,this._resourceProxy,l,a.tile.createArcadeEvaluationOptions(this.view.timeZone),a.tile.level);n.entityEnd()}return{...n.serialize().message,tileId:a.tile.id}}_setFilterState(a){const n=a.displayId,l=this._attributeStore.getHighlightFlags(a.objectId);this._attributeStore.setData(n,0,0,l|(a.visible?L.g3:0))}_getSymbolForGraphic(a){return null!=a.symbol?a.symbol:null!=this._effectiveRenderer?this._effectiveRenderer.getSymbol(a):this._getNullSymbol(a)}_ensureSymbolResource(a){var n=this;return(0,R.Z)(function*(){if(!a.symbol)return;const l=yield n._getSymbolInfo(a.symbol);if(!l)return;const h=l.linearCIM.filter(d=>"text"===d.type);if(h.length>0){const d=yield n._getTextResources(a,h);a.symbolResource={symbolInfo:l,textInfo:d}}else a.symbolResource={symbolInfo:l}})()}_getSymbolInfo(a){const n=a.hash();return this._hashToSymbolInfo.has(n)||this._hashToSymbolInfo.set(n,this._createSymbolInfo(n,a).catch(l=>null)),this._hashToSymbolInfo.get(n)}_createSymbolInfo(a,n){var l=this;return(0,R.Z)(function*(){const h=yield l._convertToCIMSymbol(n),d=yield l._createLinearCIM(h);if("text"===n.type)for(const m of d)"text"===m.type&&(m.lineWidth=n.lineWidth);return{hash:a,cimSymbol:h,linearCIM:d,meshWriters:yield l._createMeshWriters(h,d)}})()}_convertToCIMSymbol(a){return(0,R.Z)(function*(){const n=(0,B.rW)(a);return"web-style"===n.type?(yield n.fetchCIMSymbol()).data:n})()}_createLinearCIM(a){var n=this;return(0,R.Z)(function*(){return yield Promise.all(B.B$.fetchResources(a.symbol,n._cimResourceManager,[])),n.view.stage.cimAnalyzer.analyzeSymbolReference(a,!1)})()}_createMeshWriters(a,n){var l=this;return(0,R.Z)(function*(){(0,he.k_)(l._controller.signal);const h=l.container.instanceStore,d=yield function g(a,n,l){return _.apply(this,arguments)}(a,n,h);return Promise.all(d.map(m=>(0,S.fQ)(l._storage,l._resourceProxy,m.meshWriterName,(0,G.G)(m.id),m.options,{tileInfo:l.view.featuresTilingScheme.tileInfo},m.optionalAttributes)))})()}_onTileUpdate(a){if(a.added&&a.added.length>0)for(const n of a.added)this._updateTracking.addPromise(this._addTile(n));if(a.removed&&a.removed.length>0)for(const n of a.removed)this._removeTile(n.key)}_createFeatureTile(a){const n=this.view.featuresTilingScheme.getTileBounds((0,D.Ue)(),a),l=this.view.featuresTilingScheme.getTileResolution(a.level),h=new fe.$(a,l,n[0],n[3]);return this._tiles.set(a,h),this.container.addChild(h),h}_addTile(a){var n=this;return(0,R.Z)(function*(){if(!n._attached)return;const l=n._graphicStore.queryItems(a);if(!l.length)return;const h=n._createFeatureTile(a.key),d=Y.fromItems(a,l,n._metadata);yield n._fetchResources([d]);const m=n._writeMeshes(d);h.onMessage({type:"append",append:m,clear:!1,end:!0,attributeEpoch:n._attributeStore.epoch})})()}_removeTile(a){if(!this._tiles.has(a))return;const n=this._tiles.get(a);this.container.removeChild(n),n.destroy(),this._tiles.delete(a)}_getNullSymbol(a){const n=a.geometry;return(0,$.l9)(n)?j.mW:(0,$.oU)(n)||(0,$.YX)(n)?j.kD:this.defaultPointSymbolEnabled?j.G:null}_getTextResources(a,n){var l=this;return(0,R.Z)(function*(){const h=new Array,d=new Array;for(let w=0;w<n.length;w++){const M=n[w],{resource:v,overrides:I}=M.textRasterizationParam;if(I?.length>0){const O=de.E.resolveSymbolOverrides({type:"CIMSymbolReference",primitiveOverrides:I,symbol:{type:"CIMPointSymbol",symbolLayers:[{type:"CIMVectorMarker",enable:!0,size:v.symbol.height,anchorPointUnits:"Relative",frame:{xmin:-5,ymin:-5,xmax:5,ymax:5},markerGraphics:[{type:"CIMMarkerGraphic",geometry:{x:0,y:0},symbol:v.symbol,textString:v.textString}],scaleSymbolsProportionally:!0,respectFrame:!0}]}},a,l.view.spatialReference,null,(0,$.Ji)(a.projectedGeometry),null,null);O.then(V=>{const Q=V.symbolLayers[0],{textString:J}=Q.markerGraphics[0];d.push({type:"cim-rasterization-info",resource:{type:"text",textString:J||"",font:v.font}}),M.text=v.textString=J||""}),h.push(O)}else d.push({type:"cim-rasterization-info",resource:v})}h.length>0&&(yield Promise.all(h));const m=d.map(w=>l.view.stage.textureManager.rasterizeItem(w)),x=yield Promise.all(m);(0,ae.O3)(x);const b=new Map;for(let w=0;w<n.length;w++){const M=n[w];b.set(M.textRasterizationParam.resource.symbol,{text:M.text,glyphMosaicItems:x[w]})}return b})()}_cleanupSharedResources(){if(!this._cleanupRequired)return;const a=performance.now();if(a-this._lastCleanup<5e3)return;this._cleanupRequired=!1,this._lastCleanup=a;const n=new Set;for(const h of this._graphicStore.items()){const d=h.symbolResource?.symbolInfo.hash;n.add(d)}const l=new Set(this._hashToSymbolInfo.keys());for(const h of l.values())n.has(h)||this._hashToSymbolInfo.delete(h)}};(0,E._)([(0,z.Cb)()],A.prototype,"_effectiveRenderer",null),(0,E._)([(0,z.Cb)({constructOnly:!0})],A.prototype,"layerId",void 0),(0,E._)([(0,z.Cb)({constructOnly:!0})],A.prototype,"requestUpdateCallback",void 0),(0,E._)([(0,z.Cb)()],A.prototype,"container",void 0),(0,E._)([(0,z.Cb)({constructOnly:!0})],A.prototype,"graphics",void 0),(0,E._)([(0,z.Cb)()],A.prototype,"renderer",void 0),(0,E._)([(0,z.Cb)()],A.prototype,"_updateTracking",void 0),(0,E._)([(0,z.Cb)()],A.prototype,"updating",null),(0,E._)([(0,z.Cb)()],A.prototype,"view",void 0),(0,E._)([(0,z.Cb)()],A.prototype,"updateRequested",void 0),(0,E._)([(0,z.Cb)()],A.prototype,"defaultPointSymbolEnabled",void 0),A=(0,E._)([(0,le.j)("esri.views.2d.layers.support.GraphicsView2D")],A);const ze=A}}]);