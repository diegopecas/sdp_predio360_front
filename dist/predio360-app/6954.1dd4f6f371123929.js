"use strict";(self.webpackChunkpredio360_app=self.webpackChunkpredio360_app||[]).push([[6954],{66954:(Yt,$,c)=>{c.r($),c.d($,{uploadAssets:()=>wt});var u=c(15861),m=c(84792),G=c(8314),ot=c(63290),f=c(10699),x=c(27422),d=c(21726),at=c(35948),v=c(96603),h=c(68301);const j={upload:{createFromFiles:.8,loadMesh:.2},uploadAssetBlobs:{prepareAssetItems:.9,uploadAssetItems:.1},uploadConvertibleSource:{uploadEditSource:.5,serviceAssetsToGlb:.5},uploadLocalMesh:{meshToAssetBlob:.5,uploadAssetBlobs:.5}};var it=c(38305),ut=c(54024),lt=c(88159);function _(s,e=(n=>{}),t){return new pt(s,e,t)}class pt{constructor(e,t=(r=>{}),n){if(this.onProgress=t,this.taskName=n,this._progressMap=new Map,this._startTime=void 0,this._timingsMap=new Map,"number"==typeof e){this._weights={};for(let r=0;r<e;r++){const o=r;this._weights[o]=1/e,this._progressMap.set(o,0)}}else this._weights=e;this.emitProgress()}emitProgress(){let e=0;for(const[t,n]of this._progressMap.entries())e+=n*this._weights[t];if(1===e&&(0,G.Z)("enable-feature:esri-3dofl-upload-timings")){const t=Math.round(performance.now()-(this._startTime??0))/1e3;console.log(`${this.taskName} done in ${t} sec`);for(const[n,r]of this._timingsMap){const o=Math.round(r.end-r.start)/1e3,a=Math.round(o/t*100);console.log(this.taskName??"Task",{stepKey:n,stepTime:o,relativeTime:a})}}this.onProgress(e)}setProgress(e,t){if(this._progressMap.set(e,t),(0,G.Z)("enable-feature:esri-3dofl-upload-timings")){const n=performance.now();this._startTime??=n;const r=(0,lt.s1)(this._timingsMap,e,()=>({start:n,end:0}));1===t&&(r.end=n)}this.emitProgress()}simulate(e,t){return J(n=>this.setProgress(e,n),t)}makeOnProgress(e){return t=>this.setProgress(e,t)}}function J(s=(t=>{}),e=gt){const t=performance.now();s(0);const n=setInterval(()=>{const r=performance.now()-t,o=1-Math.exp(-r/e);s(o)},ht);return(0,ut.kB)(()=>{clearInterval(n),s(1)})}function ct(s,e=mt){return(0,x.up)((0,x._H)(s*W/e))}const mt=10,dt=10,W=8e-6,ht=(0,x.HA)(50),gt=(0,x.HA)(1e3),K=1e6,V=20*K,yt=2e9,xt=3;function F(){return F=(0,u.Z)(function*({data:s,name:e,description:t},n,r){let o=null;try{const a=(0,d.v_)(n,"uploads"),i=(0,d.v_)(a,"info"),{data:l}=yield(0,m.Z)(i,{query:{f:"json"},responseType:"json"});(0,f.k_)(r);const p=(0,it.M8)(n),g=l.maxUploadFileSize*K,T=p?yt:g,H=p?Math.min(V,g):V;if(s.size>T)throw new Error("Data too large");const zt=(0,d.v_)(a,"register"),{data:tt}=yield(0,m.Z)(zt,{query:{f:"json",itemName:_t(e),description:t},responseType:"json",method:"post"});if((0,f.k_)(r),!tt.success)throw new Error("Registration failed");const{itemID:Ht}=tt.item;o=(0,d.v_)(a,Ht);const $t=(0,d.v_)(o,"uploadPart"),et=Math.ceil(s.size/H),A=new Array;for(let y=0;y<et;++y)A.push(s.slice(y*H,Math.min((y+1)*H,s.size)));const Z=A.slice().reverse(),st=new Array,Gt=_(et,r?.onProgress,"uploadItem"),Jt=function(){var y=(0,u.Z)(function*(){for(;0!==Z.length;){const w=A.length-Z.length,rt=Z.pop(),M=new FormData,Kt=Gt.simulate(w,ct(rt.size));try{M.append("f","json"),M.append("file",rt),M.append("partId",`${w}`);const{data:Vt}=yield(0,m.Z)($t,{timeout:0,body:M,responseType:"json",method:"post"});if((0,f.k_)(r),!Vt.success)throw new Error("Part upload failed")}finally{Kt.remove()}}});return function(){return y.apply(this,arguments)}}();for(let y=0;y<xt&&0!==Z.length;++y)st.push(Jt());yield Promise.all(st);const Wt=(0,d.v_)(o,"commit"),{data:nt}=yield(0,m.Z)(Wt,{query:{f:"json",parts:A.map((y,w)=>w).join(",")},responseType:"json",method:"post"});if((0,f.k_)(r),!nt.success)throw new Error("Commit failed");return nt.item}catch(a){if(null!=o){const i=(0,d.v_)(o,"delete");yield(0,m.Z)(i,{query:{f:"json"},responseType:"json",method:"post"})}throw a}}),F.apply(this,arguments)}function _t(s){return s.replaceAll("/","_").replaceAll("\\","_")}var P=c(35391);function wt(s,e,t){return k.apply(this,arguments)}function k(){return k=(0,u.Z)(function*(s,e,t){const n=s.length;if(!n)return t?.onProgress?.(1),[];const r=_(n,t?.onProgress,"uploadAssets");return Promise.all(s.map((o,a)=>function Pt(s,e,t){return b.apply(this,arguments)}(o,e,{...t,onProgress:r.makeOnProgress(a)})))}),k.apply(this,arguments)}function b(){return b=(0,u.Z)(function*(s,{layer:e,ongoingUploads:t},n){const r=t.get(s);if(r)return r;if(!function Dt(s){return!!s.infoFor3D&&!!s.url}(e))throw new h.sc;if(function Tt(s,e){const{parsedUrl:t}=e;return null!=t&&s.metadata.externalSources.some(n=>(0,v.JG)(n,t))}(s,e))return n?.onProgress?.(1),s;const o=function At(s,e,t){return E.apply(this,arguments)}(s,e,n);t.set(s,o);try{yield o}finally{t.delete(s)}return s}),b.apply(this,arguments)}function E(){return E=(0,u.Z)(function*(s,e,t){const{metadata:n}=s,{displaySource:r}=n,o=Y(r?.source,e),i=n.externalSources.length>0,l=o?function Zt(s,e,t){return U.apply(this,arguments)}(o,e,t):i?function Mt(s,e,t){return S.apply(this,arguments)}(s,e,t):function jt(s,e,t){return I.apply(this,arguments)}(s,e,t),p=yield l;return(0,f.k_)(t),s.addExternalSources([p]),s}),E.apply(this,arguments)}function U(){return(U=(0,u.Z)(function*(s,e,t){return{source:yield Q(s,e,t),original:!0}})).apply(this,arguments)}function S(){return(S=(0,u.Z)(function*(s,e,t){const n=q(e),{externalSources:r}=s.metadata,o=function kt(s,e){for(const t of s){const n=Y(t.source,e);if(n)return n}return null}(r,e);if(!o)throw new h.kE;const a=_(j.uploadConvertibleSource,t?.onProgress,"uploadConvertibleSource"),i=yield Q(o,e,{onProgress:a.makeOnProgress("uploadEditSource")});s.addExternalSources([{source:i,original:!0}]);const l=o.reduce((g,{asset:T})=>T instanceof File?g+T.size:g,0),p=a.simulate("serviceAssetsToGlb",function ft(s,e=dt){return(0,x.up)((0,x._H)(s*W/e))}(l));try{return{source:yield Nt(i,e,n)}}finally{p.remove()}})).apply(this,arguments)}function I(){return I=(0,u.Z)(function*(s,e,t){const n=_(j.uploadLocalMesh,t?.onProgress,"uploadLocalMesh"),r=function Ft(s,e,t){return C.apply(this,arguments)}(s,e,{...t,onProgress:n.makeOnProgress("meshToAssetBlob")});return{source:yield X([r],e,{...t,onProgress:n.makeOnProgress("uploadAssetBlobs")}),extent:s.extent.clone(),original:!0}}),I.apply(this,arguments)}function C(){return(C=(0,u.Z)(function*(s,e,t){const n=q(e),r=yield s.load(t),o=yield r.toBinaryGLTF({ignoreLocalTransform:!0});(0,f.k_)(t);const a=yield o.buffer();return(0,f.k_)(t),{blob:new Blob([a.data],{type:a.type}),assetName:`${(0,at.zS)()}.glb`,assetType:n}})).apply(this,arguments)}function Y(s,e){if(!s)return null;const{infoFor3D:{supportedFormats:t,editFormats:n}}=e,r=(0,v.zE)(s),o=new Array;let a=!1;for(let i=0;i<r.length;++i){const l=bt(r[i],t);if(!l)return null;n.includes(l.assetType)&&(a=!0),o.push(l)}return a?o:null}function bt(s,e){const t=(0,v.vj)(s,e);return t?{asset:s,assetType:t}:null}function Q(s,e,t){return N.apply(this,arguments)}function N(){return N=(0,u.Z)(function*(s,e,t){return X(s.map(n=>function Et(s,e){return B.apply(this,arguments)}(n,t)),e,t)}),N.apply(this,arguments)}function X(s,e,t){return O.apply(this,arguments)}function O(){return O=(0,u.Z)(function*(s,e,t){const n=_(j.uploadAssetBlobs,t?.onProgress,"uploadAssetBlobs"),r=yield function St(s,e,t){const n=_(s.length,t?.onProgress,"prepareAssetItems");return Promise.all(s.map(function(){var r=(0,u.Z)(function*(o,a){const i=function Ut(s,e,t){return D.apply(this,arguments)}(yield o,e,{...t,onProgress:n.makeOnProgress(a)});return(0,f.k_)(t),i});return function(o,a){return r.apply(this,arguments)}}()))}(s,e,{...t,onProgress:n.makeOnProgress("prepareAssetItems")});(0,f.k_)(t);const o=r.map(({item:i})=>i),{uploadResults:a}=yield function It(s,e,t){return L.apply(this,arguments)}(o,e,{...t,onProgress:n.makeOnProgress("uploadAssetItems")});return(0,f.k_)(t),s.map((i,l)=>function Ct(s,e,t){const{success:n}=e;if(!n){const{error:p}=e;throw new h.fB(s.assetName,p)}const{assetHash:r}=e,{assetName:o,item:{assetType:a}}=s,{infoFor3D:{supportedFormats:i}}=t,l=(0,P.d1)(a,i);if(!l)throw new h.jO(a);return new v.CP(o,l,[new v.LL(`${t.parsedUrl.path}/assets/${r}`,r)])}(r[l],a[l],e))}),O.apply(this,arguments)}function B(){return(B=(0,u.Z)(function*(s,e){const{asset:t,assetType:n}=s;if(t instanceof File)return{blob:t,assetName:t.name,assetType:n};const r=yield t.toBlob(e);return(0,f.k_)(e),{blob:r,assetName:t.assetName,assetType:n}})).apply(this,arguments)}function D(){return D=(0,u.Z)(function*(s,e,t){const{blob:n,assetType:r,assetName:o}=s;let a=null;try{const i=yield function vt(s,e,t){return F.apply(this,arguments)}({data:n,name:o},e.url,t);(0,f.k_)(t),a={assetType:r,assetUploadId:i.itemID}}catch(i){(0,f.r9)(i),function Lt(){return ot.Z.getLogger("esri.layers.graphics.sources.support.uploadAssets")}().warnOnce(`Service ${e.url} does not support the REST Uploads API.`)}if(!a){const i=yield(0,d.IR)(n);if((0,f.k_)(t),!i.isBase64)throw new h.AC;a={assetType:r,assetData:i.data}}if(!a)throw new h._C;return{item:a,assetName:o}}),D.apply(this,arguments)}function L(){return(L=(0,u.Z)(function*(s,e,t){const n=J(t?.onProgress);try{const r=yield(0,m.Z)((0,d.v_)(e.parsedUrl.path,"uploadAssets"),{timeout:0,query:{f:"json",assets:JSON.stringify(s)},method:"post",responseType:"json"});if((0,f.k_)(t),r.data.uploadResults.length!==s.length)throw new h.Fz(s.length,r.data.uploadResults.length);return r.data}finally{n.remove()}})).apply(this,arguments)}function Nt(s,e,t){return R.apply(this,arguments)}function R(){return(R=(0,u.Z)(function*(s,e,t){const n=s.map(({assetName:p,parts:g})=>({assetName:p,assetHash:g[0].partHash})),r=e.capabilities?.operations.supportsAsyncConvert3D,o={f:"json",assets:JSON.stringify(n),transportType:"esriTransportTypeUrl",targetFormat:t,async:r},a=(0,d.v_)(e.parsedUrl.path,"convert3D");let i;try{i=(yield(r?Bt:Ot)(a,{query:o,responseType:"json",timeout:0})).data}catch{throw new h.s8}const{supportedFormats:l}=e.infoFor3D;return i.assets.map(p=>{const g=(0,P.S0)(p.contentType,l);if(!g)throw new h.jO(g);return new v.CP(p.assetName,p.contentType,[new v.LL(p.assetURL,p.assetHash)])})})).apply(this,arguments)}function Ot(s,e){return(0,m.Z)(s,e)}function Bt(s,e){return z.apply(this,arguments)}function z(){return(z=(0,u.Z)(function*(s,e){const t=(yield(0,m.Z)(s,e)).data.statusUrl;for(;;){const n=(yield(0,m.Z)(t,{query:{f:"json"},responseType:"json"})).data;switch(n.status){case"Completed":return(0,m.Z)(n.resultUrl,{query:{f:"json"},responseType:"json"});case"CompletedWithErrors":throw new Error(n.status);case"Failed ImportChanges":case"InProgress":case"Pending":case"ExportAttachments":case"ExportChanges":case"ExportingData":case"ExportingSnapshot":case"ImportAttachments":case"ProvisioningReplica":case"UnRegisteringReplica":break;default:throw new Error}yield(0,f.e4)(Rt)}})).apply(this,arguments)}function q(s){const{infoFor3D:e}=s,t=(0,P.S0)("model/gltf-binary",e.supportedFormats)??(0,P.Ow)("glb",e.supportedFormats);if(!t)throw new h.ks;return t}const Rt=(0,x.HA)(1e3)}}]);