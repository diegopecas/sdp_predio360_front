"use strict";(self.webpackChunkpredio360_app=self.webpackChunkpredio360_app||[]).push([[4309],{128:(_t,tt,d)=>{d.d(tt,{B:()=>m});var o=d(15861),E=d(22558),Y=d(21726),rt=d(35948),s=d(34117),a=d(31283),yt=d(77712),Q=d(61556),_=d(29840);function m(g){const u=g?.origins??[void 0];return(T,w)=>{const I=function Ot(g,u,T){if("resource"===g?.type)return function v(g,u,T){const w=(0,s.Oe)(u,T);return{type:String,read:(I,L,V)=>{const b=(0,_.r)(I,L,V);return w.type===String?b:"function"==typeof w.type?new w.type({url:b}):void 0},write:{writer(I,L,V,b){if(!b||!b.resources)return"string"==typeof I?void(L[V]=(0,_.t)(I,b)):void(L[V]=I.write({},b));const H=function vt(g){return null==g?null:"string"==typeof g?g:g.url}(I),x=(0,_.t)(H,{...b,verifyItemRelativeUrls:b&&b.verifyItemRelativeUrls?{writtenUrls:b.verifyItemRelativeUrls.writtenUrls,rootPath:void 0}:void 0},_.M.NO),k=w.type!==String&&(!(0,E.l)(this)||b&&b.origin&&this.originIdOf(T)>(0,a.M9)(b.origin)),K={object:this,propertyName:T,value:I,targetUrl:x,dest:L,targetPropertyName:V,context:b,params:g};b&&b.portalItem&&x&&!(0,Y.YP)(x)?k?function Tt(g){const{context:u,targetUrl:T,params:w,value:I,dest:L,targetPropertyName:V}=g;if(!u.portalItem)return;const b=u.portalItem.resourceFromPath(T),H=Ct(I,T,u),x=(0,Q.B)(H),k=(0,Y.Ml)(b.path),K=w?.compress??!1;x===k?(u.resources&&at({...g,resource:b,content:H,compress:K,updates:u.resources.toUpdate}),L[V]=T):j(g)}(K):function Vt({context:g,targetUrl:u,dest:T,targetPropertyName:w}){g.portalItem&&g.resources&&(g.resources.toKeep.push({resource:g.portalItem.resourceFromPath(u),compress:!1}),T[w]=u)}(K):b&&b.portalItem&&(null==x||null!=(0,_.i)(x)||(0,Y.jc)(x)||k)?j(K):L[V]=x}}}}(g,u,T);switch(g?.type??"other"){case"other":return{read:!0,write:!0};case"url":{const{read:w,write:I}=_.a;return{read:w,write:I}}}}(g,T,w);for(const L of u){const V=(0,yt.CJ)(T,L,w);for(const b in I)V[b]=I[b]}}}function j(g){const{targetUrl:u,params:T,value:w,context:I,dest:L,targetPropertyName:V}=g;if(!I.portalItem)return;const b=(0,_.p)(u),H=b?.filename??(0,rt.D)(),x=T?.prefix??b?.prefix,k=Ct(w,u,I),K=(0,Y.v_)(x,H),lt=`${K}.${(0,Q.B)(k)}`,it=I.portalItem.resourceFromPath(lt);(0,Y.jc)(u)&&I.resources&&I.resources.pendingOperations.push(function et(g){return N.apply(this,arguments)}(u).then(Pt=>{it.path=`${K}.${(0,Q.B)(Pt)}`,L[V]=it.itemRelativeUrl}).catch(()=>{}));const z=T?.compress??!1;I.resources&&at({...g,resource:it,content:k,compress:z,updates:I.resources.toAdd}),L[V]=it.itemRelativeUrl}function at({object:g,propertyName:u,updates:T,resource:w,content:I,compress:L}){T.push({resource:w,content:I,compress:L,finish:V=>{!function It(g,u,T){"string"==typeof g[u]?g[u]=T.url:g[u].url=T.url}(g,u,V)}})}function Ct(g,u,T){return"string"==typeof g?{url:u}:new Blob([JSON.stringify(g.toJSON(T))],{type:"application/json"})}function N(){return(N=(0,o.Z)(function*(g){const u=(yield Promise.resolve().then(d.bind(d,84792))).default,{data:T}=yield u(g,{responseType:"blob"});return T})).apply(this,arguments)}},22558:(_t,tt,d)=>{function o(E){return E&&"getAtOrigin"in E&&"originOf"in E}d.d(tt,{l:()=>o})},61556:(_t,tt,d)=>{d.d(tt,{B:()=>E});var o=d(21726);function E(_){return s[function Y(_){return _ instanceof Blob?_.type:function rt(_){const m=(0,o.Ml)(_);return Q[m]||a}(_.url)}(_)]||yt}const s={},a="text/plain",yt=s[a],Q={png:"image/png",jpeg:"image/jpeg",jpg:"image/jpg",bmp:"image/bmp",gif:"image/gif",json:"application/json",txt:"text/plain",xml:"application/xml",svg:"image/svg+xml",zip:"application/zip",pbf:"application/vnd.mapbox-vector-tile",gz:"application/gzip","bin.gz":"application/octet-stream"};for(const _ in Q)s[Q[_]]=_},72816:(_t,tt,d)=>{d.r(tt),d.d(tt,{default:()=>ye});var o=d(17626),E=d(14517),Y=d(46160),rt=d(61885),s=d(62208),a=d(77712),Q=(d(90912),d(85931)),_=d(76898),m=d(28093),Ot=d(1437),v=d(91558);let j=class extends E.Z{constructor(t){super(t),this.innerWidth=2,this.outerWidth=8,this.visibleInnerColor=new v.Z([3,252,111,1]),this.visibleOuterColor=new v.Z([3,252,111,.15]),this.occludedInnerColor=new v.Z([252,3,69,1]),this.occludedOuterColor=new v.Z([252,3,69,.1]),this.undefinedInnerColor=new v.Z([255,255,255,1]),this.undefinedOuterColor=new v.Z([127,127,127,.2])}};(0,o._)([(0,a.Cb)({type:Number})],j.prototype,"innerWidth",void 0),(0,o._)([(0,a.Cb)({type:Number})],j.prototype,"outerWidth",void 0),(0,o._)([(0,a.Cb)({type:v.Z})],j.prototype,"visibleInnerColor",void 0),(0,o._)([(0,a.Cb)({type:v.Z})],j.prototype,"visibleOuterColor",void 0),(0,o._)([(0,a.Cb)({type:v.Z})],j.prototype,"occludedInnerColor",void 0),(0,o._)([(0,a.Cb)({type:v.Z})],j.prototype,"occludedOuterColor",void 0),(0,o._)([(0,a.Cb)({type:v.Z})],j.prototype,"undefinedInnerColor",void 0),(0,o._)([(0,a.Cb)({type:v.Z})],j.prototype,"undefinedOuterColor",void 0),j=(0,o._)([(0,_.j)("esri.views.3d.analysis.LineOfSight.LineOfSightConfiguration")],j);var Tt=d(15861),at=(d(29132),d(8425)),Ct=d(59213),et=d(72392),N=d(54024),vt=d(63290),It=d(10699),g=d(32917),u=d(84161),T=d(17760),w=d(55915),I=d(65401),L=d(70562),V=d(60507);let b=class extends E.Z{constructor(t){super(t),this.target=null,this.intersectedGraphic=null,this.intersectedLocation=null,this.elevationAlignedTargetLocation=null,this.visible=void 0}};(0,o._)([(0,a.Cb)()],b.prototype,"target",void 0),(0,o._)([(0,a.Cb)()],b.prototype,"intersectedGraphic",void 0),(0,o._)([(0,a.Cb)()],b.prototype,"intersectedLocation",void 0),(0,o._)([(0,a.Cb)()],b.prototype,"elevationAlignedTargetLocation",void 0),(0,o._)([(0,a.Cb)({type:Boolean})],b.prototype,"visible",void 0),b=(0,o._)([(0,_.j)("esri.views.3d.analysis.LineOfSightAnalysisResult")],b);let H=class extends E.Z{constructor(t){super(t),this.elevationAlignedTargetLocation=null,this.inputPoints={isValid:!1,observer:(0,m.c)(),observerSurfaceNormal:null,observerFeatureId:null,target:(0,m.c)(),targetSurfaceNormal:null,targetFeatureId:null,observerAdjusted:(0,m.c)(),targetAdjusted:(0,m.c)()},this.computationResult={start:(0,m.c)(),end:(0,m.c)(),intersection:(0,m.c)(),isValid:!1,isTargetVisible:!1},this.result=null}notifyResultChanged(){this.notifyChange("computationResult")}notifyInputPointsChanged(){this.notifyChange("inputPoints")}};(0,o._)([(0,a.Cb)()],H.prototype,"target",void 0),(0,o._)([(0,a.Cb)()],H.prototype,"elevationAlignedTargetLocation",void 0),(0,o._)([(0,a.Cb)()],H.prototype,"inputPoints",void 0),(0,o._)([(0,a.Cb)()],H.prototype,"computationResult",void 0),(0,o._)([(0,a.Cb)()],H.prototype,"result",void 0),H=(0,o._)([(0,_.j)("esri.views.3d.analysis.LineOfSight.LineOfSightComputation")],H);var it,x=d(23841),k=d(26242),K=d(38114),lt=d(58817);let z=it=class extends E.Z{constructor(t){super(t)}clone(){return new it({type:this.type,id:(0,lt.d9)(this.id),mapPoint:(0,lt.d9)(this.mapPoint),renderPoint:(0,m.a)(this.renderPoint),normal:(0,lt.d9)(this.normal),ray:(0,lt.d9)(this.ray),graphic:this.graphic})}equals(t){return this.type===t.type&&this.id===t.id&&(0,s._W)(this.mapPoint,t.mapPoint)&&(0,u.F)(this.renderPoint,t.renderPoint)&&(0,Q.fS)(this.normal,t.normal)&&(0,L.fS)(this.ray,t.ray)&&this.graphic===t.graphic}};(0,o._)([(0,a.Cb)()],z.prototype,"type",void 0),(0,o._)([(0,a.Cb)({constructOnly:!0})],z.prototype,"id",void 0),(0,o._)([(0,a.Cb)({constructOnly:!0})],z.prototype,"mapPoint",void 0),(0,o._)([(0,a.Cb)({constructOnly:!0})],z.prototype,"renderPoint",void 0),(0,o._)([(0,a.Cb)({constructOnly:!0})],z.prototype,"normal",void 0),(0,o._)([(0,a.Cb)({constructOnly:!0})],z.prototype,"graphic",void 0),(0,o._)([(0,a.Cb)({constructOnly:!0})],z.prototype,"ray",void 0),z=it=(0,o._)([(0,_.j)("esri.views.3d.analysis.LineOfSight.LineOfSightIntersectionResult")],z);var Pt=d(77926),Nt=d(26046),Kt=d(90793),Jt=d(62483),J=d(67857),dt=d(93867);let ut=class extends E.Z{constructor(t){super(t),this._terrainIntersectionOptionsLayerUids=new Set(["terrain"])}initialize(){this.intersector=(0,Jt.Z8)(this.view.state.viewingMode),this.intersector.options.hud=!1,this.intersector.options.store=J.eC.MIN}getScreenPointIntersection(t){const i=(0,x.md)(t,k.qW.get()),n=(0,Nt.u4)(this.view.state.camera,i,St);return this._getRayIntersection(n)}_getRayIntersection(t,i){if((0,s.Wi)(t)||(0,s.Wi)(this.view.sceneIntersectionHelper))return null;this.intersector.options.store=J.eC.MIN,this.view.sceneIntersectionHelper.intersectToolIntersectorRay(t,this.intersector,i);const n=this.intersector.results.min,l=(0,m.c)();if(!n.getIntersectionPoint(l))return null;const c=this.view.renderCoordsHelper.fromRenderCoords(l,this.view.spatialReference),h=(0,m.a)(n.normal);if((0,Pt.GS)(n))return new z({type:J.q7.OBJECT,id:`${n.target.layerUid}/${n.target.nodeIndex}/${n.target.componentIndex}`,mapPoint:c,renderPoint:l,normal:h,ray:(0,L.JG)(t),graphic:null});if((0,Kt.TX)(n))return new z({type:J.q7.TERRAIN,id:n.target.lij.slice(),mapPoint:c,renderPoint:l,normal:h,ray:(0,L.JG)(t),graphic:null});const p=(0,dt.tB)(n,this.view);if((0,s.pC)(p)){const O=p.layer,f=p.sourceLayer;let C;return C=f&&"scene"===f.type?(0,K.MS)(p,f.objectIdField):p.uid,new z({type:J.q7.OBJECT,id:`${O?.uid}/${C}`,mapPoint:c,renderPoint:l,normal:h,ray:(0,L.JG)(t),graphic:p})}return null}updateFromGroundIntersection(t,i,n){const l=$t,c=Xt,h=Yt,p=Qt;(0,u.c)(c,t),this.view.renderCoordsHelper.worldUpAtPosition(c,h),(0,u.n)(h,h);const O=this.view.basemapTerrain.visibleElevationBounds,f=O?Math.abs(O.max-O.min):100,C=i>=0?1:-1;(0,u.g)(p,h,C*(f+Math.abs(i))),(0,u.a)(l,c,p),(0,L.zk)(l,c,St);const y=this._getRayIntersection(St,{include:this._terrainIntersectionOptionsLayerUids});return(0,s.pC)(y)?((0,u.g)(p,h,C*i),(0,u.a)(n,y.renderPoint,p),(0,m.a)(y.normal)):((0,u.c)(n,t),null)}};(0,o._)([(0,a.Cb)()],ut.prototype,"view",void 0),(0,o._)([(0,a.Cb)()],ut.prototype,"intersector",void 0),ut=(0,o._)([(0,_.j)("esri.views.3d.analysis.LineOfSight.LineOfSightRayIntersector")],ut);const $t=(0,m.c)(),Xt=(0,m.c)(),Yt=(0,m.c)(),Qt=(0,m.c)(),St=(0,L.Ue)();var Rt=d(54865),ct=d(87091),kt=d(72642);const At="esri.views.3d.analysis.LineOfSight.LineOfSightController",Mt=vt.Z.getLogger(At);let A=class extends(rt.Z.EventedMixin(E.Z)){constructor(t){super(t),this.updateOnCameraChange=!0,this._observerGroundOffsetRenderSpace=0,this._effectiveObserverElevationMode="absolute-height",this._observerFeatureId=null,this._updatingHandles=new T.t,this._frameTask=ct.sq,this._handles=new et.Z,this._computationHandles=new et.Z,this._externalObserverUpdate=!0}initialize(){const t=this.view.resourceController?.scheduler;this._frameTask=t?t.registerTask(ct.T8.LINE_OF_SIGHT_TOOL):ct.sq,this._intersector=new ut({view:this.view}),this._handles.add([this._connectObserver(),this._connectComputations(),this._connectTargets()])}destroy(){this._handles.destroy(),this._computationHandles.destroy(),this._computations.removeAll(),this._updatingHandles.destroy()}get updating(){return this._frameTask.updating||this._updatingHandles.updating}get priority(){return this._frameTask.priority}set priority(t){this._frameTask.priority=t}get _computations(){return this.analysisViewData.computations}get _elevationAlignedObserverPositionRenderSpace(){return this.analysisViewData.observerEngineLocation}set _elevationAlignedObserverPositionRenderSpace(t){this.analysisViewData.observerEngineLocation=t}get _screenPixelSize(){return this.view.state.camera.computeScreenPixelSizeAt(this._elevationAlignedObserverPositionRenderSpace)}_computeResult(t){const i=t.computation,{inputPoints:n,computationResult:l}=i,{observerAdjusted:c,targetAdjusted:h}=n,{start:p,end:O}=l;(0,u.c)(p,c),(0,u.c)(O,h),this._canCompute(i)?this._computeIntersection(t):this._interpolateIntersection(t),i.notifyResultChanged(),this.emit("result-changed",{target:t.computation.target,result:i.result})}_updateAdjustedPointsFromFeatures(t){const i=this.view,{sceneIntersectionHelper:n}=i,{inputPoints:l}=t,{observerAdjusted:c,observerFeatureId:h,targetFeatureId:p,targetAdjusted:O}=l;if((0,s.Wi)(h)&&(0,s.Wi)(p))return;const f=(0,u.i)(c,O),C=this._intersector.intersector,y=(0,L.zk)(l.observer,l.target,Dt);C.options.store=J.eC.ALL,n.intersectToolIntersectorRay(y,C);let S=null,P=null,Z=null,W=null;for(const U of C.results.all){const R=(0,dt.tB)(U,this.view);if((0,s.Wi)(R)||(0,s.Wi)(U.distanceInRenderSpace))continue;const G=(0,at.pD)(R);(0,s.Wi)(G)||((0,s.pC)(h)&&G===h&&((0,s.Wi)(S)&&(S=this._getFeatureDistanceThreshold(U,i,f)),U.distanceInRenderSpace<S&&(Z=U)),(0,s.pC)(p)&&G===p&&((0,s.Wi)(P)&&(P=this._getFeatureDistanceThreshold(U,i,f)),(0,s.Wi)(W)&&U.distanceInRenderSpace<f&&f-U.distanceInRenderSpace<P&&(W=U)))}(0,s.pC)(Z)&&Z.getIntersectionPoint(c)&&(l.observerSurfaceNormal=Z.getTransformedNormal((0,m.c)())),(0,s.pC)(W)&&W.getIntersectionPoint(O)&&(l.targetSurfaceNormal=W.getTransformedNormal((0,m.c)()))}_getFeatureDistanceThreshold(t,i,n){if((0,dt._s)(t)){const l=(0,dt.VB)(t,i);if((0,s.pC)(l))return Math.min(l*te,n)}return 1e-5*n}_adjustStartEndPositions(t){const i=this._screenPixelSize,n=this.view,{inputPoints:l}=t,{observer:c,observerSurfaceNormal:h,target:p,targetSurfaceNormal:O,observerAdjusted:f,targetAdjusted:C}=l,y=mt;(0,u.c)(f,c),(0,u.c)(C,p),this._updateAdjustedPointsFromFeatures(t),(0,s.pC)(h)?(0,u.c)(y,h):(0,u.b)(y,C,f);const S=i;(0,u.n)(y,y),(0,u.g)(y,y,Math.min(S,1)),(0,u.a)(f,f,y),(0,s.pC)(O)?(0,u.c)(y,O):(0,u.b)(y,f,C);const P=n.state.camera.computeScreenPixelSizeAt(C);(0,u.n)(y,y),(0,u.g)(y,y,Math.min(P,1)),(0,u.a)(C,C,y)}_computeIntersection({computation:t,interpolationInfo:i}){const{view:n}=this,{sceneIntersectionHelper:l,renderCoordsHelper:c}=n;if((0,s.Wi)(l))return;const h=this._intersector.intersector,{computationResult:p,inputPoints:O}=t,{observer:f,target:C}=O,{start:y,end:S}=p,P=(0,L.zk)(y,S,Dt);h.options.store=J.eC.MIN,l.intersectToolIntersectorRay(P,h);const Z=h.results.min,W=p.intersection,U=mt;let R=!0;if((0,s.pC)(Z)&&Z.getIntersectionPoint(W)){(0,u.c)(i.originalIntersection,W),(0,u.c)(i.originalObserver,y),(0,u.c)(i.originalTarget,S),c.fromRenderCoords(W,U,n.spatialReference);const F=1-(0,u.j)(S,C)/(0,u.j)(y,C);R=(0,u.j)(f,W)>=F*(0,u.j)(f,C)}const G=new kt.Z(U,n.spatialReference);{const{result:F,target:q}=t;(0,s.pC)(F)?(F.target=q,F.intersectedGraphic=R?null:(0,dt.tB)(Z,n),F.intersectedLocation=R?null:G,F.visible=R):t.result=new b({target:q,elevationAlignedTargetLocation:t.elevationAlignedTargetLocation,intersectedGraphic:R?null:(0,dt.tB)(Z,n),intersectedLocation:R?null:G,visible:R})}p.isValid=O.isValid=!0,p.isTargetVisible=R}_interpolateIntersection({computation:t,interpolationInfo:i}){const{computationResult:n,inputPoints:l}=t,{start:c,end:h,intersection:p}=n,{originalIntersection:O,originalObserver:f,originalTarget:C}=i;if((0,u.c)(p,O),l.isValid){const y=mt,S=(0,u.j)(f,O)/(0,u.j)(f,C);(0,u.w)(y,c,f),(0,u.g)(y,y,1-S),(0,u.a)(p,p,y),(0,u.w)(y,h,C),(0,u.g)(y,y,S),(0,u.a)(p,p,y),n.isValid=!0}else t.result=null,n.isValid=!1,n.isTargetVisible=!1}_canCompute(t){const n=this.view.frustum;if((0,s.Wi)(this.analysisViewData.elevationAlignedObserver)||(0,s.Wi)(t.elevationAlignedTargetLocation)||(0,s.Wi)(n))return!1;const{observerAdjusted:l,targetAdjusted:c}=t.inputPoints,h=n.intersectsPoint(l),p=n.intersectsPoint(c);return h&&p}_onObserverPositionChange(t,i,n,l,c){if(this._externalObserverUpdate=c,(0,s.Wi)(t))return this.analysisViewData.elevationAlignedObserver=null,void(this._observerFeatureId=null);if((0,s.Wi)(i))return(0,Rt.e)(this.analysis,t.spatialReference,Mt),void(this.analysisViewData.elevationAlignedObserver=null);const h=this._getEffectiveElevationInfo(i,n),{absoluteZ:p,elevation:O}=(0,V.tq)(i.x,i.y,i.z,this.view.spatialReference,this.view,h),f=i.clone();f.z=p,this._effectiveObserverElevationMode=h.mode,this.analysisViewData.elevationAlignedObserver=f;const C=(0,m.c)();this.view.renderCoordsHelper.toRenderCoords(f,C),this._elevationAlignedObserverPositionRenderSpace=C,this._observerGroundOffsetRenderSpace=p-O,this._observerFeatureId=(0,at.pD)(l),this.priority=ct.T8.LINE_OF_SIGHT_TOOL_INTERACTIVE}_onObserverRenderSpacePositionChangeForComputation(t,i,n,l,c){const{inputPoints:h}=t;switch((0,u.c)(h.observer,i),h.observerFeatureId=c,h.observerSurfaceNormal=null,l){case"on-the-ground":case"relative-to-ground":{const p=this._intersector.updateFromGroundIntersection(h.observer,n,h.observer);(0,s.Wi)(h.observerFeatureId)&&(h.observerSurfaceNormal=p)}}this._adjustStartEndPositions(t),t.notifyInputPointsChanged(),this.priority=ct.T8.LINE_OF_SIGHT_TOOL_INTERACTIVE}_onTargetPositionChange(t,i,n,l,c,h=!0){const p=t.inputPoints;if(h&&(p.isValid=!1),(0,s.Wi)(n))return(0,s.pC)(i)&&(0,Rt.e)(this.analysis,i.spatialReference,Mt),t.elevationAlignedTargetLocation=null,void t.notifyInputPointsChanged();const O=this._getEffectiveElevationInfo(n,l),{absoluteZ:f,elevation:C}=(0,V.tq)(n.x,n.y,n.z,this.view.spatialReference,this.view,O),y=n.clone();switch(y.z=f,t.elevationAlignedTargetLocation=y,this.view.renderCoordsHelper.toRenderCoords(t.elevationAlignedTargetLocation,p.target),p.targetFeatureId=(0,at.pD)(c),p.targetSurfaceNormal=null,O.mode){case"on-the-ground":case"relative-to-ground":{const S=this._intersector.updateFromGroundIntersection(p.target,f-C,p.target);(0,s.Wi)(p.targetFeatureId)&&(p.targetSurfaceNormal=S)}}this._adjustStartEndPositions(t),t.notifyInputPointsChanged(),this.priority=ct.T8.LINE_OF_SIGHT_TOOL_INTERACTIVE}_connectComputationToTarget(t){return(0,N.AL)([this._updatingHandles.add(()=>({computation:t,targetPosition:t.target.position,targetElevationInfo:t.target.elevationInfo,targetFeatureInfo:t.target.feature,projectedTargetPosition:(0,w.dz)(t.target.position,this.view.spatialReference)}),({computation:i,targetPosition:n,targetElevationInfo:l,targetFeatureInfo:c,projectedTargetPosition:h})=>{(0,s.pC)(h.pending)?this._updatingHandles.addPromise(h.pending):this._onTargetPositionChange(i,n,h.geometry,l,c)},g.nn)])}_connectComputationToObserver(t){return this._updatingHandles.add(()=>({computation:t,observer:this.analysisViewData.elevationAlignedObserver}),({computation:i})=>{this._externalObserverUpdate&&(i.inputPoints.isValid=!1,i.notifyInputPointsChanged())},g.nn)}_connectComputationToRenderSpaceObserver(t){return this._updatingHandles.add(()=>({computation:t,observer:this._elevationAlignedObserverPositionRenderSpace,observerGroundOffset:this._observerGroundOffsetRenderSpace,observerElevationMode:this._effectiveObserverElevationMode,observerFeatureId:this._observerFeatureId}),({computation:i,observer:n,observerGroundOffset:l,observerElevationMode:c,observerFeatureId:h})=>{this._onObserverRenderSpacePositionChangeForComputation(i,n,l,c,h)},g.nn)}_connectComputationToCamera(t){return this._updatingHandles.add(()=>({camera:this.view.state.camera,isDirty:this._isCameraDirty}),({isDirty:i})=>{!this.updateOnCameraChange||t.inputPoints.isValid&&!i||t.notifyInputPointsChanged()})}_connectComputationToSlicePlane(t){return this._updatingHandles.add(()=>this.view.slicePlane,()=>{t.inputPoints.isValid=!1,t.notifyInputPointsChanged()})}_connectComputationToElevation(t){const i=(n,l)=>{const c=this.analysis.observer,h=t.target;let p=null,O=null,f=null,C=null,y=null,S=null;if((0,s.pC)(c)&&(0,s.pC)(c.position)){const P=(0,w.dz)(c.position,this.view.spatialReference);if((0,s.pC)(P.pending))return this._updatingHandles.addPromise(P.pending),void P.pending.finally(()=>i(n,l));p=P.geometry,O=c.elevationInfo,f=c.feature}if((0,s.pC)(h.position)){const P=(0,w.dz)(h.position,this.view.spatialReference);if((0,s.pC)(P.pending))return this._updatingHandles.addPromise(P.pending),void P.pending.finally(()=>i(n,l));C=P.geometry,y=h.elevationInfo,S=h.feature}(0,s.Wi)(p)&&(0,s.Wi)(C)||((0,w.dH)(n,l,bt,this.view.spatialReference),(0,s.pC)(p)&&(0,I.Qn)(bt,p)&&this._onObserverPositionChange((0,s.pC)(c)?c.position:null,p,O,f,!1),(0,s.pC)(C)&&(0,I.Qn)(bt,C)&&this._onTargetPositionChange(t,h.position,C,y,S,!1),(0,s.pC)(p)&&(0,s.pC)(C)&&(0,I.I7)(bt,p,C)&&t.notifyInputPointsChanged())};return this.view.elevationProvider.on("elevation-change",n=>i(n.extent,n.spatialReference))}_connectComputationToTask(t){var i=this;let n=s.YP;const l={computation:t,interpolationInfo:{originalIntersection:(0,m.c)(),originalObserver:(0,m.c)(),originalTarget:(0,m.c)()}};return(0,N.AL)([this._updatingHandles.add(()=>t.inputPoints,()=>{n=(0,s.IM)(n),n=(0,Ct.vr)(function(){var c=(0,Tt.Z)(function*(h){yield(0,It.R8)(i._frameTask.schedule(()=>i._computeResult(l),h))});return function(h){return c.apply(this,arguments)}}())},{initial:!0,equals:()=>!1}),(0,N.kB)(()=>n=(0,s.IM)(n))])}_connectComputation(t){const i=this._computationHandles;i.has(t)||i.add([this._connectComputationToTarget(t),this._connectComputationToObserver(t),this._connectComputationToRenderSpaceObserver(t),this._connectComputationToCamera(t),this._connectComputationToSlicePlane(t),this._connectComputationToElevation(t),this._connectComputationToTask(t)],t)}_disconnectComputation(t){this._computationHandles.remove(t)}_onComputationCollectionChange({added:t,removed:i}){for(const n of i)this._disconnectComputation(n);for(const n of t)this._connectComputation(n)}_onTargetCollectionChange({added:t,removed:i}){for(const n of i)this._removeTarget(n);for(const n of t)this._addTarget(n)}_onCursorTargetChange(t,i){(0,s.pC)(i)&&this._removeTarget(i),(0,s.pC)(t)&&this._addTarget(t)}_addTarget(t){this._computations.some(i=>i.target===t)||this._computations.add(new H({target:t}))}_removeTarget(t){const i=this._computations.findIndex(n=>n.target===t);this._computations.removeAt(i)}_connectObserver(){return(0,N.AL)([this._updatingHandles.add(()=>({observerPosition:(0,s.pC)(this.analysis.observer)?this.analysis.observer.position:null,projectedObserverPosition:(0,w.dz)((0,s.pC)(this.analysis.observer)?this.analysis.observer.position:null,this.view.spatialReference),observerElevationInfo:(0,s.pC)(this.analysis.observer)?this.analysis.observer.elevationInfo:null,observerFeatureInfo:(0,s.pC)(this.analysis.observer)?this.analysis.observer.feature:null}),({observerPosition:t,projectedObserverPosition:i,observerElevationInfo:n,observerFeatureInfo:l})=>{(0,s.pC)(i.pending)?this._updatingHandles.addPromise(i.pending):this._onObserverPositionChange(t,i.geometry,n,l,!0)},g.nn)])}_connectComputations(){return this._updatingHandles.addOnCollectionChange(()=>this._computations,t=>this._onComputationCollectionChange(t),{initial:!0,final:!0})}_connectTargets(){return(0,N.AL)([this._updatingHandles.addOnCollectionChange(()=>this.analysis.targets,t=>this._onTargetCollectionChange(t),{initial:!0,final:!0}),this._updatingHandles.add(()=>this.analysisViewData.cursorTarget,(t,i)=>{this._onCursorTargetChange(t,i)})])}get _isCameraDirty(){const t=this.analysisViewData.elevationAlignedObserver,{view:i}=this,{renderCoordsHelper:n}=i;if((0,s.Wi)(t)||(0,s.Wi)(n))return!1;const l=mt;n.toRenderCoords(t,l);const c=i.state.camera.computeScreenPixelSizeAt(l);return Math.abs((c-this._screenPixelSize)/this._screenPixelSize)>qt}_getEffectiveElevationInfo(t,i){return t.hasZ?(0,s.Pt)(i,{mode:"absolute-height",offset:0}):{mode:"on-the-ground",offset:0}}};(0,o._)([(0,a.Cb)({constructOnly:!0})],A.prototype,"analysis",void 0),(0,o._)([(0,a.Cb)({constructOnly:!0})],A.prototype,"analysisViewData",void 0),(0,o._)([(0,a.Cb)({constructOnly:!0})],A.prototype,"view",void 0),(0,o._)([(0,a.Cb)()],A.prototype,"updating",null),(0,o._)([(0,a.Cb)()],A.prototype,"priority",null),(0,o._)([(0,a.Cb)()],A.prototype,"updateOnCameraChange",void 0),(0,o._)([(0,a.Cb)()],A.prototype,"_computations",null),(0,o._)([(0,a.Cb)()],A.prototype,"_elevationAlignedObserverPositionRenderSpace",null),(0,o._)([(0,a.Cb)()],A.prototype,"_observerGroundOffsetRenderSpace",void 0),(0,o._)([(0,a.Cb)()],A.prototype,"_effectiveObserverElevationMode",void 0),(0,o._)([(0,a.Cb)()],A.prototype,"_observerFeatureId",void 0),(0,o._)([(0,a.Cb)()],A.prototype,"_screenPixelSize",null),(0,o._)([(0,a.Cb)({readOnly:!0})],A.prototype,"_updatingHandles",void 0),(0,o._)([(0,a.Cb)()],A.prototype,"_frameTask",void 0),(0,o._)([(0,a.Cb)()],A.prototype,"_isCameraDirty",null),A=(0,o._)([(0,_.j)(At)],A);const qt=.1,mt=(0,m.c)(),Dt=(0,L.Ue)(),bt=(0,I.cS)(),te=.05;var Zt=d(61642),Ht=d(57574),Ut=d(13777),jt=d(82706);let $=class extends E.Z{constructor(t){super(t),this.enabled=!0,this.glowColor=new v.Z([255,127,0]),this.glowWidth=8,this.innerColor=new v.Z([255,255,255]),this.innerWidth=.75,this.globalAlpha=.75}};(0,o._)([(0,a.Cb)({type:Boolean})],$.prototype,"enabled",void 0),(0,o._)([(0,a.Cb)({type:v.Z})],$.prototype,"glowColor",void 0),(0,o._)([(0,a.Cb)({type:Number})],$.prototype,"glowWidth",void 0),(0,o._)([(0,a.Cb)({type:v.Z})],$.prototype,"innerColor",void 0),(0,o._)([(0,a.Cb)({type:Number})],$.prototype,"innerWidth",void 0),(0,o._)([(0,a.Cb)({type:Number})],$.prototype,"globalAlpha",void 0),$=(0,o._)([(0,_.j)("esri.views.3d.interactive.analysisTools.lineOfSight.LineOfSightLaserLineConfiguration")],$);let pt=class extends E.Z{constructor(t){super(t),this.size=.5,this.color=new v.Z([255,127,0,.75])}};(0,o._)([(0,a.Cb)({type:Number})],pt.prototype,"size",void 0),(0,o._)([(0,a.Cb)({type:v.Z})],pt.prototype,"color",void 0),pt=(0,o._)([(0,_.j)("esri.views.3d.interactive.analysisTools.lineOfSight.LineOfSightObserverConfiguration")],pt);let nt=class extends E.Z{constructor(t){super(t),this.size=.5,this.visibleColor=new v.Z([3,252,111,.75]),this.occludedColor=new v.Z([252,3,69,.75]),this.undefinedColor=new v.Z([127,127,127,.75])}};(0,o._)([(0,a.Cb)({type:Number})],nt.prototype,"size",void 0),(0,o._)([(0,a.Cb)({type:v.Z})],nt.prototype,"visibleColor",void 0),(0,o._)([(0,a.Cb)({type:v.Z})],nt.prototype,"occludedColor",void 0),(0,o._)([(0,a.Cb)({type:v.Z})],nt.prototype,"undefinedColor",void 0),nt=(0,o._)([(0,_.j)("esri.views.3d.interactive.analysisTools.lineOfSight.LineOfSightTargetConfiguration")],nt);class X extends E.Z{constructor(i){super(i),this.innerWidth=2,this.outerWidth=8,this.visibleInnerColor=new v.Z([3,252,111,1]),this.visibleOuterColor=new v.Z([3,252,111,.15]),this.occludedInnerColor=new v.Z([252,3,69,1]),this.occludedOuterColor=new v.Z([252,3,69,.1]),this.undefinedInnerColor=new v.Z([255,255,255,1]),this.undefinedOuterColor=new v.Z([127,127,127,.2])}}(0,o._)([(0,a.Cb)({type:Number})],X.prototype,"innerWidth",void 0),(0,o._)([(0,a.Cb)({type:Number})],X.prototype,"outerWidth",void 0),(0,o._)([(0,a.Cb)({type:v.Z})],X.prototype,"visibleInnerColor",void 0),(0,o._)([(0,a.Cb)({type:v.Z})],X.prototype,"visibleOuterColor",void 0),(0,o._)([(0,a.Cb)({type:v.Z})],X.prototype,"occludedInnerColor",void 0),(0,o._)([(0,a.Cb)({type:v.Z})],X.prototype,"occludedOuterColor",void 0),(0,o._)([(0,a.Cb)({type:v.Z})],X.prototype,"undefinedInnerColor",void 0),(0,o._)([(0,a.Cb)({type:v.Z})],X.prototype,"undefinedOuterColor",void 0);let ot=class extends E.Z{constructor(t){super(t),this.laserLine=new $,this.observer=new pt,this.target=new nt,this.lineOfSight=new X}};(0,o._)([(0,a.Cb)({type:$})],ot.prototype,"laserLine",void 0),(0,o._)([(0,a.Cb)({type:pt})],ot.prototype,"observer",void 0),(0,o._)([(0,a.Cb)({type:nt})],ot.prototype,"target",void 0),(0,o._)([(0,a.Cb)({type:X})],ot.prototype,"lineOfSight",void 0),ot=(0,o._)([(0,_.j)("esri.views.3d.interactive.analysisTools.lineOfSight.LineOfSightToolConfiguration")],ot);var ee=d(45403),ie=d(19142),ne=d(40345),se=d(57521),ht=d(33786);function ft(t,i,n){return new ne.r((0,se.PI)((0,ie.EA)(v.Z.toUnitRGBA(i)),t,32,32),n)}function zt(t){const i=[];return t.customColor1&&i.push(ft(t.size,t.customColor1,ht.jg.Custom1)),t.customColor2&&i.push(ft(t.size,t.customColor2,ht.jg.Custom2)),t.customColor3&&i.push(ft(t.size,t.customColor3,ht.jg.Custom3)),t.color&&i.push(ft(t.size,t.color)),i}var st,t,ae=d(23018),le=(d(45458),d(58997)),Wt=d(30260),xt=d(41900),Lt=d(85112);(t=st||(st={})).Ready="ready",t.Creating="creating",t.Created="created";let D=class extends le.f{constructor(t){super(t),this.removeIncompleteOnCancel=!1,this.configuration=new ot,this.analysisViewData=null,this._latestPointerMovePointerType=null,this._laserlineVisualElement=null,this._grabbedManipulator=null,this._analysisHandles=new et.Z,this._handles=new et.Z,this._updatingHandles=new T.t,this._manipulatorHandles=new et.Z,this._targetTrackerManipulator=null}initialize(){this._intersector=new ut({view:this.view}),this._handles.add((0,g.YP)(()=>this.state,t=>{t===st.Created&&this.finishToolCreation()},g.tX)),this._observerManipulator=this._createObserverManipulator(),this._handles.add([this._updatingHandles.add(()=>({...this.configuration.observer}),()=>this._updateObserverManipulatorStyle()),this._updatingHandles.add(()=>this.analysisViewData?.elevationAlignedObserver,t=>this._onObserverLocationChange(t),g.nn),this._updatingHandles.add(()=>({...this.configuration.laserLine}),()=>this._createVisualElements(),g.nn),this._updatingHandles.add(()=>this._laserLineRendererDependencies(),t=>this._updateLaserLineRenderer(t)),this._connectComputations(),this._updatingHandles.addWhen(()=>!this._shouldRenderTracker,()=>this._clearCursorTracker(),g.nn)])}destroy(){this._updatingHandles=(0,s.SC)(this._updatingHandles),this._handles=(0,s.SC)(this._handles),this._manipulatorHandles=(0,s.SC)(this._manipulatorHandles),this._analysisHandles=(0,s.SC)(this._analysisHandles),this._observerManipulator=null,this._clearCursorTracker(),this._removeVisualElements(),this._intersector=null,this._set("analysis",null)}get state(){return this.active?this.hasGrabbedManipulators?st.Created:st.Creating:(0,s.pC)(this.analysis.observer)&&(0,s.pC)(this.analysis.observer.position)?st.Created:st.Ready}get cursor(){return this.active&&this._showTracker?"crosshair":null}get updating(){return(0,s.pC)(this.analysisViewData)&&this.analysisViewData.updating||this._updatingHandles.updating}get _showTracker(){return this.active&&"mouse"===this._latestPointerMovePointerType}get _shouldRenderTracker(){return this._showTracker&&(0,s.pC)(this.analysis.observer)&&(0,s.pC)(this.analysis.observer.position)&&!this.hasGrabbedManipulators}continue(){this.view.activeTool=this}stop(){this.view.activeTool=null}onEditableChange(){this.analysisViewData.editable=this.internallyEditable}onInputEvent(t){switch(t.type){case"immediate-double-click":this._doubleClickHandler(t);break;case"key-down":this._keyDownHandler(t);break;case"pointer-move":this._pointerMoveHandler(t)}}onInputEventAfter(t){"immediate-click"===t.type&&this._clickHandler(t)}onShow(){}onHide(){}onDeactivate(){this._clearCursorTracker()}_connectComputations(){return this._updatingHandles.addOnCollectionChange(()=>this.analysisViewData.computations,t=>this._onComputationsCollectionChange(t),{initial:!0,final:!0})}_onComputationsCollectionChange({added:t,removed:i}){for(const n of i)this._disconnectComputation(n);for(const n of t)this._connectComputation(n)}_connectComputation(t){if(this.destroyed)return void vt.Z.getLogger(this.declaredClass).warn("Attempting to connect an analysis to a destroyed LineOfSight tool. Ignoring.");const i=this._analysisHandles;if(i.has(t))return;const n=this._createTargetManipulator(t.target);(0,s.Wi)(this._targetTrackerManipulator)&&n.metadata.target===this.analysisViewData.cursorTarget&&(this._targetTrackerManipulator=n,this._targetTrackerManipulator.available=!1,this._targetTrackerManipulator.interactive=!1,this._updateLaserLineRenderer()),i.add([this._updatingHandles.add(()=>this._getLineOfSightManipulatorStateDependencies(t),()=>this._updateManipulatorState(n,t),g.nn),this._updatingHandles.add(()=>t.elevationAlignedTargetLocation,l=>this._onTargetLocationChange(l,n),g.nn)],t)}_disconnectComputation(t){if(this.destroyed)return void vt.Z.getLogger(this.declaredClass).warn("Attempting to disconnect an analysis from a destroyed LineOfSight tool. Ignoring.");this._analysisHandles.remove(t);const i=this._getTargetManipulator(t.target);(0,s.pC)(i)&&(this.manipulators.remove(i),this._manipulatorHandles.remove(i),(0,s.pC)(this._targetTrackerManipulator)&&this._targetTrackerManipulator===i&&(this._targetTrackerManipulator=null))}_clearCursorTracker(){this.analysisViewData.cursorTarget=(0,s.SC)(this.analysisViewData.cursorTarget)}_createManipulator(t,i,n){const l=function re(t,i){const n=zt(i),l=new ee.Z({view:t,renderObjects:n,elevationInfo:{mode:"absolute-height",offset:0}});return function oe(t,i){let n=null;t.events.on("grab-changed",c=>{(0,s.pC)(n)&&(n.remove(),n=null),"start"===c.action&&(n=t.disableDisplay()),i&&i(c)})}(l),l}(this.view,t);return l.metadata=n,this._manipulatorHandles.add([i(l),l.events.on("grab-changed",c=>this._manipulatorGrabChanged(l,c)),l.events.on("immediate-click",c=>this._manipulatorClick(l,c))],l),this.manipulators.add(l),l}_createTargetManipulator(t){const i=this.configuration,c=this._createManipulator({size:i.target.size,customColor1:i.target.visibleColor,customColor2:i.target.occludedColor,customColor3:i.target.undefinedColor,visible:!0},h=>this._createTargetManipulatorDragPipeline(h),{target:t,type:"target"});return(0,s.pC)(t.position)?c.elevationAlignedLocation=t.position:c.available=!1,c}_getTargetManipulator(t){let i=null;return this.manipulators.forEach(n=>{const l=n.manipulator;(0,s.Wi)(i)&&"target"===l.metadata.type&&l.metadata.target===t&&(i=l)}),i}_createObserverManipulator(){const t=this.configuration;return this._createManipulator({size:t.observer.size,color:t.observer.color,visible:!0},n=>this._createObserverManipulatorDragPipeline(n),{type:"observer",intersection:null})}_updateObserverManipulatorStyle(){const t=this._observerManipulator,i=this.configuration.observer;t.renderObjects=zt({size:i.size,color:i.color,visible:t.available})}_screenToIntersection(){return t=>{const i=this._intersector.getScreenPointIntersection(t.screenEnd);return(0,s.Wi)(i)?null:{...t,intersection:i}}}_createTargetManipulatorDragPipeline(t){return(0,Wt.Xd)(t,(i,n,l)=>{n.next(this._screenToIntersection()).next(this._updateTargetDragStep(t)).next(()=>this._updateLaserLineRenderer()),l.next(this._cancelTargetDragStep(t.metadata.target)).next(()=>this._updateLaserLineRenderer())})}_createObserverManipulatorDragPipeline(t){return(0,Wt.Xd)(t,(i,n,l)=>{n.next(this._screenToIntersection()).next(this._updateObserverDragStep()).next(()=>this._updateLaserLineRenderer()),l.next(this._cancelObserverDragStep()).next(()=>this._updateLaserLineRenderer())})}_updateObserverDragStep(){return t=>((0,s.pC)(t.intersection.mapPoint)?((0,s.Wi)(this.analysis.observer)&&(this.analysis.observer=new Zt.Z),this._updateFromIntersection(this.analysis.observer,t.intersection)):this.analysis.observer=null,t)}_cancelObserverDragStep(){const t=(0,s.pC)(this.analysis.observer)&&(0,s.pC)(this.analysis.observer.position)?this.analysis.observer.clone():null;return i=>(this.analysis.observer=t,i)}_updateTargetDragStep(t){return i=>{this._updateFromIntersection(t.metadata.target,i.intersection);const n=i.intersection.mapPoint;return(0,s.pC)(n)&&(t.elevationAlignedLocation=n),i}}_cancelTargetDragStep(t){const i=(0,s.yw)(t.position,n=>n.clone());return n=>(t.position=i,n)}_manipulatorGrabChanged(t,i){switch(i.action){case"start":this._grabbedManipulator=t;break;case"end":this._grabbedManipulator===t&&(this._grabbedManipulator=null)}}_updateManipulatorState(t,i){const{isValid:n,isTargetVisible:l}=i.computationResult;t.state=n?l?ht.jg.Custom1:ht.jg.Custom2:ht.jg.Custom3}_getLineOfSightManipulatorStateDependencies(t){const{isValid:i,isTargetVisible:n}=t.computationResult;return{isValid:i,isTargetVisible:n}}_laserLineRendererDependencies(){return{laserlineVisualElement:this._laserlineVisualElement,grabbedManipulator:this._grabbedManipulator,shouldRenderTracker:this._shouldRenderTracker,observerPosition:(0,s.pC)(this.analysis.observer)?this.analysis.observer.position:null,visible:this.visible}}_updateLaserLineRenderer(t=this._laserLineRendererDependencies()){const{laserlineVisualElement:i,grabbedManipulator:n,shouldRenderTracker:l,observerPosition:c,visible:h}=t;if((0,s.Wi)(i))return;const p=(0,s.pC)(n)?n:l&&(0,s.pC)(c)?this._targetTrackerManipulator:null;this.configuration.laserLine.enabled&&(0,s.pC)(p)&&h?(i.visible=!0,i.heightManifoldTarget=p.renderLocation,i.lineVerticalPlaneSegment=p!==this._observerManipulator?(0,Ut.zk)(this._observerManipulator.renderLocation,p.renderLocation,de):null):(i.visible=!1,i.heightManifoldTarget=null,i.lineVerticalPlaneSegment=null)}_createVisualElements(){const t=this.configuration.laserLine;this._removeVisualElements(),this._laserlineVisualElement=new ae.W({view:this.view,attached:!0,visible:this.visible,style:{glowColor:v.Z.toUnitRGB(t.glowColor),glowWidth:t.glowWidth,innerColor:v.Z.toUnitRGB(t.innerColor),innerWidth:t.innerWidth,globalAlpha:t.globalAlpha}})}_removeVisualElements(){(0,s.pC)(this._laserlineVisualElement)&&(this._laserlineVisualElement.destroy(),this._laserlineVisualElement=null)}_onObserverLocationChange(t){(0,s.Wi)(t)?this._observerManipulator.available=!1:(this._observerManipulator.metadata.intersection=null,this._observerManipulator.available=!0,this._observerManipulator.elevationAlignedLocation=t)}_onTargetLocationChange(t,i){(0,s.pC)(t)?(i.elevationAlignedLocation=t,i!==this._targetTrackerManipulator&&(i.available=!0)):i.available=!1}_addPointFromClickEvent(t){const i=this._intersector.getScreenPointIntersection(t);if(!(0,s.Wi)(i)&&!(0,s.Wi)(i.mapPoint))if((0,s.pC)(this.analysis.observer)&&(0,s.pC)(this.analysis.observer.position)){this._clearCursorTracker();const n=new Ht.Z;this._updateFromIntersection(n,i),this.analysis.targets.add(n)}else{const n=new Zt.Z;this._updateFromIntersection(n,i),this.analysis.observer=n}}_clickHandler(t){this.active&&t.button!==Lt.t.Right&&(this._addPointFromClickEvent((0,xt.vT)(t)),t.stopPropagation())}_doubleClickHandler(t){this.active&&t.button!==Lt.t.Right&&(this.stop(),t.stopPropagation())}_keyDownHandler(t){this.active&&"Escape"===t.key&&(this.stop(),t.stopPropagation())}_pointerMoveHandler(t){if(this.hasGrabbedManipulators||(this._latestPointerMovePointerType=t.pointerType,this._updateLaserLineRenderer(),!this._showTracker||(0,s.Wi)(this.analysis.observer)||(0,s.Wi)(this.analysis.observer.position)))return;const i=(0,xt.vT)(t),n=this._intersector.getScreenPointIntersection(i);(0,s.pC)(n)&&(0,s.pC)(n.mapPoint)&&((0,s.Wi)(this.analysisViewData.cursorTarget)&&(this.analysisViewData.cursorTarget=new Ht.Z),this._updateFromIntersection(this.analysisViewData.cursorTarget,n),this._updateLaserLineRenderer())}_updateFromIntersection(t,i){if((0,s.Wi)(i.mapPoint))return t.position=null,t.elevationInfo=null,void(t.feature=null);switch(i.type){case J.q7.OBJECT:if((0,s.pC)(i.graphic)){const l=i.graphic,c=(0,V.RL)(l);"on-the-ground"===c.mode&&(c.mode="relative-to-ground",c.offset=0),t.elevationInfo=new jt.Z(c),t.feature=l}else t.elevationInfo=null,t.feature=null;break;case J.q7.TERRAIN:case J.q7.I3S:t.elevationInfo=new jt.Z({mode:"on-the-ground"}),t.feature=null;break;default:t.elevationInfo=null,t.feature=null}const n=i.mapPoint.clone();n.z=(0,V.vQ)(this.view,n,{mode:"absolute-height",offset:0},t.elevationInfo),t.position=n}_manipulatorClick(t,i){if("observer"===t.metadata.type||t.grabbing||t.dragging||i.button!==Lt.t.Right||this.analysis.targets.length<=1)return;const{target:n}=t.metadata;this.analysis.targets.remove(n),i.stopPropagation()}get testInfo(){return{laserLineVisualElement:this._laserlineVisualElement}}};(0,o._)([(0,a.Cb)({constructOnly:!0})],D.prototype,"view",void 0),(0,o._)([(0,a.Cb)({constructOnly:!0})],D.prototype,"analysis",void 0),(0,o._)([(0,a.Cb)({readOnly:!0})],D.prototype,"state",null),(0,o._)([(0,a.Cb)({readOnly:!0})],D.prototype,"cursor",null),(0,o._)([(0,a.Cb)()],D.prototype,"removeIncompleteOnCancel",void 0),(0,o._)([(0,a.Cb)({readOnly:!0})],D.prototype,"updating",null),(0,o._)([(0,a.Cb)({type:ot})],D.prototype,"configuration",void 0),(0,o._)([(0,a.Cb)({constructOnly:!0})],D.prototype,"analysisViewData",void 0),(0,o._)([(0,a.Cb)({readOnly:!0})],D.prototype,"_showTracker",null),(0,o._)([(0,a.Cb)()],D.prototype,"_latestPointerMovePointerType",void 0),(0,o._)([(0,a.Cb)()],D.prototype,"_shouldRenderTracker",null),(0,o._)([(0,a.Cb)()],D.prototype,"_laserlineVisualElement",void 0),(0,o._)([(0,a.Cb)()],D.prototype,"_grabbedManipulator",void 0),D=(0,o._)([(0,_.j)("esri.views.3d.interactive.analysisTools.lineOfSight.LineOfSightTool")],D);const de=(0,Ut.Ue)();var ue=d(43703);class ce{constructor(i,n,l,c){this.visibleLineVisualElement=i,this.occludedLineVisualElement=n,this.undefinedLineVisualElement=l,this.targetVisualElement=c}destroy(){this.visibleLineVisualElement.destroy(),this.occludedLineVisualElement.destroy(),this.undefinedLineVisualElement.destroy(),this.targetVisualElement.destroy()}}var wt=d(87469),Ft=d(30693),Et=d(40723);let B=class extends E.Z{constructor(t){super(t),this._lineOfSightVisualElements=new Array,this._computationHandles=new et.Z,this._updatingHandles=new T.t}initialize(){this.addHandles(this._connectComputations()),this._createObserverVisualization()}destroy(){this._updatingHandles=(0,s.SC)(this._updatingHandles),this._computationHandles=(0,s.SC)(this._computationHandles),this._observerVisualElement=(0,s.SC)(this._observerVisualElement)}get visible(){return this.analysisViewData.visible}get updating(){return this._updatingHandles.updating}get interactiveAndEditable(){return this.analysisViewData.interactive&&this.analysisViewData.editable}get test(){return{disablePartialOcclusion:()=>{for(const t of this._lineOfSightVisualElements)t.visibleLineVisualElement.renderOccluded=Et.yD.Occlude,t.occludedLineVisualElement.renderOccluded=Et.yD.Occlude,t.undefinedLineVisualElement.renderOccluded=Et.yD.Occlude},visualizations:this._lineOfSightVisualElements}}get _configuration(){return this.analysisViewData.configuration}_createLineOfSightVisualization(){const t=this._configuration,i=this.view,n={view:i,attached:!0,width:t.outerWidth,innerWidth:t.innerWidth},l=v.Z.toUnitRGBA(t.visibleOuterColor),c=v.Z.toUnitRGBA(t.visibleInnerColor),h=v.Z.toUnitRGBA(t.occludedOuterColor),p=v.Z.toUnitRGBA(t.occludedInnerColor),O=v.Z.toUnitRGBA(t.undefinedOuterColor),f=v.Z.toUnitRGBA(t.undefinedInnerColor),C=new wt.r({...n,color:l,innerColor:c}),y=new wt.r({...n,color:h,innerColor:p}),S=new wt.r({...n,color:O,innerColor:f}),P=new Ft.L({view:i,attached:!0,...Bt,size:8}),Z=new ce(C,y,S,P);return this._lineOfSightVisualElements.push(Z),Z}_destroyLineOfSightVisualization(t){t.destroy(),this._lineOfSightVisualElements.splice(this._lineOfSightVisualElements.indexOf(t),1)}_updateLineOfSightVisualization(t,i,n){const l=this._configuration,{computationResult:c,inputPoints:h}=t,{start:p,end:O,intersection:f,isValid:C,isTargetVisible:y}=c,{observer:S}=h,P=ge;P[12]=S[0],P[13]=S[1],P[14]=S[2];const Z=(0,u.b)(pe,p,S),W=(0,u.b)(he,O,S),U=(0,u.b)(ve,f,S),{visibleLineVisualElement:R,occludedLineVisualElement:G,undefinedLineVisualElement:F,targetVisualElement:q}=i,Ce=(0,s.Wi)(this.analysisViewData.elevationAlignedObserver)||(0,s.Wi)(t.elevationAlignedTargetLocation),gt=this.visible&&!Ce;R.visible=gt,G.visible=gt,F.visible=gt,q.visible=gt,q.attached=!n.interactiveAndEditable,gt&&(R.geometry=null,G.geometry=null,F.geometry=null,q.geometry=t.elevationAlignedTargetLocation,C?y?(R.geometry=[[(0,m.d)(Z),(0,m.d)(W)]],R.transform=P,R.color=v.Z.toUnitRGBA(l.visibleOuterColor),q.color=v.Z.toUnitRGBA(l.visibleInnerColor)):(R.geometry=[[(0,m.d)(Z),(0,m.d)(U)]],R.transform=P,R.color=v.Z.toUnitRGBA(l.occludedOuterColor),G.geometry=[[(0,m.d)(U),(0,m.d)(W)]],G.transform=P,q.color=v.Z.toUnitRGBA(l.occludedInnerColor)):(F.geometry=[[(0,m.d)(Z),(0,m.d)(W)]],F.transform=P,q.color=v.Z.toUnitRGBA(l.undefinedInnerColor)))}_getLineOfSightVisualizationDependencies(t){const{computationResult:i}=t,{occludedOuterColor:n,visibleOuterColor:l}=this._configuration;return{computationResult:i,occludedOuterColor:n,visibleOuterColor:l,visible:this.visible,interactiveAndEditable:this.interactiveAndEditable}}_connectComputation(t){const i=this._computationHandles;if(i.has(t))return;const n=this._createLineOfSightVisualization();i.add([this._updatingHandles.add(()=>this._getLineOfSightVisualizationDependencies(t),l=>this._updateLineOfSightVisualization(t,n,l),{initial:!0,equals:()=>!1}),(0,N.kB)(()=>this._destroyLineOfSightVisualization(n))],t)}_disconnectComputation(t){this._computationHandles.remove(t)}_connectComputations(){return this._updatingHandles.addOnCollectionChange(()=>this.analysisViewData.computations,t=>this._onComputationsCollectionChange(t),{initial:!0,final:!0})}_onComputationsCollectionChange({added:t,removed:i}){for(const n of i)this._disconnectComputation(n);for(const n of t)this._connectComputation(n)}_createObserverVisualization(){const t=v.Z.toUnitRGBA(this._configuration.visibleInnerColor),i=new Ft.L({view:this.view,attached:!1,color:t,...Bt});this._observerVisualElement=i,this.addHandles(this._updatingHandles.add(()=>({observer:this.analysisViewData.elevationAlignedObserver,interactiveAndEditable:this.interactiveAndEditable,visible:this.visible}),({observer:n,interactiveAndEditable:l,visible:c})=>{(0,s.Wi)(n)||l||!c?i.attached=!1:(i.geometry=n,this._observerVisualElement.attached=!0)},g.nn))}};(0,o._)([(0,a.Cb)({constructOnly:!0})],B.prototype,"analysis",void 0),(0,o._)([(0,a.Cb)({constructOnly:!0})],B.prototype,"analysisViewData",void 0),(0,o._)([(0,a.Cb)({constructOnly:!0})],B.prototype,"view",void 0),(0,o._)([(0,a.Cb)({readOnly:!0})],B.prototype,"visible",null),(0,o._)([(0,a.Cb)()],B.prototype,"updating",null),(0,o._)([(0,a.Cb)()],B.prototype,"interactiveAndEditable",null),(0,o._)([(0,a.Cb)()],B.prototype,"test",null),(0,o._)([(0,a.Cb)()],B.prototype,"_configuration",null),B=(0,o._)([(0,_.j)("esri.views.3d.analysis.LineOfSight.LineOfSightVisualization")],B);const Bt={size:6,pixelSnappingEnabled:!1,primitive:"circle",elevationInfo:{mode:"absolute-height",offset:0},outlineSize:0},pe=(0,m.c)(),he=(0,m.c)(),ve=(0,m.c)(),ge=(0,ue.c)();var Gt=d(95925);let M=class extends((0,Ot.p)(rt.Z.EventedMixin(E.Z))){constructor(t){super(t),this.type="line-of-sight-view-3d",this.analysis=null,this.tool=null,this.computations=new Y.Z,this.elevationAlignedObserver=null,this.configuration=new j,this.observerEngineLocation=(0,m.c)(),this.cursorTarget=null,this.editable=!0}initialize(){const t=this.view,i=this.analysis;this._analysisController=new A({analysis:i,analysisViewData:this,view:t}),this._analysisVisualization=new B({analysis:i,analysisViewData:this,view:t}),this.addHandles([this._analysisController.on("result-changed",n=>{n.target!==this.cursorTarget&&this.emit("result-changed",n)}),(0,Gt.Lp)(this,D)])}destroy(){(0,Gt.Yq)(this),this._analysisController=(0,s.SC)(this._analysisController),this._analysisVisualization=(0,s.SC)(this._analysisVisualization)}get results(){return this.computations.map(t=>t.result)}get priority(){return this._analysisController.priority}set priority(t){this._analysisController.priority=t}get updating(){return(0,s.pC)(this._analysisController)&&this._analysisController.updating||(0,s.pC)(this._analysisVisualization)&&this._analysisVisualization.updating}getResultForTarget(t){const i=this.computations.find(n=>n.target===t);return(0,s.yw)(i,n=>n.result)}get testInfo(){return{visualization:this._analysisVisualization,controller:this._analysisController}}};(0,o._)([(0,a.Cb)({readOnly:!0})],M.prototype,"type",void 0),(0,o._)([(0,a.Cb)({constructOnly:!0,nonNullable:!0})],M.prototype,"analysis",void 0),(0,o._)([(0,a.Cb)()],M.prototype,"tool",void 0),(0,o._)([(0,a.Cb)({readOnly:!0})],M.prototype,"results",null),(0,o._)([(0,a.Cb)()],M.prototype,"priority",null),(0,o._)([(0,a.Cb)()],M.prototype,"computations",void 0),(0,o._)([(0,a.Cb)()],M.prototype,"elevationAlignedObserver",void 0),(0,o._)([(0,a.Cb)()],M.prototype,"configuration",void 0),(0,o._)([(0,a.Cb)()],M.prototype,"observerEngineLocation",void 0),(0,o._)([(0,a.Cb)()],M.prototype,"cursorTarget",void 0),(0,o._)([(0,a.Cb)()],M.prototype,"updating",null),(0,o._)([(0,a.Cb)()],M.prototype,"editable",void 0),(0,o._)([(0,a.Cb)()],M.prototype,"_analysisController",void 0),(0,o._)([(0,a.Cb)()],M.prototype,"_analysisVisualization",void 0),M=(0,o._)([(0,_.j)("esri.views.3d.analysis.LineOfSightAnalysisView3D")],M);const ye=M}}]);