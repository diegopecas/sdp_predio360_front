"use strict";(self.webpackChunkpredio360_app=self.webpackChunkpredio360_app||[]).push([[7522],{25310:(St,Ie,f)=>{f.d(Ie,{a:()=>H});var _=f(26584),O=f(63290),ce=f(39406),Z=f(87526);function H(M){return(0,Z.hj)(M.minDataValue)&&(0,Z.hj)(M.maxDataValue)&&null!=M.minSize&&null!=M.maxSize?ce.X.SIZE_MINMAX_VALUE:(M.expression&&"view.scale"===M.expression||M.valueExpression&&"$view.scale"===M.valueExpression)&&Array.isArray(M.stops)?ce.X.SIZE_SCALE_STOPS:(null!=M.field||M.expression&&"view.scale"!==M.expression||M.valueExpression&&"$view.scale"!==M.valueExpression)&&(Array.isArray(M.stops)||"levels"in M&&M.levels)?ce.X.SIZE_FIELD_STOPS:(null!=M.field||M.expression&&"view.scale"!==M.expression||M.valueExpression&&"$view.scale"!==M.valueExpression)&&null!=M.valueUnit?ce.X.SIZE_UNIT_VALUE:(O.Z.getLogger("esri.views.2d.engine.webgl").error(new _.Z("mapview-bad-type","Found invalid size VisualVariable",M)),ce.X.NONE)}},46053:(St,Ie,f)=>{f.r(Ie),f.d(Ie,{default:()=>qs});var _=f(15861),O=f(17626),ce=f(80542),Z=f(8314),H=f(32917),M=f(77712),Ee=(f(90912),f(85931),f(76898)),Ae=f(37053),xt=f(2584),We=f(14517),c=f(62208),A=f(10699),P=f(82054),Xe=f(58175),Ct=f(60466),Ue=f(55746),Ft=f(38305),Tt=f(84792),Se=f(26584),ve=f(63290),Mt=f(93662),Ye=f(7848),He=f(89628),Ze=f(20477),q=f(64822),wt=f(24192),xe=f(66385),N=f(88071),$e=f(25208),Je=f(71260);const Re=268435455;class Et{constructor(){this.fieldMap=new Map,this.fields=[],this.hasFeatures=!1,this.exceededTransferLimit=!1,this.fieldCount=0,this.featureCount=0,this.objectIdFieldIndex=0,this.vertexCount=0,this.offsets={attributes:new Array,geometry:new Array},this.centroid=new Array}hasField(e){return this.fieldMap.has(e)}isDateField(e){return(null!=e&&this.fieldMap.get(e)?.isDate)??!1}getFieldIndex(e){return null!=e?this.fieldMap.get(e)?.index:void 0}}function At(i){const r=i.asUnsafe(),s=r.getLength(),n=r.pos()+s,a={name:"",isDate:!1};for(;r.pos()<n&&r.next();)switch(r.tag()){case 1:a.name=r.getString();break;case 2:"esriFieldTypeDate"===(0,Je.O7)(r.getEnum())&&(a.isDate=!0);break;default:r.skip()}return a}function Ut(i){return i.toLowerCase().trim()}const Le=268435455,pe={small:{delta:new Int32Array(128),decoded:new Int32Array(128)},large:{delta:new Int32Array(128e3),decoded:new Int32Array(128e3)}};function tt(i){return i<=pe.small.delta.length?pe.small:(i<=pe.large.delta.length||(pe.large.delta=new Int32Array(Math.round(1.25*i)),pe.large.decoded=new Int32Array(Math.round(1.25*i))),pe.large)}function st(i){return i.toLowerCase().trim()}function Pt(i){for(;i.next();){if(1===i.tag())return i.getMessage();i.skip()}return null}function Dt(i,e,t,r,s,n){return.5*Math.abs(i*r+t*n+s*e-i*n-t*e-s*r)}function Pe(i,e,t,r){return i*r-t*e==0&&i*t+e*r>0}class be extends $e.s{static fromBuffer(e,t,r=!1){const s=t.geometryType,n=function Lt(i){try{const t=new wt.Z(new Uint8Array(i),new DataView(i));for(;t.next();){if(2===t.tag())return Pt(t.getMessage());t.skip()}}catch(e){const t=new Se.Z("query:parsing-pbf","Error while parsing FeatureSet PBF payload",{error:e});ve.Z.getLogger("esri.view.2d.layers.features.support.FeatureSetReaderPBF").error(t)}return null}(e),a=function Zt(i,e,t=!1){const u=i.asUnsafe(),l=u.pos(),d=new Et;let g=0,p=0,b=null,x=null,S=null,C=!1;for(;u.next();)switch(u.tag()){case 1:b=u.getString();break;case 3:x=u.getString();break;case 12:S=u.processMessage(Je.G$);break;case 9:if(d.exceededTransferLimit=u.getBool(),d.exceededTransferLimit){d.offsets.geometry=t?new Float64Array(8e3):new Int32Array(8e3),d.centroid=t?new Float64Array(16e3):new Int32Array(16e3);for(let F=0;F<d.centroid.length;F++)d.centroid[F]=Re}break;case 13:{const F=At(i),R=F.name,L=Ut(F.name),T={fieldName:R,index:g++,isDate:F.isDate};d.fields.push(T),d.fieldMap.set(F.name,T),d.fieldMap.set(L,T);break}case 15:{const F=u.getLength(),R=u.pos()+F;if(!d.exceededTransferLimit){const E=d.centroid;d.offsets.geometry.push(0),E.push(Re),E.push(Re)}!C&&d.exceededTransferLimit&&(C=!0,d.offsets.attributes=t?new Float64Array(8e3*g):new Uint32Array(8e3*g));let L=p*g;for(;u.pos()<R&&u.next();)switch(u.tag()){case 1:{C?d.offsets.attributes[L++]=u.pos():d.offsets.attributes.push(u.pos());const T=u.getLength();u.skipLen(T);break}case 2:if(e){const T=u.getLength(),E=u.pos()+T;for(;u.pos()<E&&u.next();)switch(u.tag()){case 3:{u.getUInt32();const U=u.getSInt64(),k=u.getSInt64();d.centroid[2*p]=U,d.centroid[2*p+1]=k;break}default:u.skip()}}else{d.offsets.geometry[p]=u.pos();const T=u.getLength();d.vertexCount+=T,u.skipLen(T)}break;case 4:{const T=u.getLength(),E=u.pos()+T;for(;u.pos()<E&&u.next();)switch(u.tag()){case 3:{u.getUInt32();const U=u.getSInt64(),k=u.getSInt64();d.centroid[2*p]=U,d.centroid[2*p+1]=k;break}default:u.skip()}break}default:u.skip()}p++,d.hasFeatures=!0;break}default:u.skip()}const w=b||x;if(!w)throw new Se.Z("FeatureSet has no objectId or globalId field name");return d.featureCount=p,d.fieldCount=g,d.objectIdFieldIndex=d.getFieldIndex(w),d.transform=S,d.displayIds=new Uint32Array(d.featureCount),d.groupIds=new Uint16Array(d.featureCount),u.move(l),d}(n,"esriGeometryPoint"===s,r),o=$e.s.createInstance();return new be(o,n,a,t)}constructor(e,t,r,s){super(e,s),this._hasNext=!1,this._isPoints=!1,this._featureIndex=-1,this._featureOffset=0,this._cache={area:0,unquantGeometry:void 0,geometry:void 0,centroid:void 0,legacyFeature:void 0,optFeature:void 0},this._geometryType=s.geometryType,this._reader=t,this._header=r,this._hasNext=r.hasFeatures,this._isPoints="esriGeometryPoint"===s.geometryType}get geometryType(){return this._geometryType}get _size(){return this._header.featureCount}get hasZ(){return!1}get hasM(){return!1}get stride(){return 2+(this.hasZ?1:0)+(this.hasM?1:0)}get hasFeatures(){return this._header.hasFeatures}get hasNext(){return this._hasNext}get exceededTransferLimit(){return this._header.exceededTransferLimit}hasField(e){return this._header.hasField(e)||this._header.hasField(st(e))}getFieldNames(){return this._header.fields.map(e=>e.fieldName)}getSize(){return this._size}getQuantizationTransform(){return this._header.transform}getCursor(){return this.copy()}getIndex(){return this._featureIndex}setIndex(e){this._cache.area=0,this._cache.unquantGeometry=void 0,this._cache.geometry=void 0,this._cache.centroid=void 0,this._cache.legacyFeature=void 0,this._cache.optFeature=void 0,this._featureIndex=e}getAttributeHash(){let e="";return this._header.fields.forEach(({index:t})=>{e+=this._readAttributeAtIndex(t)+"."}),e}getObjectId(){return this._readAttributeAtIndex(this._header.objectIdFieldIndex)}getDisplayId(){return this._header.displayIds[this._featureIndex]}setDisplayId(e){this._header.displayIds[this._featureIndex]=e}getGroupId(){return this._header.groupIds[this._featureIndex]}setGroupId(e){this._header.groupIds[this._featureIndex]=e}readLegacyFeature(){if(void 0===this._cache.legacyFeature){const e=this.readCentroid(),t={attributes:this.readAttributes(),geometry:this._isPoints?this.readLegacyPointGeometry():this.readLegacyGeometry(),centroid:(e&&{x:e.coords[0],y:e.coords[1]})??null};return this._cache.legacyFeature=t,t}return this._cache.legacyFeature}readOptimizedFeature(){if(void 0===this._cache.optFeature){const e=new xe.u_(this.readGeometry(),this.readAttributes(),this.readCentroid());return e.objectId=this.getObjectId(),e.displayId=this.getDisplayId(),this._cache.optFeature=e,e}return this._cache.optFeature}getXHydrated(){const e=this._header.centroid[2*this._featureIndex],t=this.getQuantizationTransform();return(0,c.Wi)(t)?e:e*t.scale[0]+t.translate[0]}getYHydrated(){const e=this._header.centroid[2*this._featureIndex+1],t=this.getQuantizationTransform();return(0,c.Wi)(t)?e:t.translate[1]-e*t.scale[1]}getX(){return this._header.centroid[2*this._featureIndex]*this._sx+this._tx}getY(){return this._header.centroid[2*this._featureIndex+1]*this._sy+this._ty}readLegacyPointGeometry(){return{x:this.getX(),y:this.getY()}}readLegacyGeometry(e){const t=this.readGeometry(e);return(0,P.di)(t,this.geometryType,!1,!1)}readLegacyCentroid(){const e=this.readCentroid();if(!e)return null;const[t,r]=e.coords;return{x:t,y:r}}readGeometryArea(){return this._cache.area||this.readGeometry(!0),this._cache.area}readUnquantizedGeometry(e=!1){if(void 0===this._cache.unquantGeometry){const t=this.readGeometry(e);if(!t)return this._cache.unquantGeometry=void 0,null;const r=tt(t.coords.length).decoded,s=t.clone(r),n=s.coords;let a=0;for(const o of s.lengths){for(let h=1;h<o;h++){const u=2*(a+h),l=2*(a+h-1);n[u]+=n[l],n[u+1]+=n[l+1]}a+=o}return this._cache.unquantGeometry=s,s}return this._cache.unquantGeometry}readHydratedGeometry(){if(this._isPoints){if(this._header.centroid[2*this._featureIndex]===Le)return null;const s=this.getXHydrated(),n=this.getYHydrated();return new N.Z([],[s,n])}const e=this.readGeometry();if(!e)return null;const t=e.clone(),r=this.getQuantizationTransform();return(0,c.pC)(r)&&(0,P.$g)(t,t,this.hasZ,this.hasM,r),t}readGeometry(e=!1){if(void 0===this._cache.geometry){let t=null;if(this._isPoints){if(this._header.centroid[2*this._featureIndex]===Le)return null;const r=this.getX(),s=this.getY();t=new N.Z([],[r,s])}else{const r=this._header.offsets.geometry[this._featureIndex],s=this._reader;if(0===r){const n=this._readServerCentroid();if(!n)return null;const[a,o]=n.coords;return this.createQuantizedExtrudedQuad(a,o)}s.move(r);try{if(t=e?this._parseGeometryForDisplay(s):this._parseGeometry(s),null===t){const n=this._readServerCentroid();if(!n)return null;const[a,o]=n.coords;return this.createQuantizedExtrudedQuad(a,o)}}catch(n){return console.error("Failed to parse geometry!",n),null}}return this._cache.geometry=t,t}return this._cache.geometry}readCentroid(){if(void 0===this._cache.centroid){let e;return e=this._computeCentroid(),e||(e=this._readServerCentroid()),this._cache.centroid=e??void 0,e??null}return this._cache.centroid}copy(){const e=this._reader.clone(),t=new be(this.instance,e,this._header,this.fullSchema());return this.copyInto(t),t}next(){for(this._cache.area=0,this._cache.unquantGeometry=void 0,this._cache.geometry=void 0,this._cache.centroid=void 0,this._cache.legacyFeature=void 0,this._cache.optFeature=void 0;++this._featureIndex<this._size&&!this._getExists(););return this._featureIndex<this._size}_readAttribute(e,t){const r=this._header.hasField(e)?e:st(e),s=this._header.getFieldIndex(r);if(null==s)return;const n=this._readAttributeAtIndex(s);return t&&null!=n&&this._header.isDateField(r)?new Date(n):n}_readAttributes(){const e={};return this._header.fields.forEach(({fieldName:t,index:r})=>{e[t]=this._readAttributeAtIndex(r)}),e}copyInto(e){super.copyInto(e),e._featureIndex=this._featureIndex,e._featureOffset=this._featureOffset,e._hasNext=this._hasNext}_readAttributeAtIndex(e){const r=this._reader;return r.move(this._header.offsets.attributes[this._featureIndex*this._header.fieldCount+e]),function Ot(i){const l=i.getLength(),d=i.pos()+l;for(;i.pos()<d&&i.next();)switch(i.tag()){case 1:return i.getString();case 2:return i.getFloat();case 3:return i.getDouble();case 4:return i.getSInt32();case 5:return i.getUInt32();case 6:return i.getInt64();case 7:return i.getUInt64();case 8:return i.getSInt64();case 9:return i.getBool();default:return i.skip(),null}return null}(r)}_readServerCentroid(){const e=this._header.centroid[2*this._featureIndex]+this._tx;return e===Le?null:new N.Z([],[e,this._header.centroid[2*this._featureIndex+1]+this._ty])}_parseGeometry(e){const s=e.asUnsafe(),n=s.getLength(),a=s.pos()+n,o=[],h=[];for(;s.pos()<a&&s.next();)switch(s.tag()){case 2:{const u=s.getUInt32(),l=s.pos()+u;for(;s.pos()<l;)h.push(s.getUInt32());break}case 3:{const u=s.getUInt32(),l=s.pos()+u;for(o.push(s.getSInt32()+this._tx),o.push(s.getSInt32()+this._ty),this.hasZ&&s.getSInt32(),this.hasM&&s.getSInt32();s.pos()<l;)o.push(s.getSInt32()),o.push(s.getSInt32()),this.hasZ&&s.getSInt32(),this.hasM&&s.getSInt32();break}default:s.skip()}return new N.Z(h,o)}_parseGeometryForDisplay(e){const s=e.asUnsafe(),n=s.getLength(),a=s.pos()+n,o=[],h=[];let u=0,l=0,d=null,g=0;const p="esriGeometryPolygon"===this.geometryType;for(;s.pos()<a&&s.next();)switch(s.tag()){case 2:{const y=s.getUInt32(),m=s.pos()+y;for(;s.pos()<m;){const v=s.getUInt32();o.push(v),u+=v}d=tt(2*u).delta;break}case 3:{s.getUInt32();const y=2+(this.hasZ?1:0)+(this.hasM?1:0);(0,c.O3)(d);for(const m of o)if(l+y*m>d.length)for(let v=0;v<m;v++)s.getSInt32(),s.getSInt32(),this.hasZ&&s.getSInt32(),this.hasM&&s.getSInt32();else if(p){const v=this.getAreaSimplificationThreshold(m,this._header.vertexCount);let I=2,b=1;const x=!1;let S=s.getSInt32(),C=s.getSInt32();d[l++]=S,d[l++]=C,this.hasZ&&s.getSInt32(),this.hasM&&s.getSInt32();let w=s.getSInt32(),F=s.getSInt32();for(this.hasZ&&s.getSInt32(),this.hasM&&s.getSInt32();I<m;){let R=s.getSInt32(),L=s.getSInt32();this.hasZ&&s.getSInt32(),this.hasM&&s.getSInt32();const T=S+w,E=C+F;Dt(S,C,T,E,T+R,E+L)>=v?(g+=-.5*(T-S)*(E+C),b>1&&Pe(d[l-2],d[l-1],w,F)?(d[l-2]+=w,d[l-1]+=F):(d[l++]=w,d[l++]=F,b++),S=T,C=E):(R+=w,L+=F),w=R,F=L,I++}b<3||x?l-=2*b:(g+=-.5*(S+w-S)*(C+F+C),Pe(d[l-2],d[l-1],w,F)?(d[l-2]+=w,d[l-1]+=F,h.push(b)):(d[l++]=w,d[l++]=F,h.push(++b)))}else{let v=0,I=s.getSInt32(),b=s.getSInt32();this.hasZ&&s.getSInt32(),this.hasM&&s.getSInt32(),d[l++]=I,d[l++]=b,v+=1;for(let x=1;x<m;x++){const S=s.getSInt32(),C=s.getSInt32(),w=I+S,F=b+C;g+=-.5*(w-I)*(F+b),this.hasZ&&s.getSInt32(),this.hasM&&s.getSInt32(),x>2&&Pe(d[l-2],d[l-1],S,C)?(d[l-2]+=S,d[l-1]+=C):(d[l++]=S,d[l++]=C,v+=1),I=w,b=F}h.push(v)}break}default:s.skip()}if(this._cache.area=g,!h.length)return null;if(this._tx||this._ty){let y=0;(0,c.O3)(d);for(const m of h)d[2*y]+=this._tx,d[2*y+1]+=this._ty,y+=m}return new N.Z(h,d)}}class Ce{constructor(e){this.service=e}destroy(){}}function Oe(){return(Oe=(0,_.Z)(function*(i){const e=new Mt.Z;return yield e.open(i,{}),e})).apply(this,arguments)}class qt extends Ce{constructor(e){super(e),this._portsOpen=function Bt(i){return Oe.apply(this,arguments)}(e.source).then(t=>this.client=t)}destroy(){this.client.close(),this.client=null}executeQuery(e,t){var r=this;return(0,_.Z)(function*(){yield r._portsOpen;const s=yield r.client.invoke("queryFeatures",e.toJSON(),t);return q.i.fromFeatureSet(s,r.service)})()}}class Nt extends Ce{executeQuery(e,t){var r=this;return(0,_.Z)(function*(){const{data:s}=yield(0,Ze.n7)(r.service.source,e,t);return be.fromBuffer(s,r.service,!e.quantizationParameters)})()}}class jt extends Ce{executeQuery(e,t){var r=this;return(0,_.Z)(function*(){const{source:s,capabilities:n,spatialReference:a,objectIdField:o,geometryType:h}=r.service;if((0,c.pC)(e.quantizationParameters)&&!n.query.supportsQuantization){const l=e.clone(),d=(0,Ye.vY)((0,c.Wg)(l.quantizationParameters));l.quantizationParameters=null;const{data:g}=yield(0,Ze.JT)(s,l,a,t),p=(0,P.h_)(g,o);return(0,P.RZ)(d,p),q.i.fromOptimizedFeatureSet(p,r.service)}const{data:u}=yield(0,Ze.JT)(s,e,r.service.spatialReference,t);return"esriGeometryPoint"===h&&(u.features=u.features?.filter(l=>{if((0,c.pC)(l.geometry)){const d=l.geometry;return Number.isFinite(d.x)&&Number.isFinite(d.y)}return!0})),q.i.fromFeatureSet(u,r.service)})()}}class zt extends Ce{executeQuery(e,t){var r=this;return(0,_.Z)(function*(){const{capabilities:s}=r.service;if(e.quantizationParameters&&!s.query.supportsQuantization){const a=e.clone(),o=(0,Ye.vY)((0,c.Wg)(a.quantizationParameters));a.quantizationParameters=null;const h=yield(0,He.WW)(r.service.source,e,t);return(0,P.RZ)(o,h),q.i.fromOptimizedFeatureSet(h,r.service)}const n=yield(0,He.WW)(r.service.source,e,t);return q.i.fromOptimizedFeatureSet(n,r.service)})()}}var Vt=f(97478),De=f(61885),te=f(84682),Wt=f(96854),rt=f(65389);class D{constructor(){this.version=0,this.source=!1,this.targets={feature:!1,aggregate:!1},this.storage={filters:!1,data:!1},this.mesh=!1,this.queryFilter=!1,this.why={mesh:[],source:[]}}static create(e){const t=new D;for(const r in e){const s=e[r];if("object"==typeof s)for(const n in s)t[r][n]=s[n];t[r]=s}return t}static empty(){return D.create({})}static all(){return D.create({source:!0,targets:{feature:!0,aggregate:!0},storage:{filters:!0,data:!0},mesh:!0})}unset(e){this.version=e.version,e.source&&(this.source=!1),e.targets.feature&&(this.targets.feature=!1),e.targets.aggregate&&(this.targets.aggregate=!1),e.storage.filters&&(this.storage.filters=!1),e.storage.data&&(this.storage.data=!1),e.mesh&&(this.mesh=!1),e.queryFilter&&(this.queryFilter=!1)}any(){return this.source||this.mesh||this.storage.filters||this.storage.data||this.targets.feature||this.targets.aggregate||this.queryFilter}describe(){let e=0,t="";if(this.mesh){e+=20,t+="-> (20) Mesh needs update\n";for(const s of this.why.mesh)t+=`    + ${s}\n`}if(this.source){e+=10,t+="-> (10) The source needs update\n";for(const s of this.why.source)t+=`    + ${s}\n`}this.targets.feature&&(e+=5,t+="-> (5) Feature target parameters changed\n"),this.storage.filters&&(e+=5,t+="-> (5) Feature filter parameters changed\n"),this.targets.aggregate&&(e+=4,t+="-> (4) Aggregate target parameters changed\n"),this.storage.data&&(e+=1,t+="-> (1) Texture storage parameters changed"),console.debug(`Applying ${e<5?"Fastest":e<10?"Fast":e<15?"Moderate":e<20?"Slow":"Very Slow"} update of cost ${e}/45 `),console.debug(t)}toJSON(){return{queryFilter:this.queryFilter,source:this.source,targets:this.targets,storage:this.storage,mesh:this.mesh}}}class Xt{constructor(e,t){this.requests={done:new Array,stream:new rt.Z(10)},this._edits=null,this._abortController=new AbortController,this._version=0,this._done=!1,this.didSend=!1,this.tile=e,this._version=t}get signal(){return this._abortController.signal}get options(){return{signal:this._abortController.signal}}get empty(){return!this.requests.done.length&&(0,c.Wi)(this.edits)}get edits(){return this._edits}get done(){return this._done}end(){this._done=!0}clear(){this.requests.done=[]}applyUpdate(e){this.requests.done.forEach(t=>t.message.status.unset(e)),this._version=e.version,(0,c.pC)(this._edits)&&this._edits.status.unset(e)}add(e){e.message.status=e.message.status??D.empty(),e.message.status.version=this._version,(0,Z.Z)("esri-2d-update-debug")&&console.debug(this.tile.id,"DataTileSubscription:add",this._version),e.message.end&&this.requests.done.forEach(t=>{(0,c.pC)(t.message)&&t.message.end&&(t.message.end=!1)}),this.requests.done.push(e)}edit(e,t){const r=e.getQuantizationTransform(),s=e.fullSchema(),n=Array.from(e.features()).filter(c.pC),a=[...t,...n.map(o=>o.objectId)];this.removeIds(a),this._invalidate(),(0,c.Wi)(this._edits)?this._edits={type:"append",addOrUpdate:q.i.fromOptimizedFeatures(n,s,(0,c.Wg)(r)),id:this.tile.id,status:D.empty(),end:!0}:(this.requests.done.forEach(o=>o.message.end=!1),(0,c.Wg)(this._edits.addOrUpdate).append(e.features()))}*readers(){for(const{message:e}of this.requests.done)(0,c.pC)(e.addOrUpdate)&&(yield e.addOrUpdate);(0,c.pC)(this._edits)&&(0,c.pC)(this._edits.addOrUpdate)&&(yield this._edits.addOrUpdate)}_invalidate(){for(const e of this.requests.done)e.message.status=D.empty();(0,c.pC)(this._edits)&&(this._edits.status=D.empty())}removeIds(e){this._invalidate();for(const{message:t}of this.requests.done){const r=t.addOrUpdate;(0,c.pC)(r)&&(r.removeIds(e),r.isEmpty&&((0,Z.Z)("esri-2d-update-debug")&&console.debug("Removing FeatureSetReader"),t.addOrUpdate=null))}(0,c.pC)(this._edits)&&(0,c.pC)(this._edits.addOrUpdate)&&this._edits.addOrUpdate.removeIds(e),this.requests.done=this.requests.done.filter(t=>t.message.addOrUpdate||t.message.end)}abort(){this._abortController.abort()}}class it extends We.Z{constructor(e){super(),this.events=new De.Z,this._resolver=(0,A.hh)(),this._didEdit=!1,this._subscriptions=new Map,this._outSR=e.outSR,this._serviceInfo=e.serviceInfo,this._onTileUpdateMessage=e.onMessage}_onMessage(e){var t=this;return(0,_.Z)(function*(){const r=t._subscriptions.get(e.id);if(!r)return;const s={...e,remove:e.remove??[],status:e.status??D.empty()};return(0,A.R8)(t._onTileUpdateMessage(s,r.options))})()}update(e,t){const r=t.fields.length;t.outFields=function Yt(i,e){const t=new Set;return i&&i.forEach(r=>t.add(r)),e&&e.forEach(r=>t.add(r)),t.has("*")?["*"]:Array.from(t)}(this._schema?.outFields,t.outFields),t.outFields=t.outFields.length>=.75*r?["*"]:t.outFields,t.outFields.sort();const s=(0,te.Hg)(this._schema,t);if(!s)return;(0,Z.Z)("esri-2d-update-debug")&&console.debug("Applying Update - Source:",s);const a={returnCentroid:"esriGeometryPolygon"===this._serviceInfo.geometryType,returnGeometry:!0,timeReferenceUnknownClient:"stream"!==this._serviceInfo.type&&this._serviceInfo.timeReferenceUnknownClient,outFields:t.outFields,outSpatialReference:this._outSR,orderByFields:["orderByFields"in this._serviceInfo&&this._serviceInfo.orderByFields?this._serviceInfo.orderByFields:this._serviceInfo.objectIdField+" ASC"],where:t.definitionExpression||"1=1",gdbVersion:t.gdbVersion,historicMoment:t.historicMoment,timeExtent:t.timeExtent?Vt.Z.fromJSON(t.timeExtent):null},o=this._schema&&(0,te.uD)(s,"outFields");this._schema&&(0,te.V7)(s,["timeExtent","definitionExpression","gdbVersion","historicMoment","customParameters"])&&(e.why.mesh.push("Layer filter and/or custom parameters changed"),e.why.source.push("Layer filter and/or custom parameters changed"),e.mesh=!0,e.source=!0,e.queryFilter=!0),o&&(e.why.source.push("Layer required fields changed"),e.source=!0),(0,te.Hg)(a,this._queryInfo)&&(this._queryInfo=a),this._schema=t,this._resolver.resolve()}whenInitialized(){return this._resolver.promise}applyUpdate(e){var t=this;return(0,_.Z)(function*(){if(e.queryFilter||e.source&&t._didEdit)return t.refresh(e.version),void(t._didEdit=!1);t._subscriptions.forEach(r=>r.applyUpdate(e)),yield t.resend()})()}refresh(e,t){for(const r of this._tiles())this.unsubscribe(r),this.subscribe(r,e)}subscribe(e,t){const r=new Xt(e,t);this._subscriptions.set(e.id,r)}unsubscribe(e){const t=this.getSubscription(e.id);(0,c.pC)(t)&&t.abort(),this._subscriptions.delete(e.id)}createQuery(e={}){const t=this._queryInfo.historicMoment?new Date(this._queryInfo.historicMoment):null;return new Wt.Z({...this._queryInfo,historicMoment:t,...e})}getSubscription(e){return this._subscriptions.has(e)?this._subscriptions.get(e):null}queryLastEditDate(){return(0,_.Z)(function*(){throw new Error("Service does not support query type")})()}query(e,t){return(0,_.Z)(function*(){throw new Error("Service does not support query")})()}*_tiles(){const e=Array.from(this._subscriptions.values());for(const t of e)yield t.tile}edit(e,t){var r=this;return(0,_.Z)(function*(){const s=Array.from(r._subscriptions.values()),n=s.map(({tile:a})=>a);for(const a of s)a.removeIds(t);if(e.length){const a=n.map(h=>{const u=r.createTileQuery(h);return u.objectIds=e,{tile:h,query:u}}).map(function(){var h=(0,_.Z)(function*({tile:u,query:l}){return{tile:u,result:yield r.query(l,{query:{tile:(0,Z.Z)("esri-tiles-debug")?u.id.replace(/\//g,"."):void 0}}),query:l}});return function(u){return h.apply(this,arguments)}}()),o=(yield(0,A.WW)(a)).map(function(){var h=(0,_.Z)(function*({tile:u,result:l}){if(!l.hasFeatures&&!t.length&&!e.length)return;const d=r._subscriptions.get(u.key.id);d&&d.edit(l,e)});return function(u){return h.apply(this,arguments)}}());yield(0,A.as)(o)}r._didEdit=!0})()}}var ke=f(71251);class Ge extends it{constructor(e){var t,r;super(e),t=this,this.type="feature",this.mode="on-demand",this._adapter=function Qt(i){const{capabilities:e}=i;return function Gt(i){return"ogc-source"===i?.type}(i.source)?new zt(i):function kt(i){return Array.isArray(i.source)}(i)?new qt(i):e.query.supportsFormatPBF&&(0,Z.Z)("featurelayer-pbf")?new Nt(i):new jt(i)}(e.serviceInfo),this._queue=new ke.e({concurrency:8,process:(r=(0,_.Z)(function*(s){if((0,A.k_)(s),(0,c.pC)(s.tile)){const n=s.tile.key.id,{signal:a}=s,o=(0,Z.Z)("esri-tiles-debug")?{tile:n.replace(/\//g,"."),depth:s.depth}:void 0,h=yield t._adapter.executeQuery(s.query,{signal:a,query:{...o,...t._schema?.customParameters}});return h.level=s.tile.key.level,h}return t._adapter.executeQuery(s.query,{...s,query:t._schema?.customParameters})}),function(n){return r.apply(this,arguments)})}),this._patchQueue=new ke.e({concurrency:8,process:function(){var r=(0,_.Z)(function*(s){if((0,A.k_)(s),(0,c.pC)(s.tile)){const n=s.tile.key.id,{signal:a}=s,o=(0,Z.Z)("esri-tiles-debug")?{tile:n.replace(/\//g,"."),depth:s.depth}:void 0,h=yield t._adapter.executeQuery(s.query,{signal:a,query:{...o,...t._schema?.customParameters}});return h.level=s.tile.key.level,h}return t._adapter.executeQuery(s.query,{...s,query:t._schema?.customParameters})});return function(n){return r.apply(this,arguments)}}()})}destroy(){super.destroy(),this._adapter.destroy(),this._queue.destroy(),this._patchQueue.destroy()}get updating(){return!!this._queue.length||Array.from(this._subscriptions.values()).some(e=>!e.done)}get maxRecordCountFactor(){const{query:e}=this._serviceInfo.capabilities;return e.supportsMaxRecordCountFactor?4:null}get maxPageSize(){const{query:e}=this._serviceInfo.capabilities;return(e.maxRecordCount??8e3)*(0,c.Pt)(this.maxRecordCountFactor,1)}get pageSize(){return Math.min(8e3,this.maxPageSize)}enableEvent(e,t){}subscribe(e,t){super.subscribe(e,t);const r=this._subscriptions.get(e.id);this._fetchDataTile(e).catch(s=>{(0,A.D_)(s)||ve.Z.getLogger("esri.views.2d.layers.features.sources.BaseFeatureSource").error(new Se.Z("mapview-query-error","Encountered error when fetching tile",{tile:e,error:s}))}).then(()=>r.end())}unsubscribe(e){super.unsubscribe(e)}readers(e){return this._subscriptions.get(e).readers()}query(e,t={}){var r=this;return(0,_.Z)(function*(){const s=t.query??{};return r._adapter.executeQuery(e,{...t,query:{...s,...r._schema?.customParameters}})})()}queryLastEditDate(){var e=this;return(0,_.Z)(function*(){const t=e._serviceInfo.source,r={...t.query,f:"json"};return(yield(0,Tt.default)(t.path,{query:r,responseType:"json"})).data.editingInfo.lastEditDate})()}createTileQuery(e,t={}){const r=this._serviceInfo.geometryType,s=this.createQuery(t);s.quantizationParameters=t.quantizationParameters??e.getQuantizationParameters(),s.resultType="tile",s.geometry=e.extent,this._serviceInfo.capabilities.query.supportsQuantization?"esriGeometryPolyline"===r&&(s.maxAllowableOffset=e.resolution*(0,Z.Z)("feature-polyline-generalization-factor")):"esriGeometryPolyline"!==r&&"esriGeometryPolygon"!==r||(s.maxAllowableOffset=e.resolution,"esriGeometryPolyline"===r&&(s.maxAllowableOffset*=(0,Z.Z)("feature-polyline-generalization-factor")));const n=this._serviceInfo.capabilities.query;return s.defaultSpatialReferenceEnabled=n.supportsDefaultSpatialReference,s.compactGeometryEnabled=n.supportsCompactGeometry,s}_executePatchQuery(e,t,r,s){var n=this;return(0,_.Z)(function*(){const a=t.clone();a.outFields=[n._serviceInfo.objectIdField,...r],a.returnCentroid=!1,a.returnGeometry=!1;const o=(0,c.pC)(a.start)?a.start/8e3:0;return n._patchQueue.push({tile:e,query:a,signal:s.signal,depth:o})})()}_resend(e,t){var r=this;return(0,_.Z)(function*(){const{query:s,message:n}=e,a=(0,c.pC)(s.outFields)?s.outFields:[],o=r._queryInfo.outFields,h=o.filter(u=>!a.includes(u));if((0,c.Wi)(n.addOrUpdate))r._onMessage({...n,type:"append"});else if(h.length)try{const u=r._subscriptions.get(n.id).tile,l=yield r._executePatchQuery(u,s,h,t);(0,A.k_)(t),s.outFields=o,n.addOrUpdate.joinAttributes(l),r._onMessage({...n,end:n.end,type:"append"})}catch{}else r._onMessage({...n,type:"append"})})()}_resendSubscription(e){var t=this;return(0,_.Z)(function*(){if((0,Z.Z)("esri-2d-update-debug")&&console.debug(e.tile.id,"Resend Subscription"),e.empty)return t._onMessage({id:e.tile.id,addOrUpdate:null,end:!1,type:"append"});const r=e.signal;for(const s of e.requests.done)yield t._resend(s,{signal:r});return(0,c.pC)(e.edits)?t._onMessage(e.edits):void 0})()}resend(){var e=this;return(0,_.Z)(function*(){const t=Array.from(e._subscriptions.values());yield Promise.all(t.map(r=>e._resendSubscription(r)))})()}}const nt=(0,Z.Z)("esri-mobile"),at={maxDrillLevel:nt?1:4,maxRecordCountFactor:nt?1:3};class $t extends Ge{constructor(e){super(e)}_fetchDataTile(e){var t=this;return(0,_.Z)(function*(){const r=t._serviceInfo.capabilities.query.supportsMaxRecordCountFactor,s=t._subscriptions.get(e.key.id),n=s.signal,a=e.getQuantizationParameters();let o=0;const h=function(){var u=(0,_.Z)(function*(l,d){const g=t._queryInfo,p=t.createTileQuery(l,{maxRecordCountFactor:r?at.maxRecordCountFactor:void 0,returnExceededLimitFeatures:!1,quantizationParameters:a});o++;try{const y=yield t._queue.push({tile:e,query:p,signal:n,depth:d});if(o--,(0,A.k_)(n),!y)return;if(g!==t._queryInfo)return void h(l,d);if(y.exceededTransferLimit&&d<at.maxDrillLevel){for(const v of l.createChildTiles())h(v,d+1);return}const m={id:e.id,addOrUpdate:y,end:0===o,type:"append"};s.add({query:p,message:m}),t._onMessage(m)}catch(y){(0,A.D_)(y)||t._onMessage({id:e.id,addOrUpdate:null,end:!0,type:"append"})}});return function(d,g){return u.apply(this,arguments)}}();h(e,0)})()}}class Jt extends Ge{constructor(e){super(e)}_fetchDataTile(e){var t=this;return(0,_.Z)(function*(){const n=t._subscriptions.get(e.key.id);let a=!1,o=0,h=0;const u=(g,p)=>{h--,(0,A.k_)(n);const y=e.id,m=g.reader,v=g.query;if(!m.exceededTransferLimit){if(a=!0,0!==p&&!m.hasFeatures){const x={id:y,addOrUpdate:m,end:0===h,type:"append"};return n.add({message:x,query:v}),void t._onMessage(x)}const b={id:y,addOrUpdate:m,end:0===h,type:"append"};return n.add({message:b,query:v}),void t._onMessage(b)}const I={id:y,addOrUpdate:m,end:a&&0===h,type:"append"};n.add({message:I,query:v}),t._onMessage(I)};let l=0,d=0;for(;!a&&d++<20;){let g;for(let p=0;p<l+1;p++){const y=o++;h++,g=t._fetchDataTilePage(e,y,n).then(m=>m&&u(m,y)).catch(m=>{a=!0,(0,A.D_)(m)||(ve.Z.getLogger("esri.views.2d.layers.features.sources.PagedFeatureSource").error(new Se.Z("mapview-query-error","Encountered error when fetching tile",{tile:e,error:m})),t._onMessage({id:e.id,addOrUpdate:null,end:a,type:"append"}))})}yield g,(0,A.k_)(n),l=Math.min(l+2,6)}})()}_fetchDataTilePage(e,t,r){var s=this;return(0,_.Z)(function*(){(0,A.k_)(r);const n=s._queryInfo,a={start:s.pageSize*t,num:s.pageSize,returnExceededLimitFeatures:!0,quantizationParameters:e.getQuantizationParameters()};(0,c.pC)(s.maxRecordCountFactor)&&(a.maxRecordCountFactor=s.maxRecordCountFactor);const o=s.createTileQuery(e,a);try{const h=r.signal,u=yield s._queue.push({tile:e,query:o,signal:h,depth:t});return(0,A.k_)(r),u?n!==s._queryInfo?s._fetchDataTilePage(e,t,r):{reader:u,query:o}:null}catch(h){return(0,A.H9)(h),null}})()}}var Kt=f(4619),es=f(52397);function ts(i,e,t){const r=i.getXHydrated(),s=i.getYHydrated(),n=e.getColumnForX(r),a=Math.floor(e.normalizeCol(n));return`${t}/${Math.floor(e.getRowForY(s))}/${a}`}function Qe(i,e){if((0,c.Wi)(i))return null;const t=e.transform,r=i.getQuantizationTransform();if((0,c.Wi)(r)){const[v,I]=t.scale,[b,x]=t.translate;return i.transform(-b/v,x/I,1/v,1/-I)}const[s,n]=r.scale,[a,o]=r.translate,[h,u]=t.scale,[l,d]=t.translate;return i.transform((a-l)/h,(-o+d)/u,s/h,n/u)}class ss extends Ge{constructor(e){super(e),this.mode="snapshot",this._loading=!0,this._controller=new AbortController,this._downloadPromise=null,this._didSendEnd=!1,this._queries=new Array,this._invalidated=!1,this._hasAggregates=!1,this._random=new Kt.Z(1e3),this._store=e.store,this._markedIdsBufId=this._store.storage.createBitset()}destroy(){super.destroy(),this._controller.abort()}get loading(){return this._loading}get _signal(){return this._controller.signal}update(e,t){super.update(e,t),null==this._featureCount&&(this._featureCount=t.initialFeatureCount),(0,c.pC)(t.changedFeatureCount)&&(this._featureCount=t.changedFeatureCount),this._hasAggregates=!!e.targets?.aggregate}resend(e=!1){var t=this;return(0,_.Z)(function*(){if(yield t._downloadPromise,t._invalidated||e){const s=(0,c.s3)(t._featureCount,"Expected featureCount to be defined");return t._invalidated=!1,t._subscriptions.forEach(n=>n.clear()),t._downloadPromise=t._download(s),void(yield t._downloadPromise)}const r=t._queries.map(({query:s,reader:n})=>t._sendPatchQuery(s,n));yield Promise.all(r),t._subscriptions.forEach(s=>{s.requests.done.forEach(n=>t._onMessage(n.message))})})()}refresh(e,t){var r=this;return(0,_.Z)(function*(){t&&(r._featureCount=t.featureCount),yield r.resend(!0)})()}_sendPatchQuery(e,t){var r=this;return(0,_.Z)(function*(){const s=(0,c.pC)(e.outFields)?e.outFields:[],n=r._queryInfo.outFields,a=n.filter(l=>!s.includes(l));if(!a.length)return;const o=e.clone(),h=r._signal;o.returnGeometry=!1,o.returnCentroid=!1,o.outFields=a,e.outFields=n;const u=yield r._queue.push({query:o,depth:0,signal:h});(0,A.k_)({signal:h}),t.joinAttributes(u)})()}_fetchDataTile(e){var t=this;return(0,_.Z)(function*(){if(!t._downloadPromise){const u=(0,c.s3)(t._featureCount,"Expected featureCount to be defined");t._downloadPromise=t._download(u)}const r=t._store.search(e),s=t._subscriptions.get(e.key.id),n=r.length-1;for(let u=0;u<n;u++){const l=Qe(r[u],e),d={type:"append",id:e.id,addOrUpdate:l,end:!1,status:D.empty()};s.add({query:null,message:d}),t._hasAggregates||(yield(0,A.e4)(1)),t._onMessage(d)}const a=Qe(n>=0?r[n]:null,e),h={type:"append",id:e.id,addOrUpdate:a,end:t._didSendEnd,status:D.empty()};s.add({query:null,message:h}),t._onMessage(h)})()}_download(e){var t=this;return(0,_.Z)(function*(){try{yield t.whenInitialized();const r=t._store.storage.getBitset(t._markedIdsBufId),s=new Set;r.clear();const n=Math.ceil(e/t.pageSize),a=Array.from({length:n},(o,h)=>h).sort((o,h)=>t._random.getInt()-t._random.getInt()).map(o=>t._downloadPage(o,r,s));yield Promise.all(a),t._store.sweepFeatures(r,t._store.storage),t._store.sweepFeatureSets(s)}catch(r){ve.Z.getLogger("esri.views.2d.layers.features.sources.SnapshotFeatureSource").error("mapview-snapshot-source","Encountered and error when downloading feature snapshot",r)}t._sendEnd(),t._loading=!1})()}_downloadPage(e,t,r){var s=this;return(0,_.Z)(function*(){const n=s.pageSize,a={start:e*n,num:n,cacheHint:!0};(0,c.pC)(s.maxRecordCountFactor)&&(a.maxRecordCountFactor=s.maxRecordCountFactor);const o=s.createQuery(a),h=s._signal,u=yield s._queue.push({query:o,depth:e,signal:h});(0,A.k_)({signal:h}),s._queries.push({query:o,reader:u}),s._store.insert(u),r.add(u.instance);const l=u.getCursor();for(;l.next();)t.set(l.getDisplayId());s._send(u)})()}_send(e){if(!this._subscriptions.size)return;let t=null;const r=new Map,s=new Set,n=new Map;this._subscriptions.forEach(a=>{const o=a.tile;r.set(o.key.id,null),t=o.tileInfoView,s.add(o.level);const{row:h,col:u}=o.key,l=`${o.level}/${h}/${u}`,d=n.get(l)??[];d.push(a),n.set(l,d)});for(const a of s){const o=t.getLODInfoAt(a),h=e.getCursor();for(;h.next();){const u=ts(h,o,a),l=h.getIndex();if(n.has(u))for(const d of n.get(u)){const g=d.tile.id;let p=r.get(g);(0,c.Wi)(p)&&(p=[],r.set(g,p)),p.push(l)}}}r.forEach((a,o)=>{if((0,c.pC)(a)){const h=this._subscriptions.get(o),u={type:"append",id:o,addOrUpdate:Qe(es.t.from(e,a),h.tile),end:!1,status:D.empty()};h.add({query:null,message:u}),this._onMessage(u)}})}_sendEnd(){this._subscriptions.forEach(e=>{const t={type:"append",id:e.tile.id,addOrUpdate:null,end:!0,status:D.empty()};e.add({query:null,message:t}),this._onMessage(t)}),this._didSendEnd=!0}}var rs=f(76279),is=f(5075),ns=f(20901);function os(i,e){const t=i.weakClone();if((0,c.pC)(i.geometry)){const r=(0,P.Jd)(e,i.geometry.coords[0]),s=(0,P.IN)(e,i.geometry.coords[1]);t.geometry=new N.Z([],[r,s])}return t}class cs{constructor(e,t){this.onUpdate=e,this._geometryType=t,this._objectIdToFeature=new Map,this._index=null}get _features(){const e=[];return this._objectIdToFeature.forEach(t=>e.push(t)),e}add(e){this._objectIdToFeature.set(e.objectId,e),this._index=null}get(e){return this._objectIdToFeature.has(e)?this._objectIdToFeature.get(e):null}forEach(e){this._objectIdToFeature.forEach(e)}search(e){return this._index||(this._index=function ds(i,e){const t=(0,rs.r)(9,function hs(i){return"esriGeometryPoint"===i?e=>(0,c.pC)(e.geometry)?{minX:e.geometry.coords[0],minY:e.geometry.coords[1],maxX:e.geometry.coords[0],maxY:e.geometry.coords[1]}:{minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}:e=>{let t=1/0,r=1/0,s=-1/0,n=-1/0;return(0,c.pC)(e.geometry)&&e.geometry.forEachVertex((a,o)=>{t=Math.min(t,a),r=Math.min(r,o),s=Math.max(s,a),n=Math.max(n,o)}),{minX:t,minY:r,maxX:s,maxY:n}}}(e));return t.load(i),t}(this._features,this._geometryType)),function ls(i,e){return i.search({minX:e.bounds[0],minY:e.bounds[1],maxX:e.bounds[2],maxY:e.bounds[3]})}(this._index,e)}clear(){this._index=null,this._objectIdToFeature.clear()}removeById(e){const t=this._objectIdToFeature.get(e);return t?(this._objectIdToFeature.delete(e),this._index=null,t):null}update(e,t){this.onUpdate(e,t)}get size(){return this._objectIdToFeature.size}}let fe=class extends it{constructor(i){super(i),this.type="stream",this._updateIntervalId=0,this._level=0,this._updateInfo={websocket:0,client:0},this._isPaused=!1,this._inUpdate=!1;const{outSR:e}=i,{geometryType:t,objectIdField:r,timeInfo:s,purgeOptions:n,source:a,spatialReference:o,serviceFilter:h,maxReconnectionAttempts:u,maxReconnectionInterval:l,updateInterval:d,customParameters:g,enabledEventTypes:p}=i.serviceInfo,y=new cs(this._onUpdate.bind(this),t),m=new is.Qo(y,r,s,n),v=(0,ns.createConnection)(a,o,e,t,h,u,l,g??{});this._store=y,this._manager=m,this._connection=v,this._quantize=function us(i){return"esriGeometryPoint"===i?os:(e,t)=>{const r=e.weakClone(),s=new N.Z,o=(0,P.Nh)(s,e.geometry,!1,!1,i,t,!1,!1);return r.geometry=o,r}}(t),this._enabledEventTypes=new Set(p),this._handles=[this._connection.on("data-received",I=>this._onFeature(I)),this._connection.on("message-received",I=>this._onWebSocketMessage(I))],this._initUpdateInterval=()=>{let I=performance.now();this._updateIntervalId=setInterval(()=>{const b=performance.now(),x=b-I;if(x>2500){I=b;const S=Math.round(this._updateInfo.client/(x/1e3)),C=Math.round(this._updateInfo.websocket/(x/1e3));this._updateInfo.client=0,this._updateInfo.websocket=0,this.events.emit("updateRate",{client:S,websocket:C})}i.canAcceptRequest()&&!this._inUpdate&&this._manager.checkForUpdates()},d)},this._initUpdateInterval()}destroy(){super.destroy(),this._clearUpdateInterval(),this._handles.forEach(i=>i.remove()),this._connection.destroy()}_fetchDataTile(){}get connectionStatus(){return this._isPaused?"paused":this._connection?.connectionStatus}get errorString(){return this._connection?.errorString}updateCustomParameters(i){this._connection.updateCustomParameters(i)}pauseStream(){this._isPaused||(this._isPaused=!0,this._clearUpdateInterval())}resumeStream(){this._isPaused&&(this._isPaused=!1,this._initUpdateInterval())}sendMessageToSocket(i){this._connection.sendMessageToSocket(i)}sendMessageToClient(i){this._connection.sendMessageToClient(i)}enableEvent(i,e){e?this._enabledEventTypes.add(i):this._enabledEventTypes.delete(i)}get updating(){return!1}subscribe(i,e){super.subscribe(i,e);const t=this._subscriptions.get(i.id);this._level=i.level;const r=this._getTileFeatures(i);this._onMessage({type:"append",id:i.key.id,addOrUpdate:r,end:!0}),t.didSend=!0}unsubscribe(i){super.unsubscribe(i)}*readers(i){const e=this._subscriptions.get(i),{tile:t}=e;yield this._getTileFeatures(t)}createTileQuery(i){throw new Error("Service does not support tile  queries")}resend(){var i=this;return(0,_.Z)(function*(){i._subscriptions.forEach(e=>{const{tile:t}=e,r={type:"append",id:t.id,addOrUpdate:i._getTileFeatures(t),end:!0};i._onMessage(r)})})()}_getTileFeatures(i){const e=this._store.search(i).map(t=>this._quantize(t,i.transform));return q.i.fromOptimizedFeatures(e,this._serviceInfo,i.transform)}_onWebSocketMessage(i){if(this._enabledEventTypes.has("message-received")&&this.events.emit("message-received",i),"type"in i)switch(i.type){case"delete":if(i.objectIds)for(const e of i.objectIds)this._manager.removeById(e);if(i.trackIds)for(const e of i.trackIds)this._manager.removeByTrackId(e);break;case"clear":this._store.forEach(e=>this._manager.removeById(e.objectId))}}_onFeature(i){this._updateInfo.websocket++;try{this._enabledEventTypes.has("data-received")&&this.events.emit("data-received",i);const e=(0,P.XA)(i,this._serviceInfo.geometryType,!1,!1,this._serviceInfo.objectIdField);this._manager.add(e)}catch{}}_clearUpdateInterval(){clearInterval(this._updateIntervalId),this._updateIntervalId=0}_onUpdate(i,e){var t=this;return(0,_.Z)(function*(){t._inUpdate=!0;try{(0,c.pC)(i)&&(t._updateInfo.client+=i.length),t._subscriptions.forEach((s,n)=>{s.didSend&&s.tile.level===t._level&&t._onMessage({type:"append",id:n,addOrUpdate:null,clear:!0,end:!1})});const r=[];t._subscriptions.forEach((s,n)=>{if(!s.didSend||s.tile.level!==t._level)return;const o={type:"append",id:n,addOrUpdate:t._getTileFeatures(s.tile),remove:[],end:!1,status:D.empty()};s.requests.stream.enqueue(o),r.push(t._onMessage(o))}),yield Promise.all(r),t._subscriptions.forEach((s,n)=>{s.didSend&&s.tile.level===t._level&&t._onMessage({type:"append",id:n,addOrUpdate:null,end:!0})})}catch{}t._inUpdate=!1})()}};(0,O._)([(0,M.Cb)()],fe.prototype,"_isPaused",void 0),(0,O._)([(0,M.Cb)()],fe.prototype,"connectionStatus",null),(0,O._)([(0,M.Cb)()],fe.prototype,"errorString",null),fe=(0,O._)([(0,Ee.j)("esri.views.2d.layers.features.sources")],fe);var fs=f(36682);function Me(i,e,t,r){r%2&&(r+=1);let s=0,n=0,a=-90,o=90,h=-180,u=180;for(let l=0;l<r/2;l++){for(let d=0;d<5;d++){const g=(h+u)/2,p=t>g?1:0;s|=p<<29-(d+5*l),h=(1-p)*h+p*g,u=(1-p)*g+p*u}for(let d=0;d<5;d++){const g=(a+o)/2,p=e>g?1:0;n|=p<<29-(d+5*l),a=(1-p)*a+p*g,o=(1-p)*g+p*o}}i.geohashX=s,i.geohashY=n}function we(i,e,t,r,s){s%2&&(s+=1);let n=0,a=0,o=-90,h=90,u=-180,l=180;for(let d=0;d<s/2;d++){for(let g=0;g<5;g++){const p=(u+l)/2,y=r>p?1:0;n|=y<<29-(g+5*d),u=(1-y)*u+y*p,l=(1-y)*p+y*l}for(let g=0;g<5;g++){const p=(o+h)/2,y=t>p?1:0;a|=y<<29-(g+5*d),o=(1-y)*o+y*p,h=(1-y)*p+y*h}}i[2*e]=n,i[2*e+1]=a}f(29132),new Float64Array(2),new Float64Array(2);var ae=f(65234),oe=f(82959);class dt{constructor(e=[],t,r=8096){this.onRelease=s=>{},this._nodes=0,this._root=new qe(this,0,0,0),this._statisticFields=e,this._pool=r?new rt.Z(8096):null,this._serviceInfo=t}destroy(){this.clear()}_acquire(e,t,r){this._nodes++;let s=null;return(0,c.pC)(this._pool)&&(s=this._pool.dequeue()),(0,c.pC)(s)?s.realloc(e,t,r):s=new qe(this,e,t,r),s}_release(e){this.onRelease(e),this._nodes--,(0,c.pC)(this._pool)&&this._pool.enqueue(e)}get count(){return this._root.count}get size(){return this._nodes}get poolSize(){return(0,c.R2)(this._pool,0,e=>e.size)}get depth(){let e=0;return this.forEach(t=>e=Math.max(e,t.depth)),e}dropLevels(e){this.forEach(t=>{if(t.depth>=e)for(let r=0;r<t.children.length;r++){const s=t.children[r];s&&this._release(s)}}),this.forEach(t=>{if(t.depth>=e)for(let r=0;r<t.children.length;r++)t.children[r]=null})}clear(){this.forEach(e=>this._release(e)),this._root=new qe(this,0,0,0)}insert(e,t,r=0){const s=q.i.fromOptimizedFeatures([e],this._serviceInfo).getCursor();s.next();const n=s.readGeometry();if(!n)return;const[a,o]=n.coords;this.insertCursor(s,e.displayId,a,o,e.geohashX,e.geohashY,t,r)}insertCursor(e,t,r,s,n,a,o,h=0){let u=this._root,l=0,d=0,g=0;for(;null!==u;){if(u.depth>=h&&(u.count+=1,u.xTotal+=r,u.yTotal+=s,u.xGeohashTotal+=n,u.yGeohashTotal+=a,u.referenceId=t,this._updateStatisticsCursor(e,u,1)),l>=o)return void u.add(t);const p=Math.ceil((l+1)/2),y=Math.floor((l+1)/2),m=1-l%2,v=30-(3*p+2*y),I=30-(2*p+3*y),b=(n&7*m+3*(1-m)<<v)>>v,x=(a&3*m+7*(1-m)<<I)>>I,S=b+x*(8*m+4*(1-m));d=d<<3*m+2*(1-m)|b,g=g<<2*m+3*(1-m)|x,null==u.children[S]&&(u.children[S]=this._acquire(d,g,l+1)),l+=1,u=u.children[S]}}remove(e,t){const r=q.i.fromOptimizedFeatures([e],this._serviceInfo).getCursor();r.next();const s=r.readGeometry();if(!s)return;const[n,a]=s.coords;this.removeCursor(r,n,a,e.geohashX,e.geohashY,t)}removeCursor(e,t,r,s,n,a){let o=this._root,h=0;for(;null!==o;){if(o.count-=1,o.xTotal-=t,o.yTotal-=r,o.xGeohashTotal-=s,o.yGeohashTotal-=n,this._updateStatisticsCursor(e,o,-1),h>=a)return void o.remove(e.getDisplayId());const u=Math.ceil((h+1)/2),l=Math.floor((h+1)/2),d=1-h%2,g=30-(3*u+2*l),p=30-(2*u+3*l),y=((s&7*d+3*(1-d)<<g)>>g)+((n&3*d+7*(1-d)<<p)>>p)*(8*d+4*(1-d)),m=o.children[y];1===m?.count&&(this._release(m),o.children[y]=null),h+=1,o=m}}forEach(e){let t=this._root;for(;null!==t;){const r=this._linkChildren(t)||t.next;e(t),t=r}}find(e,t,r){return this._root.find(e,t,r,0,0,0)}findIf(e){let t=null;return this.forEach(r=>{e(r)&&(t=r)}),t}findAllIf(e){const t=[];return this.forEach(r=>{e(r)&&t.push(r)}),t}findSingleOccupancyNode(e,t,r,s,n){let a=this._root;for(;null!==a;){const o=a.depth,h=a.xNode,u=a.yNode,l=1-o%2,d=a.xGeohashTotal/a.count,g=a.yGeohashTotal/a.count;if(1===a.count&&e<d&&d<=r&&t<g&&g<=s)return a;if(o>=n){a=a.next;continue}const p=Math.ceil((o+1)/2),y=Math.floor((o+1)/2),m=30-(3*p+2*y),v=30-(2*p+3*y),I=~((1<<m)-1),b=~((1<<v)-1),S=(t&b)>>v,C=(r&I)>>m,w=(s&b)>>v,F=h<<3*l+2*(1-l),R=u<<2*l+3*(1-l),L=F+8*l+4*(1-l),T=R+4*l+8*(1-l),E=Math.max(F,(e&I)>>m),U=Math.max(R,S),k=Math.min(L,C),j=Math.min(T,w);let V=null,re=null;for(let G=U;G<=j;G++)for(let ee=E;ee<=k;ee++){const Q=a.children[ee-F+(G-R)*(8*l+4*(1-l))];Q&&(V||(V=Q,V.next=a.next),re&&(re.next=Q),re=Q,Q.next=a.next)}a=V||a.next}return null}getRegionDisplayIds(e){let t=this._root;const{bounds:r,geohashBounds:s,level:n}=e,[a,o,h,u]=r,l=[];for(;null!==t;){const d=t.depth,g=t.xNode,p=t.yNode;if(d>=n){const Y=t.xTotal/t.count,Q=t.yTotal/t.count;Y>=a&&Y<=h&&Q>=o&&Q<=u&&t.displayIds.forEach(he=>l.push(he)),t=t.next;continue}const y=Math.ceil((d+1)/2),m=Math.floor((d+1)/2),v=1-d%2,I=30-(3*y+2*m),b=30-(2*y+3*m),x=~((1<<I)-1),S=~((1<<b)-1),w=(s.yLL&S)>>b,F=(s.xTR&x)>>I,R=(s.yTR&S)>>b,L=g<<3*v+2*(1-v),T=p<<2*v+3*(1-v),E=L+8*v+4*(1-v),U=T+4*v+8*(1-v),k=Math.max(L,(s.xLL&x)>>I),j=Math.max(T,w),V=Math.min(E,F),re=Math.min(U,R);let G=null,ee=null;for(let Y=j;Y<=re;Y++)for(let Q=k;Q<=V;Q++){const ie=t.children[Q-L+(Y-T)*(8*v+4*(1-v))];ie&&(G||(G=ie,G.next=t.next),ee&&(ee.next=ie),ee=ie,ie.next=t.next)}t=G||t.next}return l}getRegionStatistics(e){let t=this._root,r=0,s=0,n=0;const a={},{bounds:o,geohashBounds:h,level:u}=e,[l,d,g,p]=o;let y=0;for(;null!==t;){const m=t.depth,v=t.xNode,I=t.yNode;if(m>=u){const de=t.xTotal/t.count,le=t.yTotal/t.count;de>l&&de<=g&&le>d&&le<=p&&(r+=t.count,s+=t.xTotal,n+=t.yTotal,1===t.count&&(y=t.referenceId),this._aggregateStatistics(a,t.statistics)),t=t.next;continue}const b=Math.ceil((m+1)/2),x=Math.floor((m+1)/2),S=1-m%2,C=30-(3*b+2*x),w=30-(2*b+3*x),F=~((1<<C)-1),R=~((1<<w)-1),T=(h.yLL&R)>>w,E=(h.xTR&F)>>C,U=(h.yTR&R)>>w,k=v<<3*S+2*(1-S),j=I<<2*S+3*(1-S),V=k+8*S+4*(1-S),re=j+4*S+8*(1-S),G=Math.max(k,(h.xLL&F)>>C),ee=Math.max(j,T),Y=Math.min(V,E),Q=Math.min(re,U);let he=null,ie=null;for(let de=ee;de<=Q;de++)for(let le=G;le<=Y;le++){const B=t.children[le-k+(de-j)*(8*S+4*(1-S))];if(B){if(de!==ee&&de!==Q&&le!==G&&le!==Y){const vt=B.xTotal/B.count,It=B.yTotal/B.count;vt>l&&vt<=g&&It>d&&It<=p&&(r+=B.count,s+=B.xTotal,n+=B.yTotal,1===B.count&&(y=B.referenceId),this._aggregateStatistics(a,B.statistics));continue}he||(he=B,he.next=t.next),ie&&(ie.next=B),ie=B,B.next=t.next}}t=he||t.next}return{count:r,attributes:this.normalizeStatistics(a,r),xTotal:s,yTotal:n,referenceId:y}}getBins(e){const t=[],{geohashBounds:r,level:s}=e;let n=this._root;for(;null!==n;){const a=n.depth,o=n.xNode,h=n.yNode;if(a>=s){t.push(n),n=n.next;continue}const u=Math.ceil((a+1)/2),l=Math.floor((a+1)/2),d=1-a%2,g=30-(3*u+2*l),p=30-(2*u+3*l),y=~((1<<g)-1),m=~((1<<p)-1),I=(r.yLL&m)>>p,b=(r.xTR&y)>>g,x=(r.yTR&m)>>p,S=o<<3*d+2*(1-d),C=h<<2*d+3*(1-d),w=S+8*d+4*(1-d),F=C+4*d+8*(1-d),R=Math.max(S,(r.xLL&y)>>g),L=Math.max(C,I),T=Math.min(w,b),E=Math.min(F,x);let U=null,k=null;for(let j=L;j<=E;j++)for(let V=R;V<=T;V++){const G=n.children[V-S+(j-C)*(8*d+4*(1-d))];G&&(U||(U=G,U.next=n.next),k&&(k.next=G),k=G,G.next=n.next)}n=U||n.next}return t}_linkChildren(e){let t=null,r=null;for(let s=0;s<=e.children.length;s++){const n=e.children[s];n&&(t||(t=n,t.next=e.next),r&&(r.next=n),r=n,n.next=e.next)}return t}_updateStatisticsCursor(e,t,r){for(const s of this._statisticFields){const n=s.name,a=s.inField?e.readAttribute(s.inField):e.getComputedNumericAtIndex(s.inFieldIndex);switch(s.statisticType){case"min":if(isNaN(a))break;if(!t.statistics[n]){t.statistics[n]={value:a};break}t.statistics[n].value=Math.min(t.statistics[n].value,a);break;case"max":if(isNaN(a))break;if(!t.statistics[n]){t.statistics[n]={value:a};break}t.statistics[n].value=Math.max(t.statistics[n].value,a);break;case"count":break;case"sum":case"avg":{t.statistics[n]||(t.statistics[n]={value:0,nanCount:0});const o=t.statistics[n].value,h=t.statistics[n].nanCount??0;null==a||isNaN(a)?t.statistics[n].nanCount=h+r:t.statistics[n].value=o+r*a;break}case"avg_angle":{t.statistics[n]||(t.statistics[n]={x:0,y:0,nanCount:0});const o=t.statistics[n].x,h=t.statistics[n].y,u=t.statistics[n].nanCount??0,l=Math.PI/180;null==a||isNaN(a)?t.statistics[n].nanCount=u+r:(t.statistics[n].x=o+r*Math.cos(a*l),t.statistics[n].y=h+r*Math.sin(a*l));break}case"mode":t.statistics[n]||(t.statistics[n]={}),t.statistics[n][a]=(t.statistics[n][a]||0)+r}}}_aggregateStatistics(e,t){for(const r of this._statisticFields){const s=r.name;switch(r.statisticType){case"min":if(!e[s]){e[s]={value:t[s].value};break}e[s].value=Math.min(e[s].value,t[s].value);break;case"max":if(!e[s]){e[s]={value:t[s].value};break}e[s].value=Math.max(e[s].value,t[s].value);break;case"count":break;case"sum":case"avg":case"avg_angle":case"mode":e[s]||(e[s]={});for(const n in t[s])e[s][n]=(e[s][n]||0)+t[s][n]}}}normalizeStatistics(e,t){const r={};for(const s of this._statisticFields){const n=s.name;switch(s.statisticType){case"min":case"max":{const a=e[n];if(!t||!a)break;r[n]=a.value;break}case"count":if(!t)break;r[n]=t;break;case"sum":{if(!t)break;const{value:a,nanCount:o}=e[n];if(!(t-o))break;r[n]=a;break}case"avg":{if(!t)break;const{value:a,nanCount:o}=e[n];if(!(t-o))break;r[n]=a/(t-o);break}case"avg_angle":{if(!t)break;const{x:a,y:o,nanCount:h}=e[n];if(!(t-h))break;const d=180/Math.PI,g=Math.atan2(o/(t-h),a/(t-h))*d;r[n]=g;break}case"mode":{const a=e[n];let o=0,h=0,u=null;for(const l in a){const d=a[l];d===o?h+=1:d>o&&(o=d,h=1,u=l)}r[n]="null"===u||h>1?null:u;break}}}return r}}class qe{constructor(e,t,r,s){this.count=0,this.xTotal=0,this.yTotal=0,this.statistics={},this.displayId=0,this.referenceId=0,this.displayIds=new Set,this.next=null,this.depth=0,this.xNode=0,this.yNode=0,this.xGeohashTotal=0,this.yGeohashTotal=0,this._tree=e,this.children=new Array(32);for(let n=0;n<this.children.length;n++)this.children[n]=null;this.xNode=t,this.yNode=r,this.depth=s}realloc(e,t,r){for(let s=0;s<this.children.length;s++)this.children[s]=null;return this.xNode=e,this.yNode=t,this.depth=r,this.next=null,this.xGeohashTotal=0,this.yGeohashTotal=0,this.displayId=0,this.referenceId=0,this.xTotal=0,this.yTotal=0,this.count=0,this.statistics={},this.displayIds.clear(),this}get id(){return`${this.xNode}.${this.yNode}`}add(e){this.displayIds.add(e)}remove(e){this.displayIds.delete(e)}getAttributes(){const e=this._tree.normalizeStatistics(this.statistics,this.count);return e.referenceId=null,e.aggregateId=this.id,e.aggregateCount=this.count,e}getGeometry(e,t){const r=this.getLngLatBounds(),[s,n,a,o]=r,h=(0,oe.iV)({rings:[[[s,n],[s,o],[a,o],[a,n],[s,n]]]},ae.Z.WGS84,e),u=(0,P.Uy)(new N.Z,h,!1,!1);return(0,c.pC)(t)?(0,P.Nh)(new N.Z,u,!1,!1,"esriGeometryPolygon",t,!1,!1):u}getGeometryCentroid(e,t){const r=this.getLngLatBounds(),[s,n,a,o]=r,h=(0,oe.iV)({x:(s+a)/2,y:(n+o)/2},ae.Z.WGS84,e),u=(0,P.dd)(new N.Z,h);return(0,c.pC)(t)?(0,P.Nh)(new N.Z,u,!1,!1,"esriGeometryPoint",t,!1,!1):u}getLngLatBounds(){const e=this.depth,t=Math.ceil(e/2),r=Math.floor(e/2);return function Ss(i,e){let t=-90,r=90,s=-180,n=180;for(let a=0;a<e;a++){const o=Math.ceil((a+1)/2),h=Math.floor((a+1)/2),u=1-a%2,l=30-(3*o+2*h),d=30-(2*o+3*h),p=2*u+3*(1-u),m=(7*u+3*(1-u)<<l&i.geohashX)>>l,v=(3*u+7*(1-u)<<d&i.geohashY)>>d;for(let I=3*u+2*(1-u)-1;I>=0;I--){const b=(s+n)/2,x=m&1<<I?1:0;s=(1-x)*s+x*b,n=(1-x)*b+x*n}for(let I=p-1;I>=0;I--){const b=(t+r)/2,x=v&1<<I?1:0;t=(1-x)*t+x*b,r=(1-x)*b+x*r}}return[s,t,n,r]}({geohashX:this.xNode<<30-(3*t+2*r),geohashY:this.yNode<<30-(2*t+3*r)},this.depth)}find(e,t,r,s,n,a){if(s>=r)return this;const o=1-s%2,h=3*o+2*(1-o),u=2*o+3*(1-o),l=30-n-h,d=30-a-u,p=this.children[((e&7*o+3*(1-o)<<l)>>l)+((t&3*o+7*(1-o)<<d)>>d)*(8*o+4*(1-o))];return null==p?null:p.find(e,t,r,s+1,n+h,a+u)}}var lt=f(5548),ue=f(94425),Ne=f(99666),ct=f(16669),gt=f(37118),pt=f(2004);const je=ve.Z.getLogger("esri.view.2d.layers.features.support.BinStore"),Ms=(0,lt.Ue)();function yt(i){return 57.29577951308232*i}class Es extends ct.J{constructor(e,t,r,s){super(e,r),this.type="bin",this.events=new De.Z,this.objectIdField="aggregateId",this.featureAdapter=Ue.k,this._geohashLevel=5,this._geohashBuf=[],this._serviceInfo=s,this.geometryInfo=e.geometryInfo,this._spatialReference=t,this._projectionSupportCheck=(0,oe._W)(t,ae.Z.WGS84),this._bitsets.geohash=r.getBitset(r.createBitset()),this._bitsets.inserted=r.getBitset(r.createBitset())}destroy(){this._tree&&this._tree.destroy()}get featureSpatialReference(){return this._spatialReference}get fields(){return this._fields}updateSchema(e,t){var r=()=>super.updateSchema,s=this;return(0,_.Z)(function*(){const n=s._schema;try{yield r().call(s,e,t),yield s._projectionSupportCheck}catch{}s._fields=s._schema.params.fields;const a=(0,te.Hg)(n,t);t&&(!(0,c.Wi)(a)||e.source||e.storage.filters)?(((0,te.uD)(a,"params.fields")||(0,te.uD)(a,"params")||!s._tree||e.source)&&(s._tree&&s._tree.destroy(),s._tree=new dt(s._statisticFields,s._serviceInfo),s._tree.onRelease=o=>o.displayId&&s._storage.releaseDisplayId(o.displayId),s._geohashLevel=s._schema.params.fixedBinLevel,s._rebuildTree(),(0,Z.Z)("esri-2d-update-debug")&&je.info("Aggregate mesh needs update due to tree changing")),(0,Z.Z)("esri-2d-update-debug")&&je.info("Aggregate mesh needs update due to tree changing"),e.targets[t.name]=!0,e.mesh=!1):n&&(e.mesh=!0)})()}clear(){this._rebuildTree()}sweepFeatures(e,t){this._bitsets.inserted.forEachSet(r=>{if(!e.has(r)){const s=t.lookupByDisplayIdUnsafe(r);this._remove(s)}})}sweepAggregates(e,t,r){}onTileData(e,t,r,s,n=!0){if(!this._schema||(0,c.Wi)(t.addOrUpdate))return t;this.events.emit("changed");const a=this._getTransforms(e,this._spatialReference);{const h=t.addOrUpdate.getCursor();for(;h.next();)this._update(h,s)}if(t.status.mesh||!n)return t;const o=new Array;this._getBinsForTile(o,e,a,r),t.addOrUpdate=q.i.fromOptimizedFeatures(o,{...this._serviceInfo,geometryType:"esriGeometryPolygon"}),t.addOrUpdate.attachStorage(r),t.end=!0,t.isRepush||(t.clear=!0);{const h=t.addOrUpdate.getCursor();for(;h.next();){const u=h.getDisplayId();this._bitsets.computed.unset(u),this.setComputedAttributes(r,h,u,e.scale)}}return t}forEachBin(e){this._tree.forEach(e)}forEach(e){this._tree.forEach(t=>{if(t.depth!==this._geohashLevel)return;const r=this._toFeatureJSON(t),s=q.i.fromFeatures([r],{objectIdField:this.objectIdField,globalIdField:null,geometryType:this.geometryInfo.geometryType,fields:this.fields}).getCursor();s.next(),e(s)})}forEachInBounds(e,t){}forEachBounds(e,t){const{hasM:r,hasZ:s}=this.geometryInfo;for(const n of e){const a=(0,P.$)(Ms,n.readGeometry(),s,r);(0,c.Wi)(a)||t(a)}}onTileUpdate(e){}getAggregate(e){const t=(0,Ne.QS)(e,!0),r=this._tree.findIf(s=>s.displayId===t);return(0,c.yw)(r,s=>this._toFeatureJSON(s))}getAggregates(){return this._tree.findAllIf(e=>e.depth===this._geohashLevel).map(this._toFeatureJSON.bind(this))}getDisplayId(e){const t=this._tree.findIf(r=>r.id===e);return(0,c.yw)(t,r=>r.displayId)}getFeatureDisplayIdsForAggregate(e){const t=this._tree.findIf(r=>r.id===e);return(0,c.R2)(t,[],r=>Array.from(r.displayIds))}getDisplayIdForReferenceId(e){const t=this._tree.findIf(r=>1===r.displayIds.size&&r.displayIds.has(e));return(0,c.yw)(t,r=>r.displayId)}_toFeatureJSON(e){const t=this._spatialReference;return{displayId:e.displayId,attributes:e.getAttributes(),geometry:(0,P.di)(e.getGeometry(t),"esriGeometryPolygon",!1,!1),centroid:null}}_rebuildTree(){this._bitsets.computed.clear(),this._bitsets.inserted.clear(),this._tree&&this._tree.clear()}_remove(e){const t=e.getDisplayId(),r=e.getXHydrated(),s=e.getYHydrated(),n=this._geohashBuf[2*t],a=this._geohashBuf[2*t+1];this._bitsets.inserted.has(t)&&(this._bitsets.inserted.unset(t),this._tree.removeCursor(e,r,s,n,a,this._geohashLevel))}_update(e,t){const r=e.getDisplayId(),s=this._bitsets.inserted,n=t.isVisible(r);if(n===s.has(r))return;if(!n)return void this._remove(e);const a=e.getXHydrated(),o=e.getYHydrated();this._setGeohash(r,a,o)&&(this._tree.insertCursor(e,r,a,o,this._geohashBuf[2*r],this._geohashBuf[2*r+1],this._geohashLevel),s.set(r))}_setGeohash(e,t,r){if(this._bitsets.geohash.has(e))return!0;const s=this._geohashBuf;if(this._spatialReference.isWebMercator){const n=yt(t/ue.sv.radius),a=n-360*Math.floor((n+180)/360);we(s,e,yt(Math.PI/2-2*Math.atan(Math.exp(-r/ue.sv.radius))),a,12)}else{const n=(0,oe.iV)({x:t,y:r},this._spatialReference,ae.Z.WGS84);if(!n)return!1;we(s,e,n.y,n.x,12)}return this._bitsets.geohash.set(e),!0}_getBinsForTile(e,t,r,s){try{const n=this._getGeohashBounds(t),a=this._tree.getBins(n);for(const o of a){o.displayId||(o.displayId=s.createDisplayId(!0));let h=null;const u=o.getGeometry(this._spatialReference,r.tile);u||(h=o.getGeometryCentroid(this._spatialReference,r.tile));const l=new xe.u_(u,o.getAttributes(),h);l.objectId=o.id,l.displayId=o.displayId,e.push(l)}}catch{return void je.error("Unable to get bins for tile",t.key.id)}}_getGeohash(e,t,r){const s={geohashX:0,geohashY:0};return Me(s,t,e,r),s}_getGeohashBounds(e){const t=this._getGeohashLevel(e.key.level),r=[e.extent.xmin,e.extent.ymin,e.extent.xmax,e.extent.ymax],s=gt.Z.fromExtent(pt.Z.fromBounds(r,this._spatialReference)),n=(0,oe.iV)(s,this._spatialReference,ae.Z.WGS84,{densificationStep:64*e.resolution}),a=(0,P.Uy)(new N.Z,n,!1,!1),o=a.coords.filter((m,v)=>!(v%2)),h=a.coords.filter((m,v)=>v%2),u=Math.min(...o),l=Math.min(...h),d=Math.max(...o),g=Math.max(...h),p=this._getGeohash(u,l,t),y=this._getGeohash(d,g,t);return{bounds:r,geohashBounds:{xLL:p.geohashX,yLL:p.geohashY,xTR:y.geohashX,yTR:y.geohashY},level:t}}_getGeohashLevel(e){return this._schema.params.fixedBinLevel}_getTransforms(e,t){const r={originPosition:"upperLeft",scale:[e.resolution,e.resolution],translate:[e.bounds[0],e.bounds[3]]},s=(0,Ae.C5)(t);if(!s)return{tile:r,left:null,right:null};const[n,a]=s.valid;return{tile:r,left:{...r,translate:[a,e.bounds[3]]},right:{...r,translate:[n-a+e.bounds[0],e.bounds[3]]}}}}var z=f(39351);const Us=(0,lt.Ue)();class Ve extends xe.nd{constructor(e,t,r,s,n){super(new N.Z([],[t,r]),s,null,e),this.geohashBoundsInfo=n}get count(){return this.attributes.cluster_count}static create(e,t,r,s,n,a,o,h){const u=new Ve(t,r,s,a,o);return u.displayId=e.createDisplayId(!0),u.referenceId=h,u.tileLevel=n,u}update(e,t,r,s,n,a){return this.geometry.coords[0]=e,this.geometry.coords[1]=t,this.tileLevel=r,this.attributes=s,this.geohashBoundsInfo=n,this.referenceId=null,this.referenceId=a,this}toJSON(){return{attributes:{...this.attributes,aggregateId:this.objectId,referenceId:1===this.attributes.cluster_count?this.referenceId:null},geometry:{x:this.geometry.coords[0],y:this.geometry.coords[1]}}}}function _e(i){return 57.29577951308232*i}class Zs extends ct.J{constructor(e,t,r,s){super(e,r),this.type="cluster",this.events=new De.Z,this.objectIdField="aggregateId",this.featureAdapter=Ue.k,this._geohashLevel=0,this._tileLevel=0,this._aggregateValueRanges={},this._aggregateValueRangesChanged=!1,this._geohashBuf=[],this._clusters=new Map,this._tiles=new Map,this._serviceInfo=s,this.geometryInfo=e.geometryInfo,this._spatialReference=t,this._projectionSupportCheck=(0,oe._W)(t,ae.Z.WGS84),this._bitsets.geohash=r.getBitset(r.createBitset()),this._bitsets.inserted=r.getBitset(r.createBitset())}destroy(){this._tree.destroy()}get featureSpatialReference(){return this._spatialReference}get fields(){return this._fields}updateSchema(e,t){var r=()=>super.updateSchema,s=this;return(0,_.Z)(function*(){const n=s._schema;try{yield r().call(s,e,t),yield s._projectionSupportCheck}catch{}s._fields=s._schema.params.fields;const a=(0,te.Hg)(n,t);t&&(!(0,c.Wi)(a)||e.source||e.storage.filters)?(((0,te.uD)(a,"params.fields")||!s._tree||e.source)&&(s._tree&&s._tree.destroy(),s._tree=new dt(s._statisticFields,s._serviceInfo),s._rebuildTree(),(0,Z.Z)("esri-2d-update-debug")&&console.debug("Aggregate mesh needs update due to tree changing")),(0,Z.Z)("esri-2d-update-debug")&&console.debug("Applying Update - ClusterStore:",a),e.targets[t.name]=!0,e.mesh=!1,s._aggregateValueRanges={}):n&&(e.mesh=!0)})()}clear(){this._rebuildTree()}sweepFeatures(e,t){this._bitsets.inserted.forEachSet(r=>{if(!e.has(r)){const s=t.lookupByDisplayIdUnsafe(r);this._remove(s)}})}sweepAggregates(e,t,r){this._clusters.forEach((s,n)=>{s&&s.tileLevel!==r&&(e.releaseDisplayId(s.displayId),t.unsetAttributeData(s.displayId),this._clusters.delete(n))})}onTileData(e,t,r,s,n=!0){if(!this._schema||(0,c.Wi)(t.addOrUpdate))return t;this.events.emit("changed");const a=this._getTransforms(e,this._spatialReference);{const u=t.addOrUpdate.getCursor();for(;u.next();)this._update(u,s)}if(t.status.mesh||!n)return t;const o=new Array;this._getClustersForTile(o,e,this._schema.params.clusterRadius,r,a),t.addOrUpdate=q.i.fromOptimizedFeatures(o,this._serviceInfo),t.addOrUpdate.attachStorage(r),t.clear=!0,t.end=!0;{const u=t.addOrUpdate.getCursor();for(;u.next();){const l=u.getDisplayId();this._bitsets.computed.unset(l),this.setComputedAttributes(r,u,l,e.scale)}}return this._aggregateValueRangesChanged&&t.end&&(this.events.emit("valueRangesChanged",{valueRanges:this._aggregateValueRanges}),this._aggregateValueRangesChanged=!1),t}onTileUpdate({added:e,removed:t}){if(e.length){const s=e[0].level;this._tileLevel=s,this._setGeohashLevel(s)}if(!this._schema)return;const r=this._schema.params.clusterRadius;t.forEach(s=>{this._tiles.delete(s.key.id),this._markTileClustersForDeletion(s,r)})}getAggregate(e){for(const t of this._clusters.values())if((t?.displayId&Ne._I)==(e&Ne._I))return t.toJSON();return null}getAggregates(){const e=[];for(const t of this._clusters.values())t?.tileLevel===this._tileLevel&&e.push(t.toJSON());return e}getDisplayId(e){const t=this._clusters.get(e);return t?t.displayId:null}getFeatureDisplayIdsForAggregate(e){const t=this._clusters.get(e);return t?this._tree.getRegionDisplayIds(t.geohashBoundsInfo):[]}getDisplayIdForReferenceId(e){for(const t of this._clusters.values())if(t?.referenceId===e)return t.displayId;return null}getAggregateValueRanges(){return this._aggregateValueRanges}forEach(e){this._clusters.forEach(t=>{if(!t)return;const r=t.toJSON(),s=q.i.fromFeatures([r],{objectIdField:this.objectIdField,globalIdField:null,geometryType:this.geometryInfo.geometryType,fields:this.fields}).getCursor();s.next(),e(s)})}forEachInBounds(e,t){}forEachBounds(e,t){const{hasM:r,hasZ:s}=this.geometryInfo;for(const n of e){const a=(0,P.$)(Us,n.readGeometry(),s,r);(0,c.Wi)(a)||t(a)}}size(){let e=0;return this.forEach(t=>e++),e}_rebuildTree(){this._bitsets.computed.clear(),this._bitsets.inserted.clear(),this._tree&&this._tree.clear()}_remove(e){const t=e.getDisplayId(),r=e.getXHydrated(),s=e.getYHydrated(),n=this._geohashBuf[2*t],a=this._geohashBuf[2*t+1];this._bitsets.inserted.has(t)&&(this._bitsets.inserted.unset(t),this._tree.removeCursor(e,r,s,n,a,this._geohashLevel))}_update(e,t){const r=e.getDisplayId(),s=this._bitsets.inserted,n=t.isVisible(r);if(n===s.has(r))return;if(!n)return void this._remove(e);const a=e.getXHydrated(),o=e.getYHydrated();this._setGeohash(r,a,o)&&(this._tree.insertCursor(e,r,a,o,this._geohashBuf[2*r],this._geohashBuf[2*r+1],this._geohashLevel),s.set(r))}_setGeohash(e,t,r){if(this._bitsets.geohash.has(e))return!0;const s=this._geohashBuf;if(this._spatialReference.isWebMercator){const n=_e(t/ue.sv.radius),a=n-360*Math.floor((n+180)/360);we(s,e,_e(Math.PI/2-2*Math.atan(Math.exp(-r/ue.sv.radius))),a,12)}else{const n=(0,oe.iV)({x:t,y:r},this._spatialReference,ae.Z.WGS84);if(!n)return!1;we(s,e,n.y,n.x,12)}return this._bitsets.geohash.set(e),!0}_getClustersForTile(e,t,r,s,n,a=!0){const o=this._schema.params.clusterPixelBuffer,h=2*r,u=Math.ceil(2**t.key.level*z.I_/h)+1,l=Math.ceil(o/h)+0,d=Math.ceil(z.I_/h),{row:g,col:p}=t.key,m=g*z.I_,v=Math.floor(p*z.I_/h)-l,I=Math.floor(m/h)-l,b=v+d+2*l,x=I+d+2*l,S=t.tileInfoView.getLODInfoAt(t.key.level);for(let C=v;C<=b;C++)for(let w=I;w<=x;w++){let F=C;S.wrap&&(F=C<0?C+u:C%u);const R=S.wrap&&C<0,L=S.wrap&&C%u!==C,T=this._lookupCluster(s,S,t.key.level,F,w,t);if((0,c.pC)(T)){const E=(0,c.yw)(n,U=>R?U.left:L?U.right:U.tile);if(a&&(0,c.Wi)(E)||!T.count)continue;if((0,c.pC)(E)&&a){const U=T.geometry.clone();let k=T.attributes;U.coords[0]=(0,P.Jd)(E,U.coords[0]),U.coords[1]=(0,P.IN)(E,U.coords[1]),1===T.count&&(0,c.pC)(T.referenceId)&&(k={...T.attributes,referenceId:T.referenceId});const j=new xe.u_(U,k);j.displayId=T.displayId,e.push(j)}}}}_getGeohashLevel(e){return Math.min(Math.ceil(e/2+2),12)}_setGeohashLevel(e){const t=this._getGeohashLevel(e),r=1*(Math.floor(t/1)+1)-1;if(this._geohashLevel!==r)return this._geohashLevel=r,this._rebuildTree(),void this._bitsets.geohash.clear()}_getTransforms(e,t){const r={originPosition:"upperLeft",scale:[e.resolution,e.resolution],translate:[e.bounds[0],e.bounds[3]]},s=(0,Ae.C5)(t);if(!s)return{tile:r,left:null,right:null};const[n,a]=s.valid;return{tile:r,left:{...r,translate:[a,e.bounds[3]]},right:{...r,translate:[n-a+e.bounds[0],e.bounds[3]]}}}_getClusterId(e,t,r){return(15&e)<<28|(16383&t)<<14|16383&r}_markForDeletion(e,t,r){const s=this._getClusterId(e,t,r);this._clusters.delete(s)}_getClusterBounds(e,t,r){const s=this._schema.params.clusterRadius,n=2*s;let a=r%2?t*n:t*n-s;const o=r*n;let h=a+n;const l=2**e.level*z.I_;e.wrap&&a<0&&(a=0),e.wrap&&h>l&&(h=l);const g=o/z.I_,p=h/z.I_,y=(o-n)/z.I_;return[e.getXForColumn(a/z.I_),e.getYForRow(g),e.getXForColumn(p),e.getYForRow(y)]}_getGeohash(e,t,r){const s={geohashX:0,geohashY:0};return Me(s,t,e,r),s}_getGeohashBounds(e,t){const r=this._getGeohashLevel(e.key.level);if(this._spatialReference.isWebMercator){const[m,v,I,b]=t,x={x:m,y:v},S={x:I,y:b};let C=0,w=0,F=0,R=0;{const E=_e(x.x/ue.sv.radius);C=E-360*Math.floor((E+180)/360),w=_e(Math.PI/2-2*Math.atan(Math.exp(-x.y/ue.sv.radius)))}{const E=_e(S.x/ue.sv.radius);F=E-360*Math.floor((E+180)/360),R=_e(Math.PI/2-2*Math.atan(Math.exp(-S.y/ue.sv.radius)))}const L={geohashX:0,geohashY:0},T={geohashX:0,geohashY:0};return Me(L,w,C,r),Me(T,R,F,r),{bounds:[m,v,I,b],geohashBounds:{xLL:L.geohashX,yLL:L.geohashY,xTR:T.geohashX,yTR:T.geohashY},level:r}}const s=gt.Z.fromExtent(pt.Z.fromBounds(t,this._spatialReference)),n=(0,oe.iV)(s,this._spatialReference,ae.Z.WGS84,{densificationStep:64*e.resolution});if(!n)return null;const a=(0,P.Uy)(new N.Z,n,!1,!1),o=a.coords.filter((m,v)=>!(v%2)),h=a.coords.filter((m,v)=>v%2),u=Math.min(...o),l=Math.min(...h),d=Math.max(...o),g=Math.max(...h),p=this._getGeohash(u,l,r),y=this._getGeohash(d,g,r);return{bounds:t,geohashBounds:{xLL:p.geohashX,yLL:p.geohashY,xTR:y.geohashX,yTR:y.geohashY},level:r}}_lookupCluster(e,t,r,s,n,a){const o=this._getClusterId(r,s,n),h=this._clusters.get(o),u=this._getClusterBounds(t,s,n),l=this._getGeohashBounds(a,u);if((0,c.Wi)(l))return null;const d=this._tree.getRegionStatistics(l),{count:g,xTotal:p,yTotal:y,referenceId:m}=d,v=g?p/g:0,I=g?y/g:0;if(0===g)return this._clusters.set(o,null),null;const b={cluster_count:g,...d.attributes},x=(0,c.pC)(h)?h.update(v,I,r,b,l,m):Ve.create(e,o,v,I,r,b,l,m);if(0===g){const[S,C,w,F]=u;x.geometry.coords[0]=(S+w)/2,x.geometry.coords[1]=(C+F)/2}return this._clusters.set(o,x),this._updateAggregateValueRangeForCluster(x,x.tileLevel),x}_updateAggregateValueRangeForCluster(e,t){const r=this._aggregateValueRanges[t]||{minValue:1/0,maxValue:0},s=r.minValue,n=r.maxValue;r.minValue=Math.min(s,e.count),r.maxValue=Math.max(n,e.count),this._aggregateValueRanges[t]=r,s===r.minValue&&n===r.maxValue||(this._aggregateValueRangesChanged=!0)}_markTileClustersForDeletion(e,t){const r=2*t,s=Math.ceil(z.I_/r),{row:n,col:a}=e.key,h=n*z.I_,u=Math.floor(a*z.I_/r),l=Math.floor(h/r);for(let d=u;d<u+s;d++)for(let g=l;g<l+s;g++)this._markForDeletion(e.key.level,d,g)}}var Rs=f(93872);function se(i){if(!(0,A.D_)(i)&&!function ks(i){return"worker:port-closed"===i.name}(i))throw i}function _t(i){return"feature"===i.type&&"snapshot"===i.mode}let X=class extends We.Z{constructor(){super(...arguments),this._storage=new Rs.O,this._markedIdsBufId=this._storage.createBitset(),this._lastCleanup=performance.now(),this._cleanupNeeded=!1,this._invalidated=!1,this._tileToResolver=new Map,this._didEdit=!1,this._updateVersion=1,this.tileStore=null,this.config=null,this.processor=null,this.remoteClient=null,this.service=null}initialize(){this._initStores(),this._initSource(),this._updateQueue=new ke.e({concurrency:"stream"===this._source.type?1:4,process:(i,e)=>this._onTileMessage(i,{signal:e})}),this.addHandles([this.tileStore.on("update",this.onTileUpdate.bind(this)),(0,H.gx)(()=>!this.updating,()=>this.onIdle())]),this._checkUpdating=setInterval(()=>this.notifyChange("updating"),300)}_initSource(){this._source=function gs(i,e,t,r,s,n){const a=function ps(i,e,t,r,s,n){switch(i.type){case"snapshot":return{type:"feature",origin:"snapshot",featureCount:(0,c.Pt)(i.featureCount,0),serviceInfo:i,onMessage:r,outSR:e,tileInfoView:t,canAcceptRequest:s,store:n};case"stream":return{type:"stream",serviceInfo:i,onMessage:r,outSR:e,canAcceptRequest:s};case"memory":case"on-demand":return{type:"feature",serviceInfo:i,onMessage:r,outSR:e,origin:function a(o){return Array.isArray(o)?"local":"path"in o&&(0,Ft.M8)(o.path)?"hosted":"unknown"}(i.source),tileInfoView:t,canAcceptRequest:s}}}(i,e,t,r,s,n);switch(a.type){case"feature":switch(a.origin){case"hosted":case"local":return new Jt(a);case"snapshot":return new ss(a);default:return new $t(a)}case"stream":return new fe(a)}}(this.service,this.spatialReference,this.tileStore.tileScheme,(r,s)=>(this._invalidated=!0,this._patchTile(r,s)),()=>this._updateQueue&&this._updateQueue.length<50,this.featureStore),this._proxyEvents()}_proxyEvents(){if("stream"===this._source.type){const i=this._source.events,e=this._source;this.addHandles([(0,H.YP)(()=>e.connectionStatus,t=>this.remoteClient.invoke("setProperty",{propertyName:"connectionStatus",value:t}).catch(se),{initial:!0}),(0,H.YP)(()=>e.errorString,t=>this.remoteClient.invoke("setProperty",{propertyName:"errorString",value:t}).catch(se),{initial:!0}),i.on("data-received",t=>this.remoteClient.invoke("emitEvent",{name:"data-received",event:{attributes:t.attributes,centroid:t.centroid,geometry:t.geometry}}).catch(se)),i.on("message-received",t=>this.remoteClient.invoke("emitEvent",{name:"message-received",event:t}).catch(se)),i.on("updateRate",t=>this.remoteClient.invoke("emitEvent",{name:"update-rate",event:{...t}}).catch(se))])}}_initAttributeStore(i){this.attributeStore||(this.attributeStore=new fs.Z({type:"remote",initialize:(e,t)=>(0,A.R8)(this.remoteClient.invoke("tileRenderer.featuresView.attributeView.initialize",e,{signal:t}).catch(se)),update:(e,t)=>(0,A.R8)(this.remoteClient.invoke("tileRenderer.featuresView.attributeView.requestUpdate",e,{signal:t}).catch(se)),render:e=>(0,A.R8)(this.remoteClient.invoke("tileRenderer.featuresView.requestRender",void 0,{signal:e}).catch(se))},i,()=>this.notifyChange("updating")))}_initStores(){this.featureStore=new Ue.p({geometryInfo:{geometryType:this.service.geometryType,hasM:!1,hasZ:!1},spatialReference:this.spatialReference,fieldsIndex:this.fieldsIndex,fields:this.service.fields},this._storage,"snapshot"===this.service.type?"snapshot":"on-demand")}_initQueryEngine(i){const e=this;this.featureQueryEngine?.destroy(),this.featureQueryEngine=new Xe.q({definitionExpression:i.schema.source.definitionExpression??void 0,fields:this.service.fields,geometryType:this.service.geometryType,objectIdField:this.service.objectIdField,hasM:!1,hasZ:!1,spatialReference:this.spatialReference.toJSON(),cacheSpatialQueries:!0,featureStore:this.featureStore,aggregateAdapter:{getFeatureObjectIds:t=>(0,c.Wi)(e.aggregateStore)?[]:e.aggregateStore.getFeatureDisplayIdsForAggregate(t).map(r=>e.getObjectId(r))},timeInfo:this.service.timeInfo})}_initAggregateQueryEngine(i,e){if(this.aggregateQueryEngine?.destroy(),(0,c.Wi)(i))return;const t=e.targets.aggregate.params.fields.slice();this.aggregateQueryEngine=new Xe.q({definitionExpression:void 0,fields:t,geometryType:i.geometryInfo.geometryType,objectIdField:i.objectIdField,hasM:i.geometryInfo.hasM,hasZ:i.geometryInfo.hasZ,spatialReference:this.spatialReference.toJSON(),cacheSpatialQueries:!1,featureStore:i,aggregateAdapter:{getFeatureObjectIds:r=>[]}})}destroy(){this._updateQueue.destroy(),this._source.destroy(),this.featureQueryEngine?.destroy(),this.aggregateQueryEngine?.destroy(),this.attributeStore?.destroy();for(const i of this.tileStore.tiles)this._source.unsubscribe(i);clearInterval(this._checkUpdating)}get fieldsIndex(){return new Ct.Z(this.service.fields)}get spatialReference(){return this.tileStore.tileScheme.spatialReference}get updating(){return this.isUpdating()}isUpdating(){const i=this._source.updating,e=!!this._updateQueue.length,t=!this.attributeStore||this.attributeStore.isUpdating(),r=i||e||t;return(0,Z.Z)("esri-2d-log-updating")&&console.log(`Updating FeatureController2D: ${r}\n  -> updatingSource ${i}\n  -> updateQueue ${e}\n  -> updatingAttributeStore ${t}\n`),r}updateCustomParameters(i){"stream"===this._source.type&&this._source.updateCustomParameters(i)}enableEvent(i){this._source.enableEvent(i.name,i.value)}pause(){this._updateQueue.pause(),this._updateQueue.clear()}resume(){this._updateQueue.resume()}pauseStream(){"stream"===this._source.type&&this._source.pauseStream()}resumeStream(){"stream"===this._source.type&&this._source.resumeStream()}sendMessageToSocket(i){"stream"===this._source.type&&this._source.sendMessageToSocket(i)}sendMessageToClient(i){"stream"===this._source.type&&this._source.sendMessageToClient(i)}_initAggregateStore(i){const e=i.schema.targets?.aggregate?.type;if((0,c.yw)(this.config,r=>r.schema.targets?.aggregate?.type)!==e&&((0,c.pC)(this.aggregateStore)&&(this.removeHandles("valueRangesChanged"),this.aggregateStore.destroy(),this.aggregateStore=null),e)){switch(e){case"cluster":this.aggregateStore=new Zs({geometryInfo:{geometryType:"esriGeometryPoint",hasM:!1,hasZ:!1},spatialReference:this.spatialReference,fieldsIndex:this.fieldsIndex,fields:this.service.fields},this.spatialReference,this._storage,this.service),this.addHandles(this.aggregateStore.events.on("valueRangesChanged",s=>{this.remoteClient.invoke("emitEvent",{name:"valueRangesChanged",event:{valueRanges:s.valueRanges}}).catch(se)}),"valueRangesChanged");break;case"bin":this.aggregateStore=new Es({geometryInfo:{geometryType:"esriGeometryPolygon",hasM:!1,hasZ:!1},spatialReference:this.spatialReference,fieldsIndex:this.fieldsIndex,fields:this.service.fields},this.spatialReference,this._storage,this.service)}this.aggregateStore.onTileUpdate({added:this.tileStore.tiles,removed:[]})}}update(i,e){var t=this;return(0,_.Z)(function*(){t._updateVersion++,t._initQueryEngine(e),t._initAttributeStore(e),t.pause(),yield Promise.all([t._source.update(i,e.schema.source),t.featureStore.updateSchema(i,e.schema.targets.feature),t.attributeStore.update(i,e),t.attributeStore.updateFilters(i,e,t)]),t._initAggregateStore(e),(0,c.pC)(t.aggregateStore)&&(yield t.aggregateStore.updateSchema(i,e.schema.targets.aggregate)),t._initAggregateQueryEngine(t.aggregateStore,e.schema),(0,Z.Z)("esri-2d-update-debug")&&i.describe(),t._set("config",e)})()}applyUpdate(i){var e=this;return(0,_.Z)(function*(){i.version=e._updateVersion,(0,Z.Z)("esri-2d-update-debug")&&console.debug(`Applying update ${i.version}`),i.mesh&&e.clearTiles(),e._updateQueue.resume(),yield e._source.applyUpdate(i),e.notifyChange("updating"),yield(0,H.N1)(()=>!e.updating),(0,c.pC)(e.aggregateStore)&&(yield(0,A.e4)(10),yield(0,H.N1)(()=>!e.updating))})()}onEdits({edits:i}){var e=this;return(0,_.Z)(function*(){(0,Z.Z)("esri-2d-update-debug")&&console.debug("Applying Edit:",i),e._didEdit=!0;try{const t=i.removed.map(s=>s.objectId&&-1!==s.objectId?s.objectId:e._lookupObjectIdByGlobalId(s.globalId)),r=i.addOrModified.map(({objectId:s})=>s);e.featureStore.invalidate(),yield e._source.edit(r,t),e.clearTiles(),e.notifyChange("updating"),(0,c.pC)(e.aggregateStore)&&e.aggregateStore.clear(),yield e._source.resend(),yield(0,H.N1)(()=>!e.updating)}catch{}})()}refresh(i){var e=this;return(0,_.Z)(function*(){if(!i.dataChanged){const t=D.empty();return t.storage.filters=!0,e.applyUpdate(t)}e.featureStore.invalidate(),e.clearTiles(),e._source.refresh(e._updateVersion,i),e._cleanupNeeded=!0,e.notifyChange("updating"),yield(0,H.N1)(()=>!e.updating)})()}clearTiles(){for(const i of this.tileStore.tiles)this.processor.onTileClear(i)}onTileUpdate(i){(0,c.pC)(this.aggregateStore)&&this.aggregateStore.onTileUpdate(i);for(const e of i.added)this._source.subscribe(e,this._updateVersion),this._level=e.level;for(const e of i.removed)this._source.unsubscribe(e),this._cleanupNeeded=!0,this._tileToResolver.has(e.id)&&(this._tileToResolver.get(e.id).resolve(),this._tileToResolver.delete(e.id));this.notifyChange("updating")}onIdle(){var i=this;return(0,_.Z)(function*(){i._invalidated&&(i._invalidated=!1,((0,c.pC)(i.aggregateStore)||"heatmap"===i.processor.type)&&(yield i._repushCurrentLevelTiles())),i._markAndSweep()})()}querySummaryStatistics({query:i,params:e}){var t=this;return(0,_.Z)(function*(){return t.featureQueryEngine.executeQueryForSummaryStatistics(i,e)})()}queryAggregateSummaryStatistics({query:i,params:e}){var t=this;return(0,_.Z)(function*(){return t.aggregateQueryEngine.executeQueryForSummaryStatistics(i,e)})()}queryUniqueValues({query:i,params:e}){var t=this;return(0,_.Z)(function*(){return t.featureQueryEngine.executeQueryForUniqueValues(i,e)})()}queryAggregateUniqueValues({query:i,params:e}){var t=this;return(0,_.Z)(function*(){return t.aggregateQueryEngine.executeQueryForUniqueValues(i,e)})()}queryClassBreaks({query:i,params:e}){var t=this;return(0,_.Z)(function*(){return t.featureQueryEngine.executeQueryForClassBreaks(i,e)})()}queryAggregateClassBreaks({query:i,params:e}){var t=this;return(0,_.Z)(function*(){return t.aggregateQueryEngine.executeQueryForClassBreaks(i,e)})()}queryHistogram({query:i,params:e}){var t=this;return(0,_.Z)(function*(){return t.featureQueryEngine.executeQueryForHistogram(i,e)})()}queryAggregateHistogram({query:i,params:e}){var t=this;return(0,_.Z)(function*(){return t.aggregateQueryEngine.executeQueryForHistogram(i,e)})()}queryExtent(i){return this.featureQueryEngine.executeQueryForExtent(i)}queryAggregates(i){return this.aggregateQueryEngine.executeQuery(i)}queryAggregateCount(i){return this.aggregateQueryEngine.executeQueryForCount(i)}queryAggregateIds(i){return this.aggregateQueryEngine.executeQueryForIds(i)}queryFeatures(i){return this.featureQueryEngine.executeQuery(i)}queryVisibleFeatures(i){var e=this;return(0,_.Z)(function*(){const t=yield e.featureQueryEngine.executeQuery(i),r=t.objectIdFieldName;return t.features=t.features.filter(s=>{const a=e.getDisplayId(s.attributes[r]);return(0,c.yw)(a,o=>e.attributeStore.isVisible(o))}),t})()}queryFeatureCount(i){return this.featureQueryEngine.executeQueryForCount(i)}queryLatestObservations(i){return this.featureQueryEngine.executeQueryForLatestObservations(i)}queryObjectIds(i){return this.featureQueryEngine.executeQueryForIds(i)}queryStatistics(){var i=this;return(0,_.Z)(function*(){return i.featureStore.storeStatistics})()}getObjectId(i){return this.featureStore.lookupObjectId(i,this._storage)}getDisplayId(i){if((0,c.pC)(this.aggregateStore)){const e=this.aggregateStore.getDisplayId(i);if((0,c.Wi)(e)){const t=this.featureStore.lookupDisplayId(i);return this.aggregateStore.getDisplayIdForReferenceId(t)}return e}return this.featureStore.lookupDisplayId(i)}getFeatures(i){const e=[],t=[];for(const r of i){const s=(0,c.pC)(this.aggregateStore)?this.getAggregate(r):null;if((0,c.pC)(s))if((0,c.pC)(s.attributes.referenceId)){const n=this.getFeature(s.attributes.referenceId);(0,c.pC)(n)&&e.push(n)}else t.push(s);else{const n=this.getFeature(r);(0,c.pC)(n)&&e.push(n)}}return{features:e,aggregates:t}}getFeature(i){const e=this.featureStore.lookupFeatureByDisplayId(i,this._storage);if((0,c.Wi)(e))return null;const t=e.readHydratedGeometry(),r=(0,P.di)(t,e.geometryType,e.hasZ,e.hasM);return{attributes:e.readAttributes(),geometry:r}}getAggregate(i){return(0,c.Wi)(this.aggregateStore)?null:this.aggregateStore.getAggregate(i)}getAggregates(){return(0,c.Wi)(this.aggregateStore)?[]:this.aggregateStore.getAggregates()}setHighlight(i){var e=this;return(0,_.Z)(function*(){const t=(0,c.lV)(i.map(r=>e.getDisplayId(r)));return e.attributeStore.setHighlight(i,t)})()}_lookupObjectIdByGlobalId(i){const e=this.service.globalIdField;if((0,c.Wi)(e))throw new Error("Expected globalIdField to be defined");let t=null;if(this.featureStore.forEach(r=>{i===r.readAttribute(e)&&(t=r.getObjectId())}),(0,c.Wi)(t))throw new Error(`Expected to find a feature with globalId ${i}`);return t}_repushCurrentLevelTiles(){var i=this;return(0,_.Z)(function*(){const e=i.tileStore.tiles.filter(r=>r.level===i._level);e.map(function(){var r=(0,_.Z)(function*(s){return i._patchTile({type:"append",id:s.key.id,clear:!0,addOrUpdate:null,end:!1})});return function(s){return r.apply(this,arguments)}}());const t=e.map(function(){var r=(0,_.Z)(function*(s){return i._patchTile({type:"append",id:s.key.id,addOrUpdate:q.i.fromOptimizedFeatures([],i.service),remove:[],end:!0,isRepush:!0,status:D.empty()})});return function(s){return r.apply(this,arguments)}}());yield Promise.all(t)})()}_maybeForceCleanup(){performance.now()-this._lastCleanup>5e3&&this._markAndSweep()}_patchTile(i,e){const t=this._updateQueue.push(i,e).then(()=>{this.notifyChange("updating")}).catch(r=>{this.notifyChange("updating")});return this.notifyChange("updating"),t}_onTileMessage(i,e){var t=this;return(0,_.Z)(function*(){if((0,A.k_)(e),(0,Z.Z)("esri-2d-update-debug")){const a=(0,c.yw)(i.addOrUpdate,o=>o.hasFeatures);console.debug(i.id,`FeatureController:onTileMessage: [clear:${i.clear}, end:${i.end}, features: ${a}]`)}const r=t.tileStore.get(i.id);if(!r)return;if(i.clear)return t.processor.onTileClear(r);const s=i.status;t._cleanupNeeded=!0;const n=[];for(const a of i.remove??[]){const o=t.featureStore.lookupDisplayId(a);o&&n.push(o)}i.remove=n;try{if((0,c.Wi)(i.addOrUpdate))return void t.processor.onTileMessage(r,{...i,addOrUpdate:null},(0,c.pC)(t.aggregateStore),e).catch(A.H9);if(i.addOrUpdate.setArcadeSpatialReference(t.spatialReference),t.featureStore.hasInstance(i.addOrUpdate.instance)&&s.targets.feature||(s.targets.feature=!0,t.featureStore.onTileData(r,i)),(!s.storage.data||!s.storage.filters)&&(s.storage.data=!0,s.storage.filters=!0,t.attributeStore.onTileData(r,i),"stream"===t._source.type||t._didEdit?(yield t.attributeStore.sendUpdates(),(0,A.k_)(e)):t.attributeStore.sendUpdates()),(0,c.pC)(t.aggregateStore)&&!s.targets.aggregate){s.targets.aggregate=!0;const a=_t(t._source)&&t._source.loading,o=!_t(t._source)||a||i.end;if(t.aggregateStore.onTileData(r,i,t._storage,t.attributeStore,o),!o)return;s.mesh||(t.attributeStore.onTileData(r,i),yield t.attributeStore.sendUpdates())}if(!s.mesh){s.mesh=!0;const a=(0,c.pC)(t.aggregateStore)&&"cluster"===t.aggregateStore.type;yield t.processor.onTileMessage(r,i,a,e),(0,A.k_)(e)}t._maybeForceCleanup()}catch(a){(0,A.H9)(a)}})()}_mark(i,e,t){const r=(4294901760&this._storage.getInstanceId(i))>>>16;i&&(e.add(r),t.set(i))}_markAndSweep(){if(this._lastCleanup=performance.now(),"feature"===this._source.type&&"snapshot"===this._source.mode||"stream"!==this._source.type&&!this._cleanupNeeded)return;this._cleanupNeeded=!1;const i=this._storage.getBitset(this._markedIdsBufId),e=new Set;i.clear();for(const t of this.tileStore.tiles)for(const r of this._source.readers(t.id)){const s=r.getCursor();for(;s.next();){let n=s.getDisplayId();if(!n){const a=s.getObjectId();n=this.featureStore.lookupDisplayId(a)}this._mark(n,e,i)}}"symbol"===this.processor.type&&this.processor.forEachBufferId(t=>{this._mark(t,e,i)}),this._updateQueue.forEach(t=>{for(const r of t.remove??[]){const s=this.featureStore.lookupDisplayId(r);this._mark(s,e,i)}}),(0,c.pC)(this.aggregateStore)&&(this.aggregateStore.sweepFeatures(i,this.featureStore),"sweepAggregates"in this.aggregateStore&&this.aggregateStore.sweepAggregates(this._storage,this.attributeStore,this._level)),this.featureStore.sweepFeatures(i,this._storage,this.attributeStore),this.featureStore.sweepFeatureSets(e)}};(0,O._)([(0,M.Cb)({constructOnly:!0})],X.prototype,"tileStore",void 0),(0,O._)([(0,M.Cb)()],X.prototype,"config",void 0),(0,O._)([(0,M.Cb)({readOnly:!0})],X.prototype,"fieldsIndex",null),(0,O._)([(0,M.Cb)()],X.prototype,"processor",void 0),(0,O._)([(0,M.Cb)({constructOnly:!0})],X.prototype,"remoteClient",void 0),(0,O._)([(0,M.Cb)({constructOnly:!0})],X.prototype,"service",void 0),(0,O._)([(0,M.Cb)()],X.prototype,"spatialReference",null),(0,O._)([(0,M.Cb)()],X.prototype,"updating",null),X=(0,O._)([(0,Ee.j)("esri.views.2d.layers.features.controllers.FeatureController2D")],X);const Gs=X;var Qs=f(42666),Bs=f(9598);let ge=class extends ce.r{constructor(){super(...arguments),this.controller=null,this.processor=null,this.remoteClient=null,this.tileStore=null,this.service=null,this.viewState=null,this._paused=!1,this._pendingTileUpdates=[]}initialize(){this.handles.add((0,H.YP)(()=>this.updating,i=>{this.remoteClient.invoke("setUpdating",i).catch(e=>{})}))}destroy(){this.stop(),this.controller?.destroy(),this.processor?.destroy(),this.controller=this.processor=this.tileStore=this.remoteClient=null}get updating(){return!this.controller||this.controller.updating}stop(){this._paused=!0,Array.isArray(this.service?.source)&&(this.service.source.forEach(i=>i.close()),this.service.source.length=0),this.tileStore?.updateTiles({added:[],removed:this.tileStore.tiles.map(i=>i.id)}),this.tileStore?.destroy(),this.tileStore=null,this._pendingTileUpdates.length=0}startup({service:i,config:e,tileInfo:t,tiles:r}){var s=this;return(0,_.Z)(function*(){if(s._paused=!0,Array.isArray(s.service?.source)&&(s.service.source.forEach(n=>n.close()),s.service.source.length=0),s.service=i,!s.tileStore||!(0,Ae.fS)(s.tileStore.tileScheme.spatialReference,t.spatialReference)){const n=new Bs.Z(xt.Z.fromJSON(t));r.added.length=r.removed.length=0,s.tileStore?.updateTiles({added:[],removed:s.tileStore.tiles.map(a=>a.id)}),s.tileStore?.destroy(),s.tileStore=new Qs.Z(n),s._pendingTileUpdates.length=0}for(yield s._createProcessorAndController(e),yield s.update({config:e}),s.controller.resume(),s.tileStore.clear(),s.tileStore.updateTiles(r),s._paused=!1;s._pendingTileUpdates.length;)s.tileStore.updateTiles(s._pendingTileUpdates.pop())})()}updateTiles(i){var e=this;return(0,_.Z)(function*(){e._paused?e._pendingTileUpdates.push(i):e.tileStore?.updateTiles(i)})()}update({config:i}){var e=this;return(0,_.Z)(function*(){const t=D.empty();return yield Promise.all([e.processor.update(t,i),e.controller.update(t,i)]),t.toJSON()})()}applyUpdate(i){var e=this;return(0,_.Z)(function*(){return e.controller.applyUpdate(D.create(i))})()}_createProcessorAndController(i){var e=this;return(0,_.Z)(function*(){yield Promise.all([e._handleControllerConfig(i),e._handleProcessorConfig(i)]),e.controller.processor=e.processor})()}_handleControllerConfig(i){var e=this;return(0,_.Z)(function*(){return e._createController(e.service,i)})()}_handleProcessorConfig(i){var e=this;return(0,_.Z)(function*(){return e._createProcessor(e.service,i)})()}_createController(i,e){var t=this;return(0,_.Z)(function*(){t.controller&&t.controller.destroy();const{tileStore:r,remoteClient:s}=t,n=new Gs({service:i,tileStore:r,remoteClient:s});return t.controller=n,n})()}_createProcessor(i,e){var t=this;return(0,_.Z)(function*(){const r=e.schema.processors[0].type,s=(yield function bt(i){return"heatmap"===i?Promise.all([f.e(8592),f.e(7434)]).then(f.bind(f,67434)):Promise.all([f.e(2815),f.e(3871),f.e(1619),f.e(8592),f.e(7118)]).then(f.bind(f,61517))}(r)).default,{remoteClient:n,tileStore:a}=t,o=new s({service:i,config:e,tileStore:a,remoteClient:n});return t.processor&&t.processor.destroy(),t.processor=o,o})()}};(0,O._)([(0,M.Cb)()],ge.prototype,"controller",void 0),(0,O._)([(0,M.Cb)()],ge.prototype,"processor",void 0),(0,O._)([(0,M.Cb)()],ge.prototype,"updating",null),(0,O._)([(0,M.Cb)()],ge.prototype,"viewState",void 0),ge=(0,O._)([(0,Ee.j)("esri.views.2d.layers.features.Pipeline")],ge);const qs=ge}}]);