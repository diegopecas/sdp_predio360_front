"use strict";(self.webpackChunkpredio360_app=self.webpackChunkpredio360_app||[]).push([[5357,5611],{47139:(ne,W,l)=>{l.d(W,{Fp:()=>V,RL:()=>G,UV:()=>$,bk:()=>z});var f=l(36161),x=l(91179),Z=l(31375),O=l(39351);function V(S){switch(S.type){case"CIMPointSymbol":{const E=S.symbolLayers;if(!E||1!==E.length)return null;const U=E[0];return"CIMVectorMarker"!==U.type?null:V(U)}case"CIMVectorMarker":{const E=S.markerGraphics;if(!E||1!==E.length)return null;const U=E[0];if(!U)return null;const M=U.geometry;if(!M)return null;const d=U.symbol;return!d||"CIMPolygonSymbol"!==d.type&&"CIMLineSymbol"!==d.type||d.symbolLayers?.some(_=>!!_.effects)?null:{type:"sdf",geom:M,asFill:"CIMPolygonSymbol"===d.type}}}}function F(S){let E=1/0,U=-1/0,M=1/0,d=-1/0;for(const _ of S)for(const g of _)g[0]<E&&(E=g[0]),g[0]>U&&(U=g[0]),g[1]<M&&(M=g[1]),g[1]>d&&(d=g[1]);return[E,M,U,d]}function z(S){return S?S.rings?F(S.rings):S.paths?F(S.paths):(0,x.YX)(S)?[S.xmin,S.ymin,S.xmax,S.ymax]:null:null}function $(S,E,U,M,d){const[_,g,c,y]=S;if(c<_||y<g)return[0,0,0,1];const h=c-_,v=y-g,R=O.s4,D=Math.floor(.5*(64-R)),A=(128-2*(D+R))/Math.max(h,v),L=Math.round(h*A)+2*D,H=Math.round(v*A)+2*D;let Q=1;E&&(Q=H/A/(E.ymax-E.ymin));let K=0,k=0,Y=1;M&&(d?E&&U&&E.ymax-E.ymin>0&&(Y=(E.xmax-E.xmin)/(E.ymax-E.ymin),K=M.x/(U*Y),k=M.y/U):(K=M.x,k=M.y)),E&&(K=.5*(E.xmax+E.xmin)+K*(E.xmax-E.xmin),k=.5*(E.ymax+E.ymin)+k*(E.ymax-E.ymin)),K-=_,k-=g,K*=A,k*=A,K+=D,k+=D;let oe=K/L-.5,Ve=k/H-.5;return d&&U&&(oe*=U*Y,Ve*=U),[Q,oe,Ve,Y]}function G(S){const E=function I(S){return S?S.rings?S.rings:S.paths?S.paths:void 0!==S.xmin&&void 0!==S.ymin&&void 0!==S.xmax&&void 0!==S.ymax?[[[S.xmin,S.ymin],[S.xmin,S.ymax],[S.xmax,S.ymax],[S.xmax,S.ymin],[S.xmin,S.ymin]]]:null:null}(S.geom),U=function P(S){let E=1/0,U=-1/0,M=1/0,d=-1/0;for(const _ of S)for(const g of _)g[0]<E&&(E=g[0]),g[0]>U&&(U=g[0]),g[1]<M&&(M=g[1]),g[1]>d&&(d=g[1]);return new Z.Z(E,M,U-E,d-M)}(E),d=O.s4,_=Math.floor(.5*(64-d)),g=(128-2*(_+d))/Math.max(U.width,U.height),c=Math.round(U.width*g)+2*_,y=Math.round(U.height*g)+2*_,h=[];for(const w of E)if(w&&w.length>1){const R=[];for(const D of w){let[A,L]=D;A-=U.x,L-=U.y,A*=g,L*=g,A+=_-.5,L+=_-.5,R.push(S.asFill?[A,L]:[Math.round(A),Math.round(L)])}if(S.asFill){const D=R.length-1;R[0][0]===R[D][0]&&R[0][1]===R[D][1]||R.push(R[0])}h.push(R)}const v=function ee(S,E,U,M){const d=E*U,_=new Array(d),g=M*M+1;for(let c=0;c<d;++c)_[c]=g;for(const c of S){const y=c.length;for(let h=1;h<y;++h){const v=c[h-1],w=c[h];let R,D,A,L;v[0]<w[0]?(R=v[0],D=w[0]):(R=w[0],D=v[0]),v[1]<w[1]?(A=v[1],L=w[1]):(A=w[1],L=v[1]);let H=Math.floor(R)-M,Q=Math.floor(D)+M,K=Math.floor(A)-M,k=Math.floor(L)+M;H<0&&(H=0),Q>E&&(Q=E),K<0&&(K=0),k>U&&(k=U);const Y=w[0]-v[0],oe=w[1]-v[1],Ve=Y*Y+oe*oe;for(let te=H;te<Q;te++)for(let be=K;be<k;be++){let ve,_e,Re=(te-v[0])*Y+(be-v[1])*oe;Re<0?(ve=v[0],_e=v[1]):Re>Ve?(ve=w[0],_e=w[1]):(Re/=Ve,ve=v[0]+Re*Y,_e=v[1]+Re*oe);const je=(te-ve)*(te-ve)+(be-_e)*(be-_e),ke=(U-be-1)*E+te;je<_[ke]&&(_[ke]=je)}}}for(let c=0;c<d;++c)_[c]=Math.sqrt(_[c]);return _}(h,c,y,_);return S.asFill&&function N(S,E,U,M,d){for(const _ of S){const g=_.length;for(let c=1;c<g;++c){const y=_[c-1],h=_[c];let v,w,R,D;y[0]<h[0]?(v=y[0],w=h[0]):(v=h[0],w=y[0]),y[1]<h[1]?(R=y[1],D=h[1]):(R=h[1],D=y[1]);let A=Math.floor(v),L=Math.floor(w)+1,H=Math.floor(R),Q=Math.floor(D)+1;A<M&&(A=M),L>E-M&&(L=E-M),H<M&&(H=M),Q>U-M&&(Q=U-M);for(let K=H;K<Q;++K){if(y[1]>K==h[1]>K)continue;const k=(U-K-1)*E;for(let Y=A;Y<L;++Y)Y<(h[0]-y[0])*(K-y[1])/(h[1]-y[1])+y[0]&&(d[k+Y]=-d[k+Y]);for(let Y=M;Y<A;++Y)d[k+Y]=-d[k+Y]}}}}(h,c,y,_,v),[j(v,_),c,y]}function j(S,E){const U=2*E,M=S.length,d=new Uint8Array(4*M);for(let _=0;_<M;++_)(0,f.I)(.5-S[_]/U,d,4*_);return d}},25665:(ne,W,l)=>{l.d(W,{b:()=>U});var f=l(15861),x=l(26584),Z=l(8314),O=l(63290),V=l(10699),I=l(39351),P=l(99666),F=l(87526),z=l(67969),$=l(85775),G=l(18952),ee=l(31548);class j{constructor(d,_,g){this._texture=null,this._lastTexture=null,this._fbos={},this.texelSize=4;const{buffer:c,pixelType:y,textureOnly:h}=d,v=(0,F.UK)(y);this.blockIndex=g,this.pixelType=y,this.size=_,this.textureOnly=h,h||(this.data=new v(c)),this._resetRange()}destroy(){this._texture?.dispose();for(const d in this._fbos){const _=this._fbos[d];_&&("0"===d&&_.detachColorTexture(),_.dispose()),this._fbos[d]=null}this._texture=null}get _textureDesc(){const d=new ee.X;return d.wrapMode=z.e8.CLAMP_TO_EDGE,d.samplingMode=z.cw.NEAREST,d.dataType=this.pixelType,d.width=this.size,d.height=this.size,d}setData(d,_,g){const c=(0,P.jL)(d),y=this.data,h=c*this.texelSize+_;!y||h>=y.length||(y[h]=g,this.dirtyStart=Math.min(this.dirtyStart,c),this.dirtyEnd=Math.max(this.dirtyEnd,c))}getData(d,_){if(null==this.data)return null;const g=(0,P.jL)(d)*this.texelSize+_;return!this.data||g>=this.data.length?null:this.data[g]}getTexture(d){return this._texture??this._initTexture(d)}getFBO(d,_=0){if(!this._fbos[_]){const g=0===_?this.getTexture(d):this._textureDesc;this._fbos[_]=new $.X(d,g)}return this._fbos[_]}get hasDirty(){return this.dirtyEnd>=this.dirtyStart}updateTexture(d,_){try{const g=this.dirtyStart,c=this.dirtyEnd;if(!this.hasDirty)return;(0,Z.Z)("esri-2d-update-debug")&&console.debug(`Version[${_}] AttributeStoreView.updateTexture`,{start:g,end:c,firstBytes:new Uint8Array(this.data.buffer.slice(0,16)),block:this}),this._resetRange();const y=this.data.buffer,h=this.getTexture(d),v=4,w=(g-g%this.size)/this.size,D=w,L=(c-c%this.size)/this.size,H=w*this.size*v,Q=(this.size+L*this.size)*v-H,K=(0,F.UK)(this.pixelType),k=new K(y,H*K.BYTES_PER_ELEMENT,Q),Y=this.size,oe=L-D+1;if(oe>this.size)return void O.Z.getLogger("esri.views.2d.engine.webgl.AttributeStoreView").error(new x.Z("mapview-webgl","Out-of-bounds index when updating AttributeData"));h.updateData(0,0,D,Y,oe,k)}catch{}}update(d){const{data:_,start:g,end:c}=d;if(null!=_&&null!=this.data){const y=this.data,h=g*this.texelSize;for(let v=0;v<_.length;v++)d.layout&1<<v%this.texelSize&&(y[h+v]=_[v])}this.dirtyStart=Math.min(this.dirtyStart,g),this.dirtyEnd=Math.max(this.dirtyEnd,c)}resize(d,_){const g=this.size;if(this.size=_,this.textureOnly)return void(g!==this.size&&(this._lastTexture=this._texture,this._texture=null));const c=(0,F.UK)(this.pixelType);this.destroy(),this.data=new c(d.buffer)}_resetRange(){this.dirtyStart=2147483647,this.dirtyEnd=0}_initTexture(d){const _=new G.x(d,this._textureDesc,this.data??void 0);if(null!=this._lastTexture&&this._fbos[0]){const g=this._lastTexture.descriptor.width,c=this._lastTexture.descriptor.height,y=this._lastTexture.descriptor.dataType,h=this._lastTexture.descriptor.pixelFormat,v=this.getFBO(d),w=(0,F.Yw)(y),R=new((0,F.UK)(y))(new ArrayBuffer(g*c*w*this.texelSize)),D=d.getBoundFramebufferObject(),{x:A,y:L,width:H,height:Q}=d.getViewport();d.bindFramebuffer(v),v.readPixels(0,0,g,c,h,y,R),_.updateData(0,0,0,2*g,c/2,R),d.setViewport(A,L,H,Q),d.bindFramebuffer(D)}return this.destroy(),this._texture=_,this._texture}}class S{constructor(){this.size=0,this._pendingAttributeUpdates=[],this._version=0,this._epoch=0,this._locked=!1}_initialize(d){if(!d)throw new Error("InternalError: initArgs must be defined");const _=d.blockDescriptors;if(this.size=d.blockSize,(0,Z.Z)("esri-2d-update-debug")&&console.debug("AttributeStoreView.initialize",{message:d}),null==this._data)this._data=_.map((g,c)=>null!=g?new j(g,this.size,c):null);else for(let g=0;g<this._data.length;g++){const c=this._data[g],y=_[g];null!=y&&(null==c?this._data[g]=new j(y,this.size,g):c.resize(y,this.size))}}destroy(){for(const d of this._data??[])d?.destroy();this._defaultTexture?.dispose();for(const{resolver:d}of this._pendingAttributeUpdates)d.reject("AttributeStore destroyed");this._pendingAttributeUpdates=[]}isEmpty(){return null==this._data}getBlock(d){return null==this._data?null:this._data[d]}setLabelMinZoom(d,_){this.setData(d,0,1,_)}getLabelMinZoom(d){return this.getData(d,0,1,255)}getFilterFlags(d){return this.getData(d,0,0,0)}getVVSize(d){return this.getData(d,I.wi.VV,0,0)}getData(d,_,g,c){if(!this._data)return 0;const y=this._data[_];return null==y?0:y.getData(d,g)??c}setData(d,_,g,c){this._data[_].setData(d,g,c)}lockTextureUploads(){this._locked=!0}unlockTextureUploads(){this._locked=!1,this.update()}requestUpdate(d){var _=this;return(0,f.Z)(function*(){const g=(0,V.hh)();g.promise=g.promise.catch(c=>{(0,Z.Z)("esri-2d-update-debug")&&console.error("AttributeStoreView.requestUpdate rejected",c)}),_._version=d.version,_._pendingAttributeUpdates.push({inner:d,resolver:g}),(0,Z.Z)("esri-2d-update-debug")&&console.debug(`Version[${_._version}] AttributeStoreView.requestUpdate`,{message:d})})()}get currentEpoch(){return this._epoch}update(){if(this._locked)return;const d=this._pendingAttributeUpdates;this._pendingAttributeUpdates=[];for(const{inner:_,resolver:g}of d){const{blockData:c,initArgs:y,sendUpdateEpoch:h,version:v}=_;(0,Z.Z)("esri-2d-update-debug")&&console.debug(`Version[${this._version}] Epoch[${h}] AttributeStoreView.applyUpdate`),this._version=v,this._epoch=h,null!=y&&this._initialize(y);const w=this._data;for(let R=0;R<c.length;R++){const D=c[R],A=w[R];null!=A&&null!=D&&((0,Z.Z)("esri-2d-update-debug")&&console.debug(`Version[${this._version}] CpuBlock[${R}] AttributeStoreView.update`,{block:D}),A.update(D))}g.resolve()}}getUniforms(d){return{filterFlags:{texture:this._getTexture(d,I.wi.FilterFlags),unit:I.NY},animation:{texture:this._getTexture(d,I.wi.Animation),unit:I.zZ},gpgpu:{texture:this._getTexture(d,I.wi.GPGPU),unit:I.cz},visualVariableData:{texture:this._getTexture(d,I.wi.VV),unit:I.bm},dataDriven0:{texture:this._getTexture(d,I.wi.DD0),unit:I.j1},dataDriven1:{texture:this._getTexture(d,I.wi.DD1),unit:I.Ly},dataDriven2:{texture:this._getTexture(d,I.wi.DD2),unit:I.ce},size:this.size}}_getTexture(d,_){const g=this._data?.[_];return g?(g.updateTexture(d,this._version),g.getTexture(d)):this._getDefaultTexture(d)}_getDefaultTexture(d){if(null==this._defaultTexture){const _=new ee.X;_.wrapMode=z.e8.CLAMP_TO_EDGE,_.samplingMode=z.cw.NEAREST,_.width=1,_.height=1,this._defaultTexture=new G.x(d,_,new Uint8Array(4))}return this._defaultTexture}}var E=l(26268);class U extends E.Z{constructor(d){super(d),this._statisticsByLevel=new Map,this.attributeView=new S}destroy(){this.children.forEach(d=>d.destroy()),this.removeAllChildren(),this.attributeView.destroy()}doRender(d){d.context.capabilities.enable("textureFloat"),super.doRender(d)}createRenderParams(d){const _=super.createRenderParams(d);return _.attributeView=this.attributeView,_.instanceStore=this._instanceStore,_.statisticsByLevel=this._statisticsByLevel,_}}},26268:(ne,W,l)=>{l.d(W,{Z:()=>P});var f=l(8314),x=l(39406),Z=l(44589),O=l(13382),V=l(7590);const I=(F,z)=>F.key.level-z.key.level!=0?F.key.level-z.key.level:F.key.row-z.key.row!=0?F.key.row-z.key.row:F.key.col-z.key.col;class P extends Z.Z{constructor(z){super(),this._tileInfoView=z}renderChildren(z){this.sortChildren(I),this.setStencilReference(z),super.renderChildren(z)}createRenderParams(z){const{state:$}=z,G=super.createRenderParams(z);return G.requiredLevel=this._tileInfoView.getClosestInfoForScale($.scale).level,G.displayLevel=this._tileInfoView.tileInfo.scaleToZoom($.scale),G}prepareRenderPasses(z){const $=super.prepareRenderPasses(z);return $.push(z.registerRenderPass({name:"stencil",brushes:[O.Z],drawPhase:x.jx.DEBUG|x.jx.MAP|x.jx.HIGHLIGHT|x.jx.LABEL,target:()=>this.getStencilTarget()})),(0,f.Z)("esri-tiles-debug")&&$.push(z.registerRenderPass({name:"tileInfo",brushes:[V.Z],drawPhase:x.jx.DEBUG,target:()=>this.children})),$}getStencilTarget(){return this.children}setStencilReference(z){let $=1;for(const G of this.children)G.stencilRef=$++}}},4151:(ne,W,l)=>{l.d(W,{o:()=>x});var f=l(24055);class x{constructor(O,V,I,P,F){this._instanceId=O,this.techniqueRef=V,this._meshWriterName=I,this._input=P,this.optionalAttributes=F}get instanceId(){return(0,f.G)(this._instanceId)}createMeshInfo(O){return{id:this._instanceId,meshWriterName:this._meshWriterName,options:O,optionalAttributes:this.optionalAttributes}}getInput(){return this._input}setInput(O){this._input=O}}},46850:(ne,W,l)=>{l.r(W),l.d(W,{default:()=>ri});var f=l(15861),x=l(17626),Z=l(88879),O=l(77712),V=l(8314),I=l(63290),F=(l(4619),l(76898));let z=class extends Z.Z{constructor(){super(...arguments),this.isAggregate=!0}getEffectivePopupTemplate(t=!1){if(this.popupTemplate)return this.popupTemplate;const e=this.sourceLayer?.featureReduction;return e&&"popupTemplate"in e&&e.popupEnabled?e.popupTemplate:null}getObjectId(){return this.attributes.aggregateId}};(0,x._)([(0,O.Cb)({type:Boolean})],z.prototype,"isAggregate",void 0),z=(0,x._)([(0,F.j)("esri.AggregateGraphic")],z);const $=z;l(29132);var ee=l(85931),N=l(46160),j=l(94573),S=l(26584),E=l(54024),U=l(62208),M=l(10699),d=l(32917),_=l(84682),g=l(83761),c=l(52884);let y=class extends g.Z{constructor(t){super(t),this._filter=null,this.duration=(0,V.Z)("mapview-transitions-duration"),this._excludedEffectView=new c.AM(t),this._includedEffectView=new c.AM(t)}get excludedEffects(){return this._excludedEffectView.effects}set featureEffect(t){this._get("featureEffect")!==t&&this._transitionTo(t)}get filter(){return this._filter||this.featureEffect?.filter||null}get hasEffects(){return this._excludedEffectView.hasEffects||this._includedEffectView.hasEffects}get includedEffects(){return this._includedEffectView.effects}set scale(t){this._set("scale",t),this._excludedEffectView.scale=t,this._includedEffectView.scale=t}get transitioning(){return this._excludedEffectView.transitioning||this._includedEffectView.transitioning}transitionStep(t,e){this._set("scale",e),this.transitioning?(this._includedEffectView.transitionStep(t,e),this._excludedEffectView.transitionStep(t,e),this.transitioning||(this._filter=null)):(this._excludedEffectView.scale=e,this._includedEffectView.scale=e)}endTransitions(){this._includedEffectView.endTransitions(),this._excludedEffectView.endTransitions(),this._filter=null}_transitionTo(t){const e=this._get("featureEffect"),r=t,s=r?.includedEffect,a=r?.excludedEffect,o=this._includedEffectView.canTransitionTo(s)&&this._excludedEffectView.canTransitionTo(a);this._includedEffectView.effect=s,this._excludedEffectView.effect=a,this._set("featureEffect",r),this._filter=r?.filter||e?.filter||null,o||this.endTransitions()}};(0,x._)([(0,O.Cb)()],y.prototype,"_filter",void 0),(0,x._)([(0,O.Cb)()],y.prototype,"_excludedEffectView",void 0),(0,x._)([(0,O.Cb)()],y.prototype,"_includedEffectView",void 0),(0,x._)([(0,O.Cb)()],y.prototype,"duration",void 0),(0,x._)([(0,O.Cb)()],y.prototype,"excludedEffects",null),(0,x._)([(0,O.Cb)()],y.prototype,"featureEffect",null),(0,x._)([(0,O.Cb)()],y.prototype,"filter",null),(0,x._)([(0,O.Cb)()],y.prototype,"hasEffects",null),(0,x._)([(0,O.Cb)()],y.prototype,"includedEffects",null),(0,x._)([(0,O.Cb)({value:0})],y.prototype,"scale",null),(0,x._)([(0,O.Cb)()],y.prototype,"transitioning",null),y=(0,x._)([(0,F.j)("esri.layers.effects.FeatureEffectView")],y);const h=y;var v=l(98624),w=l(90194),R=l(72469),D=l(68653),A=l(17253),L=l(65234);let H=class extends A.Z{constructor(){super(...arguments),this.features=[]}readFeatures(t,e){const r=L.Z.fromJSON(e.spatialReference),s=[];for(let a=0;a<t.length;a++){const o=t[a],u=$.fromJSON(o),p=o.geometry?.spatialReference;null==u.geometry||p||(u.geometry.spatialReference=r);const m=o.aggregateGeometries,b=u.aggregateGeometries;if(m&&null!=b)for(const C in b){const T=b[C],J=m[C]?.spatialReference;null==T||J||(T.spatialReference=r)}s.push(u)}return s}};(0,x._)([(0,O.Cb)({type:[$],json:{write:!0}})],H.prototype,"features",void 0),(0,x._)([(0,D.r)("features")],H.prototype,"readFeatures",null),H=(0,x._)([(0,F.j)("esri.rest.support.AggregateFeatureSet")],H);const Q=H;var K=l(96854),k=l(72571),Y=l(56800),oe=l(11426),Ve=l(25665),te=l(39406),be=l(77275),ve=l(4151),_e=l(24055);class Re{constructor(){this._instanceById=new Map}destroy(){this._instanceById.clear()}get size(){return this._instanceById.size}updateStart(){this._instanceByIdNext=new Map}updateEnd(){if(!this._instanceByIdNext)throw new Error("InternalError: Found updateEnd call without corresponding updateStart");for(const e of this._instanceById.keys())this._instanceByIdNext.has(e)||this._instanceById.delete(e);for(const[e,r]of this._instanceByIdNext.entries()){const s=this._instanceById.get(e);s?s.setInput(r.getInput()):this._instanceById.set(e,r)}this._instanceByIdNext=null}values(){return this._instanceById.values()}ensureInstance(e,r,s){let a=`${e.registryName}`;for(const u in r){const p=r[u];if("object"==typeof p&&"geometry"===u)for(const m in p)a+=`.${u}.${m}.${null!=p[m]}`;else a+=`.${u}.${null!=r[u]}`}if(null!=s)for(const u in s)s[u]&&(a+=`-${u}`);const o=(0,be.hP)(a);if(this._instanceByIdNext){const u=new ve.o((0,_e.W)(o),e,e.meshWriter.name,r,s);return this._instanceByIdNext.set(o,u),u}if(!this._instanceById.has(o)){const u=new ve.o((0,_e.W)(o),e,e.meshWriter.name,r,s);this._instanceById.set(o,u)}return this._instanceById.get(o)}getInstance(e){return this._instanceById.get(e)}}var je=l(65401),Ye=(l(9598),l(58098)),Mt=(l(8480),l(79527),l(96552)),Tt=l(55376);class wt{constructor(e,r,s){this.getStage=e,this.version=r,this._tileInfoView=s,this._tiles=new Map,this._pendingUpdates=[],this._locked=!1}destroy(){}tiles(){return this._tiles.values()}size(){return this._tiles.size}setTiles(e){this._tiles.clear();for(const r of e)this._tiles.set(r.key.id,r)}lockUploads(){this._locked=!0}unlockUploads(){this._locked=!1;for(const e of this._pendingUpdates)this.updateTile(e);this._pendingUpdates=[]}updateTile(e){if(this._locked)return void this._pendingUpdates.push(e);(0,V.Z)("esri-2d-update-debug")&&console.debug(`Version[${e.version}] Tile[${e.id}] Chunk[${e.debugInfo?.chunkId??"<EnsureEnd>"}] RenderState.updateTile [${e.type}]`,e);const r=this._ensureTile(e.id);if("update"===e.type){const[o,...u]=e.modify;r.onMessage({type:"update",modify:o,remove:e.remove,end:e.end,attributeEpoch:e.attributeEpoch});for(const p of u){const m=this._tiles.get(p.tileId);m&&m.onMessage({type:"update",modify:p,remove:e.remove,end:!1,isPixelBuffer:!0,attributeEpoch:null})}return}if(null==e.append)return void r.onMessage({type:"append",clear:e.clear,debugInfo:e.debugInfo,end:e.end,attributeEpoch:e.attributeEpoch});const[s,...a]=e.append;r.onMessage({type:"append",clear:e.clear,append:s,debugInfo:e.debugInfo,end:e.end,attributeEpoch:e.attributeEpoch});for(const o of a){const u=this._tiles.get(o.tileId);u&&u.onMessage({type:"update",modify:o,remove:[],sort:!1,end:!1,isPixelBuffer:!0,attributeEpoch:null})}}removeTile(e){const r=this._tiles.get(e);(0,V.Z)("esri-2d-update-debug")&&console.debug(`Tile[${e}] RenderState.removeTile`),r?.destroy(),this._tiles.delete(e)}isTileDone(e){const r=this._tiles.get(e.id);return!!r&&r.isReady}_ensureTile(e){if(!this._tiles.has(e)){const r=this._createTile(e);this._copyPixelBufferedEntitiesInto(r),this._tiles.set(e,r)}return this._tiles.get(e)}_createTile(e){(0,V.Z)("esri-2d-update-debug")&&console.debug(`Version[${this.version}] Tile[${e}] RenderState.createTile`);const r=new Ye.Z(e),s=this._tileInfoView.getTileBounds((0,je.Ue)(),r),a=this._tileInfoView.getTileResolution(r.level),o=new Mt.$(r,a,s[0],s[3],!0);if(o.stage=this.getStage(),!o.stage){const u=new S.Z("featurelayerview:webgl","Cannot create tile with empty stage");I.Z.getLogger("esri.views.2d.layers.features.RenderState").error(u)}return o}_copyPixelBufferedEntitiesInto(e){let r=7;for(let s=-1;s<=1;s++)for(let a=-1;a<=1;a++){if(0===s&&0===a)continue;const u=(0,Tt.M)(e.key,a,s,this._tileInfoView.tileInfo.isWrappable).id,p=this._tiles.get(u);null!=p&&e.copyPixelBufferedEntitesFrom(p,1<<r,a,s),r--}}}var At=l(38321);class Ut{constructor(e,r){this.id=e,this.version=r,this._resolver=(0,M.hh)(),this._done=!1}get done(){return this._done}get promise(){return this._resolver.promise}end(){this._resolver.resolve(),this._done=!0}destroy(){this._resolver.reject()}}class Dt extends Ve.b{constructor(e){super(e.view.featuresTilingScheme),this.updatingHandles=new oe.R,this._hitTestsRequests=[],this._store=new Re,this._visibleTiles=new Set,this._subscriptions=new Map,this._updateStatisticsRequests=[],this._lockStatisticUpdates=!1,this._layerView=e}renderChildren(e){if(this.attributeView.update(),this._renderState){const r=Array.from(this._renderState.tiles()).filter(s=>s.needsUpload);r.length&&(r[Math.floor(Math.random()*r.length)].upload(),r.length>=2&&this.requestRender());for(const s of this._renderState.tiles())s.tryReady(this.attributeView.currentEpoch)&&(this._layerView.requestUpdate(),this.hasLabels&&this._layerView.view.labelManager.requestUpdate(),this.requestRender())}for(const r of this.children)r.setTransform(e.state);switch(this.hasAnimation&&e.painter.effects.integrate.draw(e,e.attributeView),super.renderChildren(e),e.drawPhase){case te.jx.MAP:return this._renderMapPhase(e);case te.jx.HIGHLIGHT:return this._renderHighlightPhase(e);case te.jx.LABEL:return this._renderLabelPhase(e)}}subscriptions(){return this._subscriptions.values()}get _instanceStore(){return this._store}get instanceStore(){return this._store}get layerView(){return this._layerView}get hasLabels(){return this._layerView.labelingCollisionInfos.length>0}get hasHighlight(){return this._layerView.hasHighlight()}get _layer(){return this._layerView.layer}_getExclusivePostprocessingInstance({drawPhase:e}){if(null==this._instanceStore)return null;let r=0,s=null;for(const a of this._instanceStore.values())a.techniqueRef.drawPhase&e&&(r++,a.techniqueRef.postProcessingEnabled&&(s=a));return r>1?null:s}_getOverrideStencilRef({drawPhase:e}){if(null==this._instanceStore)return null;let r=null;for(const s of this._instanceStore.values()){if(!(s.techniqueRef.drawPhase&e))continue;const{overrideStencilRef:a}=s.techniqueRef;if(null==r)r=a;else if(r!==a){r=null;break}}return r}get children(){return this._renderState?Array.from(this._renderState.tiles()).filter(e=>this._visibleTiles.has(e.key.id)):[]}updateAttributeView(e){var r=this;return(0,f.Z)(function*(){r.requestRender(),yield r.updatingHandles.addPromise(r.attributeView.requestUpdate(e)),r.hasLabels&&r._layerView.view.labelManager.requestUpdate()})()}updateSubscriptions(e){for(const{tileId:r,version:s}of e.subscribe)if(this._subscriptions.has(r))this._subscriptions.get(r).version=s;else{const a=new Ut(r,s);this._subscriptions.set(r,a),this.updatingHandles.addPromise(a.promise)}for(const r of e.unsubscribe)this._subscriptions.get(r)?.destroy(),this._subscriptions.delete(r),this.removeTile(r)}isDone(e){return!!this._renderState&&this._renderState.isTileDone(e)}updateRenderState(e){var r=this;return(0,f.Z)(function*(){(0,V.Z)("esri-2d-update-debug")&&console.debug(`Version[${e}] FeatureContainer.updateRenderState`),r._renderStateNext=new wt(()=>r._stage,e,r._tileInfoView)})()}getDisplayStatistics(e,r){const s=this._statisticsByLevel.get(e);return s?s.get(r):null}updateStatistics(e,r){if(this._lockStatisticUpdates)return void this._updateStatisticsRequests.push({level:e,statistics:r});let s=this._statisticsByLevel.get(e);s||(s=new Map,this._statisticsByLevel.set(e,s));for(const a of r)s.set(a.fieldName,{minValue:a.minValue,maxValue:a.maxValue})}editStart(){this._renderState?.lockUploads(),this.attributeView.lockTextureUploads(),this._lockStatisticUpdates=!0}editEnd(){this._renderState?.unlockUploads(),this.attributeView.unlockTextureUploads(),this._lockStatisticUpdates=!1;for(const e of this._updateStatisticsRequests)this.updateStatistics(e.level,e.statistics);this._updateStatisticsRequests=[],this.requestRender()}swapRenderState(){if(this._renderStateNext&&((0,V.Z)("esri-2d-update-debug")&&console.debug(`Version[${this._renderStateNext.version}] FeatureContainer.update.swapRenderState`),this._renderState?.destroy(),this._renderState=this._renderStateNext,this._renderStateNext=null),this._renderState)for(const e of this._renderState.tiles())e.upload();this.requestRender()}setVisibleTiles(e){this._visibleTiles=e}onMessage(e,r){var s=this;return(0,f.Z)(function*(){if((0,M.k_)(r),!s._subscriptions.has(e.id))return;const a=s._subscriptions.get(e.id);if(a.version!==e.subscriptionVesrion)return void((0,V.Z)("esri-2d-update-debug")&&console.debug(`Version[${e.subscriptionVesrion} != ${a.version}] Tile[${e.id}] FeatureContainer - Dropping message, outdated version]`,e));const o=s._renderStateNext??s._renderState;if(!o)throw new Error("InternalError: No renderState defined");o.version!==e.version&&console.error(`InternalError: Version mismatch. [renderState: ${o.version}, message: ${e.version}]`),o.updateTile(e),e.end&&s._subscriptions.get(e.id).end(),s.requestRender(),s._layerView.view.labelManager.requestUpdate(),s._layerView.requestUpdate()})()}removeTile(e){(this._renderState||this._renderStateNext)&&(this._renderState&&this._renderState.removeTile(e),this._renderStateNext&&this._renderStateNext.removeTile(e))}hitTest(e){let r=this._hitTestsRequests.find(({x:a,y:o})=>a===e.x&&o===e.y);const s=(0,M.hh)();return r?r.resolvers.push(s):(r={x:e.x,y:e.y,resolvers:[s]},this._hitTestsRequests.push(r)),this.requestRender(),s.promise}getSortKeys(e){const r=new Set(e),s=new Map;for(const a of this.children)if(a.getSortKeys(r).forEach((o,u)=>s.set(u,o)),s.size===r.size)break;return s}get hasAnimation(){return this.hasLabels}updateTransitionProperties(e,r){super.updateTransitionProperties(e,r),this._layerView.featureEffectView.transitionStep(e,r),this._layerView.featureEffectView.transitioning&&this.requestRender()}doRender(e){const{minScale:r,maxScale:s}=this._layer.effectiveScaleRange,a=e.state.scale;a<=(r||1/0)&&a>=s&&super.doRender(e)}afterRender(e){super.afterRender(e),this._hitTestsRequests.length&&this.requestRender()}setStencilReference(e){const r=this._getOverrideStencilRef(e);if(null==r)super.setStencilReference(e);else for(const s of this.children)s.stencilRef=r(s)}_renderMapPhase(e){this._layerView.featureEffectView.hasEffects?(this._renderOutsideEffect(e),this._renderInsideEffect(e)):this._renderFeatures(e,te.Xq.All),this._hitTestsRequests.length>0&&this._renderHittest(e)}_renderHighlightPhase(e){this.hasHighlight&&(0,At.P9)(e,!1,r=>{this._renderFeatures(r,te.Xq.Highlight)})}_renderLabelPhase(e){this._renderFeatures(e,te.Xq.All)}_renderInsideEffect(e){const r=e.painter.effects.insideEffect;r.bind(e),this._renderFeatures(e,te.Xq.InsideEffect),r.draw(e,this._layerView.featureEffectView.includedEffects),r.unbind()}_renderOutsideEffect(e){const r=e.painter.effects.outsideEffect;r.bind(e),this._renderFeatures(e,te.Xq.OutsideEffect),r.draw(e,this._layerView.featureEffectView.excludedEffects),r.unbind()}_renderHittest(e){const{context:r}=e,s=e.painter.effects.hittest,a=r.getBoundFramebufferObject(),o=r.getViewport(),u=e.passOptions;s.bind(e),e.passOptions=s.createOptions(e,this._hitTestsRequests),this._renderFeatures(e,te.Xq.All),s.draw(e),s.unbind(),r.bindFramebuffer(a),r.restoreViewport(o),e.passOptions=u}_renderFeatures(e,r){for(const a of this.children){if(!a.visible)continue;const o=(0,V.Z)("featurelayer-force-marker-text-draw-order")?te.gl.STRICT_MARKERS_AND_TEXT:te.gl.BATCHING,u=a.getDisplayList(e.drawPhase,this._instanceStore,o);e.selection=r,u?.render(e)}const s=this._getExclusivePostprocessingInstance(e);s?.techniqueRef.postProcess(e,s)}}var Lt=l(97347);function Xe(){return(Xe=(0,f.Z)(function*(t){const e=yield(0,Lt.bA)("FeaturePipelineWorker",{client:t,strategy:"dedicated"});return new Bt(e)})).apply(this,arguments)}class Bt{constructor(e){this._connection=e,this.pipeline=this._connection.createInvokeProxy(),this.features=this._connection.createInvokeProxy("features"),this.aggregates=this._connection.createInvokeProxy("aggregates"),this.streamMessenger=this._connection.createInvokeProxy("streamMessenger")}destroy(){this._connection.destroy()}get closed(){return this._connection.closed}}var Zt=l(61885),jt=l(88634);let pe=class extends g.Z{constructor(){super(...arguments),this.events=new Zt.Z,this._updatingStrategy=!0,this._tileToEvent=new jt.Z,this._fetchStatus={outstanding:0,done:0}}get hasAllFeatures(){return this._hasAllData()&&(this._strategyInfo?.willQueryAllFeatures??!1)}get hasAllFeaturesInView(){return this._hasAllData()}get hasFullGeometries(){return this._hasAllData()&&(this._strategyInfo?.willQueryFullResolutionGeometry??!1)}onEvent(t){switch(t.type){case"subscribe":case"unsubscribe":case"loaded":case"error":this._handleTileEvent(t);break;case"updateStrategyStart":this._updatingStrategy=!0,this._fetchStatus={done:0,outstanding:0},this._strategyInfo=t.about;break;case"updateStrategyEnd":this._updatingStrategy=!1;break;case"updateFieldsStart":this._fetchStatus={done:0,outstanding:0};break;case"updateFieldsEnd":break;case"updateFieldsError":this.events.emit("error",t);break;case"fetchStart":this._fetchStatus.outstanding+=1,this.events.emit("status",this._fetchStatus);break;case"fetchEnd":this._fetchStatus.done+=1,this.events.emit("status",this._fetchStatus),t.done&&(this._fetchStatus={done:0,outstanding:0})}}_hasAllData(){return!this._updatingStrategy&&this._hasAllTileData()}_hasAllTileData(){for(const t of this._tileToEvent.values())if("loaded"!==t[t.length-1].type)return!1;return!0}_handleTileEvent(t){switch(t.type){case"subscribe":this._tileToEvent.set(t.tile,[t]);break;case"unsubscribe":this._tileToEvent.delete(t.tile);break;case"loaded":{const e=this._tileToEvent.get(t.tile);if(!e)return;e.push(t),this._tileToEvent.set(t.tile,e);break}case"error":{const e=this._tileToEvent.get(t.tile);if(!e)return;e.push(t),this._tileToEvent.set(t.tile,e),this.events.emit("error",t);break}}}};(0,x._)([(0,O.Cb)({readOnly:!0})],pe.prototype,"hasAllFeatures",null),(0,x._)([(0,O.Cb)({readOnly:!0})],pe.prototype,"hasAllFeaturesInView",null),(0,x._)([(0,O.Cb)({readOnly:!0})],pe.prototype,"hasFullGeometries",null),(0,x._)([(0,O.Cb)()],pe.prototype,"_updatingStrategy",void 0),(0,x._)([(0,O.Cb)()],pe.prototype,"_strategyInfo",void 0),(0,x._)([(0,O.Cb)()],pe.prototype,"_tileToEvent",void 0),pe=(0,x._)([(0,F.j)("esri.views.2d.layers.features.FeatureSourceEventLog")],pe);var De=l(58817),Ne=l(38305);function fe(t){switch(t.geometryType){case"point":return"esriGeometryPoint";case"polyline":return"esriGeometryPolyline";case"polygon":case"multipatch":return"esriGeometryPolygon";case"multipoint":return"esriGeometryMultipoint";default:return null}}var Le=l(23841),ae=l(80263),Ke=l(21286),Kt=l(21254),Se=l(86971);const Jt=Math.PI;function xt(t,e){switch(e.transformationType){case Se.hL.Additive:return function Wt(t,e){return t+(ce(e.minSize,t)||e.minDataValue)}(t,e);case Se.hL.Constant:return function Ht(t,e){const r=t.stops;let s=r?.length&&r[0].size;return null==s&&(s=t.minSize),ce(s,e)}(e,t);case Se.hL.ClampedLinear:return function $t(t,e){const r=e.minDataValue,s=e.maxDataValue,a=(t-r)/(s-r),o=ce(e.minSize,t),u=ce(e.maxSize,t);return t<=r?o:t>=s?u:o+a*(u-o)}(t,e);case Se.hL.Proportional:return function Gt(t,e){const r=t/e.minDataValue,s=ce(e.minSize,t),a=ce(e.maxSize,t);let o=null;return o=r*s,(0,Ke.uZ)(o,s,a)}(t,e);case Se.hL.Stops:return function Qt(t,e){const[r,s,a]=function Yt(t,e){if(!e)return;let r=0,s=e.length-1;return e.some((a,o)=>t<a?(s=o,!0):(r=o,!1)),[r,s,(t-e[r])/(e[s]-e[r])]}(t,e.cache.ipData);if(r===s)return ce(e.stops[r].size,t);{const o=ce(e.stops[r].size,t);return o+(ce(e.stops[s].size,t)-o)*a}}(t,e);case Se.hL.RealWorldSize:return function kt(t,e){const r=Kt.a[e.valueUnit],s=ce(e.minSize,t),a=ce(e.maxSize,t),{valueRepresentation:o}=e;let u=null;return u="area"===o?2*Math.sqrt(t/Jt)/r:"radius"===o||"distance"===o?2*t/r:t/r,(0,Ke.uZ)(u,s,a)}(t,e);case Se.hL.Identity:return t;case Se.hL.Unknown:return null}}function ce(t,e){return"number"==typeof t?t:xt(e,t)}function Ee(t){return(t.labelsVisible&&t.labelingInfo?.every(e=>"none"!==e.deconflictionStrategy))??!1}function Te(t,e){const r=(0,ae.g)(t,e);if(r?.labelsVisible&&r.labelingInfo?.length)return r.labelingInfo.every(s=>"none"!==s.deconflictionStrategy)}function Xt(t){return e=>(0,Le.F2)(xt(e,t))}function Oe(t){const e=null!=t&&"visualVariables"in t&&t.visualVariables;if(!e)return null;for(const r of e)if("size"===r.type)return Xt(r);return null}var Je=l(95737);function Ce(t,e,r,s,a){const u=(0,Je._)(e.definitionExpression,null!=e.subtypeCode?`${e.subtypeField} = ${e.subtypeCode}`:null),p=e.customParameters??{};return a&&(p.token=a),{type:"feature",mutable:{sourceRefreshVersion:s,availableFields:r.availableFields,dataFilter:{definitionExpression:u,gdbVersion:e.gdbVersion,historicMoment:e.historicMoment?.getTime(),outSpatialReference:r.outSpatialReference.toJSON(),timeExtent:e.timeExtent?.toJSON(),customParameters:p}},service:t,tileInfoJSON:r.tileInfoJSON}}var qt=l(74154),er=l(62667),tr=(l(20383),l(36859)),xe=l(35909),he=l(7547),rr=l(47139),ir=l(40028);function sr(t,e,r=0){if(null==e)return t[r]=0,t[r+1]=0,t[r+2]=0,void(t[r+3]=0);const{r:s,g:a,b:o,a:u}=e;t[r]=s*u/255,t[r+1]=a*u/255,t[r+2]=o*u/255,t[r+3]=u}l(5254);var We=l(39351),ie=l(33428),He=l(5352),q=l(31201),$e=l(80095),Ie=l(6939),nr=l(88493);function ye(t,e){return qe.apply(this,arguments)}function qe(){return qe=(0,f.Z)(function*(t,e){if(!t)return[];switch(t.type){case"simple-fill":return Vt(t,e);case"picture-fill":return function gr(t,e){const{outline:r}=t,{uniforms:s,schemaOptions:a}=e,{store:o}=a,u=[],p=xe.B$.createPictureFillRasterizationParam(t);if(!p)return[];const{width:m,height:b,xoffset:C,yoffset:T,xscale:B,yscale:J}=t,X={color:[255,255,255,255],sprite:p,height:b,aspectRatio:m/b,offsetX:C,offsetY:T,scaleX:B,scaleY:J,angle:0,applyRandomOffset:!1,sampleAlphaOnly:!1,scaleProportionally:!1,effects:null,scaleInfo:null};if("solid"===r?.style)return[o.ensureInstance(ie.k2.complexOutlineFill,{geometry:{visualVariableColor:s.visualVariableColor,visualVariableOpacity:s.visualVariableOpacity,visualVariableSizeScaleStops:s.visualVariableSizeOutlineScaleStops,visualVariableSizeMinMaxValue:null,visualVariableSizeStops:null,visualVariableSizeUnitValue:null}},{zoomRange:!1}).createMeshInfo({params:{...X,...it(r,!!s.visualVariableSizeOutlineScaleStops)}})];const le=o.ensureInstance(ie.k2.complexFill,{geometry:{visualVariableColor:s.visualVariableColor,visualVariableOpacity:s.visualVariableOpacity}},{zoomRange:!1});return u.push(le.createMeshInfo({params:X})),r&&u.push(...ze(r,e,!0)),u}(t,e);case"simple-marker":return function ur(t,e){return rt.apply(this,arguments)}(t,e);case"picture-marker":return function cr(t,e){const{uniforms:r,schemaOptions:s}=e,{store:a}=s,o=a.ensureInstance(ie.k2.marker,{geometry:{visualVariableColor:r.visualVariableColor,visualVariableOpacity:r.visualVariableOpacity,visualVariableSizeMinMaxValue:r.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:r.visualVariableSizeScaleStops,visualVariableSizeStops:r.visualVariableSizeStops,visualVariableSizeUnitValue:r.visualVariableSizeUnitValue,visualVariableRotation:r.visualVariableRotation}},{zoomRange:!1}),u=xe.B$.createPictureMarkerRasterizationParam(t);return u?[o.createMeshInfo({params:{type:"picture",color:[255,255,255,255],height:t.height,width:t.width,offsetX:t.xoffset,offsetY:t.yoffset,angle:t.angle,alignment:(0,Ie.A)(r)?he.v2.MAP:he.v2.SCREEN,outlineColor:null,outlineSize:0,referenceSize:t.height,sprite:u,overrideOutlineColor:!1,hasSizeVV:(0,Ie.h)(r),placement:null,effects:null,transforms:null,scaleInfo:null,minPixelBuffer:(0,q.XS)(r)}})]:[]}(t,e);case"simple-line":return ze(t,e,!1);case"text":return function hr(t,e){const{uniforms:r,schemaOptions:s}=e,{store:a}=s;return[a.ensureInstance(ie.k2.text,{geometry:{visualVariableColor:r.visualVariableColor,visualVariableOpacity:r.visualVariableOpacity,visualVariableRotation:r.visualVariableRotation,visualVariableSizeMinMaxValue:r.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:r.visualVariableSizeScaleStops,visualVariableSizeStops:r.visualVariableSizeStops,visualVariableSizeUnitValue:r.visualVariableSizeUnitValue}},{zoomRange:!1,clipAngle:!1,referenceSymbol:!1}).createMeshInfo({params:{boxBackgroundColor:t.backgroundColor?.toArray(),boxBorderLineColor:t.borderLineColor?.toArray(),boxBorderLineSize:t.borderLineSize??0,color:t.color?.toArray()??[0,0,0,0],offsetX:t.xoffset,offsetY:t.yoffset,postAngle:t.angle,fontSize:t.font.size,decoration:t.font.decoration,haloColor:t.haloColor?.toArray()??[0,0,0,0],haloFontSize:t.haloSize??0,lineWidth:t.lineWidth,lineHeightRatio:t.lineHeight,horizontalAlignment:t.horizontalAlignment,verticalAlignment:t.verticalAlignment,useCIMAngleBehavior:!1,glyphs:{type:"text-rasterization-param",resource:{type:"text",font:t.font.toJSON(),textString:t.text,symbol:xe.B$.createCIMTextSymbolfromTextSymbol(t)},overrides:[]},referenceSize:null,effects:null,placement:null,scaleInfo:null,transforms:null,scaleFactor:1,minPixelBuffer:(0,q.XS)(r),repeatLabel:null,repeatLabelDistance:null,allowOverrun:null,labelPosition:null,isLineLabel:!1}})]}(t,e);case"label":return function pr(t,e){const{schemaOptions:r,uniforms:s}=e,{store:a}=r,o=t.symbol,{allowOverrun:u,repeatLabel:p,repeatLabelDistance:m}=t,b={maxScale:t.maxScale??0,minScale:t.minScale??0},C=a.ensureInstance(ie.k2.label,{geometry:{visualVariableColor:null,visualVariableOpacity:null,visualVariableRotation:s.visualVariableRotation,visualVariableSizeMinMaxValue:s.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:s.visualVariableSizeScaleStops,visualVariableSizeStops:s.visualVariableSizeStops,visualVariableSizeUnitValue:s.visualVariableSizeUnitValue}},{zoomRange:!0,clipAngle:!0,referenceSymbol:!0}),T=t.labelPlacement,[B,J]=(0,ir.qv)(T);return[C.createMeshInfo({params:{boxBackgroundColor:o.backgroundColor?.toArray(),boxBorderLineColor:o.borderLineColor?.toArray(),boxBorderLineSize:o.borderLineSize??0,color:o.color?.toArray()??[0,0,0,0],offsetX:o.xoffset,offsetY:o.yoffset,postAngle:o.angle,fontSize:o.font.size,decoration:o.font.decoration,haloColor:o.haloColor?.toArray()??[0,0,0,0],haloFontSize:o.haloSize??0,lineWidth:o.lineWidth,lineHeightRatio:o.lineHeight,horizontalAlignment:B,verticalAlignment:J,repeatLabel:p,repeatLabelDistance:(0,Le.F2)(m),allowOverrun:u,labelPosition:t.labelPosition,scaleInfo:b,minPixelBuffer:(0,q.XS)(s),useCIMAngleBehavior:!1,glyphs:{type:"text-rasterization-param",resource:{type:"text",font:o.font.toJSON(),textString:o.text,symbol:xe.B$.createCIMTextSymbolfromTextSymbol(o),primitiveName:"label-override"},useLegacyLabelEvaluationRules:null==t.labelExpressionInfo?.expression,overrides:[{type:"CIMPrimitiveOverride",valueExpressionInfo:{type:"CIMExpressionInfo",expression:t.labelExpressionInfo?.expression??t.labelExpression,returnType:"String"},primitiveName:"label-override",propertyName:"textString",defaultValue:""}]},referenceSize:null,effects:null,placement:null,transforms:null,scaleFactor:1,isLineLabel:!1}})]}(t,e);case"cim":return(0,$e.$L)(t.data,e);case"web-style":{const r=yield t.fetchCIMSymbol();return(0,$e.$L)(r.data,e)}default:throw new Error(`symbol not supported ${t.type}`)}}),qe.apply(this,arguments)}function ar(t,e){return et.apply(this,arguments)}function et(){return(et=(0,f.Z)(function*(t,e){const{schemaOptions:r}=e,{store:s}=r,a=new Array(We.Pp),o=new Array(We.Pp/4);for(let b=0;b<We.Pp;b++){const C=b<t.attributes.length?t.attributes[b].color:null;a[b]=[0,0,0,0],sr(a[b],C)}for(let b=0;b<We.Pp/4;b++)o[b]=[0,0,0,0],o[b][0]=4*b<t.attributes.length?1:0,o[b][1]=4*b+1<t.attributes.length?1:0,o[b][2]=4*b+2<t.attributes.length?1:0,o[b][3]=4*b+3<t.attributes.length?1:0;const p=s.ensureInstance(ie.k2.dotDensity,{isActive:o,colors:a,dotValue:t.dotValue,dotScale:t.referenceScale,blending:t.dotBlendingEnabled,dotSize:t.dotSize,seed:t.seed},{}).createMeshInfo({params:{effects:null}}),m=[];if(t.backgroundColor){const b=new nr.Z({color:t.backgroundColor,outline:null}),C=yield ye(b,e);m.push(...C)}if(m.push(p),t.outline){const b=ze(t.outline,e,!0);m.push(...b)}return m})).apply(this,arguments)}function or(t,e){return tt.apply(this,arguments)}function tt(){return(tt=(0,f.Z)(function*(t,e){const{store:r}=e,{radius:s,minDensity:a,maxDensity:o,referenceScale:u,field:p,valueExpression:m,colorStops:b}=t,C=(0,tr.uI)(b);return[r.ensureInstance(ie.k2.heatmap,{radius:(0,Le.F2)(s),minDensity:a,maxDensity:o,referenceScale:u,isFieldActive:!(!p&&!m),gradient:C,gradientHash:C.join(",")},{}).createMeshInfo({params:{effects:null}})]})).apply(this,arguments)}function lr(t,e){const{store:r}=e,s=t.outline?.width||0,a=(0,q.Sc)(t),o=r.ensureInstance(ie.k2.pieChart,{geometry:{outlineWidth:Math.round((0,Le.F2)(s)),defaultColor:(0,He.n)(t.defaultColor),outlineColor:(0,He.n)(t.outline?.color),othersColor:(0,He.n)(t.othersCategory?.color),donutRatio:t.holePercentage,sectorThreshold:t.othersCategory?.threshold||0,colors:t.attributes.map(u=>(0,He.n)(u.color)),visualVariableOpacity:a.visualVariableOpacity,visualVariableSizeMinMaxValue:a.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:a.visualVariableSizeScaleStops,visualVariableSizeStops:a.visualVariableSizeStops,visualVariableSizeUnitValue:a.visualVariableSizeUnitValue,hittestUniforms:null},numberOfFields:t.attributes.length},{}).createMeshInfo({params:{size:t.size,outlineWidth:s,effects:null,scaleInfo:null,minPixelBuffer:(0,q.XS)(a)}});return[...t.backgroundFillSymbol?Vt(t.backgroundFillSymbol,{schemaOptions:e,path:"",uniforms:q.Jh}):[],o]}function It(t){if("path"===t.style){if(null==t.path)throw new Error("Symbol with a style of type path must define a path");return{type:"sprite-rasterization-param",overrides:[],resource:{type:"path",path:t.path,asFill:!0}}}const e=xe.B$.fromSimpleMarker(t);if("outline"in t&&t.outline&&"none"!==t.outline.style&&"solid"!==t.outline.style){if(!e||!e.symbolLayers)throw new Error("Error handling marker! ");return{type:"sprite-rasterization-param",resource:e.symbolLayers[0],overrides:[]}}return{type:"sprite-rasterization-param",resource:(0,rr.Fp)(e),overrides:[]}}function rt(){return(rt=(0,f.Z)(function*(t,e){const{uniforms:r,schemaOptions:s}=e,{store:a}=s;if("path"===t.style||t.outline&&"solid"!==t.outline.style&&"none"!==t.outline.style){const B=xe.B$.fromSimpleMarker(t);if(!B||!B.symbolLayers)throw new Error("Error handling marker! ");if(r.visualVariableRotation&&(B.angleAlignment="Map"),"path"!==t.style){const J=B.symbolLayers[0];if((0,Ie.h)(e.uniforms)){const X=(0,q.XS)(e.uniforms,0,1);if(X>J.size){const le=X/J.size;J.size=X;const ue=J.markerGraphics?.[0].symbol;(ue.symbolLayers&&ue.symbolLayers[0]).width*=le}}}return(0,$e.$L)({type:"CIMSymbolReference",symbol:B},e)}const o=a.ensureInstance(ie.k2.marker,{geometry:{visualVariableColor:r.visualVariableColor,visualVariableOpacity:r.visualVariableOpacity,visualVariableSizeMinMaxValue:r.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:r.visualVariableSizeScaleStops,visualVariableSizeStops:r.visualVariableSizeStops,visualVariableSizeUnitValue:r.visualVariableSizeUnitValue,visualVariableRotation:r.visualVariableRotation}},{zoomRange:!1}),u=It(t);let p=t.color?.toArray()??[0,0,0,0];"CIMVectorMarker"===u.resource.type&&(p=[255,255,255,255]);const b=t.size,T=null!=r.visualVariableColor&&("cross"===t.style||"x"===t.style);return[o.createMeshInfo({params:{type:"simple",color:p,height:b,width:b*("triangle"===t.style?124/116:1),offsetX:t.xoffset,offsetY:t.yoffset,angle:t.angle,alignment:(0,Ie.A)(r)?he.v2.MAP:he.v2.SCREEN,outlineColor:t.outline?.color?.toArray()??[0,0,0,0],outlineSize:t.outline?.width??1,referenceSize:b,sprite:u,overrideOutlineColor:T,hasSizeVV:(0,Ie.h)(r),placement:null,effects:null,transforms:null,scaleInfo:null,minPixelBuffer:(0,q.XS)(r)}})]})).apply(this,arguments)}function it(t,e){const r=t.width;return{outlineColor:t.color?.toArray()||[0,0,0,1],width:r,referenceWidth:r,capType:t.cap??"round",joinType:t.join??"round",miterLimit:t.miterLimit,hasSizeVV:e}}function Vt(t,e){const{style:r}=t;return r&&"none"!==r&&"solid"!==r?function fr(t,e){const{uniforms:r,schemaOptions:s}=e,{store:a}=s,o=t.color?.toArray()??[0,0,0,0],u={type:"sprite-rasterization-param",resource:{type:"fill-style",style:t.style},overrides:[]};if("solid"===t.outline?.style)return[a.ensureInstance(ie.k2.patternOutlineFill,{geometry:{visualVariableColor:r.visualVariableColor,visualVariableOpacity:r.visualVariableOpacity,visualVariableSizeScaleStops:r.visualVariableSizeOutlineScaleStops,visualVariableSizeMinMaxValue:null,visualVariableSizeStops:null,visualVariableSizeUnitValue:null}},{zoomRange:!1}).createMeshInfo({params:{color:o,...it(t.outline,!!r.visualVariableSizeOutlineScaleStops),sprite:u,scaleInfo:null,effects:null}})];const p=[],m=a.ensureInstance(ie.k2.patternFill,{geometry:{visualVariableColor:r.visualVariableColor,visualVariableOpacity:r.visualVariableOpacity}},{zoomRange:!1}).createMeshInfo({params:{color:t.color?.toArray()??[0,0,0,0],sprite:u,scaleInfo:null,effects:null}});return p.push(m),t.outline&&p.push(...ze(t.outline,e,!0)),p}(t,e):function yr(t,e){const{uniforms:r,schemaOptions:s}=e,{store:a}=s,o=t.color?.toArray()??[0,0,0,0];if("none"!==t.style&&"solid"===t.outline?.style)return[a.ensureInstance(ie.k2.outlineFill,{geometry:{visualVariableColor:r.visualVariableColor,visualVariableOpacity:r.visualVariableOpacity,visualVariableSizeScaleStops:r.visualVariableSizeOutlineScaleStops,visualVariableSizeMinMaxValue:null,visualVariableSizeStops:null,visualVariableSizeUnitValue:null}},{zoomRange:!1}).createMeshInfo({params:{color:o,...it(t.outline,!!r.visualVariableSizeOutlineScaleStops),scaleInfo:null,effects:null}})];const u=[];if("none"!==t.style){const p=a.ensureInstance(ie.k2.fill,{geometry:{visualVariableColor:r.visualVariableColor,visualVariableOpacity:r.visualVariableOpacity}},{zoomRange:!1}).createMeshInfo({params:{color:o,scaleInfo:null,effects:null}});u.push(p)}return t.outline&&u.push(...ze(t.outline,e,!0)),u}(t,e)}function ze(t,e,r){const{color:s,style:a,width:o,cap:u,join:p}=t,{schemaOptions:m}=e,{store:b}=m,C=[],T=r?{...q.Jh,visualVariableSizeScaleStops:e.uniforms.visualVariableSizeOutlineScaleStops}:e.uniforms,B={geometry:{visualVariableColor:T.visualVariableColor,visualVariableOpacity:T.visualVariableOpacity,visualVariableSizeMinMaxValue:T.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:T.visualVariableSizeScaleStops,visualVariableSizeStops:T.visualVariableSizeStops,visualVariableSizeUnitValue:T.visualVariableSizeUnitValue}},J={color:s?.toArray()??[0,0,0,0],width:o,referenceWidth:o,capType:u,joinType:p,miterLimit:t.miterLimit,hasSizeVV:(0,Ie.h)(T),effects:null,scaleInfo:null};if(null==a||"solid"===a){const X=b.ensureInstance(ie.k2.line,B,{zoomRange:!1}).createMeshInfo({params:J});C.push(X)}else if("none"!==a){const X=b.ensureInstance(ie.k2.texturedLine,B,{zoomRange:!1}).createMeshInfo({params:{...J,shouldScaleDash:!0,shouldSampleAlphaOnly:!1,isSDF:!0,sprite:{type:"sprite-rasterization-param",resource:{type:"dash",dashTemplate:(0,xe.U1)(a,u),capStyle:(0,xe.qp)(u)},overrides:[]}}});C.push(X)}return null!=t.marker&&C.push(...function dr(t,e,r){const{uniforms:s,schemaOptions:a}=r,{store:o}=a,u=o.ensureInstance(ie.k2.marker,{geometry:{visualVariableColor:s.visualVariableColor,visualVariableOpacity:s.visualVariableOpacity,visualVariableSizeMinMaxValue:s.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:s.visualVariableSizeScaleStops,visualVariableSizeStops:s.visualVariableSizeStops,visualVariableSizeUnitValue:s.visualVariableSizeUnitValue,visualVariableRotation:s.visualVariableRotation}},{zoomRange:!1}),p=It(t),b=6*e.width,C=b,T=t.color?.toArray()??e.color?.toArray()??[0,0,0,0],B="cross"===t.style||"x"===t.style;let J;switch(t.placement){case"begin-end":J=he.Tx.Both;break;case"begin":J=he.Tx.JustBegin;break;case"end":J=he.Tx.JustEnd;break;default:J=he.Tx.None}const X={type:"cim-marker-placement-info",placement:{type:"CIMMarkerPlacementAtExtremities",angleToLine:!0,offset:0,extremityPlacement:J,offsetAlongLine:0},overrides:[]};return[u.createMeshInfo({params:{type:"simple",color:T,height:C,width:b,offsetX:0,offsetY:0,angle:0,alignment:(0,Ie.A)(s)?he.v2.MAP:he.v2.SCREEN,outlineColor:T,outlineSize:B?e.width:0,referenceSize:C/6,sprite:p,overrideOutlineColor:B&&null!=s.visualVariableColor,hasSizeVV:(0,Ie.h)(s),placement:X,transforms:null,effects:null,scaleInfo:null,minPixelBuffer:(0,q.XS)(s)}})]}(t.marker,t,e)),C}function Be(t,e,r){return st.apply(this,arguments)}function st(){return st=(0,f.Z)(function*(t,e,r){const s=e.labelsVisible&&e.labelingInfo||[],a=fe(e),o=(0,er.a)(s,a);return{type:"label",classes:yield Promise.all(o.map((u,p)=>function mr(t,e,r,s){return nt.apply(this,arguments)}(t,u,p,r)))}}),st.apply(this,arguments)}function nt(){return(nt=(0,f.Z)(function*(t,e,r,s){const a=yield ye(e,{path:`${r}`,schemaOptions:t,uniforms:s});return{maxScale:e.maxScale,minScale:e.minScale,expression:e.labelExpressionInfo?.expression??e.labelExpression,where:e.where,meshes:a}})).apply(this,arguments)}function Ze(t,e){return at.apply(this,arguments)}function at(){return at=(0,f.Z)(function*(t,e){if(!e)return{type:"simple",meshes:[]};switch(e.type){case"simple":return function br(t,e){return lt.apply(this,arguments)}(t,e);case"dot-density":return function vr(t,e){return ut.apply(this,arguments)}(t,e);case"class-breaks":return function _r(t,e){return ct.apply(this,arguments)}(t,e);case"unique-value":return function Sr(t,e){return dt.apply(this,arguments)}(t,e);case"dictionary":return function Er(t){const e=(0,q.Sc)(t),r=t.scaleExpression;return{type:"dictionary",fieldMap:t.fieldMap,scaleExpression:null!=r&&"1"!==r?{valueExpressionInfo:{type:"CIMExpressionInfo",expression:t.scaleExpression,returnType:"Numeric"},defaultValue:1}:void 0,visualVariableUniforms:e}}(e);case"heatmap":return function xr(t,e){return ht.apply(this,arguments)}(t,e);case"pie-chart":return function Ir(t,e){return pt.apply(this,arguments)}(t,e)}}),at.apply(this,arguments)}function lt(){return(lt=(0,f.Z)(function*(t,e){const r=e.getSymbols(),s=r.length?r[0]:null,a=(0,q.Sc)(e);return{type:"simple",meshes:yield ye(s,{schemaOptions:t,uniforms:a,path:"renderer.symbol"})}})).apply(this,arguments)}function ut(){return(ut=(0,f.Z)(function*(t,e){const r=(0,q.Sc)(e);return{type:"dot-density",meshes:yield ar(e,{schemaOptions:t,uniforms:r,path:"renderer.symbol"})}})).apply(this,arguments)}function ct(){return ct=(0,f.Z)(function*(t,e){const r=(0,q.Sc)(e),s=e.backgroundFillSymbol,a=e.normalizationType,o="log"===a?"esriNormalizeByLog":"percent-of-total"===a?"esriNormalizeByPercentOfTotal":"field"===a?"esriNormalizeByField":null,u=e.classBreakInfos.map(function(){var C=(0,f.Z)(function*(T){return{meshes:yield ye(T.symbol,{path:`renderer-stop-${T.minValue}-${T.maxValue}`,schemaOptions:t,uniforms:r}),min:T.minValue,max:T.maxValue}});return function(T){return C.apply(this,arguments)}}()),p=(yield Promise.all(u)).sort((C,T)=>C.min-T.min),m=yield ye(s,{schemaOptions:t,path:"renderer.backgroundFill",uniforms:{...q.Jh,visualVariableSizeOutlineScaleStops:r.visualVariableSizeOutlineScaleStops}}),b=yield ye(e.defaultSymbol,{schemaOptions:t,path:"renderer.defaultSymbol",uniforms:r});return{type:"interval",field:e.field,expression:e.valueExpression,backgroundFill:m,defaultSymbol:b,intervals:p,normalizationField:e.normalizationField,normalizationTotal:e.normalizationTotal,normalizationType:o,isMaxInclusive:e.isMaxInclusive}}),ct.apply(this,arguments)}function dt(){return(dt=(0,f.Z)(function*(t,e){const r=[],s=(0,q.Sc)(e),a=yield ye(e.backgroundFillSymbol,{schemaOptions:t,path:"renderer.backgroundFill",uniforms:{...q.Jh,visualVariableSizeOutlineScaleStops:s.visualVariableSizeOutlineScaleStops}}),o=yield ye(e.defaultSymbol,{schemaOptions:t,path:"renderer.defaultSymbol",uniforms:s});for(const u of e.uniqueValueInfos??[]){const p=yield ye(u.symbol,{path:`renderer-unique-value-${u.value}`,schemaOptions:t,uniforms:s});r.push({value:""+u.value,symbol:p})}return{type:"map",field:e.field,expression:e.valueExpression,field2:e.field2,field3:e.field3,fieldDelimiter:e.fieldDelimiter,backgroundFill:a,defaultSymbol:o,map:r}})).apply(this,arguments)}function ht(){return(ht=(0,f.Z)(function*(t,e){return{type:"heatmap",meshes:yield or(e,t)}})).apply(this,arguments)}function pt(){return(pt=(0,f.Z)(function*(t,e){return{type:"pie-chart",meshes:lr(e,t)}})).apply(this,arguments)}var Ge=l(958);function Vr(t,e){return ft.apply(this,arguments)}function ft(){return(ft=(0,f.Z)(function*(t,e){const r=e.renderer,s=(0,q.Sc)(r);return{symbology:yield Ze(t,r),labels:yield Be(t,e,s)}})).apply(this,arguments)}function Pe(t,e,r,s){return yt.apply(this,arguments)}function yt(){return yt=(0,f.Z)(function*(t,e,r,s){const a=r.featureReduction;if(a)switch(a.type){case"binning":return function Or(t,e,r,s,a){return gt.apply(this,arguments)}(a,t,e,r,s);case"cluster":return function Cr(t,e,r,s,a){return mt.apply(this,arguments)}(a,t,e,r,s)}const o=function Pr(t,e,r){const s=null!=e&&"unique-value"===e.type&&e.orderByClassesEnabled;if("default"!==t||s||(t=[new qt.Z({field:r,order:"descending"})]),"default"!==t&&t.length){const a=t[0],o="ascending"===a.order?"asc":"desc";return a.field?{field:a.field,order:o}:a.valueExpression?{expression:a.valueExpression,order:o}:null}return s?{byRenderer:!0,order:"asc"}:null}(r.orderBy,r.renderer,r.objectIdField);return{storage:(0,Ge.$F)(r.renderer,e.filters),mesh:{displayRefreshVersion:s,strategy:{type:"feature"},factory:yield Vr(t,r),sortKey:o,timeZone:e.timeZone}}}),yt.apply(this,arguments)}function Rt(t,e){return t.fields.map(r=>({...r.toJSON(),type:Rr(r,e)}))}function Rr(t,e){const{onStatisticExpression:r,onStatisticField:s,statisticType:a}=t;switch(a){case"min":case"max":case"avg":case"avg_angle":case"sum":case"count":return"esriFieldTypeDouble";case"mode":{if(r){const{returnType:u}=r;return u?"string"===u?"esriFieldTypeString":"esriFieldTypeDouble":"esriFieldTypeString"}const o=e.find(u=>u.name===s);return o?o.type:"esriFieldTypeString"}}}function gt(){return(gt=(0,f.Z)(function*(t,e,r,s,a){const o=Rt(t,s.fields),u=t.renderer,p=yield Ze(e,u),m=(0,Ge.$F)(u,[null,null]),b=(0,q.Sc)(u),C=yield Be(e,{geometryType:"polygon",labelingInfo:t.labelingInfo,labelsVisible:t.labelsVisible},b);return{storage:m,mesh:{displayRefreshVersion:a,strategy:{type:"binning",fields:o,fixedBinLevel:t.fixedBinLevel,featureFilter:r.filters[0]},factory:{labels:C,symbology:p},sortKey:null,timeZone:r.timeZone}}})).apply(this,arguments)}function mt(){return(mt=(0,f.Z)(function*(t,e,r,s,a){const o=Rt(t,s.fields),u={type:"cluster",feature:yield Ze(e,t.effectiveFeatureRenderer),cluster:yield Ze(e,t.effectiveClusterRenderer)},p=(0,q.Sc)(t.effectiveFeatureRenderer),m={type:"cluster",feature:yield Be(e,s,p),cluster:yield Be(e,{geometryType:"point",labelingInfo:t.labelingInfo,labelsVisible:t.labelsVisible},p)};return{storage:(0,Ge.$F)(t.effectiveFeatureRenderer,[null,null]),mesh:{displayRefreshVersion:a,strategy:{type:"cluster",fields:o,featureFilter:r.filters[0],clusterRadius:(0,Le.F2)(t.clusterRadius/2)},factory:{labels:m,symbology:u},sortKey:null,timeZone:r.timeZone}}})).apply(this,arguments)}var Fe=l(22418);class Fr{constructor(e){this.layer=e}getLabelingDeconflictionInfo(e){const r=this.layer,s=Ee(r);return[{vvEvaluators:{0:Oe(r.renderer)},deconflictionEnabled:s}]}createServiceOptions(e){var r=this;return(0,f.Z)(function*(){const s=r.layer,a=s.parent,o=(0,R.S1)(a),{capabilities:u,editingInfo:p,objectIdField:m,globalIdField:b,datesInUnknownTimezone:C,orderBy:T,subtypeField:B,parsedUrl:J}=a,X=a.fieldsIndex.toJSON(),le=fe(s),ue=a.timeInfo?.toJSON(),Me=s.spatialReference.toJSON(),ge=(0,De.d9)(J);let me=m;if(T?.length){const de=!T[0].valueExpression&&T[0].field;de&&(me=de)}return{type:"feature-service",source:ge,isSourceHosted:(0,Ne.M8)(ge.path),orderByFields:me,metadata:{timeReferenceUnknownClient:C,subtypeField:B,globalIdField:b,fieldsIndex:X,geometryType:le,objectIdField:m,timeInfo:ue,spatialReference:Me,subtypes:null,typeIdField:null,types:null},queryMetadata:{capabilities:u,effectiveCapabilities:o,lastEditDate:p?.lastEditDate?.getTime(),snapshotInfo:null}}})()}createSourceSchema(e,r,s){const{definitionExpression:a,customParameters:o,timeExtent:u,apiKey:p}=this.layer.parent;return Ce(e,{definitionExpression:a,customParameters:o,timeExtent:u},r,s,p)}createProcessorSchema(e,r,s){const{parent:{fields:a,geometryType:o,orderBy:u,objectIdField:p},renderer:m,labelingInfo:b,labelsVisible:C}=this.layer;return Pe(e,r,{featureReduction:null,fields:a.map(B=>B.toJSON()),geometryType:o,labelingInfo:b,labelsVisible:C,objectIdField:p,orderBy:u??"default",renderer:m?.clone()},s)}get hasRequiredSupport(){return(0,Fe.T)(this.layer.renderer)}getUpdateHashProperties(e){const r=this.layer,{parent:s,parent:{definitionExpression:a,apiKey:o},renderer:u}=r,p=this.layer.labelsVisible?this.layer.labelingInfo:null;return{apiKey:o,customParameters:JSON.stringify(s.customParameters),definitionExpression:a,labelingInfo:p,orderBy:JSON.stringify(s.orderBy),renderer:u}}setGraphicOrigin(e){e.origin={type:"catalog",layer:this.layer}}}function bt(t,e){const r=t.extent,s=e?.clone().intersection(r),o=e?e.width*e.height:0,u=0===o?0:(null!=s?s.width*s.height:0)/o,p=(0,V.Z)("featurelayer-snapshot-point-coverage");return!isNaN(u)&&u>=p}function we(t,e){return null!=t.floorInfo&&(t.floorInfo.viewAllLevelIds.length>0||e.floors.length>0)}function vt(t,e,r){const s=function Mr(t,e,r){if(null==t.floorInfo||!r.floors?.length)return e;let s=r.floors;const{floorField:a,viewAllLevelIds:o}=t.floorInfo;o.length&&(s=o);const u=s.filter(m=>""!==m).map(m=>"'"+m+"'");if(u.push("''"),e?.includes(a)){let m=new RegExp("AND \\("+a+".*NULL\\)","g");e=e.replace(m,""),m=new RegExp("\\("+a+".*NULL\\)","g"),e=(e=e.replace(m,"")).replaceAll(/\s+/g," ").trim()}let p="("+a+" IN ({ids}) OR "+a+" IS NULL)";return p=p.replace("{ids}",u.join(", ")),(0,Je._)(e,p)}(t,e?.where,r);return s&&(e??=new v.Z,e.where=s),e}class Tr{constructor(e){this.layer=e}getLabelingDeconflictionInfo(e){const r=this.layer,s=Te(r,e)??Ee(r);return[{vvEvaluators:{0:Oe(r.renderer)},deconflictionEnabled:s}]}createServiceOptions(e){var r=this;return(0,f.Z)(function*(){const s=r.layer,a=(0,R.S1)(s),{capabilities:o,editingInfo:u,objectIdField:p,typeIdField:m,globalIdField:b,datesInUnknownTimezone:C,orderBy:T,subtypeField:B,refreshInterval:J}=s,X=s.fieldsIndex.toJSON(),le=X.fields,ue=fe(s),Me=s.timeInfo?.toJSON(),ge=s.spatialReference.toJSON(),me=s.types?.map(Ue=>Ue.toJSON()),de=(0,De.d9)(r.layer.parsedUrl);r.layer.dynamicDataSource&&(de.query={layer:JSON.stringify({source:r.layer.dynamicDataSource})});let Qe=r.layer.objectIdField;if(T?.length){const Ue=!T[0].valueExpression&&T[0].field;Ue&&(Qe=Ue)}const ii=null==u?.lastEditDate&&J>0,Ft=(0,V.Z)("featurelayer-snapshot-enabled")&&"point"===s.geometryType&&o?.query.supportsPagination&&!o?.operations.supportsEditing&&!ii,si=Ft&&bt(e,s.fullExtent);return{type:"feature-service",source:de,isSourceHosted:(0,Ne.M8)(de.path),orderByFields:Qe,metadata:{typeIdField:m??void 0,types:me,timeReferenceUnknownClient:C,subtypeField:B,globalIdField:b,fields:le,fieldsIndex:X,geometryType:ue,objectIdField:p,timeInfo:Me,spatialReference:ge,subtypes:r.layer.subtypes?.map(Ue=>Ue.toJSON())},queryMetadata:{capabilities:o,effectiveCapabilities:a,lastEditDate:u?.lastEditDate?.getTime(),snapshotInfo:{supportsSnapshotMinThreshold:Ft,supportsSnapshotMaxThreshold:si,snapshotCountThresholds:{min:(0,V.Z)("featurelayer-snapshot-point-min-threshold"),max:(0,V.Z)("featurelayer-snapshot-point-max-threshold")}}}}})()}createSourceSchema(e,r,s){const{definitionExpression:a,customParameters:o,gdbVersion:u,historicMoment:p,subtypeCode:m,subtypeField:b,timeExtent:C,apiKey:T}=this.layer;return Ce(e,{definitionExpression:a,customParameters:o,gdbVersion:u,historicMoment:p,subtypeCode:m,subtypeField:b,timeExtent:C},r,s,T)}createProcessorSchema(e,r,s){const{fields:a,renderer:o,geometryType:u,labelingInfo:p,labelsVisible:m,orderBy:b,objectIdField:C}=this.layer;return Pe(e,r,{fields:a.map(B=>B.toJSON()),renderer:o?.clone(),featureReduction:(0,ae.g)(this.layer,r),geometryType:u,labelingInfo:p,labelsVisible:m,objectIdField:C,orderBy:b??"default"},s)}get hasRequiredSupport(){return(0,Fe.T)(this.layer.renderer)}hasFilters(e){return we(this.layer,e)}addFilters(e,r){return vt(this.layer,e,r)}getUpdateHashProperties(e){const r=this.layer,{definitionExpression:s,renderer:a,gdbVersion:o,apiKey:u,subtypeCode:p}=r,m=this.layer.labelsVisible?this.layer.labelingInfo:null,b=r.historicMoment?.getTime()??void 0,C=JSON.stringify(r.customParameters),T=(0,ae.g)(r,e)?.toJSON(),B=JSON.stringify(r.orderBy);return{apiKey:u,customParameters:C,definitionExpression:s,featureReduction:T,floors:we(this.layer,e)?e.floors:null,gdbVersion:o,historicMoment:b,labelingInfo:m,orderBy:B,renderer:a,subtypeCode:p}}}class Ot{constructor(e){this.layer=e}getLabelingDeconflictionInfo(e){const r=this.layer,s=Te(r,e)??Ee(r);return[{vvEvaluators:{0:Oe(r.renderer)},deconflictionEnabled:s}]}createServiceOptions(e){var r=this;return(0,f.Z)(function*(){const s=r.layer,a=(0,R.S1)(s),{capabilities:o,objectIdField:u}=s,p=s.fieldsIndex.toJSON(),m=fe(s),b=s.timeInfo?.toJSON(),C=s.spatialReference.toJSON();return function wr(t){if(!("openPorts"in t))throw new S.Z("source-not-supported")}(s.source),{type:"memory",source:yield s.source.openPorts(),orderByFields:u,metadata:{fieldsIndex:p,geometryType:m,objectIdField:u,timeInfo:b,spatialReference:C,subtypes:null,subtypeField:null,globalIdField:null,typeIdField:null,types:null,timeReferenceUnknownClient:null},queryMetadata:{capabilities:o,effectiveCapabilities:a,lastEditDate:null,snapshotInfo:null}}})()}createSourceSchema(e,r,s){const{definitionExpression:a,timeExtent:o}=this.layer;return Ce(e,{definitionExpression:a,timeExtent:o,customParameters:null},r,s,null)}createProcessorSchema(e,r,s){const{fields:a,renderer:o,geometryType:u,labelingInfo:p,labelsVisible:m,orderBy:b,objectIdField:C}=this.layer;return Pe(e,r,{fields:a.map(B=>B.toJSON()),renderer:o?.clone(),featureReduction:(0,ae.g)(this.layer,r),geometryType:u,labelingInfo:p,labelsVisible:m,objectIdField:C,orderBy:b??"default"},s)}get hasRequiredSupport(){return(0,Fe.T)(this.layer.renderer)}getUpdateHashProperties(e){const r=this.layer,{definitionExpression:s,renderer:a}=r,o=this.layer.labelsVisible?this.layer.labelingInfo:null,u=(0,ae.g)(r,e)?.toJSON();return{orderBy:JSON.stringify(r.orderBy),definitionExpression:s,renderer:a,labelingInfo:o,featureReduction:u}}}class Ar{constructor(e){this.layer=e}getLabelingDeconflictionInfo(e){const r=this.layer,s=Te(r,e)??Ee(r);return[{vvEvaluators:{0:Oe(r.renderer)},deconflictionEnabled:s}]}createServiceOptions(e){var r=this;return(0,f.Z)(function*(){const s=r.layer,a=(0,R.S1)(s),{capabilities:o,objectIdField:u}=s,p=s.fieldsIndex.toJSON(),m=fe(s),b=s.spatialReference.toJSON();return{type:"memory",source:yield s.source.openPorts(),orderByFields:u,metadata:{fieldsIndex:p,geometryType:m,objectIdField:u,spatialReference:b,globalIdField:null,subtypeField:null,subtypes:null,timeInfo:null,timeReferenceUnknownClient:null,typeIdField:null,types:null},queryMetadata:{capabilities:o,effectiveCapabilities:a,lastEditDate:null,snapshotInfo:null}}})()}createSourceSchema(e,r,s){const{definitionExpression:a}=this.layer;return Ce(e,{definitionExpression:a,customParameters:null},r,s,null)}createProcessorSchema(e,r,s){const{fields:a,renderer:o,geometryType:u,labelingInfo:p,labelsVisible:m,objectIdField:b}=this.layer;return Pe(e,r,{fields:a.map(T=>T.toJSON()),renderer:o?.clone(),featureReduction:(0,ae.g)(this.layer,r),geometryType:u,labelingInfo:p,labelsVisible:m,objectIdField:b,orderBy:"default"},s)}get hasRequiredSupport(){return(0,Fe.T)(this.layer.renderer)}getUpdateHashProperties(e){const r=this.layer,{definitionExpression:s,renderer:a}=r,o=this.layer.labelsVisible?this.layer.labelingInfo:null,u=(0,ae.g)(r,e)?.toJSON();return{definitionExpression:s,renderer:a,labelingInfo:o,featureReduction:u}}}class Ur{constructor(e){this.layer=e}getLabelingDeconflictionInfo(e){const r=this.layer,s=Te(r,e)??Ee(r);return[{vvEvaluators:{0:Oe(r.renderer)},deconflictionEnabled:s}]}createServiceOptions(e){var r=this;return(0,f.Z)(function*(){const s=r.layer,a=(0,R.S1)(s),{capabilities:o,objectIdField:u}=s,p=s.fieldsIndex.toJSON(),m=fe(s),b=s.timeInfo?.toJSON(),C=s.spatialReference.toJSON(),T=s.source.getSource(),B=r.layer.objectIdField,J=(0,De.d9)(o);return J.query.maxRecordCount=T.maxRecordCount,{type:"ogc",source:T,orderByFields:B,metadata:{fieldsIndex:p,geometryType:m,objectIdField:u,timeInfo:b,spatialReference:C,globalIdField:null,subtypeField:null,subtypes:null,timeReferenceUnknownClient:null,typeIdField:null,types:null},queryMetadata:{capabilities:J,effectiveCapabilities:a,lastEditDate:null,snapshotInfo:null}}})()}createSourceSchema(e,r,s){const{customParameters:a,timeExtent:o,apiKey:u}=this.layer;return Ce(e,{customParameters:a,timeExtent:o},r,s,u)}createProcessorSchema(e,r,s){const{fields:a,renderer:o,geometryType:u,labelingInfo:p,labelsVisible:m,orderBy:b,objectIdField:C}=this.layer;return Pe(e,r,{fields:a.map(B=>B.toJSON()),renderer:o?.clone(),featureReduction:(0,ae.g)(this.layer,r),geometryType:u,labelingInfo:p,labelsVisible:m,objectIdField:C,orderBy:b??"default"},s)}get hasRequiredSupport(){return(0,Fe.T)(this.layer.renderer)}getUpdateHashProperties(e){const r=this.layer,{renderer:s,apiKey:a}=r,o=this.layer.labelsVisible?this.layer.labelingInfo:null,u=JSON.stringify(r.customParameters),p=(0,ae.g)(r,e)?.toJSON();return{apiKey:a,customParameters:u,featureReduction:p,labelingInfo:o,orderBy:JSON.stringify(r.orderBy),renderer:s}}}class Dr{constructor(e){this.layer=e}getLabelingDeconflictionInfo(e){const r=this.layer,s=Te(r,e)??Ee(r);return[{vvEvaluators:{0:Oe(r.renderer)},deconflictionEnabled:s}]}createServiceOptions(e){var r=this;return(0,f.Z)(function*(){const s=r.layer,a=(0,R.S1)(s),{capabilities:o,objectIdField:u,globalIdField:p,orderBy:m,refreshInterval:b}=s,C=s.fieldsIndex.toJSON(),T=C.fields,B=fe(s),J=s.timeInfo?.toJSON(),X=s.spatialReference.toJSON(),le=(0,De.d9)(r.layer.parsedUrl);let ue=r.layer.objectIdField;if(m?.length){const de=!m[0].valueExpression&&m[0].field;de&&(ue=de)}const Me=b>0,ge=(0,V.Z)("featurelayer-snapshot-enabled")&&"point"===s.geometryType&&o?.query.supportsPagination&&!o?.operations.supportsEditing&&!Me,me=ge&&bt(e,s.fullExtent);return{type:"feature-service",source:le,isSourceHosted:(0,Ne.M8)(le.path),orderByFields:ue,metadata:{globalIdField:p,fields:T,fieldsIndex:C,geometryType:B,objectIdField:u,timeInfo:J,spatialReference:X,timeReferenceUnknownClient:!1,subtypeField:null,subtypes:null,typeIdField:null,types:null},queryMetadata:{capabilities:o,effectiveCapabilities:a,lastEditDate:null,snapshotInfo:{supportsSnapshotMinThreshold:ge,supportsSnapshotMaxThreshold:me,snapshotCountThresholds:{min:(0,V.Z)("featurelayer-snapshot-point-min-threshold"),max:(0,V.Z)("featurelayer-snapshot-point-max-threshold")}}}}})()}createSourceSchema(e,r,s){const{definitionExpression:a,customParameters:o,timeExtent:u}=this.layer;return Ce(e,{definitionExpression:a,customParameters:o,timeExtent:u},r,s,null)}createProcessorSchema(e,r,s){const{fields:a,renderer:o,geometryType:u,labelingInfo:p,labelsVisible:m,orderBy:b,objectIdField:C}=this.layer;return Pe(e,r,{fields:a.map(B=>B.toJSON()),renderer:o?.clone(),featureReduction:(0,ae.g)(this.layer,r),geometryType:u,labelingInfo:p,labelsVisible:m,objectIdField:C,orderBy:b??"default"},s)}get hasRequiredSupport(){return(0,Fe.T)(this.layer.renderer)}hasFilters(e){return we(this.layer,e)}addFilters(e,r){return vt(this.layer,e,r)}getUpdateHashProperties(e){const r=this.layer,{definitionExpression:s,renderer:a}=r,o=this.layer.labelsVisible?this.layer.labelingInfo:null,u=JSON.stringify(r.customParameters),p=(0,ae.g)(r,e)?.toJSON();return{orderBy:JSON.stringify(r.orderBy),definitionExpression:s,renderer:a,labelingInfo:o,featureReduction:p,customParameters:u,floors:we(this.layer,e)?e.floors:null}}}class Lr{constructor(e){this.layer=e}getLabelingDeconflictionInfo(e){const r=this.layer,s=Te(r,e)??Ee(r);return[{vvEvaluators:{0:Oe(r.renderer)},deconflictionEnabled:s}]}createServiceOptions(e){var r=this;return(0,f.Z)(function*(){const s=r.layer,{objectIdField:a}=s,o=fe(s),u=s.timeInfo?.toJSON()||null,p=s.spatialReference?s.spatialReference.toJSON():null;return{source:r.layer.parsedUrl,metadata:{fieldsIndex:r.layer.fieldsIndex.toJSON(),geometryType:o,objectIdField:a,timeInfo:u,timeReferenceUnknownClient:null,spatialReference:p,subtypeField:null,subtypes:null,globalIdField:null,typeIdField:null,types:null}}})()}createSourceSchema(e,r,s){const{definitionExpression:a,geometryDefinition:o,customParameters:u}=this.layer;return{type:"stream",service:e,tileInfoJSON:r.tileInfoJSON,mutable:{sourceRefreshVersion:s,availableFields:r.availableFields,dataFilter:{geometryDefinition:o?.toJSON(),definitionExpression:a,outSpatialReference:r.outSpatialReference.toJSON(),customParameters:u??null,maxReconnectionAttempts:this.layer.maxReconnectionAttempts,maxReconnectionInterval:this.layer.maxReconnectionInterval,purgeOptions:this.layer.purgeOptions.toJSON()}}}}createProcessorSchema(e,r,s){const{fields:a,renderer:o,geometryType:u,labelingInfo:p,labelsVisible:m,objectIdField:b}=this.layer;return Pe(e,r,{fields:a.map(T=>T.toJSON()),renderer:o?.clone(),featureReduction:(0,ae.g)(this.layer,r),geometryType:u,labelingInfo:p,labelsVisible:m,objectIdField:b,orderBy:"default"},s)}get hasRequiredSupport(){return(0,Fe.T)(this.layer.renderer)}getUpdateHashProperties(e){const r=this.layer,{definitionExpression:s,renderer:a}=r,o=this.layer.labelsVisible?this.layer.labelingInfo:null,u=JSON.stringify(r.customParameters),p=(0,ae.g)(r,e)?.toJSON();return{definitionExpression:s,renderer:a,labelingInfo:o,featureReduction:p,customParameters:u,streamFilter:`${JSON.stringify(r.geometryDefinition)}${r.definitionExpression}`}}}var zr=l(31637);function Br(t,e){return _t.apply(this,arguments)}function _t(){return(_t=(0,f.Z)(function*(t,{subtypeField:e,sublayers:r}){const s=yield Promise.all(r.map(({renderer:a})=>Ze(t,a)));return{type:"subtype",subtypeField:e,renderers:r.reduce((a,{subtypeCode:o},u)=>({...a,[o]:s[u]}),{})}})).apply(this,arguments)}function Zr(t,e){const r=(0,zr.h)();return{type:"subtype",filters:t.filters,capabilities:{maxTextureSize:r.maxTextureSize},subtypeField:e.subtypeField,target:"feature",bindings:e.sublayers.reduce((s,{renderer:a,subtypeCode:o})=>({...s,[o]:(0,Ge.vZ)(a)}),{})}}function jr(t,e){return St.apply(this,arguments)}function St(){return(St=(0,f.Z)(function*(t,{subtypeField:e,sublayers:r}){const s=yield Promise.all(r.map(a=>{const o=(0,q.Sc)(a.renderer),u={...a,geometryType:a.geometryType??null};return Be(t,u,o)}));return{type:"subtype",subtypeField:e,renderers:r.reduce((a,{subtypeCode:o},u)=>({...a,[o]:s[u]}),{})}})).apply(this,arguments)}function Et(){return(Et=(0,f.Z)(function*(t,e,r,s){return{storage:Zr(e,r),mesh:{displayRefreshVersion:s,strategy:{type:"feature"},factory:{symbology:yield Br(t,r),labels:yield jr(t,r)},sortKey:null,timeZone:e.timeZone}}})).apply(this,arguments)}class Kr{constructor(e){this.layer=e}getLabelingDeconflictionInfo(e){return[{vvEvaluators:{},deconflictionEnabled:this.layer.sublayers.every(r=>Ee(r))}]}createServiceOptions(e){var r=this;return(0,f.Z)(function*(){const s=r.layer,a=(0,R.S1)(s),{capabilities:o,datesInUnknownTimezone:u,editingInfo:p,globalIdField:m,objectIdField:b,refreshInterval:C,subtypeField:T}=s,B=s.fieldsIndex.toJSON(),J=fe(s),X=s.timeInfo?.toJSON(),le=s.spatialReference.toJSON(),ue=(0,De.d9)(r.layer.parsedUrl),Me=b,ge=null==p?.lastEditDate&&C>0,me=(0,V.Z)("featurelayer-snapshot-enabled")&&"point"===s.geometryType&&o?.query.supportsPagination&&!o?.operations.supportsEditing&&!ge,de=me&&bt(e,s.fullExtent);return{type:"feature-service",source:ue,isSourceHosted:(0,Ne.M8)(ue.path),orderByFields:Me,metadata:{timeReferenceUnknownClient:u,subtypeField:T,globalIdField:m,fieldsIndex:B,geometryType:J,objectIdField:b,timeInfo:X,spatialReference:le,subtypes:r.layer.subtypes?.map(Qe=>Qe.toJSON()),typeIdField:null,types:null},queryMetadata:{capabilities:o,effectiveCapabilities:a,lastEditDate:p?.lastEditDate?.getTime(),snapshotInfo:{supportsSnapshotMinThreshold:me,supportsSnapshotMaxThreshold:de,snapshotCountThresholds:{min:(0,V.Z)("featurelayer-snapshot-point-min-threshold"),max:(0,V.Z)("featurelayer-snapshot-point-max-threshold")}}}}})()}createSourceSchema(e,r,s){const{definitionExpression:a,customParameters:o,gdbVersion:u,historicMoment:p,subtypeField:m,timeExtent:b,apiKey:C}=this.layer,T=this.layer.sublayers.map(X=>X.subtypeCode).join(",");return Ce(e,{definitionExpression:(0,Je._)(a,this.layer.sublayers.length?`${this.layer.subtypeField} IN (${T})`:"1=2"),customParameters:o,gdbVersion:u,historicMoment:p,subtypeField:m,timeExtent:b},r,s,C)}createProcessorSchema(e,r,s){return function Nr(t,e,r,s){return Et.apply(this,arguments)}(e,r,{subtypeField:this.layer.subtypeField,sublayers:Array.from(this.layer.sublayers,o=>({featureReduction:null,geometryType:this.layer.geometryType,labelingInfo:o.labelingInfo,labelsVisible:o.labelsVisible,renderer:o.renderer,subtypeCode:o.subtypeCode,orderBy:null}))},s)}hasFilters(e){return we(this.layer,e)||function Jr(t,e){return t.sublayers.some(r=>!Ct(r,e))}(this.layer,e)}addFilters(e,r){e=vt(this.layer,e,r);const s=this.layer.sublayers.filter(o=>!Ct(o,r)).map(o=>o.subtypeCode);if(!s.length)return e;e??=new v.Z;const a=`NOT ${this.layer.subtypeField} IN (${s.join(",")})`;return e.where=(0,Je._)(e.where,a),e}get hasRequiredSupport(){return!0}getUpdateHashProperties(e){const r=this.layer,{definitionExpression:s,gdbVersion:a,apiKey:o}=r,u=r.historicMoment?.getTime()??void 0,p=JSON.stringify(r.customParameters),m=we(this.layer,e)?e.floors:null;return{gdbVersion:a,definitionExpression:s,historicMoment:u,customParameters:p,apiKey:o,sublayerHash:"sublayers"in this.layer&&this.layer.sublayers.items.reduce((b,C)=>b+`${C.visible?1:0}.${JSON.stringify(C.renderer)}.${C.labelsVisible}\n.${JSON.stringify(C.labelingInfo)}`,""),floors:m}}setGraphicOrigin(e){const r=this.layer.fieldsIndex.get(this.layer.subtypeField),s=e.attributes[r.name],a=this.layer.sublayers.find(o=>o.subtypeCode===s);e.layer=e.sourceLayer=a}}function Ct(t,e){return t.visible&&(0===t.minScale||(0,Ke.W8)(e.scale,t.minScale)||e.scale<t.minScale)&&(0===t.maxScale||(0,Ke.W8)(e.scale,t.maxScale)||e.scale>t.maxScale)}var Wr=l(74738),re=l(57121),Hr=l(79359);function Ae(t,e){const r=new Set;for(const s of t instanceof Set?t.values():t.keys())e.has(s)||r.add(s);return r}class $r{constructor(e){this.version=e}}class Gr{constructor(e){this._subscriptions=new Map,this._visible=new Set,this._paused=new Set,this._version=0,this._config=e}destroy(){}get _coverageSet(){const e=this._coverage?Array.from(this._coverage.keys()).map(r=>r.id):[];return new Set(e)}suspend(){this._suspendedOverage=this._coverage,this._coverage=null,this._updateSubscriptions()}resume(){null==this._coverage&&(this._coverage=this._suspendedOverage,this._suspendedOverage=null,this._updateSubscriptions())}update(e){return this._version=this._version+1%Number.MAX_SAFE_INTEGER,this._updateCoverage(e),this._updateSubscriptions(),new Set(this._visible)}_updateCoverage(e){this._coverage=this._config.tileInfoView.getTileCoverage(e.state,0,!0,"closest")}_updateSubscriptions(){const e=this._coverageSet,r=this._updateVisibility(),s=Ae(r,e),a=Ae(this._subscriptions,r),o=Ae(e,this._subscriptions),u=Ae(a,e),p=Ae(s,u),m=Ae(p,this._paused);this._visible=r;for(const b of o.values())this._subscriptions.set(b,new $r(this._version));for(const b of m.values())this._paused.add(b);for(const b of u.values())this._subscriptions.delete(b),this._paused.delete(b);(o.size||u.size||m.size)&&this._sendUpdateSubscriptions(o,u,m)}_sendUpdateSubscriptions(e,r,s){const a=Array.from(e.values()).map(o=>({tileId:o,version:this._subscriptions.get(o).version}));this._config.updateSubscriptions({subscribe:a,unsubscribe:Array.from(r.values()),pause:Array.from(s.values()),tileInfoJSON:this._config.tileInfoView.tileInfo.toJSON()})}_updateVisibility(){const e=new Set;if(!this._coverage)return e;for(const r of this._coverage.keys())this._config.isDone(r)?e.add(r.id):this._addVisibleParent(e,r)||this._addVisibleChildren(e,r)||e.add(r.id);return e}_addVisibleParent(e,r){let s=!1;for(const a of this._visible.values())new Ye.Z(a).containsChild(r)&&(e.add(a),s=!0);return s}_addVisibleChildren(e,r){let s=!1;for(const a of this._visible.values()){const o=new Ye.Z(a);r.containsChild(o)&&(e.add(a),s=!0)}return s}}var Qr=l(56482),kr=l(45611),Yr=l(94421),Xr=l(2004);const Pt=4294967294;let se=class extends((0,Qr.Z)((0,Yr.Z)((0,Y.y)(kr.Z)))){constructor(){var t;super(...arguments),t=this,this._commandsQueue=new Wr.Z({process:e=>{switch(e.type){case"processed-edit":return this._doEdit(e);case"update":return this._doUpdate()}}}),this._visibilityOverrides=new Set,this._highlightCounter=new Hr.i,this._updateHighlight=(0,M.Ds)((0,f.Z)(function*(){const e=[];for(const r of t._highlightCounter.ids()){const s=t._highlightCounter.getHighestReason(r),a=(0,k.ck)(s);e.push({objectId:r,highlightFlags:a})}t._worker.pipeline.updateHighlight({highlights:e})})),this._lastAvailableFields=[],this.eventLog=new pe,this._sourceRefreshVersion=1,this._displayRefreshVersion=1,this._pipelineUpdating=!1,this._fields=null,this.featureEffectView=new h}destroy(){this._worker?.destroy(),this._commandsQueue.destroy()}initialize(){this.addResolvingPromise(this._initProxy()),this.featureEffectView.featureEffect=this.featureEffect,this.featureEffectView.endTransitions()}_initProxy(){var t=this;return(0,f.Z)(function*(){const e=t.layer;if("isTable"in e&&e.isTable)throw new S.Z("featurelayerview:table-not-supported","table feature layer can't be displayed",{layer:e});if("mesh"===e.geometryType)throw new S.Z("featurelayerview:geometry-type-not-supported",`Geometry type of ${e.geometryType} is not supported`,{layer:e});if(("feature"===e.type||"subtype-group"===e.type)&&!1===(0,R.S1)(e)?.operations.supportsQuery)throw new S.Z("featurelayerview:query-not-supported","layer view requires a layer with query capability",{layer:e});t._worker&&t._worker.destroy();const r=t._createClientOptions();t._worker=yield function zt(t){return Xe.apply(this,arguments)}(r)})()}get hasAllFeatures(){return this.layer.visible&&this.eventLog.hasAllFeatures}get hasAllFeaturesInView(){return this.layer.visible&&this.eventLog.hasAllFeaturesInView}get hasFullGeometries(){return this.layer.visible&&this.eventLog.hasFullGeometries}get labelingCollisionInfos(){const t=this.layerAdapter.getLabelingDeconflictionInfo(this.view),e=this.layer.geometryType,r=!this.suspended;return t.map(({vvEvaluators:s,deconflictionEnabled:a})=>({container:this.featureContainer,vvEvaluators:s,deconflictionEnabled:a,geometryType:e,visible:r}))}get layerAdapter(){switch(this.layer.type){case"feature":return"memory"===this.layer.source.type?new Ot(this.layer):new Tr(this.layer);case"geojson":case"csv":case"wfs":return new Ot(this.layer);case"subtype-group":return new Kr(this.layer);case"ogc-feature":return new Ur(this.layer);case"stream":return new Lr(this.layer);case"oriented-imagery":return new Dr(this.layer);case"knowledge-graph-sublayer":return new Ar(this.layer);case"catalog-footprint":return new Fr(this.layer);default:(0,j.Bg)(this.layer)}return null}get updateHash(){if(!this.layerAdapter)return null;const{availableFields:t,_displayRefreshVersion:e,timeExtent:r,clips:s,filter:a,featureEffect:o,_sourceRefreshVersion:u,view:{timeZone:p}}=this,m=JSON.stringify(s),b=o?.toJSON(),C=a?.toJSON();return JSON.stringify({availableFields:t,clipsHash:m,displayRefreshVersion:e,effectHash:b,filterHash:C,sourceRefreshVersion:u,timeExtent:r,timeZone:p,...this.layerAdapter.getUpdateHashProperties(this.view)})}getDisplayStatistics(t,e){return this.featureContainer?.getDisplayStatistics(t,e)}queryHeatmapStatistics(t){var e=this;return(0,f.Z)(function*(){return e._worker.pipeline.queryHeatmapStatistics(t)})()}highlight(t,e="highlight"){let r;t instanceof Z.Z?r=[t.getObjectId()]:"number"==typeof t||"string"==typeof t?r=[t]:N.Z.isCollection(t)&&t.length>0?r=t.map(a=>a?.getObjectId()).toArray():Array.isArray(t)&&t.length>0&&(r="number"==typeof t[0]||"string"==typeof t[0]?t:t.map(a=>a?.getObjectId()));const s=r?.filter(ee.pC);return s?.length?(this._addHighlight(s,e),(0,E.kB)(()=>this._removeHighlight(s,e))):(0,E.kB)()}getHighlightIds(){return Array.from(this._highlightCounter.ids())}hasHighlight(){return!this._highlightCounter.empty}hitTest(t,e){var r=this;return(0,f.Z)(function*(){const s=yield r.featureContainer.hitTest(e);if(0===s.length)return null;const{features:a,aggregates:o}=yield r._worker.pipeline.getDisplayFeatures(s),u=r.featureContainer.getSortKeys(s),p=({displayId:m},{displayId:b})=>u.has(m)&&u.has(b)?u.get(m)-u.get(b):m-b;return a.sort(p).reverse(),o.sort(p).reverse(),[...o.map(m=>r._createGraphicHit(t,$.fromJSON(m))),...a.map(m=>r._createGraphicHit(t,Z.Z.fromJSON(m)))]})()}queryStatistics(){return(0,re.Y)(this._worker.pipeline.queryStatistics(),{featureCount:0,ringCount:0,vertexCount:0})}querySummaryStatistics(t,e,r){const s={...e,scale:this.view.scale},a=this._worker.features.executeQueryForSummaryStatistics(this._cleanUpQuery(t),s,r);return(0,re.Y)(a,{})}queryAggregateSummaryStatistics(t,e,r){var s=this;return(0,f.Z)(function*(){const a={...e,scale:s.view.scale},o=s._worker.aggregates.executeQueryForSummaryStatistics(s._cleanUpAggregateQuery(t),a,r);return(0,re.Y)(o,{})})()}queryUniqueValues(t,e,r){var s=this;return(0,f.Z)(function*(){const a={...e,scale:s.view.scale},o=s._worker.features.executeQueryForUniqueValues(s._cleanUpQuery(t),a,r);return(0,re.Y)(o,{uniqueValueInfos:[]})})()}queryAggregateUniqueValues(t,e,r){var s=this;return(0,f.Z)(function*(){const a={...e,scale:s.view.scale},o=s._worker.aggregates.executeQueryForUniqueValues(s._cleanUpAggregateQuery(t),a,r);return(0,re.Y)(o,{uniqueValueInfos:[]})})()}queryClassBreaks(t,e,r){var s=this;return(0,f.Z)(function*(){const a={...e,scale:s.view.scale},o=s._worker.features.executeQueryForClassBreaks(s._cleanUpQuery(t),a,r);return(0,re.Y)(o,{classBreakInfos:[]})})()}queryAggregateClassBreaks(t,e,r){var s=this;return(0,f.Z)(function*(){const a={...e,scale:s.view.scale},o=s._worker.aggregates.executeQueryForClassBreaks(s._cleanUpAggregateQuery(t),a,r);return(0,re.Y)(o,{classBreakInfos:[]})})()}queryHistogram(t,e,r){var s=this;return(0,f.Z)(function*(){const a={...e,scale:s.view.scale},o=s._worker.features.executeQueryForHistogram(s._cleanUpQuery(t),a,r);return(0,re.Y)(o,{bins:[],maxValue:null,minValue:null,normalizationTotal:null})})()}queryAggregateHistogram(t,e,r){var s=this;return(0,f.Z)(function*(){const a={...e,scale:s.view.scale},o=s._worker.aggregates.executeQueryForHistogram(s._cleanUpAggregateQuery(t),a,r);return(0,re.Y)(o,{bins:[],maxValue:null,minValue:null,normalizationTotal:null})})()}queryFeatures(t,e){return this.queryFeaturesJSON(t,e).then(r=>{const s=A.Z.fromJSON(r);return s.features.forEach(a=>this._setLayersForFeature(a)),s})}queryVisibleFeatures(t,e){var r=this;return(0,f.Z)(function*(){const s=r._worker.pipeline.queryVisibleFeatures(r._cleanUpQuery(t),e),a=yield(0,re.Y)(s,{features:[]}),o=A.Z.fromJSON(a);return o.features.forEach(u=>r._setLayersForFeature(u)),o})()}queryAggregates(t,e){var r=this;return(0,f.Z)(function*(){const s=r._worker.aggregates.executeQuery(r._cleanUpAggregateQuery(t),e),a=yield(0,re.Y)(s,{features:[]}),o=Q.fromJSON(a);return o.features.forEach(u=>r._setLayersForFeature(u)),o})()}queryAggregateIds(t,e){const r=this._worker.aggregates.executeQueryForIds(this._cleanUpAggregateQuery(t),e);return(0,re.Y)(r,[])}queryAggregateCount(t,e){const r=this._worker.aggregates.executeQueryForCount(this._cleanUpAggregateQuery(t),e);return(0,re.Y)(r,0)}queryAggregateJSON(t,e){const r=this._worker.aggregates.executeQuery(this._cleanUpAggregateQuery(t),e);return(0,re.Y)(r,{features:[]})}queryFeaturesJSON(t,e){var r=this;return(0,f.Z)(function*(){const s=r._worker.features.executeQuery(r._cleanUpQuery(t),e);return(0,re.Y)(s,{features:[]})})()}queryObjectIds(t,e){const r=this._worker.features.executeQueryForIds(this._cleanUpQuery(t),e);return(0,re.Y)(r,[])}queryFeatureCount(t,e){const r=this._worker.features.executeQueryForCount(this._cleanUpQuery(t),e);return(0,re.Y)(r,0)}queryExtent(t,e){var r=this;return(0,f.Z)(function*(){const s=r._worker.features.executeQueryForExtent(r._cleanUpQuery(t),e),a=yield(0,re.Y)(s,{count:0,extent:null});return{count:a.count,extent:Xr.Z.fromJSON(a.extent)}})()}getSampleFeatures(t){var e=this;return(0,f.Z)(function*(){return e._worker.pipeline.getSampleFeatures(t)})()}setVisibility(t,e){e?this._visibilityOverrides.delete(t):this._visibilityOverrides.add(t),this._update()}update(t){if(!this._subscriptionManager)return;const e=this._subscriptionManager.update(t);this.featureContainer.setVisibleTiles(e)}attach(){(0,V.Z)("esri-2d-update-debug")&&console.debug("FeatureLayerView2D.attach"),this.featureContainer=new Dt(this),this.container.addChild(this.featureContainer),this.view.timeline.record(`${this.layer.title} (FeatureLayer) Attach`),this._subscriptionManager=new Gr({tileInfoView:this.view.featuresTilingScheme,updateSubscriptions:t=>{this.featureContainer.updateSubscriptions(t),this._worker.pipeline.updateSubscriptions(t)},isDone:t=>this.featureContainer.isDone(t)}),this.requestUpdate(),this.addAttachHandles([(0,d.YP)(()=>this.updateHash,()=>this._update(),d.nn),(0,d.YP)(()=>this.updateSuspended,t=>{t||this._subscriptionManager.resume()})]),"stream"!==this.layer.type&&"catalog-footprint"!==this.layer.type&&this.addAttachHandles(this.layer.on("edits",t=>this._edit(t)))}detach(){(0,V.Z)("esri-2d-update-debug")&&console.debug("FeatureLayerView2D.detach"),this._fields=null,this.featureContainer.destroy(),this._commandsQueue.clear(),this.container.removeAllChildren(),this._subscriptionManager=(0,U.SC)(this._subscriptionManager),this._worker.pipeline.onDetach()}moveStart(){this.requestUpdate()}viewChange(){this.requestUpdate()}moveEnd(){this.requestUpdate()}isUpdating(){const t="renderer"in this.layer&&null!=this.layer.renderer,e=this._commandsQueue.updateTracking.updating,r=null!=this._updatingRequiredFieldsPromise,s=this.featureContainer.updatingHandles.updating,a=t&&(e||r)||s||this._pipelineUpdating||this.dataUpdating;if((0,V.Z)("esri-2d-log-updating")){console.log(`Updating FLV2D (${this.layer.id}): ${a}\n  -> hasRenderer ${t}\n  -> updatingRequiredFields ${r}\n  -> hasPendingCommand ${e}\n  -> dataUpdating ${this.dataUpdating}\n  -> processing ${this._pipelineUpdating}\n  -> updatingContainer ${s}\n`);for(const o of this.featureContainer.subscriptions())console.log(`    -> Tile[${o.id}] Done: ${o.done}`)}return a}_createClientOptions(){const t=this;return{get container(){return t.featureContainer},setUpdating:e=>{this._set("_pipelineUpdating",e.pipeline),this._set("dataUpdating",e.data)},emitEvent:e=>{this.emit(e.name,e.event)},get eventLog(){return t.eventLog},fetch:e=>Promise.all(e.map(r=>t.view.stage.painter.textureManager.rasterizeItem(r))),fetchDictionary:e=>Promise.all(e.map(r=>this._fetchDictionaryRequest(r)))}}_fetchDictionaryRequest(t){var e=this;return(0,f.Z)(function*(){try{if("subtype-group"===e.layer.type)throw new Error("InternalError: SubtypeGroupLayer does not support dictionary renderer");const r=e.layer.renderer;if(!r||"dictionary"!==r.type)throw new Error("InternalError: Expected layer to have a DictionaryRenderer");const s=e._lastSchema.processor.mesh.factory.symbology;if("dictionary"!==s.type)throw new Error("InternalError: Expected schema to be of type 'dictionary'");const a={cimAnalyzer:e.view.stage.cimAnalyzer,cimResourceManager:e.view.stage.painter.textureManager.resourceManager,store:e.featureContainer.instanceStore,scaleExpression:s.scaleExpression};e._fields||(e._fields=e.layer.fields.map(p=>p.toJSON()));const o=s.visualVariableUniforms,u=yield r.getSymbolAsync(t.feature,{fields:e._fields});return u&&u.data?{type:"dictionary-response",meshes:yield(0,$e.$L)(u.data,{uniforms:o,path:"renderer",schemaOptions:a})}:{type:"dictionary-response",meshes:[]}}catch{return{type:"dictionary-response",meshes:[]}}})()}_cleanUpQuery(t){const e=K.Z.from(t)||this.createQuery();return e.outSpatialReference||(e.outSpatialReference=this.view.spatialReference),e.toJSON()}_cleanUpAggregateQuery(t){const e=K.Z.from(t)||this.createAggregateQuery();e.outSpatialReference||(e.outSpatialReference=this.view.spatialReference);const r=e.objectIds??[];for(const s of e.aggregateIds??[])r.push(s);return e.objectIds=r,e.aggregateIds=[],e.toJSON()}_update(){var t=this;return(0,f.Z)(function*(){return t._commandsQueue.push({type:"update"})})()}_edit(t){var e=this;return(0,f.Z)(function*(){return e.updateSuspended?void e._subscriptionManager.suspend():e._validateEdit(t)?e._commandsQueue.push({type:"edit",edits:t}).catch(M.H9):void 0})()}doRefresh(t){var e=this;return(0,f.Z)(function*(){e.attached&&(e.updateSuspended&&t||(t?e.incrementSourceRefreshVersion():e.incrementDisplayRefreshVersion()))})()}incrementSourceRefreshVersion(){this._sourceRefreshVersion=(this._sourceRefreshVersion+1)%Pt+1}incrementDisplayRefreshVersion(){this._displayRefreshVersion=(this._displayRefreshVersion+1)%Pt+1}_validateEdit(t){const e="globalIdField"in this.layer&&this.layer.globalIdField,r=t.deletedFeatures.some(a=>-1===a.objectId||!a.objectId),s=e&&this.availableFields.includes(e);return r&&!s?(I.Z.getLogger(this).error(new S.Z("mapview-apply-edits",`Editing the specified service requires the layer's globalIdField, ${e} to be included the layer's outFields for updates to be reflected on the map`)),null):t}_doUpdate(){var t=this;return(0,f.Z)(function*(){"featureReduction"in t.layer&&t.layer.featureReduction&&t.layer.featureReduction!==t._lastFeatureReduction&&(t.layer.featureReduction=t.layer.featureReduction?.clone(),t._lastFeatureReduction=t.layer.featureReduction);try{if(yield t._updateRequiredFields(),t.destroyed||!t.layerAdapter?.hasRequiredSupport||!t._subscriptionManager)return;const e=t.featureContainer.instanceStore;t.featureContainer.attributeView.lockTextureUploads(),e.updateStart();const r=t.featureEffect,s={store:e,cimAnalyzer:t.view.stage.cimAnalyzer,cimResourceManager:t.view.stage.painter.textureManager.resourceManager,scaleExpression:void 0},a=yield t.layerAdapter.createServiceOptions(t.view),o=t._createViewSchemaConfig(),u={source:t.layerAdapter.createSourceSchema(a,o,t._sourceRefreshVersion),processor:yield t.layerAdapter.createProcessorSchema(s,o,t._displayRefreshVersion)},p=!!(0,_.Hg)(t._lastSchema?.source.mutable,u.source.mutable)||!!(0,_.Hg)(t._lastSchema?.processor,u.processor);if(!p)return t.featureContainer.requestRender(),t.featureContainer.attributeView.unlockTextureUploads(),e.updateEnd(),void(t.featureEffectView.featureEffect=r);t._lastSchema=u,t._fields=null;const m=Math.round(performance.now());(0,V.Z)("esri-2d-update-debug")&&console.debug(`Id[${t.layer.uid}] Version[${m}] FeatureLayerView2D._doUpdate`,{changes:p});let b=[];Array.isArray(a.source)&&(b=a.source),yield t._worker.pipeline.updateSchema(u,m,{transferList:b}),e.updateEnd(),t.featureEffectView.featureEffect=r,t.featureEffectView.endTransitions(),t.featureContainer.attributeView.unlockTextureUploads(),t.featureContainer.swapRenderState(),t.featureContainer.requestRender(),(0,V.Z)("esri-2d-update-debug")&&console.debug(`Version[${m}] FeatureLayerView2D.updateEnd`),t.requestUpdate()}catch(e){(0,V.Z)("esri-2d-update-debug")&&console.error("Encountered an error during update",e)}})()}_doEdit(t){var e=this;return(0,f.Z)(function*(){try{e.featureContainer.editStart(),yield e._worker.pipeline.onEdits(t),e.featureContainer.editEnd()}catch(r){(0,M.D_)(r)}})()}get hasFilter(){const t=this.layerAdapter.hasFilters?.(this.view)??!1;return null!=this.filter||null!=this.timeExtent||this._visibilityOverrides.size>0||t}_getEffectiveAvailableFields(t){const e=function qr(t,e){const r=new Set;return t&&t.forEach(s=>r.add(s)),e&&e.forEach(s=>r.add(s)),r.has("*")?["*"]:Array.from(r)}(this._lastAvailableFields,t);return this._lastAvailableFields=e,(0,w.TK)(this.layer.fieldsIndex,e)}_createViewSchemaConfig(){const t=[ti(this.view,this.layerAdapter,this.timeExtent,this._visibilityOverrides,this.filter),this.featureEffect?.filter?.toJSON()??null];return{availableFields:this._getEffectiveAvailableFields(this.availableFields),filters:t,outSpatialReference:this.view.spatialReference,tileInfoJSON:this.view.featuresTilingScheme.tileInfo.toJSON(),scale:this.view.scale,timeZone:this.view.timeZone}}_addHighlight(t,e){this._highlightCounter.addReason(t,e),this._updateHighlight().catch(r=>{(0,M.D_)(r)||I.Z.getLogger(this).error(r)})}_removeHighlight(t,e){this._highlightCounter.deleteReason(t,e),this._updateHighlight().catch(r=>{(0,M.D_)(r)||I.Z.getLogger(this).error(r)})}_setLayersForFeature(t){t.layer=t.sourceLayer=this.layer,this.layerAdapter.setGraphicOrigin&&this.layerAdapter.setGraphicOrigin(t)}_createGraphicHit(t,e){return this._setLayersForFeature(e),null!=e.geometry&&(e.geometry.spatialReference=this.view.spatialReference),{type:"graphic",graphic:e,layer:this.layer,mapPoint:t}}};function ti(t,e,r,s,a){a&&(a=a.clone());const o=null!=a?a.timeExtent:null,u=null!=r&&null!=o?r.intersection(o):r||o;u&&(a??=new v.Z,a.timeExtent=u);let p=(a=e.addFilters?.(a,t)??a)?.toJSON()??null;return s.size&&(p??=(new v.Z).toJSON(),p.hiddenIds=Array.from(s)),p}(0,x._)([(0,O.Cb)()],se.prototype,"_worker",void 0),(0,x._)([(0,O.Cb)()],se.prototype,"_commandsQueue",void 0),(0,x._)([(0,O.Cb)()],se.prototype,"_sourceRefreshVersion",void 0),(0,x._)([(0,O.Cb)()],se.prototype,"_displayRefreshVersion",void 0),(0,x._)([(0,O.Cb)({readOnly:!0})],se.prototype,"_pipelineUpdating",void 0),(0,x._)([(0,O.Cb)({readOnly:!0})],se.prototype,"hasAllFeatures",null),(0,x._)([(0,O.Cb)({readOnly:!0})],se.prototype,"hasAllFeaturesInView",null),(0,x._)([(0,O.Cb)({readOnly:!0})],se.prototype,"hasFullGeometries",null),(0,x._)([(0,O.Cb)()],se.prototype,"featureEffectView",void 0),(0,x._)([(0,O.Cb)()],se.prototype,"labelingCollisionInfos",null),(0,x._)([(0,O.Cb)()],se.prototype,"layerAdapter",null),(0,x._)([(0,O.Cb)()],se.prototype,"updateHash",null),(0,x._)([(0,O.Cb)()],se.prototype,"updating",void 0),se=(0,x._)([(0,F.j)("esri.views.2d.layers.FeatureLayerView2D")],se);const ri=se},56800:(ne,W,l)=>{l.d(W,{y:()=>c});var S,f=l(17626),x=l(46160),Z=l(89726),O=l(26584),V=l(32917),I=l(77712),$=(l(8314),l(63290),l(4619),l(76898)),G=l(83137),ee=l(1011),N=l(38093),j=l(90135);let E=S=class extends j.Z{constructor(y){super(y),this.type="rect",this.left=null,this.right=null,this.top=null,this.bottom=null}clone(){return new S({left:this.left,right:this.right,top:this.top,bottom:this.bottom})}commitVersionProperties(){this.commitProperty("left"),this.commitProperty("right"),this.commitProperty("top"),this.commitProperty("bottom")}};(0,f._)([(0,I.Cb)({type:[Number,String],json:{write:!0}})],E.prototype,"left",void 0),(0,f._)([(0,I.Cb)({type:[Number,String],json:{write:!0}})],E.prototype,"right",void 0),(0,f._)([(0,I.Cb)({type:[Number,String],json:{write:!0}})],E.prototype,"top",void 0),(0,f._)([(0,I.Cb)({type:[Number,String],json:{write:!0}})],E.prototype,"bottom",void 0),E=S=(0,f._)([(0,$.j)("esri.views.layers.support.ClipRect")],E);const U=E;var M=l(74835);let d=class extends j.Z{constructor(y){super(y),this.type="path",this.path=[]}commitVersionProperties(){this.commitProperty("path")}};(0,f._)([(0,I.Cb)({type:[[[Number]]],json:{write:!0}})],d.prototype,"path",void 0),d=(0,f._)([(0,$.j)("esri.views.layers.support.Path")],d);const g=x.Z.ofType({key:"type",base:null,typeMap:{rect:U,path:d,geometry:M.Z}}),c=y=>{let h=class extends y{constructor(){super(...arguments),this.attached=!1,this.clips=new g,this.lastUpdateId=-1,this.moving=!1,this.updateRequested=!1,this.visibleAtCurrentScale=!1,this.highlightOptions=null}initialize(){this.view?.spatialReference&&(this.view?.spatialReferenceLocked??1)&&!this.spatialReferenceSupported?this.addResolvingPromise(Promise.reject(new O.Z("layerview:spatial-reference-incompatible","The spatial reference of this layer does not meet the requirements of the view",{layer:this.layer}))):(this.container||(this.container=new ee.W),this.container.fadeTransitionEnabled=!0,this.container.visible=!1,this.container.endTransitions(),this.addHandles([(0,V.YP)(()=>this.suspended,R=>{this.container&&(this.container.visible=!R)},V.tX),(0,V.YP)(()=>this.updateSuspended,R=>{this.view&&!R&&this.updateRequested&&this.view.requestUpdate()},V.tX),(0,V.YP)(()=>this.layer?.opacity??1,R=>{this.container&&(this.container.opacity=R)},V.tX),(0,V.YP)(()=>this.layer&&"blendMode"in this.layer?this.layer.blendMode:"normal",R=>{this.container&&(this.container.blendMode=R)},V.tX),(0,V.YP)(()=>this.layer&&"effect"in this.layer?this.layer.effect:null,R=>{this.container&&(this.container.effect=R)},V.tX),(0,V.YP)(()=>this.highlightOptions,R=>this.container.highlightOptions=R,V.tX),(0,V.on)(()=>this.clips,"change",()=>{this.container&&(this.container.clips=this.clips)},V.tX),(0,V.YP)(()=>({scale:this.view?.scale,scaleRange:this.layer&&"effectiveScaleRange"in this.layer?this.layer.effectiveScaleRange:null}),({scale:R})=>{const D=null!=R&&this.isVisibleAtScale(R);D!==this.visibleAtCurrentScale&&this._set("visibleAtCurrentScale",D)},V.tX)],"constructor"),this.view?.whenLayerView?this.view.whenLayerView(this.layer).then(R=>{R===this&&this.processAttach()},()=>{}):this.when().then(()=>{this.processAttach()},()=>{}))}destroy(){this.processDetach(),this.updateRequested=!1}get spatialReferenceSupported(){const v=this.view?.spatialReference;return null==v||this.supportsSpatialReference(v)}get updateSuspended(){return this.suspended}get updating(){return this.spatialReferenceSupported&&(!this.attached||!this.suspended&&(this.updateRequested||this.isUpdating())||!!this._updatingHandles?.updating)}processAttach(){this.isResolved()&&!this.attached&&!this.destroyed&&this.spatialReferenceSupported&&(this.attach(),this.attached=!0,this.requestUpdate())}processDetach(){this.attached&&(this.attached=!1,this.removeHandles("attach"),this.detach(),this.updateRequested=!1)}isVisibleAtScale(v){const w=this.layer&&"effectiveScaleRange"in this.layer?this.layer.effectiveScaleRange:null;if(!w)return!0;const{minScale:R,maxScale:D}=w;return(0,G.o2)(v,R,D)}requestUpdate(){this.destroyed||this.updateRequested||(this.updateRequested=!0,this.updateSuspended||this.view.requestUpdate())}processUpdate(v){!this.isFulfilled()||this.isResolved()?(this._set("updateParameters",v),this.updateRequested&&!this.updateSuspended&&(this.updateRequested=!1,this.update(v))):this.updateRequested=!1}hitTest(v,w){return Promise.resolve(null)}supportsSpatialReference(v){return!0}canResume(){return!!this.spatialReferenceSupported&&!!super.canResume()&&this.visibleAtCurrentScale}getSuspendInfo(){const v=super.getSuspendInfo(),w=!this.spatialReferenceSupported,R=this.visibleAtCurrentScale;return w&&(v.spatialReferenceNotSupported=w),R&&(v.outsideScaleRange=R),v}addAttachHandles(v){this.addHandles(v,"attach")}};return(0,f._)([(0,I.Cb)()],h.prototype,"attached",void 0),(0,f._)([(0,I.Cb)({type:g,set(v){const w=(0,Z.Z)(v,this._get("clips"),g);this._set("clips",w)}})],h.prototype,"clips",void 0),(0,f._)([(0,I.Cb)()],h.prototype,"container",void 0),(0,f._)([(0,I.Cb)()],h.prototype,"moving",void 0),(0,f._)([(0,I.Cb)({readOnly:!0})],h.prototype,"spatialReferenceSupported",null),(0,f._)([(0,I.Cb)({readOnly:!0})],h.prototype,"updateParameters",void 0),(0,f._)([(0,I.Cb)()],h.prototype,"updateRequested",void 0),(0,f._)([(0,I.Cb)()],h.prototype,"updateSuspended",null),(0,f._)([(0,I.Cb)()],h.prototype,"updating",null),(0,f._)([(0,I.Cb)()],h.prototype,"view",void 0),(0,f._)([(0,I.Cb)({readOnly:!0})],h.prototype,"visibleAtCurrentScale",void 0),(0,f._)([(0,I.Cb)({type:N.Z})],h.prototype,"highlightOptions",void 0),h=(0,f._)([(0,$.j)("esri.views.2d.layers.LayerView2D")],h),h}},55376:(ne,W,l)=>{function f(x,Z,O,V){const I=x.clone(),P=1<<I.level,F=I.col+Z,z=I.row+O;return V&&F<0?(I.col=F+P,I.world-=1):F>=P?(I.col=F-P,I.world+=1):I.col=F,I.row=z,I}l.d(W,{M:()=>f})},79359:(ne,W,l)=>{l.d(W,{i:()=>x});var f=l(72571);class x{constructor(){this._idToCounters=new Map}get empty(){return 0===this._idToCounters.size}addReason(O,V){for(const I of O){let P=this._idToCounters.get(I);P||(P=new Map,this._idToCounters.set(I,P)),P.set(V,(P.get(V)||0)+1)}}deleteReason(O,V){for(const I of O){const P=this._idToCounters.get(I);if(!P)continue;let F=P.get(V);if(null==F)return;F--,F>0?P.set(V,F):P.delete(V),0===P.size&&this._idToCounters.delete(I)}}getHighestReason(O){const V=this._idToCounters.get(O);if(!V)return null;let I=null;for(const P of f.Oo)V.get(P)&&(I=P);return I||null}ids(){return this._idToCounters.keys()}}},57121:(ne,W,l)=>{l.d(W,{Y:()=>x});var f=l(15861);function x(O,V){return Z.apply(this,arguments)}function Z(){return(Z=(0,f.Z)(function*(O,V){try{return yield O}catch(I){if("no-queryEngine"!==I.name)throw I;return V}})).apply(this,arguments)}},56482:(ne,W,l)=>{l.d(W,{Z:()=>d});var f=l(15861),x=l(17626),Z=l(26584),O=l(63290),V=l(10699),I=l(32917),P=l(77712),$=(l(8314),l(4619),l(76898)),G=l(13812),ee=l(2319),N=l(98624),j=l(90194),S=l(59990),E=l(96854),U=l(46679),M=l(10023);const d=_=>{let g=class extends _{constructor(...c){super(...c),this._updatingRequiredFieldsPromise=null,this.dataUpdating=!1,this.filter=null,this.timeExtent=null,this.layer=null,this.requiredFields=[],this.view=null}initialize(){this.addHandles([(0,I.YP)(()=>{const c=this.layer;return[c&&"elevationInfo"in c?c.elevationInfo?.featureExpressionInfo:null,c&&"displayField"in c?c.displayField:null,c&&"timeInfo"in c&&c.timeInfo,c&&"renderer"in c&&c.renderer,c&&"labelingInfo"in c&&c.labelingInfo,c&&"floorInfo"in c&&c.floorInfo,this.filter,this.featureEffect,this.timeExtent]},()=>this._handleRequiredFieldsChange(),I.tX),(0,I.on)(()=>this.view?.floors,"change",()=>this._handleRequiredFieldsChange()),(0,I.on)(()=>{const c=this.layer;return c&&"sublayers"in c?c.sublayers:null},"change",()=>this._handleRequiredFieldsChange())])}get availableFields(){if(!this.layer)return[];const{layer:c,layer:{fieldsIndex:y},requiredFields:h}=this;return(0,j.Q0)(y,"outFields"in c&&c.outFields?[...(0,j.Lk)(y,c.outFields),...h]:h)}get featureEffect(){return this.layer&&"featureEffect"in this.layer?this.layer.featureEffect:null}set featureEffect(c){this._override("featureEffect",c)}get maximumNumberOfFeatures(){return 0}set maximumNumberOfFeatures(c){O.Z.getLogger(this).error("#maximumNumberOfFeatures=","Setting maximum number of features is not supported")}get maximumNumberOfFeaturesExceeded(){return!1}highlight(c){throw new Error("missing implementation")}createQuery(){const c={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference},y=null!=this.filter?this.filter.createQuery(c):new E.Z(c);if("floorInfo"in this.layer&&this.layer.floorInfo){const h=(0,S.c)(this);null!=h&&(y.where=y.where?`(${y.where}) AND (${h})`:h)}return null!=this.timeExtent&&(y.timeExtent=null!=y.timeExtent?y.timeExtent.intersection(this.timeExtent):this.timeExtent.clone()),y}createAggregateQuery(){return new E.Z({outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference})}queryFeatures(c,y){throw new Error("missing implementation")}queryObjectIds(c,y){throw new Error("missing implementation")}queryFeatureCount(c,y){throw new Error("missing implementation")}queryExtent(c,y){throw new Error("missing implementation")}fetchPopupFeaturesFromGraphics(c,y){var h=this;return(0,f.Z)(function*(){return h._validateFetchPopupFeatures(c,y),h._fetchPopupFeatures(c,y)})()}_loadArcadeModules(c){return c.expressionInfos?.length||Array.isArray(c.content)&&c.content.some(y=>"expression"===y.type)?(0,U.LC)():Promise.resolve()}_handleRequiredFieldsChange(){const c=this._updateRequiredFields();this._set("_updatingRequiredFieldsPromise",c),c.then(()=>{this._updatingRequiredFieldsPromise===c&&this._set("_updatingRequiredFieldsPromise",null)})}_updateRequiredFields(){var c=this;return(0,f.Z)(function*(){if(!c.layer||!c.view)return;const y="3d"===c.view.type,{layer:h,layer:{fieldsIndex:v,objectIdField:w}}=c,R="renderer"in h&&h.renderer,D="orderBy"in h&&h.orderBy,A="featureReduction"in h?h.featureReduction:null,L=new Set,H=yield Promise.allSettled([R?R.collectRequiredFields(L,v):null,(0,j.Mu)(L,h),y&&"elevationInfo"in h?(0,j.vl)(L,h):null,null!=c.filter?(0,j.Ll)(L,h,c.filter):null,y||null==c.featureEffect?null:(0,j.Ll)(L,h,c.featureEffect.filter),!y&&A?(0,j.ZV)(L,h,A):null,!y&&D?(0,j.Qj)(L,h,D):null]);if("timeInfo"in h&&h.timeInfo&&c.timeExtent&&(0,j.gd)(L,h.fieldsIndex,[h.timeInfo.startField,h.timeInfo.endField]),"floorInfo"in h&&h.floorInfo&&(0,j.gd)(L,h.fieldsIndex,[h.floorInfo.floorField]),"feature"===h.type&&y&&null!=h.infoFor3D&&(null==h.globalIdField&&O.Z.getLogger(c).error("globalIdField missing on 3DObjectFeatureLayer"),(0,j.gd)(L,h.fieldsIndex,[h.globalIdField])),"subtype-group"===h.type){(0,j.AB)(L,v,h.subtypeField);const K=h.sublayers.map(k=>Promise.all([k.renderer?.collectRequiredFields(L,v),(0,j.Mu)(L,k)]));yield Promise.allSettled(K)}"catalog-footprint"===h.type&&(0,j.gd)(L,v,[h.parent.itemSourceField,h.parent.itemTypeField]);for(const K of H)"rejected"===K.status&&O.Z.getLogger(c).error(K.reason);(0,j.AB)(L,v,w),y&&"displayField"in h&&h.displayField&&(0,j.AB)(L,v,h.displayField);const Q=Array.from(L).sort();c._set("requiredFields",Q)})()}_validateFetchPopupFeatures(c,y){if(null!=y)for(const h of c){const v=h.origin&&"layer"in h.origin?h.origin.layer:h.layer;if("popupEnabled"in v&&!v.popupEnabled)throw new Z.Z("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:v});if(h.isAggregate){const w="featureReduction"in v?v.featureReduction:null;if(!(w&&"popupTemplate"in w&&w.popupEnabled&&w.popupTemplate))throw new Z.Z("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:v})}else if("popupTemplate"in v&&!(0,M.V5)(v,y))throw new Z.Z("featurelayerview:fetchPopupFeatures","Layer does not define a popup template",{layer:v})}}_popupFeatureHasRequiredFields(c,y){return(0,j.R9)(y,c)}_fetchPopupFeatures(c,y){var h=this;return(0,f.Z)(function*(){const v=new Array(c.length),w=new Map,R=yield h._createPopupQuery(c.map(D=>D.origin?.layer??D.layer),y);for(let D=0;D<c.length;D++){const A=c[D];if(A.isAggregate){v[D]=A;continue}const L=A.origin?.layer??A.layer;if(!L||!("popupEnabled"in L))continue;const H=(0,j.Lk)(h.layer.fieldsIndex,R.outFields),Q=(0,M.V5)(L,y);if(null==Q)continue;const K=yield h._loadArcadeModules(Q);(0,V.k_)(y),K&&K.arcadeUtils.hasGeometryOperations(Q)||!h._popupFeatureHasRequiredFields(A,H)?w.set(A.getObjectId(),{graphic:A,index:D}):v[D]=A}if("stream"===h.layer.type||0===w.size)return v.filter(Boolean);R.objectIds=Array.from(w.keys());try{const D=yield h.layer.queryFeatures(R,y);for(const A of D.features){const{graphic:{geometry:L,origin:H},index:Q}=w.get(A.getObjectId());A.geometry||=L,A.origin=H,v[Q]=A}}catch{}return v.filter(Boolean)})()}_createPopupQuery(c,y){var h=this;return(0,f.Z)(function*(){const v=h.layer.createQuery(),w=new Set;let R=!1;const D=c??[h.layer];for(const A of D){if(!("popupEnabled"in A))continue;const L=(0,M.V5)(A,y);if(null==L)continue;const H=yield h._loadArcadeModules(L);(0,V.k_)(y);const Q=H&&H.arcadeUtils.hasGeometryOperations(L);R=!("point"!==h.layer.geometryType&&!Q);const K=yield(0,M.e7)(h.layer,L);(0,V.k_)(y);for(const k of K)w.add(k)}if(v.returnGeometry=R,v.returnZ=R,v.returnM=R,v.outFields=Array.from(w),v.outSpatialReference=h.view.spatialReference,"floorInfo"in h.layer&&h.layer.floorInfo){const A=(0,S.c)(h);null!=A&&(v.where=v.where?`(${v.where}) AND (${A})`:A)}return v})()}canResume(){return!(!super.canResume()||null!=this.timeExtent&&this.timeExtent.isEmpty)}getTest(){return{createPopupQuery:c=>this._createPopupQuery(void 0,c)}}get test(){return this.getTest()}};return(0,x._)([(0,P.Cb)()],g.prototype,"_updatingRequiredFieldsPromise",void 0),(0,x._)([(0,P.Cb)({readOnly:!0})],g.prototype,"availableFields",null),(0,x._)([(0,P.Cb)({readOnly:!0})],g.prototype,"dataUpdating",void 0),(0,x._)([(0,P.Cb)({type:ee.Z})],g.prototype,"featureEffect",null),(0,x._)([(0,P.Cb)({type:N.Z})],g.prototype,"filter",void 0),(0,x._)([(0,P.Cb)(G.qG)],g.prototype,"timeExtent",void 0),(0,x._)([(0,P.Cb)()],g.prototype,"layer",void 0),(0,x._)([(0,P.Cb)({type:Number})],g.prototype,"maximumNumberOfFeatures",null),(0,x._)([(0,P.Cb)({readOnly:!0,type:Boolean})],g.prototype,"maximumNumberOfFeaturesExceeded",null),(0,x._)([(0,P.Cb)({readOnly:!0})],g.prototype,"requiredFields",void 0),(0,x._)([(0,P.Cb)()],g.prototype,"suspended",void 0),(0,x._)([(0,P.Cb)()],g.prototype,"view",void 0),g=(0,x._)([(0,$.j)("esri.views.layers.FeatureLayerView")],g),g}},45611:(ne,W,l)=>{l.d(W,{Z:()=>j});var f=l(17626),x=l(83761),Z=l(61885),O=l(61996),V=l(63290),I=l(62208),P=l(60330),F=l(77712),G=(l(8314),l(4619),l(76898)),ee=l(11426);let N=class extends((0,O.IG)((0,P.v)(Z.Z.EventedMixin(x.Z)))){constructor(S){super(S),this._updatingHandles=new ee.R,this.layer=null,this.parent=null}initialize(){this.when().catch(S=>{if("layerview:create-error"!==S.name){const E=this.layer&&this.layer.id||"no id",U=this.layer?.title||"no title";V.Z.getLogger(this).error("#resolve()",`Failed to resolve layer view (layer title: '${U}', id: '${E}')`,S)}})}destroy(){this._updatingHandles=(0,I.SC)(this._updatingHandles)}get fullOpacity(){return(this.layer?.opacity??1)*(this.parent?.fullOpacity??1)}get suspended(){return!this.canResume()}get suspendInfo(){return this.getSuspendInfo()}get legendEnabled(){return!this.suspended&&!0===this.layer?.legendEnabled}get updating(){return!(!this._updatingHandles?.updating&&!this.isUpdating())}get updatingProgress(){return this.updating?0:1}get visible(){return!0===this.layer?.visible}set visible(S){this._overrideIfSome("visible",S)}canResume(){return this.visible&&this.layer?.loaded&&!this.parent?.suspended&&this.view?.ready||!1}getSuspendInfo(){const S=this.parent?.suspended?this.parent.suspendInfo:{};return this.view?.ready||(S.viewNotReady=!0),this.layer&&this.layer.loaded||(S.layerNotLoaded=!0),this.visible||(S.layerInvisible=!0),S}isUpdating(){return!1}};(0,f._)([(0,F.Cb)()],N.prototype,"fullOpacity",null),(0,f._)([(0,F.Cb)()],N.prototype,"layer",void 0),(0,f._)([(0,F.Cb)()],N.prototype,"parent",void 0),(0,f._)([(0,F.Cb)({readOnly:!0})],N.prototype,"suspended",null),(0,f._)([(0,F.Cb)({readOnly:!0})],N.prototype,"suspendInfo",null),(0,f._)([(0,F.Cb)({readOnly:!0})],N.prototype,"legendEnabled",null),(0,f._)([(0,F.Cb)({type:Boolean,readOnly:!0})],N.prototype,"updating",null),(0,f._)([(0,F.Cb)({readOnly:!0})],N.prototype,"updatingProgress",null),(0,f._)([(0,F.Cb)()],N.prototype,"visible",null),(0,f._)([(0,F.Cb)()],N.prototype,"view",void 0),N=(0,f._)([(0,G.j)("esri.views.layers.LayerView")],N);const j=N},94421:(ne,W,l)=>{l.d(W,{Z:()=>z});var f=l(17626),x=l(63290),Z=l(10699),O=l(32917),F=(l(8314),l(4619),l(26584),l(76898));const z=$=>{let G=class extends ${initialize(){this.addHandles((0,O.on)(()=>this.layer,"refresh",ee=>{this.doRefresh(ee.dataChanged).catch(N=>{(0,Z.D_)(N)||x.Z.getLogger(this).error(N)})}),"RefreshableLayerView")}};return G=(0,f._)([(0,F.j)("esri.layers.mixins.RefreshableLayerView")],G),G}},90135:(ne,W,l)=>{l.d(W,{Z:()=>z});var f=l(17626),x=l(86810),Z=l(77712),P=(l(8314),l(63290),l(4619),l(76898));let F=class extends x.wq{get version(){return this.commitVersionProperties(),(this._get("version")||0)+1}};(0,f._)([(0,Z.Cb)({readOnly:!0})],F.prototype,"version",null),F=(0,f._)([(0,P.j)("esri.views.layers.support.ClipArea")],F);const z=F},74835:(ne,W,l)=>{l.d(W,{Z:()=>E});var N,f=l(17626),Z=(l(29132),l(77712)),P=(l(8314),l(63290),l(4619),l(76898)),F=l(21674),z=l(91179),$=l(90135),G=l(2004),ee=l(37118);const j={base:F.Z,key:"type",typeMap:{extent:G.Z,polygon:ee.Z}};let S=N=class extends $.Z{constructor(U){super(U),this.type="geometry",this.geometry=null}clone(){return new N({geometry:this.geometry?.clone()??null})}commitVersionProperties(){this.commitProperty("geometry")}};(0,f._)([(0,Z.Cb)({types:j,json:{read:z.im,write:!0}})],S.prototype,"geometry",void 0),S=N=(0,f._)([(0,P.j)("esri.views.layers.support.Geometry")],S);const E=S},10023:(ne,W,l)=>{l.d(W,{V5:()=>V,e7:()=>Z,zc:()=>I});var f=l(15861),x=l(90194);function Z(P){return O.apply(this,arguments)}function O(){return(O=(0,f.Z)(function*(P,F=P.popupTemplate){if(null==F)return[];const z=yield F.getRequiredFields(P.fieldsIndex),{lastEditInfoEnabled:$}=F,{objectIdField:G,typeIdField:ee,globalIdField:N,relationships:j}=P;if(z.includes("*"))return["*"];const S=$?(0,x.CH)(P):[],E=(0,x.Q0)(P.fieldsIndex,[...z,...S]);return ee&&E.push(ee),E&&G&&P.fieldsIndex?.has(G)&&!E.includes(G)&&E.push(G),E&&N&&P.fieldsIndex?.has(N)&&!E.includes(N)&&E.push(N),j&&j.forEach(U=>{const{keyField:M}=U;E&&M&&P.fieldsIndex?.has(M)&&!E.includes(M)&&E.push(M)}),E})).apply(this,arguments)}function V(P,F){return P.popupTemplate?P.popupTemplate:null!=F&&F.defaultPopupTemplateEnabled&&null!=P.defaultPopupTemplate?P.defaultPopupTemplate:null}function I(P,F){return null!=V(P,{defaultPopupTemplateEnabled:F})}}}]);