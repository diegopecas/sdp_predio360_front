"use strict";(self.webpackChunkpredio360_app=self.webpackChunkpredio360_app||[]).push([[5279],{47139:(lt,ze,b)=>{b.d(ze,{Fp:()=>Re,RL:()=>se,UV:()=>W,bk:()=>fe});var K=b(36161),ce=b(91179),ae=b(31375),D=b(39351);function Re(w){switch(w.type){case"CIMPointSymbol":{const O=w.symbolLayers;if(!O||1!==O.length)return null;const E=O[0];return"CIMVectorMarker"!==E.type?null:Re(E)}case"CIMVectorMarker":{const O=w.markerGraphics;if(!O||1!==O.length)return null;const E=O[0];if(!E)return null;const P=E.geometry;if(!P)return null;const g=E.symbol;return!g||"CIMPolygonSymbol"!==g.type&&"CIMLineSymbol"!==g.type||g.symbolLayers?.some(T=>!!T.effects)?null:{type:"sdf",geom:P,asFill:"CIMPolygonSymbol"===g.type}}}}function de(w){let O=1/0,E=-1/0,P=1/0,g=-1/0;for(const T of w)for(const S of T)S[0]<O&&(O=S[0]),S[0]>E&&(E=S[0]),S[1]<P&&(P=S[1]),S[1]>g&&(g=S[1]);return[O,P,E,g]}function fe(w){return w?w.rings?de(w.rings):w.paths?de(w.paths):(0,ce.YX)(w)?[w.xmin,w.ymin,w.xmax,w.ymax]:null:null}function W(w,O,E,P,g){const[T,S,V,X]=w;if(V<T||X<S)return[0,0,0,1];const N=V-T,k=X-S,L=D.s4,q=Math.floor(.5*(64-L)),Y=(128-2*(q+L))/Math.max(N,k),te=Math.round(N*Y)+2*q,ne=Math.round(k*Y)+2*q;let oe=1;O&&(oe=ne/Y/(O.ymax-O.ymin));let J=0,Q=0,Z=1;P&&(g?O&&E&&O.ymax-O.ymin>0&&(Z=(O.xmax-O.xmin)/(O.ymax-O.ymin),J=P.x/(E*Z),Q=P.y/E):(J=P.x,Q=P.y)),O&&(J=.5*(O.xmax+O.xmin)+J*(O.xmax-O.xmin),Q=.5*(O.ymax+O.ymin)+Q*(O.ymax-O.ymin)),J-=T,Q-=S,J*=Y,Q*=Y,J+=q,Q+=q;let pe=J/te-.5,_e=Q/ne-.5;return g&&E&&(pe*=E*Z,_e*=E),[oe,pe,_e,Z]}function se(w){const O=function Ue(w){return w?w.rings?w.rings:w.paths?w.paths:void 0!==w.xmin&&void 0!==w.ymin&&void 0!==w.xmax&&void 0!==w.ymax?[[[w.xmin,w.ymin],[w.xmin,w.ymax],[w.xmax,w.ymax],[w.xmax,w.ymin],[w.xmin,w.ymin]]]:null:null}(w.geom),E=function G(w){let O=1/0,E=-1/0,P=1/0,g=-1/0;for(const T of w)for(const S of T)S[0]<O&&(O=S[0]),S[0]>E&&(E=S[0]),S[1]<P&&(P=S[1]),S[1]>g&&(g=S[1]);return new ae.Z(O,P,E-O,g-P)}(O),g=D.s4,T=Math.floor(.5*(64-g)),S=(128-2*(T+g))/Math.max(E.width,E.height),V=Math.round(E.width*S)+2*T,X=Math.round(E.height*S)+2*T,N=[];for(const j of O)if(j&&j.length>1){const L=[];for(const q of j){let[Y,te]=q;Y-=E.x,te-=E.y,Y*=S,te*=S,Y+=T-.5,te+=T-.5,L.push(w.asFill?[Y,te]:[Math.round(Y),Math.round(te)])}if(w.asFill){const q=L.length-1;L[0][0]===L[q][0]&&L[0][1]===L[q][1]||L.push(L[0])}N.push(L)}const k=function A(w,O,E,P){const g=O*E,T=new Array(g),S=P*P+1;for(let V=0;V<g;++V)T[V]=S;for(const V of w){const X=V.length;for(let N=1;N<X;++N){const k=V[N-1],j=V[N];let L,q,Y,te;k[0]<j[0]?(L=k[0],q=j[0]):(L=j[0],q=k[0]),k[1]<j[1]?(Y=k[1],te=j[1]):(Y=j[1],te=k[1]);let ne=Math.floor(L)-P,oe=Math.floor(q)+P,J=Math.floor(Y)-P,Q=Math.floor(te)+P;ne<0&&(ne=0),oe>O&&(oe=O),J<0&&(J=0),Q>E&&(Q=E);const Z=j[0]-k[0],pe=j[1]-k[1],_e=Z*Z+pe*pe;for(let ye=ne;ye<oe;ye++)for(let $=J;$<Q;$++){let be,Se,xe=(ye-k[0])*Z+($-k[1])*pe;xe<0?(be=k[0],Se=k[1]):xe>_e?(be=j[0],Se=j[1]):(xe/=_e,be=k[0]+xe*Z,Se=k[1]+xe*pe);const Ne=(ye-be)*(ye-be)+($-Se)*($-Se),Fe=(E-$-1)*O+ye;Ne<T[Fe]&&(T[Fe]=Ne)}}}for(let V=0;V<g;++V)T[V]=Math.sqrt(T[V]);return T}(N,V,X,T);return w.asFill&&function I(w,O,E,P,g){for(const T of w){const S=T.length;for(let V=1;V<S;++V){const X=T[V-1],N=T[V];let k,j,L,q;X[0]<N[0]?(k=X[0],j=N[0]):(k=N[0],j=X[0]),X[1]<N[1]?(L=X[1],q=N[1]):(L=N[1],q=X[1]);let Y=Math.floor(k),te=Math.floor(j)+1,ne=Math.floor(L),oe=Math.floor(q)+1;Y<P&&(Y=P),te>O-P&&(te=O-P),ne<P&&(ne=P),oe>E-P&&(oe=E-P);for(let J=ne;J<oe;++J){if(X[1]>J==N[1]>J)continue;const Q=(E-J-1)*O;for(let Z=Y;Z<te;++Z)Z<(N[0]-X[0])*(J-X[1])/(N[1]-X[1])+X[0]&&(g[Q+Z]=-g[Q+Z]);for(let Z=P;Z<Y;++Z)g[Q+Z]=-g[Q+Z]}}}}(N,V,X,T,k),[U(k,T),V,X]}function U(w,O){const E=2*O,P=w.length,g=new Uint8Array(4*P);for(let T=0;T<P;++T)(0,K.I)(.5-w[T]/E,g,4*T);return g}},26996:(lt,ze,b)=>{b.d(ze,{Y:()=>Re,m:()=>Ue});var K=b(36161),ce=b(21286),ae=b(92087);const D=G=>"vertical"===G||"horizontal"===G||"cross"===G||"esriSFSCross"===G||"esriSFSVertical"===G||"esriSFSHorizontal"===G;function Re(G,de,fe){const W=de.style,se=(0,ce.fp)(Math.ceil(fe)),A=D(W)?8*se:16*se,I=2*se;G.width=A,G.height=A;const U=G.getContext("2d");U.strokeStyle="#FFFFFF",U.lineWidth=se,U.beginPath(),"vertical"!==W&&"cross"!==W&&"esriSFSCross"!==W&&"esriSFSVertical"!==W||(U.moveTo(A/2,-I),U.lineTo(A/2,A+I)),"horizontal"!==W&&"cross"!==W&&"esriSFSCross"!==W&&"esriSFSHorizontal"!==W||(U.moveTo(-I,A/2),U.lineTo(A+I,A/2)),"backward-diagonal"!==W&&"diagonal-cross"!==W&&"esriSFSDiagonalCross"!==W&&"esriSFSBackwardDiagonal"!==W||(U.moveTo(-I,-I),U.lineTo(A+I,A+I),U.moveTo(A-I,-I),U.lineTo(A+I,I),U.moveTo(-I,A-I),U.lineTo(I,A+I)),"forward-diagonal"!==W&&"diagonal-cross"!==W&&"esriSFSForwardDiagonal"!==W&&"esriSFSDiagonalCross"!==W||(U.moveTo(A+I,-I),U.lineTo(-I,A+I),U.moveTo(I,-I),U.lineTo(-I,I),U.moveTo(A+I,A-I),U.lineTo(A-I,A+I)),U.stroke();const w=U.getImageData(0,0,G.width,G.height),O=new Uint8Array(w.data);let E;for(let P=0;P<O.length;P+=4)E=O[P+3]/255,O[P]=O[P]*E,O[P+1]=O[P+1]*E,O[P+2]=O[P+2]*E;return[O,G.width,G.height,se]}function Ue(G,de){const fe="Butt"===de,W="Square"===de,se=!fe&&!W;G.length%2==1&&(G=[...G,...G]);const A=ae.v,I=2*A;let U=0;for(const N of G)U+=N;const w=Math.round(U*A),O=new Float32Array(w*I),E=.5*A;let P=0,g=0,T=.5,S=!0;for(const N of G){for(P=g,g+=N*A;T<=g;){let k=.5;for(;k<I;){const j=(k-.5)*w+T-.5,L=se?(k-A)*(k-A):Math.abs(k-A);O[j]=S?fe?Math.max(Math.max(P+E-T,L),Math.max(T-g+E,L)):L:se?Math.min((T-P)*(T-P)+L,(T-g)*(T-g)+L):W?Math.min(Math.max(T-P,L),Math.max(g-T,L)):Math.min(Math.max(T-P+E,L),Math.max(g+E-T,L)),k++}T++}S=!S}const V=O.length,X=new Uint8Array(4*V);for(let N=0;N<V;++N){const k=(se?Math.sqrt(O[N]):O[N])/A;(0,K.I)(k,X,4*N)}return[X,w,I]}},65279:(lt,ze,b)=>{b.r(ze),b.d(ze,{GraphicContainer:()=>$r.Z,GraphicsView2D:()=>Yr.Z,LabelManager:()=>jr.Q,MagnifierView2D:()=>ri,MapViewNavigation:()=>Kr.Z,Stage:()=>Zr});var K=b(15861),ce=b(26584),ae=b(8314),D=b(62208),Re=b(50618),Ue=b(37922),G=b(2753),de=b(78260),fe=b(17002),W=b(58817),se=b(63290),A=b(23841),I=b(77275),U=b(35909),w=b(96731),O=b(7547),E=b(2648),P=b(47139),g=b(80991),T=b(73608),S=b(39351);function X(m){const e=m.markerPlacement;return e&&e.angleToLine?O.v2.MAP:O.v2.SCREEN}class N{constructor(e){this._cimLayers=[],this._poMap={},this._primitiveOverrides=[],e&&(this._resourceManager=e)}analyzeSymbolReference(e,r,i){if(this._cimLayers=i??[],!e)return this._cimLayers;if(this._reset(),e.primitiveOverrides){this._primitiveOverrides=e.primitiveOverrides;for(const s of this._primitiveOverrides){const n=s.valueExpressionInfo;if(n)this._setPoMap(s.primitiveName,s.propertyName,n);else if(null!=s.value){let a=s.value;s.propertyName.includes("Color")&&((0,de.jQ)(a)&&(a=(0,g.nn)(a)),a=(0,g.oY)(a)),this._setPoMap(s.primitiveName,s.propertyName,a)}}}return this._analyzeSymbol(e.symbol,r),this._cimLayers}_reset(){this._cimLayers=[],this._poMap={},this._primitiveOverrides=[]}_analyzeSymbol(e,r){switch(e?.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":this._analyzeMultiLayerSymbol(e,r)}}_analyzeMultiLayerSymbol(e,r){const i=e?.symbolLayers;if(!i)return;const s=e.effects;let n=O.v2.SCREEN;const a=(0,g.ap)(e)??0;"CIMPointSymbol"===e.type&&"Map"===e.angleAlignment&&(n=O.v2.MAP);const o="CIMPolygonSymbol"===e.type;let h=i.length;for(;h--;){const l=i[h];if(!l||!1===l.enable)continue;let u;s?.length&&(u=[...s]);const d=l.effects;d?.length&&(s?u.push(...d):u=[...d]);let f=null;if(u){f=[];for(const y of u){const x=E.E.findEffectOverrides(y,this._primitiveOverrides);x&&f.push(x)}}switch(E.E.findApplicableOverrides(l,this._primitiveOverrides,[]),l.type){case"CIMSolidFill":this._analyzeSolidFill(l,f);break;case"CIMPictureFill":this._analyzePictureFill(l,f);break;case"CIMHatchFill":this._analyzeHatchFill(l,f);break;case"CIMGradientFill":this._analyzeGradientFill(l,f);break;case"CIMSolidStroke":this._analyzeSolidStroke(l,f,o,a);break;case"CIMPictureStroke":this._analyzePictureStroke(l,f,o,a);break;case"CIMGradientStroke":this._analyzeGradientStroke(l,f,o,a);break;case"CIMCharacterMarker":case"CIMPictureMarker":case"CIMVectorMarker":{"CIMLineSymbol"!==e.type&&"CIMPolygonSymbol"!==e.type||(n=X(l));const y=[],x=l.primitiveName;x&&y.push(x);const v=o&&(0,g.gJ)(l.markerPlacement);this._analyzeMarker(l,f,null,y,n,a,r,[],!1,v);break}default:se.Z.getLogger("esri.symbols.cim.cimAnalyzer").error("Cannot analyze CIM layer",l.type)}}}_analyzeSolidFill(e,r){const{primitiveName:i,type:s}=e,n=(0,g.oY)(e.color);this._cimLayers.push({type:"fill",spriteRasterizationParam:null,colorLocked:!!e.colorLocked,color:this._getValueOrOverrideExpression(s,i,"Color",n),height:0,angle:0,offsetX:0,offsetY:0,scaleX:1,effects:r,applyRandomOffset:!1,sampleAlphaOnly:!0,hasUnresolvedReplacementColor:!1})}_analyzePictureFill(e,r){const{primitiveName:i,type:s}=e,n=(0,g.cO)(e),a=(0,g.NA)(e.height,w.E.CIMPictureFill.height);let o=(0,g.NA)(e.scaleX,1);if("width"in e&&"number"==typeof e.width){const l=e.width;let u=1;const d=this._resourceManager.getResource(e.url);null!=d&&(u=d.width/d.height),o/=u*(a/l)}const h={type:"sprite-rasterization-param",resource:e,overrides:this._getPrimitiveMaterialOverrides(i,s)};this._cimLayers.push({type:"fill",spriteRasterizationParam:h,colorLocked:!!e.colorLocked,effects:r,color:this._getValueOrOverrideExpression(s,i,"TintColor",n),height:this._getValueOrOverrideExpression(s,i,"Height",a),scaleX:this._getValueOrOverrideExpression(s,i,"ScaleX",o),angle:this._getValueOrOverrideExpression(s,i,"Rotation",(0,g.NA)(e.rotation)),offsetX:this._getValueOrOverrideExpression(s,i,"OffsetX",(0,g.NA)(e.offsetX)),offsetY:this._getValueOrOverrideExpression(s,i,"OffsetY",(0,g.NA)(e.offsetY)),applyRandomOffset:!1,sampleAlphaOnly:!1,hasUnresolvedReplacementColor:!1})}_analyzeHatchFill(e,r){const{primitiveName:i,type:s}=e,n=this._analyzeMaterialOverrides(i,["Rotation","OffsetX","OffsetY"]),a=this._normalizePrimitiveOverrideProps(n);let o=[255,255,255,1],h=!1;if(e.lineSymbol?.symbolLayers)for(const u of e.lineSymbol.symbolLayers){if("CIMSolidStroke"!==u.type)continue;const d=u.primitiveName??i;h||!d||u.colorLocked||null==this._poMap[d]?.Color&&null==this._poMap[d]?.StrokeColor||(o=(0,g.oY)(u.color),o=this._maybeGetValueOrOverrideExpression(d,"StrokeColor")??this._getValueOrOverrideExpression(s,d,"Color",o),h=!0);const f=this._maybeGetValueOrOverrideExpression(d,"StrokeWidth");if(f){let _=null,y=null;"number"==typeof f?_=f:y=f.valueExpressionInfo;let x=a.find(v=>"strokeWidth"===v.propertyName);x?x.propertyName="width":(x={type:"CIMPrimitiveOverride",primitiveName:d,propertyName:"width",valueExpressionInfo:y,value:_,defaultValue:(0,g.dT)(s,"width")},a.push(x))}}this._cimLayers.push({type:"fill",spriteRasterizationParam:{type:"sprite-rasterization-param",resource:e,overrides:a},colorLocked:!!e.colorLocked,effects:r,color:o,height:this._getValueOrOverrideExpression(s,i,"Separation",(0,g.NA)(e.separation,w.E.CIMHatchFill.separation)),scaleX:1,angle:this._getValueOrOverrideExpression(s,i,"Rotation",(0,g.NA)(e.rotation)),offsetX:this._getValueOrOverrideExpression(s,i,"OffsetX",(0,g.NA)(e.offsetX)),offsetY:this._getValueOrOverrideExpression(s,i,"OffsetY",(0,g.NA)(e.offsetY)),applyRandomOffset:!1,sampleAlphaOnly:!0,hasUnresolvedReplacementColor:!h})}_analyzeGradientFill(e,r){this._cimLayers.push({type:"fill",spriteRasterizationParam:null,colorLocked:!!e.colorLocked,effects:r,color:[128,128,128,1],height:0,angle:0,offsetX:0,offsetY:0,scaleX:1,applyRandomOffset:!1,sampleAlphaOnly:!1,hasUnresolvedReplacementColor:!1})}_analyzeSolidStroke(e,r,i,s){const{primitiveName:n,type:a}=e,o=(0,g.oY)(e.color),h=(0,g.NA)(e.width,w.E.CIMSolidStroke.width),l=(0,g.vn)(e.capStyle,w.E.CIMSolidStroke.capstyle),u=(0,g.vn)(e.joinStyle,w.E.CIMSolidStroke.joinstyle),d=e.miterLimit;let f,_,y=[];if(this._analyzePrimitiveOverrides(n,r,null,null)&&(y=this._getPrimitiveMaterialOverrides(n,a)),r&&r instanceof Array&&r.length>0){const v=r[r.length-1].effect;v&&"CIMGeometricEffectDashes"===v.type&&"NoConstraint"===v.lineDashEnding&&null===v.offsetAlongLine&&(f=v.dashTemplate,_=v.scaleDash,(r=[...r]).pop())}this._cimLayers.push({type:"line",spriteRasterizationParam:void 0!==f?{type:"sprite-rasterization-param",resource:{type:"dash",dashTemplate:f,capStyle:l},overrides:y}:null,isOutline:i,colorLocked:!!e.colorLocked,effects:r,color:this._getValueOrOverrideExpression(a,n,"Color",o),width:this._getValueOrOverrideExpression(a,n,"Width",h),cap:this._getValueOrOverrideExpression(a,n,"CapStyle",l),join:this._getValueOrOverrideExpression(a,n,"JoinStyle",u),miterLimit:d&&this._getValueOrOverrideExpression(a,n,"MiterLimit",d),referenceWidth:s,zOrder:k(e.name),dashTemplate:f,scaleDash:_,sampleAlphaOnly:!0})}_analyzePictureStroke(e,r,i,s){const{primitiveName:n,type:a}=e,o=(0,g.cO)(e),h=(0,g.NA)(e.width,w.E.CIMPictureStroke.width),l=(0,g.vn)(e.capStyle,w.E.CIMPictureStroke.capstyle),u=(0,g.vn)(e.joinStyle,w.E.CIMPictureStroke.joinstyle),d=e.miterLimit,f={type:"sprite-rasterization-param",resource:e,overrides:this._getPrimitiveMaterialOverrides(n,a)};this._cimLayers.push({type:"line",spriteRasterizationParam:f,isOutline:i,colorLocked:!!e.colorLocked,effects:r,color:this._getValueOrOverrideExpression(a,n,"TintColor",o),width:this._getValueOrOverrideExpression(a,n,"Width",h),cap:this._getValueOrOverrideExpression(a,n,"CapStyle",l),join:this._getValueOrOverrideExpression(a,n,"JoinStyle",u),miterLimit:d&&this._getValueOrOverrideExpression(a,n,"MiterLimit",d),referenceWidth:s,zOrder:k(e.name),dashTemplate:null,scaleDash:!1,sampleAlphaOnly:!1})}_analyzeGradientStroke(e,r,i,s){const{primitiveName:n,type:a}=e,o=(0,g.NA)(e.width,w.E.CIMSolidStroke.width),h=(0,g.vn)(e.capStyle,w.E.CIMGradientStroke.capstyle),l=(0,g.vn)(e.joinStyle,w.E.CIMGradientStroke.joinstyle),u=e.miterLimit;this._cimLayers.push({type:"line",spriteRasterizationParam:null,isOutline:i,colorLocked:!!e.colorLocked,effects:r,color:[128,128,128,1],width:this._getValueOrOverrideExpression(a,n,"Width",o),cap:this._getValueOrOverrideExpression(a,n,"CapStyle",h),join:this._getValueOrOverrideExpression(a,n,"JoinStyle",l),miterLimit:u&&this._getValueOrOverrideExpression(a,n,"MiterLimit",u),referenceWidth:s,zOrder:k(e.name),dashTemplate:null,scaleDash:!1,sampleAlphaOnly:!1})}_analyzeMarker(e,r,i,s,n,a,o,h,l=!1,u=!1){if(l||=!!e.colorLocked,this._analyzeMarkerInsidePolygon(e,r,l))return;const d=(0,g.NA)(e.size,w.E.CIMVectorMarker.size),f=(0,g.NA)(e.rotation),_=(0,g.NA)(e.offsetX),y=(0,g.NA)(e.offsetY),{primitiveName:x,type:v}=e,C=this._getValueOrOverrideExpression(v,x,"Size",d),M=this._getValueOrOverrideExpression(v,x,"Rotation",f),z=this._getValueOrOverrideExpression(v,x,"OffsetX",_),R=this._getValueOrOverrideExpression(v,x,"OffsetY",y);switch(e.type){case"CIMPictureMarker":this._analyzePictureMarker(e,r,i,s,n,a,C,M,z,R,h,l,u);break;case"CIMVectorMarker":this._analyzeVectorMarker(e,r,i,s,n,a,C,M,z,R,h,o,l,u)}}_analyzeMarkerInsidePolygon(e,r,i){const{markerPlacement:s,type:n}=e;if(!s||"CIMMarkerPlacementInsidePolygon"!==s.type)return!1;if("CIMVectorMarker"===n||"CIMPictureMarker"===n){const f=e.primitiveName;if(f&&this._analyzePrimitiveOverrides([f],r,null,null))return!1;const _=s.primitiveName;if(_&&this._analyzePrimitiveOverrides([_],r,null,null))return!1;if("CIMVectorMarker"===n){const{markerGraphics:y}=e;if(y)for(const x of y){const{symbol:v}=x;if("CIMPolygonSymbol"===v?.type&&v.symbolLayers){const{symbolLayers:C}=v;for(const M of C)if("CIMSolidStroke"===M.type)return!1}}}else{const{animatedSymbolProperties:y}=e;if(y)return!1}}const a=Math.abs(s.stepX),o=Math.abs(s.stepY);if(0===a||0===o)return!0;let h,l;if("Random"===s.gridType){const f=(0,A.Wz)(S.KA),_=Math.max(Math.floor(f/a),1);h=o*Math.max(Math.floor(f/o),1),l=_*a/h}else s.shiftOddRows?(h=2*o,l=a/o*.5):(h=o,l=a/o);const u=(0,g.cO)(e);return this._cimLayers.push({type:"fill",spriteRasterizationParam:"CIMCharacterMarker"===e.type?null:{type:"sprite-rasterization-param",resource:e,overrides:[]},colorLocked:i,effects:r,color:u,height:h,scaleX:l,angle:s.gridAngle,offsetX:(0,g.NA)(s.offsetX),offsetY:(0,g.NA)(s.offsetY),applyRandomOffset:"Random"===s.gridType,sampleAlphaOnly:"CIMPictureMarker"!==e.type,hasUnresolvedReplacementColor:!0}),!0}_analyzePictureMarker(e,r,i,s,n,a,o,h,l,u,d,f,_){const{primitiveName:y,type:x}=e;let v=(0,g.NA)(e.scaleX,1);const C=(0,g.cO)(e);i||(i=this._createMarkerPlacementOverrideExpression(e.markerPlacement));const M=this._createAnimatedSymbolPropertiesOverrideExpression(e.animatedSymbolProperties),z=e.anchorPoint??{x:0,y:0};if("width"in e&&"number"==typeof e.width){const ee=e.width;let H=1;const ie=this._resourceManager.getResource(e.url);null!=ie&&(H=ie.width/ie.height),v/=H*((0,g.NA)(e.size)/ee)}const R=[...s];let B;e.primitiveName&&R.push(e.primitiveName),e.animatedSymbolProperties||M?B={type:"animated",url:e.url,urlHash:"H"+(0,I.hP)(e.url),playAnimation:e.animatedSymbolProperties?.playAnimation,reverseAnimation:e.animatedSymbolProperties?.reverseAnimation,randomizeStartTime:e.animatedSymbolProperties?.randomizeStartTime,randomizeStartSeed:e.animatedSymbolProperties?.randomizeStartSeed,startTimeOffset:e.animatedSymbolProperties?.startTimeOffset,duration:e.animatedSymbolProperties?.duration,repeatType:e.animatedSymbolProperties?.repeatType,repeatDelay:e.animatedSymbolProperties?.repeatDelay}:(B=(0,W.d9)(e),B.markerPlacement=null);const F={type:"sprite-rasterization-param",resource:B,overrides:this._getMaterialOverrides(R,x)};M&&F.overrides.push(...M.overrides),this._cimLayers.push({type:"marker",spriteRasterizationParam:F,colorLocked:f,effects:r,scaleSymbolsProportionally:!1,alignment:n,size:o,scaleX:this._getValueOrOverrideExpression(x,y,"ScaleX",v),rotation:h,offsetX:l,offsetY:u,transform:{type:"cim-marker-transform-param",params:d},color:this._getValueOrOverrideExpression(x,y,"TintColor",C),anchorPoint:{x:z.x,y:z.y},isAbsoluteAnchorPoint:"Relative"!==e.anchorPointUnits,outlineColor:[0,0,0,0],outlineWidth:0,frameHeight:0,widthRatio:1,rotateClockwise:!!e.rotateClockwise,referenceSize:a,sizeRatio:1,isOutline:_,markerPlacement:i,animatedSymbolProperties:M})}_analyzeVectorMarker(e,r,i,s,n,a,o,h,l,u,d,f,_,y){const x=e.markerGraphics;if(!x)return;const v=e.frame;let C=0;if(C=v?v.ymax-v.ymin:a,C){const M={offsetX:l,offsetY:u,rotation:h,size:o,frameHeight:C,rotateClockWise:!!e.rotateClockwise};d=[...d,M]}i||(i=this._createMarkerPlacementOverrideExpression(e.markerPlacement));for(const M of x)if(M){const z=M.symbol;if(!z)continue;const R=M.primitiveName;let B;if(R&&s.push(R),("CIMPointSymbol"===z.type||"CIMTextSymbol"===z.type)&&v){let F=0,ee=0;const H=M.geometry;"x"in H&&"y"in H&&(F+=H.x-.5*(v.xmin+v.xmax),ee+=H.y-.5*(v.ymin+v.ymax));const ie=e.anchorPoint;ie&&("Absolute"===e.anchorPointUnits?(F-=ie.x,ee-=ie.y):v&&(F-=(v.xmax-v.xmin)*ie.x,ee-=(v.ymax-v.ymin)*ie.y));const we={offsetX:F,offsetY:ee,rotation:0,size:0,frameHeight:0,rotateClockWise:!1};B=[...d,we]}switch(z.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":f||q(z)?this._analyzeMultiLayerGraphicNonSDF(e,r,i,null,M,s,n,a,B??d,C,_,y):this._analyzeMultiLayerGraphic(e,r,i,null,M,s,n,a,B??d,C,_,y);break;case"CIMTextSymbol":this._analyzeTextGraphic(r,i,M,s,n,a,B??d,_)}R&&s.pop()}}_analyzeMultiLayerGraphic(e,r,i,s,n,a,o,h,l,u,d,f){const _=n.symbol,y=_.symbolLayers;if(!y)return;let x=y.length;if(L(y))return void this._analyzeCompositeMarkerGraphic(e,r,i,s,n,y,o,h,l,u,d,f);const v=this._resourceManager.geometryEngine,C=T.j.applyEffects(_.effects,n.geometry,v);if(C)for(;x--;){const M=y[x];if(!M||!1===M.enable)continue;const z=M.primitiveName;switch(z&&a.push(z),M.type){case"CIMSolidFill":case"CIMSolidStroke":{const R=T.j.applyEffects(M.effects,C,v),B=(0,P.bk)(R);if(!B)continue;const F="Relative"!==e.anchorPointUnits,[ee,H,ie,we]=(0,P.UV)(B,e.frame,e.size,e.anchorPoint,F),ue="CIMSolidFill"===M.type,Be={type:"sdf",geom:R,asFill:ue},{path:Oe}=M,Ae=ue?(0,g.oY)((0,g.W7)(M)):null==Oe?(0,g.oY)((0,g.$Z)(M)):[0,0,0,0],Ie=ue?[0,0,0,0]:(0,g.oY)((0,g.$Z)(M)),He=(0,g.F)(M)??0;if(!ue&&!He)break;const ke=n.primitiveName;let Je=null;ue&&!M.colorLocked&&(Je=this._maybeGetValueOrOverrideExpression(ke,"FillColor"));let We=null;ue||M.colorLocked||(We=this._maybeGetValueOrOverrideExpression(ke,"StrokeColor"));const ot=Je??this._getValueOrOverrideExpression(M.type,z,"Color",Ae),Te=We??this._getValueOrOverrideExpression(M.type,z,"Color",Ie),Qe=this._maybeGetValueOrOverrideExpression(ke,"StrokeWidth")??this._getValueOrOverrideExpression(M.type,z,"Width",He);this._cimLayers.push({type:"marker",spriteRasterizationParam:Oe?{type:"sprite-rasterization-param",resource:{type:"path",path:Oe,asFill:ue},overrides:[]}:{type:"sprite-rasterization-param",resource:Be,overrides:[]},colorLocked:!!M.colorLocked||!!d,effects:r,scaleSymbolsProportionally:!!e.scaleSymbolsProportionally,alignment:o,anchorPoint:{x:H,y:ie},isAbsoluteAnchorPoint:F,size:u,rotation:0,offsetX:0,offsetY:0,scaleX:1,transform:{type:"cim-marker-transform-param",params:l},frameHeight:u,widthRatio:we,rotateClockwise:!1,referenceSize:h,sizeRatio:ee,color:ot,outlineColor:Te,outlineWidth:Qe,isOutline:f,markerPlacement:i,animatedSymbolProperties:s});break}case"CIMPictureMarker":case"CIMVectorMarker":M.markerPlacement?this._analyzeMultiLayerGraphicNonSDF(e,r,i,s,n,a,o,h,l,u,!!M.colorLocked||!!d,f):this._analyzeMarker(M,r,i,a,o,h,!1,l,d,f);break;default:this._analyzeMultiLayerGraphicNonSDF(e,r,i,s,n,a,o,h,l,u,!!M.colorLocked||!!d,f)}z&&a.pop()}}_analyzeTextGraphic(e,r,i,s,n,a,o,h){E.E.findApplicableOverrides(i,this._primitiveOverrides,[]);const u=i.geometry;if(!("x"in u)||!("y"in u))return;const d=i.symbol,f=(0,g.BX)(d),_=(0,g.wi)(d.fontStyleName),y=(0,fe.BN)(d.fontFamilyName);d.font={family:y,decoration:f,..._};const x=(0,g.NA)(d.height,w.E.CIMTextSymbol.height),v=(0,g.NA)(d.angle),C=(0,g.NA)(d.offsetX),M=(0,g.NA)(d.offsetY),z=(0,g.oY)((0,g.W7)(d));let R=(0,g.oY)((0,g.$Z)(d)),B=(0,g.F)(d)??0;B||(R=(0,g.oY)((0,g.W7)(d.haloSymbol)),B=(0,g.NA)(d.haloSize));let F=!1;if(d.symbol?.symbolLayers)for(const Te of d.symbol.symbolLayers)null!=(0,g.oY)((0,g.W7)(Te))&&(F=!!Te.colorLocked);const ee=i.primitiveName;let H=null;F||(H=this._maybeGetValueOrOverrideExpression(ee,"FillColor"));const ie=this._maybeGetValueOrOverrideExpression(ee,"TextSize"),we=this._maybeGetValueOrOverrideExpression(ee,"TextAngle"),ue=this._maybeGetValueOrOverrideExpression(ee,"TextOffsetX"),Be=this._maybeGetValueOrOverrideExpression(ee,"TextOffsetY");let Oe=null,Ae=null,Ie=0;if(d.callout&&"CIMBackgroundCallout"===d.callout.type){const Te=d.callout;if(Te.backgroundSymbol){const Qe=Te.backgroundSymbol.symbolLayers;if(Qe)for(const Ce of Qe)"CIMSolidFill"===Ce.type?Oe=(0,g.oY)(Ce.color):"CIMSolidStroke"===Ce.type&&(Ae=(0,g.oY)(Ce.color),Ie=(0,g.NA)(Ce.width,w.E.CIMSolidStroke.width))}}const He=this._getValueOrOverrideExpression(d.type,i.primitiveName,"TextString",i.textString??"");if(null==He)return;const{fontStyleName:ke}=d,Je=y+(ke?"-"+ke.toLowerCase():"-regular"),We=this._getMaterialOverrides(s,d.type);We.push(...this._getPrimitiveMaterialOverrides(i.primitiveName,d.type)),this._cimLayers.push({type:"text",lineWidth:null,textRasterizationParam:{type:"text-rasterization-param",resource:{type:"text",textString:i.textString??"",font:d.font,symbol:d,primitiveName:i.primitiveName},overrides:We},colorLocked:!!h||!!F,effects:e,alignment:n,anchorPoint:{x:0,y:0},isAbsoluteAnchorPoint:!1,fontName:Je,decoration:f,weight:_.weight,style:_.style,size:ie??x,angle:we??v,offsetX:ue??C,offsetY:Be??M,transform:{type:"cim-marker-transform-param",params:o},horizontalAlignment:(0,g.X_)(d.horizontalAlignment),verticalAlignment:(0,g.FG)(d.verticalAlignment),text:He,color:H??this._getValueOrOverrideExpression(d.type,i.primitiveName,"Color",z),outlineColor:R,outlineSize:B,backgroundColor:Oe,borderLineColor:Ae,borderLineWidth:Ie,referenceSize:a,sizeRatio:1,markerPlacement:r})}_analyzeMultiLayerGraphicNonSDF(e,r,i,s,n,a,o,h,l,u,d,f){const _=this._buildSimpleMarker(e,n),x=this._analyzeMaterialOverrides(e.primitiveName,["Rotation","OffsetX","OffsetY"]),v=this._normalizePrimitiveOverrideProps(x),[C,M,z]=U.B$.getTextureAnchor(_,this._resourceManager),R=this._getMaterialOverrides(a,e.type);R.push(...v);const B={type:"sprite-rasterization-param",resource:{..._,avoidSDFRasterization:!0},overrides:R};this._cimLayers.push({type:"marker",spriteRasterizationParam:B,colorLocked:d,effects:r,scaleSymbolsProportionally:!!e.scaleSymbolsProportionally,alignment:o,anchorPoint:{x:C,y:M},isAbsoluteAnchorPoint:!1,size:u,rotation:0,offsetX:0,offsetY:0,transform:{type:"cim-marker-transform-param",params:l},color:[255,255,255,1],outlineColor:[0,0,0,0],outlineWidth:0,scaleX:1,frameHeight:u,widthRatio:1,rotateClockwise:!!e.rotateClockwise,referenceSize:h,sizeRatio:z/(0,A.F2)(e.size),isOutline:f,markerPlacement:i,animatedSymbolProperties:s})}_createMarkerPlacementOverrideExpression(e){if(!e)return null;const r=[];return E.E.findApplicableOverrides(e,this._primitiveOverrides,r),{type:"cim-marker-placement-info",placement:e,overrides:Y(r)}}_createAnimatedSymbolPropertiesOverrideExpression(e){if(!e)return null;const r=[];return E.E.findApplicableOverrides(e,this._primitiveOverrides,r),{type:"cim-animation-info",animation:e,overrides:Y(r)}}_buildSimpleMarker(e,r){return{type:e.type,enable:!0,name:e.name,colorLocked:e.colorLocked,primitiveName:e.primitiveName,anchorPoint:e.anchorPoint,anchorPointUnits:e.anchorPointUnits,offsetX:0,offsetY:0,rotateClockwise:e.rotateClockwise,rotation:0,size:e.size,billboardMode3D:e.billboardMode3D,depth3D:e.depth3D,frame:e.frame,markerGraphics:[r],scaleSymbolsProportionally:e.scaleSymbolsProportionally,respectFrame:e.respectFrame,clippingPath:e.clippingPath}}_analyzeCompositeMarkerGraphic(e,r,i,s,n,a,o,h,l,u,d,f){const _=n.geometry,y=a[0],x=a[1],v=(0,P.bk)(_);if(!v)return;const C="Relative"!==e.anchorPointUnits,[M,z,R,B]=(0,P.UV)(v,e.frame,e.size,e.anchorPoint,C),{path:F}=x,ee=x.primitiveName,H=y.primitiveName,ie=n.primitiveName;let we=null;x.colorLocked||d||(we=this._maybeGetValueOrOverrideExpression(ie,"FillColor"));const ue=we??this._getValueOrOverrideExpression(x.type,ee,"Color",(0,g.oY)(x.color));let Be=null;y.colorLocked||d||(Be=this._maybeGetValueOrOverrideExpression(ie,"StrokeColor"));const Oe=Be??this._getValueOrOverrideExpression(y.type,H,"Color",(0,g.oY)(y.color)),Ae=this._maybeGetValueOrOverrideExpression(ie,"StrokeWidth")??this._getValueOrOverrideExpression(y.type,H,"Width",(0,g.NA)(y.width,w.E.CIMSolidStroke.width));this._cimLayers.push({type:"marker",spriteRasterizationParam:{type:"sprite-rasterization-param",resource:F?{type:"path",path:F,asFill:!0}:{type:"sdf",geom:_,asFill:!0},overrides:[]},colorLocked:d,effects:r,scaleSymbolsProportionally:!!e.scaleSymbolsProportionally,alignment:o,anchorPoint:{x:z,y:R},isAbsoluteAnchorPoint:C,size:u,rotation:0,offsetX:0,offsetY:0,scaleX:1,transform:{type:"cim-marker-transform-param",params:l},frameHeight:u,widthRatio:B,rotateClockwise:!1,referenceSize:h,sizeRatio:M,color:ue,outlineColor:Oe,outlineWidth:Ae,isOutline:f,markerPlacement:i,animatedSymbolProperties:s})}_setPoMap(e,r,i){let s;this._poMap[e]?s=this._poMap[e]:(s={},this._poMap[e]=s),s[r]=i}_maybeGetValueOrOverrideExpression(e,r,i){return this._getValueOrOverrideExpression("",e,r,i,!1)}_getValueOrOverrideExpression(e,r,i,s,n=!0){if(n&&!(0,g.Mk)(s)&&(s=(0,g.dT)(e,i.toLowerCase())),null==r)return s;const a=this._poMap[r];if(null==a)return s;const o=a[i];return"string"==typeof o||"number"==typeof o||Array.isArray(o)?o:o?{valueExpressionInfo:o,defaultValue:s}:s}_analyzePrimitiveOverrides(e,r,i,s){if(null==e)return!1;"string"==typeof e&&(e=[e]);for(const n of this._primitiveOverrides)if(e.includes(n.primitiveName)&&n.valueExpressionInfo)return!0;if(null!=r)for(const n of r)if(n?.overrides.length>0)return!0;if(null!=i)for(const n of i)if(n?.overrides.length>0)return!0;if(null!=s)for(const n of s)if(n?.overrides.length>0)return!0;return!1}_getMaterialOverrides(e,r){if(!e)return[];const i=[];for(const s of e)i.push(...this._getPrimitiveMaterialOverrides(s,r));return i}_getPrimitiveMaterialOverrides(e,r){if(!e)return[];const i=this._normalizePrimitiveOverrideProps(this._primitiveOverrides.filter(s=>s.primitiveName===e));return i.forEach(s=>s.defaultValue=(0,g.dT)(r,s.propertyName.toLowerCase())),i}_analyzeMaterialOverrides(e,r){return this._primitiveOverrides.filter(i=>i.primitiveName!==e||!r.includes(i.propertyName))}_normalizePrimitiveOverrideProps(e){return e.map(r=>({...r,propertyName:(0,g.Le)(r.propertyName)}))}}function k(m){if(m&&0===m.indexOf("Level_")){const e=parseInt(m.substr(6),10);if(!isNaN(e))return e}return 0}const L=m=>m&&2===m.length&&m[0].enable&&m[1].enable&&"CIMSolidStroke"===m[0].type&&"CIMSolidFill"===m[1].type&&null==m[0].path&&null==m[1].path&&!m[0].effects&&!m[1].effects;function q(m){const e=m.symbolLayers;if(!e||2!==e.length)return!1;const r=e.find(s=>s.effects?.find(n=>"CIMGeometricEffectDashes"===n.type&&null!=n.dashTemplate)),i=e.find(s=>s.effects?.find(n=>"CIMGeometricEffectAddControlPoints"===n.type));return!!r||!!i}function Y(m){return(0,W.d9)(m).map(e=>({...e,propertyName:(0,g.Le)(e.propertyName)}))}var te=b(1011),ne=b(61885),oe=b(17770),J=b(54024),Q=b(21286),Z=b(50047),pe=b(58704),_e=b(80738);class ye{constructor(e){this.events=new ne.Z,this._hasMajorPerformanceCaveat=!1,this._lastRenderFrameCounter=0,this._canvas=document.createElement("canvas"),this._canvas.setAttribute("style","width: 100%; height:100%; display:block; willChange:transform");const r={failIfMajorPerformanceCaveat:!0,alpha:!0,antialias:!1,depth:!0,stencil:!0};e.appendChild(this._canvas);let i=(0,_e.k)(this._canvas,r);i||(i=(0,_e.k)(this._canvas,{...r,failIfMajorPerformanceCaveat:!1}),this._hasMajorPerformanceCaveat=!0),this._gl=i,this._handles=(0,J.AL)([(0,oe.on)(this._canvas,"webglcontextlost",s=>this.events.emit("webgl-context-lost",s))])}destroy(){this._canvas.parentNode?.removeChild(this._canvas),this._canvas=null,this._handles.remove(),this._gl=null}get gl(){return this._gl}render(e,r){if(this._hasMajorPerformanceCaveat||(0,ae.Z)("esri-force-performance-mode")){if(++this._lastRenderFrameCounter>=(0,ae.Z)("esri-performance-mode-frames-between-render")&&(r(),this._lastRenderViewState=e.state.clone(),this._lastRenderFrameCounter=0),this._lastRenderViewState){const[i,s,n,a,o,h]=this._computeViewTransform(this._lastRenderViewState,e.state);this._canvas.style.transform=`matrix(${i}, ${s}, ${n}, ${a}, ${o}, ${h})`}}else r()}resize(e){const r=this._canvas,i=r.style,{state:{size:s},pixelRatio:n}=e,a=s[0],o=s[1],h=Math.round(a*n),l=Math.round(o*n);r.width===h&&r.height===l||(r.width=h,r.height=l),i.width=a+"px",i.height=o+"px"}_computeViewTransform(e,r){const[i,s]=e.center,[n,a]=r.center,[o,h]=e.toScreen([0,0],n,a),[l,u]=e.toScreen([0,0],i,s),d=l-o,f=u-h,_=e.scale/r.scale,y=r.rotation-e.rotation,x=(0,pe.Ue)();return(0,Z.yR)(x),(0,Z.bA)(x,x,[_,_]),(0,Z.U1)(x,x,(0,Q.Vl)(y)),(0,Z.Iu)(x,x,[d,f]),x}}var $=b(39406),be=b(41738),Se=b(68447),xe=b(93292),Ne=b(35903),Fe=b(83994),p=b(67969),Xe=b(94299),qe=b(49353);class ht{constructor(){this._initialized=!1}dispose(){this._program=(0,D.M2)(this._program),this._vertexArrayObject=(0,D.M2)(this._vertexArrayObject)}render(e,r,i,s){e&&(this._initialized||this._initialize(e),e.setBlendFunctionSeparate(p.zi.ONE,p.zi.ONE_MINUS_SRC_ALPHA,p.zi.ONE,p.zi.ONE_MINUS_SRC_ALPHA),e.bindVAO(this._vertexArrayObject),e.useProgram(this._program),r.setSamplingMode(i),e.bindTexture(r,0),this._program.setUniform1i("u_tex",0),this._program.setUniform1f("u_opacity",s),e.drawArrays(p.MX.TRIANGLE_STRIP,0,4),e.bindTexture(null,0),e.bindVAO())}_initialize(e){if(this._initialized)return!0;const r=(0,Xe.H)(e,Ne.Q);if(!r)return!1;const i=new Int8Array(16);i[0]=-1,i[1]=-1,i[2]=0,i[3]=0,i[4]=1,i[5]=-1,i[6]=1,i[7]=0,i[8]=-1,i[9]=1,i[10]=0,i[11]=1,i[12]=1,i[13]=1,i[14]=1,i[15]=1;const n=new qe.U(e,Ne.Q.attributes,xe.As,{geometry:Fe.f.createVertex(e,p.l1.STATIC_DRAW,i)});return this._program=r,this._vertexArrayObject=n,this._initialized=!0,!0}}var Tt=b(86859);class Ct{constructor(e){this._rctx=e,this._programByKey=new Map}dispose(){this._programByKey.forEach(e=>e.dispose()),this._programByKey.clear()}getProgram(e,r=[]){const i=e.vsPath+"."+e.fsPath+JSON.stringify(r);if(this._programByKey.has(i))return this._programByKey.get(i);const s={...r.map(u=>"string"==typeof u?{name:u,value:!0}:u).reduce((u,d)=>({...u,[d.name]:d.value}),{})},{vsPath:n,fsPath:a,attributes:o}=e,h=(0,Tt.s)(n,a,o,s),l=this._rctx.programCache.acquire(h.shaders.vertexShader,h.shaders.fragmentShader,h.attributes);if(!l)throw new Error("Unable to get program for key: ${key}");return this._programByKey.set(i,l),l}}var zt=b(59318),Le=b(84792),Rt=b(986),me=b(10699),Ft=b(57052),ct=b(26996),Bt=b(31375);class It{constructor(e){this._resourceManager=e,this._cachedRasterizationCanvas=null}dispose(){this._cachedRasterizationCanvas=null}get _canvas(){return this._cachedRasterizationCanvas||(this._cachedRasterizationCanvas=document.createElement("canvas")),this._cachedRasterizationCanvas}rasterizeJSONResource(e,r){switch(e.type){case"dash":{const i=e.dashTemplate,s=e.capStyle,[n,a,o]=(0,ct.m)(i,s);return{size:[a,o],image:new Uint32Array(n.buffer),sdf:!0,simplePattern:!0,anchorX:0,anchorY:0}}case"fill-style":{const[i,s,n,a]=(0,ct.Y)(this._canvas,e,r);return{size:[s,n],image:new Uint32Array(i.buffer),sdf:!1,simplePattern:!0,anchorX:0,anchorY:0,rasterizationScale:a}}case"sdf":return this._rasterizeSDFInfo(e);case"CIMHatchFill":case"CIMVectorMarker":case"CIMPictureMarker":return this._rasterizeCIMJSONResource(e,r)}}_rasterizeCIMJSONResource(e,r){switch(e.type){case"CIMHatchFill":{const i=U.B$.fromCIMHatchFill(e,r);return this._rasterizeCIMVectorMarker(i)}case"CIMPictureMarker":{const i=U.B$.fromCIMInsidePolygon(e);return this._rasterizeCIMVectorMarker(i)}case"CIMVectorMarker":{if("CIMMarkerPlacementInsidePolygon"===e.markerPlacement?.type){const s=U.B$.fromCIMInsidePolygon(e);return this._rasterizeCIMVectorMarker(s)}const i=(0,P.Fp)(e);return i&&!e.avoidSDFRasterization?this._rasterizeSDFInfo(i):this._rasterizeCIMVectorMarker(e,!1)}}}_rasterizeSDFInfo(e){if(!e)return null;const[r,i,s]=(0,P.RL)(e);return r?{size:[i,s],image:new Uint32Array(r.buffer),sdf:!0,simplePattern:!0,anchorX:0,anchorY:0}:null}_rasterizeCIMVectorMarker(e,r=!0){const i=r?Bt.Z.fromExtent(e.frame):null,[s,n,a,o,h]=U.B$.rasterize(this._canvas,e,i,this._resourceManager);return s?{size:[n,a],image:new Uint32Array(s.buffer),sdf:!1,simplePattern:!1,anchorX:o,anchorY:h}:null}rasterizeImageResource(e,r,i,s){this._canvas.width=e,this._canvas.height=r;const n=this._canvas.getContext("2d",{willReadFrequently:!0});i instanceof ImageData?n.putImageData(i,0,0):(i.setAttribute("width",`${e}px`),i.setAttribute("height",`${r}px`),n.drawImage(i,0,0,e,r));const a=n.getImageData(0,0,e,r),o=new Uint8Array(a.data);if(s)for(const _ of s)if(_&&_.oldColor&&4===_.oldColor.length&&_.newColor&&4===_.newColor.length){const[y,x,v,C]=_.oldColor,[M,z,R,B]=_.newColor;if(y===M&&x===z&&v===R&&C===B)continue;for(let F=0;F<o.length;F+=4)y===o[F]&&x===o[F+1]&&v===o[F+2]&&C===o[F+3]&&(o[F]=M,o[F+1]=z,o[F+2]=R,o[F+3]=B)}let h;for(let _=0;_<o.length;_+=4)h=o[_+3]/255,o[_]=o[_]*h,o[_+1]=o[_+1]*h,o[_+2]=o[_+2]*h;let l=o,u=e,d=r;const f=512;if(u>=f||d>=f){const _=u/d;_>1?(u=f,d=Math.round(f/_)):(d=f,u=Math.round(f*_)),l=new Uint8Array(4*u*d);const y=new Uint8ClampedArray(l.buffer);(0,g.TT)(o,e,r,y,u,d,!1)}return{size:[u,d],image:new Uint32Array(l.buffer),sdf:!1,simplePattern:!1,anchorX:0,anchorY:0}}}var le=b(84439);class Ze{constructor(e,r){this._width=0,this._height=0,this._free=[],this._width=e,this._height=r,this._free.push(new le.Z(0,0,e,r))}get width(){return this._width}get height(){return this._height}allocate(e,r){if(e>this._width||r>this._height)return new le.Z;let i=null,s=-1;for(let n=0;n<this._free.length;++n){const a=this._free[n];e<=a.width&&r<=a.height&&(null===i||a.y<=i.y&&a.x<=i.x)&&(i=a,s=n)}return null===i?new le.Z:(this._free.splice(s,1),i.width<i.height?(i.width>e&&this._free.push(new le.Z(i.x+e,i.y,i.width-e,r)),i.height>r&&this._free.push(new le.Z(i.x,i.y+r,i.width,i.height-r))):(i.width>e&&this._free.push(new le.Z(i.x+e,i.y,i.width-e,i.height)),i.height>r&&this._free.push(new le.Z(i.x,i.y+r,e,i.height-r))),new le.Z(i.x,i.y,e,r))}release(e){for(let r=0;r<this._free.length;++r){const i=this._free[r];if(i.y===e.y&&i.height===e.height&&i.x+i.width===e.x)i.width+=e.width;else if(i.x===e.x&&i.width===e.width&&i.y+i.height===e.y)i.height+=e.height;else if(e.y===i.y&&e.height===i.height&&e.x+e.width===i.x)i.x=e.x,i.width+=e.width;else{if(e.x!==i.x||e.width!==i.width||e.y+e.height!==i.y)continue;i.y=e.y,i.height+=e.height}this._free.splice(r,1),this.release(e)}this._free.push(e)}}var ge=b(18952),re=b(31548);const Ut=m=>Math.floor(m/256);class Vt{constructor(e,r,i){this.width=0,this.height=0,this._dirties=[],this._glyphData=[],this._currentPage=0,this._glyphCache={},this._textures=[],this._rangePromises=new Map,this._preloadCache={},this.width=e,this.height=r,this._glyphSource=i,this._binPack=new Ze(e-4,r-4),this._glyphData.push(new Uint8Array(e*r)),this._dirties.push(!0),this._textures.push(null),this._initDecorationGlyphs()}dispose(){this._binPack=null;for(const e of this._textures)e&&e.dispose();this._textures.length=0,this._glyphData.length=0}_initDecorationGlyphs(){const e=[117,149,181,207,207,181,149,117],r=[],i=[];for(let a=0;a<e.length;a++){const o=e[a];for(let h=0;h<11;h++){const l=a>=3&&a<5&&h>=3&&h<8?255:0;r.push(o),i.push(l)}}const s={metrics:{width:5,height:2,left:0,top:0,advance:0},bitmap:new Uint8Array(r)},n={metrics:{width:5,height:2,left:0,top:0,advance:0},bitmap:new Uint8Array(i)};this._recordGlyph(s),this._recordGlyph(n)}getTexture(e,r){if(!this._textures[r]){const i=new re.X;i.pixelFormat=p.VI.ALPHA,i.wrapMode=p.e8.CLAMP_TO_EDGE,i.width=this.width,i.height=this.height,this._textures[r]=new ge.x(e,i,new Uint8Array(this.width*this.height))}return this._dirties[r]&&(this._textures[r].setData(this._glyphData[r]),this._dirties[r]=!1),this._textures[r]}getGlyphItems(e,r,i){var s=this;return(0,K.Z)(function*(){const n=s._getGlyphCache(e);return yield s._fetchRanges(e,r,i),r.map(a=>s._getMosaicItem(n,e,a))})()}bind(e,r,i,s){const n=this.getTexture(e,i);n.setSamplingMode(r),e.bindTexture(n,s)}preloadASCIIGlyphCache(e){const r=this._preloadCache[e];if(null!=r)return r;const i=this._glyphSource.preloadASCIIRange(e).then(()=>{const s=this._getGlyphCache(e);for(let n=0;n<256;n++)this._getMosaicItem(s,e,n)});return this._preloadCache[e]=i,i}_getGlyphCache(e){return this._glyphCache[e]||(this._glyphCache[e]={}),this._glyphCache[e]}_invalidate(){this._dirties[this._currentPage]=!0}_fetchRanges(e,r,i){var s=this;return(0,K.Z)(function*(){const n=function Nt(m){const e=new Set;for(const r of m)e.add(Ut(r));return e}(r),a=[];n.forEach(o=>{a.push(s._fetchRange(e,o,i))}),yield Promise.all(a)})()}_fetchRange(e,r,i){var s=this;return(0,K.Z)(function*(){if(!(r>256))return function Lt(m,e,r){return m.has(e)||m.set(e,r().then(()=>{m.delete(e)}).catch(i=>{m.delete(e),(0,me.H9)(i)})),m.get(e)}(s._rangePromises,e+r,()=>s._glyphSource.getRange(e,r,i))})()}_getMosaicItem(e,r,i){if(!e[i]){const s=this._glyphSource.getGlyph(r,i);if(!s?.metrics)return m=i,{rect:new le.Z(0,0,0,0),page:0,metrics:{left:0,width:0,height:0,advance:0,top:0},code:m,sdf:!0};const n=this._recordGlyph(s);e[i]={rect:n,page:this._currentPage,metrics:s.metrics,code:i,sdf:!0},this._invalidate()}var m;return e[i]}_recordGlyph(e){const r=e.metrics;let i;if(0===r.width)i=new le.Z(0,0,0,0);else{const n=r.width+6,a=r.height+6;i=this._binPack.allocate(n,a),i.isEmpty&&(this._dirties[this._currentPage]||(this._glyphData[this._currentPage]=null),this._currentPage=this._glyphData.length,this._glyphData.push(new Uint8Array(this.width*this.height)),this._dirties.push(!0),this._textures.push(null),this._initDecorationGlyphs(),this._binPack=new Ze(this.width-4,this.height-4),i=this._binPack.allocate(n,a));const o=this._glyphData[this._currentPage],h=e.bitmap;let l,u;if(h)for(let d=0;d<a;d++){l=n*d,u=this.width*(i.y+d)+i.x;for(let f=0;f<n;f++)o[u+f]=h[l+f]}(0,ae.Z)("esri-glyph-debug")&&this._showDebugPage(o)}return i}_showDebugPage(e){const r=document.createElement("canvas"),i=r.getContext("2d"),s=new ImageData(this.width,this.height),n=s.data;r.width=this.width,r.height=this.height,r.style.border="1px solid black";for(let a=0;a<e.length;++a)n[4*a]=e[a],n[4*a+1]=0,n[4*a+2]=0,n[4*a+3]=255;i.putImageData(s,0,0),document.body.appendChild(r)}}var ut=b(24192);class dt{constructor(e){for(this._metrics=[],this._bitmaps=[];e.next();)switch(e.tag()){case 1:{const r=e.getMessage();for(;r.next();)switch(r.tag()){case 3:{const i=r.getMessage();let s,n,a,o,h,l,u;for(;i.next();)switch(i.tag()){case 1:s=i.getUInt32();break;case 2:n=i.getBytes();break;case 3:a=i.getUInt32();break;case 4:o=i.getUInt32();break;case 5:h=i.getSInt32();break;case 6:l=i.getSInt32();break;case 7:u=i.getUInt32();break;default:i.skip()}i.release(),s&&(this._metrics[s]={width:a,height:o,left:h,top:l,advance:u},this._bitmaps[s]=n);break}default:r.skip()}r.release();break}default:e.skip()}}getMetrics(e){return this._metrics[e]}getBitmap(e){return this._bitmaps[e]}}class Gt{constructor(){this._ranges=[]}getRange(e){return this._ranges[e]}addRange(e,r){this._ranges[e]=r}}class Ht{constructor(e){this._glyphInfo={},this._baseURL=e}getRange(e,r,i){const s=this._getFontStack(e);if(s.getRange(r))return Promise.resolve();const n=256*r,a=n+255,o=this._baseURL.replace("{fontstack}",e).replace("{range}",n+"-"+a);return(0,Le.Z)(o,{responseType:"array-buffer",...i}).then(h=>{s.addRange(r,new dt(new ut.Z(new Uint8Array(h.data),new DataView(h.data))))})}preloadASCIIRange(e){var r=this;return(0,K.Z)(function*(){const i=r._getFontStack(e),a=r._baseURL.replace("{fontstack}",e).replace("{range}","0-255"),o=yield(0,Le.Z)(a,{responseType:"array-buffer"}),h=new dt(new ut.Z(new Uint8Array(o.data),new DataView(o.data)));for(let l=0;l<=255;l++)i.getRange(l)||i.addRange(l,h)})()}getGlyph(e,r){const i=this._getFontStack(e);if(!i)return;const s=Math.floor(r/256),n=i.getRange(s);return n?{metrics:n.getMetrics(r),bitmap:n.getBitmap(r)}:void 0}_getFontStack(e){let r=this._glyphInfo[e];return r||(r=this._glyphInfo[e]=new Gt),r}}var Wt=b(36161);const De=1e20;class Xt{constructor(e){this._svg=null,this.size=e;const r=document.createElement("canvas");r.width=r.height=e,this._context=r.getContext("2d",{willReadFrequently:!1}),this._gridOuter=new Float64Array(e*e),this._gridInner=new Float64Array(e*e),this._f=new Float64Array(e),this._d=new Float64Array(e),this._z=new Float64Array(e+1),this._v=new Int16Array(e)}dispose(){this._context=this._gridOuter=this._gridInner=this._f=this._d=this._z=this._v=null,this._svg&&(document.body.removeChild(this._svg),this._svg=null)}draw(e,r,i,s=31){this._initSVG();const n=this.createSVGString(e,r);return new Promise((a,o)=>{const h=new Image;h.src="data:image/svg+xml; charset=utf8, "+encodeURIComponent(n),h.onload=()=>{h.onload=null,this._context.clearRect(0,0,this.size,this.size),this._context.drawImage(h,0,0,this.size,this.size);const u=this._context.getImageData(0,0,this.size,this.size),d=new Uint8Array(this.size*this.size*4);for(let f=0;f<this.size*this.size;f++){const _=u.data[4*f+3]/255;this._gridOuter[f]=1===_?0:0===_?De:Math.max(0,.5-_)**2,this._gridInner[f]=1===_?De:0===_?0:Math.max(0,_-.5)**2}this._edt(this._gridOuter,this.size,this.size),this._edt(this._gridInner,this.size,this.size);for(let f=0;f<this.size*this.size;f++)(0,Wt.I)(.5-(this._gridOuter[f]-this._gridInner[f])/(2*s),d,4*f);a(d)};const l=i?.signal;l&&(0,me.fu)(l,()=>o((0,me.zE)()))})}_initSVG(){if(!this._svg){const e=document.createElementNS("http://www.w3.org/2000/svg","svg");e.setAttribute("style","position: absolute;"),e.setAttribute("width","0"),e.setAttribute("height","0"),e.setAttribute("aria-hidden","true"),e.setAttribute("role","presentation"),document.body.appendChild(e),this._svg=e}return this._svg}createSVGString(e,r){const i=this._initSVG(),s=document.createElementNS("http://www.w3.org/2000/svg","path");s.setAttribute("d",e),i.appendChild(s);const n=s.getBBox(),a=n.width/n.height,o=this.size/2;let h,l,u;a>1?(h=o/n.width,l=this.size/4,u=o-o*(1/a)/2):(h=o/n.height,l=o-o*a/2,u=this.size/4),s.setAttribute("style",`transform: matrix(${h}, 0, 0, ${h}, ${-n.x*h+l}, ${-n.y*h+u})`),s.setAttribute("stroke-width",""+.5/h);const _=`<svg style="fill:${r?"red":"none"}; stroke:${r?"none":"red"}" height="${this.size}" width="${this.size}" xmlns="http://www.w3.org/2000/svg">${i.innerHTML}</svg>`;return i.removeChild(s),_}_edt(e,r,i){const s=this._f,n=this._d,a=this._v,o=this._z;for(let h=0;h<r;h++){for(let l=0;l<i;l++)s[l]=e[l*r+h];this._edt1d(s,n,a,o,i);for(let l=0;l<i;l++)e[l*r+h]=n[l]}for(let h=0;h<i;h++){for(let l=0;l<r;l++)s[l]=e[h*r+l];this._edt1d(s,n,a,o,r);for(let l=0;l<r;l++)e[h*r+l]=Math.sqrt(n[l])}}_edt1d(e,r,i,s,n){i[0]=0,s[0]=-De,s[1]=+De;for(let a=1,o=0;a<n;a++){let h=(e[a]+a*a-(e[i[o]]+i[o]*i[o]))/(2*a-2*i[o]);for(;h<=s[o];)o--,h=(e[a]+a*a-(e[i[o]]+i[o]*i[o]))/(2*a-2*i[o]);o++,i[o]=a,s[o]=h,s[o+1]=+De}for(let a=0,o=0;a<n;a++){for(;s[o+1]<a;)o++;r[a]=(a-i[o])*(a-i[o])+e[i[o]]}}}var ft=b(43289);function Me(m){return m&&"static"===m.type}class et{constructor(e,r,i=0){this._mosaicPages=[],this._maxItemSize=0,this._currentPage=0,this._pageWidth=0,this._pageHeight=0,this._mosaicRects=new Map,this._spriteCopyQueue=[],this.pixelRatio=1,(e<=0||r<=0)&&console.error("Sprites mosaic defaultWidth and defaultHeight must be greater than zero!"),this._pageWidth=e,this._pageHeight=r,i>0&&(this._maxItemSize=i),this.pixelRatio=window.devicePixelRatio||1,this._binPack=new Ze(this._pageWidth,this._pageHeight);const s=Math.floor(this._pageWidth),n=Math.floor(this._pageHeight);this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(s*n)},size:[this._pageWidth,this._pageHeight],dirty:!0,texture:void 0})}getWidth(e){return e>=this._mosaicPages.length?-1:this._mosaicPages[e].size[0]}getHeight(e){return e>=this._mosaicPages.length?-1:this._mosaicPages[e].size[1]}getPageTexture(e){return e<this._mosaicPages.length?this._mosaicPages[e].texture:null}has(e){return this._mosaicRects.has(e)}get itemCount(){return this._mosaicRects.size}getSpriteItem(e){return this._mosaicRects.get(e)}addSpriteItem(e,r,i,s,n,a,o=1){if(this._mosaicRects.has(e))return this._mosaicRects.get(e);let h,l,u;if(Me(i)?[h,l,u]=this._allocateImage(r[0],r[1]):(h=new le.Z(0,0,r[0],r[1]),l=this._mosaicPages.length,this._mosaicPages.push({mosaicsData:i,size:[r[0]+2*S.s4,r[1]+2*S.s4],dirty:!0,texture:void 0})),h.width<=0||h.height<=0)return null;const d={type:"sprite",rect:h,width:r[0],height:r[1],sdf:n,simplePattern:a,rasterizationScale:o,page:l};return this._mosaicRects.set(e,d),Me(i)&&((0,ae.Z)("esri-mosaic-debug")&&this._showDebugSprite(r,i.data),this._copy({rect:h,spriteSize:r,spriteData:i.data,page:l,pageSize:u,repeat:s,sdf:n})),d}hasItemsToProcess(){return 0!==this._spriteCopyQueue.length}processNextItem(){const e=this._spriteCopyQueue.pop();e&&this._copy(e)}getMosaicItemPosition(e){const r=this.getSpriteItem(e),i=r?.rect;if(!i)return null;i.width=r.width,i.height=r.height;const a=S.s4,o=this._mosaicPages[r.page].size;return{size:[r.width,r.height],tl:[(i.x+a)/o[0],(i.y+a)/o[1]],br:[(i.x+a+r.width)/o[0],(i.y+a+r.height)/o[1]],page:r.page}}bind(e,r,i=0,s=0){const n=this._mosaicPages[i],a=n.mosaicsData;let o=n.texture;o||(o=pt(e,n.size),n.texture=o),o.setSamplingMode(r),Me(a)?(e.bindTexture(o,s),n.dirty&&(o.setData(new Uint8Array(a.data.buffer)),o.generateMipmap(),(0,ae.Z)("esri-mosaic-debug")&&this._showDebugPage(i))):(a.data.loadFrame(o),e.bindTexture(o,s),o.generateMipmap()),n.dirty=!1}getTexture(e,r=0){const i=this._mosaicPages[r],s=i.mosaicsData;let n=i.texture;return n||(n=pt(e,i.size),i.texture=n),Me(s)?i.dirty&&(n.setData(new Uint8Array(s.data.buffer)),n.generateMipmap(),(0,ae.Z)("esri-mosaic-debug")&&this._showDebugPage(r)):(s.data.loadFrame(n),n.generateMipmap()),i.dirty=!1,n}dispose(){this._binPack=null;for(const e of this._mosaicPages){const r=e.texture;r&&r.dispose();const i=e.mosaicsData;Me(i)||i.data.destroy()}this._mosaicPages=null,this._mosaicRects.clear()}static _copyBits(e,r,i,s,n,a,o,h,l,u,d){let f=s*r+i,_=h*a+o;if(d){_-=a;for(let y=-1;y<=u;y++,f=((y+u)%u+s)*r+i,_+=a)for(let x=-1;x<=l;x++)n[_+x]=e[f+(x+l)%l]}else for(let y=0;y<u;y++){for(let x=0;x<l;x++)n[_+x]=e[f+x];f+=r,_+=a}}_copy(e){if(e.page>=this._mosaicPages.length)return;const r=this._mosaicPages[e.page],i=r.mosaicsData;if(!Me(r.mosaicsData))throw new ce.Z("mapview-invalid-resource","unsuitable data type!");const s=e.spriteData,n=i.data;n&&s||console.error("Source or target images are uninitialized!"),et._copyBits(s,e.spriteSize[0],0,0,n,e.pageSize[0],e.rect.x+S.s4,e.rect.y+S.s4,e.spriteSize[0],e.spriteSize[1],e.repeat),r.dirty=!0}_allocateImage(e,r){e+=2*S.s4,r+=2*S.s4;const i=Math.max(e,r);if(this._maxItemSize&&this._maxItemSize<i){const n=2**Math.ceil((0,ft.k3)(e)),a=2**Math.ceil((0,ft.k3)(r)),o=new le.Z(0,0,e,r);return this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(n*a)},size:[n,a],dirty:!0,texture:void 0}),[o,this._mosaicPages.length-1,[n,a]]}const s=this._binPack.allocate(e,r);if(s.width<=0){const n=this._mosaicPages[this._currentPage];return!n.dirty&&Me(n.mosaicsData)&&(n.mosaicsData.data=null),this._currentPage=this._mosaicPages.length,this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(this._pageWidth*this._pageHeight)},size:[this._pageWidth,this._pageHeight],dirty:!0,texture:void 0}),this._binPack=new Ze(this._pageWidth,this._pageHeight),this._allocateImage(e,r)}return[s,this._currentPage,[this._pageWidth,this._pageHeight]]}_showDebugSprite([e,r],i){const s=document.createElement("canvas");s.width=e,s.height=r,s.setAttribute("style",`position: absolute; top: ${4+204*Zt++}px; right: 208px; width: 200px; height: 200px; border: 1px solid black;`);const n=s.getContext("2d"),a=new ImageData(e,r);a.data.set(new Uint8Array(i.buffer)),n.putImageData(a,0,0),document.body.appendChild(s)}_showDebugPage(e){const r=this._mosaicPages[e],{size:[i,s],mosaicsData:n}=r;if(!Me(n))return void console.error("Could not show sprite mosaic debug for non-static resource");const a=`mosaicDebugPage${e}`,o=document.getElementById(a)??document.createElement("canvas");o.id=a,o.width=i,o.height=s,o.setAttribute("style",`position: absolute; top: ${4+204*e}px; right: 4px; width: 200px; height: 200px; border: 1px solid black;`);const h=o.getContext("2d"),l=new ImageData(i,s);l.data.set(new Uint8Array(n.data.buffer)),h.putImageData(l,0,0),document.body.appendChild(o)}}let Zt=0;function pt(m,e){const r=new re.X;return r.width=e[0],r.height=e[1],r.wrapMode=p.e8.CLAMP_TO_EDGE,new ge.x(m,r,null)}var tt=b(87526),jt=b(34106);class Yt{constructor(e,r,i,s){this._animation=e,this._frameData=null,this.frameCount=this._animation.frameDurations.length,this.width=this._animation.width,this.height=this._animation.height,this._playHandle=(0,jt.hY)(this._animation,i,s,a=>{this._frameData=a,r.requestRender()})}destroy(){this._playHandle.remove()}loadFrame(e){const r=this._frameData;null!=r&&(e.updateData(0,S.s4,S.s4,"width"in r?r.width:r.codedWidth,"height"in r?r.height:r.codedHeight,r),this._frameData=null)}}var $t=b(71251);const mt="arial-unicode-ms-regular",Pe=(m,e,r)=>se.Z.getLogger("esri.views.2d.engine.webgl.TextureManager").error(new ce.Z(m,e,r));class rt{static fromMosaic(e,r){return new rt(e,r.page,r.sdf)}constructor(e,r,i){this.mosaicType=e,this.page=r,this.sdf=i}}class Qt{constructor(e){var r;this._requestRender=e,this._resourceManager=new Ft.Z,this._invalidFontsMap=new Map,this._sdfConverter=new Xt(S.qu),this._bindingInfos=new Array,this._hashToBindingIndex=new Map,this._ongoingRasterizations=new Map,this._imageRequestQueue=new $t.e({concurrency:10,process:(r=(0,K.Z)(function*(i,s){(0,me.k_)(s);try{return yield(0,Le.Z)(i,{responseType:"image",signal:s})}catch(n){throw(0,me.D_)(n)?n:new ce.Z("mapview-invalid-resource",`Could not fetch requested resource at ${i}`,n)}}),function(s,n){return r.apply(this,arguments)})}),this._spriteMosaic=new et(2048,2048,500),this._glyphSource=new Ht(`${zt.Z.fontsUrl}/{fontstack}/{range}.pbf`),this._glyphMosaic=new Vt(1024,1024,this._glyphSource),this._rasterizer=new It(this.resourceManager)}dispose(){this._spriteMosaic.dispose(),this._glyphMosaic.dispose(),this._rasterizer.dispose(),this._sdfConverter.dispose(),this._spriteMosaic=null,this._glyphMosaic=null,this._sdfConverter=null,this._hashToBindingIndex.clear(),this._hashToBindingIndex=null,this._bindingInfos=null,this._ongoingRasterizations.clear(),this._ongoingRasterizations=null,this._imageRequestQueue.clear(),this._imageRequestQueue=null,this._resourceManager.destroy()}get sprites(){return this._spriteMosaic}get glyphs(){return this._glyphMosaic}get resourceManager(){return this._resourceManager}rasterizeItem(e,r){var i=this;return(0,K.Z)(function*(){if(null==e)return Pe("mapview-null-resource","Unable to rasterize null resource"),null;if("cim-rasterization-info"!==e.type)return Pe("mapview-unexpected-resource","Unable to rasterize resource"),null;const{resource:s}=e;if("text"===s.type){const a=yield i._rasterizeText(s,r);for(const o of a.glyphs)i._setTextureBinding($.Un.GLYPH,o);return a}const n=yield i._rasterizeSprite(s,r);return n&&i._setTextureBinding($.Un.SPRITE,n),n})()}getMosaicInfo(e,r,i=!1){const s=this._getTextureBindingInfo(e,r,i);return s?{size:s.size,texture:{texture:s.texture,unit:"sprite"===s.type?S.Kt:S.wJ}}:(Pe("mapview-invalid-resource",`Unable to find resource for ${r}`),{size:[0,0],texture:{texture:null,unit:0}})}_getTextureBindingInfo(e,r,i){const s=this._bindingInfos[r-1],n=s.page,a=i?p.cw.LINEAR_MIPMAP_LINEAR:p.cw.LINEAR;switch(s.mosaicType){case $.Un.SPRITE:{const o=[this.sprites.getWidth(n),this.sprites.getHeight(n)],h=this._spriteMosaic.getTexture(e,n);return h.setSamplingMode(a),{type:"sprite",texture:h,size:o}}case $.Un.GLYPH:{const o=[this.glyphs.width,this.glyphs.height],h=this._glyphMosaic.getTexture(e,n);return this._glyphMosaic.bind(e,a,n,S.wJ),h.setSamplingMode(a),{type:"glyph",texture:h,size:o}}default:return Pe("mapview-texture-manager",`Cannot handle unknown type ${s.mosaicType}`),null}}_hashMosaic(e,r){return 1|e<<1|(r.sdf?1:0)<<2|r.page<<3}_setTextureBinding(e,r){const i=this._hashMosaic(e,r);if(!this._hashToBindingIndex.has(i)){const s=rt.fromMosaic(e,r);this._hashToBindingIndex.set(i,this._bindingInfos.length+1),this._bindingInfos.push(s)}r.textureBinding=this._hashToBindingIndex.get(i)}_rasterizeText(e,r){var i=this;return(0,K.Z)(function*(){const{font:s,textString:n}=e,a=(0,fe.Yc)(s),o=i._invalidFontsMap.has(a),[h,l]=(0,Rt.E)(n),u=(0,tt.Jq)(h);try{const d=o?mt:a;return(0,ae.Z)("esri-2d-stabilize-glyphs")&&(yield i._glyphMosaic.preloadASCIIGlyphCache(d)),{type:"glyphs",glyphs:yield i._glyphMosaic.getGlyphItems(d,u,r),isRightToLeft:l}}catch{return Pe("mapview-invalid-resource",`Couldn't find font ${a}. Falling back to Arial Unicode MS Regular`),i._invalidFontsMap.set(a,!0),{type:"glyphs",glyphs:yield i._glyphMosaic.getGlyphItems(mt,u,r),isRightToLeft:l}}})()}_hashSpriteResource(e){switch(e.type){case"path":return`path:${e.path}.${e.asFill?1:0}`;case"CIMPictureMarker":return`${e.type}:${e.url}:${e.size}`;case"CIMPictureFill":return`${e.type}:${e.url}:${e.height}`;case"CIMPictureStroke":return`${e.type}:${e.url}:${e.width}`;case"dash":return`dash:${e.capStyle}.${e.dashTemplate.join("")}`;case"sdf":return`sdf:${JSON.stringify(e.geom)}.${e.asFill?1:0}`;case"fill-style":return`fill_style:${e.style}`;case"animated":return JSON.stringify((0,tt.IS)(e));case"CIMHatchFill":case"CIMVectorMarker":return JSON.stringify(e)}}_rasterizeSprite(e,r){var i=this;return(0,K.Z)(function*(){if(!e)return null;const s=(0,I.hP)(i._hashSpriteResource(e));if(i._spriteMosaic.has(s))return i._spriteMosaic.getSpriteItem(s);if("url"in e&&e.url||"CIMPictureFill"===e.type||"CIMPictureStroke"===e.type||"CIMPictureMarker"===e.type||"CIMVectorMarker"===e.type){const n=[];U.B$.fetchResources({type:"CIMPointSymbol",symbolLayers:[e]},i._resourceManager,n),n.length>0&&(yield Promise.all(n))}switch(e.type){case"CIMPictureMarker":return"CIMMarkerPlacementInsidePolygon"===e.markerPlacement?.type?i._rasterizeJSONResource(s,e):i._handleAsyncResource(s,e,r);case"animated":case"CIMPictureFill":case"CIMPictureStroke":case"path":return i._handleAsyncResource(s,e,r);case"sdf":case"dash":case"fill-style":case"CIMVectorMarker":case"CIMHatchFill":return i._rasterizeJSONResource(s,e)}})()}_rasterizeJSONResource(e,r){const i=this._rasterizer.rasterizeJSONResource(r,function Jt(m){switch(m.type){case"fill-style":case"CIMHatchFill":return S.FM}return 1}(r));if(i){const{size:s,image:n,sdf:a,simplePattern:o,rasterizationScale:h}=i;return this._addItemToMosaic(e,s,{type:"static",data:n},je(r),a,o,h)}return null}_handleAsyncResource(e,r,i){var s=this;return(0,K.Z)(function*(){if(s._ongoingRasterizations.has(e))return s._ongoingRasterizations.get(e);let n;return n="path"===r.type?s._handleSVG(r,e,i):s._handleImage(r,e,i),s._ongoingRasterizations.set(e,n),n.finally(()=>s._ongoingRasterizations.delete(e)),n})()}_handleSVG(e,r,i){var s=this;return(0,K.Z)(function*(){const n=[S.qu,S.qu],{asFill:a}=e,o=yield s._sdfConverter.draw(e.path,a,i);return s._addItemToMosaic(r,n,{type:"static",data:new Uint32Array(o.buffer)},!1,!0,!0)})()}_handleGIFOrPNG(e,r,i){var s=this;return(0,K.Z)(function*(){const a=s.resourceManager.getResource(e.url);if(null==a)return null;const{width:o,height:h}=a;if(a instanceof HTMLImageElement){if("animated"===e.type)return Pe("mapview-unexpected-resource","Attempt to configure animations for a non-animated image."),null;const _="colorSubstitutions"in e?e.colorSubstitutions:void 0,{size:y,sdf:x,image:v}=s._rasterizer.rasterizeImageResource(o,h,a,_);return s._addItemToMosaic(r,y,{type:"static",data:v},je(e),x,!1)}let l,u,d;"animated"===e.type?(l=!1,u={playAnimation:e.playAnimation,reverseAnimation:e.reverseAnimation,randomizeStartTime:e.randomizeStartTime,randomizeStartSeed:e.randomizeStartSeed,startTimeOffset:e.startTimeOffset,duration:e.duration,repeatType:e.repeatType,repeatDelay:e.repeatDelay},d=e.startGroup||0):(l=je(e),u={},d=0);const f=new Yt(a,s._requestRender,u,d);return s._addItemToMosaic(r,[f.width,f.height],{type:"animated",data:f},l,!1,!1)})()}_handleImage(e,r,i){var s=this;return(0,K.Z)(function*(){const n=e.url;if(er(n)||rr(n))return s._handleGIFOrPNG(e,r,i);if("animated"===e.type)return Pe("mapview-unexpected-resource","Attempt to configure animations for a non-animated image."),null;try{let a;const o=s.resourceManager.getResource(n);if(null!=o&&o instanceof HTMLImageElement)a=o;else{const{data:y}=yield s._imageRequestQueue.push(n,{...i});a=y}if((0,tt.TB)(n))if("width"in e&&"height"in e)a.width=(0,A.F2)(e.width),a.height=(0,A.F2)(e.height);else if("cim"in e){const y=e;a.width=(0,A.F2)(y.width??y.scaleX*y.size),a.height=(0,A.F2)(y.size)}if(!a.width||!a.height)return null;const h=a.width,l=a.height,u="colorSubstitutions"in e?e.colorSubstitutions:void 0,{size:d,sdf:f,image:_}=s._rasterizer.rasterizeImageResource(h,l,a,u);return s._addItemToMosaic(r,d,{type:"static",data:_},je(e),f,!1)}catch(a){throw(0,me.D_)(a)?a:new ce.Z("mapview-invalid-resource",`Could not fetch requested resource at ${n}. ${a.message}`)}})()}_addItemToMosaic(e,r,i,s,n,a,o){return this._spriteMosaic.addSpriteItem(e,r,i,s,n,a,o)}}function je(m){switch(m.type){case"CIMVectorMarker":case"CIMPictureMarker":return ir(m);default:return!0}}const er=m=>m&&(m.includes(".gif")||(m=>null!=m&&m.startsWith("data:image/gif"))(m)),rr=m=>m&&(m.includes(".png")||(m=>null!=m&&m.startsWith("data:image/png"))(m)),ir=m=>m&&"markerPlacement"in m&&m.markerPlacement&&"CIMMarkerPlacementInsidePolygon"===m.markerPlacement.type;class sr{constructor(e){this._queue=[],this._refreshable=e}destroy(){this._queue=[]}enqueueTextureUpdate(e,r){const i=(0,me.hh)(),s=e,n=S.Uz,a=Math.ceil(s.height/n);(0,me.k_)(r);for(let o=0;o<a;o++){const l=o===a-1;this._queue.push({type:"chunk",request:e,resolver:i,chunk:o,chunkOffset:o*n,destHeight:l?s.height-n*o:n,chunkIsLast:l,options:r})}return(0,me.$F)(r,o=>i.reject(o)),i.promise}upload(){let e=0;for(;this._queue.length;){const r=performance.now(),i=this._queue.shift();if(i){if(null!=i.options.signal&&i.options.signal.aborted)continue;switch(i.type){case"chunk":this._uploadChunk(i);break;case"no-chunk":this._uploadNoChunk(i)}const s=performance.now()-r;if(e+=s,e+s>=S.NG)break}}this._queue.length&&this._refreshable.requestRender()}_uploadChunk(e){const{request:r,resolver:i,chunkOffset:s,chunkIsLast:n,destHeight:a}=e,{data:o,texture:h,width:l}=r;null!=o&&(h.updateData(0,0,s,l,a,o,s),n&&i.resolve())}_uploadNoChunk(e){const{request:r,resolver:i}=e,{data:s,texture:n}=r;n.setData(s),i.resolve()}}var ve=b(50392),ar=b(86670),Ve=b(86274),nr=b(15331),it=b(79800),st=b(29302),or=b(60233);const lr=(0,nr.al)(-.5,-.5);class hr{constructor(){this._centerNdc=(0,st.Ue)(),this._pxToNdc=(0,st.Ue)(),this._worldDimensionsPx=(0,st.Ue)(),this._mat3=(0,G.Ue)(),this._initialized=!1}dispose(){this._program=(0,D.M2)(this._program),this._quad=(0,D.M2)(this._quad)}render(e,r,i){const{context:s}=e,n=this._updateGeometry(e,i);if(null!=r){const{r:a,g:o,b:h,a:l}=r;s.setClearColor(l*a/255,l*o/255,l*h/255,l)}else s.setClearColor(0,0,0,0);if(s.setStencilFunction(p.wb.ALWAYS,0,255),s.setStencilWriteMask(255),!n)return s.setClearStencil(1),void s.clear(s.gl.STENCIL_BUFFER_BIT|s.gl.COLOR_BUFFER_BIT);s.setClearStencil(0),s.clear(s.gl.STENCIL_BUFFER_BIT|s.gl.COLOR_BUFFER_BIT),this._initialized||this._initialize(s),s.setDepthWriteEnabled(!1),s.setDepthTestEnabled(!1),s.setColorMask(!1,!1,!1,!1),s.setBlendingEnabled(!1),s.setStencilOp(p.xS.KEEP,p.xS.KEEP,p.xS.REPLACE),s.setStencilFunction(p.wb.ALWAYS,1,255),s.setStencilTestEnabled(!0),s.useProgram(this._program),this._program.setUniformMatrix3fv("u_worldExtent",this._mat3),this._quad.draw(),this._quad.unbind()}_initialize(e){if(this._initialized)return;const r=(0,Xe.H)(e,or.H);r&&(this._program=r,this._quad=new ve.Z(e,[0,0,1,0,0,1,1,1]),this._initialized=!0)}_updateGeometry(e,r){const{state:i,pixelRatio:s}=e,{size:n,rotation:a}=i,o=Math.round(n[0]*s),h=Math.round(n[1]*s);if(!i.spatialReference.isWrappable)return!1;const l=(0,ar.c$)(a),u=Math.abs(Math.cos(l)),d=Math.abs(Math.sin(l)),f=Math.round(o*u+h*d),_=Math.round(i.worldScreenWidth);if(f<=_)return!1;const v=(r.left-r.right)*s/o,C=(r.bottom-r.top)*s/h;(0,it.s)(this._worldDimensionsPx,_*s,o*d+h*u,1),(0,it.s)(this._pxToNdc,2/o,-2/h,1),(0,it.s)(this._centerNdc,v,C,1);const M=this._mat3;return(0,Ve.vc)(M,this._centerNdc),(0,Ve.bA)(M,M,this._pxToNdc),0!==a&&(0,Ve.U1)(M,M,l),(0,Ve.bA)(M,M,this._worldDimensionsPx),(0,Ve.Iu)(M,M,lr),!0}}class Ge{constructor(){this.name=this.constructor.name}createOptions(e,r){return null}}class cr extends Ge{constructor(){super(...arguments),this.defines=[],this._desc={vsPath:"fx/integrate",fsPath:"fx/integrate",attributes:new Map([["a_position",0]])}}dispose(){this._quad&&this._quad.dispose()}bind(){}unbind(){}draw(e,r){if(!r?.size)return;const{context:i,renderingOptions:s}=e;this._quad||(this._quad=new ve.Z(i,[0,0,1,0,0,1,1,1]));const n=i.getBoundFramebufferObject(),{x:a,y:o,width:h,height:l}=i.getViewport(),u=r.getBlock(S.wi.Animation);if(null==u)return;const d=r.getUniforms(i);i.setViewport(0,0,r.size,r.size);const f=d.filterFlags,_=d.animation,y=(0,ae.Z)("featurelayer-animation-enabled")?s.labelsAnimationTime:1,x=u.getFBO(i,1);i.unbindTexture(x.colorTexture),this._computeDelta(e,x,_,f,y);const v=u.getFBO(i);i.unbindTexture(v.colorTexture),this._updateAnimationState(e,x,v),i.bindFramebuffer(n),i.setViewport(a,o,h,l)}_computeDelta(e,r,i,s,n){const{context:a,painter:o,displayLevel:h}=e,l=o.materialManager.getProgram(this._desc,["delta"]);if(a.bindFramebuffer(r),a.setColorMask(!0,!0,!0,!0),a.setClearColor(0,0,0,0),a.clear(a.gl.COLOR_BUFFER_BIT),a.useProgram(l),!("type"in s.texture)||!("type"in i.texture))throw new Error("InternalError: Expected to find texture");a.bindTexture(s.texture,s.unit),a.bindTexture(i.texture,i.unit),l.setUniform1i("u_maskTexture",s.unit),l.setUniform1i("u_sourceTexture",i.unit),l.setUniform1f("u_timeDelta",e.deltaTime),l.setUniform1f("u_animationTime",n),l.setUniform1f("u_zoomLevel",Math.round(10*h)),this._quad.draw()}_updateAnimationState(e,r,i){const{context:s,painter:n}=e,a=n.materialManager.getProgram(this._desc,["update"]);s.bindTexture(r.colorTexture,1),s.useProgram(a),a.setUniform1i("u_sourceTexture",1),s.bindFramebuffer(i),s.setColorMask(!0,!0,!0,!0),s.setClearColor(0,0,0,0),s.clear(s.gl.COLOR_BUFFER_BIT),this._quad.draw()}}var gt=b(37977);const _t=m=>`#define ${(m=>m.replace("-","_").toUpperCase())(m)}\n`;function yt(m){return{attributes:new Map([["a_pos",0],["a_tex",1]]),shaders:{vertexShader:_t(m)+(0,gt.w)("blend/blend.vert"),fragmentShader:_t(m)+(0,gt.w)("blend/blend.frag")}}}const bt=()=>se.Z.getLogger("esri.views.2d.engine.webgl.effects.blendEffects.BlendEffect");class dr{constructor(){this._size=[0,0]}dispose(e){this._backBufferTexture=(0,D.M2)(this._backBufferTexture),this._quad=(0,D.M2)(this._quad)}draw(e,r,i,s,n){const{context:a,drawPhase:o}=e;if(this._setupShader(a),s&&"normal"!==s&&o!==$.jx.LABEL)return void this._drawBlended(e,r,i,s,n);const h=yt("normal"),l=a.programCache.acquire(h.shaders.vertexShader,h.shaders.fragmentShader,h.attributes);if(!l)return void bt().error(new ce.Z("mapview-BlendEffect",'Error creating shader program for blend mode "normal"'));a.useProgram(l),r.setSamplingMode(i),a.bindTexture(r,0),l.setUniform1i("u_layerTexture",0),l.setUniform1f("u_opacity",n),a.setBlendingEnabled(!0),a.setBlendFunction(p.zi.ONE,p.zi.ONE_MINUS_SRC_ALPHA);const u=this._quad;u.draw(),u.unbind(),l.dispose()}_drawBlended(e,r,i,s,n){const{context:a,state:o,pixelRatio:h,inFadeTransition:l}=e,{size:u}=o,d=a.getBoundFramebufferObject();let f,_;null!=d?(f=d.width,_=d.height):(f=Math.round(h*u[0]),_=Math.round(h*u[1])),this._createOrResizeTexture(e,f,_);const y=this._backBufferTexture;d.copyToTexture(0,0,f,_,0,0,y),a.setStencilTestEnabled(!1),a.setStencilWriteMask(0),a.setBlendingEnabled(!0),a.setDepthTestEnabled(!1),a.setDepthWriteEnabled(!1);const x=yt(s),v=a.programCache.acquire(x.shaders.vertexShader,x.shaders.fragmentShader,x.attributes);if(!v)return void bt().error(new ce.Z("mapview-BlendEffect",`Error creating shader program for blend mode ${s}`));a.useProgram(v),y.setSamplingMode(i),a.bindTexture(y,0),v.setUniform1i("u_backbufferTexture",0),r.setSamplingMode(i),a.bindTexture(r,1),v.setUniform1i("u_layerTexture",1),v.setUniform1f("u_opacity",n),v.setUniform1f("u_inFadeOpacity",l?1:0),a.setBlendFunction(p.zi.ONE,p.zi.ZERO);const C=this._quad;C.draw(),C.unbind(),v.dispose(),a.setBlendFunction(p.zi.ONE,p.zi.ONE_MINUS_SRC_ALPHA)}_setupShader(e){this._quad||(this._quad=new ve.Z(e,[-1,-1,1,-1,-1,1,1,1]))}_createOrResizeTexture(e,r,i){const{context:s}=e;if(null===this._backBufferTexture||r!==this._size[0]||i!==this._size[1]){if(this._backBufferTexture)this._backBufferTexture.resize(r,i);else{const n=new re.X;n.internalFormat=p.VI.RGBA,n.wrapMode=p.e8.CLAMP_TO_EDGE,n.width=r,n.height=i,this._backBufferTexture=new ge.x(s,n)}this._size[0]=r,this._size[1]=i}}}class xt extends Ge{constructor(e){super(),this.name=this.constructor.name,this.defines=[e]}dispose(){}bind({context:e,painter:r}){this._prev=e.getBoundFramebufferObject();const i=r.getFbos().effect0;e.bindFramebuffer(i),e.setColorMask(!0,!0,!0,!0),e.setClearColor(0,0,0,0),e.clear(e.gl.COLOR_BUFFER_BIT)}unbind(){}draw(e,r){const{context:i,painter:s}=e,n=s.getPostProcessingEffects(r),a=i.getBoundFramebufferObject();for(const{postProcessingEffect:o,effect:h}of n)o.draw(e,a,h);i.bindFramebuffer(this._prev),i.setStencilTestEnabled(!1),s.blitTexture(i,a.colorTexture,p.cw.NEAREST),i.setStencilTestEnabled(!0)}}var Ye=b(11690),Mt=b(8017),vt=b(40852);class fr{constructor(){this._width=void 0,this._height=void 0,this._resources=null}dispose(){this._resources&&(this._resources.quadGeometry.dispose(),this._resources.quadVAO.dispose(),this._resources.highlightProgram.dispose(),this._resources.blurProgram.dispose(),this._resources=null)}preBlur(e,r){e.bindTexture(r,S.Zt),e.useProgram(this._resources.blurProgram),this._resources.blurProgram.setUniform4fv("u_direction",[1,0,1/this._width,0]),this._resources.blurProgram.setUniformMatrix4fv("u_channelSelector",Ye.bM),e.bindVAO(this._resources.quadVAO),e.drawArrays(p.MX.TRIANGLE_STRIP,0,4),e.bindVAO()}finalBlur(e,r){e.bindTexture(r,S.Zt),e.useProgram(this._resources.blurProgram),this._resources.blurProgram.setUniform4fv("u_direction",[0,1,0,1/this._height]),this._resources.blurProgram.setUniformMatrix4fv("u_channelSelector",Ye.dl),e.bindVAO(this._resources.quadVAO),e.drawArrays(p.MX.TRIANGLE_STRIP,0,4),e.bindVAO()}renderHighlight(e,r,i){e.bindTexture(r,S.Zt),e.useProgram(this._resources.highlightProgram),i.applyHighlightOptions(e,this._resources.highlightProgram),e.bindVAO(this._resources.quadVAO),e.setBlendingEnabled(!0),e.setBlendFunction(p.zi.ONE,p.zi.ONE_MINUS_SRC_ALPHA),e.drawArrays(p.MX.TRIANGLE_STRIP,0,4),e.bindVAO()}_initialize(e,r,i){this._width=r,this._height=i;const s=Fe.f.createVertex(e,p.l1.STATIC_DRAW,new Int8Array([-1,-1,0,0,1,-1,1,0,-1,1,0,1,1,1,1,1]).buffer),n=new qe.U(e,new Map([["a_position",0],["a_texcoord",1]]),{geometry:[new vt.G("a_position",2,p.g.BYTE,0,4),new vt.G("a_texcoord",2,p.g.UNSIGNED_BYTE,2,4)]},{geometry:s}),a=(0,Xe.H)(e,Mt.C),o=(0,Xe.H)(e,Mt.y);e.useProgram(a),a.setUniform1i("u_texture",S.Zt),a.setUniform1i("u_shade",S.Sf),a.setUniform1f("u_sigma",Ye.pW),e.useProgram(o),o.setUniform1i("u_texture",S.Zt),o.setUniform1f("u_sigma",Ye.pW),this._resources={quadGeometry:s,quadVAO:n,highlightProgram:a,blurProgram:o}}setup(e,r,i){this._resources?(this._width=r,this._height=i):this._initialize(e,r,i)}}var he=b(85775),at=b(20781);function wt(m,e,r){const i=new re.X(e,r);return i.wrapMode=p.e8.CLAMP_TO_EDGE,new he.X(m,i,new at.Y(p.Tg.STENCIL_INDEX8,e,r))}class pr{constructor(){this._width=void 0,this._height=void 0,this._resources=null}dispose(){this._resources&&(this._resources.sharedBlur1Fbo.dispose(),this._resources.sharedBlur2Fbo.dispose(),this._resources=null)}_initialize(e,r,i){this._width=r,this._height=i;const s=wt(e,r,i),n=wt(e,r,i);this._resources={sharedBlur1Fbo:s,sharedBlur2Fbo:n}}setup(e,r,i){!this._resources||this._width===r&&this._height===i||this.dispose(),this._resources||this._initialize(e,r,i)}get sharedBlur1Tex(){return this._resources.sharedBlur1Fbo.colorTexture}get sharedBlur1Fbo(){return this._resources.sharedBlur1Fbo}get sharedBlur2Tex(){return this._resources.sharedBlur2Fbo.colorTexture}get sharedBlur2Fbo(){return this._resources.sharedBlur2Fbo}}class mr extends Ge{constructor(){super(...arguments),this.defines=["highlight"],this._hlRenderer=new fr,this._width=void 0,this._height=void 0,this._boundFBO=null,this._hlSurfaces=new pr,this._adjustedWidth=void 0,this._adjustedHeight=void 0,this._blitRenderer=new ht}dispose(){this._hlSurfaces?.dispose(),this._hlRenderer?.dispose(),this._boundFBO=null}bind(e){const{context:r,painter:i}=e,{width:s,height:n}=r.getViewport(),a=i.getFbos().effect0;this.setup(e,s,n),r.bindFramebuffer(a),r.setColorMask(!0,!0,!0,!0),r.setClearColor(0,0,0,0),r.clear(r.gl.COLOR_BUFFER_BIT)}unbind(){}setup({context:e},r,i){this._width=r,this._height=i;const s=r%4,n=i%4;i+=n<2?-n:4-n,this._adjustedWidth=r+=s<2?-s:4-s,this._adjustedHeight=i,this._boundFBO=e.getBoundFramebufferObject();const a=Math.round(1*r),o=Math.round(1*i);this._hlRenderer.setup(e,a,o),this._hlSurfaces.setup(e,a,o)}draw(e){const{context:r,passOptions:i}=e,s=i.activeGradient,n=r.getBoundFramebufferObject();r.setViewport(0,0,1*this._adjustedWidth,1*this._adjustedHeight),r.bindFramebuffer(this._hlSurfaces.sharedBlur1Fbo),r.setStencilTestEnabled(!1),r.setClearColor(0,0,0,0),r.clear(r.gl.COLOR_BUFFER_BIT),this._blitRenderer.render(r,n.colorTexture,p.cw.NEAREST,1),r.setStencilTestEnabled(!1),r.setBlendingEnabled(!1),r.setColorMask(!1,!1,!1,!0),r.bindFramebuffer(this._hlSurfaces.sharedBlur2Fbo),r.setClearColor(0,0,0,0),r.clear(r.gl.COLOR_BUFFER_BIT),this._hlRenderer.preBlur(r,this._hlSurfaces.sharedBlur1Tex),r.bindFramebuffer(this._hlSurfaces.sharedBlur1Fbo),r.setClearColor(0,0,0,0),r.clear(r.gl.COLOR_BUFFER_BIT),this._hlRenderer.finalBlur(r,this._hlSurfaces.sharedBlur2Tex),r.bindFramebuffer(this._boundFBO),r.setBlendingEnabled(!0),r.setColorMask(!0,!0,!0,!0),r.setViewport(0,0,this._width,this._height),this._hlRenderer.renderHighlight(r,this._hlSurfaces.sharedBlur1Tex,s),this._boundFBO=null}}class gr extends Ge{constructor(){super(...arguments),this.name=this.constructor.name,this.defines=["hittest"]}dispose(){null!=this._fbo&&this._fbo.dispose()}createOptions({pixelRatio:e},r,i=S.nY){if(!r.length)return null;const s=r.shift(),n=s.x,a=s.y;return this._outstanding=s,{type:"hittest",distance:i*e,smallSymbolDistance:0,smallSymbolSizeThreshold:3,position:[n,a]}}bind(e){const{context:r,attributeView:i}=e;if(!i.size)return;const s=i.getBlock(S.wi.GPGPU);if(null==s)return;const n=s.getFBO(r);r.setViewport(0,0,i.size,i.size),r.bindFramebuffer(n),r.setColorMask(!0,!0,!0,!0),r.setClearColor(0,0,0,0),r.clear(r.gl.COLOR_BUFFER_BIT|r.gl.DEPTH_BUFFER_BIT)}unbind(){}draw(e){if(null==this._outstanding)return;const r=this._outstanding;this._outstanding=null,this._resolve(e,r.resolvers)}_resolve(e,r){return(0,K.Z)(function*(){const{context:i,attributeView:s}=e,n=s.getBlock(S.wi.GPGPU);if(null==n)return void r.forEach(l=>l.resolve([]));const a=n.getFBO(i),o=new Uint8Array(a.width*a.height*4);try{yield a.readPixelsAsync(0,0,a.width,a.height,p.VI.RGBA,p.Br.UNSIGNED_BYTE,o)}catch{return void r.forEach(u=>u.resolve([]))}const h=[];for(let l=0;l<o.length;l+=4)o[l]&&h.push(l/4);r.forEach(l=>l.resolve(h))})()}}class _r extends Ge{constructor(){super(...arguments),this.name=this.constructor.name,this.defines=["id"],this._lastSize=0,this._boundFBO=null}dispose(){null!=this._fbo&&this._fbo.dispose()}bind({context:e,painter:r}){this._boundFBO=e.getBoundFramebufferObject();const i=r.getFbos().effect0;e.bindFramebuffer(i),e.setColorMask(!0,!0,!0,!0),e.setClearColor(0,0,0,0),e.clear(e.gl.COLOR_BUFFER_BIT)}unbind({context:e}){e.bindFramebuffer(this._boundFBO),this._boundFBO=null}draw(e,r,i=2*S.nY){this._resolve(e,r,i)}_resolve({context:e,state:r,pixelRatio:i},s,n){var a=this;return(0,K.Z)(function*(){const o=e.getBoundFramebufferObject(),h=r.size[1]*i,l=Math.round(n*i),u=l/2,d=l/2;a._ensureBuffer(l),s.forEach(function(){var f=(0,K.Z)(function*(_,y){const x=new Map,v=Math.floor(y.x*i-l/2),C=Math.floor(h-y.y*i-l/2);yield o.readPixelsAsync(v,C,l,l,p.VI.RGBA,p.Br.UNSIGNED_BYTE,a._buf);for(let z=0;z<a._buf32.length;z++){const R=a._buf32[z];if(4294967295!==R&&0!==R){const B=z%l,F=l-Math.floor(z/l),ee=(u-B)*(u-B)+(d-F)*(d-F),H=x.has(R)?x.get(R):4294967295;x.set(R,Math.min(ee,H))}}const M=Array.from(x).sort((z,R)=>z[1]-R[1]).map(z=>z[0]);_.resolve(M),s.delete(y)});return function(_,y){return f.apply(this,arguments)}}())})()}_ensureBuffer(e){this._lastSize!==e&&(this._lastSize=e,this._buf=new Uint8Array(4*e*e),this._buf32=new Uint32Array(this._buf.buffer))}}const yr=[1,0],br=[0,1],xr=[1,.8,.6,.4,.2],Mr=[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1];class vr{constructor(){this._intensityFBO=null,this._compositeFBO=null,this._mipsFBOs=new Array(5),this._nMips=5,this._kernelSizeArray=[3,5,7,9,11],this._size=[0,0],this._programDesc={luminosityHighPass:{vsPath:"post-processing/pp",fsPath:"post-processing/bloom/luminosityHighPass",attributes:new Map([["a_position",0]])},gaussianBlur:{vsPath:"post-processing/pp",fsPath:"post-processing/bloom/gaussianBlur",attributes:new Map([["a_position",0]])},composite:{vsPath:"post-processing/pp",fsPath:"post-processing/bloom/composite",attributes:new Map([["a_position",0]])},blit:{vsPath:"post-processing/pp",fsPath:"post-processing/blit",attributes:new Map([["a_position",0]])}}}dispose(){if(this._quad=(0,D.M2)(this._quad),this._intensityFBO=(0,D.M2)(this._intensityFBO),this._compositeFBO=(0,D.M2)(this._compositeFBO),this._mipsFBOs){for(let e=0;e<this._nMips;e++)this._mipsFBOs[e]&&(this._mipsFBOs[e].horizontal.dispose(),this._mipsFBOs[e].vertical.dispose());this._mipsFBOs=null}}draw(e,r,i){const{width:s,height:n}=r,{context:a,painter:o}=e,{materialManager:h}=o,l=a.gl,u=this._programDesc,{strength:d,radius:f,threshold:_}=i;this._quad||(this._quad=new ve.Z(a,[-1,-1,1,-1,-1,1,1,1])),this._createOrResizeResources(e,s,n),a.setStencilTestEnabled(!1),a.setBlendingEnabled(!0),a.setBlendFunction(p.zi.ONE,p.zi.ONE_MINUS_SRC_ALPHA),a.setStencilWriteMask(0);const y=this._quad;y.bind(),a.bindFramebuffer(this._intensityFBO);const x=h.getProgram(u.luminosityHighPass);a.useProgram(x),a.bindTexture(r.colorTexture,0),x.setUniform1i("u_texture",0),x.setUniform3fv("u_defaultColor",[0,0,0]),x.setUniform1f("u_defaultOpacity",0),x.setUniform1f("u_luminosityThreshold",_),x.setUniform1f("u_smoothWidth",.01);const v=[Math.round(s/2),Math.round(n/2)];a.setViewport(0,0,v[0],v[1]),a.setClearColor(0,0,0,0),a.clear(l.COLOR_BUFFER_BIT),y.draw(),a.setBlendingEnabled(!1);let C=this._intensityFBO.colorTexture;for(let R=0;R<this._nMips;R++){const B=h.getProgram(u.gaussianBlur,[{name:"radius",value:this._kernelSizeArray[R]}]);a.useProgram(B),a.bindTexture(C,R+1),B.setUniform1i("u_colorTexture",R+1),B.setUniform2fv("u_texSize",v),B.setUniform2fv("u_direction",yr),a.setViewport(0,0,v[0],v[1]);const F=this._mipsFBOs[R];a.bindFramebuffer(F.horizontal),y.draw(),C=F.horizontal.colorTexture,a.bindFramebuffer(F.vertical),a.bindTexture(C,R+1),B.setUniform2fv("u_direction",br),y.draw(),C=F.vertical.colorTexture,v[0]=Math.round(v[0]/2),v[1]=Math.round(v[1]/2)}a.setViewport(0,0,s,n);const M=h.getProgram(u.composite,[{name:"nummips",value:5}]);a.bindFramebuffer(this._compositeFBO),a.useProgram(M),M.setUniform1f("u_bloomStrength",d),M.setUniform1f("u_bloomRadius",f),M.setUniform1fv("u_bloomFactors",xr),M.setUniform3fv("u_bloomTintColors",Mr),a.bindTexture(this._mipsFBOs[0].vertical.colorTexture,1),M.setUniform1i("u_blurTexture1",1),a.bindTexture(this._mipsFBOs[1].vertical.colorTexture,2),M.setUniform1i("u_blurTexture2",2),a.bindTexture(this._mipsFBOs[2].vertical.colorTexture,3),M.setUniform1i("u_blurTexture3",3),a.bindTexture(this._mipsFBOs[3].vertical.colorTexture,4),M.setUniform1i("u_blurTexture4",4),a.bindTexture(this._mipsFBOs[4].vertical.colorTexture,5),M.setUniform1i("u_blurTexture5",5),y.draw(),a.bindFramebuffer(r),a.setBlendingEnabled(!0);const z=h.getProgram(u.blit);a.useProgram(z),a.bindTexture(this._compositeFBO.colorTexture,6),z.setUniform1i("u_texture",6),a.setBlendFunction(p.zi.ONE,p.zi.ONE),y.draw(),y.unbind(),a.setBlendFunction(p.zi.ONE,p.zi.ONE_MINUS_SRC_ALPHA),a.setStencilTestEnabled(!0)}_createOrResizeResources(e,r,i){const{context:s}=e;if(this._compositeFBO&&this._size[0]===r&&this._size[1]===i)return;this._size[0]=r,this._size[1]=i;const n=[Math.round(r/2),Math.round(i/2)];if(this._compositeFBO)this._compositeFBO.resize(r,i);else{const a=new re.X(r,i);a.internalFormat=p.VI.RGBA,a.wrapMode=p.e8.CLAMP_TO_EDGE,this._compositeFBO=new he.X(s,a)}if(this._intensityFBO)this._intensityFBO.resize(n[0],n[1]);else{const a=new re.X(n[0],n[1]);a.internalFormat=p.VI.RGBA,a.wrapMode=p.e8.CLAMP_TO_EDGE,this._intensityFBO=new he.X(s,a)}for(let a=0;a<this._nMips;a++){if(this._mipsFBOs[a])this._mipsFBOs[a].horizontal.resize(n[0],n[1]),this._mipsFBOs[a].vertical.resize(n[0],n[1]);else{const o=new re.X(n[0],n[1]);o.internalFormat=p.VI.RGBA,o.wrapMode=p.e8.CLAMP_TO_EDGE,this._mipsFBOs[a]={horizontal:new he.X(s,o),vertical:new he.X(s,o)}}n[0]=Math.round(n[0]/2),n[1]=Math.round(n[1]/2)}}}const wr=[1,0],Or=[0,1];class Sr{constructor(){this._blurFBO=null,this._size=[0,0],this._programDesc={gaussianBlur:{vsPath:"post-processing/pp",fsPath:"post-processing/blur/gaussianBlur",attributes:new Map([["a_position",0]])},radialBlur:{vsPath:"post-processing/pp",fsPath:"post-processing/blur/radial-blur",attributes:new Map([["a_position",0]])},blit:{vsPath:"post-processing/pp",fsPath:"post-processing/blit",attributes:new Map([["a_position",0]])}}}dispose(){this._blurFBO&&(this._blurFBO.dispose(),this._blurFBO=null)}draw(e,r,i){const{context:s}=e,{type:n,radius:a}=i;if(0===a)return;this._createOrResizeResources(e),this._quad||(this._quad=new ve.Z(s,[-1,-1,1,-1,-1,1,1,1]));const o=this._quad;o.bind(),"blur"===n?this._gaussianBlur(e,r,a):this._radialBlur(e,r),o.unbind()}_gaussianBlur(e,r,i){const{context:s,state:n,painter:a,pixelRatio:o}=e,{size:h}=n,{materialManager:l}=a,u=this._programDesc,d=this._quad,f=[Math.round(o*h[0]),Math.round(o*h[1])],_=this._blurFBO,y=l.getProgram(u.gaussianBlur,[{name:"radius",value:Math.ceil(i)}]);s.useProgram(y),s.setBlendingEnabled(!1),s.bindFramebuffer(_),s.bindTexture(r.colorTexture,4),y.setUniform1i("u_colorTexture",4),y.setUniform2fv("u_texSize",f),y.setUniform2fv("u_direction",wr),y.setUniform1f("u_sigma",i),d.draw(),s.bindFramebuffer(r),s.setStencilWriteMask(0),s.setStencilTestEnabled(!1),s.setDepthWriteEnabled(!1),s.setDepthTestEnabled(!1),s.bindTexture(_?.colorTexture,5),y.setUniform1i("u_colorTexture",5),y.setUniform2fv("u_direction",Or),d.draw(),s.setBlendingEnabled(!0),s.setBlendFunction(p.zi.ONE,p.zi.ONE_MINUS_SRC_ALPHA),s.setStencilTestEnabled(!0)}_radialBlur(e,r){const{context:i,painter:s}=e,{materialManager:n}=s,a=this._programDesc,o=this._quad,h=this._blurFBO;i.bindFramebuffer(h);const l=n.getProgram(a.radialBlur);i.useProgram(l),i.setBlendingEnabled(!1),i.bindTexture(r.colorTexture,4),l.setUniform1i("u_colorTexture",4),o.draw(),i.bindFramebuffer(r),i.setStencilWriteMask(0),i.setStencilTestEnabled(!1),i.setDepthWriteEnabled(!1),i.setDepthTestEnabled(!1),i.setBlendingEnabled(!0);const u=n.getProgram(a.blit);i.useProgram(u),i.bindTexture(h?.colorTexture,5),u.setUniform1i("u_texture",5),i.setBlendFunction(p.zi.ONE,p.zi.ONE_MINUS_SRC_ALPHA),o.draw()}_createOrResizeResources(e){const{context:r,state:i,pixelRatio:s}=e,{size:n}=i,a=Math.round(s*n[0]),o=Math.round(s*n[1]);if(!this._blurFBO||this._size[0]!==a||this._size[1]!==o)if(this._size[0]=a,this._size[1]=o,this._blurFBO)this._blurFBO.resize(a,o);else{const h=new re.X(a,o);h.internalFormat=p.VI.RGBA,h.wrapMode=p.e8.CLAMP_TO_EDGE,this._blurFBO=new he.X(r,h)}}}class Pr{constructor(){this._layerFBOTexture=null,this._size=[0,0],this._programDesc={vsPath:"post-processing/pp",fsPath:"post-processing/filterEffect",attributes:new Map([["a_position",0]])}}dispose(){this._layerFBOTexture=(0,D.M2)(this._layerFBOTexture)}draw(e,r,i){const{width:s,height:n}=r;this._createOrResizeResources(e,s,n);const{context:a,painter:o}=e,{materialManager:h}=o,l=this._programDesc,u=this._quad,d=i.colorMatrix;u.bind();const f=this._layerFBOTexture;a.bindFramebuffer(r),r.copyToTexture(0,0,s,n,0,0,f),a.setBlendingEnabled(!1),a.setStencilTestEnabled(!1);const _=h.getProgram(l);a.useProgram(_),a.bindTexture(f,2),_.setUniformMatrix4fv("u_coefficients",d),_.setUniform1i("u_colorTexture",2),u.draw(),a.setBlendingEnabled(!0),a.setBlendFunction(p.zi.ONE,p.zi.ONE_MINUS_SRC_ALPHA),a.setStencilTestEnabled(!0),u.unbind()}_createOrResizeResources(e,r,i){const{context:s}=e;if(!this._layerFBOTexture||this._size[0]!==r||this._size[1]!==i){if(this._size[0]=r,this._size[1]=i,this._layerFBOTexture)this._layerFBOTexture.resize(r,i);else{const n=new re.X;n.internalFormat=p.VI.RGBA,n.wrapMode=p.e8.CLAMP_TO_EDGE,n.width=r,n.height=i,this._layerFBOTexture=new ge.x(s,n)}this._quad||(this._quad=new ve.Z(s,[-1,-1,1,-1,-1,1,1,1]))}}}const Er=[1,0],Tr=[0,1];class Cr{constructor(){this._layerFBOTexture=null,this._horizontalBlurFBO=null,this._verticalBlurFBO=null,this._size=[0,0],this._quad=null,this._programDesc={blur:{vsPath:"post-processing/pp",fsPath:"post-processing/blur/gaussianBlur",attributes:new Map([["a_position",0]])},composite:{vsPath:"post-processing/pp",fsPath:"post-processing/drop-shadow/composite",attributes:new Map([["a_position",0]])},blit:{vsPath:"post-processing/pp",fsPath:"post-processing/blit",attributes:new Map([["a_position",0]])}}}dispose(){this._layerFBOTexture=(0,D.M2)(this._layerFBOTexture),this._horizontalBlurFBO=(0,D.M2)(this._horizontalBlurFBO),this._verticalBlurFBO=(0,D.M2)(this._verticalBlurFBO)}draw(e,r,i){const{context:s,state:n,painter:a}=e,{materialManager:o}=a,h=this._programDesc,l=r.width,u=r.height,d=[Math.round(l),Math.round(u)],{blurRadius:f,offsetX:_,offsetY:y,color:x}=i,v=[(0,A.F2)(_),(0,A.F2)(y)];this._createOrResizeResources(e,l,u,d);const C=this._horizontalBlurFBO,M=this._verticalBlurFBO;s.setStencilWriteMask(0),s.setStencilTestEnabled(!1),s.setDepthWriteEnabled(!1),s.setDepthTestEnabled(!1);const z=this._layerFBOTexture;r.copyToTexture(0,0,l,u,0,0,z),this._quad||(this._quad=new ve.Z(s,[-1,-1,1,-1,-1,1,1,1])),s.setViewport(0,0,d[0],d[1]);const R=this._quad;R.bind(),s.setBlendingEnabled(!1);const B=o.getProgram(h.blur,[{name:"radius",value:Math.ceil(f)}]);s.useProgram(B),s.bindFramebuffer(C),s.bindTexture(r.colorTexture,4),B.setUniform1i("u_colorTexture",4),B.setUniform2fv("u_texSize",d),B.setUniform2fv("u_direction",Er),B.setUniform1f("u_sigma",f),R.draw(),s.bindFramebuffer(M),s.bindTexture(C?.colorTexture,5),B.setUniform1i("u_colorTexture",5),B.setUniform2fv("u_direction",Tr),R.draw(),s.bindFramebuffer(r),s.setViewport(0,0,l,u);const F=o.getProgram(h.composite);s.useProgram(F),s.bindTexture(M?.colorTexture,2),F.setUniform1i("u_blurTexture",2),s.bindTexture(z,3),F.setUniform1i("u_layerFBOTexture",3),F.setUniform4fv("u_shadowColor",[x[3]*(x[0]/255),x[3]*(x[1]/255),x[3]*(x[2]/255),x[3]]),F.setUniformMatrix3fv("u_displayViewMat3",n.displayMat3),F.setUniform2fv("u_shadowOffset",v),R.draw(),s.setBlendingEnabled(!0),s.setStencilTestEnabled(!0),s.setBlendFunction(p.zi.ONE,p.zi.ONE_MINUS_SRC_ALPHA),R.unbind()}_createOrResizeResources(e,r,i,s){const{context:n}=e;if(!this._horizontalBlurFBO||this._size[0]!==r||this._size[1]!==i){if(this._size[0]=r,this._size[1]=i,this._horizontalBlurFBO)this._horizontalBlurFBO.resize(s[0],s[1]);else{const a=new re.X(s[0],s[1]);a.internalFormat=p.VI.RGBA,a.wrapMode=p.e8.CLAMP_TO_EDGE,this._horizontalBlurFBO=new he.X(n,a)}if(this._verticalBlurFBO)this._verticalBlurFBO.resize(s[0],s[1]);else{const a=new re.X(s[0],s[1]);a.internalFormat=p.VI.RGBA,a.wrapMode=p.e8.CLAMP_TO_EDGE,this._verticalBlurFBO=new he.X(n,a)}if(this._layerFBOTexture)this._layerFBOTexture.resize(r,i);else{const a=new re.X;a.internalFormat=p.VI.RGBA,a.wrapMode=p.e8.CLAMP_TO_EDGE,a.width=r,a.height=i,this._layerFBOTexture=new ge.x(n,a)}}}}class zr{constructor(){this._size=[0,0],this._layerFBOTexture=null}dispose(){this._layerFBOTexture=(0,D.M2)(this._layerFBOTexture)}draw(e,r,i){const{width:s,height:n}=r;this._createOrResizeResources(e,s,n);const{context:a,painter:o}=e,{amount:h}=i,l=a.gl,u=this._layerFBOTexture;a.bindFramebuffer(r),r.copyToTexture(0,0,s,n,0,0,u),a.setBlendingEnabled(!0),a.setStencilTestEnabled(!1),a.setDepthTestEnabled(!1),a.setClearColor(0,0,0,0),a.clear(l.COLOR_BUFFER_BIT),o.blitTexture(a,u,p.cw.NEAREST,h)}_createOrResizeResources(e,r,i){const{context:s}=e;if(!this._layerFBOTexture||this._size[0]!==r||this._size[1]!==i)if(this._size[0]=r,this._size[1]=i,this._layerFBOTexture)this._layerFBOTexture.resize(r,i);else{const n=new re.X;n.internalFormat=p.VI.RGBA,n.wrapMode=p.e8.CLAMP_TO_EDGE,n.samplingMode=p.cw.NEAREST,n.width=r,n.height=i,this._layerFBOTexture=new ge.x(s,n)}}}function Rr(m){switch(m){case"bloom":case"blur":case"opacity":case"drop-shadow":return m;default:return"colorize"}}const Fr={colorize:()=>new Pr,blur:()=>new Sr,bloom:()=>new vr,opacity:()=>new zr,"drop-shadow":()=>new Cr};class Br{constructor(){this._effectMap=new Map}dispose(){this._effectMap.forEach(e=>e.dispose()),this._effectMap.clear()}getPostProcessingEffects(e){if(!e||0===e.length)return[];const r=[];for(const i of e){const s=Rr(i.type);let n=this._effectMap.get(s);n||(n=Fr[s](),this._effectMap.set(s,n)),r.push({postProcessingEffect:n,effect:i})}return r}}var Ar=b(85931);class Ir{constructor(e,r){this.brushes=e,this.name=r.name,this.drawPhase=r.drawPhase||$.jx.MAP,this._targetFn=r.target,this.effects=r.effects||[],this.enableDefaultDraw=r.enableDefaultDraw??(()=>!0),this.forceDrawByDisplayOrder=!!r.forceDrawByDisplayOrder}render(e){const{context:r,profiler:i}=e,s=this._targetFn(),n=this.drawPhase&e.drawPhase;if(i.recordPassStart(this.name),n){this.enableDefaultDraw()&&this._doRender(e,s),i.recordPassEnd();for(const a of this.effects){if(!a.enable())continue;const o=a.apply,h=a.args?.(),l=r.getViewport(),u=r.getBoundFramebufferObject(),d=e.passOptions;this._bindEffect(e,o,h),this._doRender(e,s,o.defines),this._drawAndUnbindEffect(e,o,l,u,d,h)}}}_doRender(e,r,i){if(null==r)return;const{profiler:s,context:n}=e;for(const a of this.brushes){if(s.recordBrushStart(a.name),null!=a.brushEffect){const o=n.getViewport(),h=n.getBoundFramebufferObject(),l=e.passOptions;this._bindEffect(e,a.brushEffect),this._drawWithBrush(a,e,r,i),this._drawAndUnbindEffect(e,a.brushEffect,o,h,l)}else this._drawWithBrush(a,e,r,i);s.recordBrushEnd()}}_drawWithBrush(e,r,i,s){(0,Ar.zG)(i)?(e.prepareState(r,s),e.drawMany(r,i,s)):i.visible&&(e.prepareState(r,s),e.draw(r,i,s))}_bindEffect(e,r,i){const{profiler:s}=e;s.recordPassStart(this.name+"."+r.name),r.bind(e,i);const n=r.createOptions(e,i);e.passOptions=n}_drawAndUnbindEffect(e,r,i,s,n,a){const{profiler:o,context:h}=e;e.passOptions=n,o.recordBrushStart(r.name),r.draw(e,a),r.unbind(e,a),h.bindFramebuffer(s);const{x:l,y:u,width:d,height:f}=i;h.setViewport(l,u,d,f),o.recordBrushEnd(),o.recordPassEnd()}}class Ot{constructor(){this._programCache=new Map}destroy(){for(const e of this._programCache.values())e.destroy();this._programCache.clear()}getProgram(e,r,i,s,n){const a=e.getShaderKey(r,i,s,n);let o=this._programCache.get(a);return o||(o=e.getProgram(r,i,s,n),this._programCache.set(a,o)),o}}var kr=b(49266);class Ur{constructor(e,r){this.context=e,this._currentPipelineStateNeedsUpdate=!1,this._blitRenderer=new ht,this._worldExtentRenderer=new hr,this._brushCache=new Map,this._lastWidth=null,this._lastHeight=null,this._vtlMaterialManager=new Se.Z,this._blendEffect=new dr,this._stencilBuf=null,this._prevBeforeLayerFBOStack=[],this._fboPool=[],this.effects={highlight:new mr,hittest:new gr,hittestVTL:new _r,integrate:new cr,insideEffect:new xt("inside"),outsideEffect:new xt("outside")},this._programCache=new Ot,this._shaderState={shader:null,uniforms:null,defines:null,optionalAttributes:null,useComputeBuffer:!1},this.materialManager=new Ct(e),this.textureManager=new Qt(r),this.textureUploadManager=new sr(r),this._effectsManager=new Br,this._quadMesh=new ve.Z(e,[0,0,1,0,0,1,1,1])}dispose(){if(this._programCache.destroy(),this.materialManager.dispose(),this.textureManager.dispose(),this.textureUploadManager.destroy(),this._blitRenderer=(0,D.M2)(this._blitRenderer),this._worldExtentRenderer=(0,D.M2)(this._worldExtentRenderer),this._quadMesh.dispose(),this._brushCache&&(this._brushCache.forEach(e=>e.dispose()),this._brushCache.clear(),this._brushCache=null),this._fbos){let e;for(e in this._fbos)this._fbos[e]&&this._fbos[e].dispose()}for(const e of this._fboPool)e.dispose();if(this._fboPool.length=0,this.effects){let e;for(e in this.effects)this.effects[e]&&this.effects[e].dispose()}this._effectsManager.dispose(),this._blendEffect.dispose(this.context),this._vtlMaterialManager=(0,D.M2)(this._vtlMaterialManager)}clearShaderCache(){this._programCache.destroy(),this._programCache=new Ot}get blitRenderer(){return this._blitRenderer}get vectorTilesMaterialManager(){return this._vtlMaterialManager}getFbos(){if(!this._fbos)throw new Error("InternalError: Painter FBOs not initialized");return this._fbos}acquireFbo(e,r){let i;if(this._fboPool.length>0)i=this._fboPool.pop();else{const s=new re.X(e,r);s.samplingMode=p.cw.NEAREST,s.wrapMode=p.e8.CLAMP_TO_EDGE,i=new he.X(this.context,s,this._stencilBuf)}return i.width===e&&i.height===r||i.resize(e,r),i}releaseFbo(e){this._fboPool.push(e)}getSharedStencilBuffer(){return this._stencilBuf}beforeRenderPhases(e,r,i){const{context:s}=e;this._worldExtentRenderer.render(e,r,i);const{width:n,height:a}=s.getViewport();if(this.updateFBOs(n,a),this._prevFBO=s.getBoundFramebufferObject(),s.bindFramebuffer(this.getFbos().output),s.setColorMask(!0,!0,!0,!0),null!=r){const{r:o,g:h,b:l,a:u}=r;s.setClearColor(u*o/255,u*h/255,u*l/255,u)}else s.setClearColor(0,0,0,0);s.setDepthWriteEnabled(!0),s.setClearDepth(1),s.clear(s.gl.COLOR_BUFFER_BIT|s.gl.DEPTH_BUFFER_BIT),s.setDepthWriteEnabled(!1)}afterRenderPhases(e){const{context:r}=e;r.bindFramebuffer(this._prevFBO),r.setStencilFunction(p.wb.EQUAL,1,255),r.setStencilTestEnabled(!0),r.setDepthTestEnabled(!1),this.blitTexture(r,this.getFbos().output.colorTexture,p.cw.NEAREST)}beforeRenderLayer(e,r,i){const{context:s,blendMode:n,effects:a,drawPhase:o,requireFBO:h}=e;if(h||St(o,n,a,i)){const l=s.getBoundFramebufferObject();this._prevBeforeLayerFBOStack.push(l);const{width:u,height:d}=s.getViewport(),f=this.acquireFbo(u,d);s.bindFramebuffer(f),s.setColorMask(!0,!0,!0,!0),s.setClearColor(0,0,0,0),s.setDepthWriteEnabled(!0),s.setClearDepth(1),s.clear(s.gl.COLOR_BUFFER_BIT|s.gl.DEPTH_BUFFER_BIT),s.setDepthWriteEnabled(!1)}s.setDepthWriteEnabled(!1),s.setDepthTestEnabled(!1),s.setStencilTestEnabled(!0),s.setClearStencil(r),s.setStencilWriteMask(255),s.clear(s.gl.STENCIL_BUFFER_BIT)}afterRenderLayer(e,r){const{context:i,blendMode:s,effects:n,requireFBO:a,drawPhase:o}=e;if(a||St(o,s,n,r)){const h=i.getBoundFramebufferObject();null!=n&&n.length>0&&o===$.jx.MAP&&(i.setColorMask(!0,!0,!0,!0),this._applyEffects(e,n,h)),i.bindFramebuffer(this._prevBeforeLayerFBOStack.pop()),i.setStencilTestEnabled(!1),i.setStencilWriteMask(0),i.setBlendingEnabled(!0),i.setBlendFunctionSeparate(p.zi.ONE,p.zi.ONE_MINUS_SRC_ALPHA,p.zi.ONE,p.zi.ONE_MINUS_SRC_ALPHA),i.setColorMask(!0,!0,!0,!0),this._blendEffect.draw(e,h.colorTexture,p.cw.NEAREST,null==s||o===$.jx.HIGHLIGHT?"normal":s,r),this.releaseFbo(h)}}renderObject(e,r,i,s){const n=be.U[i];if(!n)return;let a=this._brushCache.get(n);void 0===a&&(a=new n,this._brushCache.set(n,a)),a.prepareState(e),a.draw(e,r,s)}renderObjects(e,r,i,s){const n=be.U[i];if(!n)return;let a=this._brushCache.get(n);void 0===a&&(a=new n,this._brushCache.set(n,a)),a.drawMany(e,r,s)}registerRenderPass(e){const r=e.brushes.map(i=>(this._brushCache.has(i)||this._brushCache.set(i,new i),this._brushCache.get(i)));return new Ir(r,e)}blitTexture(e,r,i,s=1){e.setBlendingEnabled(!0),e.setBlendFunctionSeparate(p.zi.ONE,p.zi.ONE_MINUS_SRC_ALPHA,p.zi.ONE,p.zi.ONE_MINUS_SRC_ALPHA),e.setColorMask(!0,!0,!0,!0),this._blitRenderer.render(e,r,i,s),this._currentPipelineStateNeedsUpdate=!0}getPostProcessingEffects(e){return this._effectsManager.getPostProcessingEffects(e)}updateFBOs(e,r){if(e!==this._lastWidth||r!==this._lastHeight){if(this._lastWidth=e,this._lastHeight=r,this._fbos){let n;for(n in this._fbos)this._fbos[n].resize(e,r);return}const i=new re.X(e,r);i.samplingMode=p.cw.NEAREST,i.wrapMode=p.e8.CLAMP_TO_EDGE;const s=new at.Y(p.Tg.DEPTH_STENCIL,e,r);this._stencilBuf=new kr.r(this.context,s),this._fbos={output:new he.X(this.context,i,this._stencilBuf),effect0:new he.X(this.context,i,this._stencilBuf)}}}_applyEffects(e,r,i){const{context:s}=e,n=this._effectsManager.getPostProcessingEffects(r);for(const{postProcessingEffect:a,effect:o}of n)s.bindFramebuffer(i),a.draw(e,i,o);this._currentPipelineStateNeedsUpdate=!0}setShader(e){this._shaderState.shader=e.shader,this._shaderState.uniforms=e.uniforms,this._shaderState.defines=e.defines,this._shaderState.optionalAttributes=e.optionalAttributes,this._shaderState.useComputeBuffer=e.useComputeBuffer??!1}setPipelineState(e){e!==this._currentPipelineState&&(this._currentPipelineState=e,this._currentPipelineStateNeedsUpdate=!0)}submitDraw(e,r){const{instance:i}=r,s=i.instanceId,{shader:n,uniforms:a,defines:o,optionalAttributes:h,useComputeBuffer:l}=this._shaderState,u=r.target.getMesh(s),d={useComputeBuffer:l,locationInfo:n.locationInfo,computeAttributeMap:n.computeAttributes},f=u.getLayout(d);if(null==f)return null;const{primitive:_,count:y,offset:x}=u.getDrawArgs(p.MX.TRIANGLES,r.count,r.start*Uint32Array.BYTES_PER_ELEMENT,l),v=this._programCache.getProgram(n,f,a,o??{},h??{});v.setUniforms(a),v.bind(e),this.updatePipelineState(e),this._updateStencilRef(e,r.target);const C=u.getVAO(e,n.locationInfo,d);return e.bindVAO(C),e.drawElements(_,y,p.g.UNSIGNED_INT,x),e.bindVAO(null),v.cleanupTemporaryTextures(),{vertexShader:v.vertexShader,fragmentShader:v.fragmentShader}}submitDrawQuad(e){const{shader:r,uniforms:i,defines:s,optionalAttributes:n}=this._shaderState,a=this._programCache.getProgram(r,this._quadMesh.layout,i,s??{},n??{});a.setUniforms(i),a.bind(e),this.updatePipelineState(e),this._updateStencilRef(e,null),this._quadMesh.draw(),e.bindVAO(null),a.cleanupTemporaryTextures()}submitDrawMesh(e,r,i){const{shader:s,uniforms:n,defines:a,optionalAttributes:o}=this._shaderState,h=this._programCache.getProgram(s,r.layout,n,a??{},o??{});if(h.setUniforms(n),h.bind(e),this.updatePipelineState(e),this._updateStencilRef(e,null),i)for(const l of i)r.bind(e,l),r.draw(e);else for(let l=0;l<r.parts.length;l++)r.bind(e,l),r.draw(e);r.unbind(e),h.cleanupTemporaryTextures()}updatePipelineState(e){this._currentPipelineStateNeedsUpdate&&(this._currentPipelineStateNeedsUpdate=!1,this._updatePipelineState(e))}_updatePipelineState(e){if(null==this._currentPipelineState)throw new Error("Pipeline state not defined. Call setPipelineState before calling submitDraw ");const{color:r,depth:i,stencil:s}=this._currentPipelineState;if(r){const{blendMode:n,write:a}=r;switch(e.setColorMask(...a),e.setBlendingEnabled(!0),e.setBlendEquation(p.db.ADD),n){case"composite":e.setBlendFunctionSeparate(p.zi.ONE,p.zi.ONE_MINUS_SRC_ALPHA,p.zi.ONE,p.zi.ONE_MINUS_SRC_ALPHA);break;case"additive":e.setBlendFunctionSeparate(p.zi.ONE,p.zi.ONE,p.zi.ONE,p.zi.ONE);break;case"custom":{const{blendParameters:o}=r,{dstAlpha:h,dstRGB:l,srcAlpha:u,srcRGB:d}=o;e.setBlendFunctionSeparate(d,l,u,h);break}case"delete":e.setBlendEquation(p.db.REVERSE_SUBTRACT),e.setBlendFunctionSeparate(p.zi.ONE,p.zi.ONE_MINUS_SRC_ALPHA,p.zi.ONE,p.zi.ONE_MINUS_SRC_ALPHA)}}if(i){const{test:n,write:a}=i;a?(e.setDepthWriteEnabled(!0),e.setDepthRange(a.zNear,a.zFar)):e.setDepthWriteEnabled(!1),n?(e.setDepthTestEnabled(!0),e.setDepthFunction(n)):e.setDepthTestEnabled(!1)}else e.setDepthTestEnabled(!1),e.setDepthWriteEnabled(!1);if(s){const{test:n,write:a}=s;if(n){const{compare:o,mask:h,op:l,ref:u}=n;e.setStencilTestEnabled(!0),"function"!=typeof u&&e.setStencilFunctionSeparate(p.LR.FRONT_AND_BACK,o,u,h),e.setStencilOpSeparate(p.LR.FRONT_AND_BACK,l.fail,l.zFail,l.zPass)}else e.setStencilTestEnabled(!1);if(a){const{mask:o}=a;e.setStencilWriteMask(o)}else e.setStencilWriteMask(0)}else e.setStencilTestEnabled(!1),e.setStencilWriteMask(0)}_updateStencilRef(e,r){if(null==this._currentPipelineState)throw new Error("Pipeline state not defined. Call setPipelineState before calling submitDraw ");const{stencil:i}=this._currentPipelineState;if(i){const{test:s}=i;if(s){const{compare:n,mask:a,ref:o}=s;"function"==typeof o&&e.setStencilFunctionSeparate(p.LR.FRONT_AND_BACK,n,o(r),a)}}}}function St(m,e,r,i){return m!==$.jx.LABEL_ALPHA&&m!==$.jx.LABEL&&m!==$.jx.HIGHLIGHT&&(1!==i||null!=e&&"normal"!==e||null!=r&&r.length>0)}var Nr=b(49851),Lr=b(22796),Dr=b(97843),Pt=b(33428),Vr=b(33412),Gr=b(18605),Hr=b(75617),Wr=b(90740);class Zr extends te.W{constructor(e,r){super(),this._trash=new Set,this._renderRemainingTime=0,this._lastFrameRenderTime=0,this._renderRequested=(0,Ue.t)(!1),this.stage=this,this._stationary=!0,this._reshuffleManager=new Dr.y,this._canvas=new ye(e),this.context=new Hr.x(this._canvas.gl,r.contextOptions??{}),this.painter=new Ur(this.context,this),this._cimAnalyzer=new N(this.painter.textureManager.resourceManager),(0,ae.Z)("esri-2d-profiler")&&(this._debugOutput=document.createElement("div"),this._debugOutput.setAttribute("style","margin: 24px 64px; position: absolute; color: red;"),e.appendChild(this._debugOutput));const i=()=>this._highlightGradient;this._renderParameters={drawPhase:0,state:this.state,pixelRatio:window.devicePixelRatio,stationary:!1,globalOpacity:1,blendMode:null,deltaTime:-1,time:0,inFadeTransition:!1,effects:null,context:this.context,painter:this.painter,timeline:r.timeline||new Vr.T,renderingOptions:r.renderingOptions,requestRender:()=>this.requestRender(),allowDelayedRender:!1,requireFBO:!1,profiler:new Lr.Q(this.context,this._debugOutput),dataUploadCounter:0,get highlightGradient(){return i()},reshuffleManager:this._reshuffleManager,backgroundColor:r.backgroundColor},this._taskHandle=(0,Re.A)({render:s=>this.renderFrame(s)}),this._taskHandle.pause(),this._lostWebGLContextHandle=this._canvas.events.on("webgl-context-lost",s=>this.emit("webgl-error",{error:new ce.Z("webgl-context-lost",s.statusMessage)})),this._bufferPool=new Nr.o,(0,Pt.W4)()}destroy(){(0,Pt.IG)(this.context),this.removeAllChildren(),this._emptyTrash(),this._taskHandle=(0,D.hw)(this._taskHandle),this._lostWebGLContextHandle=(0,D.hw)(this._lostWebGLContextHandle),this._canvas.destroy(),this._debugOutput?.parentNode?.removeChild(this._debugOutput),this._bufferPool.destroy(),this.painter.dispose(),this.context.dispose(),this._canvas=null}get textureManager(){return this.painter.textureManager}get backgroundColor(){return this._renderParameters.backgroundColor}set backgroundColor(e){this._renderParameters.backgroundColor=e,this.requestRender()}get bufferPool(){return this._bufferPool}get cimAnalyzer(){return this._cimAnalyzer}get renderingOptions(){return this._renderingOptions}set renderingOptions(e){this._renderingOptions=e,this.requestRender()}get renderRequested(){return this._renderRequested.value}get state(){return this._state}set state(e){this._state=e,this.requestRender()}get stationary(){return this._stationary}set stationary(e){this._stationary!==e&&(this._stationary=e,this.requestRender())}trashDisplayObject(e){this._trash.add(e),this.requestRender()}untrashDisplayObject(e){return this._trash.delete(e)}requestRender(){this._renderRemainingTime=2e3,this.renderRequested||(this._renderRequested.value=!0,this._taskHandle.resume())}renderFrame(e){this._renderRemainingTime-=this._lastFrameRenderTime?e.time-this._lastFrameRenderTime:0,this._renderRemainingTime<=0&&this._taskHandle.pause(),this._lastFrameRenderTime=e.time,this._renderRequested.value=!1,this._renderParameters.state=this._state,this._renderParameters.stationary=this.stationary,this._renderParameters.pixelRatio=window.devicePixelRatio,this._renderParameters.globalOpacity=1,this._renderParameters.time=e.time,this._renderParameters.deltaTime=e.deltaTime,this._renderParameters.effects=null,this.processRender(this._renderParameters),this._emptyTrash()}_createTransforms(){return{displayViewScreenMat3:(0,G.Ue)()}}renderChildren(e){for(const r of this.children)r.beforeRender(e);this._reshuffleManager.reshuffle(S.BZ),this._canvas.render(e,()=>this._renderChildren(this.children,e));for(const r of this.children)r.afterRender(e)}_renderChildren(e,r){const i=this.context;this.painter.textureUploadManager.upload(),i.resetInfo(),r.profiler.recordStart("drawLayers"),r.dataUploadCounter=0,this.painter.beforeRenderPhases(r,r.backgroundColor,this.state.padding),r.drawPhase=$.jx.MAP;for(const s of e)s.processRender(r);if(this.children.some(s=>s.hasHighlight)){r.drawPhase=$.jx.HIGHLIGHT;for(const s of e)s.processRender(r)}if(this.children.some(s=>s.hasLabels)){r.drawPhase=$.jx.LABEL;for(const s of e)s.processRender(r)}if((0,ae.Z)("esri-tiles-debug")){r.drawPhase=$.jx.DEBUG;for(const s of e)s.processRender(r)}this.painter.afterRenderPhases(r),r.profiler.recordEnd("drawLayers"),i.logInfo()}doRender(e){const r=this.context,{state:i,pixelRatio:s}=e;this._canvas.resize(e),r.setViewport(0,0,s*i.size[0],s*i.size[1]),r.setDepthWriteEnabled(!0),r.setStencilWriteMask(255),this.renderChildren(e)}takeScreenshot(e,r,i,s){var n=this;return(0,K.Z)(function*(){const a=Math.round(n.state.size[0]*e.resolutionScale),o=Math.round(n.state.size[1]*e.resolutionScale),h=e.resolutionScale,l=n.context,u=n._state.clone();if(null!=s){const z=u.viewpoint;u.viewpoint.rotation=s,u.viewpoint=z}const d={...n._renderParameters,drawPhase:null,globalOpacity:1,stationary:!0,state:u,pixelRatio:h,time:performance.now(),deltaTime:0,blendMode:null,effects:null,inFadeTransition:!1,backgroundColor:i},f=new re.X(a,o);f.wrapMode=p.e8.CLAMP_TO_EDGE,f.internalFormat=p.lP.RGBA8,f.isImmutable=!0;const _=new he.X(l,f,new at.Y(p.Tg.DEPTH_STENCIL,a,o)),y=l.getBoundFramebufferObject(),x=l.getViewport();l.bindFramebuffer(_),l.setViewport(0,0,a,o),n._renderChildren(r??n.children,d);const v=n._readbackScreenshot(_,{...e.cropArea,y:o-(e.cropArea.y+e.cropArea.height)});l.bindFramebuffer(y),l.setViewport(x.x,x.y,x.width,x.height),n.requestRender();const C=yield v;let M;return 1===e.outputScale?M=C:(M=new ImageData(Math.round(C.width*e.outputScale),Math.round(C.height*e.outputScale)),(0,Gr.TT)(C,M,!0)),_.dispose(),M})()}_readbackScreenshot(e,r){return(0,K.Z)(function*(){const i=(0,Wr.r7)(r.width,r.height,document.createElement("canvas"));return yield e.readPixelsAsync(r.x,r.y,r.width,r.height,p.VI.RGBA,p.Br.UNSIGNED_BYTE,new Uint8Array(i.data.buffer)),i})()}_emptyTrash(){for(;this._trash.size>0;){const e=Array.from(this._trash);this._trash.clear();for(const r of e)r.processDetach()}}}var jr=b(80576),Yr=b(61005),$r=b(36275),Kr=b(69709),Jr=b(59213),Qr=b(72392),Ke=b(32917),qr=b(21726),ei=b(57477),Et=b(18142),ti=b(67670);class ri extends ei.s{constructor(){super(),this._handles=new Qr.Z,this._resourcePixelRatio=1,this.visible=!1}destroy(){this._handles=(0,D.SC)(this._handles),this._disposeRenderResources(),this._resourcesTask=(0,D.IM)(this._resourcesTask)}get backgroundColor(){return this._backgroundColor}set backgroundColor(e){this._backgroundColor=e,this.requestRender()}get magnifier(){return this._magnifier}set magnifier(e){this._magnifier=e,this._handles.removeAll(),this._handles.add([(0,Ke.YP)(()=>e.version,()=>{this.visible=e.visible&&null!=e.position&&e.size>0,this.requestRender()},Ke.nn),(0,Ke.YP)(()=>[e.maskUrl,e.overlayUrl],()=>this._reloadResources()),(0,Ke.YP)(()=>e.size,()=>{this._disposeRenderResources(),this.requestRender()})])}_createTransforms(){return{displayViewScreenMat3:(0,G.Ue)()}}doRender(e){const r=e.context;if(!this._resourcesTask)return void this._reloadResources();if(e.drawPhase!==$.jx.MAP||!this._canRender())return;this._updateResources(e);const i=this._magnifier;if(null==i.position)return;const s=e.pixelRatio,n=i.size*s,o=Math.ceil(1/i.factor*n);this._readbackTexture.resize(o,o);const{size:h}=e.state,l=s*h[0],u=s*h[1],d=.5*o,f=.5*o,_=(0,Q.uZ)(s*i.position.x,d,l-d-1),y=(0,Q.uZ)(u-s*i.position.y,f,u-f-1);r.setBlendingEnabled(!0);const x=_-d,v=y-f,C=this._readbackTexture;r.bindTexture(C,0),r.gl.copyTexImage2D(C.descriptor.target,0,C.descriptor.pixelFormat,x,v,o,o,0);const M=this.backgroundColor,z=M?[M.a*M.r/255,M.a*M.g/255,M.a*M.b/255,M.a]:[1,1,1,1],R=(_+i.offset.x*s)/l*2-1,B=(y-i.offset.y*s)/u*2-1,F=n/l*2,ee=n/u*2,H=this._program;r.bindVAO(this._vertexArrayObject),r.bindTexture(this._overlayTexture,6),r.bindTexture(this._maskTexture,7),r.useProgram(H),H.setUniform4fv("u_background",z),H.setUniform1i("u_readbackTexture",0),H.setUniform1i("u_overlayTexture",6),H.setUniform1i("u_maskTexture",7),H.setUniform4f("u_drawPos",R,B,F,ee),H.setUniform1i("u_maskEnabled",i.maskEnabled?1:0),H.setUniform1i("u_overlayEnabled",i.overlayEnabled?1:0),r.setStencilTestEnabled(!1),r.setColorMask(!0,!0,!0,!0),r.drawArrays(p.MX.TRIANGLE_STRIP,0,4),r.bindVAO()}_canRender(){return this.mask&&this.overlay&&null!=this._magnifier}_reloadResources(){var e=this;this._resourcesTask&&this._resourcesTask.abort();const r=null!=this._magnifier?this._magnifier.maskUrl:null,i=null!=this._magnifier?this._magnifier.overlayUrl:null;this._resourcesTask=(0,Jr.vr)(function(){var s=(0,K.Z)(function*(n){const a=null==r||null==i?(0,ti.e)(n):null,o=null!=r?(0,Le.Z)(r,{responseType:"image",signal:n}).then(d=>d.data):a.then(d=>d.mask),h=null!=i?(0,Le.Z)(i,{responseType:"image",signal:n}).then(d=>d.data):a.then(d=>d.overlay),[l,u]=yield Promise.all([o,h]);e.mask=l,e.overlay=u,e._disposeRenderResources(),e.requestRender()});return function(n){return s.apply(this,arguments)}}())}_disposeRenderResources(){this._readbackTexture=(0,D.M2)(this._readbackTexture),this._overlayTexture=(0,D.M2)(this._overlayTexture),this._maskTexture=(0,D.M2)(this._maskTexture),this._vertexArrayObject=(0,D.M2)(this._vertexArrayObject),this._program=(0,D.M2)(this._program)}_updateResources(e){if(e.pixelRatio!==this._resourcePixelRatio&&this._disposeRenderResources(),this._readbackTexture)return;const r=e.context;this._resourcePixelRatio=e.pixelRatio;const i=Math.ceil(this._magnifier.size*e.pixelRatio);this._program=(0,Et.F)(r);const s=new Uint16Array([0,1,0,0,1,1,1,0]);this._vertexArrayObject=new qe.U(r,Et.c.attributes,xe.cD,{geometry:Fe.f.createVertex(r,p.l1.STATIC_DRAW,s)}),this.overlay.width=i,this.overlay.height=i;const a=new re.X;a.internalFormat=p.VI.RGBA,a.wrapMode=p.e8.CLAMP_TO_EDGE,a.samplingMode=p.cw.NEAREST,a.flipped=!0,a.preMultiplyAlpha=!(0,qr.zd)(this.overlay.src)||!e.context.driverTest.svgPremultipliesAlpha.result,this._overlayTexture=new ge.x(r,a,this.overlay),this.mask.width=i,this.mask.height=i,a.pixelFormat=a.internalFormat=p.VI.ALPHA,this._maskTexture=new ge.x(r,a,this.mask);const o=1/this._magnifier.factor;a.pixelFormat=a.internalFormat=p.VI.RGBA,a.width=a.height=Math.ceil(o*i),a.samplingMode=p.cw.LINEAR,a.flipped=!1,this._readbackTexture=new ge.x(r,a)}}}}]);