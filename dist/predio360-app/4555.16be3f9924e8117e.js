"use strict";(self.webpackChunkpredio360_app=self.webpackChunkpredio360_app||[]).push([[4555],{26268:(J,L,s)=>{s.d(L,{Z:()=>P});var V=s(8314),f=s(39406),B=s(44589),j=s(8650),g=s(13382);const Z=(y,o)=>y.key.level-o.key.level!=0?y.key.level-o.key.level:y.key.row-o.key.row!=0?y.key.row-o.key.row:y.key.col-o.key.col;class P extends B.Z{constructor(o){super(),this._tileInfoView=o}get requiresDedicatedFBO(){return!1}renderChildren(o){this.sortChildren(Z),this.setStencilReference(o),super.renderChildren(o)}createRenderParams(o){const{state:v}=o,C=super.createRenderParams(o);return C.requiredLevel=this._tileInfoView.getClosestInfoForScale(v.scale).level,C.displayLevel=this._tileInfoView.tileInfo.scaleToZoom(v.scale),C}prepareRenderPasses(o){const v=super.prepareRenderPasses(o);return v.push(o.registerRenderPass({name:"stencil",brushes:[g.Z],drawPhase:f.jx.DEBUG|f.jx.MAP|f.jx.HIGHLIGHT,target:()=>this.getStencilTarget()})),(0,V.Z)("esri-tiles-debug")&&v.push(o.registerRenderPass({name:"tileInfo",brushes:[j.Z],drawPhase:f.jx.DEBUG,target:()=>this.children})),v}getStencilTarget(){return this.children}setStencilReference(o){let v=1;for(const C of this.children)C.stencilRef=v++}}},82557:(J,L,s)=>{s.r(L),s.d(L,{default:()=>ot});var V=s(15861),f=s(17626),B=s(24263),j=s(46160),g=s(62208),Z=s(32917),P=s(21726),y=s(77712),C=(s(90912),s(85931),s(76898)),F=s(2004),A=s(55915),Y=s(65234),D=s(98686),Q=s(2618),_=s(51815),G=s(90301),X=s(91757),$=s(37384),O=s(36275),N=s(78209),q=s(45611),tt=s(84792),z=s(72642),k=s(28594),et=s(50392),it=s(86859),p=s(67969),st=s(85775),at=s(38982),rt=s(75740),H=s(55086);let nt=(()=>{class t{constructor(e){if(this._ownsRctx=!1,e)this._ownsRctx=!1,this._rctx=e;else{if(t._instance)return t._instanceRefCount++,t._instance;t._instanceRefCount=1,t._instance=this,this._ownsRctx=!0;const a=document.createElement("canvas").getContext("webgl");a.getExtension("OES_texture_float"),this._rctx=new rt.x(a,{})}const l=(0,it.s)("raster/reproject","raster/reproject",new Map([["a_position",0]]),{applyProjection:!0,bilinear:!1,bicubic:!1});this._program=this._rctx.programCache.acquire(l.shaders.vertexShader,l.shaders.fragmentShader,l.attributes),this._rctx.useProgram(this._program),this._program.setUniform1f("u_opacity",1),this._program.setUniform1i("u_image",0),this._program.setUniform1i("u_flipY",0),this._program.setUniform1i("u_transformGrid",1),this._quad=new et.Z(this._rctx,[0,0,1,0,0,1,1,1])}reprojectTexture(e,n,l=!1){const a=(0,A.iV)(e.extent,n),r=new z.Z({x:(e.extent.xmax-e.extent.xmin)/e.texture.descriptor.width,y:(e.extent.ymax-e.extent.ymin)/e.texture.descriptor.height,spatialReference:e.extent.spatialReference}),{x:d,y:c}=(0,k.VO)(r,n,e.extent);let m=(d+c)/2;const u=Math.round((a.xmax-a.xmin)/m),h=Math.round((a.ymax-a.ymin)/m);m=(a.width/u+a.height/h)/2;const W=new z.Z({x:m,y:m,spatialReference:a.spatialReference}),S=(0,k.Qp)({projectedExtent:a,srcBufferExtent:e.extent,pixelSize:W,hasWrapAround:!0,spacing:[16,16]}),R=(0,at.Br)(this._rctx,S),I=new H.x(this._rctx,{width:u,height:h,pixelFormat:p.VI.RGBA,dataType:p.Br.UNSIGNED_BYTE,wrapMode:p.e8.CLAMP_TO_EDGE,samplingMode:p.cw.LINEAR,hasMipmap:!1}),x=new st.X(this._rctx,{colorTarget:p.Lm.TEXTURE,depthStencilTarget:p.OU.NONE,width:u,height:h},I);this._rctx.bindFramebuffer(x),this._rctx.setViewport(0,0,u,h),this._rctx.useProgram(this._program),this._rctx.bindTexture(e.texture,0),this._rctx.bindTexture(R,1),this._quad.bind();const{width:M=0,height:E=0}=e.texture.descriptor;if(this._program.setUniform2f("u_srcImageSize",M,E),this._program.setUniform2fv("u_transformSpacing",S.spacing),this._program.setUniform2fv("u_transformGridSize",S.size),this._program.setUniform2f("u_targetImageSize",u,h),this._quad.draw(),this._quad.unbind(),this._rctx.useProgram(null),this._rctx.bindFramebuffer(null),R.dispose(),l){const{width:w=0,height:T=0}=x.descriptor,U=new ImageData(w,T);return x.readPixels(0,0,w,T,p.VI.RGBA,p.Br.UNSIGNED_BYTE,U.data),x.detachColorTexture(p.VY.COLOR_ATTACHMENT0),x.dispose(),{texture:I,extent:a,imageData:U}}return x.detachColorTexture(p.VY.COLOR_ATTACHMENT0),x.dispose(),{texture:I,extent:a}}reprojectBitmapData(e,n){const l=(0,G.JZ)(e.bitmapData)?(0,G.RL)(e.bitmapData):e.bitmapData,a=new H.x(this._rctx,{width:e.bitmapData.width,height:e.bitmapData.height,pixelFormat:p.VI.RGBA,dataType:p.Br.UNSIGNED_BYTE,wrapMode:p.e8.CLAMP_TO_EDGE,samplingMode:p.cw.LINEAR,hasMipmap:!1},l),r=this.reprojectTexture({texture:a,extent:e.extent},n,!0);r.texture.dispose();const d=document.createElement("canvas"),c=r.imageData;return d.width=c.width,d.height=c.height,d.getContext("2d").putImageData(c,0,0),{bitmapData:d,extent:r.extent}}loadAndReprojectBitmapData(e,n,l){var a=this;return(0,V.Z)(function*(){const r=(yield(0,tt.default)(e,{responseType:"image"})).data,d=document.createElement("canvas");d.width=r.width,d.height=r.height;const c=d.getContext("2d");c.drawImage(r,0,0);const m=c.getImageData(0,0,d.width,d.height);if(n.spatialReference.equals(l))return{bitmapData:m,extent:n};const u=a.reprojectBitmapData({bitmapData:m,extent:n},l);return{bitmapData:u.bitmapData,extent:u.extent}})()}destroy(){this._ownsRctx?(t._instanceRefCount--,0===t._instanceRefCount&&(this._quad.dispose(),this._program.dispose(),this._rctx.dispose(),t._instance=null)):(this._quad.dispose(),this._program.dispose())}}return t._instanceRefCount=0,t})();class K{constructor(){this.allSublayers=new Map,this.allPoints=[],this.allPolylines=[],this.allPolygons=[],this.allMapImages=[]}}let b=class extends((0,$.y)(q.Z)){constructor(){super(...arguments),this._bitmapIndex=new Map,this._mapImageContainer=new X.c,this._kmlVisualData=new K,this._fetchController=null,this.allVisiblePoints=new _.J,this.allVisiblePolylines=new _.J,this.allVisiblePolygons=new _.J,this.allVisibleMapImages=new j.Z}hitTest(t,i){var e=this;return(0,V.Z)(function*(){const n=e.layer;return[e._pointsView?.hitTest(t),e._polylinesView?.hitTest(t),e._polygonsView?.hitTest(t)].flat().filter(Boolean).map(l=>(l.layer=n,l.sourceLayer=n,{type:"graphic",graphic:l,layer:n,mapPoint:t}))})()}update(t){this._polygonsView&&this._polygonsView.processUpdate(t),this._polylinesView&&this._polylinesView.processUpdate(t),this._pointsView&&this._pointsView.processUpdate(t)}attach(){this._fetchController=new AbortController,this.container.addChild(this._mapImageContainer),this._polygonsView=new N.Z({view:this.view,graphics:this.allVisiblePolygons,requestUpdateCallback:()=>this.requestUpdate(),container:new O.Z(this.view.featuresTilingScheme)}),this.container.addChild(this._polygonsView.container),this._polylinesView=new N.Z({view:this.view,graphics:this.allVisiblePolylines,requestUpdateCallback:()=>this.requestUpdate(),container:new O.Z(this.view.featuresTilingScheme)}),this.container.addChild(this._polylinesView.container),this._pointsView=new N.Z({view:this.view,graphics:this.allVisiblePoints,requestUpdateCallback:()=>this.requestUpdate(),container:new O.Z(this.view.featuresTilingScheme)}),this.container.addChild(this._pointsView.container),this.addAttachHandles([this.allVisibleMapImages.on("change",t=>{t.added.forEach(i=>this._addMapImage(i)),t.removed.forEach(i=>this._removeMapImage(i))}),(0,Z.YP)(()=>this.layer.visibleSublayers,t=>{for(const[i,e]of this._kmlVisualData.allSublayers)e.visibility=0;for(const i of t){const e=this._kmlVisualData.allSublayers.get(i.id);e&&(e.visibility=1)}this._refreshCollections()})]),this.updatingHandles.addPromise(this._fetchService(this._fetchController.signal)),this._imageReprojector=new nt}detach(){this._fetchController=(0,g.IM)(this._fetchController),this._mapImageContainer.removeAllChildren(),this.container.removeAllChildren(),this._bitmapIndex.clear(),this._polygonsView=(0,g.SC)(this._polygonsView),this._polylinesView=(0,g.SC)(this._polylinesView),this._pointsView=(0,g.SC)(this._pointsView),this._imageReprojector=(0,g.SC)(this._imageReprojector)}moveStart(){}viewChange(){this._polygonsView.viewChange(),this._polylinesView.viewChange(),this._pointsView.viewChange()}moveEnd(){}isUpdating(){return this._pointsView.updating||this._polygonsView.updating||this._polylinesView.updating}_addMapImage(t){(this.view.spatialReference?.isWGS84||this.view.spatialReference?.isWebMercator)&&this._imageReprojector.loadAndReprojectBitmapData(t.href,F.Z.fromJSON(t.extent),this.view.spatialReference).then(i=>{const e=new G.eY(i.bitmapData,{immutable:!1,requestRenderOnSourceChangedEnabled:!0});e.x=i.extent.xmin,e.y=i.extent.ymax,e.resolution=i.extent.width/i.bitmapData.width,e.rotation=t.rotation,this._mapImageContainer.addChild(e),this._bitmapIndex.set(t,e)})}_getViewDependentUrl(t,i){return(0,V.Z)(function*(){const{viewFormat:e,viewBoundScale:n,httpQuery:l}=t;if((0,g.pC)(e)){if((0,g.Wi)(i))throw new Error("Loading this network link requires a view state.");let a;if(yield(0,A.zD)(),(0,g.pC)(n)&&1!==n){const w=new F.Z(i.extent);w.expand(n),a=w}else a=i.extent;a=(0,A.iV)(a,Y.Z.WGS84);const r=(0,A.iV)(a,Y.Z.WebMercator),d=a.xmin,c=a.xmax,m=a.ymin,u=a.ymax,h=i.size[0]*i.pixelRatio,W=i.size[1]*i.pixelRatio,S=Math.max(r.width,r.height),R={"[bboxWest]":d.toString(),"[bboxEast]":c.toString(),"[bboxSouth]":m.toString(),"[bboxNorth]":u.toString(),"[lookatLon]":a.center.x.toString(),"[lookatLat]":a.center.y.toString(),"[lookatRange]":S.toString(),"[lookatTilt]":"0","[lookatHeading]":i.rotation.toString(),"[lookatTerrainLon]":a.center.x.toString(),"[lookatTerrainLat]":a.center.y.toString(),"[lookatTerrainAlt]":"0","[cameraLon]":a.center.x.toString(),"[cameraLat]":a.center.y.toString(),"[cameraAlt]":S.toString(),"[horizFov]":"60","[vertFov]":"60","[horizPixels]":h.toString(),"[vertPixels]":W.toString(),"[terrainEnabled]":"0","[clientVersion]":B.i8,"[kmlVersion]":"2.2","[clientName]":"ArcGIS API for JavaScript","[language]":"en-US"},I=w=>{for(const T in w)for(const U in R)w[T]=w[T].replace(U,R[U])},x=(0,P.u0)(e);I(x);let M={};(0,g.pC)(l)&&(M=(0,P.u0)(l),I(M));const E=(0,Q.en)(t.href);return E.query={...E.query,...x,...M},`${E.path}?${(0,P.B7)(x)}`}return t.href})()}_fetchService(t){var i=this;return(0,V.Z)(function*(){const e=new K;yield i._loadVisualData(i.layer.url,e,t),i._kmlVisualData=e,i._refreshCollections()})()}_refreshCollections(){this.allVisiblePoints.removeAll(),this.allVisiblePolylines.removeAll(),this.allVisiblePolygons.removeAll(),this.allVisibleMapImages.removeAll(),this.allVisiblePoints.addMany(this._kmlVisualData.allPoints.filter(t=>this._isSublayerVisible(t.sublayerId)).map(({item:t})=>t)),this.allVisiblePolylines.addMany(this._kmlVisualData.allPolylines.filter(t=>this._isSublayerVisible(t.sublayerId)).map(({item:t})=>t)),this.allVisiblePolygons.addMany(this._kmlVisualData.allPolygons.filter(t=>this._isSublayerVisible(t.sublayerId)).map(({item:t})=>t)),this.allVisibleMapImages.addMany(this._kmlVisualData.allMapImages.filter(t=>this._isSublayerVisible(t.sublayerId)).map(({item:t})=>t))}_isSublayerVisible(t){const i=this._kmlVisualData.allSublayers.get(t);return!!i?.visibility&&(-1===i.parentFolderId||this._isSublayerVisible(i.parentFolderId))}_loadVisualData(t,i,e){var n=this;return this._fetchParsedKML(t,e).then(function(){var l=(0,V.Z)(function*(a){for(const r of a.sublayers){i.allSublayers.set(r.id,r);const d=r.points?yield(0,D.Yu)(r.points):[],c=r.polylines?yield(0,D.Yu)(r.polylines):[],m=r.polygons?yield(0,D.Yu)(r.polygons):[],u=r.mapImages||[];if(i.allPoints.push(...d.map(h=>({item:h,sublayerId:r.id}))),i.allPolylines.push(...c.map(h=>({item:h,sublayerId:r.id}))),i.allPolygons.push(...m.map(h=>({item:h,sublayerId:r.id}))),i.allMapImages.push(...u.map(h=>({item:h,sublayerId:r.id}))),r.networkLink){const h=yield n._getViewDependentUrl(r.networkLink,n.view.state);yield n._loadVisualData(h,i,e)}}});return function(a){return l.apply(this,arguments)}}())}_fetchParsedKML(t,i){return(0,D.CS)(t,this.layer.spatialReference,this.layer.refreshInterval,i).then(e=>(0,D.Cw)(e.data))}_removeMapImage(t){const i=this._bitmapIndex.get(t);i&&(this._mapImageContainer.removeChild(i),this._bitmapIndex.delete(t))}};(0,f._)([(0,y.Cb)()],b.prototype,"_pointsView",void 0),(0,f._)([(0,y.Cb)()],b.prototype,"_polylinesView",void 0),(0,f._)([(0,y.Cb)()],b.prototype,"_polygonsView",void 0),(0,f._)([(0,y.Cb)()],b.prototype,"updating",void 0),b=(0,f._)([(0,C.j)("esri.views.2d.layers.KMLLayerView2D")],b);const ot=b}}]);