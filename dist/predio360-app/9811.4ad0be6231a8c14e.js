"use strict";(self.webpackChunkpredio360_app=self.webpackChunkpredio360_app||[]).push([[9811,6446],{66607:(ge,X,u)=>{u.d(X,{Z:()=>gt});var N=u(17626),O=u(14517),b=u(72392),C=u(8314),Z=u(63290),a=u(62208),U=u(77029),J=u(60330),p=u(10699),H=u(32917),g=u(77712),te=(u(90912),u(85931)),Y=u(76898),q=u(55915),ae=u(65401),re=u(38114),oe=u(41291),ue=u(59617),ce=u(87091);let se=class extends O.Z{constructor(){super(),this.referenceCount=0,this.callbacks=new Array,this.runIndex=0}get running(){return this.callbacks.some(i=>i.running)}runTask(i){this._sort();const e=this.callbacks,t={numIndexLoading:0,numNodesLoading:0};for(let s=0;s<e.length&&!i.done;++s)e[s].priority=e[s].runTask(i,t),this.runIndex=s}_sort(){const i=this.callbacks;let e=i.length;for(let t=this.runIndex;t>0;t--){const s=i[t-1];let r=t;for(;r<i.length&&s.priority<=i[r].priority&&(r!==e||s.priority<i[r].priority);)i[r-1]=i[r],r++;i[r-1]=s,e=r-1}this.runIndex=0}add(i){this._sort(),i.priority=1/0,this.callbacks.unshift(i),this.notifyChange("running")}remove(i){(0,te.e$)(this.callbacks,i),this.runIndex=this.callbacks.length,this._sort(),this.notifyChange("running")}};(0,N._)([(0,g.Cb)({readOnly:!0})],se.prototype,"running",null),se=(0,N._)([(0,Y.j)("esri.views.3d.layers.i3s.I3SFrameTask")],se);class _e{constructor(e,t){this.task=e,this.handle=t}}const me=new Map;function k(i,e){let t=me.get(i);if(null==t){const s=new se,r=i.registerTask(ce.T8.I3S_CONTROLLER,s);t=new _e(s,r),me.set(i,t)}return t.task.add(e),{remove:()=>{null!=t&&(t.task.remove(e),t.task.callbacks.length>0||(me.delete(i),t.handle.remove(),t.task.destroy()),t=null)}}}var R=u(84161),f=u(4794),c=u(52565),P=u(42964),l=u(93394);class h{constructor(e,t,s,r,n){this.childOffset=e,this.childCount=t,this.visibilityCache=s,this.ref=r,this.node=n,this.useAsHole=0,this.filterImpact=c.U_.NotChecked}}class _{constructor(e,t,s,r,n,d,o,m,L,V,v,S,B,D){this._streamDataController=s,this._viewportQueries=r,this._logger=n,this.holeFilling=d,this._isLoaded=o,this._isReloading=m,this._isSelected=L,this._enable=V,this._needsUpdate=v,this._canRequest=S,this._computeVisibilityObb=B,this._computeNodeFiltering=D,this._dirty=!0,this._nodePages=[],this._nodeCount=0,this._nodesPerPage=0,this._rootIndex=0,this._lodMetric=c.w5.None,this._lodConversion=K=>K,this._urlPrefix="",this._loading=new Set,this._failedNodes=new Set,this._failedPages=new Set,this._indexMissing=1,this._maxUnloadedPrio=Number.NEGATIVE_INFINITY,this._maxProcessingPrio=Number.POSITIVE_INFINITY,this._nodeTraversalState=new Map,this._version=M(0),this._visibilityCacheVersion=M(0),this._maxLevel=1,this._featureEstimate={estimate:0,leavesReached:!1},this._unloadedMemoryEstimate=0,this._missing=new U.Z({deallocator:null}),this._prefetch=new U.Z({deallocator:null}),this._updates=new x(this._missing),this._imModificationUncategorized=new U.Z({deallocator:null}),this.ignoreServiceObb=!1,this.progressiveLoadPenalty=0,this._pageQueue=[],this.needNodeElevationRange=!1,this.layerHasModifications=!1,this._layerHasFilter=!1,this._logLayer=e,e.serviceUpdateTimeStamp&&e.serviceUpdateTimeStamp.lastUpdate&&(this._lastUpdate=`${e.serviceUpdateTimeStamp.lastUpdate}`),this._maxLodLevel=this._viewportQueries?this._viewportQueries.maxLodLevel:1,this._init(t)}_init(e){if("page"===e.type){switch(this._urlPrefix=e.urlPrefix,this._nodesPerPage=e.pageSize,this._rootIndex=e.rootIndex,e.lodMetric){case"maxScreenThreshold":this._lodMetric=c.w5.MaxScreenThreshold;break;case"maxScreenThresholdSQ":this._lodMetric=c.w5.MaxScreenThreshold,this._lodConversion=pe}this._addPage(E(this._rootIndex,this._nodesPerPage),e.rootPage),this._updateParentsAndLevel()}else if("node"===e.type){this._urlPrefix=e.urlPrefix,this._nodePages.push({nodes:[],children:[],parents:[]}),this._makeRefNode(new c.$i(e.rootNode.id,null),-1);const t=this._validateNode(e.rootNode.id,e.rootNode);t&&this._addNode(t,0)}}_loadPage(e){this._loading.add(e),this._streamDataController.request(this._urlPrefix+e,"json").then(s=>{this._pageQueue.push({pageIndex:e,page:s})}).catch(s=>{this._loading.delete(e),(0,p.D_)(s)||(this._failedPages.add(e),this._logger.error("#loadPage()",this._logLayer,`Error when loading page ${e}`,s))})}_addQueuedPages(e){for(;this._pageQueue.length>0&&!e.done;){const{pageIndex:t,page:s}=this._pageQueue.shift();this._addPage(t,s),this._loading.delete(t),e.madeProgress()}this._updateParentsAndLevel()}_addPage(e,t){for(let d=this._nodePages.length;d<e;d++)this._nodePages[d]=null;const s=[],r=[],n=t.nodes.map((d,o)=>{const m=s.length,L=d.children?d.children.length:0;r.push(-1);for(let G=0;G<L;G++)s.push(d.children[G]);const V=`${d.index}`,v=(0,l.d9)(d.obb),S=(0,f.b)([v.center[0],v.center[1],v.center[2],(0,R.l)(v.halfSize)]),B=d.mesh&&d.mesh.attribute,D=d.mesh&&d.mesh.geometry,K=d.mesh&&d.mesh.material,w=new c.NB(V,e*this._nodesPerPage+o,S,L,0,{hasSharedResource:!1,hasFeatureData:!!D,attributes:B&&null!=B.resource?`${B.resource}`:void 0,geometry:D&&null!=D.resource?`${D.resource}`:void 0,texture:K&&null!=K.resource?`${K.resource}`:void 0,geometryDefinition:D?D.definition:-1,materialDefinition:K?K.definition:-1},this._lastUpdate,this._lodMetric,this._lodConversion(d.lodThreshold),D?D.featureCount:null);return w.serviceObb=v,w.visibilityObb=this._computeVisibilityObb(w),w.vertexCount=D?D.vertexCount:0,new h(m,L,F(this._visibilityCacheVersion),null,w)});this._nodePages[e]={nodes:n,children:s,parents:r},this._nodeCount+=n.length}_updateParentsAndLevel(){const e=new Array,t=(s,r,n)=>{const d=this._getPage(s);if((0,a.pC)(d)){const o=Q(s,this._nodesPerPage);d.parents[o]=r;const m=d.nodes[o].node;(0,a.pC)(m)&&(m.level=n,e.push(s))}};for(t(this._rootIndex,-1,0);e.length;){const s=e.pop(),r=this.getNode(s);if((0,a.pC)(r))for(let n=0;n<r.childCount;n++)t(this.getChildIndex(r.index,n),s,r.level+1),this._maxLevel=Math.max(this._maxLevel,r.level+1)}}_getPage(e){return this._nodePages[E(e,this._nodesPerPage)]}_getNodeInternal(e){const t=this._getPage(e);return(0,a.Wi)(t)?null:t.nodes[Q(e,this._nodesPerPage)]}_addNode(e,t){null!=e.children&&this.populateChildren(t,e.children);const s=this.getParent(t),r=(0,a.pC)(s)?s.level+1:0;this._maxLevel=Math.max(this._maxLevel,e.children?r+1:r);const{lodMetric:n,maxError:d}=function ee(i){if(i)for(let e=0;e<i.length;e++)for(const t of z)if(t[0]===i[e].metricType)return{lodMetric:t[1],maxError:i[e].maxError};return{lodMetric:c.w5.None,maxError:0}}(e.lodSelection),o=(0,a.Wg)(this._getNodeInternal(t));return o.node=new c.NB(e.id,t,(0,f.b)(e.mbs),o.childCount,r,e.resources,e.version,n,d,e.numFeatures),e.obb&&(o.node.serviceObb=(0,l.d9)(e.obb)),o.node.visibilityObb=this._computeVisibilityObb(o.node),(0,a.pC)(o.ref)&&(null==o.ref.mbs&&(o.ref.mbs=e.mbs),o.node.renderMbs=o.ref.renderMbs,o.node.serviceObbInRenderSR=o.ref.serviceObbInRenderSR,o.ref.visibilityObb=o.node.visibilityObb),o.node}_makeRefNode(e,t){const s=this._nodePages[0];if(null==s)return-1;const r=s.nodes.length;return s.nodes.push(new h(0,0,F(this._visibilityCacheVersion),e,null)),this._nodeCount++,s.parents.push(t),(0,P.WD)(e.renderMbs),(0,P.VL)(e.serviceObbInRenderSR),r}populateChildren(e,t){const s=(0,a.Wg)(this._getNodeInternal(e)),r=(0,a.Wg)(this._getPage(e));s.childOffset=r.children.length,s.childCount=t.length;for(let n=0;n<t.length;n++){const d=this._makeRefNode(t[n],e);r.children.push(d)}}getNode(e){const t=this._getNodeInternal(e);return(0,a.pC)(t)?t.node:null}getIndexById(e){let t;return this._forAllNodes((s,r)=>{((0,a.pC)(s.node)&&s.node.id===e||(0,a.pC)(s.ref)&&s.ref.id===e)&&(t=r)}),t}getNodeById(e){const t=this.getIndexById(e);return null!=t&&t>=0?this.getNode(t):null}getChildIndex(e,t){const s=this._getPage(e);if((0,a.Wi)(s))return-1;const r=s.nodes[Q(e,this._nodesPerPage)];return s.children[r.childOffset+t]}getParentIndex(e){const t=this._getPage(e);return(0,a.pC)(t)?t.parents[Q(e,this._nodesPerPage)]:-1}getParent(e){return(e=this.getParentIndex(e))>=0?this.getNode(e):null}isLeaf(e){const t=this._getNodeInternal(e);return(0,a.pC)(t)&&0===t.childCount}get rootNode(){return this.getNode(this._rootIndex)}get size(){return this._nodeCount}removeAllGeometryObbs(){this._forAllNodes(e=>{(0,a.pC)(e.node)&&(e.node.geometryObb=null)})}invalidateVisibilityCache(){this._visibilityCacheVersion=M(this._visibilityCacheVersion)}invalidateNodeVisibilityCache(e){const t=this._getNodeInternal(e);(0,a.pC)(t)&&this.invalidateNodeVisibilityCacheInternal(t)}invalidateNodeVisibilityCacheInternal(e){e.visibilityCache=F(this._visibilityCacheVersion)}invalidateBoundingVolumeCache(e){const t=this._getNodeInternal(e);(0,a.pC)(t)&&(I(t),this.invalidateNodeVisibilityCacheInternal(t))}updateElevationChanged(e){const t=this._getNodeInternal(e);if((0,a.Wi)(t))return;if(!this.needNodeElevationRange)return void this.invalidateBoundingVolumeCache(e);const s=(0,a.pC)(t.node)?t.node:t.ref;if((0,a.Wi)(s))return;const r=s.elevationRange;(0,a.Wi)(r)||(r.valid=!1)}invalidateGeometryVisibility(e){const t=this._getNodeInternal(e);(0,a.pC)(t)&&(0,a.pC)(t.node)&&(t.node.geometryObb=null,(0,P.WD)(t.node.renderMbs),(0,P.VL)(t.node.serviceObbInRenderSR))}invalidateVisibilityObbs(){(0,a.Wi)(this.rootNode)||this.traverse(this.rootNode,e=>(e.visibilityObb=this._computeVisibilityObb(e),e.geometryObb=null,!0))}_updateElevationRange(e){const t=this._getNodeInternal(e);if((0,a.Wi)(t))return null;const s=(0,a.pC)(t.node)?t.node:t.ref;if((0,a.Wi)(s))return null;const r=s.elevationRange;if((0,a.pC)(r)&&r.valid)return r;const n=new c.rw;let d=!1;for(let o=0;o<t.childCount;o++){const m=this._updateElevationRange(this.getChildIndex(e,o));(0,a.Wi)(m)?d=!0:(n.min=Math.min(n.min,m.min),n.max=Math.max(n.max,m.max))}if(0===t.childCount||d&&(0,a.pC)(t.node)&&t.node.resources.geometry){const o=this._viewportQueries.getElevationRange(s);(0,a.pC)(o)&&(n.min=Math.min(n.min,o.min),n.max=Math.max(n.max,o.max))}return(0,a.pC)(r)&&r.min===n.min&&r.max===n.max?(r.valid=!0,r):(n.valid=!0,s.elevationRange=n,this.invalidateBoundingVolumeCache(e),n)}isNodeVisible(e){const t=this._getNodeInternal(e);if((0,a.Wi)(t)||(0,a.pC)(t.ref)&&!t.ref.mbs)return!0;if(this.needNodeElevationRange&&this._updateElevationRange(e),!A(t.visibilityCache,this._visibilityCacheVersion)){const s=t.node,r=(0,a.pC)(s)&&((0,a.Wi)(t.ref)||(0,a.pC)(s.visibilityObb))?s:(0,a.pC)(t.ref)?t.ref:null;if(this._layerHasFilter&&this._computeNodeFiltering&&((0,a.pC)(s)||(0,a.pC)(t.ref))&&t.filterImpact===c.U_.NotChecked){const o=(0,a.pC)(s)?s.mbs:(0,a.pC)(t.ref)?t.ref.mbs:null;t.filterImpact=null!=o?this._computeNodeFiltering(o):c.U_.Unmodified}const n=(0,a.pC)(s)&&t.filterImpact===c.U_.Culled,d=!((0,a.pC)(s)&&s.imModificationImpact===c.O4.Culled)&&(!r||this._viewportQueries.isNodeVisible(r))&&!n;return t.visibilityCache=T(d,this._visibilityCacheVersion),d}return W(t.visibilityCache)}isGeometryVisible(e){if(!this.isNodeVisible(e))return!1;const t=this._getNodeInternal(e);return!((0,a.pC)(t)&&(0,a.pC)(t.node)&&(0,a.pC)(t.node.geometryObb)&&(!this.layerHasModifications||t.node.imModificationImpact!==c.O4.NotChecked))||this._viewportQueries.isGeometryVisible(t.node)}_traverseCoverage(e,t,s,r,n){const d=this._getPage(e);if((0,a.Wi)(d)||0===t.childCount)return;const o=t.childOffset+t.childCount,m=new Array;for(let L=t.childOffset;L<o;++L){const V=d.children[L],v=this._getNodeInternal(V);(0,a.pC)(v)&&(0,a.pC)(v.node)&&this.isGeometryVisible(V)&&m.push(v)}r/=m.length;for(const L of m){const V=(0,a.Wg)(L.node).index;this._isLoaded(V)||this._isReloading(V)?(n.delta=Math.max(n.delta,s),n.coverage+=r):this._traverseCoverage(V,L,s+1,r,n)}}useNodeAsHole(e){if("off"===this.holeFilling)return!1;const t=this._getNodeInternal(e);if((0,a.Wi)(t))return!1;if("always"===this.holeFilling)return!0;if(A(t.useAsHole,this._version))return W(t.useAsHole);const s={delta:0,coverage:0};this._traverseCoverage(e,t,0,1,s);const r=s.delta*s.coverage<=.5;return t.useAsHole=T(r,this._version),r}get maxLevel(){return this._maxLevel}get dirty(){return this._dirty}destroy(){this._updates.add.prune(),this._updates.update.prune()}requestUpdate(){this._dirty=!0,this._indexMissing=1,this._version=M(this._version)}imModificationsChanged(e){this.layerHasModifications=e,this._forAllNodes(({node:t})=>{(0,a.pC)(t)&&(t.imModificationImpact=c.O4.NotChecked,t.visibilityObb=this._computeVisibilityObb(t),t.hasModifications&&this.invalidateGeometryVisibility(t.index))}),this.invalidateVisibilityCache()}layerFilterChanged(e){this._layerHasFilter=e,this._forAllNodes(t=>{if((0,a.pC)(t)){t.filterImpact=c.U_.NotChecked;const s=t.node;(0,a.pC)(s)&&this.invalidateNodeVisibilityCache(s.index)}}),this.invalidateVisibilityCache()}update(e,t,s){if(!this._dirty)return;this._pageQueue.length>0&&this._addQueuedPages(t),this._maxUnloadedPrio=Number.NEGATIVE_INFINITY,this._maxProcessingPrio=Number.NEGATIVE_INFINITY,this._missing.clear(),this._prefetch.clear(),this._updates.reset(e),y.clear();let r=!0;const n=new de,d=new de,o=this._imModificationUncategorized;o.clear();const m=new Set;this.traverseVisible((v,S,B)=>{if((0,a.Wi)(S)){let w=this._entryPriority(v);w===1/0&&(w=this._entryPriority(B));const G=E(v,this._nodesPerPage);return y.set(G,Math.max(w,y.get(G)||0)),this._loading.has(G)||this._failedPages.has(G)||this._missing.push(G),void(this._maxProcessingPrio=Math.max(this._maxProcessingPrio,w))}const D=S.node;if(this._updateNodeFeatureEstimate(D,d),(0,a.Wi)(D)){const w=this._entryPriority(v);return this._loading.has(v)||this._failedNodes.has(v)||(this._missing.push(v),y.set(v,w)),void(this._maxProcessingPrio=Math.max(this._maxProcessingPrio,w))}const K=(0,a.Wg)(this._getPage(v));if(0===this._missing.length&&0===this._nodesPerPage)for(let w=0;w<S.childCount;w++){const G=K.children[S.childOffset+w],he=this._getNodeInternal(G);!(0,a.pC)(he)||he.node||this._loading.has(G)||this._failedNodes.has(G)||(y.set(G,this._entryPriority(G)),this._prefetch.push(G))}if(D.failed||!D.resources.hasFeatureData)return void(r&&S.childCount>0&&this._isSelected(D)&&(r=!1));if(m.add(D.id),this._isLoaded(v)){if(n.known+=D.memory,++n.knownNodes,this._isSelected(D)?S.childCount>0&&(r=!1):(n.unremoved+=D.memory,r=!1),this._needsUpdate(D)){const w=this._entryPriority(v);y.set(v,w),this._maxProcessingPrio=Math.max(this._maxProcessingPrio,w),this._updates.update.push(v)}return}if(D.memory&&(n.known+=D.memory,++n.knownNodes),!this._isSelected(D))return void(this._isReloading(v)&&this._updates.remove.push(v));if(S.childCount>0&&(r=!1),D.memory?(n.missing+=D.memory,n.known+=D.memory,++n.knownNodes):++n.missingNodes,e.includes(D.index))return this._maxProcessingPrio=Math.max(this._maxProcessingPrio,this._entryPriority(v)),void(this._updates.cancel=this._updates.cancel.filter(w=>w!==D.index));if(!t.done&&this._enable(D))return void t.madeProgress();const ie=this._entryPriority(v);y.set(v,ie),this._maxProcessingPrio=Math.max(this._maxProcessingPrio,ie),this._updates.add.push(v),this.layerHasModifications&&s&&(0,a.pC)(D)&&D.imModificationImpact===c.O4.NotChecked&&o.push(v)});const V=this._updates.add;V.length>0&&this.layerHasModifications&&(o.length>0&&s?.(o),V.filterInPlace(v=>{const S=this._getNodeInternal(v),B=(0,a.Wi)(S)||(0,a.Wi)(S.node)||S.node.imModificationImpact!==c.O4.Culled;return B||this.invalidateNodeVisibilityCache(v),B})),this._unloadedMemoryEstimate=n.missing-n.unremoved,n.knownNodes>3&&n.missingNodes>0&&(this._unloadedMemoryEstimate+=n.known/n.knownNodes*n.missingNodes),this._unloadedMemoryEstimate=.8*Math.max(0,this._unloadedMemoryEstimate),this._featureEstimate.estimate=this._computeFeatureEstimate(d),this._featureEstimate.leavesReached=r,this._missing.sort((v,S)=>v-S),this._missing.filterInPlace((v,S)=>S<1||this._missing.data[S-1]!==v),this._missing.sort((v,S)=>y.get(v)-y.get(S)),this._missing.length>0&&(this._maxUnloadedPrio=y.get(this._missing.back()),this._prefetch.clear()),this._updates.add.filterInPlace(v=>y.get(v)>=this._maxUnloadedPrio).sort((v,S)=>y.get(v)-y.get(S)),this._updates.update.sort((v,S)=>y.get(v)-y.get(S)),this._indexMissing=this._loading.size+this._missing.length,this._dirty=this._indexMissing>0,y.clear()}checkFeatureTarget(e,t){const s=this._viewportQueries.updateScreenSpaceErrorBias(t);let r=t,n=t,d=s,o=10;for(;o--;){const m=new de;if(this._updateFeatureEstimate(r,m),this._computeFeatureEstimate(m)<=e){if(r>=t||m.missingNodes>0||0===o)break;d=r,r=.5*(r+n)}else n=r,r=.5*(r+d)}return this._version=M(this._version),this._viewportQueries.updateScreenSpaceErrorBias(s),Math.min(t,r)}_updateFeatureEstimate(e,t){this._version=M(this._version),this._viewportQueries.updateScreenSpaceErrorBias(e),this.traverseVisible((s,r)=>this._updateNodeFeatureEstimate((0,a.pC)(r)?r.node:void 0,t))}_updateNodeFeatureEstimate(e,t){if(!((0,a.Wi)(e)||e.failed||(0,a.Wi)(e.numFeatures)))return this._isLoaded(e.index)?(t.known+=e.numFeatures,++t.knownNodes,void(this._isSelected(e)||(t.unremoved+=e.numFeatures))):void(this._isSelected(e)&&((0,a.pC)(e.numFeatures)?(t.missing+=e.numFeatures,t.known+=e.numFeatures,++t.knownNodes):++t.missingNodes))}_computeFeatureEstimate(e){let t=e.known-e.unremoved;return e.knownNodes>3&&e.missingNodes>0&&(t+=e.known/e.knownNodes*e.missingNodes),Math.max(0,t)}load(){return this._load(this._missing)}prefetch(){return this._prefetch.sort((e,t)=>y.get(e)-y.get(t)),this._load(this._prefetch)}_load(e){if(0===e.length||!this._canRequest())return!1;for(;e.length>0&&this._canRequest();)0===this._nodesPerPage?this._loadNode(e.pop()):this._loadPage(e.pop());return!0}get isLoading(){return this._indexMissing>0}get isPrefetching(){return this._prefetch.length>0}get indexLoading(){return this._loading.size}get indexMissing(){return this._indexMissing}get unloadedMemoryEstimate(){return this._unloadedMemoryEstimate}get updates(){return this._updates}get featureEstimate(){return this._featureEstimate}get maxPriority(){return Math.max(this._maxProcessingPrio,this._maxUnloadedPrio)}nodeTraversalState(e){if((0,a.Wi)(e))return null;let t=this._nodeTraversalState.get(e.index);if(t&&A(t.version,this._version))return t;const s=this._viewportQueries.getLodLevel(e),r=this._viewportQueries.hasLOD(e);let n=!0;if(r){const d=this.getParentIndex(e.index);if(d>=0){const o=this._nodeTraversalState.get(d);n=!!o&&s>o.lodLevel}else n=s>0}else n=0===e.childCount;return t?(t.lodLevel=s,t.isChosen=n,t.version=T(!0,this._version),t):(t=new c.oQ(r,n,s,T(!0,this._version)),this._nodeTraversalState.set(e.index,t),t)}_loadNode(e){this._loading.add(e);const t=(0,a.Wg)(this._getNodeInternal(e)).ref;if((0,a.Wi)(t))return void this._failedNodes.add(e);const s=t.id,r=this._urlPrefix+s,n=()=>{this._loading.delete(e),0===this._missing.length&&0===this._loading.size&&this.requestUpdate()};this._streamDataController.request(r,"json").then(d=>{n();const o=this._validateNode(s,d);if(null==o)return;o.obb&&this.invalidateNodeVisibilityCache(e);const m=this._addNode(o,e);this.nodeTraversalState(m)},d=>{n(),(0,p.D_)(d)||(this._logger.error("#loadNode()",this._logLayer,"Error loading node: "+r),this._failedNodes.add(e))})}_validateNode(e,t){if(null==t||"object"!=typeof t||t.id!==e)return this._logger.error("#validateNode()",this._logLayer,`Invalid node. Wrong type or wrong id "${e}"`),null;if(!Array.isArray(t.mbs))return this._logger.error("#validateNode()",this._logLayer,`Invalid bounding volume on node ${e}.`),null;t.sharedResource&&"./shared"!==t.sharedResource.href&&"./shared/"!==t.sharedResource.href&&this._logger.warn("#validateNode()",this._logLayer,`Invalid shared resource href on node "${e}"`),null==t.geometryData||Array.isArray(t.geometryData)&&1===t.geometryData.length&&"./geometries/0"===t.geometryData[0].href||this._logger.warn("#validateNode()",this._logLayer,`Invalid geometry data on node "${e}"`),null==t.attributeData||Array.isArray(t.attributeData)&&!t.attributeData.some((o,m)=>o.href!==`./attributes/f_${m}/0`)||this._logger.warn("#validateNode()",this._logLayer,`Invalid attribute data on node "${e}"`),t.featureData&&t.featureData.length>1&&this._logger.warn("#validateNode()",this._logLayer,`Node ${e} has ${t.featureData.length} bundles. Only the first bundle will be loaded.`);const s=t.hasOwnProperty("obb")&&!this.ignoreServiceObb?t.obb:null,r=t.featureData&&1===t.featureData.length&&t.featureData[0].featureRange?t.featureData[0].featureRange[1]-t.featureData[0].featureRange[0]+1:void 0,d=Array.isArray(t.children)?t.children.map(o=>{if(null==o)return null;const m=v=>this._logger.error("#validateNode()",this._logLayer,`Invalid node reference on node ${e}: ${v}`);if("number"==typeof o.id)m(`id ${o.id} is a number instead of a string.`);else if("string"!=typeof o.id||!Array.isArray(o.mbs))return m("Missing or invalid id."),null;if(!Array.isArray(o.mbs))return m(`Invalid bounding volume on reference ${o.id}.`),null;o.href&&o.href!=="../"+o.id&&this._logger.error("#validateNode()",this._logLayer,`Invalid node href on node "${e}"`);const L=o.hasOwnProperty("obb")&&!this.ignoreServiceObb?o.obb:null,V=new c.$i(`${o.id}`,o.mbs);return V.serviceObb=L,V.visibilityObb=this._computeVisibilityObb(V),V}).filter(o=>null!=o):null;return{id:e,mbs:t.mbs,obb:s,children:d,resources:{hasFeatureData:t.featureData&&t.featureData.length>0,hasSharedResource:null!=t.sharedResource,attributes:t.attributeData?e:void 0,texture:t.textureData&&t.textureData.length>0?e:void 0,geometry:null!=t.geometryData?e:void 0},version:"string"==typeof t.version?t.version:null,lodSelection:Array.isArray(t.lodSelection)?t.lodSelection:null,numFeatures:r}}resetFailedNodes(){this._failedNodes.clear(),this._failedPages.clear(),this._forAllNodes(e=>{(0,a.pC)(e.node)&&(e.node.failed=!1)})}_entryPriority(e){const t=this._getNodeInternal(e),s=this.getParentIndex(e);if((0,a.Wi)(t)||s<0&&null==t.node)return s<0?1/0:this._entryPriority(s);let r=0;if(t.node&&s>=0){const o=this._nodeTraversalState.get(s);null!=o&&(r=o.lodLevel)}let n=this.progressiveLoadPenalty;for(let o=e;o>=0;o=this.getParentIndex(o))if(this._isLoaded(o)){n=0;break}const d=(0,a.pC)(t.ref)?this._viewportQueries.distToPOI(t.ref):(0,a.pC)(t.node)?this._viewportQueries.distToPOI(t.node):0;return-d-r*(d+this.progressiveLoadPenalty)+n}traverseVisible(e){const t=this._getNodeInternal(this._rootIndex);(0,a.Wi)(t)?e(this._rootIndex,null,null):this._traverseVisible(this._rootIndex,-1,t,e)}_traverseVisible(e,t,s,r){if(s.node&&0===s.childCount)return void(this.isGeometryVisible(e)&&r(e,s,t));if(!this.isNodeVisible(e)||(r(e,s,t),null==s.node))return;const n=this.nodeTraversalState(s.node);if(n?.nodeHasLOD&&n.lodLevel===this._maxLodLevel)return;const d=(0,a.Wg)(this._getPage(e));for(let o=0;o<s.childCount;o++){const m=d.children[s.childOffset+o],L=this._getNodeInternal(m);(0,a.pC)(L)?this._traverseVisible(m,e,L,r):r(m,null,e)}}traverse(e,t){t(e)&&this.traverseChildren(e,t)}traverseChildren(e,t){const s=e.index,r=this._getNodeInternal(s);(0,a.pC)(r)&&this._traverseChildren(s,r,t)}_traverseChildren(e,t,s){const r=this._getPage(e);if((0,a.Wi)(r))return;const n=t.childOffset+t.childCount;for(let d=t.childOffset;d<n;++d){const o=r.children[d],m=this._getNodeInternal(o);(0,a.pC)(m)&&(0,a.pC)(m.node)&&s(m.node)&&this._traverseChildren(o,m,s)}}updateChildrenLoaded(e,t){let s=this.getNode(e);for(;(0,a.pC)(s);)s.childrenLoaded+=t,s=this.getParent(s.index)}checkChildrenLoadedInvariant(){if((0,a.Wi)(this.rootNode))return!0;const e=[],t=s=>{let r=this._isLoaded(s.index)||this._isReloading(s.index)?1:0;return this.traverseChildren(s,n=>(r+=t(n),!1)),s.childrenLoaded!==r&&e.push(s.index),r};return t(this.rootNode),e.length&&this._logger.error("childrenLoaded invariant broken at following nodes: "+e.join(",")),e.length>0}updateStats(e){if(this._updates.add.length>0&&(e.nodes+=" + "+this._updates.add.length),(this._indexMissing||this._prefetch.length>0)&&(e.index+=" + "+this._indexMissing||0),e.prio=this._maxProcessingPrio,this._featureEstimate.estimate){const t=this._featureEstimate.estimate-e.features;t>0?e.features+=" + "+t:t<0&&(e.features+=" - "+-t)}}updateElevationInfo(e,t){this.needNodeElevationRange=t&&!!e&&("relative-to-ground"===e.mode||"on-the-ground"===e.mode),this._viewportQueries.updateElevationInfo(e),this.invalidateAllElevationRanges()}invalidateAllElevationRanges(){this._forAllNodes(e=>{I(e),(0,a.pC)(e.node)&&(e.node.elevationRange=null),(0,a.pC)(e.ref)&&(e.ref.elevationRange=null)})}_forAllNodes(e){for(let t=0;t<this._nodePages.length;t++){const s=this._nodePages[t];if(s){const r=t*this._nodesPerPage;for(let n=0;n<s.nodes.length;n++)e(s.nodes[n],r+n)}}}get test(){return{addNode:(e,t)=>this._addNode(e,t)}}}const y=new Map;class x{constructor(e){this.missing=e,this.update=new U.Z({deallocator:null}),this.add=new U.Z({deallocator:null}),this.remove=new U.Z({deallocator:null}),this.cancel=[]}reset(e){this.add.clear(),this.update.clear(),this.cancel=e}}function I(i){(0,a.pC)(i.node)&&((0,P.WD)(i.node.renderMbs),(0,P.VL)(i.node.serviceObbInRenderSR)),(0,a.pC)(i.ref)&&((0,P.WD)(i.ref.renderMbs),(0,P.VL)(i.ref.serviceObbInRenderSR))}function F(i){return(0,P.HV)(i,-2)}function M(i){return(0,P.HV)(i,2)}function T(i,e){return e+(i?1:0)}function A(i,e){return(-2&i)===e}function W(i){return 1==(1&i)}function E(i,e){return 0===e?0:i/e|0}function Q(i,e){return 0===e?i:i%e}const z=[["maxScreenThreshold",c.w5.MaxScreenThreshold],["screenSpaceRelative",c.w5.ScreenSpaceRelative],["removedFeatureDiameter",c.w5.RemovedFeatureDiameter],["distanceRangeFromDefaultCamera",c.w5.DistanceRangeFromDefaultCamera]];class de{constructor(){this.known=0,this.knownNodes=0,this.missing=0,this.missingNodes=0,this.unremoved=0}}function pe(i){return Math.sqrt(i*(4/Math.PI))}var De=u(73683);class Ze{constructor(e){this._layerView=e,this._lodGlobalDirty=!1}startNodeLoading(e,t,s,r){this._maxLodLevel=r.maxLodLevel,this._index=s,this._isNodeInScaleBounds=e,this._removeNodes=t}shouldLoadNode(e){if((0,a.Wi)(e))return!1;const t=this._index.nodeTraversalState(e);return!!this._isChosenMaxLOD(t)||!!t.isChosen&&this._childrenRequireLoading(e)}setLodGlobalDirty(){this._lodGlobalDirty=!0}get requiresLODGlobalHandling(){return null!=this._index&&!0===this._lodGlobalDirty}lodGlobalHandling(e){if(!this.requiresLODGlobalHandling)return!1;this._lodGlobalDirty=!1;const s=Math.max(0,Math.floor(10*(this._layerView.view.resourceController.memoryController.usedMemory-1)));le.clear(),this._lodGlobalHandling(this._index.rootNode,s,!1,!!this._layerView.nodeCrossfadingEnabled);const r=le.length;this._removeNodes(le,e);const n=le.length<r;return 0!==le.length&&(this._lodGlobalDirty=!0),le.clear(),n}_lodGlobalHandling(e,t,s,r){if((0,a.Wi)(e))return!1;const n=e.index,d=this._index,o=this._layerView,m=d.nodeTraversalState(e),L=this._isChosenMaxLOD(m);if(L&&!e.resources.hasFeatureData)return e.childrenLoaded>0&&this._removeChildrenRecursive(e),!0;const v=o.isNodeLoaded(n);if(r&&v&&L){const w=!s&&this.hasNoVisibleChildren(e);o.fadeNode(n,De.B.FadeIn,!w)}const S=v&&(!o.isNodeFullyFadedIn||o.isNodeFullyFadedIn(n));if(v&&(o.updateNodeState(n,L?c.FE.Leaf:c.FE.Hole),L))return S&&this._removeChildrenRecursive(e),S;const B=e.childCount>0;let D=B;if(B)for(let w=0;w<e.childCount;w++){const G=d.getChildIndex(n,w),he=d.getNode(G);(0,a.pC)(he)?d.isGeometryVisible(G)&&!this._lodGlobalHandling(he,t,s||S,r)&&this._isNodeInScaleBounds(he)&&(D=!1):d.isNodeVisible(G)&&(D=!1)}const K=v&&!L&&(D||le.length<t);return K&&le.push(n),!r||K||!v||s||D||o.fadeNode(n,De.B.FadeIn,!1),D||S&&!K||!e.resources.hasFeatureData}_removeChildrenRecursive(e){this._index.traverseChildren(e,t=>((this._layerView.isNodeLoaded(t.index)||this._layerView.isNodeReloading(t.index))&&le.push(t.index),t.childrenLoaded>0))}hasNoVisibleChildren(e){let t=!0;return this._index.traverseChildren(e,s=>!(!t||!this._index.isNodeVisible(s.index))&&(this._layerView.isNodeLoaded(s.index)?(t=!1,!1):s.childrenLoaded>0)),t}_childrenRequireLoading(e){let t=!1,s=!0;return this._index.traverseChildren(e,r=>{if(!s||!this._index.isNodeVisible(r.index))return!1;const n=this._index.nodeTraversalState(r);return this._isChosenMaxLOD(n)&&this._index.isGeometryVisible(r.index)&&(t=!0),this._layerView.isNodeLoaded(r.index)?(s=!1,!1):r.childrenLoaded>0}),s&&t}_isChosenMaxLOD(e){return e.isChosen&&(!e.nodeHasLOD||e.lodLevel===this._maxLodLevel)}}const le=new U.Z({deallocator:null});var ze=u(15861),fe=u(59213),Ye=u(58817),Ae=u(21726),Ne=u(81937),Re=u(92852),Pe=u(42767);class Ce{constructor(e,t,s,r,n,d){if(this._streamDataController=t,this._logger=s,this._defaultGeometrySchema=r,this._requiredAttributes=n,this._options=d,this._logLayer=e,this._layerUrl=e.parsedUrl.path,this._geometryDefinitions=e.geometryDefinitions,e.materialDefinitions){const o=e.textureSetDefinitions;this._materialAndTextures=e.materialDefinitions.map(m=>(0,Pe.R0)(o,m))}}_load(e,t,s){return this._streamDataController.request(e,t,s)}_loadAttribute(e,t,s){return this._load(`${this._layerUrl}/nodes/${e.resources.attributes}/attributes/${t.key}/0`,"binary",s).then(n=>(0,Re.qM)(t,n))}loadAttributes(e,t,s){return(0,p.as)(t.map(r=>this._loadAttribute(e,r.attributeStorageInfo,s))).then(r=>{const n={};for(let d=0;d<t.length;++d){const o=r[d].value;if(o)n[t[d].name]=o;else{if((0,p.D_)(r[d].error))throw r[d].error;this._logger.error("#loadAttributes",this._logLayer,`Failed to load attributeData for '${t[d].name}' on node '${e.id}'`,r[d].error)}}return n})}loadNodeData(e,t){var s=this;return(0,ze.Z)(function*(){const r=null!=s._requiredAttributes&&e.resources.attributes?(0,fe.q6)(s.loadAttributes(e,s._requiredAttributes,t)):null,{bufferDefinition:n,bufferIndex:d}=function tt(i,e){const t={bufferDefinition:null,bufferIndex:0},s=e.resources.geometryDefinition;if(null==i||null==s||s<0)return t;const r=s>=0?i[s].geometryBuffers:null;if(null==r)return t;for(let n=0;n<r.length;n++){const d=r[n];if(null==d.compressedAttributes)t.bufferIndex=n,t.bufferDefinition=r[n];else if("draco"===d.compressedAttributes.encoding&&!(0,C.Z)("disable-feature:i3s-draco"))return t.bufferIndex=n,t.bufferDefinition=d,t}return t}(s._geometryDefinitions,e),o=!!e.resources.geometry,m=o?(0,fe.q6)(s._loadGeometry(e.resources.geometry,d,t)):null,L=e.resources.hasSharedResource?yield s._loadShared(e,t):null,V=e.resources.materialDefinition,v=s._materialAndTextures&&null!=V&&V>=0?s._materialAndTextures[V]:null!=L?(0,Pe.Pg)(L):null,S=v?.material,B=v?.textures??[],D=`${e.id}`,K=!o&&s._options.loadFeatureData,ie=K?yield s._loadFeatureData(D,t):null,w=K?function Je(i){if(!i)return null;for(const e of i.featureData){const t=e.geometries;if(null!=t)for(const s of t)return{featureIds:[e.id],featureDataPosition:e.position,geometries:[s]}}return null}(ie):function Xe(i){return{featureIds:[],geometries:[{type:"ArrayBufferView",params:{material:i}}],featureDataPosition:[0,0,0]}}(S),G=(0,a.Wi)(w)?function qe(i){if(!i)return null;const e=new Array;for(const t of i.featureData)null!=t.position&&e.push({featureIds:[t.id],featureDataPosition:t.position,geometries:[]});return e}(ie):null,he=B.length>0?(0,fe.q6)(s.loadTextures(e,B,t)):null;let Fe=null,Te=null;if(m){Fe=(0,fe.w6)(yield m);const mt=function et(i,e){if(!i||!e||!e.materialDefinitions)return i;const t=Object.keys(e.materialDefinitions)[0];return!e.materialDefinitions[t].params.vertexRegions&&i.vertexAttributes.region&&delete(i=(0,Ye.d9)(i)).vertexAttributes.region,i}(s._defaultGeometrySchema,L);Te=(0,Re.Es)(n,mt)}const $e=he?(0,fe.w6)(yield he):null,ke=r?(0,fe.w6)(yield r):{},Ke=ke?{attributeData:ke,loadedAttributes:s._requiredAttributes}:null;if((0,a.pC)(w))return{geometryData:w,attributeDataInfo:Ke,geometryBuffer:Fe,geometryDescriptor:Te,requiredTextures:B,textureData:$e};if((0,a.pC)(G))return{pointData:G,attributeDataInfo:Ke,geometryBuffer:Fe,geometryDescriptor:Te,requiredTextures:B,textureData:$e};throw new Error})()}static _addAbsoluteHrefTexture(e,t){const s=e.textureDefinitions;if(null!=s)for(const r of Object.keys(s))for(const n of s[r].images)n.hrefConcat=Array.isArray(n.href)?n.href.map(d=>(0,Ae.hF)(d,t)):(0,Ae.hF)(n.href,t)}static _fixTextureEncodings(e){const t=e.textureDefinitions;if(null!=t)for(const s in t){const r=t[s];if(Array.isArray(r.encoding))for(let n=0;n<r.encoding.length;n++){const d=r.encoding[n];"data:"===d.substring(0,5)&&(r.encoding[n]=d.substring(5))}else{const n=r.encoding;"data:"===n.substring(0,5)&&(r.encoding=n.substring(5))}}}_loadShared(e,t){const s=`${this._layerUrl}/nodes/${e.resources.geometry}/shared`;return this._load(s,"json",t).then(r=>(Ce._fixTextureEncodings(r),Ce._addAbsoluteHrefTexture(r,s),r))}_loadTexture(e,t,s,r,n,d){let o=!1;return n===Ne.j.DDS_S3TC||n===Ne.j.KTX2||n===Ne.j.Basis?this._load(e,"binary",d).then(m=>({id:t,usage:s,data:m,encoding:n,downsampled:o})):this._load(e,"image",d).then(m=>{let L=m;if(r&&m.width*m.height>=4096){const S=Math.ceil(m.width/2),B=Math.ceil(m.height/2),D=document.createElement("canvas");D.width=S,D.height=B,D.getContext("2d").drawImage(m,0,0,S,B),L=D,o=!0}return{id:t,usage:s,data:L,encoding:n,downsampled:o}})}loadTextures(e,t,s){const r=!!this._options.uncompressedTextureDownsamplingEnabled,n=this._options.textureUsageMask;return Promise.all(t.map(d=>{if(!(d.usage&n))return null;const o=(0,Pe.nn)(d.encodings,this._options.textureEncodings);return null==o?(this._logger.error("#loadTextures",this._logLayer,`No known encoding for texture found on node ${e.id}`),Promise.reject()):this._loadTexture(`${this._layerUrl}/nodes/${e.resources.texture||e.id}/textures/${o.name}`,d.id,d.usage,r,o.encoding,s)}))}_loadFeatureData(e,t){return this._load(`${this._layerUrl}/nodes/${e}/features/0`,"json",t)}_loadGeometry(e,t,s){return this._load(`${this._layerUrl}/nodes/${e}/geometries/${t}`,"binary",s)}}class Ve{constructor(e,t){this._requester=e,this._apiKey=t,this._activeRequests=new Set}get busy(){return this._requester.busy}request(e,t,s){const r=new AbortController,n=(0,p.$F)(s,()=>r.abort()),o=this._requester.request(e,t,{signal:r.signal,query:{token:this._apiKey}}),m={response:o,abortController:r,abortHandle:n};return this._activeRequests.add(m),(0,p.Bx)(o,()=>{m.abortController=null,m.abortHandle?.remove(),m.abortHandle=null,this._activeRequests.delete(m)}),o}cancelAll(){this._activeRequests.forEach(e=>{e.abortController?.abort(),e.abortController=null,e.abortHandle?.remove()}),this._activeRequests.clear()}}var be=u(28093),it=u(993),st=u(92383),rt=u(81863),Ie=u(8834),nt=u(37053),at=u(97126),Ue=u(81468),ot=u(79112),je=u(74746);class dt{constructor(e,t,s,r,n,d,o,m,L={}){this._indexSR=e,this._renderCoordsHelper=t,this._clippingArea=n,this._elevationProvider=d,this._viewingMode=o,this._options=L,this._frustum=(0,Ie.Ue)(),this._useFrustumCulling=!1,this._poi=(0,be.c)(),this._elevationContext=null,this.minDistance=1/0,this.maxDistance=0,this.maxLodLevel=2,this._tmpObb=(0,l.Ue)(),this._tmp1=(0,be.c)(),this._tmp2=(0,be.c)(),this._tmp3=(0,be.c)(),this._tmp0=(0,be.c)(),this._screenspaceErrorBias=L.screenspaceErrorBias||1,this._progressiveLoadFactor=L.progressiveLoadFactor||1,this.updateCamera(s,r),this.engineSR=this._renderCoordsHelper.spatialReference,this.updateElevationInfo(m),this._tmpPoint=(0,re.Tx)(0,0,0,e),this._isECEFOBBInLocalMode=this._indexSR.isWGS84&&(this.engineSR.isWebMercator||(0,nt.QM)(this.engineSR)),this._indexSREllipsoidRadius=(0,st.Iu)(this._indexSR).radius}updateElevationInfo(e){null!=e?(this._elevationContext=ot.o.fromElevationInfo(e),this._elevationContext.updateFeatureExpressionInfoContext((0,je.bw)((0,je.WI)(e,!1)))):this._elevationContext=null}updateCamera(e,t){this._useFrustumCulling=t,t&&(0,Ie.q_)(e.viewMatrix,e.projectionMatrix,this._frustum),this._screenSizeFactor=1/(e.perScreenPixelRatio/2),this._camPos=e.eye,this.minDistance=1/0,this.maxDistance=0}setPointOfInterest(e){this._poi=e}updateScreenSpaceErrorBias(e){const t=this._screenspaceErrorBias;return this._screenspaceErrorBias=e,t}updateClippingArea(e){this._clippingArea=e}getElevationRange(e){if((0,a.Wi)(this._elevationContext))return null;const t=e.mbs;if(!t)return null;const s=t[0],r=t[1],n=t[2],o="relative-to-scene"===this._elevationContext.mode?"scene":"ground";if(this._elevationProvider.getSphereElevationBounds)return this._elevationProvider.getSphereElevationBounds(s,r,n,t[3],this._indexSR,o);const m=this._elevationProvider.getElevation(s,r,n,this._indexSR,o);return(0,a.pC)(m)?{min:m,max:m}:null}getRenderMbs(e){const t=e.renderMbs;return(0,P.c$)(t)||(e.mbs&&(0,it.c)(t,e.mbs),this._elevationContext&&t[3]<1e5&&(this._tmpPoint.x=t[0],this._tmpPoint.y=t[1],this._tmpPoint.z=t[2],t[2]=(0,Ue.w7)(this._tmpPoint,this._elevationProvider,this._elevationContext,this._renderCoordsHelper)),(0,q.st)(t,this._indexSR,t,this.engineSR)),t}getVisibilityObb(e){if((0,a.pC)(e.visibilityObb))return e.visibilityObb;const t=e.serviceObb,s=.01*this._indexSREllipsoidRadius;return(0,a.Wi)(t)||!e.mbs||!(0,P.vH)(t)||this._isECEFOBBInLocalMode&&t.halfSize.some(r=>r>s)?null:(e.serviceObbInRenderSR=this._computeRenderObb(t,e.serviceObbInRenderSR,e.mbs[3],e.elevationRange),e.serviceObbInRenderSR)}_computeRenderObb(e,t,s,r){if((0,a.Wi)(t))t=(0,l.Ue)();else if((0,P.vH)(t))return t;let n=0,d=0;if(this._elevationContext&&(0,a.pC)(r)&&Number.isFinite(r.min))switch(this._elevationContext.mode){case"relative-to-ground":n=this._elevationContext.geometryZWithOffset(e.center[2],this._renderCoordsHelper)+r.min-e.center[2],d=r.max-r.min;break;case"on-the-ground":n=r.min-e.center[2],d=r.max-r.min}else this._elevationContext&&s<1e5&&(this._tmpPoint.x=e.center[0],this._tmpPoint.y=e.center[1],this._tmpPoint.z=e.center[2],n=(0,Ue.w7)(this._tmpPoint,this._elevationProvider,this._elevationContext,this._renderCoordsHelper)-e.center[2]);return d>0?((0,P.jv)(e,this._indexSR,this._tmpObb,this.engineSR,n),(0,l.gI)(this._tmpObb,0,d,this._viewingMode,t)):(0,P.jv)(e,this._indexSR,t,this.engineSR,n),t}isNodeVisible(e){const t=this.getRenderMbs(e);if(!this._isMBSinClippingArea(t))return!1;if(!this._useFrustumCulling)return!0;const s=this.getVisibilityObb(e);return(0,a.pC)(s)?(0,l.pn)(s,this._frustum):(0,Ie.hr)(this._frustum,(0,at.w)(t))}isGeometryVisible(e){if(!this._useFrustumCulling)return!0;const t=e.geometryObb;return(0,a.pC)(t)?(0,l.pn)(t,this._frustum):this.isNodeVisible(e)}_isMBSinClippingArea(e){return!!(0,a.Wi)(this._clippingArea)||(0,P.cr)(this._clippingArea,e)!==P.pD.OUTSIDE}_screenSpaceDiameterMbs(e,t){const s=this.getRenderMbs(e),r=Math.sqrt((0,R.d)(s,this._camPos)),n=r-s[3];return this._updateMinMaxDistance(r),n<0?.5*Number.MAX_VALUE:t/n*this._screenSizeFactor}calcCameraDistance(e){return this.calcCameraDistanceToCenter(e)-this.getRenderMbs(e)[3]}calcCameraDistanceToCenter(e){const t=this.getRenderMbs(e),s=(0,R.i)(t,this._camPos);return this._updateMinMaxDistance(s),s}calcAngleDependentLoD(e){const t=this.getRenderMbs(e),s=t[3],r=(Math.abs(t[0]*(t[0]-this._camPos[0])+t[1]*(t[1]-this._camPos[1])+t[2]*(t[2]-this._camPos[2]))/(0,R.l)(t)+s)/(0,R.i)(t,this._camPos);return Math.min(1,r)}hasLOD(e){return e.lodMetric!==c.w5.None}_getDistancePlanarMode(e,t){const s=e[0]-t[0],r=e[1]-t[1],n=e[2]-t[2],d=s*s+r*r,o=t[3];if(d<=o*o)return Math.abs(n);const m=Math.sqrt(d)-o;return Math.sqrt(n*n+m*m)}_getDistanceGlobeMode(e,t){const s=(0,R.l)(t),r=(0,R.l)(e)-s;(0,R.g)(this._tmp0,e,(0,R.e)(e,t)/(0,R.p)(e));const n=(0,R.d)(t,this._tmp0),d=t[3];if(n<=d*d)return Math.abs(r);{const o=(0,R.g)(this._tmp0,t,1/s),V=(0,R.g)(this._tmp1,o,s-d*d/2/s),v=e,S=(0,R.b)(this._tmp2,v,V),B=(0,R.b)(this._tmp2,S,(0,R.g)(this._tmp3,o,(0,R.e)(o,S))),D=(0,R.a)(this._tmp2,V,(0,R.g)(this._tmp2,B,d/(0,R.l)(B)));let K=(0,R.i)(v,D);if(r>=2e5){const ie=(0,R.b)(this._tmp1,v,D);let w=(0,R.e)(ie,o)/(0,R.l)(ie);w<.08&&(w=1e-4),K/=w}return K}}_getDistance(e,t){return this.engineSR===(0,rt.rS)(this.engineSR)?this._getDistanceGlobeMode(e,t):this._getDistancePlanarMode(e,t)}_updateMinMaxDistance(e){e>0?(this.minDistance=Math.min(this.minDistance,e),this.maxDistance=Math.max(this.maxDistance,e)):(this.minDistance=0,this.maxDistance=Math.max(this.maxDistance,-e))}getLodLevel(e){if(e.lodMetric===c.w5.None)return 0;if(0===e.childCount)return this.maxLodLevel;if(this._useFrustumCulling&&this._progressiveLoadFactor<1){const s=this._screenspaceErrorBias;return this.evaluateLODmetric(e,this._progressiveLoadFactor*this._screenspaceErrorBias)?this.evaluateLODmetric(e,s)?2:1:0}return this.evaluateLODmetric(e,this._screenspaceErrorBias)?this.maxLodLevel:0}evaluateLODmetric(e,t){switch(e.lodMetric){case c.w5.ScreenSpaceRelative:{const s=this.getRenderMbs(e),r=this._getDistance(this._camPos,s),n=2*r/this._screenSizeFactor;return this._updateMinMaxDistance(r+s[3]),e.maxError*t<=n}case c.w5.MaxScreenThreshold:{let s=this._screenSpaceDiameterMbs(e,e.mbs[3]*t);return this._options.angleDependentLoD&&(s*=this.calcAngleDependentLoD(e)),s<e.maxError}case c.w5.RemovedFeatureDiameter:return this._screenSpaceDiameterMbs(e,e.maxError)*t<10;case c.w5.DistanceRangeFromDefaultCamera:return this.calcCameraDistance(e)>e.maxError*t}return!1}distToPOI(e){const t=this.getRenderMbs(e);return(0,R.i)(t,this._poi)-t[3]}distCameraToPOI(){return(0,R.i)(this._camPos,this._poi)}}var lt=u(55745),Le=u(39135),Oe=u(93579);const Be="esri.layers.graphics.controllers.I3SOnDemandController",ve=Z.Z.getLogger(Be),Se=1e-4;let $=class extends((0,J.v)(O.Z)){get isMeshPyramid(){return"mesh-pyramids"===this.layer.profile||"MeshPyramid"===this.layer.store?.lodType}get isGraphics3D(){return"points"===this.layer.profile}get useMaximumNumberOfFeatures(){return!this.isMeshPyramid&&((0,a.Wi)(this.layer.priority)||"High"===this.layer.priority)}get indexStreamController(){const i=this.layerView.view.resourceController.createStreamDataRequester(Le.Bh.I3S_INDEX);return new Ve(i,this.layer.apiKey)}get dataStreamController(){const i=this.layerView.view.resourceController.createStreamDataRequester(Le.Bh.I3S_DATA);return new Ve(i,this.layer.apiKey)}get crsVertex(){return(0,P.T2)(this.layer)}get crsIndex(){return(0,P.tp)(this.layer)}get layer(){return this.layerView.i3slayer}get running(){return this.updating}get rootNodeVisible(){if((0,a.pC)(this._index)){const i=this._index.rootNode;if((0,a.pC)(i))return this._updateViewData(),this._index.isNodeVisible(i.index)}return!0}get index(){return this._index}constructor(i){super(i),this.screenSizeFactor=0,this.featureTarget=5e4,this.fixedFeatureTarget=!1,this.updating=!0,this.updatingProgress=1,this.leavesReached=!1,this.scaleVisibilityEnabled=!0,this._featureLOD=1,this._stableFeatureLOD=!1,this._isIdle=!1,this._cameraDirty=!0,this._invisibleDirty=!1,this._idleStateCallbacks=null,this._newLoadingNodes=new U.Z({deallocator:null}),this._loadedNodeScales=new Map,this._modificationsNodeFilteringArray=new U.Z,this._downloadingCount=0,this._loadingNodes=new Map,this._updatingNodes=new Map,this._progressMaxNumNodes=1,this._requiredAttributes=new Array,this._requiredAttributesDirty=!0,this._updatesDisabled=!1,this.disableIDBCache=!1,this._disableMemCache=!1,this._restartNodeLoading=!1,this._fields=null,this._attributeStorageInfo=null,this._handles=new b.Z,this._idleQueue=new oe.b,this._elevationUpdateNodes=new U.Z({deallocator:null}),this._errorCount=0}initialize(){const{layerView:i,layer:e}=this;this._disableMemCache=!i.loadCachedGPUData||!i.addCachedGPUData,this._lodHandling=new Ze(i),this._defaultGeometrySchema=e.store.defaultGeometrySchema,this.disableIDBCache=(0,C.Z)("disable-feature:idb-cache"),"fields"in e&&(this._fields=e.fields,this._attributeStorageInfo=e.attributeStorageInfo),this.addResolvingPromise(Promise.all([e.indexInfo,e.when(),i.when()]).then(([t])=>{if(this.destroyed||!i||i.destroyed||!t)return;const{view:s}=i,{resourceController:r}=s;this._setClippingArea(s.clippingArea),this.addHandles([(0,H.YP)(()=>s?.pointsOfInterest?.focus?.renderLocation,n=>this._pointOfInterestChanged(n),H.nn),(0,H.YP)(()=>r.memoryController.memoryFactor,()=>this._setCameraDirty(),H.Z_),(0,H.YP)(()=>i.suspended,n=>{const d=n?()=>this._updateViewData():()=>this._updateIdleState(!0),o=n?()=>{}:()=>this._updateIdleState(!1);!n&&(0,a.pC)(this._index)&&this._index.invalidateAllElevationRanges(),this._idleStateCallbacks?(n&&this.cancelNodeLoading(),this.restartNodeLoading(),this._idleStateCallbacks.idleBegin=d,this._idleStateCallbacks.idleEnd=o):this._idleStateCallbacks=r.scheduler.registerIdleStateCallbacks(d,o)},H.nn),k(i.view.resourceController.scheduler,this),(0,H.YP)(()=>i.uncompressedTextureDownsamplingEnabled,()=>this.restartNodeLoading()),(0,H.YP)(()=>[this.featureTarget,this.fixedFeatureTarget],()=>{this._setCameraDirty(),this._stableFeatureLOD=!1}),(0,H.YP)(()=>s.state?.contentCamera,()=>this._setCameraDirty()),(0,H.YP)(()=>e.elevationInfo,n=>this._elevationInfoChanged(n)),(0,H.YP)(()=>e.effectiveScaleRange,()=>this._scaleBoundsChanged()),(0,H.YP)(()=>i.lodFactor,()=>this._setCameraDirty()),(0,H.YP)(()=>i.availableFields,()=>this._requiredFieldsChange()),(0,H.YP)(()=>i.holeFilling,n=>(0,a.pC)(this._index)&&(this._index.holeFilling=n))]),this._updateScaleHandles(),this._viewportQueries=new dt(this.crsIndex,s.renderCoordsHelper,s.state.contentCamera,!s.state.fixedContentCamera||this.isGraphics3D,this._clippingArea,this.isMeshPyramid?s.basemapTerrain:s.elevationProvider,(0,ue.wg)(s.viewingMode),this.layer.elevationInfo,{progressiveLoadFactor:this._getProgressiveLoadFactor(),screenspaceErrorBias:this._lod,angleDependentLoD:this._lod<.5}),this._index=new _(e,t,this.indexStreamController,this._viewportQueries,ve,i.holeFilling,n=>i.isNodeLoaded(n),n=>i.isNodeReloading(n),n=>this._shouldLoadNode(n),n=>this._enableFromGPUCache(n,c.FE.Leaf),n=>this._needsUpdate(n),()=>!this.indexStreamController.busy,n=>i.computeVisibilityObb?i.computeVisibilityObb(n):null,i?.computeNodeFiltering?n=>i.computeNodeFiltering(n):void 0),this._index.updateElevationInfo(this.layer.elevationInfo,this.isMeshPyramid),this._index.imModificationsChanged(!!i.hasModifications),this._startNodeLoading()})),this._tmpPoint=(0,re.Tx)(0,0,0,this.crsIndex)}updateNodeModificationStatus(i){const e=this._index,t=this.layerView;(0,a.pC)(e)&&t?.updateNodeModificationStatus&&(this._modificationsNodeFilteringArray.clear(),i.forAll(s=>{const r=e.getNode(s);(0,a.pC)(r)&&this._modificationsNodeFilteringArray.push(r)}),t.updateNodeModificationStatus(this._modificationsNodeFilteringArray),this._invisibleDirty=!0)}destroy(){this.cancelNodeLoading(),this._idleStateCallbacks&&(this._isIdle=!1,this._idleStateCallbacks.remove(),this._idleStateCallbacks=null),this._handles.destroy(),this._nodeLoader=null,ne.prune(),(0,a.pC)(Me)&&(Me.hide(),Me=null)}_getRequiredAttributes(){if(null==this._attributeStorageInfo||!this._fields||!this.layerView.availableFields)return[];const i=this._attributeStorageInfo,e=this._fields,t=this.layer.objectIdField;return this.layerView.availableFields.map(s=>{const r=we(i,s),n=we(e,s);return r>=0&&n>=0?{index:r,name:e[n].name,field:e[n],attributeStorageInfo:i[r]}:null}).filter(s=>null!=s&&s.name!==t)}_requiredFieldsChange(){const i=this._getRequiredAttributes();Ee(this._requiredAttributes,i)||(this._requiredAttributes=i,this._requiredAttributesDirty=!1,this.restartNodeLoading())}requestUpdate(){this._requiredAttributesDirty=!0,this.restartNodeLoading()}_setClippingArea(i){const e=(0,ae.Ue)();this._clippingArea=(0,lt.G)(i,e,this.layerView.view.renderSpatialReference)?e:null}_pointOfInterestChanged(i){(0,a.pC)(this._viewportQueries)&&(this._viewportQueries.setPointOfInterest(i),(0,a.pC)(this._index)&&(this._index.progressiveLoadPenalty=Qe.distancePenalty*this._viewportQueries.distCameraToPOI(),this._index.requestUpdate()))}updateClippingArea(i){this._setClippingArea(i),(0,a.pC)(this._viewportQueries)&&(0,a.pC)(this._index)&&(this._viewportQueries.updateClippingArea(this._clippingArea),this._index.invalidateVisibilityCache()),this._setCameraDirty()}_setCameraDirty(){this._cameraDirty=!0,this._lodHandling.setLodGlobalDirty(),this._evaluateUpdating()}updateElevationChanged(i,e){const t=this._index;if((0,a.Wi)(t)||(0,a.Wi)(t.rootNode)||(0,a.Wi)(e))return null;this.crsIndex.equals(e)||((0,q.dH)(i,e,xe,this.crsIndex),i=xe);const s=this._elevationUpdateNodes;return s.clear(),(0,P.tS)(i,t.rootNode,t,r=>s.push(r.index)),s.length&&(s.forAll(r=>t.updateElevationChanged(r)),this._setCameraDirty()),s}getParentIndex(i){return(0,a.pC)(this._index)?this._index.getParentIndex(i):-1}removeAllGeometryObbs(){(0,a.pC)(this._index)&&this._index.removeAllGeometryObbs()}getRenderMbs(i){return(0,a.pC)(this._viewportQueries)?this._viewportQueries.getRenderMbs(i):null}_elevationInfoChanged(i){(0,a.Wi)(this._index)||(this._index.updateElevationInfo(i,this.isMeshPyramid),this._setCameraDirty())}_updateScaleHandles(){const i="scale-bounds";this._handles.remove(i),this._areScaleBoundsActive&&this._handles.add(this.layerView.view.basemapTerrain.on("scale-change",e=>this._scaleUpdateHandler(e)),i)}_scaleBoundsChanged(){this._areScaleBoundsActive||this._loadedNodeScales.clear(),this._updateScaleHandles(),this._setCameraDirty()}_scaleUpdateHandler(i){this._updateScaleInBoundingRect(i.extent,i.spatialReference),this._setCameraDirty()}_updateScaleInBoundingRect(i,e){const t=this._index;(0,a.Wi)(t)||!(0,a.Wi)(t.rootNode)&&(0,q.dH)(i,e,xe,this.crsIndex)&&this._loadedNodeScales.forEach((r,n)=>{const d=t.getNode(n);(0,a.pC)(d)&&(0,ae.hr)(xe,d.mbs)&&this._loadedNodeScales.set(n,this._computeScale(d))})}restartNodeLoading(){this._restartNodeLoading=!0,this.cancelNodeLoading(),this._evaluateUpdating()}schedule(i,e){return this._idleQueue.push(i,e)}reschedule(i,e){return this._idleQueue.unshift(i,e)}get _isIntegratedMesh(){return"integrated-mesh"===this.layer.type}get _areScaleBoundsActive(){const{minScale:i,maxScale:e}=(0,Oe.lu)(this.layer);return this.scaleVisibilityEnabled&&(i>0||e>0)}get unloadedMemoryEstimate(){return(0,a.Wi)(this._index)||this.layerView.suspended?0:this._index.unloadedMemoryEstimate*this._lodDropFactor}get indexDepth(){return(0,a.pC)(this._index)?this._index.maxLevel:0}set disableMemCache(i){this.layerView.loadCachedGPUData&&this.layerView.addCachedGPUData||(this._disableMemCache=!0),this._disableMemCache=i}runTask(i,e){return this.layerView.suspended?(this._updateViewData(),this._evaluateUpdating(),-1/0):!this.layerView.visible||(0,a.Wi)(this._index)?-1/0:(this._processWithErrorLogging(i,e),this._index.maxPriority)}_processWithErrorLogging(i,e){try{this._process(i,e)}catch(t){this._errorCount<50?ve.error("Error during processing: "+t):50===this._errorCount&&ve.error("Too many errors for this layer. Further errors will not be displayed."),this._errorCount++}}_process(i,e){this._restartNodeLoading&&this._startNodeLoading(),null==this._nodeLoader||(0,a.Wi)(this._index)||(this._updateViewData(),this._invisibleDirty&&this._removeInvisibleNodes(i)&&(this._invisibleDirty=!1),this._isIntegratedMesh&&(i.enabled=!1),i.run(()=>this._processIndex(i)),this._updateFeatureLOD(),i.run(()=>this._processCache(i)),this._isIntegratedMesh&&(i.enabled=!0),i.run(()=>this._processNodes(i,e)),this._idleQueue.runTask(i),i.run(()=>this._prefetchIndex()),e.numIndexLoading+=this._index.indexLoading,e.numNodesLoading+=this._downloadingCount,i.run(()=>this._lodHandling.lodGlobalHandling(i)),this._evaluateUpdating())}_processIndex(i){if((0,a.Wi)(this._index))return!1;if(this._index.dirty){this._newLoadingNodes.clear(),this._index.update(Array.from(this._loadingNodes.keys()),i,t=>this.updateNodeModificationStatus(t)),this._disableMemCache||(this._newLoadingNodes.pushArray(this._index.updates.add.data,this._index.updates.add.length),this._newLoadingNodes.pushArray(this._index.updates.missing.data,this._index.updates.missing.length));const e=this._index.featureEstimate.leavesReached;this._index.isLoading||e===this._get("leavesReached")||this._set("leavesReached",e)}return this._index.load()}_prefetchIndex(){return!((0,a.Wi)(this._index)||this._loadingNodes.size>0||this._index.updates.add.length>0)&&this._index.prefetch()}_updateFeatureLOD(){if(!this.useMaximumNumberOfFeatures||(0,a.Wi)(this._index)||(0,a.Wi)(this._viewportQueries))return;const i=!this._index.isLoading,e=this.featureTarget*this._baseLOD,t=this._index.featureEstimate;if(t.estimate=t.estimate||e/2,this._index.indexMissing>500){if(this._featureLOD<=Se)return;this._featureLOD/=1.5,this._stableFeatureLOD=!1}else if(i&&t.estimate<e){if(t.leavesReached||this._featureLOD>=1e4||this._stableFeatureLOD)return;const s=Math.min(10,Math.max(e/t.estimate,1.001));this._featureLOD*=s;const r=this._lod,n=this._index.checkFeatureTarget(e,r);n!==r&&(this._featureLOD=n/this._baseLOD,this._stableFeatureLOD=!0)}else{if(!(t.estimate>1.2*e||i&&t.estimate>e)||this._featureLOD<=Se)return;this._featureLOD/=1+.25*(t.estimate/e-1),this._stableFeatureLOD=!1}this._featureLOD=Math.min(1e4,Math.max(Se,this._featureLOD)),this._viewportQueries.updateScreenSpaceErrorBias(this._lod),this._index.requestUpdate()}_processCache(i){const e=this._index;if((0,a.Wi)(e))return!1;for(;this._newLoadingNodes.length>0&&!i.done;){const t=this._newLoadingNodes.pop();for(let s=e.getParent(t);(0,a.pC)(s)&&!this.layerView.isNodeLoaded(s.index)&&this._isNodeInScaleBounds(s);s=e.getParent(s.index))if(this._enableFromGPUCache(s,c.FE.Hole)){i.madeProgress();break}}return i.hasProgressed}_processNodes(i,e){if((0,a.Wi)(this._index))return!1;let t=(this._isIdle?100:2)-this._loadingNodes.size;const s=this._index.updates;for(s.cancel.forEach(this._cancelNode,this),s.cancel=[];s.remove.length>0&&!i.done;)this.layerView.removeNode(s.remove.pop()),i.madeProgress();for(;s.update.length>0&&!i.done;){const r=this._index.getNode(s.update.pop());(0,a.pC)(r)&&(this._updateLoadedNode(r),i.madeProgress())}for(;s.add.length>0&&!i.done&&t>0;){--t;const r=this._index.getNode(s.add.back());if((0,a.Wi)(r)||r.cacheState!==c.Hw.Cached&&!this._hasNodeLoadToken(e))break;s.add.pop(),this._loadNode(r),i.madeProgress()}return i.hasProgressed}_cancelAllNodes(){this._loadingNodes.forEach(i=>i.abort()),this._loadingNodes.clear(),this._updatingNodes.forEach(i=>i.abort()),this._updatingNodes.clear()}_cancelNode(i){const e=this._loadingNodes.get(i);e&&(e.abort(),this._loadingNodes.delete(i))}_hasNodeLoadToken(i){return!(!this._isIdle&&i.numNodesLoading+this._loadingNodes.size>=2)&&this._downloadingCount<Le.NT&&!this.dataStreamController.busy}_evaluateUpdating(){let i=!1,e=0;if(this.layerView.suspended)i=this._cameraDirty,e=i?0:1;else{const t=((0,a.pC)(this._index)?this._index.indexMissing:0)+3*((0,a.pC)(this._index)?this._index.updates.add.length:0)+2*this._loadingNodes.size;i=!!(t>0||this._updatingNodes.size>0||this._restartNodeLoading||this._cameraDirty||this._idleQueue.running||this._lodHandling&&this._lodHandling.requiresLODGlobalHandling||(0,a.pC)(this._index)&&this._index.isPrefetching),0===t&&(this._progressMaxNumNodes=1),this._progressMaxNumNodes=Math.max(t,this._progressMaxNumNodes),e=1-t/this._progressMaxNumNodes}this.updating=i,this.updatingProgress=e}_updateViewData(){if(!this._cameraDirty||(0,a.Wi)(this._index)||(0,a.Wi)(this._viewportQueries))return;const i=this.layerView.view,{contentCamera:e,fixedContentCamera:t}=i.state;this.screenSizeFactor=1/(e.perScreenPixelRatio/2),this._viewportQueries.updateCamera(e,!t||this.isGraphics3D),this._viewportQueries.setPointOfInterest(i.pointsOfInterest.focus.renderLocation),this._viewportQueries.updateScreenSpaceErrorBias(this._lod),this._index.invalidateVisibilityCache(),this._index.progressiveLoadPenalty=Qe.distancePenalty*this._viewportQueries.distCameraToPOI(),this._index.requestUpdate(),this._stableFeatureLOD=!1,this._invisibleDirty=!0,this._cameraDirty=!1,this.notifyChange("rootNodeVisible")}_getProgressiveLoadFactor(){return this.layerView.view.resourceController.memoryController.memoryFactor<1?1:this.layerView.progressiveLoadFactor}get _lod(){return this._featureLOD*this._baseLOD}get _baseLOD(){const i=this.layerView.lodFactor;return this.fixedFeatureTarget?1:(i>0?i:1)*this.layerView.view.resourceController.memoryController.memoryFactor}get _lodDropFactor(){if(this.fixedFeatureTarget)return 1;const i=this.layerView.view.resourceController.memoryController;return(Math.min(i.memoryFactor,.5)-i.minQuality)/(.5-i.minQuality)}isGeometryVisible(i){return(0,a.pC)(this._index)&&this._index.isGeometryVisible(i.index)}updateVisibility(i){(0,a.pC)(this._index)&&this._index.invalidateNodeVisibilityCache(i)}invalidateGeometryVisibility(i){(0,a.pC)(this._index)&&this._index.invalidateGeometryVisibility(i)}invalidateVisibilityObbs(){(0,a.pC)(this._index)&&this._index.invalidateVisibilityObbs()}modificationsChanged(){(0,a.pC)(this._index)&&this._index.imModificationsChanged(!!this.layerView.hasModifications),this._invisibleDirty=!0}_shouldLoadNode(i){return!(!this._lodHandling.shouldLoadNode(i)||this._shouldDropNode(i))&&!((0,a.Wi)(this._index)||!this._index.isGeometryVisible(i.index))&&this._isNodeInScaleBounds(i)}_shouldDropNode(i){if((0,a.Wi)(this._viewportQueries))return!1;const e=this._lodDropFactor;return!(e>=1||!this._lodHandling.hasNoVisibleChildren(i))&&Math.abs(this._viewportQueries.calcCameraDistanceToCenter(i))-this._viewportQueries.minDistance>(this._viewportQueries.maxDistance-this._viewportQueries.minDistance)*e}_startNodeLoading(){this._restartNodeLoading=!1;const i=this._index;this._updatesDisabled||(0,a.Wi)(i)||(0,a.Wi)(this._viewportQueries)||(this._updateViewData(),this._requiredAttributesDirty&&(this._requiredAttributes=this._getRequiredAttributes(),this._requiredAttributesDirty=!1),this._nodeLoader=new Ce(this.layer,this.dataStreamController,ve,this._defaultGeometrySchema,this._requiredAttributes,{textureEncodings:this.layerView.supportedTextureEncodings,uncompressedTextureDownsamplingEnabled:this.layerView.uncompressedTextureDownsamplingEnabled,textureUsageMask:this.layerView.rendererTextureUsage,loadFeatureData:this.useMaximumNumberOfFeatures}),i.requestUpdate(),this._lodHandling.startNodeLoading(t=>this._isNodeInScaleBounds(t),(t,s)=>this._removeNodes(t,s,ye.fadeout),i,{maxLodLevel:this._viewportQueries.maxLodLevel}),this._evaluateUpdating())}isNodeLoading(){return null!=this._nodeLoader&&null!=this._index}cancelNodeLoading(){this.isNodeLoading()&&(this.indexStreamController.cancelAll(),this.dataStreamController.cancelAll(),this._idleQueue.cancelAll(),this._cancelAllNodes(),this._nodeLoader=null,this._evaluateUpdating())}_removeInvisibleNodes(i){const e=this._index;if((0,a.Wi)(e)||(0,a.Wi)(this._viewportQueries))return!1;ne.clear(),this.layerView.getLoadedNodeIndices(ne);const t=0===this._viewportQueries.maxDistance,s=t?()=>!1:r=>this._shouldDropNode(r);return ne.filterInPlace(r=>{const n=e.getNode(r);return(0,a.Wi)(n)||!e.isGeometryVisible(r)||s(n)||!this._isNodeInScaleBounds(n)}),ne.length>0&&this._lodHandling.setLodGlobalDirty(),this._removeNodes(ne,i,ye.pop),!(t&&this._lodDropFactor<1||0!==ne.length&&(ne.clear(),1))}markNodeToRemove(i){ne.push(i)}removeMarkedNodes(){this._removeNodes(ne,ce.G5,ye.pop)}_removeNodes(i,e,t){const s=i.length;if(0!==s&&!e.done){for((0,a.pC)(this._index)&&this._index.requestUpdate();i.length>0&&!e.done;){const r=i.pop(),n=this._index;t===ye.fadeout&&this.layerView.nodeFadeoutEnabled&&(0,a.pC)(n)&&n.isGeometryVisible(r)?this.layerView.fadeNode(r,De.B.FadeOut,!0):this.layerView.removeNode(r),e.madeProgress()}if(this._loadedNodeScales.size>0)for(let r=i.length;r<s;r++)this._loadedNodeScales.delete(i.data[r])}}_needsUpdate(i){if(!i.resources.hasFeatureData||this._updatingNodes.has(i.index))return!1;const e=this.layerView.getLoadedAttributes(i.index);return null!=e&&e!==this._requiredAttributes}_updateLoadedNode(i){const e=new AbortController;this._updatingNodes.set(i.index,e),(Ee(this.layerView.getLoadedAttributes(i.index),this._requiredAttributes)?Promise.resolve(this.layerView.getAttributeData(i.index)):this._nodeLoader.loadAttributes(i,this._requiredAttributes,e.signal)).then(t=>this.schedule(()=>this.layerView.updateAttributes(i.index,{loadedAttributes:this._requiredAttributes,attributeData:t},e.signal),e.signal)).catch(t=>{if(!(0,p.D_)(t))return this.layerView.updateAttributes(i.index,{loadedAttributes:this._requiredAttributes,attributeData:{}},e.signal)}).catch(()=>{}).then(()=>{this._updatingNodes.delete(i.index),this._evaluateUpdating()}),this._evaluateUpdating()}_loadNode(i){if(this._loadingNodes.has(i.index))return void ve.error("already loading node "+i.index);const e=new AbortController;this._loadingNodes.set(i.index,e),this._evaluateUpdating(),this._loadAndAddNode(i,e.signal).then(t=>{t&&(0,a.pC)(this._index)&&this._loadingNodes.get(i.index)===e&&(this._loadingNodes.delete(i.index),this._index.requestUpdate())}).catch(t=>{if(!(0,p.D_)(t))throw t}).finally(()=>{this._loadingNodes.get(i.index)===e&&this._loadingNodes.delete(i.index),this._evaluateUpdating()})}_loadAndAddNode(i,e){return i.cacheState===c.Hw.Uncached?this._loadUncached(i,e).then(()=>!1):this._loadCached(i,e).then(t=>!t&&(i.cacheState=c.Hw.Uncached,!0)).catch(t=>!(0,p.D_)(t)&&(i.cacheState=c.Hw.Uncached,!0))}_enableFromGPUCache(i,e){if(this._disableMemCache||(0,a.Wi)(this._index))return!1;if(e===c.FE.Hole&&!this._index.useNodeAsHole(i.index))return!0;const t=this._loadCachedGPUData(i);return!!t&&(this.layerView.addCachedGPUData(i,t,e),this._nodeAdded(),!0)}_loadCachedGPUData(i){const e=this.layerView.loadCachedGPUData(i);return(0,a.pC)(e)&&(0,a.pC)(e.attributeInfo)&&Ee(e.attributeInfo.loadedAttributes,this._requiredAttributes)?e:(this.layerView.deleteCachedGPUData(e),null)}_nodeAdded(){(0,a.pC)(this._index)&&this._index.requestUpdate(),this._lodHandling.setLodGlobalDirty(),this._evaluateUpdating()}updateLoadStatus(i,e){const t=this._index;(0,a.pC)(t)&&t.updateChildrenLoaded(i,e?1:-1)}_loadCached(i,e){if(this._enableFromGPUCache(i,c.FE.Leaf))return Promise.resolve(!0);const t=this.layerView;return!this.disableIDBCache&&t.loadCachedNodeData&&t.addCachedNodeData?this.schedule(()=>t.loadCachedNodeData(i,e,(s,r)=>this._nodeLoader.loadTextures(i,s,r)),e).then(s=>{if((0,a.Wi)(s))return!1;const r=this._requiredAttributes;return this.reschedule(()=>this._nodeLoader.loadAttributes(i,r,e),e).then(n=>this.reschedule(()=>t.addCachedNodeData(i,s,{loadedAttributes:r,attributeData:n},e),e)).then(()=>(this._nodeAdded(),!0))}):Promise.resolve(!1)}_loadUncached(i,e){return this._downloadingCount++,this._nodeLoader.loadNodeData(i,e).catch(t=>{throw this._downloadingCount--,t}).then(t=>(this._downloadingCount--,this.schedule(()=>this.layerView.addNode(i,t,e),e))).then(()=>{this._nodeAdded(),i.cacheState=c.Hw.Cached}).catch(t=>{if(!(0,p.D_)(t))throw ve.error("#loadNodeData()",this.layer,`Failed to load node '${i.id}'`,t),i.failed=!0,(0,a.pC)(this._index)&&this._index.requestUpdate(),t})}_updateIdleState(i){i!==this._isIdle&&(this._isIdle=i,this._evaluateUpdating(),i&&this._index&&(0,a.pC)(this._index)&&this._index.resetFailedNodes())}_getScale(i){if(this._loadedNodeScales.has(i.index))return this._loadedNodeScales.get(i.index);const e=this._computeScale(i);return this.layerView.isNodeLoaded(i.index)&&this._loadedNodeScales.set(i.index,e),e}_computeScale(i){return this._tmpPoint.x=i.mbs[0],this._tmpPoint.y=i.mbs[1],this._tmpPoint.z=i.mbs[2],this.layerView.view.basemapTerrain.getSphereScale(this._tmpPoint,i.mbs[3])}_isNodeInScaleBounds(i){if(!this._areScaleBoundsActive)return!0;const e=this._getScale(i),{minScale:t,maxScale:s}=(0,Oe.lu)(this.layer);return(0,Oe.rs)(e,t,s)}updateStats(i){i.index=(0,a.pC)(this._index)?this._index.size:0,this.isGraphics3D&&(i.detail=this._featureLOD,i.target=this.featureTarget*this._baseLOD),(0,a.pC)(this._index)&&this._index.updateStats(i)}get test(){const i=this;return{index:this._index,set disableUpdates(e){i._updatesDisabled=e,e?i.cancelNodeLoading():i.requestUpdate()},set disableIDBCache(e){i.disableIDBCache=e},set ignoreServiceObb(e){(0,a.pC)(i._index)&&(i._index.ignoreServiceObb=e)},shouldLoadNode:e=>i._shouldLoadNode(e)}}notifyLODUpdate(){this._lodHandling.setLodGlobalDirty(),this._evaluateUpdating(),(0,a.pC)(this._index)&&this._index.requestUpdate()}geometryFilterChanged(i){const e=this._index;(0,a.pC)(e)&&e.layerFilterChanged(i),this._setCameraDirty()}};(0,N._)([(0,g.Cb)({readOnly:!0})],$.prototype,"isMeshPyramid",null),(0,N._)([(0,g.Cb)({readOnly:!0})],$.prototype,"isGraphics3D",null),(0,N._)([(0,g.Cb)({readOnly:!0})],$.prototype,"useMaximumNumberOfFeatures",null),(0,N._)([(0,g.Cb)({readOnly:!0})],$.prototype,"indexStreamController",null),(0,N._)([(0,g.Cb)({readOnly:!0})],$.prototype,"dataStreamController",null),(0,N._)([(0,g.Cb)({readOnly:!0})],$.prototype,"crsVertex",null),(0,N._)([(0,g.Cb)({readOnly:!0})],$.prototype,"crsIndex",null),(0,N._)([(0,g.Cb)()],$.prototype,"screenSizeFactor",void 0),(0,N._)([(0,g.Cb)()],$.prototype,"featureTarget",void 0),(0,N._)([(0,g.Cb)()],$.prototype,"fixedFeatureTarget",void 0),(0,N._)([(0,g.Cb)()],$.prototype,"layerView",void 0),(0,N._)([(0,g.Cb)()],$.prototype,"layer",null),(0,N._)([(0,g.Cb)()],$.prototype,"updating",void 0),(0,N._)([(0,g.Cb)({readOnly:!0})],$.prototype,"running",null),(0,N._)([(0,g.Cb)()],$.prototype,"updatingProgress",void 0),(0,N._)([(0,g.Cb)({readOnly:!0})],$.prototype,"leavesReached",void 0),(0,N._)([(0,g.Cb)({constructOnly:!0})],$.prototype,"scaleVisibilityEnabled",void 0),(0,N._)([(0,g.Cb)({readOnly:!0,dependsOn:[]})],$.prototype,"rootNodeVisible",null),$=(0,N._)([(0,Y.j)(Be)],$);const ne=new U.Z({deallocator:null});let Me;function Ee(i,e){return(0,a.pC)(i)&&i.length===e.length&&i.every(t=>we(e,t.name)>=0)}function we(i,e){const t=e.toLowerCase();for(let s=0;s<i.length;s++)if(i[s].name.toLowerCase()===t)return s;return-1}const Qe={factorIM:.2,factor3dObject:.05,distancePenalty:10},xe=(0,ae.Ue)();var ye,i;(i=ye||(ye={}))[i.pop=0]="pop",i[i.fadeout=1]="fadeout";const gt=$},16446:(ge,X,u)=>{u.r(X),u.d(X,{default:()=>te});var N=u(17626),O=u(26584),b=u(62208),C=u(77712),U=(u(90912),u(85931),u(76898)),J=u(55915),p=u(72469),H=u(35560),g=u(50126);let j=class extends g.Z{constructor(){super(...arguments),this.type="feature-3d",this.direct3DObjectFeatureLayerDisplayEnabled=(0,H.hq)()}initialize(){const{layer:Y,view:q}=this;(0,p.S1)(Y)?.operations.supportsQuery||this.addResolvingPromise(Promise.reject(new O.Z("featurelayerview:query-not-supported","layer view requires a layer with query capability",{layer:Y}))),(0,b.pC)(Y.infoFor3D)&&(this.direct3DObjectFeatureLayerDisplayEnabled?this._set("suspendResumeExtentMode","computed"):this.addResolvingPromise(Promise.reject(new O.Z("featurelayerview3d:unsupported-geometry-type",`Unsupported geometry type ${Y.geometryType}`)))),"mesh"!==Y.geometryType||(0,J.Up)(Y.spatialReference,q.spatialReference)||this.addResolvingPromise(Promise.reject(new O.Z("layerview:spatial-reference-incompatible","The spatial references of the feature layer is incompatible with the spatial reference of the view")))}get featureSpatialReference(){return this.view.featureTiles?.tilingScheme?.spatialReference}};(0,N._)([(0,C.Cb)({constructOnly:!0})],j.prototype,"direct3DObjectFeatureLayerDisplayEnabled",void 0),(0,N._)([(0,C.Cb)()],j.prototype,"layer",void 0),j=(0,N._)([(0,U.j)("esri.views.3d.layers.FeatureLayerView3D")],j);const te=j},42767:(ge,X,u)=>{u.d(X,{K0:()=>_e,Pg:()=>ae,R0:()=>j,RE:()=>se,cU:()=>oe,dY:()=>re,nn:()=>me});var N=u(8314),O=u(21286),b=u(62208),C=u(81937),Z=u(52051),a=u(92724),U=u(67022),J=u(22799),p=u(42743),H=u(81695),g=u(67969);function j(f,c){const P=new Map,l=(E,Q)=>{if((0,b.Wi)(E))return-1;const z=P.get(E.id);if(z)return z.usage|=Q,z.id;const ee=P.size;return P.set(E.id,{id:ee,usage:Q}),ee},h=c.pbrMetallicRoughness,_=h&&h.baseColorFactor,y=c.emissiveFactor,x=null==c.normalTexture&&null==c.emissiveTexture&&null==c.occlusionTexture&&(!h||null==h.metallicRoughnessTexture&&1===h.roughnessFactor&&(1===h.metallicFactor||0===h.metallicFactor)),I=x?a.Fw[0]:h?h.metallicFactor:1,F=x?a.Fw[1]:h?h.roughnessFactor:1,T={baseColorFactor:_?[_[0],_[1],_[2],_[3]]:[1,1,1,1],baseColorTextureId:l(h&&h.baseColorTexture,"mask"===c.alphaMode?C.v.Color|C.v.AlphaMask:C.v.Color),metallicRoughnessTextureId:l(h&&h.metallicRoughnessTexture,C.v.MetallicRoughness),metallicFactor:I,roughnessFactor:F},A={alphaMode:c.alphaMode,alphaCutoff:c.alphaCutoff,doubleSided:c.doubleSided,cullFace:"none"===c.cullFace?p.Vr.None:"back"===c.cullFace?p.Vr.Back:"front"===c.cullFace?p.Vr.Front:p.Vr.None,normalTextureId:l(c.normalTexture,C.v.Normal),emissiveTextureId:l(c.emissiveTexture,C.v.Emissive),occlusionTextureId:l(c.occlusionTexture,C.v.Occlusion),emissiveFactor:y?[y[0],y[1],y[2]]:[0,0,0],metallicRoughness:T,wrapTextures:!1,hasParametersFromSource:x},W=[];return P.forEach(({usage:E},Q)=>{const z=(0,b.pC)(f)&&f[Q]&&f[Q].formats,ee=z?te(z.map(({name:de,format:pe})=>({name:de,encoding:Y[pe]}))):[];W.push({id:Q,usage:E,encodings:ee})}),{material:A,textures:W}}function te(f){return f.sort((c,P)=>c.encoding-P.encoding)}const Y={ktx2:C.j.KTX2,basis:C.j.Basis,dds:C.j.DDS_S3TC,png:C.j.PNG,jpg:C.j.JPG,"ktx-etc2":C.j.KTX_ETC2},q={[p.Ti.KTX2_ENCODING]:C.j.Basis,[p.Ti.BASIS_ENCODING]:C.j.Basis,[p.Ti.DDS_ENCODING]:C.j.DDS_S3TC,"image/png":C.j.PNG,"image/jpg":C.j.JPG,"image/jpeg":C.j.JPG,"image/ktx":C.j.KTX_ETC2};function ae(f){const c=f&&f.materialDefinitions?Object.keys(f.materialDefinitions)[0]:null,P=f&&f.textureDefinitions?Object.keys(f.textureDefinitions)[0]:null,l=c?f.materialDefinitions?.[c]:null,h=P?f.textureDefinitions?.[P]:null,_=re();if(null!=l){const x=l.params;x.diffuse&&(_.metallicRoughness.baseColorFactor=[x.diffuse[0],x.diffuse[1],x.diffuse[2],1]),null!=x.doubleSided&&(_.doubleSided=x.doubleSided,_.cullFace=x.doubleSided?p.Vr.None:p.Vr.Back),"none"!==x.cullFace&&"front"!==x.cullFace&&"back"!==x.cullFace||(_.cullFace="none"===x.cullFace?p.Vr.None:"back"===x.cullFace?p.Vr.Back:p.Vr.Front),x.transparency&&(_.metallicRoughness.baseColorFactor[3]=(0,O.uZ)(1-x.transparency,0,1)),(x.useVertexColorAlpha||_.metallicRoughness.baseColorFactor[3]<1)&&(_.alphaMode="blend")}const y=[];if(null!=h){!h.wrap||"repeat"!==h.wrap[0]&&"repeat"!==h.wrap[1]||(_.wrapTextures=!0);let I=C.v.Color;"rgba"===h.channels&&(_.alphaMode="blend",I|=C.v.AlphaMask);const M=h.images[h.images.length-1],T=W=>W&&W.split("/").pop(),A=Array.isArray(h.encoding)?te(h.encoding.map((W,E)=>({name:T(M.href[E]),encoding:q[W]||0}))):[{name:T(M.href),encoding:q[h.encoding]||0}];y.push({id:0,usage:I,encodings:A}),_.metallicRoughness.baseColorTextureId=0}return{material:_,textures:y}}const re=()=>({alphaMode:"opaque",alphaCutoff:U.F,doubleSided:!0,cullFace:p.Vr.None,normalTextureId:-1,emissiveTextureId:-1,occlusionTextureId:-1,emissiveFactor:[0,0,0],metallicRoughness:{baseColorFactor:[.8,.8,.8,1],baseColorTextureId:-1,metallicRoughnessTextureId:-1,metallicFactor:0,roughnessFactor:.6},wrapTextures:!1,hasParametersFromSource:!0});function oe(f,c,P,l){if((0,b.Wi)(f)||null==f.data)return null;const h=f.data,_=!(h instanceof HTMLImageElement)||(0,O.wt)(h.width)&&(0,O.wt)(h.height),x=P&&!l.capabilities.shaderTextureLOD?1:l.renderingContext.parameters.maxMaxAnisotropy,I=_&&!f.downsampled&&x>1,F=P||!c.wrapTextures?ue:ce,M=function R(f){switch(f){case C.j.KTX2:return p.Ti.KTX2_ENCODING;case C.j.Basis:return p.Ti.BASIS_ENCODING;case C.j.DDS_S3TC:return p.Ti.DDS_ENCODING;case C.j.PNG:return"image/png";case C.j.JPG:return"image/jpeg";case C.j.KTX_ETC2:return"image/ktx";default:return""}}(f.encoding);return new H.x(h,{mipmap:I,maxAnisotropy:x,encoding:M,wrap:F,components:f.usage&C.v.Color?"opaque"===c.alphaMode?3:4:3,noUnpackFlip:!0})}const ue={s:g.e8.CLAMP_TO_EDGE,t:g.e8.CLAMP_TO_EDGE},ce={s:g.e8.REPEAT,t:g.e8.REPEAT};function se(f,c,P,l,h,_){const y=_.rendererTextureUsage,x=z=>function k(f,c,P){if((0,b.Wi)(f)||P===C.v.None)return null;for(let l=0;l<f.length;l++){const h=f[l];if((0,b.pC)(h)&&h.usage&P){const _=c[l];return(0,b.pC)(_)?_.id:null}}return null}(l,P,z&y),I=c.metallicRoughness.baseColorFactor,F=(0,O.uZ)(c.metallicRoughness.baseColorFactor[3],0,1);f.baseColor=[I[0],I[1],I[2],F],f.hasParametersFromSource=!!c.hasParametersFromSource,f.usePBR=_.usePBR,f.mrrFactors=[c.metallicRoughness.metallicFactor,c.metallicRoughness.roughnessFactor,c.hasParametersFromSource?.2:.5],f.emissiveFactor=c.emissiveFactor,f.isIntegratedMesh=_.isIntegratedMesh,f.textureAlphaCutoff="mask"===c.alphaMode?c.alphaCutoff:U.F,f.alphaDiscardMode="opaque"===c.alphaMode?p.JJ.Opaque:"mask"===c.alphaMode?p.JJ.Mask:p.JJ.MaskBlend;const M=[],T=x(C.v.Color|C.v.AlphaMask);(0,b.pC)(T)&&(f.baseColorTexture=new Z.T(h,T),M.push(f.baseColorTexture.loadPromise));const A=x(C.v.MetallicRoughness);(0,b.pC)(A)&&(f.metallicRoughnessTexture=new Z.T(h,A),M.push(f.metallicRoughnessTexture.loadPromise));const W=x(C.v.Emissive);(0,b.pC)(W)&&(f.emissionTexture=new Z.T(h,W),M.push(f.emissionTexture.loadPromise));const E=x(C.v.Occlusion);(0,b.pC)(E)&&(f.occlusionTexture=new Z.T(h,E),M.push(f.occlusionTexture.loadPromise));const Q=x(C.v.Normal);return(0,b.pC)(Q)&&(f.normalTexture=new Z.T(h,Q),M.push(f.normalTexture.loadPromise)),f.commonMaterialParameters.hasSlicePlane=_.slicePlaneEnabled,f.commonMaterialParameters.doubleSided=c.doubleSided,f.commonMaterialParameters.cullFace=c.cullFace,f.ellipsoidMode=(0,J.j)(_.viewSpatialReference),Promise.all(M)}function _e(f){const c=!!f.compressedTextureS3TC,P=!!f.compressedTextureETC,l=(0,N.Z)("disable-feature:i3s-basis")?0:C.j.Basis|C.j.KTX2;return C.j.JPG|C.j.PNG|(c?l|C.j.DDS_S3TC:0)|(P?l:0)}function me(f,c){if(null!=c)return f.find(P=>0!=(P.encoding&c))}},52565:(ge,X,u)=>{u.d(X,{$i:()=>O,FE:()=>J,Hw:()=>a,NB:()=>p,O4:()=>Z,U_:()=>C,oQ:()=>H,rw:()=>b,w5:()=>U});var C,Z,a,U,J,g,N=u(97126);class O{constructor(j,te){this.id=j,this.mbs=te,this.renderMbs=(0,N.f)(0,0,0,-1),this.elevationRange=null}}class b{constructor(){this.min=1/0,this.max=-1/0,this.valid=!1}}(g=C||(C={}))[g.Unmodified=0]="Unmodified",g[g.Culled=1]="Culled",g[g.NotChecked=2]="NotChecked",function(g){g[g.Unmodified=0]="Unmodified",g[g.PotentiallyModified=1]="PotentiallyModified",g[g.Culled=2]="Culled",g[g.Unknown=3]="Unknown",g[g.NotChecked=4]="NotChecked"}(Z||(Z={}));class p extends O{constructor(j,te,Y,q,ae,re,oe,ue,ce,se){super(j,Y),this.index=te,this.childCount=q,this.level=ae,this.resources=re,this.version=oe,this.lodMetric=ue,this.maxError=ce,this.numFeatures=se,this.failed=!1,this.cacheState=a.Unknown,this.vertexCount=0,this.memory=0,this.childrenLoaded=0,this.hasModifications=!1,this.imModificationImpact=Z.NotChecked}}(function(g){g[g.Unknown=0]="Unknown",g[g.Uncached=1]="Uncached",g[g.Cached=2]="Cached"})(a||(a={})),function(g){g[g.None=0]="None",g[g.MaxScreenThreshold=1]="MaxScreenThreshold",g[g.ScreenSpaceRelative=2]="ScreenSpaceRelative",g[g.RemovedFeatureDiameter=3]="RemovedFeatureDiameter",g[g.DistanceRangeFromDefaultCamera=4]="DistanceRangeFromDefaultCamera"}(U||(U={})),function(g){g[g.Hole=0]="Hole",g[g.Leaf=1]="Leaf"}(J||(J={}));class H{constructor(j,te,Y,q){this.nodeHasLOD=j,this.isChosen=te,this.lodLevel=Y,this.version=q}}},86152:(ge,X,u)=>{u.d(X,{v:()=>k});var N=u(15861),O=u(17626),b=u(84792),C=u(14517),Z=u(85931),a=u(59213),U=u(27306),J=u(63290),p=u(62208),H=u(10699),g=u(32917),j=u(77712),Y=(u(90912),u(76898)),q=u(15348),ae=u(96854);function re(l,h,_){return oe.apply(this,arguments)}function oe(){return(oe=(0,N.Z)(function*(l,h,_){h=h.clone(),l.capabilities.query.supportsMaxRecordCountFactor&&(h.maxRecordCountFactor=se(l));const y=ue(l),x=l.capabilities.query.supportsPagination;h.start=0,h.num=y;let I=null;for(;;){const F=yield l.source.queryFeaturesJSON(h,_);if((0,p.Wi)(I)?I=F:I.features=I.features.concat(F.features),I.exceededTransferLimit=F.exceededTransferLimit,!x||!F.exceededTransferLimit)break;h.start+=y}return I})).apply(this,arguments)}function ue(l){return se(l)*function ce(l){return l.capabilities.query.maxRecordCount||2e3}(l)}function se(l){return l.capabilities.query.supportsMaxRecordCountFactor?ae.Z.MAX_MAX_RECORD_COUNT_FACTOR:1}var _e=u(35560),me=u(16446);let k=class extends C.Z{constructor(l){super(l),this._warnMaximumChangedObjectsExceeded=!1,this._interactiveEditingSessions=null,this._maximumNumberOfEditOVerrides=P,this._original3DOFLDefinitionExpression=null,this._associatedLayerView=null,this._changedObjectIds=new Set,this._pendingFetchChangedObjectIds=null,this._pendingFetchAbortController=new AbortController}initialize(){this._memCache=this.memoryController.newCache(`${this.layer.uid}-attribute-overrides`),this._pendingFetchChangedObjectIds=this._fetchChangedObjectIds(this._pendingFetchAbortController?.signal),this._pendingFetchChangedObjectIds.then(()=>{this._pendingFetchAbortController=null,this._pendingFetchChangedObjectIds=null}),this.is3DOFL&&(0,_e.hq)()&&(0,p.pC)(this._associatedLayer)&&this._associatedLayer.load().then(l=>{this.destroyed||(this._original3DOFLDefinitionExpression=l.definitionExpression,this.addHandles((0,g.YP)(()=>this._definitionExpression,h=>l.definitionExpression=h,g.nn)),this._associatedLayerView=new me.default({layer:this._associatedLayer,view:this.view}))})}destroy(){this.is3DOFL&&(0,_e.hq)()&&(0,p.pC)(this._associatedLayerView)&&(0,p.pC)(this._associatedLayer)&&(this._associatedLayer.definitionExpression=(0,p.Wg)(this._original3DOFLDefinitionExpression)),this._set("layer",null),this._memCache=(0,p.SC)(this._memCache),this._pendingFetchAbortController=(0,p.IM)(this._pendingFetchAbortController),this._pendingFetchChangedObjectIds=null}get is3DOFL(){return(0,_e.Rx)()&&(0,p.pC)(this._associatedLayer)&&(0,p.pC)(this._associatedLayer.infoFor3D)}get geometryChangedObjectIds(){return this.is3DOFL?[...this._changedObjectIds]:[]}get _associatedLayer(){return null==this.layer?null:this.layer.associatedLayer}get _definitionExpression(){const l=this.geometryChangedObjectIds;return 0===l.length?"1 = 0":`OBJECTID IN (${l.join(",")})`}get updating(){return!(!this.is3DOFL||!(0,_e.hq)())&&(!(0,p.pC)(this._associatedLayerView)||(0,p.pC)(this._associatedLayerView)&&this._associatedLayerView.updating)}get isEmpty(){return null==this._pendingFetchChangedObjectIds&&0===this._changedObjectIds.size}createInteractiveEditSession(l){this._changedObjectIds.add(l),this.notifyChange("_changedObjectIds"),(0,p.Wi)(this._interactiveEditingSessions)&&(this._interactiveEditingSessions=[]);const h=this._interactiveEditingSessions,_=new R(l,{rollback:()=>{(0,Z.Od)(h,_),0===h.length&&(this._interactiveEditingSessions=null)},commit:y=>{for(const[x,I]of y)this.updateAttributeValue(l,x,I)}});return h.unshift(_),_}apply(l,h,_){var y=this;return(0,N.Z)(function*(){if((0,p.Wi)(h))return;const{loadedAttributes:x,attributeData:I}=h;if((0,p.Wi)(x)||0===x.length||(0,p.Wi)(I)||(y._pendingFetchChangedObjectIds&&(yield(0,H.Hl)(y._pendingFetchChangedObjectIds,_)),0===y._changedObjectIds.size))return;const F={loadedAttributes:x,attributeData:I},M=y._getOverridesFromCache(l,F,y._changedObjectIds),{objectIds:T,fieldNames:A}=M;if(0===T.length||0===A.length)return;const W=yield y._queryOverridesFromAssociatedLayer(T,A,_);(0,p.Wi)(W)||y._processOverridesFromAssociatedLayer(l,W,A,F)})()}updateGeometry(l){this._changedObjectIds.add(l),this.notifyChange("_changedObjectIds")}updateAttributeValue(l,h,_){this._changedObjectIds.add(l),this._cacheAttributeValue(l,h,_),this.notifyChange("_changedObjectIds")}_cacheAttributeValue(l,h,_){this._memCache.put(this._getAttributeCacheKey(l,h),_,this._memCacheAttributeValueSize(_))}_getOverridesFromCache(l,{loadedAttributes:h,attributeData:_},y){const x=new Set,I=new Array;for(const M of h)I[M.index]=_[M.name];const F=new Set;for(let M=0;M<l.length;M++){const T=l[M];if(y.has(T))for(const A of h){const W=this._fromCache(T,A.index);void 0===W?(x.add(T),F.add(A.name)):I[A.index][M]=W}}return{objectIds:Array.from(x),fieldNames:Array.from(F)}}_fromCache(l,h){const _=this._fromInteractiveEditingSession(l,h);if(void 0!==_)return _;const y=this._getAttributeCacheKey(l,h);return this._memCache.get(y)}_fromInteractiveEditingSession(l,h){if(!(0,p.Wi)(this._interactiveEditingSessions))for(const _ of this._interactiveEditingSessions){if(_.objectId!==l)continue;const y=_.get(h);if(void 0!==y)return y}}_getAttributeCacheKey(l,h){return`${l}-${h}`}_queryOverridesFromAssociatedLayer(l,h,_){var y=this;return(0,N.Z)(function*(){if(0===l.length||0===h.length)return null;l=l.sort((T,A)=>T-A),y._warnMaximumChangedObjectsExceeded&&(y._warnMaximumChangedObjectsExceeded=!1,y._logMaximumObjectsExceededWarning());const x=y.layer.associatedLayer;if((0,p.Wi)(x))return null;const I=x.createQuery();I.where="1=1",I.returnGeometry=!1,I.outFields=[x.objectIdField,...h],I.cacheHint=!0,I.objectIds=l;const F=ue(x),M=l.length>F?(0,Z.vr)(l,F).map(T=>{const A=I.clone();return A.objectIds=T,(0,a.mt)(re(x,A,{signal:_}))}):[(0,a.mt)(re(x,I,{signal:_}))];return(yield Promise.all(M)).reduce((T,A)=>T.concat(A.ok?A.value.features:[]),[])})()}_logMaximumObjectsExceededWarning(){let l=`The number of edited objects that are not yet cached in the scene service exceeds the maximum limit. Attribute changes will only be available for the first ${(0,q.uf)(this._maximumNumberOfEditOVerrides)} objects. Please consider re-caching the scene service`;const h=this.layer.portalItem;l+=h&&h.loaded?` (${h.portal.url}/home/item.html?id=${h.id}#settings)`:` (${this.layer.parsedUrl.path})`,J.Z.getLogger("esri.views.3d.layers.i3s.I3SOverrides").warn("#queryOverrides()",this.layer.title,`${l}.`)}_processOverridesFromAssociatedLayer(l,h,_,{loadedAttributes:y,attributeData:x}){const I=this.layer.associatedLayer;if((0,p.Wi)(I))return;const F=I.objectIdField,M=_.map(E=>x[E]),T=new Map(y.map(E=>[E.name,E.index])),A=_.map(E=>T.get(E)),W=new Map(Array.from(l,(E,Q)=>[E,Q]));for(const E of h){const Q=E.attributes[F];for(let z=0;z<_.length;z++){const ee=A[z],de=W.get(Q),pe=E.attributes[_[z]];M[z][de]=pe,this._cacheAttributeValue(Q,ee,pe)}}}_memCacheAttributeValueSize(l){return"string"==typeof l?(0,U.hH)(l):(0,U.G3)()}_fetchChangedObjectIds(l){var h=this;return(0,N.Z)(function*(){const _=h.layer;if(yield _.load({signal:l}),h._changedObjectIds.clear(),(0,p.Wi)(_.associatedLayer)||!_.associatedLayer.capabilities?.operations?.supportsChangeTracking)return;const y=h._getFetchChangedObjectIdsServerGen();if((0,p.Wi)(y))return;const x=_.associatedLayer.layerId,I=(0,p.pC)(_.associatedLayer.infoFor3D),F=yield(0,a.q6)((0,b.default)(`${_.associatedLayer.url}/extractChanges`,{method:"post",query:{f:"json",returnIdsOnly:!0,layers:`[${x}]`,returnUpdates:!0,returnDeletes:I,returnInserts:I,layerServerGens:JSON.stringify([{id:x,serverGen:y}])},timeout:c,signal:l}));if(F.ok&&F.value.data?.edits&&1===F.value.data.edits.length){const M=F.value.data.edits[0],T=(0,p.U2)(M,"objectIds","adds"),A=(0,p.U2)(M,"objectIds","updates"),W=(0,p.U2)(M,"objectIds","deletes");let E=[];(0,p.pC)(T)&&(E=E.concat(T)),(0,p.pC)(A)&&(E=E.concat(A)),(0,p.pC)(W)&&(E=E.concat(W));const Q=Math.min(h._maximumNumberOfEditOVerrides,E.length);Q<E.length&&(h._warnMaximumChangedObjectsExceeded=!0);const z=E.sort((ee,de)=>ee-de);for(let ee=0;ee<Q;ee++)h._changedObjectIds.add(z[ee])}h.notifyChange("_changedObjectIds")})()}_getFetchChangedObjectIdsServerGen(){const l=this.layer;if((0,p.pC)(l.serviceUpdateTimeStamp)&&(0,p.pC)(l.serviceUpdateTimeStamp.lastUpdate))return l.serviceUpdateTimeStamp.lastUpdate;const h=l.associatedLayer;return(0,p.pC)(h)&&(0,p.pC)(h.serverGens)&&(0,p.pC)(h.serverGens.minServerGen)?h.serverGens.minServerGen:null}get test(){const l=Array.from(this._changedObjectIds),_=this;return{changedObjectIds:l,pendingFetchChangedObjectIds:this._pendingFetchChangedObjectIds,get maximumNumberOfEditOVerrides(){return _._maximumNumberOfEditOVerrides},set maximumNumberOfEditOVerrides(y){_._maximumNumberOfEditOVerrides=y}}}};(0,O._)([(0,j.Cb)({constructOnly:!0})],k.prototype,"view",void 0),(0,O._)([(0,j.Cb)({constructOnly:!0})],k.prototype,"layer",void 0),(0,O._)([(0,j.Cb)({readOnly:!0})],k.prototype,"is3DOFL",null),(0,O._)([(0,j.Cb)({readOnly:!0})],k.prototype,"geometryChangedObjectIds",null),(0,O._)([(0,j.Cb)()],k.prototype,"_associatedLayer",null),(0,O._)([(0,j.Cb)()],k.prototype,"_associatedLayerView",void 0),(0,O._)([(0,j.Cb)({constructOnly:!0})],k.prototype,"memoryController",void 0),(0,O._)([(0,j.Cb)()],k.prototype,"_changedObjectIds",void 0),(0,O._)([(0,j.Cb)()],k.prototype,"_pendingFetchChangedObjectIds",void 0),(0,O._)([(0,j.Cb)()],k.prototype,"_definitionExpression",null),(0,O._)([(0,j.Cb)()],k.prototype,"updating",null),(0,O._)([(0,j.Cb)()],k.prototype,"isEmpty",null),k=(0,O._)([(0,Y.j)("esri.views.3d.layers.i3s.I3SOverrides")],k);class R{constructor(h,_){this.objectId=h,this._options=_,this._updates=new Map,this._state=f.ACTIVE}get(h){return this._updates.get(h)}set(h,_){this._isActive&&this._updates.set(h,_)}rollback(){this._isActive&&(this._state=f.ROLLED_BACK,this._options.rollback())}commit(){this._isActive&&(this._state=f.COMMITTED,this._options.commit(this._updates),this._updates.clear())}get _isActive(){return this._state===f.ACTIVE}}var f,l;(l=f||(f={}))[l.ACTIVE=0]="ACTIVE",l[l.COMMITTED=1]="COMMITTED",l[l.ROLLED_BACK=2]="ROLLED_BACK";const c=1e4,P=5e4},81937:(ge,X,u)=>{var N,O,b;u.d(X,{j:()=>N,v:()=>O}),(b=N||(N={}))[b.KTX2=1]="KTX2",b[b.Basis=2]="Basis",b[b.DDS_S3TC=4]="DDS_S3TC",b[b.PNG=8]="PNG",b[b.JPG=16]="JPG",b[b.KTX_ETC2=32]="KTX_ETC2",function(b){b[b.None=0]="None",b[b.Color=1]="Color",b[b.MetallicRoughness=2]="MetallicRoughness",b[b.Normal=4]="Normal",b[b.Occlusion=8]="Occlusion",b[b.Emissive=16]="Emissive",b[b.AlphaMask=32]="AlphaMask",b[b.ColorTextures=19]="ColorTextures",b[b.GeometryTextures=36]="GeometryTextures",b[b.GeometryTexturesPBR=44]="GeometryTexturesPBR",b[b.AllTextures=37]="AllTextures",b[b.AllTexturesPBR=63]="AllTexturesPBR"}(O||(O={}))},73683:(ge,X,u)=>{var N,O;u.d(X,{B:()=>N}),(O=N||(N={}))[O.FadeIn=0]="FadeIn",O[O.FadeOut=1]="FadeOut"},52051:(ge,X,u)=>{u.d(X,{T:()=>b});var N=u(62208),O=u(10699);class b{constructor(Z,a){this._textureRep=Z,this.loadPromise=null,this._disposed=!1;const U=this._textureRep.acquire(a);(0,O.y8)(U)?(U.then(J=>{this._disposed?(0,N.RY)(J):this._textureRef=J}),this.loadPromise=U):this._textureRef=U}dispose(){this._textureRef=(0,N.RY)(this._textureRef),this._disposed=!0}get glTexture(){return(0,N.pC)(this._textureRef)?this._textureRef.glTexture:null}}}}]);