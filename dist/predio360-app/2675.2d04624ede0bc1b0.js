"use strict";(self.webpackChunkpredio360_app=self.webpackChunkpredio360_app||[]).push([[2675],{76391:(ue,G,g)=>{function m(Z){const S={};for(const I in Z){if("declaredClass"===I)continue;const f=Z[I];if(null!=f&&"function"!=typeof f)if(Array.isArray(f)){S[I]=[];for(let y=0;y<f.length;y++)S[I][y]=m(f[y])}else"object"==typeof f?f.toJSON&&(S[I]=JSON.stringify(f)):S[I]=f}return S}g.d(G,{A:()=>m})},20477:(ue,G,g)=>{g.d(G,{Ev:()=>P,JT:()=>ae,Vn:()=>fe,Vr:()=>ne,hH:()=>$,n7:()=>le,qp:()=>B});var m=g(15861),Z=g(84792),S=g(21726),I=g(91179),f=g(93555),y=g(37053),b=g(76391),v=g(85262),x=g(61515);const D="Layer does not support extent calculation.";function H(k,O){const j=k.geometry,F=k.toJSON();delete F.compactGeometryEnabled,delete F.defaultSpatialReferenceEnabled;const A=F;let w,T,q;if(null!=j&&(T=j.spatialReference,q=(0,y.B9)(T),A.geometryType=(0,I.Ji)(j),A.geometry=function se(k,O){if(O&&"extent"===k.type)return`${k.xmin},${k.ymin},${k.xmax},${k.ymax}`;if(O&&"point"===k.type)return`${k.x},${k.y}`;const j=k.toJSON();return delete j.spatialReference,JSON.stringify(j)}(j,k.compactGeometryEnabled),A.inSR=q),F.groupByFieldsForStatistics&&(A.groupByFieldsForStatistics=F.groupByFieldsForStatistics.join(",")),F.objectIds&&(A.objectIds=F.objectIds.join(",")),F.orderByFields&&(A.orderByFields=F.orderByFields.join(",")),!F.outFields||!F.returnDistinctValues&&(O?.returnCountOnly||O?.returnExtentOnly||O?.returnIdsOnly)?delete A.outFields:A.outFields=F.outFields.includes("*")?"*":F.outFields.join(","),F.outSR?(A.outSR=(0,y.B9)(F.outSR),w=k.outSpatialReference):j&&(F.returnGeometry||F.returnCentroid)&&(A.outSR=A.inSR,w=T),F.returnGeometry&&delete F.returnGeometry,F.outStatistics&&(A.outStatistics=JSON.stringify(F.outStatistics)),F.fullText&&(A.fullText=JSON.stringify(F.fullText)),F.pixelSize&&(A.pixelSize=JSON.stringify(F.pixelSize)),F.quantizationParameters&&(k.defaultSpatialReferenceEnabled&&null!=T&&null!=k.quantizationParameters?.extent&&T.equals(k.quantizationParameters.extent.spatialReference)&&delete F.quantizationParameters.extent.spatialReference,A.quantizationParameters=JSON.stringify(F.quantizationParameters)),F.parameterValues&&(A.parameterValues=JSON.stringify(F.parameterValues)),F.rangeValues&&(A.rangeValues=JSON.stringify(F.rangeValues)),F.dynamicDataSource&&(A.layer=JSON.stringify({source:F.dynamicDataSource}),delete F.dynamicDataSource),F.timeExtent){const U=F.timeExtent,{start:oe,end:ie}=U;null==oe&&null==ie||(A.time=oe===ie?oe:`${oe??"null"},${ie??"null"}`),delete F.timeExtent}return k.defaultSpatialReferenceEnabled&&null!=T&&null!=w&&T.equals(w)&&(A.defaultSR=A.inSR,delete A.inSR,delete A.outSR),A}function ae(k,O,j,F){return he.apply(this,arguments)}function he(){return(he=(0,m.Z)(function*(k,O,j,F){const A=null!=O.timeExtent&&O.timeExtent.isEmpty?{data:{features:[]}}:yield fe(k,O,"json",F);return(0,x.p)(O,j,A.data),A})).apply(this,arguments)}function B(k,O,j,F){return ye.apply(this,arguments)}function ye(){return(ye=(0,m.Z)(function*(k,O,j,F){if(null!=O.timeExtent&&O.timeExtent.isEmpty)return{data:j.createFeatureResult()};const A=yield le(k,O,F),w=A;return w.data=(0,v.C)(A.data,j),w})).apply(this,arguments)}function le(k,O,j){return fe(k,O,"pbf",j)}function P(k,O,j){return null!=O.timeExtent&&O.timeExtent.isEmpty?Promise.resolve({data:{objectIds:[]}}):fe(k,O,"json",j,{returnIdsOnly:!0})}function $(k,O,j){return null!=O.timeExtent&&O.timeExtent.isEmpty?Promise.resolve({data:{count:0}}):fe(k,O,"json",j,{returnIdsOnly:!0,returnCountOnly:!0})}function ne(k,O,j){return _e.apply(this,arguments)}function _e(){return(_e=(0,m.Z)(function*(k,O,j){if(null!=O.timeExtent&&O.timeExtent.isEmpty)return{data:{count:0,extent:null}};const F=yield fe(k,O,"json",j,{returnExtentOnly:!0,returnCountOnly:!0}),A=F.data;if(A.hasOwnProperty("extent"))return F;if(A.features)throw new Error(D);if(A.hasOwnProperty("count"))throw new Error(D);return F})).apply(this,arguments)}function fe(k,O,j){return de.apply(this,arguments)}function de(){return(de=(0,m.Z)(function*(k,O,j,F={},A={}){const w="string"==typeof k?(0,S.mN)(k):k,T=O.geometry?[O.geometry]:[],U=(yield(0,f.aX)(T,null,{signal:F.signal}))?.[0];null!=U&&((O=O.clone()).geometry=U);const oe=(0,b.A)({...w.query,f:j,...A,...H(O,A)});return(0,Z.Z)((0,S.v_)(w.path,function be(k,O){return null!=k.formatOf3DObjects&&!(O.returnCountOnly||O.returnExtentOnly||O.returnIdsOnly)}(O,A)?"query3d":"query"),{...F,responseType:"pbf"===j?"array-buffer":"json",query:{...oe,...F.query}})})).apply(this,arguments)}},72571:(ue,G,g)=>{g.d(G,{EC:()=>S,Oo:()=>f,ck:()=>I});var m=g(91558),Z=g(38093);const S={selection:y=>new Z.Z({color:new m.Z([y.color.r/2,y.color.g/2,y.color.b/2,y.color.a])}),highlight:y=>y,popup:y=>new Z.Z({color:new m.Z([y.color.g,y.color.b,y.color.r,y.color.a])})};function I(y){if(!y)return 0;let b=1;for(const v in S){if(v===y)break;b<<=1}return b}const f=Object.keys(S)},65540:(ue,G,g)=>{g.d(G,{Z:()=>S});var m=g(21433),Z=g(77643);class S{constructor(f,y){this.id=f,this.sortKey=y,this.records=[]}serialize(f){return f.push(this.id),f.writeF32(this.sortKey),(0,Z.G)(f,this.records),f}static deserialize(f){const y=f.readInt32(),b=f.readF32(),v=new S(y,b);return v.records=(0,Z.h)(f,m.Z)??[],v}}S.byteSizeHint=2*Uint32Array.BYTES_PER_ELEMENT+m.Z.byteSizeHint},21433:(ue,G,g)=>{g.d(G,{Z:()=>m});class m{constructor(S,I,f,y,b,v,x){this.instanceId=S,this.textureKey=I,this.indexStart=f,this.indexCount=y,this.vertexStart=b,this.vertexCount=v,this.overlaps=x}updateBaseOffsets(S){this.vertexStart+=S.vertexFrom,this.indexStart+=S.indexFrom}clone(){return new m(this.instanceId,this.textureKey,this.indexStart,this.indexCount,this.vertexStart,this.vertexCount,this.overlaps)}static write(S,I,f,y,b,v,x,D){S.push(I),S.push(f),S.push(y),S.push(b),S.push(v),S.push(x),S.push(D)}serialize(S){return S.push(this.instanceId),S.push(this.textureKey),S.push(this.indexStart),S.push(this.indexCount),S.push(this.vertexStart),S.push(this.vertexCount),S.push(this.overlaps),S}static deserialize(S){const I=S.readInt32(),f=S.readInt32(),y=S.readInt32(),b=S.readInt32(),v=S.readInt32(),x=S.readInt32(),D=S.readInt32();return new m(I,f,y,b,v,x,D)}}m.byteSizeHint=7*Uint32Array.BYTES_PER_ELEMENT},87526:(ue,G,g)=>{g.d(G,{IS:()=>A,Jq:()=>O,TB:()=>k,UK:()=>$,Yw:()=>P,cM:()=>be,cU:()=>F});var m=g(26584),Z=g(63290),b=(g(7547),g(4619),g(8314),g(68598),g(67969)),se=(g(85775),g(20194),g(72787),g(35098)),H=g(18952),ae=g(31548),he=g(40852);const B=()=>Z.Z.getLogger("esri.views.2d.engine.webgl.Utils");function P(w){switch(w){case b.Br.UNSIGNED_BYTE:return 1;case b.Br.UNSIGNED_SHORT_4_4_4_4:return 2;case b.Br.FLOAT:return 4;default:return void B().error(new m.Z("webgl-utils",`Unable to handle type ${w}`))}}function $(w){switch(w){case b.Br.UNSIGNED_BYTE:return Uint8Array;case b.Br.UNSIGNED_SHORT_4_4_4_4:return Uint16Array;case b.Br.FLOAT:return Float32Array;default:return void B().error(new m.Z("webgl-utils",`Unable to handle type ${w}`))}}const _e=w=>{const T=new Map;for(const q in w)for(const U of w[q])T.set(U.name,U.location);return T},fe=w=>{const T={};for(const q in w){const U=w[q];T[q]=U?.length?U[0].stride:0}return T},de=new Map,be=(w,T)=>{if(!de.has(w)){const q=function ne(w){const T={};for(const q in w){let oe=0;T[q]=w[q].map(ie=>{const Ue=new he.G(ie.name,ie.count,ie.type,oe,0,ie.normalized||!1);return oe+=ie.count*(0,se.S)(ie.type),Ue}),T[q]?.forEach(ie=>ie.stride=oe)}return T}(T),U={strides:fe(q),bufferLayouts:q,attributes:_e(T)};de.set(w,U)}return de.get(w)},k=w=>w.includes("data:image/svg+xml");function O(w){const T=[];for(let q=0;q<w.length;q++)T.push(w.charCodeAt(q));return T}function F(w,T,q){const U=new ae.X(T.width,T.height);return U.dataType=T.dataType,T.depth&&(U.depth=T.depth),T.flipped&&(U.flipped=T.flipped),T.hasMipmap&&(U.hasMipmap=T.hasMipmap),U.internalFormat=T.internalFormat,T.isImmutable&&(U.isImmutable=T.isImmutable),T.isOpaque&&(U.isOpaque=T.isOpaque),T.maxAnisotropy&&(U.maxAnisotropy=T.maxAnisotropy),U.pixelFormat=T.pixelFormat,T.preMultiplyAlpha&&(U.preMultiplyAlpha=T.preMultiplyAlpha),T.samplingMode&&(U.samplingMode=T.samplingMode),T.target&&(U.target=T.target),U.uniform=T.uniform,T.unpackAlignment&&(U.unpackAlignment=T.unpackAlignment),T.wrapMode&&(U.wrapMode=T.wrapMode),new H.x(w,U,q)}function A(w){return"url"in w&&"urlHash"in w?{...w,url:""}:w}},83499:(ue,G,g)=>{g.d(G,{O:()=>S});var m=g(6239),Z=g(77643);class S{constructor(f,y,b,v,x,D,se,H,ae=[]){this.entityTexel=f,this.anchorX=y,this.anchorY=b,this.directionX=v,this.directionY=x,this.maxScale=D,this.minScale=se,this.referenceBounds=H,this.bounds=ae}serialize(f){f.push(this.entityTexel),f.writeF32(this.anchorX),f.writeF32(this.anchorY),f.writeF32(this.directionX),f.writeF32(this.directionY),f.writeF32(this.maxScale),f.writeF32(this.minScale),null===this.referenceBounds?(f.writeF32(0),f.writeF32(0),f.writeF32(0)):(f.writeF32(this.referenceBounds.size),f.writeF32(this.referenceBounds.offsetX),f.writeF32(this.referenceBounds.offsetY)),(0,Z.G)(f,this.bounds)}static deserialize(f){const y=f.readInt32(),b=f.readF32(),v=f.readF32(),x=f.readF32(),D=f.readF32(),se=f.readF32(),H=f.readF32(),ae=f.readF32(),he=f.readF32(),B=f.readF32(),ye=(0,Z.h)(f,m.Z)??[];return new S(y,b,v,x,D,se,H,{size:ae,offsetX:he,offsetY:B},ye)}}},5254:(ue,G,g)=>{g.d(G,{UJ:()=>he});const m=new Float32Array(1);function he(P,$){return 65535&P|$<<16}new Uint32Array(m.buffer)},69862:(ue,G,g)=>{g.d(G,{G:()=>Z,n:()=>S});var m=g(67969);function Z(I,f,y,b){const v=y.packPrecisionFactor??1;switch(y.type){case m.g.BYTE:if(1===y.count)I.setInt8(b+y.offset,f*v);else for(let x=0;x<y.count;x++){const D=x*Int8Array.BYTES_PER_ELEMENT;I.setInt8(b+y.offset+D,f[x]*v)}break;case m.g.UNSIGNED_BYTE:if(1===y.count)I.setUint8(b+y.offset,f*v);else for(let x=0;x<y.count;x++){const D=x*Uint8Array.BYTES_PER_ELEMENT;I.setUint8(b+y.offset+D,f[x]*v)}break;case m.g.SHORT:if(1===y.count)I.setInt16(b+y.offset,f*v,!0);else for(let x=0;x<y.count;x++){const D=x*Int16Array.BYTES_PER_ELEMENT;I.setInt16(b+y.offset+D,f[x]*v,!0)}break;case m.g.UNSIGNED_SHORT:if(1===y.count)I.setUint16(b+y.offset,f*v,!0);else for(let x=0;x<y.count;x++){const D=x*Uint16Array.BYTES_PER_ELEMENT;I.setUint16(b+y.offset+D,f[x]*v,!0)}break;case m.g.INT:if(1===y.count)I.setInt32(b+y.offset,f*v,!0);else for(let x=0;x<y.count;x++){const D=x*Int32Array.BYTES_PER_ELEMENT;I.setInt32(b+y.offset+D,f[x]*v,!0)}break;case m.g.UNSIGNED_INT:if(1===y.count)I.setUint32(b+y.offset,f*v,!0);else for(let x=0;x<y.count;x++){const D=x*Uint32Array.BYTES_PER_ELEMENT;I.setUint32(b+y.offset+D,f[x]*v,!0)}break;case m.g.FLOAT:if(1===y.count)I.setFloat32(b+y.offset,f*v,!0);else for(let x=0;x<y.count;x++){const D=x*Float32Array.BYTES_PER_ELEMENT;I.setFloat32(b+y.offset+D,f[x]*v,!0)}}}function S(I,f,y){switch(f.type){case m.g.BYTE:{if(1===f.count)return I.getInt8(y+f.offset);const b=[];for(let v=0;v<f.count;v++){const x=v*Int8Array.BYTES_PER_ELEMENT;b.push(I.getInt8(y+f.offset+x))}return b}case m.g.UNSIGNED_BYTE:{if(1===f.count)return I.getUint8(y+f.offset);const b=[];for(let v=0;v<f.count;v++){const x=v*Uint8Array.BYTES_PER_ELEMENT;b.push(I.getUint8(y+f.offset+x))}return b}case m.g.SHORT:{if(1===f.count)return I.getInt16(y+f.offset,!0);const b=[];for(let v=0;v<f.count;v++){const x=v*Int16Array.BYTES_PER_ELEMENT;b.push(I.getInt16(y+f.offset+x,!0))}return b}case m.g.UNSIGNED_SHORT:{if(1===f.count)return I.getUint16(y+f.offset,!0);const b=[];for(let v=0;v<f.count;v++){const x=v*Uint16Array.BYTES_PER_ELEMENT;b.push(I.getUint16(y+f.offset+x,!0))}return b}case m.g.INT:{if(1===f.count)return I.getInt32(y+f.offset,!0);const b=[];for(let v=0;v<f.count;v++){const x=v*Int32Array.BYTES_PER_ELEMENT;b.push(I.getInt32(y+f.offset+x,!0))}return b}case m.g.UNSIGNED_INT:{if(1===f.count)return I.getUint32(y+f.offset,!0);const b=[];for(let v=0;v<f.count;v++){const x=v*Uint32Array.BYTES_PER_ELEMENT;b.push(I.getUint32(y+f.offset+x,!0))}return b}case m.g.FLOAT:{if(1===f.count)return I.getFloat32(y+f.offset,!0);const b=[];for(let v=0;v<f.count;v++){const x=v*Float32Array.BYTES_PER_ELEMENT;b.push(I.getFloat32(y+f.offset+x,!0))}return b}}}},95860:(ue,G,g)=>{g.d(G,{b8:()=>I,ig:()=>Z,mx:()=>S});var m=g(77275);function Z(f){const y=f.map(({name:b,count:v,type:x})=>`${b}.${v}.${x}`).join(",");return(0,m.hP)(y)}function S(f,y,b,v,x,D,se){if(f.primitiveName===y)for(const H in f)if(H===b){let ae=v?.readWithDefault(x,D,f[H]&&se);return"text"===f.type&&(ae=ae.toString()),void(f[H]=ae)}if("type"in f&&null!=f.type)switch(f.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":if(f.symbolLayers)for(const H of f.symbolLayers)S(H,y,b,v,x,D,se);break;case"CIMHatchFill":f.lineSymbol&&S(f.lineSymbol,y,b,v,x,D,se);break;case"CIMSolidStroke":case"CIMSolidFill":case"CIMVectorMarker":if("CIMVectorMarker"===f.type&&f.markerGraphics)for(const H of f.markerGraphics)S(H,y,b,v,x,D,se),S(H.symbol,y,b,v,x,D,se)}}function I(f){return null!=f.effects?256:Math.max(1.25*f.width,8)}},77643:(ue,G,g)=>{function m(S,I){if(null!==I){S.push(I.length);for(const f of I)f.serialize(S);return S}S.push(0)}function Z(S,I,f){const y=S.readInt32(),b=new Array(y);for(let v=0;v<b.length;v++)b[v]=I.deserialize(S,f);return b}g.d(G,{G:()=>m,h:()=>Z})},594:(ue,G,g)=>{g.r(G),g.d(G,{default:()=>or});var m=g(15861),Z=g(26584),S=g(54024),I=g(8314),f=g(79682),y=g(10699),b=g(4619),v=g(32917),x=g(23841),D=g(2584),se=g(9598),H=g(58098),B=(g(8480),g(79527),g(39351));class ye{constructor(t){this._client=t,this.layerView=this._client.createInvokeProxy("",{ignoreConnectionErrors:!0}),this.container=this._client.createInvokeProxy("container",{ignoreConnectionErrors:!0}),this.eventLog=this._client.createInvokeProxy("eventLog",{ignoreConnectionErrors:!0})}}var le=g(16296),P=g(62208),$=g(84682),ne=g(65234),_e=g(86207),fe=g(55376);const de=1,be=2,k=4,O=8,j=16,F=32,A=64,w=128;function T(h){switch(h){case de:case O:case F:return-1;case be:case A:return 0;case k:case j:case w:return 1}}function q(h){switch(h){case de:case be:case k:return-1;case O:case j:return 0;case F:case A:case w:return 1}}const U=de|O|F,oe=k|j|w,ie=de|be|k,Ue=F|A|w;class Qt{constructor(t,s,i,a=0){this.tileKey=t,this._bufferingEnabled=s,this._sizeHint=a,this._meshes={self:new _e._(this.id,this._sizeHint),neighbors:new Array},this._currentRecordOverlaps=0,this._currentEntityOverlaps=0,this._copyBufferedDataIntoSelf=i&&this._bufferingEnabled&&0===t.level}get id(){return this.tileKey.id}vertexCount(){return this._meshes.self.vertexCount()}indexCount(){return this._meshes.self.indexCount()}indexEnsureSize(t){this._meshes.self.indexEnsureSize(t)}entityStart(t,s=t){this._currentEntityOverlaps=0,this._meshes.self.entityStart(t,s)}entityRecordCount(){return this._meshes.self.entityRecordCount()}entityEnd(){if(this._meshes.self.entityEnd(),this._bufferingEnabled){if(this._copyBufferedDataIntoSelf)return;for(let t=0;t<8;t++)this._currentEntityOverlaps&1<<t&&this._meshes.neighbors[t].entityEnd()}}recordStart(t,s,i){this._currentRecordOverlaps=0,this._meshes.self.recordStart(t,s,i)}recordEnd(t=0){const s=this._meshes.self.recordEnd(this._currentRecordOverlaps);return s&&0!==this._currentRecordOverlaps?(this._copyIntoNeighbors(),this._currentEntityOverlaps|=this._currentRecordOverlaps,!0):s}recordBounds(t,s,i,a){this._bufferingEnabled&&this._addOverlap(t,s,i,a)}recordCount(){return this._meshes.self.recordCount()}metricStart(t){this._meshes.self.metricStart(t)}metricBoxWrite(t){this._meshes.self.metricBoxWrite(t)}metricEnd(){this._meshes.self.metricEnd()}vertexWrite(t){this._meshes.self.vertexWrite(t)}vertexWriteF32(t){this._meshes.self.vertexWriteF32(t)}vertexWriteRegion(t){this._meshes.self.vertexWriteRegion(t)}indexWrite(t){this._meshes.self.indexWrite(t)}serialize(t){const s={message:[],transferList:[]},i=this._meshes.self.serialize();return s.message.push({tileId:this.tileKey.id,...i.message}),s.transferList.push(...i.transferList),this._meshes.neighbors.forEach((a,o)=>{const u=a.serialize(),l=1<<o,d=T(l),c=q(l),p=(0,fe.M)(new H.Z(this.tileKey),d,c,t);s.message.push({tileId:p.id,...u.message}),s.transferList.push(...u.transferList)}),s}_addOverlap(t,s,i,a){const o=Math.min(B.i9/2,i),u=Math.min(B.i9/2,a);this._currentRecordOverlaps|=255^((t<0+o?oe:t>=B.i9-o?U:oe|U)|(s<0+u?Ue:s>=B.i9-u?ie:Ue|ie))}_copyIntoNeighbors(){for(let t=0;t<8;t++){const s=1<<t;if(this._currentRecordOverlaps&s){if(this._copyBufferedDataIntoSelf){const u=-T(s)*B.i9,l=-q(s)*B.i9;this._meshes.self.copyLast(u,l);continue}if(!this._meshes.neighbors[t]){const u=Math.floor(this._sizeHint/16);this._meshes.neighbors[t]=new _e._(s,u)}const i=this._meshes.neighbors[t],a=-T(s)*B.i9,o=-q(s)*B.i9;i.copyLastFrom(this._meshes.self,a,o)}}}}class Jt{}var me=g(24464);class Ie{constructor(){this._defaultResult=null,this._backgroundFillResult=null}static from(t,s,i,a){return(0,m.Z)(function*(){const o=new Ie;return o.setDefault(yield(0,me.yj)(t,s,i.meshes,a)),o})()}size(){return 1}getDefault(){return this._defaultResult}setDefault(t){this._defaultResult=t}getBackgroundFill(){return this._backgroundFillResult}setBackgroundFill(t){this._backgroundFillResult=t}match(t,s){const i=this.doMatch(t,s)||this.getDefault();if(i&&i.length>0){const a=this.getBackgroundFill();if(a)return[...a,...i]}return i}getSortKey(t,s){return 0}doMatch(t,s){return null}fetchResources(t,s){return(0,m.Z)(function*(){})()}}class Ye extends Ie{static fromDictionaryRenderer(t,s,i){return(0,m.Z)(function*(){return new Ye(t,s,i)})()}constructor(t,s,i){super(),this._storage=t,this._schema=s,this._viewParams=i,this._hashToGroup=new Map}get fieldMap(){return this._schema.fieldMap}fetchResources(t,s){var i=this;return(0,m.Z)(function*(){const a=s.getCursor(),o=[];for(;a.next();)o.push(i._updateMeshWriterGroup(t,a));yield Promise.all(o)})()}match(t,s){const i=t.getAttributeHash();return this._hashToGroup.get(i)}_updateMeshWriterGroup(t,s){var i=this;return(0,m.Z)(function*(){const a=s.readLegacyFeatureForDisplay(),o=s.getAttributeHash();if(i._hashToGroup.has(o))return;i._hashToGroup.set(o,null);const u=yield t.fetchDictionaryResourceImmediate({type:"dictionary-request",feature:a});if(!u)return;const l=yield(0,me.yj)(i._storage,t,u.meshes,i._viewParams);i._hashToGroup.set(o,l)})()}}class Ve extends Ie{constructor(t,s){super(),this._intervals=[],this._isMaxInclusive=s,this._field=t}static fromIntervalSchema(t,s,i,a){return(0,m.Z)(function*(){const o=yield t.createComputedField(i),u=new Ve(o,i.isMaxInclusive);yield Promise.all(i.intervals.map(function(){var c=(0,m.Z)(function*(p){const _=yield(0,me.yj)(t,s,p.meshes,a);u.add(p,_)});return function(p){return c.apply(this,arguments)}}()));const l=yield(0,me.yj)(t,s,i.defaultSymbol,a);u.setDefault(l);const d=yield(0,me.yj)(t,s,i.backgroundFill,a);return u.setBackgroundFill(d),u})()}add(t,s){this._intervals.push({interval:t,result:s}),this._intervals.sort((i,a)=>i.interval.min-a.interval.min)}size(){return super.size()+this._intervals.length}doMatch(t,s){const i=this._field?.read(t,s);if(null==i||isNaN(i)||i===1/0||i===-1/0)return null;for(let a=0;a<this._intervals.length;a++){const{interval:o,result:u}=this._intervals[a];if(i>=o.min&&(this._isMaxInclusive?i<=o.max:i<o.max))return u}return null}}class $e extends Ie{static fromLabelSchema(t,s,i,a){return(0,m.Z)(function*(){const o=i.classes.map(function(){var l=(0,m.Z)(function*(d){const c=yield(0,me.yj)(t,s,d.meshes,a);return{minScale:d.minScale,maxScale:d.maxScale,meshes:c,expression:null,where:yield t.createWhereClause(d.where)}});return function(d){return l.apply(this,arguments)}}()),u=yield Promise.all(o);return new $e(u)})()}constructor(t){super(),this._labels=t}match(t,s){if(!this._labels.length)return null;const i=this._getLabels(s.$view.scale),a=[];for(const o of i)o.where&&!o.where(t)||a.push(...o.meshes);return a}_getLabels(t){return this._labels.filter(s=>this._validForTileScale(s,t))}_validForTileScale(t,s){return(!t.minScale||t.minScale>=s-s/4)&&(!t.maxScale||t.maxScale<=s+s/2)}}class Ke extends Ie{constructor(t,s){super(),this._defaultSymbolSortKey=0,this._nullResult=null,this._resultsMap=new Map,this._fields=[],this._fields=t,this._separator=s||""}static fromMatcherSchema(t,s,i,a){return(0,m.Z)(function*(){const o=i.expression?[t.createComputedField({expression:i.expression})]:[i.field?t.createComputedField({field:i.field}):null,i.field2?t.createComputedField({field:i.field2}):null,i.field3?t.createComputedField({field:i.field3}):null],u=(yield Promise.all(o)).filter(p=>!!p),l=new Ke(u,i.fieldDelimiter),d=yield(0,me.yj)(t,s,i.defaultSymbol,a);l.setDefault(d);const c=yield(0,me.yj)(t,s,i.backgroundFill,a);return l.setBackgroundFill(c),yield Promise.all(i.map.map(function(){var p=(0,m.Z)(function*(_,E){const M=yield(0,me.yj)(t,s,_.symbol,a);"<Null>"===_.value?l.setNullResult(M):l.add(_.value,M,E+1)});return function(_,E){return p.apply(this,arguments)}}())),l})()}setNullResult(t){this._nullResult=t}getSortKey(t,s){const i=this._getValueFromFields(t,s);if(null==i||""===i||"<Null>"===i)return 0;const a=this._resultsMap.get(i.toString());return a?a.sortKey:this._defaultSymbolSortKey}add(t,s,i){this._resultsMap.set(t.toString(),{meshWriters:s,sortKey:i}),this._defaultSymbolSortKey=Math.max(this._defaultSymbolSortKey,i+1)}size(){return super.size()+this._resultsMap.size}doMatch(t,s){const i=this._getValueFromFields(t,s);if(null!==this._nullResult&&(null==i||""===i||"<Null>"===i))return this._nullResult;if(null==i)return null;const a=i.toString();return this._resultsMap.get(a)?.meshWriters}_getValueFromFields(t,s){const i=[];for(const a of this._fields){const o=a.read(t,s);i.push(null==o||""===o?"<Null>":o)}return i.join(this._separator)}}function ke(h,t,s,i){return He.apply(this,arguments)}function He(){return(He=(0,m.Z)(function*(h,t,s,i){switch(s.type){case"simple":case"heatmap":case"dot-density":case"pie-chart":return Ie.from(h,t,s,i);case"interval":return Ve.fromIntervalSchema(h,t,s,i);case"dictionary":return Ye.fromDictionaryRenderer(h,s,i);case"label":return $e.fromLabelSchema(h,t,s,i);case"map":return Ke.fromMatcherSchema(h,t,s,i);case"subtype":return Xe.fromSubtypes(h,t,s,i);case"cluster":return Qe.fromClusterSchema(h,t,s,i);default:throw new Error("Impl")}})).apply(this,arguments)}class Xe extends Ie{constructor(t,s){super(),this._subMatchers=t,this._subtypeField=s}static fromSubtypes(t,s,i,a){return(0,m.Z)(function*(){const o=new Map,u=[];for(const l in i.renderers){const d=parseInt(l,10),c=ke(t,s,i.renderers[l],a).then(p=>o.set(d,p));u.push(c)}return yield Promise.all(u),new Xe(o,i.subtypeField)})()}match(t,s){const i=t.readAttribute(this._subtypeField),a=this._subMatchers.get(i);return a?a.match(t,s):null}}class Qe extends Ie{static fromClusterSchema(t,s,i,a){return(0,m.Z)(function*(){const[o,u]=yield Promise.all([ke(t,s,i.feature,a),ke(t,s,i.cluster,a)]);return new Qe(o,u)})()}constructor(t,s){super(),this._featureMatcher=t,this._clusterMatcher=s}match(t,s){return 1===t.readAttribute("cluster_count")?this._featureMatcher.match(t,s):this._clusterMatcher.match(t,s)}}class Je extends Jt{static create(t,s,i,a){return(0,m.Z)(function*(){const o=yield ke(t,s,i.symbology,a),u=i.labels?yield ke(t,s,i.labels,a):null;return new Je(o,u)})()}constructor(t,s){super(),this._symbology=t,this._labels=s}destroy(){}enqueueMatcherRequests(t,s){var i=this;return(0,m.Z)(function*(){yield Promise.all([i._symbology.fetchResources(t,s),i._labels?.fetchResources(t,s)])})()}enqueueWriterRequests(t,s,i){const a=this._symbology.match(s,i);if(a){for(const o of a)o.enqueueRequest(t,s,i);if(this._labels){const o=this._labels.match(s,i);if(!o)return;for(const u of o)u.enqueueRequest(t,s,i)}}}write(t,s,i,a,o){const u=this._symbology.match(i,a);if(u){for(const l of u)l.write(t,s,i,a,o);if(t.entityRecordCount()>=1&&this._labels){const l=this._labels.match(i,a);if(!l)return;for(const d of l)d.setReferences(u),d.write(t,s,i,a,o)}}}getSortKey(t,s){return this._symbology.getSortKey(t,s)}}var es=g(8380),Tt=g(71251);class ts{constructor(t){this._outstandingMessages=[],this._queue=new Tt.e({concurrency:t.concurrency,process:s=>t.process(s)})}push(t){var s=this;return(0,m.Z)(function*(){if(t.end)return yield Promise.all(s._outstandingMessages),yield s._queue.push(t),void(s._outstandingMessages=[]);const i=s._queue.push(t);return s._outstandingMessages.push(i),i})()}}var ss=g(24191);function je(h){var t={},s=!1;function i(a,o){return s=!0,o=new Promise(function(u){u(h[a](o))}),{done:!1,value:new ss.Z(o,1)}}return t[typeof Symbol<"u"&&Symbol.iterator||"@@iterator"]=function(){return this},t.next=function(a){return s?(s=!1,a):i("next",a)},"function"==typeof h.throw&&(t.throw=function(a){if(s)throw s=!1,a;return i("throw",a)}),"function"==typeof h.return&&(t.return=function(a){return s?(s=!1,a):i("return",a)}),t}var xe=g(26420),ve=g(79671),et=(g(29132),g(83274)),J=g(82054),Se=g(66385),tt=g(82959),rs=g(90725);class Ae{static create(t,s){return(0,m.Z)(function*(){if("count"===s.statisticType){const a=new rs.J(1);return new Ae(s.name,s.alias,s.type,s.statisticType,a)}const i=yield t.createComputedField({expression:s.onStatisticExpression?.expression,field:s.onStatisticField});return new Ae(s.name,s.alias,s.type,s.statisticType,i)})()}constructor(t,s,i,a,o){this.name=t,this.alias=s,this.type=i,this.statisticType=a,this.computed=o}}var st=g(61885),rt=g(5548),ns=g(92794),Ct=g(73771);class nt{constructor(t){this.subscription=t,this.handledChunks=new Set}destroy(){}}class Mt{constructor(t,s){this._source=t,this._attributeStore=s,this._sendStates=new Map}destroy(){}get enablePixelBuffering(){return!0}onSubscribe(t){const s=this.createState(t);this._sendStates.set(t.key.id,s),this.updateChunks()}onUnsubscribe(t){this._sendStates.get(t.key.id)?.destroy(),this._sendStates.delete(t.key.id)}invalidate(){const t=Array.from(this._sendStates.values());this._sendStates.clear();for(const s of t)s.destroy(),this.onSubscribe(s.subscription)}invalidateAttributeData(){}getFeatureObjectIdsForAggregate(t){throw new Error("InternalError: AggregateId lookup not supported")}getDisplayIds(t){return this.displayMap(t,s=>s,s=>s)}getDisplayAndObjectIds(t){return this.displayMap(t,s=>s,(s,i,a)=>[s,a])}afterUpdateChunks(){}}class Ot extends Mt{constructor(t,s,i,a){super(t,s),this.spatialReference=i,this.aggregateFields=a,this.events=new st.Z,this.featureAdapter=ns.n}get aggregateQueryEngine(){return this._aggregateQueryEngine||(this._aggregateQueryEngine=new Ct.q({featureStore:this,fieldsIndex:this._metadata.fieldsIndex,geometryType:this._metadata.geometryType,objectIdField:this._metadata.objectIdField,spatialReference:this.spatialReference})),this._aggregateQueryEngine}removeChunks(t){}forEach(t){return this.forEachAggregateWorldSpace(t)}forEachInBounds(t,s){}forEachBounds(t,s){const i=(0,rt.Ue)();for(const a of t){const o=(0,J.$)(i,a.geometry,!1,!1);o&&s(o)}}}class it{constructor(t,s,i,a,o){this.subscription=t,this.reader=s,this.clear=i,this.end=a,this.debugInfo=o,this.type="append"}get id(){return this.subscription.tile.id}createMessage(t,s,i){return{type:"append",clear:this.clear,id:this.id,append:t,end:this.end,debugInfo:this.debugInfo,subscriptionVesrion:this.subscription.version,version:s,attributeEpoch:i}}}class at{constructor(t,s,i,a,o){this.subscription=t,this.reader=s,this.remove=i,this.end=a,this.debugInfo=o,this.type="update"}get id(){return this.subscription.tile.id}createMessage(t,s,i){return{type:"update",id:this.id,modify:t,debugInfo:this.debugInfo,remove:this.remove,version:s,subscriptionVesrion:this.subscription.version,end:this.end,attributeEpoch:i}}}var ot=g(46836),kt=g(70236),ut=g(44222),At=g(60466),lt=g(25208);class X extends lt.s{static fromFeatures(t,s){const{objectIdField:i,geometryType:a}=s,o=(0,J.Yn)([],t,a,!1,!1,i);for(let u=0;u<o.length;u++)o[u].displayId=t[u].displayId;return X.fromOptimizedFeatures(o,s)}static fromFeatureSet(t,s){const i=(0,J.h_)(t,s.objectIdField);return X.fromOptimizedFeatureSet(i,s)}static fromOptimizedFeatureSet(t,s){const i=X.fromOptimizedFeatures(t.features,s);return i._exceededTransferLimit=t.exceededTransferLimit,i._transform=t.transform,i._fieldsIndex=new At.Z(t.fields),i}static fromOptimizedFeatures(t,s,i){const a=new X(t,s);return a._fieldsIndex=s.fieldsIndex,a._transform=i,a}static empty(t){return new X([],t)}constructor(t,s){super(s),this._exceededTransferLimit=!1,this._featureIndex=-1,this._fieldsIndex=null,this._geometryType=s.geometryType,this._features=t}get fields(){return this._fieldsIndex}get geometryType(){return this._geometryType}get hasFeatures(){return!!this._features.length}get hasNext(){return this._featureIndex+1<this._features.length}get exceededTransferLimit(){return this._exceededTransferLimit}get hasZ(){return!1}get hasM(){return!1}get _current(){return this._features[this._featureIndex]}removeIds(t){const s=new Set(t);this._features=this._features.filter(i=>!(null!=i.objectId&&s.has(i.objectId)))}getSize(){return this._features.length}getCursor(){return this.copy()}getInTransform(){return this._transform}getAttributeHash(){let t="";for(const s in this._current.attributes)t+=this._current.attributes[s];return t}getIndex(){return this._featureIndex}setIndex(t){this._featureIndex=t}getObjectId(){return this._current?.objectId}getDisplayId(){return this._current.displayId}setDisplayId(t){this._current.displayId=t}copy(){const t=new X(this._features,this.metadata);return this.copyInto(t),t}next(){for(;++this._featureIndex<this._features.length&&!this._getExists(););return this._featureIndex<this._features.length}readGeometryArea(){return(0,Se.S6)(this._current)?(0,J.lz)(this._current.geometry,2):0}_readX(){return(0,Se.S6)(this._current)?this._current.geometry.coords[0]:0}_readY(){return(0,Se.S6)(this._current)?this._current.geometry.coords[1]:0}_readGeometry(){return(0,Se.S6)(this._current)?this._current.geometry??null:null}_readServerCentroid(){return this._current.centroid}_readAttribute(t,s){if(!this._fieldsIndex){const o=this._current.attributes[t];if(void 0!==o)return o;const u=t.toLowerCase();for(const l in this._current.attributes)if(l.toLowerCase()===u)return this._current.attributes[l];return}const i=this._fieldsIndex.get(t);if(!i)return;let a=this._current.attributes[i.name];return null==a?a:("esriFieldTypeTimestampOffset"===this.fields.get(t)?.type&&(a=this.parseTimestampOffset(a)),s&&this.fields.isDateField(t)?new Date(a):a)}_readAttributes(){return this._current.attributes}copyInto(t){super.copyInto(t),t._featureIndex=this._featureIndex,t._transform=this._transform,t._fieldsIndex=this._fieldsIndex}}class is extends nt{constructor(t,s){super(t),this.bins=new Map,this.done=!1,this._store=s}reset(){this.destroy(),this.bins.clear(),this.done=!1,this.handledChunks.clear()}destroy(){const t=this.subscription.tile.key.level;for(const s of this.bins.values()){const i=s.cachedFeature?.objectId;null!=i&&this._store.releaseDisplayIdForObjectId(`${i}.${t}`)}}*featuresWorldSpace(){for(const t of this.bins.values()){const s=t.cachedFeature;if(s){const i=s.clone();i.geometry&&(0,J.$g)(i.geometry,i.geometry,!1,!1,this.subscription.tile.transform),yield i}}}getGeohashBounds(t,s){const i=this.subscription.tile;return(0,et.ir)(i.extent,i.resolution,s,t)}}class dt extends Ot{static create(t,s,i,a,o){return(0,m.Z)(function*(){const u=new ot.O({spatialReference:s}),l=t.fixedBinLevel,d=yield Promise.all(t.fields.map(function(){var p=(0,m.Z)(function*(_){return Ae.create(u,_)});return function(_){return p.apply(this,arguments)}}())),c=t.featureFilter?yield kt.Z.create({geometryType:i.metadata.geometryType,hasM:!1,hasZ:!1,timeInfo:i.metadata.timeInfo,fieldsIndex:i.metadata.fieldsIndex,spatialReference:s,filterJSON:t.featureFilter}):null;return yield(0,tt._W)(s,ne.Z.WGS84),new dt({fields:d,geohashLevel:l,spatialReference:s,featureFilter:c,timeZone:o},t.fields,i,a)})()}constructor(t,s,i,a){super(i,a,t.spatialReference,t.fields),this._indexOptions=t,this._metadata=new ut.A({geometryType:"esriGeometryPolygon",objectIdField:"aggregateId",fields:s,globalIdField:null,spatialReference:i.metadata.spatialReference,subtypeField:null,subtypes:null,timeInfo:null,timeReferenceUnknownClient:null,typeIdField:null,types:null})}createState(t){return new is(t,this._attributeStore)}applyOverride(t){var s=this;return(0,ve.Z)(function*(){for(const i of s._sendStates.values())i.reset(),yield new it(i.subscription,X.empty(s._source.metadata),!0,!1,{})})()}displayMap(t,s,i){const a=new Map(t.map(u=>[s(u),u])),o=[];for(const u of this._sendStates.values())for(const l of u.featuresWorldSpace()){const{objectId:d,displayId:c}=l,p=a.get(d);if(null!=p){const _=i(c,p,d);o.push(_),a.delete(d)}}return o}getDisplayFeatures(t){const s=new Set(t),i=new Set,a=[];for(const o of this._sendStates.values())for(const u of o.featuresWorldSpace())s.has(u.displayId)&&!i.has(u.objectId)&&(u.geometry&&a.push({...(0,J.EI)(u,this._metadata.geometryType,!1,!1),displayId:u.displayId}),i.add(u.objectId));return{features:[],aggregates:a}}getFeatureObjectIdsForAggregate(t){for(const s of this._sendStates.values())for(const i of s.bins.values())if(i.id===t)return Array.from(i.objectIds);return[]}updateChunks(){var t=this;return(0,ve.Z)(function*(){if(t._source.chunks().length)for(const s of t._sendStates.values())yield*je((0,le.Z)(t._update(s,t._source)))})()}forEachAggregateWorldSpace(t){for(const s of this._sendStates.values())for(const i of s.featuresWorldSpace())t(i)}_update(t,s){var i=this;return(0,ve.Z)(function*(){const{handledChunks:a,subscription:o,bins:u}=t,{spatialReference:l,geohashLevel:d}=i._indexOptions,c=o.tile;if(t.done)return;for(const R of s.chunks()){if(a.has(R.chunkId))continue;a.add(R.chunkId);const W=R.queryInfo;if("tileId"in W){const Y=new H.Z(W.tileId);if(Y.level!==c.level||Y.world!==c.key.world)continue}const z=R.getGeohashIndex(i._indexOptions),V=t.getGeohashBounds(l,d);null!=V&&z.putBins(u,V)}const p=[],_=o.tile.transform,E=o.tile.key.level;for(const R of u.values()){if(R.cachedFeature)R.cachedFeature.attributes=R.getAttributes();else{const W=R.getGeometry(i.spatialReference,_),z=new Se.u_(W,R.getAttributes(),null);W||(z.centroid=R.getGeometryCentroid(i.spatialReference,_)),z.objectId=R.id,z.displayId=i._attributeStore.createDisplayIdForObjectId(`${z.objectId}.${E}`),R.cachedFeature=z}p.push(R.cachedFeature)}i.events.emit("changed"),t.done=!s.updateTracking.updating;const M=X.fromOptimizedFeatures(p,i._metadata,_),C=M.getCursor(),N=t.subscription.tile.createArcadeEvaluationOptions(i._indexOptions.timeZone);for(;C.next();)i._attributeStore.setAttributeData(C.getDisplayId(),C,N);yield new at(t.subscription,M,[],t.done,{})})()}}var re=g(88071),as=g(55442);const Pt=Math.PI/180;class Pe{static create(t){return new Pe(t.map(s=>function os(h){switch(h.statisticType){case"min":return new ct(h);case"max":return new ht(h);case"avg":return new ft(h);case"avg_angle":return new pt(h);case"sum":case"count":return new _t(h);case"mode":return new gt(h)}}(s)))}constructor(t){this._statistics=t}values(){return this._statistics.values()}insert(t,s){for(const i of this._statistics)i.insert(t,s)}merge(t){for(let s=0;s<this._statistics.length;s++){const i=this._statistics[s],a=t._statistics[s];if(i.field.name!==a.field.name)throw new Error("InternalError: Tried to merge incompatible statistics");i.merge(a)}}clone(){return new Pe(this._statistics.map(t=>t.clone()))}}class Te{constructor(t){this.field=t}insert(t,s){if(!this.field.computed)return;const i=this.field.computed.read(t,s);(0,as.s_)(i)||this._insertValue(i)}}class ct extends Te{constructor(){super(...arguments),this.type="min",this.value=Number.MAX_VALUE}_insertValue(t){this.value=Math.min(this.value,t)}merge(t){this.value=Math.min(this.value,t.value)}clone(){const t=new ct(this.field);return t.value=this.value,t}}class ht extends Te{constructor(){super(...arguments),this.type="max",this.value=Number.MIN_VALUE}_insertValue(t){this.value=Math.max(this.value,t)}merge(t){this.value=Math.max(this.value,t.value)}clone(){const t=new ht(this.field);return t.value=this.value,t}}class _t extends Te{constructor(){super(...arguments),this.type="sum",this.value=0}_insertValue(t){this.value+=t}merge(t){this.value+=t.value}clone(){const t=new _t(this.field);return t.value=this.value,t}}class ft extends Te{constructor(){super(...arguments),this.type="avg",this._total=0,this._count=0}get value(){return this._total/this._count}_insertValue(t){this._total+=t,this._count+=1}merge(t){this._total+=t._total,this._count+=t._count}clone(){const t=new ft(this.field);return t._total=this._total,t._count=this._count,t}}class pt extends Te{constructor(){super(...arguments),this.type="avg_angle",this._x=0,this._y=0,this._count=0}get value(){const i=180/Math.PI;return Math.atan2(this._y/this._count,this._x/this._count)*i}_insertValue(t){this._x=this._x+Math.cos(t*Pt),this._y=this._y+Math.sin(t*Pt),this._count+=1}merge(t){this._x+=t._x,this._y+=t._y,this._count+=t._count}clone(){const t=new pt(this.field);return t._x=this._x,t._y=this._y,t._count=this._count,t}}class gt extends Te{constructor(){super(...arguments),this._frequencies=new Map}get value(){let t,s=0;for(const[i,a]of this._frequencies.entries())a>s&&(s=a,t=i);return t}_insertValue(t){const s=this._frequencies.get(t);this._frequencies.set(t,null!=s?s+1:1)}merge(t){for(const[s,i]of t._frequencies.entries()){const a=this._frequencies.get(s);this._frequencies.set(s,null!=a?a+i:i)}}clone(){const t=new gt(this.field);return t._frequencies=new Map(this._frequencies),t}}class Fe{static createId(t,s){return`${t}.${s}`}static create(t,s,i,a){return new Fe(t,s,Pe.create(i),a)}constructor(t,s,i,a){this.gridX=t,this.gridY=s,this._statistics=i,this._worldUnitsPerCell=a,this._count=0,this._xWorldTotal=0,this._yWorldTotal=0,this._objectIds=new Set}get id(){return Fe.createId(this.gridX,this.gridY)}get count(){return this._count}get statistics(){return this._statistics}get objectIds(){return this._objectIds}get firstObjectId(){return this._objectIds.values().next().value}get centroidXWorld(){return this._xWorldTotal/this._count}get centroidYWorld(){return this._yWorldTotal/this._count}clone(){const t=new Fe(this.gridX,this.gridY,this._statistics.clone(),this._worldUnitsPerCell);return t._count=this._count,t._xWorldTotal=this._xWorldTotal,t._yWorldTotal=this._yWorldTotal,t._firstFeatureAttributes=this._firstFeatureAttributes,t._objectIds=new Set(this._objectIds),t}insert(t,s,i,a){this._firstFeatureAttributes=0===this._count?t.readAttributes():null,this._count+=1,this._xWorldTotal+=i,this._yWorldTotal+=a,this._statistics.insert(t,s),this._objectIds.add(t.getObjectId())}merge(t){if(0!==t._count){this._count+=t._count,this._firstFeatureAttributes=t._firstFeatureAttributes,this._xWorldTotal+=t._xWorldTotal,this._yWorldTotal+=t._yWorldTotal,this._statistics.merge(t._statistics);for(const s of t._objectIds.values())this._objectIds.add(s)}}getCentroidX(t){return null==t?this.centroidXWorld:(0,J.Jd)(t,this.centroidXWorld)}getCentroidY(t){return null==t?this.centroidYWorld:(0,J.IN)(t,this.centroidYWorld)}getCentroid(t){const s=new re.Z([],[this.centroidXWorld,this.centroidYWorld]);if(null!=t){const i=new re.Z;return(0,J.Nh)(i,s,!1,!1,"esriGeometryPoint",t)}return s}getGeometricCentroid(t){const a=new re.Z([],[this.gridX*this._worldUnitsPerCell+.5*this._worldUnitsPerCell,this.gridY*this._worldUnitsPerCell+.5*this._worldUnitsPerCell]);if(null!=t){const o=new re.Z;return(0,J.Nh)(o,a,!1,!1,"esriGeometryPoint",t)}return a}getAttributes(){const t={aggregateId:this.id};for(const s of this._statistics.values())t[s.field.name]=s.value;return null!=this._firstFeatureAttributes?{...t,...this._firstFeatureAttributes}:t}}var Rt=g(16730);const us=96;function yt(h,t){return(0,Rt.c9)(h)*Rt.hd*us/t}class ls{constructor(t){this._options=t,this._cells=new Map,this._pixelsPerMapUnit=yt(t.spatialReference,t.scale)}insert(t,s){const i=t.getCursor(),a={$view:{scale:this._options.scale,timeZone:this._options.timeZone}};for(;i.next();)this._insertFeature(i,a,s)}putCellsInBounds(t,s){const[i,a,o,u]=s,l=Math.floor(i*this._pixelsPerMapUnit/this._options.cellSize),d=Math.floor(a*this._pixelsPerMapUnit/this._options.cellSize),c=Math.ceil(o*this._pixelsPerMapUnit/this._options.cellSize),p=Math.ceil(u*this._pixelsPerMapUnit/this._options.cellSize);for(let _=d;_<=p;_++)for(let E=l;E<=c;E++){const C=this._cells.get(`${E}.${_}`);if(!C)continue;const N=t.get(C.id);N?C&&!t.has(C.id)&&N.merge(C):t.set(C.id,C.clone())}}putCells(t){for(const s of this._cells.values()){const i=t.get(s.id);i?i.merge(s):t.set(s.id,s.clone())}}_insertFeature(t,s,i){const{featureFilter:a}=this._options;if(null!==a&&!a.check(t))return;let o=0,u=0;if("esriGeometryPoint"===t.geometryType)o=t.readXWorldSpace(),u=t.readYWorldSpace();else{if(i){const E=t.readCentroidForDisplay();if(null==E)return;const[M,C]=E.coords;if(M<0||M>B.i9||C<0||C>B.i9)return}const _=t.readCentroidWorldSpace();if(null==_)return;o=_.coords[0],u=_.coords[1]}const d=u*this._pixelsPerMapUnit,c=Math.floor(o*this._pixelsPerMapUnit/this._options.cellSize),p=Math.floor(d/this._options.cellSize);this._getCellOrCreate(c,p).insert(t,s,o,u)}_getCellOrCreate(t,s){const i=Fe.createId(t,s);let a=this._cells.get(i);return a||(a=Fe.create(t,s,this._options.fields,1*this._options.cellSize/this._pixelsPerMapUnit),this._cells.set(i,a)),a}}class ds{constructor(t,s){this.inner=t,this.displayId=s}}class cs extends nt{constructor(t){super(t),this.didSend=!1,this.done=!1}}class hs{constructor(t,s,i,a,o){this._level=t,this._scale=s,this._indexOptions=i,this._clusterRadius=a,this._store=o,this._cells=new Map,this._handledChunks=new Set,this._statistics=new Map,this._clusters=new Map}destroy(){this._clearClusters()}_clearClusters(){for(const t of this._clusters.values())this._store.releaseDisplayIdForObjectId(t.inner.id);this._clusters.clear()}*aggregatesWorldSpace(){for(const t of this._clusters.values()){const s=t.inner.getCentroid(null),i=new Se.u_(s,t.inner.getAttributes(),null);i.objectId=t.inner.id,i.displayId=t.displayId,yield i}}clusters(){return this._clusters.values()}updateChunks(t,s){let i=!1;for(const l of t){const d=l.queryInfo;"tileId"in d&&new H.Z(d.tileId).level!==this._level||this._handledChunks.has(l.normalizedChunkId)||(this._handledChunks.add(l.normalizedChunkId),i=!0,l.getGridIndex({...this._indexOptions,scale:this._scale}).putCells(this._cells))}const a={xMin:1/0,yMin:1/0,xMax:-1/0,yMax:-1/0},o=yt(this._indexOptions.spatialReference,this._scale),u=this._indexOptions.cellSize;for(const{subscription:l}of s){const d=l.tile.bounds,c=Math.floor(d[0]*o/u),p=Math.floor(d[1]*o/u),_=Math.ceil(d[2]*o/u),E=Math.ceil(d[3]*o/u);a.xMin=Math.min(a.xMin,c),a.yMin=Math.min(a.yMin,p),a.xMax=Math.max(a.xMax,_),a.yMax=Math.max(a.yMax,E)}return null!=this._lastCellBounds&&a.xMin===this._lastCellBounds.xMin&&a.yMin===this._lastCellBounds.yMin&&a.yMin===this._lastCellBounds.yMin&&a.yMax===this._lastCellBounds.yMax||(i=!0,this._lastCellBounds=a),i&&this._clusterCells(a),i}updateStatistics(t){var s=this;return(0,m.Z)(function*(){let i=!1;for(const a of s._clusters.values())a.inner.count>1&&(i=s._updateAggregateStatistics(s._statistics,a.inner)||i);if(i){const a=Array.from(s._statistics.entries()).map(([o,u])=>({fieldName:o,minValue:u.minValue,maxValue:u.maxValue}));yield t.container.updateStatistics(s._level,a)}})()}createAggregateFeatures(t,s){const i=t.subscription,a=[],o=i.tile.transform;for(const u of this._clusters.values()){let l=u.inner.getCentroidX(o);const d=u.inner.getCentroidY(o),c=i.tile.lod,p=c.wrap?c.worldSize[0]:null,_=1===u.inner.count?u.inner.firstObjectId:u.inner.id,E=u.displayId;if(null!=p)if(1===p){const M=new re.Z([],[l,d]),C=new Se.u_(M,u.inner.getAttributes(),null);C.geometry.coords[0]-=B.i9,C.objectId=_,C.displayId=E,a.push(C);const N=new re.Z([],[l,d]),L=new Se.u_(N,u.inner.getAttributes(),null);L.geometry.coords[0]+=B.i9,L.objectId=_,L.displayId=E,a.push(L)}else l>B.i9+B.i9/2?l-=p*B.i9:l<-B.i9/2&&(l+=p*B.i9);if(l<B.i9+128&&l>=-128&&d<B.i9+128&&d>=-128){const M=new re.Z([],[l,d]),C=new Se.u_(M,u.inner.getAttributes(),null);C.objectId=_,C.displayId=E,a.push(C)}}return X.fromOptimizedFeatures(a,s,i.tile.transform)}_clusterCells(t){let s=Array.from(this._cells.values());s=s.sort((l,d)=>d.count-l.count);const i=[];for(const l of this._clusters.values())i.push(l.inner.id);this._clusters.clear();const a=this._clusterRadius*(1/yt(this._indexOptions.spatialReference,this._scale)),o=1+this._clusterRadius/this._indexOptions.cellSize,u=new Set;for(const l of s){if(u.has(l.id)||l.gridX<t.xMin||l.gridX>t.xMax||l.gridY<t.yMin||l.gridY>t.yMax)continue;const d=this._store.createDisplayIdForObjectId(l.id),c=new ds(l.clone(),d);u.add(l.id),this._clusters.set(l.id,c);const p=l.centroidXWorld,_=l.centroidYWorld;for(let E=l.gridY-o;E<=l.gridY+o;E++)for(let M=l.gridX-o;M<=l.gridX+o;M++){if(E===l.gridY&&M===l.gridX)continue;const C=this._cells.get(Fe.createId(M,E));if(!C||u.has(C.id))continue;const N=Math.abs(C.centroidXWorld-p),L=Math.abs(C.centroidYWorld-_);N<a&&L<a&&(c.inner.merge(C),u.add(C.id))}}for(const l of i)this._store.releaseDisplayIdForObjectId(l)}_updateAggregateStatistics(t,s){let i=!1;for(const a of s.statistics.values()){if("esriFieldTypeString"===a.field.type)continue;const o=a.value,u=a.field,l=t.get(u.name);if(l){const{minValue:d,maxValue:c}=l,p=Math.min(l.minValue,o),_=Math.max(l.maxValue,o);d===p&&c===_||(l.minValue=p,l.maxValue=_,i=!0)}else t.set(u.name,{minValue:o,maxValue:o}),i=!0}return i}}class mt extends Ot{static create(t,s,i,a,o,u){return(0,m.Z)(function*(){const l=new ot.O({spatialReference:i}),d={fields:yield Promise.all(s.fields.map(function(){var c=(0,m.Z)(function*(p){return Ae.create(l,p)});return function(p){return c.apply(this,arguments)}}())),spatialReference:i,featureFilter:s.featureFilter?yield kt.Z.create({geometryType:a.metadata.geometryType,hasM:!1,hasZ:!1,timeInfo:a.metadata.timeInfo,fieldsIndex:a.metadata.fieldsIndex,spatialReference:i,filterJSON:s.featureFilter}):null,cellSize:s.clusterRadius/4,timeZone:u};return new mt(t,s.clusterRadius,d,s.fields,a,o)})()}constructor(t,s,i,a,o,u){super(o,u,i.spatialReference,i.fields),this._connection=t,this._clusterRadius=s,this._indexOptions=i,this._cellsPerScale=new Map,this._metadata=new ut.A({geometryType:"esriGeometryPoint",objectIdField:"aggregateId",fields:[...a,...this._source.metadata.fieldsIndex.fields,{name:"aggregateId",alias:"aggregateId",type:"esriFieldTypeOID"}],globalIdField:null,spatialReference:o.metadata.spatialReference,subtypeField:null,subtypes:null,timeInfo:null,timeReferenceUnknownClient:null,typeIdField:null,types:null})}get enablePixelBuffering(){return!1}invalidate(){super.invalidate();for(const t of this._cellsPerScale.values())t.destroy();this._cellsPerScale.clear()}onSubscribe(t){super.onSubscribe(t),this._requiredLevel=t.tile.level,this._requiredScale=t.tile.scale}createState(t){return new cs(t)}applyOverride(t){var s=this;return(0,ve.Z)(function*(){for(const i of s._cellsPerScale.values())i.destroy();s._cellsPerScale.clear();for(const i of s._sendStates.values())i.done=!1})()}displayMap(t,s,i){const a=new Map(t.map(l=>[s(l),l])),o=[],u=this._getClusterState(this._requiredLevel,this._requiredScale);for(const l of u.clusters()){const d=a.get(l.inner.id);if(null==d){if(1===l.inner.count){const c=a.get(l.inner.firstObjectId);if(null!=c){const p=i(l.displayId,c,l.inner.firstObjectId);o.push(p),a.delete(l.inner.firstObjectId)}}}else{const c=i(l.displayId,d,l.inner.id);o.push(c),a.delete(l.inner.id)}}return o}getDisplayFeatures(t){const s=new Set(t),i=new Set,a=[],o=[],u=this._getClusterState(this._requiredLevel,this._requiredScale);for(const l of u.aggregatesWorldSpace())if(s.has(l.displayId)&&!i.has(l.displayId)){const d=(0,J.EI)(l,this._metadata.geometryType,!1,!1);if(i.add(l.displayId),1===d.attributes.cluster_count){a.push({...d,displayId:l.displayId});continue}o.push({...d,displayId:l.displayId})}return{features:a,aggregates:o}}getFeatureObjectIdsForAggregate(t){const s=this._getClusterState(this._requiredLevel,this._requiredScale);for(const i of s.clusters())if(i.inner.id===t)return Array.from(i.inner.objectIds);return[]}updateChunks(){var t=this;return(0,ve.Z)(function*(){const s=t._source.chunks();if(!s.length)return;const i=t._getClusterState(t._requiredLevel,t._requiredScale),a=Array.from(t._sendStates.values()).filter(l=>l.subscription.tile.level===t._requiredLevel);if(i.updateChunks(s,a)||!t._source.updateTracking.updating)for(const l of a)l.subscription.tile.level===t._requiredLevel&&(l.didSend=!1,l.done=!1);const o=Array.from(t._sendStates.values()).filter(l=>l.done).map(l=>l.subscription.tile.key),u=new Set(o);for(const l of t._sendStates.values())t._source.updateTracking.updating&&(o.some(d=>d.containsChild(l.subscription.tile.key))||l.subscription.tile.key.getChildKeys().every(d=>u.has(d)))||l.didSend||l.subscription.tile.level!==t._requiredLevel||(l.didSend=!0,yield*je((0,le.Z)(t._update(l,i,t._source))));yield(0,xe.Z)(i.updateStatistics(t._connection))})()}forEachAggregateWorldSpace(t){if(null==this._requiredLevel||null==this._requiredScale)return;const s=this._getClusterState(this._requiredLevel,this._requiredScale);for(const i of s.aggregatesWorldSpace())t(i)}_getClusterState(t,s){if(null==t||null==s)throw new Error("InternalError: Level and scale must be defined");let i=this._cellsPerScale.get(s);return i||(i=new hs(t,s,this._indexOptions,this._clusterRadius,this._attributeStore),this._cellsPerScale.set(s,i)),i}_update(t,s,i){var a=this;return(0,ve.Z)(function*(){if(t.done)return;const o=s.createAggregateFeatures(t,a._metadata);a.events.emit("changed"),t.done=!i.updateTracking.updating;const u=o.getCursor(),l=t.subscription.tile.createArcadeEvaluationOptions(a._indexOptions.timeZone);for(;u.next();)a._attributeStore.setAttributeData(u.getDisplayId(),u,l);yield new it(t.subscription,o,!0,t.done,{})})()}}var _s=g(76279);class It{static fromReader(t){const s=[],i=t.copy(),a=(0,rt.Ue)();for(;i.next();)i.getBounds(a)&&s.push(i.getIndex());const o=(0,_s.r)(9,u=>(i.setIndex(u),{minX:i.getBoundsXMin(),minY:i.getBoundsYMin(),maxX:i.getBoundsXMax(),maxY:i.getBoundsYMax()}));return o.load(s),new It(o)}constructor(t){this._index=t}search(t){return this._index.search({minX:t[0],minY:t[1],maxX:t[2],maxY:t[3]})}}class Re{static create(t,s,i,a){const o=Pe.create(t),u=new Array(32);for(let l=0;l<u.length;l++)u[l]=null;return new Re(o,s,i,a,u)}constructor(t,s,i,a,o){this._statistics=t,this.xNode=s,this.yNode=i,this.depth=a,this.children=o,this._objectIds=new Set,this._count=0,this._xWorldTotal=0,this._yWorldTotal=0,this._xGeohashTotal=0,this._yGeohashTotal=0,this.next=null}get id(){return`${this.xNode}.${this.yNode}`}get objectIds(){return this._objectIds}clone(){const t=new Re(this._statistics.clone(),this.xNode,this.yNode,this.depth,this.children);return t._count=this._count,t._xWorldTotal=this._xWorldTotal,t._yWorldTotal=this._yWorldTotal,t._xGeohashTotal=this._xGeohashTotal,t._yGeohashTotal=this._yGeohashTotal,t.next=this.next,t.cachedFeature=this.cachedFeature,t._objectIds=new Set(this._objectIds),t}insert(t,s,i,a,o,u){this._count+=1,this._xWorldTotal+=s,this._yWorldTotal+=i,this._xGeohashTotal+=a,this._yGeohashTotal+=o,this._statistics.insert(t,u),this._objectIds.add(t.getObjectId())}merge(t){if(0!==t._count){this._count+=t._count,this._xWorldTotal+=t._xWorldTotal,this._yWorldTotal+=t._yWorldTotal,this._xGeohashTotal+=t._xWorldTotal,this._yGeohashTotal+=t._yWorldTotal,this._statistics.merge(t._statistics);for(const s of t._objectIds.values())this._objectIds.add(s)}}getGeometry(t,s){const i=this._getLngLatBounds(),[a,o,u,l]=i,d=(0,tt.iV)({rings:[[[a,o],[a,l],[u,l],[u,o],[a,o]]]},ne.Z.WGS84,t),c=(0,J.Uy)(new re.Z,d,!1,!1);return null!=s?(0,J.Nh)(new re.Z,c,!1,!1,"esriGeometryPolygon",s,!1,!1):c}getGeometryCentroid(t,s){const i=this._getLngLatBounds(),[a,o,u,l]=i,d=(0,tt.iV)({x:(a+u)/2,y:(o+l)/2},ne.Z.WGS84,t),c=(0,J.dd)(new re.Z,d);return null!=s?(0,J.Nh)(new re.Z,c,!1,!1,"esriGeometryPoint",s,!1,!1):c}getAttributes(){const t={aggregateId:this.id};for(const s of this._statistics.values())t[s.field.name]=s.value;return t.aggregateCount=this._count,t}_getLngLatBounds(){const t=this.depth,s=Math.ceil(t/2),i=Math.floor(t/2);return(0,et.bU)({geohashX:this.xNode<<30-(3*s+2*i),geohashY:this.yNode<<30-(2*s+3*i)},this.depth)}}class fs{constructor(t){this._fields=t,this._root=Re.create(this._fields,0,0,0)}destroy(){}insert(t,s,i,a,o,u,l){let d=this._root,c=0,p=0,_=0;for(;null!==d;){if(d.insert(t,s,i,a,o,l),c>=u)return;const E=Math.ceil((c+1)/2),M=Math.floor((c+1)/2),C=1-c%2,N=30-(3*E+2*M),L=30-(2*E+3*M),R=(a&7*C+3*(1-C)<<N)>>N,W=(o&3*C+7*(1-C)<<L)>>L,z=R+W*(8*C+4*(1-C));p=p<<3*C+2*(1-C)|R,_=_<<2*C+3*(1-C)|W,null==d.children[z]&&(d.children[z]=Re.create(this._fields,p,_,c+1)),c+=1,d=d.children[z]}}putBins(t,s){for(const i of this.getNodes(s)){const a=t.get(i.id);a?a.merge(i):t.set(i.id,i.clone())}}getNodes(t){const s=[],{geohashBounds:i,level:a}=t;let o=this._root;for(;null!==o;){const u=o.depth,l=o.xNode,d=o.yNode;if(u>=a){s.push(o),o=o.next;continue}const c=Math.ceil((u+1)/2),p=Math.floor((u+1)/2),_=1-u%2,E=30-(3*c+2*p),M=30-(2*c+3*p),C=~((1<<E)-1),N=~((1<<M)-1),R=(i.yLL&N)>>M,W=(i.xTR&C)>>E,z=(i.yTR&N)>>M,V=l<<3*_+2*(1-_),Y=d<<2*_+3*(1-_),Q=V+8*_+4*(1-_),K=Y+4*_+8*(1-_),te=Math.max(V,(i.xLL&C)>>E),pe=Math.max(Y,R),ge=Math.min(Q,W),ee=Math.min(K,z);let ce=null,we=null;for(let Ee=pe;Ee<=ee;Ee++)for(let Et=te;Et<=ge;Et++){const Ze=o.children[Et-V+(Ee-Y)*(8*_+4*(1-_))];Ze&&(ce||(ce=Ze,ce.next=o.next),we&&(we.next=Ze),we=Ze,Ze.next=o.next)}o=ce||o.next}return s}}class ps{constructor(t){this._options=t,this._tree=new fs(t.fields)}insert(t,s){const i=t.getCursor(),a={$view:{scale:0,timeZone:this._options.timeZone}};for(;i.next();)this._insertFeature(i,a,s)}putBins(t,s){this._tree.putBins(t,s)}_insertFeature(t,s,i){const{featureFilter:a,geohashLevel:o,spatialReference:u}=this._options;if(null!==a&&!a.check(t))return;let l=0,d=0;if("esriGeometryPoint"===t.geometryType)l=t.readXWorldSpace(),d=t.readYWorldSpace();else{if(i){const _=t.readCentroidForDisplay();if(null==_)return;const[E,M]=_.coords;if(E<0||E>B.i9||M<0||M>B.i9)return}const p=t.readCentroidWorldSpace();if(null==p)return;l=p.coords[0],d=p.coords[1]}const c=(0,et.zp)(l,d,o,u);c&&this._tree.insert(t,l,d,c[0],c[1],o,s)}}class Be extends lt.s{static from(t,s){return new Be(t.copy(),s)}constructor(t,s){super(t.metadata),this._currentIndex=-1,this._displayTranslationX=0,this._displayTranslationY=0,this._displayScaleX=1,this._displayScaleY=1,this._reader=t,this._indices=s,this._isPoint="esriGeometryPoint"===t.geometryType}setTransformForDisplay(t){const s=this._reader.getInTransform();if(null==s){const[_,E]=t.scale,[M,C]=t.translate;return this._displayTranslationX=-M/_,this._displayScaleX=1/_,this._displayTranslationY=C/E,this._displayScaleY=1/-E,void(this._displayTransform=t)}const[i,a]=s.scale,[o,u]=s.translate,[l,d]=t.scale,[c,p]=t.translate;if(this._displayScaleX=i/l,this._displayTranslationX=(o-c)/l,this._displayScaleY=a/d,this._displayTranslationY=(-u+p)/d,!this._isPoint&&s)throw new Error("InternalError: Relative transformations not supported for non-point features");this._displayTransform=t}getInTransform(){return this._reader.getInTransform()}get fields(){return this._reader.fields}get hasNext(){return this._currentIndex+1<this._indices.length}getSize(){return this._indices.length}getCursor(){return this.copy()}copy(){const t=new Be(this._reader.copy(),this._indices);return t._currentIndex=this._currentIndex,t._displayTransform=this._displayTransform,t._displayTranslationX=this._displayTranslationX,t._displayTranslationY=this._displayTranslationY,t._displayScaleX=this._displayScaleX,t._displayScaleY=this._displayScaleY,t}get contextTimeZone(){return this._reader.contextTimeZone}set contextTimeZone(t){this._reader.contextTimeZone=t}_nextIndex(){return++this._currentIndex<this._indices.length&&(this._reader.setIndex(this._indices[this._currentIndex]),!0)}next(){for(;this._nextIndex()&&!this._reader._getExists(););return this._currentIndex<this._indices.length}readXForDisplay(){return this._reader.readXForDisplay()*this._displayScaleX+this._displayTranslationX}readYForDisplay(){return this._reader.readYForDisplay()*this._displayScaleY+this._displayTranslationY}readGeometryForDisplay(){const t=this._reader.readGeometryForDisplay();if(!this._displayTransform)return t;const s=new re.Z;return(0,J.Nh)(s,t,this.hasZ,this.hasM,this.geometryType,this._displayTransform),s.deltaDecode()}readCentroidForDisplay(){const t=this._reader.readCentroidForDisplay()?.clone();if(t){const[s,i]=t.coords;t.coords[0]=s*this._displayScaleX+this._displayTranslationX,t.coords[1]=i*this._displayScaleY+this._displayTranslationY}return t}get geometryType(){return this._reader.geometryType}get hasFeatures(){return this._reader.hasFeatures}get exceededTransferLimit(){return this._reader.exceededTransferLimit}get hasZ(){return this._reader.hasZ}get hasM(){return this._reader.hasM}readAttribute(t,s=!1){return this._reader.readAttribute(t,s)}readAttributes(){return this._reader.readAttributes()}joinAttributes(t){return this._reader.joinAttributes(t)}getBounds(t){return this._reader.getBounds(t)}getAttributeHash(){return this._reader.getAttributeHash()}getObjectId(){return this._reader.getObjectId()}getDisplayId(){return this._reader.getDisplayId()}setDisplayId(t){return this._reader.setDisplayId(t)}setIndex(t){return this._reader.setIndex(t)}getIndex(){return this._reader.getIndex()}readXWorldSpace(){return this._reader.readXWorldSpace()}readYWorldSpace(){return this._reader.readYWorldSpace()}_readX(){return this._reader.readXForDisplay()}_readY(){return this._reader.readYForDisplay()}_readServerCentroid(){return this._reader._readServerCentroid()}readLegacyFeatureForDisplay(){const t=this.readCentroidForDisplay();return{attributes:this.readAttributes(),geometry:this.readLegacyGeometryForDisplay(),centroid:(t&&{x:t.coords[0],y:t.coords[1]})??null}}readLegacyGeometryForDisplay(){const t=this.readGeometryForDisplay();return(0,J.di)(t,this.geometryType,!1,!1)}readGeometryArea(){return this._reader.readGeometryArea()}readGeometryWorldSpace(){return this._reader.readGeometryWorldSpace()}_readGeometry(){return this._reader._readGeometry()}_readAttribute(t,s){throw new Error("Error: Should not be called. Underlying _reader should be used instead")}_readAttributes(){throw new Error("Error: Should not be called. Underlying _reader should be used instead")}readArcadeFeature(){return this._reader.readArcadeFeature()}geometry(){return this._reader.geometry()}field(t){return this.readAttribute(t,!0)}hasField(t){return this._reader.hasField(t)}setField(t,s){return this._reader.setField(t,s)}keys(){return this._reader.keys()}castToText(t=!1){return this._reader.castToText(t)}}class De{size(){return this.reader.getSize()}get fields(){return this.reader.fields}invalidate(){this._geohashIndex=null,this._geohashIndexHash=null,this._spatialIndex=null,this._gridIndex=null,this._gridIndexHash=null}queryFeaturesInBounds(t){const s=this._getSpatialIndex().search(t);return Be.from(this.reader,s)}getGeohashIndex(t){const s=JSON.stringify(t);return s!==this._geohashIndexHash&&(this._geohashIndexHash=s,this._geohashIndex=new ps(t),this._geohashIndex.insert(this.reader,this.isTiled)),this._geohashIndex}getGridIndex(t){const s=JSON.stringify(t);return s!==this._gridIndexHash&&(this._gridIndexHash=s,this._gridIndex=new ls(t),this._gridIndex.insert(this.reader,this.isTiled)),this._gridIndex}_getSpatialIndex(){return this._spatialIndex||(this._spatialIndex=It.fromReader(this.reader)),this._spatialIndex}}class Dt extends De{constructor(t){super(),this.metadata=t,this.chunkId="override",this.normalizedChunkId="override",this.removed=new Set,this.overridenIds=new Set,this._features=[]}get reader(){return X.fromOptimizedFeatures(this._features,this.metadata)}get queryInfo(){return{}}get first(){return!1}get end(){return!1}get isTiled(){return!1}applyOverrides(t){super.invalidate();const{reader:s,removed:i}=t,a=[],o=new Set,u=s.getCursor(),l=new Set(i);for(this.overridenIds.clear();u.next();){const d=u.readOptimizedFeatureWorldSpace(),c=d.objectId;a.push(d),o.add(c),this.overridenIds.add(c),this.removed.delete(c)}for(const d of this._features){const c=d.objectId;l.has(c)||o.has(c)||(a.push(d),this.overridenIds.add(c))}this._features=a;for(const d of o.values())this.removed.delete(d);for(const d of i)this.removed.add(d),this.overridenIds.add(d)}getTileReader(t){if(!this._features.length)return null;const s=this.queryFeaturesInBounds(t.bounds);return s.setTransformForDisplay(t.transform),s}}class gs extends nt{}class ys extends Mt{constructor(t,s,i){super(t,s),this._timeZone=i,this.handledChunks=new Set,this.handledChunksForIdCreation=new Set,this.handledChunksForAttributeData=new Set,this._streamLayerDeferredObjectIdsToRemove=[]}destroy(){super.destroy();for(const t of this._source.chunks())this._cleanupChunkIds(t)}invalidateAttributeData(){this.handledChunksForAttributeData.clear()}onSubscribe(t){super.onSubscribe(t),this._evalOptions=t.tile.createArcadeEvaluationOptions(this._timeZone)}createState(t){return new gs(t)}get aggregateQueryEngine(){return null}displayMap(t,s,i){const a=new Map(t.map(u=>[s(u),u])),o=[];for(const u of this._source.chunks()){const l=u.reader.getCursor();for(;l.next();){const d=l.getObjectId(),c=l.getDisplayId(),p=a.get(d);if(null!=p){const _=i(c,p,d);o.push(_),a.delete(d)}}}return o}getDisplayFeatures(t){const s=new Set(t),i=new Set,a=[];for(const o of this._source.chunks()){const u=o.reader.getCursor();for(;u.next();){const l=u.getObjectId(),d=u.getDisplayId();s.has(d)&&!i.has(l)&&(a.push({...u.readLegacyFeatureWorldSpace(),displayId:d}),i.add(l))}}return{features:a,aggregates:[]}}applyOverride(t){var s=this;return(0,ve.Z)(function*(){const i=[],a=t.reader.getCursor();for(;a.next();){const d=a.getObjectId();i.push(d);const c=s._attributeStore.createDisplayIdForObjectId(d);a.setDisplayId(c),s._attributeStore.setAttributeData(c,a,s._evalOptions)}const o=s.getDisplayIds(i),u=s.getDisplayIds(t.removed),l=new Dt(s._source.metadata);l.applyOverrides(t),s.handledChunks.add(l.chunkId),s.handledChunksForAttributeData.add(l.chunkId),s.handledChunksForIdCreation.add(l.chunkId);for(const d of s._sendStates.values())d.handledChunks.add(l.chunkId),yield new at(d.subscription,null,o,!1,l.queryInfo);for(const d of s._sendStates.values()){const c=l.getTileReader(d.subscription.tile);yield new at(d.subscription,c,u,!1,l.queryInfo)}for(const d of t.removed)s._attributeStore.releaseDisplayIdForObjectId(d)})()}updateChunks(){var t=this;return(0,ve.Z)(function*(){if(t._source.chunks().length){yield(0,xe.Z)(t._updateAttributeData());for(const s of t._sendStates.values())yield*je((0,le.Z)(t._update(s)))}})()}removeChunks(t){for(const s of t)this.handledChunks.delete(s.chunkId),this.handledChunksForAttributeData.delete(s.chunkId),this._cleanupChunkIds(s)}afterUpdateChunks(){for(const t of this._streamLayerDeferredObjectIdsToRemove)this._attributeStore.releaseDisplayIdForObjectId(t);this._streamLayerDeferredObjectIdsToRemove=[]}_cleanupChunkIds(t){if(this.handledChunksForIdCreation.has(t.chunkId)){const s=t.reader.getCursor();for(;s.next();){const i=s.getObjectId();this._source.isStream?this._streamLayerDeferredObjectIdsToRemove.push(i):this._attributeStore.releaseDisplayIdForObjectId(i)}this.handledChunksForIdCreation.delete(t.chunkId)}}_updateAttributeData(){var t=this;return(0,m.Z)(function*(){for(const s of t._source.chunks()){const{chunkId:i,reader:a}=s;if(!t.handledChunksForIdCreation.has(i)){t.handledChunksForIdCreation.add(i);const o=a.getCursor();for(;o.next();){const u=t._attributeStore.createDisplayIdForObjectId(o.getObjectId());o.setDisplayId(u)}}}for(const s of t._source.chunks())if(!t.handledChunksForAttributeData.has(s.chunkId)){t.handledChunksForAttributeData.add(s.chunkId);const i=s.reader.getCursor();for(;i.next();){const a=i.getDisplayId();t._attributeStore.setAttributeData(a,i,t._evalOptions)}}})()}*_update(t){const{subscription:s,handledChunks:i}=t;for(const a of this._source.chunks()){const{chunkId:o}=a;if(i.has(o))continue;i.add(o);const u=a.getTileReader(s.tile);u&&(yield new it(t.subscription,u,!1,a.end,a.queryInfo))}}}var ms=g(28269);class Is{constructor(t,s){this._connection=t,this._source=s,this._version=1,this._proxy=new es.f({fetch:(i,a)=>this._connection.layerView.fetch(i,a),fetchDictionary:(i,a)=>this._connection.layerView.fetchDictionary(i,a)}),this._attributeStore=new ms.p({isLocal:!1,update:i=>(0,y.R8)(this._connection.container.updateAttributeView(i))})}destroy(){this._proxy.destory(),this._strategy?.destroy(),this._attributeStore.destroy()}get aggregateQueryEngine(){return this._strategy?.aggregateQueryEngine}getDisplayFeatures(t){return this._strategy?this._strategy.getDisplayFeatures(t):{features:[],aggregates:[]}}getFeatureObjectIdsForAggregate(t){return this._strategy?this._strategy.getFeatureObjectIdsForAggregate(t):[]}onSubscribe(t){this._strategy?.onSubscribe(t)}onUnsubscribe(t){this._strategy?.onUnsubscribe(t)}update(t,s,i,a,o){var u=this;return(0,m.Z)(function*(){const l=t.processor,d=(0,$.Hg)(u._schema,l);if(!d&&!a)return;(0,I.Z)("esri-2d-update-debug")&&console.debug(`Version[${u._version}] SymbolProcessor.update`,{changes:d,schema:l}),u._schema=l;const c=ne.Z.fromJSON(t.source.mutable.dataFilter.outSpatialReference),p=new ot.O({fields:u._source.metadata.fieldsIndex,spatialReference:c});return yield u._attributeStore.update(l.storage,p,u._source.metadata,c,s),u._strategy?.invalidateAttributeData(),a||(0,$.uD)(d,"mesh")?((0,$.uD)(d,"mesh.strategy")&&(yield u._updateStrategy(l.mesh.strategy,c,o,l.mesh.timeZone)),u._updateSortKey(p,"sortKey"in l.mesh?l.mesh.sortKey:null),((0,$.uD)(d,"mesh.factory")||"dictionary"===l.mesh.factory.symbology.type)&&(u._factory=yield Je.create(p,u._proxy,l.mesh.factory,i)),u._invalidate(),u._version=s,u._connection.container.updateRenderState(u._version)):void 0})()}applyOverride(t){var s=this;return(0,m.Z)(function*(){if(!s._strategy)return;const i=s._strategy.applyOverride(t);var u,a=!1,o=!1;try{for(var d,l=(0,le.Z)(i);a=!(d=yield l.next()).done;a=!1){const c=d.value;try{yield s._process(c)}catch{}}}catch(c){o=!0,u=c}finally{try{a&&null!=l.return&&(yield l.return())}finally{if(o)throw u}}s._source.applyOverride(t)})()}updateChunks(){var t=this;return(0,m.Z)(function*(){yield t._doUpdateChunks(),t._strategy?.afterUpdateChunks()})()}removeChunks(t){var s=this;return(0,m.Z)(function*(){s._strategy?.removeChunks(t),s._attributeStore.incrementDisplayIdGeneration()})()}updateHighlight({highlights:t}){if(!this._strategy)return void this._attributeStore.setHighlight(t.map(({objectId:i,highlightFlags:a})=>({objectId:i,highlightFlags:a,displayId:-1})),t);const s=this._strategy.displayMap(t,({objectId:i})=>i,(i,{highlightFlags:a},o)=>({objectId:o,displayId:i,highlightFlags:a}));this._attributeStore.setHighlight(s,t)}_doUpdateChunks(){var t=this;return(0,m.Z)(function*(){if(!t._strategy)return;const s=t._strategy.updateChunks(),i=[],a=new Map;var l,o=!1,u=!1;try{for(var c,d=(0,le.Z)(s);o=!(c=yield d.next()).done;o=!1){const p=c.value;{let _=a.get(p.id);null==_&&(_=new ts({concurrency:16,process:M=>t._process(M)}),a.set(p.id,_));const E=_.push(p).catch(M=>(0,y.H9)(M));i.push(E)}}}catch(p){u=!0,l=p}finally{try{o&&null!=d.return&&(yield d.return())}finally{if(u)throw l}}try{yield Promise.all(i)}catch{}(0,I.Z)("esri-2d-update-debug")&&console.log("SendUpdates"),yield t._attributeStore.sendUpdates(),(0,I.Z)("esri-2d-update-debug")&&console.log("SendUpdates.await")})()}_updateStrategy(t,s,i,a){var o=this;return(0,m.Z)(function*(){switch(o._strategy?.destroy(),t.type){case"feature":o._strategy=new ys(o._source,o._attributeStore,a);break;case"binning":o._strategy=yield dt.create(t,s,o._source,o._attributeStore,a);break;case"cluster":o._strategy=yield mt.create(o._connection,t,s,o._source,o._attributeStore,a)}for(const u of i)o._strategy.onSubscribe(u)})()}_updateSortKey(t,s){var i=this;return(0,m.Z)(function*(){if(i._sortInfo=(0,P.SC)(i._sortInfo?.computed),null!=s){const a=s.byRenderer?null:yield t.createComputedField(s);i._sortInfo={...s,computed:a}}})()}_invalidate(){this._strategy&&this._strategy.invalidate()}_process(t){var s=this;return(0,m.Z)(function*(){const i=t.subscription;(0,I.Z)("esri-2d-update-debug")&&console.debug(`Version[${s._version}] Tile[${i.tile.key.id}, end=${t.end}] Processor._process`),yield s._fetchResources(t),(0,y.k_)(i.signal);const a=yield s._write(t,i.tile.createArcadeEvaluationOptions(s._schema.mesh.timeZone)),o=i.tile.tileInfoView.tileInfo.isWrappable,{message:u,transferList:l}=a.serialize(o),d=t.createMessage(u,s._version,s._attributeStore.epoch);(0,y.k_)(i.signal),s._connection.container.onMessage(d,{signal:i.signal,transferList:l}),s._attributeStore.sendUpdates(),(0,I.Z)("esri-2d-update-debug")&&console.debug(`Version[${s._version}] Tile[${i.tile.key.id}, end=${t.end}] Processor._process.await`)})()}_fetchResources(t){var s=this;return(0,m.Z)(function*(){yield s._fetchMatcherResources(t),yield s._fetchWriterResources(t)})()}_fetchMatcherResources(t){var s=this;return(0,m.Z)(function*(){if(t.reader)return s._factory.enqueueMatcherRequests(s._proxy,t.reader)})()}_fetchWriterResources(t){var s=this;return(0,m.Z)(function*(){if(!t.reader)return;const i=t.reader.getCursor(),a=t.subscription.tile.createArcadeEvaluationOptions(s._schema.mesh.timeZone);for(;i.next();)s._factory.enqueueWriterRequests(s._proxy,i,a);yield s._proxy.fetchEnqueuedResources()})()}_write(t,s){var i=this;return(0,m.Z)(function*(){const a=t.subscription.tile,o=t.reader?.getCursor(),u=o?.getSize()??0,d=new Qt(a.key,i._strategy.enablePixelBuffering,a.tileInfoView.tileInfo.isWrappable,u);if(!o)return d;const c=a.createArcadeEvaluationOptions(i._schema.mesh.timeZone);for(;o.next();){const p=i._getSortKeyValue(o,s);d.entityStart(o.getDisplayId(),p),i._factory.write(d,i._proxy,o,c,a.level),d.entityEnd()}return d})()}_getSortKeyValue(t,s){if(!this._sortInfo)return 0;const{computed:i,order:a,byRenderer:o}=this._sortInfo,u=o?this._factory.getSortKey(t,s):i?.read(t,s);return null==u||isNaN(u)?0:u*("asc"===a?-1:1)}}var vs=g(84792),Ne=g(20477);class vt{static from(t){let s=0,i=0,a=0;return t.forEach(o=>{const u=o._readGeometry();u&&(i+=u.isPoint?1:u.lengths.reduce((l,d)=>l+d,0),a+=u.isPoint?1:u.lengths.length,s+=1)}),new vt(s,i,a)}constructor(t,s,i){this.featureCount=t,this.vertexCount=s,this.ringCount=i}toJSON(){return{featureCount:this.featureCount,ringCount:this.featureCount,vertexCount:this.featureCount}}}var Ss=g(97478),bs=g(38305),Zt=g(96854);class bt{static fromSchema(t,s){return new bt(function xs(h,t){const{service:s}=h,i=s.orderByFields??t.objectIdField+" ASC",a=s.source,o={returnCentroid:!(null!==a&&"object"==typeof a&&"path"in a&&(0,bs.M8)(a.path))&&"esriGeometryPolygon"===t.geometryType,returnGeometry:!0,timeReferenceUnknownClient:t.timeReferenceUnknownClient??void 0,outSpatialReference:ne.Z.fromJSON(h.mutable.dataFilter.outSpatialReference),orderByFields:[i],where:h.mutable.dataFilter.definitionExpression??"1=1",outFields:h.mutable.availableFields};if("feature"===h.type){const{gdbVersion:u,historicMoment:l,timeExtent:d}=h.mutable.dataFilter;return{...o,gdbVersion:u,historicMoment:l?new Date(l):null,timeExtent:d?Ss.Z.fromJSON(d):null,outFields:h.mutable.availableFields}}return o}(t,s),t.mutable.dataFilter.customParameters,s.geometryType,t.service.queryMetadata.capabilities)}constructor(t,s,i,a){this._queryParams=t,this._customParameters=s,this._geometryType=i,this._capabilities=a}get pageSize(){if(null==this._capabilities)throw new Error("InternalError: Service does not support paged queries");const{query:t}=this._capabilities;return Math.min(8e3,(t.maxRecordCount??8e3)*((t.supportsMaxRecordCountFactor?4:null)??1))}updateFields(t){this._queryParams.outFields=t}createPatchFieldsQuery(t,s){const i=t.clone();if("*"===this._queryParams.outFields[0]){if("*"===(i.outFields??[])[0])return null;i.outFields=this._queryParams.outFields}else{const a=new Set(this._queryParams.outFields),o=[];for(const u of a)s.hasField(u)||o.push(u);if(0===o.length)return null;i.outFields=o}return i.returnGeometry=!1,i.returnCentroid=!1,i.quantizationParameters=null,i.cacheHint=!0,{inner:i,customParameters:this._customParameters}}createQuery(t={}){if(!this._queryParams)throw new Error("InternalError: queryInfo should be defined");return{inner:new Zt.Z({...this._queryParams,...t}),customParameters:this._customParameters}}createTileQuery(t,s){if(null==this._capabilities)throw new Error("InternalError: Service does not support tile queries");const i=this.createQuery(s),a=i.inner;return a.quantizationParameters=s.quantizationParameters??t.getQuantizationParameters(),a.resultType="tile",a.geometry=t.extent,this._capabilities.query.supportsQuantization?"esriGeometryPolyline"===this._geometryType&&(a.maxAllowableOffset=t.resolution*(0,I.Z)("feature-polyline-generalization-factor")):"esriGeometryPolyline"!==this._geometryType&&"esriGeometryPolygon"!==this._geometryType||(a.maxAllowableOffset=t.resolution,"esriGeometryPolyline"===this._geometryType&&(a.maxAllowableOffset*=(0,I.Z)("feature-polyline-generalization-factor"))),a.defaultSpatialReferenceEnabled=this._capabilities.query.supportsDefaultSpatialReference,a.compactGeometryEnabled=this._capabilities.query.supportsCompactGeometry,this._capabilities.query.supportsMaxRecordCountFactor&&(a.maxRecordCountFactor=4),i}createPagedTileQuery(t,s){const i=this.pageSize;return this.createTileQuery(t,{start:i*s,num:i,returnExceededLimitFeatures:!0})}createPagedQuery(t){const s=this.pageSize;return this.createQuery({start:s*t,num:s,returnExceededLimitFeatures:!0,maxRecordCountFactor:4})}}var Ce=g(17626),Ut=g(83761),We=g(77712),Fs=g(63290),jt=g(76898);let ze=class extends Ut.Z{constructor(h){super(),this._connection=h,this._enabledEventTypes=new Set,this._updateInfo={websocket:0,client:0},this._lastTime=performance.now(),this.addHandles([(0,v.YP)(()=>this._strategy?.connectionStatus??"disconnected",t=>{this._layerView.setProperty({propertyName:"pipelineConnectionStatus",value:t})},{initial:!0}),(0,v.YP)(()=>this._strategy?.errorString||null,t=>this._layerView.setProperty({propertyName:"pipelineErrorString",value:t}),{initial:!0})])}destroy(){this._strategy=null,this.removeAllHandles()}get _layerView(){return this._connection.layerView}set strategy(h){null==this._strategy&&this._resetUpdateInfo(performance.now());const t="event-handles";this.removeHandles(t),null!=h&&this.addHandles([h.events.on("data-received",s=>this._onFeature(s)),h.events.on("message-received",s=>this._onWebSocketMessage(s)),h.events.on("features-updated",s=>this._onUpdate(s)),h.events.on("tick",()=>this._onTick())],t),this._strategy=h}updateCustomParameters(h){null!=h&&this._strategy?.updateCustomParameters(h)}sendMessageToSocket(h){this._strategy?.sendMessageToSocket(h)}sendMessageToClient(h){this._strategy?.sendMessageToClient(h)}enableEvent(h,t){t?this._enabledEventTypes.add(h):this._enabledEventTypes.delete(h)}disconnect(){this._strategy?.disconnect()}connect(){this._strategy?.connect()}clear(){this._strategy?.clear()}_onWebSocketMessage(h){this._enabledEventTypes.has("message-received")&&this._layerView.emitEvent({name:"message-received",event:h})}_onFeature(h){this._updateInfo.websocket++,this._enabledEventTypes.has("data-received")&&this._layerView.emitEvent({name:"data-received",event:{attributes:h.attributes,centroid:h.centroid,geometry:h.geometry}})}_onUpdate(h){this._updateInfo.client+=h}_onTick(){const h=performance.now(),t=h-this._lastTime;if(t>2500){const s=Math.round(this._updateInfo.client/(t/1e3)),i=Math.round(this._updateInfo.websocket/(t/1e3));this._resetUpdateInfo(h),this._layerView.emitEvent({name:"update-rate",event:{client:s,websocket:i}})}}_resetUpdateInfo(h){this._lastTime=h,this._updateInfo.client=0,this._updateInfo.websocket=0}};(0,Ce._)([(0,We.Cb)()],ze.prototype,"_strategy",void 0),ze=(0,Ce._)([(0,jt.j)("esri.views.2d.layers.features.sources.StreamMessenger")],ze);class Lt{constructor(t){this._store=t,this._controller=new AbortController}destroy(){this._controller.abort()}get _options(){return{signal:this._controller.signal}}queryOverride(t){return(0,m.Z)(function*(){throw new Error("InternalError: LoadStrategy does not support fetching")})()}}var Es=g(93662),Bt=g(7848),Nt=g(89628),Ts=g(24192),Cs=g(2854),Wt=g(71260);const xt=268435455;class Ms{constructor(){this.hasFeatures=!1,this.exceededTransferLimit=!1,this.fieldCount=0,this.featureCount=0,this.objectIdFieldIndex=0,this.vertexCount=0,this.offsets={attributes:new Array,geometry:new Array},this.centroid=new Array}}const zt=268435455,Me={small:{delta:new Int32Array(128),decoded:new Int32Array(128)},large:{delta:new Int32Array(128e3),decoded:new Int32Array(128e3)}};function Yt(h){return h<=Me.small.delta.length?Me.small:(h<=Me.large.delta.length||(Me.large.delta=new Int32Array(Math.round(1.25*h)),Me.large.decoded=new Int32Array(Math.round(1.25*h))),Me.large)}function Ps(h){for(;h.next();){if(1===h.tag())return h.getMessage();h.skip()}return null}function Ds(h,t,s,i,a,o){return.5*Math.abs(h*i+s*o+a*t-h*o-s*t-a*i)}function Ft(h,t,s,i){return h*i-s*t==0&&h*s+t*i>0}class Ge extends lt.s{static fromBuffer(t,s,i=!1){const a=s.geometryType,o=function As(h){try{const s=new Ts.Z(new Uint8Array(h),new DataView(h));for(;s.next();){if(2===s.tag())return Ps(s.getMessage());s.skip()}}catch(t){const s=new Z.Z("query:parsing-pbf","Error while parsing FeatureSet PBF payload",{error:t});Fs.Z.getLogger("esri.view.2d.layers.features.support.FeatureSetReaderPBF").error(s)}return null}(t),u=function Os(h,t,s=!1){const c=h.asUnsafe(),p=c.pos(),_=new Ms;let E=0,M=0,W=null,z=null,V=null,Y=!1;const Q=[];for(;c.next();)switch(c.tag()){case 1:W=c.getString();break;case 3:z=c.getString();break;case 12:V=c.processMessage(Wt.G$);break;case 9:if(_.exceededTransferLimit=c.getBool(),_.exceededTransferLimit){_.offsets.geometry=s?new Float64Array(8e3):new Int32Array(8e3),_.centroid=s?new Float64Array(16e3):new Int32Array(16e3);for(let te=0;te<_.centroid.length;te++)_.centroid[te]=xt}break;case 13:{const te=c.processMessage(Wt.wn);te.index=E++,Q.push(te);break}case 15:{const te=c.getLength(),pe=c.pos()+te;if(!_.exceededTransferLimit){const ce=_.centroid;_.offsets.geometry.push(0),ce.push(xt),ce.push(xt)}!Y&&_.exceededTransferLimit&&(Y=!0,_.offsets.attributes=s?new Float64Array(8e3*E):new Uint32Array(8e3*E));let ge=M*E;for(;c.pos()<pe&&c.next();)switch(c.tag()){case 1:{Y?_.offsets.attributes[ge++]=c.pos():_.offsets.attributes.push(c.pos());const ee=c.getLength();c.skipLen(ee);break}case 2:if(t){const ee=c.getLength(),ce=c.pos()+ee;for(;c.pos()<ce&&c.next();)switch(c.tag()){case 3:{c.getUInt32();const we=c.getSInt64(),Ee=c.getSInt64();_.centroid[2*M]=we,_.centroid[2*M+1]=Ee;break}default:c.skip()}}else{_.offsets.geometry[M]=c.pos();const ee=c.getLength();_.vertexCount+=ee,c.skipLen(ee)}break;case 4:{const ee=c.getLength(),ce=c.pos()+ee;for(;c.pos()<ce&&c.next();)switch(c.tag()){case 3:{c.getUInt32();const we=c.getSInt64(),Ee=c.getSInt64();_.centroid[2*M]=we,_.centroid[2*M+1]=Ee;break}default:c.skip()}break}default:c.skip()}M++,_.hasFeatures=!0;break}default:c.skip()}const K=W||z;if(!K)throw new Z.Z("FeatureSet has no objectId or globalId field name");return _.fields=new At.Z(Q),_.featureCount=M,_.fieldCount=E,_.objectIdFieldIndex=_.fields.get(K)?.index,_.transform=V,_.displayIds=new Uint32Array(_.featureCount),_.groupIds=new Uint16Array(_.featureCount),c.move(p),_}(o,"esriGeometryPoint"===a,i);return new Ge(o,u,s)}constructor(t,s,i){super(i),this._hasNext=!1,this._isPoints=!1,this._featureIndex=-1,this._featureOffset=0,this._cache={area:0,unquantGeometry:void 0,geometry:void 0,centroid:void 0,legacyFeature:void 0,optFeature:void 0},this._parseCaches=new Array,this._geometryType=i.geometryType,this._reader=t,this._header=s,this._hasNext=s.hasFeatures,this._isPoints="esriGeometryPoint"===i.geometryType}get _size(){return this._header.featureCount}get fields(){return this._header.fields}get geometryType(){return this._geometryType}get hasZ(){return!1}get hasM(){return!1}get hasFeatures(){return this._header.hasFeatures}get hasNext(){return this._hasNext}get exceededTransferLimit(){return this._header.exceededTransferLimit}getSize(){return this._size}getInTransform(){return this._header.transform}getCursor(){return this.copy()}getIndex(){return this._featureIndex}setIndex(t){this._cache.area=0,this._cache.unquantGeometry=void 0,this._cache.geometry=void 0,this._cache.centroid=void 0,this._cache.legacyFeature=void 0,this._cache.optFeature=void 0,this._featureIndex=t}getAttributeHash(){let t="";for(const s of this._header.fields.fields)t+=this._readAttributeAtIndex(s.index)+".";return t}getObjectId(){return this._readAttributeAtIndex(this._header.objectIdFieldIndex)}getDisplayId(){return this._header.displayIds[this._featureIndex]}setDisplayId(t){this._header.displayIds[this._featureIndex]=t}readGeometryArea(){return this._cache.area||this._readGeometry(!0),this._cache.area}copy(){const t=this._reader.clone(),s=new Ge(t,this._header,this.metadata);return this.copyInto(s),s}next(){for(this._cache.area=0,this._cache.unquantGeometry=void 0,this._cache.geometry=void 0,this._cache.centroid=void 0,this._cache.legacyFeature=void 0,this._cache.optFeature=void 0;++this._featureIndex<this._size&&!this._getExists(););return this._featureIndex<this._size}_readX(){return this._header.centroid[2*this._featureIndex]}_readY(){return this._header.centroid[2*this._featureIndex+1]}_readServerCentroid(){const t=this._header.centroid[2*this._featureIndex];return t===zt?null:new re.Z([],[t,this._header.centroid[2*this._featureIndex+1]])}_readGeometry(t=!1){if(void 0===this._cache.geometry){let s=null;if(this._isPoints){if(this._header.centroid[2*this._featureIndex]===zt)return null;s=new re.Z([],[this._header.centroid[2*this._featureIndex],this._header.centroid[2*this._featureIndex+1]])}else{const i=this._header.offsets.geometry[this._featureIndex],a=this._reader;if(0===i)return null;a.move(i);try{s=t?this._parseGeometryForDisplay(a):this._parseGeometry(a)}catch(o){return console.error("Failed to parse geometry!",o),null}}return 0===s?.coords.length&&(s=null),this._cache.geometry=s,s}return this._cache.geometry}_readAttribute(t,s){const i=this._header.fields.get(t);if(null==i)return;let a=this._readAttributeAtIndex(i.index);"esriFieldTypeTimestampOffset"===this.fields.get(t)?.type&&(a=this.parseTimestampOffset(a));const o=this._header.fields.isDateField(i.name);return s?null==a?a:o?new Date(a):a:a}_readAttributes(){const t={};for(const s of this._header.fields.fields)t[s.name]=this._readAttributeAtIndex(s.index);return t}copyInto(t){super.copyInto(t),t._featureIndex=this._featureIndex,t._featureOffset=this._featureOffset,t._hasNext=this._hasNext,t._parseCaches=this._parseCaches}_readAttributeAtIndex(t){let s=this._parseCaches[t];if(s||(s=new Cs.j(this.getSize()),this._parseCaches[t]=s),s.has(this._featureIndex))return s.get(this._featureIndex);const a=this._reader;a.move(this._header.offsets.attributes[this._featureIndex*this._header.fieldCount+t]);const o=function Rs(h){const p=h.getLength(),_=h.pos()+p;for(;h.pos()<_&&h.next();)switch(h.tag()){case 1:return h.getString();case 2:return h.getFloat();case 3:return h.getDouble();case 4:return h.getSInt32();case 5:return h.getUInt32();case 6:return h.getInt64();case 7:return h.getUInt64();case 8:return h.getSInt64();case 9:return h.getBool();default:return h.skip(),null}return null}(a);return s.set(this._featureIndex,o),o}_readGeometryDeltaDecoded(t=!1){if(void 0===this._cache.unquantGeometry){const s=this._readGeometry(t);if(!s)return this._cache.unquantGeometry=void 0,null;if(!this.getInTransform())return this._cache.unquantGeometry=s,s;const i=Yt(s.coords.length).decoded,a=s.clone(i),o=a.coords;let u=0;for(const l of a.lengths){for(let d=1;d<l;d++){const c=2*(u+d),p=2*(u+d-1);o[c]+=o[p],o[c+1]+=o[p+1]}u+=l}return this._cache.unquantGeometry=a,a}return this._cache.unquantGeometry}_parseGeometry(t){const a=t.asUnsafe(),o=a.getLength(),u=a.pos()+o,l=[],d=[];for(;a.pos()<u&&a.next();)switch(a.tag()){case 2:{const c=a.getUInt32(),p=a.pos()+c;for(;a.pos()<p;)d.push(a.getUInt32());break}case 3:{const c=a.getUInt32(),p=a.pos()+c;for(l.push(a.getSInt64()),l.push(a.getSInt64()),this.hasZ&&a.getSInt64(),this.hasM&&a.getSInt64();a.pos()<p;)l.push(a.getSInt64()),l.push(a.getSInt64()),this.hasZ&&a.getSInt64(),this.hasM&&a.getSInt64();break}default:a.skip()}return new re.Z(d,l)}_parseGeometryForDisplay(t){const a=t.asUnsafe(),o=a.getLength(),u=a.pos()+o,l=[],d=[];let c=0,p=0,_=null,E=0;const M="esriGeometryPolygon"===this.geometryType;for(;a.pos()<u&&a.next();)switch(a.tag()){case 2:{const C=a.getUInt32(),N=a.pos()+C;for(;a.pos()<N;){const L=a.getUInt32();l.push(L),c+=L}_=Yt(2*c).delta;break}case 3:{a.getUInt32();const C=2+(this.hasZ?1:0)+(this.hasM?1:0);(0,P.O3)(_);for(const N of l)if(p+C*N>_.length)for(let L=0;L<N;L++)a.getSInt32(),a.getSInt32(),this.hasZ&&a.getSInt32(),this.hasM&&a.getSInt32();else if(M){const L=this.getAreaSimplificationThreshold(N,this._header.vertexCount);let R=2,W=1;const z=!1;let V=a.getSInt32(),Y=a.getSInt32();_[p++]=V,_[p++]=Y,this.hasZ&&a.getSInt32(),this.hasM&&a.getSInt32();let Q=a.getSInt32(),K=a.getSInt32();for(this.hasZ&&a.getSInt32(),this.hasM&&a.getSInt32();R<N;){let te=a.getSInt32(),pe=a.getSInt32();this.hasZ&&a.getSInt32(),this.hasM&&a.getSInt32();const ge=V+Q,ee=Y+K;Ds(V,Y,ge,ee,ge+te,ee+pe)>=L?(E+=-.5*(ge-V)*(ee+Y),W>1&&Ft(_[p-2],_[p-1],Q,K)?(_[p-2]+=Q,_[p-1]+=K):(_[p++]=Q,_[p++]=K,W++),V=ge,Y=ee):(te+=Q,pe+=K),Q=te,K=pe,R++}W<3||z?p-=2*W:(E+=-.5*(V+Q-V)*(Y+K+Y),Ft(_[p-2],_[p-1],Q,K)?(_[p-2]+=Q,_[p-1]+=K,d.push(W)):(_[p++]=Q,_[p++]=K,d.push(++W)))}else{let L=0,R=a.getSInt32(),W=a.getSInt32();this.hasZ&&a.getSInt32(),this.hasM&&a.getSInt32(),_[p++]=R,_[p++]=W,L+=1;for(let z=1;z<N;z++){const V=a.getSInt32(),Y=a.getSInt32(),Q=R+V,K=W+Y;E+=-.5*(Q-R)*(K+W),this.hasZ&&a.getSInt32(),this.hasM&&a.getSInt32(),z>2&&Ft(_[p-2],_[p-1],V,Y)?(_[p-2]+=V,_[p-1]+=Y):(_[p++]=V,_[p++]=Y,L+=1),R=Q,W=K}d.push(L)}break}default:a.skip()}return this._cache.area=E,d.length?new re.Z(d,_):null}}class qe{constructor(t,s){this.service=t,this._metadata=s}destroy(){}}function wt(){return(wt=(0,m.Z)(function*(h){const t=new Es.Z;return yield t.open(h,{}),t})).apply(this,arguments)}class js extends qe{constructor(t,s){super(t,s),this._portsOpen=function Us(h){return wt.apply(this,arguments)}(t.source).then(i=>this.client=i)}destroy(){this.client.close(),this.client=null}executeQuery(t,s){var i=this;return(0,m.Z)(function*(){yield i._portsOpen;const a=yield i.client.invoke("queryFeatures",t.toJSON(),s);return X.fromFeatureSet(a,i._metadata)})()}}class Ls extends qe{executeQuery(t,s){var i=this;return(0,m.Z)(function*(){const{data:a}=yield(0,Ne.n7)(i.service.source,t,s);return Ge.fromBuffer(a,i._metadata,!t.quantizationParameters)})()}}class Bs extends qe{executeQuery(t,s){var i=this;return(0,m.Z)(function*(){const{source:a,queryMetadata:o}=i.service;if(null!=t.quantizationParameters&&!o.capabilities.query.supportsQuantization){const d=t.clone(),c=(0,Bt.vY)(d.quantizationParameters);d.quantizationParameters=null;const{data:p}=yield(0,Ne.JT)(a,d,i._metadata.spatialReference,s),_=(0,J.h_)(p,i._metadata.objectIdField);return(0,J.RZ)(c,_),X.fromOptimizedFeatureSet(_,i._metadata)}const{data:l}=yield(0,Ne.JT)(a,t,i._metadata.spatialReference,s);return"esriGeometryPoint"===i._metadata.geometryType&&(l.features=l.features?.filter(d=>{if(null!=d.geometry){const c=d.geometry;return Number.isFinite(c.x)&&Number.isFinite(c.y)}return!0})),X.fromFeatureSet(l,i._metadata)})()}}class Ns extends qe{executeQuery(t,s){var i=this;return(0,m.Z)(function*(){const{capabilities:a}=i.service.queryMetadata;if(t.quantizationParameters&&!a.query.supportsQuantization){const u=t.clone(),l=(0,Bt.vY)(u.quantizationParameters);u.quantizationParameters=null;const d=yield(0,Nt.WW)(i.service.source,t,s);return(0,J.RZ)(l,d),X.fromOptimizedFeatureSet(d,i._metadata)}const o=yield(0,Nt.WW)(i.service.source,t,s);return X.fromOptimizedFeatureSet(o,i._metadata)})()}}class Vt extends Lt{constructor(t,s,i,a,o){var u,l;super(i),u=this,this._serviceInfo=t,this._queryInfo=s,this._metadata=a,this._eventLog=o,this._queue=new Tt.e({concurrency:16,process:(l=(0,m.Z)(function*(d){return u._adapter.executeQuery(d.query.inner,{signal:d.options?.signal,query:d.query.customParameters})}),function(c){return l.apply(this,arguments)})}),this._adapter=function Zs(h,t){switch(h.type){case"memory":return new js(h,t);case"ogc":return new Ns(h,t);case"feature-service":return h.queryMetadata.capabilities.query.supportsFormatPBF&&(0,I.Z)("featurelayer-pbf")?new Ls(h,t):new Bs(h,t)}}(t,a)}updateFields(t){var s=this;return(0,m.Z)(function*(){s._queryInfo.updateFields(t);const i=Array.from(s._store.chunks()).map(function(){var o=(0,m.Z)(function*(u){const l=Zt.Z.fromJSON(u.queryInfo.queryJSON);if(l)try{return yield s._tryUpdateFields(u.reader,l),null}catch(d){return d}});return function(u){return o.apply(this,arguments)}}()),a=(yield Promise.all(i)).filter(o=>o);if(a.length)throw new Z.Z("featurelayer-query","Encountered errors when downloading fields",{errors:a})})()}queryOverride({edits:t}){var s=this;return(0,m.Z)(function*(){const i=[],a=[];for(const l of t.removed)null!=l.objectId&&-1!==l.objectId?i.push(l.objectId):a.push(l.globalId);a.length&&i.push(...s._mapGlobalIdsToObjectIds(a));const o=t.addOrModified.map(({objectId:l})=>l);let u;if(o.length){const l=s._queryInfo.createQuery({objectIds:o});u=yield s._fetch(l)}else u=X.empty(s._metadata);return{reader:u,removed:i}})()}_mapGlobalIdsToObjectIds(t){const s=new Set(t),i=this._metadata.globalIdField;if(null==i)throw new Error("InternalError: Recieved an edit with globalIds, but not supported by the service");const a=[];return this._store.forEachUnsafe(o=>{const u=o.readAttribute(i);s.has(u)&&a.push(o.getObjectId())}),a}_fetch(t,s){var i=this;return(0,m.Z)(function*(){const a=yield i._enqueue(t,s);return yield i._tryUpdateFields(a,t.inner),a})()}_tryUpdateFields(t,s){var i=this;return(0,m.Z)(function*(){const a=i._queryInfo.createPatchFieldsQuery(s,t);if(!a)return;const o=yield i._enqueue(a,i._options);t.joinAttributes(o)})()}_enqueue(t,s){var i=this;return(0,m.Z)(function*(){return i._eventLog.onEvent({type:"fetchStart"}),i._queue.push({query:t,options:s}).finally(()=>{i._eventLog.onEvent({type:"fetchEnd",done:0===i._queue.length})})})()}}class $t extends Vt{constructor(){super(...arguments),this._chunksById=new Map}unload(t){this._removeChunks(t.tile)}_addChunk(t){const s=t.tile.id;this._chunksById.has(s)||this._chunksById.set(s,[]);const i=t.size();(i||t.first||t.end)&&((0,I.Z)("esri-2d-update-debug")&&console.debug(`Chunk[${t.chunkId}] ATileLoadStrategy.addChunk [count=${i}]`),this._chunksById.get(s).push(t),this._store.insert(t))}_removeChunks(t){const s=this._chunksById.get(t.key.id)??[];for(const i of s)(0,I.Z)("esri-2d-update-debug")&&console.debug(`Tile[${t.key.id}] Chunk[${i.chunkId}] ATileLoadStrategy.removeChunk`),this._store.remove(i);this._chunksById.delete(t.key.id)}}class Kt extends De{constructor(t,s,i,a,o,u){super(),this._reader=t,this._queryJSON=s,this._tile=i,this._sourceTile=a,this._sourceTileDepth=o,this._end=u,this.chunkId=`${this._tile.key.id}.${this._sourceTile?.key.id}${this._end?"e":""}`,this.normalizedChunkId=`${this._tile.key.normalizedId}.${this._sourceTile?.key.normalizedId}${this._end?"e":""}`}get queryInfo(){return{type:"drill-down-tile",chunkId:this.chunkId,tileId:this._tile.key.id,queryJSON:this._queryJSON,sourceTileDepth:this._sourceTileDepth,sourceTileId:this._sourceTile?.key.id,size:this.size(),end:this.end}}get first(){return 0===this._sourceTileDepth}get reader(){return this._reader}get end(){return this._end}get tile(){return this._tile}get isTiled(){return!0}getTileReader(t){return this._tile.key.id===t.key.id?this.reader:null}}class Ws{constructor(t,s){this.subscription=t,this._tileIdToResult=new Map,this._controller=new AbortController,(0,y.fu)(t.options,()=>this._controller.abort()),(0,y.fu)(s,()=>this._controller.abort())}get(t){return this._tileIdToResult.get(t)}set(t,s){this._tileIdToResult.set(t,s)}get options(){return{signal:this._controller.signal}}}class zs extends $t{constructor(){super(...arguments),this._loadStates=new Map}get about(){return{willQueryAllFeatures:!1,willQueryFullResolutionGeometry:!1}}load(t){var s=this;return(0,m.Z)(function*(){s._loadStates.has(t.key.id)||s._loadStates.set(t.key.id,new Ws(t,s._options));const i=s._loadStates.get(t.key.id);let a;try{var l,o=!1,u=!1;try{for(var c,d=(0,le.Z)(s._fetchChunkInfos(i,t.tile,0));o=!(c=yield d.next()).done;o=!1){const _=c.value;{const{queryJSON:E,reader:M,sourceTile:C,sourceTileDepth:N,tile:L}=_,R=new Kt(M,E,L,C,N,!1);(0,y.k_)(t.options),s._addChunk(R)}}}catch(_){u=!0,l=_}finally{try{o&&null!=d.return&&(yield d.return())}finally{if(u)throw l}}}catch(_){a=_}const p=new Kt(X.empty(s._metadata),null,t.tile,null,-1,!0);if(s._addChunk(p),a)throw a})()}unload(t){super.unload(t),this._loadStates.delete(t.key.id)}_fetchChunkInfos(t,s,i){var a=this;return(0,ve.Z)(function*(){let o=t.get(s.id);const u=!!o;if(o||(o=yield(0,xe.Z)(a._fetchChunkInfo(t,s,i)),t.set(s.id,o)),o.reader.exceededTransferLimit&&i<(0,I.Z)("featurelayer-query-max-depth"))for(const l of s.createChildTiles())yield*je((0,le.Z)(a._fetchChunkInfos(t,l,i+1)));else u||(yield o)})()}_fetchChunkInfo(t,s,i){var a=this;return(0,m.Z)(function*(){const o=t.subscription.tile.getQuantizationParameters(),u=a._queryInfo.createTileQuery(s,{returnExceededLimitFeatures:!1,quantizationParameters:o});return{reader:yield a._fetch(u,t.subscription.options),queryJSON:u.inner.toJSON(),tile:t.subscription.tile,sourceTile:s,sourceTileDepth:i}})()}}class Ht extends De{constructor(t,s,i,a,o){super(),this._reader=t,this._queryJSON=s,this._tile=i,this._page=a,this._end=o,this.chunkId=`${this._tile.key.id}.${this._page}${this.end?"e":""}`,this.normalizedChunkId=`${this._tile.key.normalizedId}.${this._page}${this.end?"e":""}`}get queryInfo(){return{type:"paged-tile",chunkId:this.chunkId,tileId:this._tile.key.id,queryJSON:this._queryJSON,page:this._page,size:this.size(),end:this.end}}get reader(){return this._reader}get first(){return 0===this._page}get end(){return this._end}get page(){return this._page}get tile(){return this._tile}get isTiled(){return!0}getTileReader(t){return this._tile.key.id===t.key.id?this.reader:null}}class Gs{constructor(t,s){this.subscription=t,this._pages=new Set,this._controller=new AbortController,this._done=!1,(0,y.fu)(t.options,()=>this._controller.abort()),(0,y.fu)(s,()=>this._controller.abort())}resetAbortController(){this._controller=new AbortController}get pageStart(){let t=-1;for(const s of this._pages.values())t=Math.max(t,s);return t+1}get done(){return this._done}get options(){return{signal:this._controller.signal}}add(t,s){this._pages.add(t),this._done=this._done||s}}class qs extends $t{constructor(){super(...arguments),this._loadStates=new Map}get about(){return{willQueryAllFeatures:!1,willQueryFullResolutionGeometry:!1}}load(t){var s=this;return(0,m.Z)(function*(){s._loadStates.has(t.key.id)||s._loadStates.set(t.key.id,new Gs(t,s._options));const i=s._loadStates.get(t.key.id);let a;i.resetAbortController();try{yield s._fetchPages(i)}catch(u){a=u}const o=new Ht(X.empty(s._metadata),null,t.tile,-1,!0);if((0,y.Hc)(i.options)||s._addChunk(o),a)throw a})()}unload(t){super.unload(t),this._loadStates.delete(t.key.id)}_fetchPages(t){var s=this;return(0,m.Z)(function*(){let o=0,u=t.pageStart,l=1;for(;o<20&&!t.done;){const d=[];for(let p=0;p<l;p++)d.push(s._fetchChunk(t,u++));const c=yield Promise.all(d);for(const p of c)(0!==p.size()||p.first)&&(t.add(p.page,!p.reader.exceededTransferLimit),(0,y.k_)(t.options),s._addChunk(p));o++,l=Math.min(l+1,4)}})()}_fetchChunk(t,s){var i=this;return(0,m.Z)(function*(){const a=t.subscription.tile,o=i._queryInfo.createPagedTileQuery(a,s),u=yield i._fetch(o,t.options);return new Ht(u,o.inner.toJSON(),a,s,!1)})()}}class Xt extends De{constructor(t,s,i,a){super(),this._reader=t,this._queryJSON=s,this._page=i,this._end=a,this.chunkId=`${this._page}${this.end?"e":""}`,this.normalizedChunkId=this.chunkId}get reader(){return this._reader}get first(){return 0===this._page}get end(){return this._end}get queryInfo(){return{type:"snapshot",chunkId:this.chunkId,queryJSON:this._queryJSON,page:this._page,size:this.size(),end:this.end}}get isTiled(){return!1}getTileReader(t){const s=this.queryFeaturesInBounds(t.bounds);return s.setTransformForDisplay(t.transform),s}}class Ys extends Vt{constructor(t,s,i,a,o,u){super(t,s,i,o,u),this._random=new b.Z(1e3),this._featureCount=a}get about(){return{willQueryAllFeatures:!0,willQueryFullResolutionGeometry:!0}}load(t){return null==this._promise&&(this._promise=this._downloadPages(this._featureCount)),this._promise}unload(t){}_downloadPages(t){var s=this;return(0,m.Z)(function*(){const i=Math.ceil(t/s._queryInfo.pageSize),a=Array.from({length:i},(d,c)=>c).sort((d,c)=>s._random.getInt()-s._random.getInt()),o=yield Promise.all(a.map(d=>s._downloadPage(d))),u=new Xt(X.empty(s._metadata),null,-1,!0);s._store.insert(u);const l=o.filter(d=>d);if(l.length)throw new Z.Z("featurelayer-query","Encountered errors when downloading data",{errors:l})})()}_downloadPage(t){var s=this;return(0,m.Z)(function*(){try{const i=s._queryInfo.createPagedQuery(t),a=yield s._fetch(i,s._options),o=new Xt(a,i.inner.toJSON(),t,!1);return(0,y.k_)(s._options),s._store.insert(o),null}catch(i){return i}})()}}var Vs=g(5075),$s=g(20901);let Oe=class extends Ut.Z{constructor(h){super(h)}get connectionStatus(){return this.connection?.connectionStatus}get errorString(){return this.connection?.errorString}};(0,Ce._)([(0,We.Cb)()],Oe.prototype,"connection",void 0),(0,Ce._)([(0,We.Cb)()],Oe.prototype,"connectionStatus",null),(0,Ce._)([(0,We.Cb)()],Oe.prototype,"errorString",null),Oe=(0,Ce._)([(0,jt.j)("esri.views.2d.layers.features.sources.StreamConnectionState")],Oe);class Ks{constructor(t,s){this._metadata=t,this._onUpdate=s,this._objectIdToFeature=new Map}get size(){return this._objectIdToFeature.size}get reader(){return X.fromFeatures([...this._objectIdToFeature.values()],this._metadata)}add(t){this._objectIdToFeature.set(t.objectId,t)}forEach(t){this._objectIdToFeature.forEach(t)}removeById(t){const s=this._objectIdToFeature.get(t);return s?(this._objectIdToFeature.delete(t),s):null}clear(){this._objectIdToFeature=new Map}update(t,s){this._onUpdate(t?.length??0)}}class Hs extends De{constructor(t){super(),this._reader=t,this.chunkId="stream-chunk",this.normalizedChunkId="stream-chunk"}get reader(){return this._reader}get first(){return!0}get end(){return!0}get queryInfo(){return{type:"stream",chunkId:this.chunkId,size:this.size(),end:this.end}}get isTiled(){return!1}getTileReader(t){const s=this.queryFeaturesInBounds(t.bounds);return s.setTransformForDisplay(t.transform),s}}class Xs extends Lt{constructor(t,s,i,a,o){super(i),this._service=t,this._dataFilter=s,this._streamOptions=a,this._metadata=o,this._connectionState=new Oe,this._forceRefresh=!1,this.events=new st.Z;const{objectIdField:u,timeInfo:l}=this._metadata,{purgeOptions:d}=s;this._stagingStore=new Ks(this._metadata,c=>this.events.emit("features-updated",c)),this._manager=new Vs.Qo(this._stagingStore,u,l,d),this.connect()}destroy(){super.destroy(),this.disconnect()}get about(){return{willQueryAllFeatures:!1,willQueryFullResolutionGeometry:!1}}get connectionStatus(){return this._connectionState.connectionStatus}get errorString(){return this._connectionState?.errorString}refresh(){var t=this;return(0,m.Z)(function*(){const s=null!=t._chunk;(t._manager.checkForUpdates()||!s||t._forceRefresh)&&(t._chunk&&t._store.remove(t._chunk),t._forceRefresh=!1,t._chunk=new Hs(t._stagingStore.reader),t._store.insert(t._chunk)),t.events.emit("tick")})()}updateFields(t){return(0,m.Z)(function*(){throw new Error("Updating available fields not supported for StreamLayer")})()}load(t){return(0,m.Z)(function*(){})()}unload(t){}disconnect(){this._connection=(0,P.SC)(this._connection),this._connectionState.connection=null,this._handlesGroup?.remove()}connect(){if(null!=this._connection)return;const{geometryType:t,spatialReference:s}=this._metadata,{maxReconnectionAttempts:i,maxReconnectionInterval:a,geometryDefinition:o,definitionExpression:u,customParameters:l}=this._dataFilter;this._connection=(0,$s.createConnection)(this._service.source,s,this._streamOptions.outSR,t,u,o,i,a,l),this._handlesGroup=(0,S.AL)([this._connection.on("data-received",d=>this._onFeature(d)),this._connection.on("message-received",d=>this._onWebSocketMessage(d))]),this._connectionState.connection=this._connection}clear(){this._manager.checkForUpdates(),this._stagingStore.clear(),this._forceRefresh=!0}updateCustomParameters(t){this._connection?.updateCustomParameters(t)}sendMessageToSocket(t){this._connection?.sendMessageToSocket(t)}sendMessageToClient(t){this._connection?.sendMessageToClient(t)}_onWebSocketMessage(t){if("type"in t)switch(t.type){case"delete":if(t.objectIds)for(const s of t.objectIds)this._manager.removeById(s);if(t.trackIds)for(const s of t.trackIds)this._manager.removeByTrackId(s);break;case"clear":this.clear()}this.events.emit("message-received",t)}_onFeature(t){try{this._manager.add(t),this.events.emit("data-received",t)}catch{}}}var Qs=g(95404);class Js{constructor(t){this._onChange=t,this._chunks=new Map,this._chunksToRemove=[],this.events=new st.Z,this.featureAdapter=new Qs.t}destroy(){this.clear()}clear(){for(const t of this._chunks.values())this._chunksToRemove.push(t);this._chunks.clear(),null!=this._overrideChunk&&this._chunksToRemove.push(this._overrideChunk),this._overrideChunk=null}*chunks(){this._overrideChunk&&(yield this._overrideChunk),yield*this._chunks.values()}insert(t){(0,I.Z)("esri-2d-update-debug")&&console.debug(`Chunk[${t.chunkId}] SourceChunkStore.insert`),this._overrideChunk?.overridenIds.size&&t.reader.removeIds(this._overrideChunk.overridenIds),this._chunks.set(t.chunkId,t),this.events.emit("changed"),this._onChange()}remove(t){(0,I.Z)("esri-2d-update-debug")&&console.debug(`Chunk[${t.chunkId}] SourceChunkStore.remove`),this._chunks.delete(t.chunkId),this._chunksToRemove.push(t)}cleanupRemovedChunks(){const t=this._chunksToRemove;return this._chunksToRemove=[],t}applyOverrides(t,s){null==this._overrideChunk&&(this._overrideChunk=new Dt(s)),this._overrideChunk.applyOverrides(t);for(const i of this._chunks.values())i.reader.removeIds(this._overrideChunk.overridenIds),i.invalidate()}forEach(t){const s=new Set;for(const i of this.chunks()){const a=i.reader.getCursor();for(;a.next();){const o=a.getObjectId();s.has(o)||(t(a.copy()),s.add(o))}}}forEachUnsafe(t){const s=new Set;for(const i of this.chunks()){const a=i.reader.getCursor();for(;a.next();){const o=a.getObjectId();s.has(o)||(t(a),s.add(o))}}}forEachInBounds(t,s){const i=new Set;for(const a of this.chunks()){const o=a.queryFeaturesInBounds(t);for(;o.next();){const u=o.getObjectId();i.has(u)||(s(o.copy()),i.add(u))}}}forEachBounds(t,s){const i=(0,rt.Ue)();for(const a of t)a.getBounds(i)&&s(i)}}var er=g(25596);class tr{constructor(t,s,i,a){this._aggregateAdapter=t,this._subscriptions=s,this._onChange=i,this._connection=a,this._updateTracking=new er.x({debugName:"FeatureSource"}),this._didInvalidateData=!1,this._store=new Js(this._onChange)}destroy(){this._strategy?.destroy(),this._store.destroy(),this._streamMessenger?.destroy()}get _eventLog(){return this._connection.eventLog}get metadata(){if(!this._metadata)throw new Error("InternalError: Metadata not defined. Was update called?");return this._metadata}get service(){return this._schema.service}get store(){return this._store}get streamMessenger(){return null==this._streamMessenger&&this._initStreamMessenger(),this._streamMessenger}get statistics(){return vt.from(this._store)}get updateTracking(){return this._updateTracking}get queryEngine(){if(!this._queryEngine){if(!this._schema)return null;const{dataFilter:t}=this._schema.mutable,i=this._metadata;this._queryEngine=new Ct.q({featureStore:this._store,fieldsIndex:i.fieldsIndex,geometryType:i.geometryType,objectIdField:i.objectIdField,hasM:!1,hasZ:!1,spatialReference:t.outSpatialReference,cacheSpatialQueries:!0,aggregateAdapter:this._aggregateAdapter,timeInfo:i.timeInfo,definitionExpression:t.definitionExpression,availableFields:this._schema.mutable.availableFields})}return this._queryEngine}get isStream(){return"stream"===this._schema.type}chunks(){return Array.from(this._store.chunks())}cleanupRemovedChunks(){return this._store.cleanupRemovedChunks()}onSubscribe(t){this._eventLog.onEvent({type:"subscribe",tile:t.tile.id});const s=this._strategy?.load(t);s&&(s.then(()=>this._eventLog.onEvent({type:"loaded",tile:t.tile.id})).catch(i=>this._eventLog.onEvent({type:"error",tile:t.tile.id,error:i})),this._updateTracking.addPromise(s))}onResume(t){this._updateTracking.addPromise((0,y.R8)(this._strategy?.load(t)))}onUnsubscribe(t){this._eventLog.onEvent({type:"unsubscribe",tile:t.tile.id}),this._strategy?.unload(t)}getOverride(t){return this._updateTracking.addPromise(this._doGetOverride(t))}applyOverride(t){this._didInvalidateData=!0,this._store.applyOverrides(t,this.metadata)}update(t,s){var i=this;return(0,m.Z)(function*(){const a=t.source,o=(0,$.Hg)(i._schema?.mutable,a.mutable);if(!o)return!1;if((0,I.Z)("esri-2d-update-debug")&&console.debug(`Version[${s}] FeatureSource.update`,{changes:o}),i._schema=a,i._metadata=new ut.A(i._schema.service.metadata),i._queryEngine?.destroy(),i._queryEngine=null,"feature"===i._schema.type&&null!=i._schema.service.queryMetadata.lastEditDate&&(i._lastEditDate=i._schema.service.queryMetadata.lastEditDate),null==i._streamMessenger&&"stream"===i._schema.type&&i._initStreamMessenger(),(0,$.$c)(o,"sourceRefreshVersion")&&i._strategy?.refresh)return yield i._strategy.refresh(),!0;if("feature"===a.type&&(0,$.$c)(o,"availableFields")){if((yield i._queryLastEditDateChanged())||i._didInvalidateData)i._didInvalidateData=!1,yield i._updateStrategy(s);else{i._eventLog.onEvent({type:"updateFieldsStart"});try{yield i._strategy.updateFields(a.mutable.availableFields),i._eventLog.onEvent({type:"updateFieldsEnd"})}catch(u){i._eventLog.onEvent({type:"updateFieldsError",error:u})}}return!1}return!(!(0,$.jW)(o,"dataFilter")&&!(0,$.jW)(o,"sourceRefreshVersion")||(yield i._updateStrategy(s),0))})()}_initStreamMessenger(){null==this._streamMessenger&&(this._streamMessenger=new ze(this._connection))}_doGetOverride(t){var s=this;return(0,m.Z)(function*(){return s._strategy.queryOverride(t)})()}_queryLastEditDateChanged(){var t=this;return(0,m.Z)(function*(){if(null==t._lastEditDate)return!1;const s=t._schema.service.source,i={...s.query,f:"json"},a=(yield(0,vs.Z)(s.path,{query:i,responseType:"json"})).data.editingInfo.lastEditDate;return a!==t._lastEditDate&&(t._lastEditDate=a,!0)})()}_createStrategy(){var t=this;return(0,m.Z)(function*(){const s=t.service,i="isSourceHosted"in s&&s.isSourceHosted,a=Array.isArray(s.source),u=i||a||s.source&&"collection"in s.source;if("stream"===t._schema.type){const c=new Xs(t._schema.service,t._schema.mutable.dataFilter,t._store,{outSR:t._schema.mutable.dataFilter.outSpatialReference},t.metadata);return t._streamMessenger.strategy=c,c}const l=bt.fromSchema(t._schema,t._metadata),d=yield t._supportSnapshotMode(t._schema,l);return d?new Ys(t._schema.service,l,t._store,d.featureCount,t.metadata,t._eventLog):u?new qs(t._schema.service,l,t._store,t.metadata,t._eventLog):new zs(t._schema.service,l,t._store,t.metadata,t._eventLog)})()}_updateStrategy(t){var s=this;return(0,m.Z)(function*(){const i=yield s._createStrategy();s._eventLog.onEvent({type:"updateStrategyStart",about:i.about});const a=!!s._strategy;s._store.clear(),s._strategy?.destroy(),s._strategy=i,(0,I.Z)("esri-2d-update-debug")&&console.debug(`Version[${t}] FeatureSource.updateStrategy`,{strategy:i});const o=Array.from(s._subscriptions.values());if(!o.length)return void s._eventLog.onEvent({type:"updateStrategyEnd"});const u=Promise.all(o.map(l=>s._strategy.load(l).then(()=>s._eventLog.onEvent({type:"loaded",tile:l.tile.id})).catch(d=>s._eventLog.onEvent({type:"error",tile:l.tile.id,error:d}))));s._updateTracking.addPromise(u);try{a&&(yield u)}catch(l){(0,y.H9)(l)}s._eventLog.onEvent({type:"updateStrategyEnd"}),(0,I.Z)("esri-2d-update-debug")&&console.debug(`Version[${t}] FeatureSource.updateStrategyEnd`,{strategy:i})})()}_supportSnapshotMode(t,s){return(0,m.Z)(function*(){const{queryMetadata:i}=t.service,a=i.snapshotInfo;if(!a||!a.supportsSnapshotMinThreshold||!a.snapshotCountThresholds)return null;const o=t.service.source,u=s.createQuery();u.inner.orderByFields=[],u.inner.returnGeometry=!1;const l=(yield(0,Ne.hH)(o,u.inner,{query:u.customParameters})).data.count,{min:d,max:c}=a.snapshotCountThresholds;return l<=d||a.supportsSnapshotMaxThreshold&&l<c?{featureCount:l}:null})()}}var sr=g(72392);class rr{constructor(t,s){this._handles=new sr.Z,this._abortController=new AbortController,this._resolver=(0,y.hh)(),this._isDone=!1,this._aborted=!1,this.tile=t,this._version=s,this._handles.add([])}destroy(){this.pause(),this._handles.destroy()}get key(){return this.tile.key}get version(){return this._version}set version(t){this._version=t}get signal(){return this._abortController.signal}get options(){return{signal:this._abortController.signal}}get done(){return this._resolver.promise}get isDone(){return this._isDone}resolve(){this._isDone=!0,this._resolver.resolve()}get paused(){return this._aborted}resume(){this._abortController=new AbortController,this._aborted=!1}pause(){this._aborted||(this._aborted=!0,this._abortController.abort())}}var nr=g(81340);class ir{constructor(t){this.edit=t,this.resolver=(0,y.hh)()}}class ar{constructor(t,s){this.schema=t,this.version=s,this.resolver=(0,y.hh)()}}class or{constructor(){this._aggregateAdapter={getFeatureObjectIds:t=>this._processor.getFeatureObjectIdsForAggregate(t)},this._subscriptions=new Map,this._updateRequested=!1,this._updateSubscriptionRequests=[],this._updateHighlightRequests=[]}destroy(){this._subscriptions.clear(),this._processor.destroy(),this._source.destroy(),this._handles.remove(),this._editState=null,this._tileInfoView=null}onDetach(){this.destroy(),this._initialize(this._connection)}_initialize(t){this._source=new tr(this._aggregateAdapter,this._subscriptions,()=>this._requestUpdate(),t),this._processor=new Is(t,this._source),this._handles=(0,S.AL)([(0,v.YP)(()=>this._source.updateTracking.updating,()=>{this._requestUpdate(),this._connection.layerView.setUpdating({data:this._source.updateTracking.updating,pipeline:!0})})])}set remoteClient(t){this._connection=new ye(t),this._initialize(this._connection)}get features(){const t=this._source.queryEngine;if(!t)throw new Z.Z("no-queryEngine","No query engine defined");return t}get aggregates(){const t=this._processor.aggregateQueryEngine;if(!t)throw new Z.Z("no-queryEngine","No aggregate query engine defined");return t}get processor(){return this._processor}get streamMessenger(){return this._source.streamMessenger}getDisplayFeatures(t){return this._processor.getDisplayFeatures(t)}updateSchema(t,s){var i=this;return(0,m.Z)(function*(){return(0,I.Z)("esri-2d-update-debug")&&i._updateSchemaState&&console.error("InternalError: Schema already updating"),i._updateSchemaState=new ar(t,s),i._requestUpdate(),i._updateSchemaState.resolver.promise})()}updateSubscriptions(t){this._updateSubscriptionRequests.push(t),this._requestUpdate()}updateHighlight(t){this._updateHighlightRequests.push(t),this._requestUpdate()}onEdits(t){var s=this;return(0,m.Z)(function*(){if(null!=s._editState)throw new Z.Z("InternalError - Already processing an edit");s._editState=new ir(t);const i=s._editState.resolver.promise;return s._requestUpdate(),i})()}queryStatistics(){return this._source.statistics.toJSON()}queryVisibleFeatures(t,s){var i=this;return(0,m.Z)(function*(){return i.features.executeQuery(t,s)})()}queryHeatmapStatistics(t){var s=this;return(0,m.Z)(function*(){const i=Math.round((0,x.F2)(t.radius));let a=Number.POSITIVE_INFINITY,o=Number.NEGATIVE_INFINITY;const u="string"==typeof t.fieldOffset,l=t.fieldOffset??0,d=Array.from(s._subscriptions.values()),c=s._source.chunks(),p=i**2,_=3/(Math.PI*p),E=2*i,M=Math.ceil(B.i9/E);for(const C of d){const N=C.tile,L=new Float64Array(M*M);for(const R of c){const W=R.getTileReader(N);if(!W)continue;const z=W.getCursor();for(;z.next();){let V=1;if(null!=t.field){const ee=z.readAttribute(t.field);V=u?-1*+ee:+ee+l}const Y=z.readXForDisplay()/E,Q=z.readYForDisplay()/E,K=Math.floor(Y),te=Math.floor(Q);if(K<0||te<0||K>=M||te>=M)continue;const pe=((.5+K-Y)*E)**2+((.5+te-Q)*E)**2;pe>p||(L[te+K*M]+=V*(_*(1-pe/p)**2))}}for(let R=0;R<L.length;R++)a=Math.min(a,L[R]),o=Math.max(o,L[R])}return{max:o,min:a}})()}getSampleFeatures(t){var s=this;return(0,m.Z)(function*(){const i=s._source.chunks();if(i.reduce((c,p)=>c+p.size(),0)<=t.minFeatureCount){if(!s._source.updateTracking.updating){const c=[];return s._source.store.forEachUnsafe(p=>c.push(p.readLegacyFeatureWorldSpace())),c}return null}const a=new Set,o=[],u=i.map(c=>c.reader.getCursor()),l=new b.Z,d=3*t.sampleSize;for(let c=0;c<d&&o.length<t.sampleSize;c++){const p=u[l.getIntRange(0,i.length-1)];if(0===p.getSize())continue;const _=l.getIntRange(0,p.getSize()-1);p.setIndex(_);const E=p.getObjectId();a.has(E)||(a.add(E),o.push(p.readLegacyFeatureWorldSpace()))}return o.length>=t.sampleSize?o:null})()}_requestUpdate(){this._updateRequested||(this._updateRequested=!0,(0,f.Y)(()=>this._scheduleNextUpdate()))}_scheduleNextUpdate(){this._updateRequested&&(this._ongoingUpdate||(this._ongoingUpdate=this._doUpdate().finally(()=>{this._ongoingUpdate=null,this._scheduleNextUpdate()}),this._updateRequested=!1))}_subscribe(t){const s=t.tileId;if(this._subscriptions.has(s)){const o=this._subscriptions.get(s);return void(o.paused&&((0,I.Z)("esri-2d-update-debug")&&console.debug(`Tile[${s}] Pipeline.resume`),o.resume(),o.version=t.version,this._source.onResume(o)))}(0,I.Z)("esri-2d-update-debug")&&console.debug(`Tile[${s}] Pipeline.subscribe`);const i=new nr.n(this._tileInfoView,s),a=new rr(i,t.version);this._subscriptions.set(s,a),this._source.onSubscribe(a),this._processor.onSubscribe(a)}_unsubscribe(t){const s=this._subscriptions.get(t);s&&((0,I.Z)("esri-2d-update-debug")&&console.debug(`Tile[${t}] Pipeline.unsubscribe`),this._source.onUnsubscribe(s),this._processor.onUnsubscribe(s),this._subscriptions.delete(s.key.id),s.destroy())}_pauseSubscription(t){const s=this._subscriptions.get(t);s&&((0,I.Z)("esri-2d-update-debug")&&console.debug(`Tile[${t}] Pipeline.pause`),s.pause())}_doUpdate(){var t=this;return(0,m.Z)(function*(){if((0,I.Z)("esri-2d-update-debug")&&console.debug("Pipeline._doUpdateStart"),yield t._connection.layerView.setUpdating({data:t._source.updateTracking.updating,pipeline:!0}),t._updateSubscriptionRequests.length){const o=t._updateSubscriptionRequests;t._updateSubscriptionRequests=[];for(const u of o)t._doUpdateSubscriptions(u)}const s=t._updateSchemaState;if(t._updateSchemaState=null,null!=s){const{schema:o,version:u}=s;yield t._doUpdateSchema(o,u)}const i=t._editState;if(t._editState=null,null!=i){(0,I.Z)("esri-2d-update-debug")&&console.debug("Pipeline.applyEditOverride",i.edit);const o=yield t._source.getOverride(i.edit);yield t._processor.applyOverride(o),(0,I.Z)("esri-2d-update-debug")&&console.debug("Pipeline.endEditOverride",i.edit)}if(t._updateHighlightRequests.length){const o=t._updateHighlightRequests;t._updateHighlightRequests=[];for(const u of o)t._processor.updateHighlight(u)}const a=t._source.cleanupRemovedChunks();t._processor.removeChunks(a);try{t._subscriptions.size&&((0,I.Z)("esri-2d-update-debug")&&console.debug("Pipeline.updateChunksStart"),yield t._processor.updateChunks(),(0,I.Z)("esri-2d-update-debug")&&console.debug("Pipeline.updateChunksEnd"))}catch(o){(0,y.H9)(o)}i?.resolver.resolve(),s?.resolver.resolve(),t._updateRequested?((0,I.Z)("esri-2d-update-debug")&&console.debug("Pipeline._doUpdateEnd [updateRequested=true]"),yield t._connection.layerView.setUpdating({data:t._source.updateTracking.updating,pipeline:!0})):((0,I.Z)("esri-2d-update-debug")&&console.debug("Pipeline._doUpdateEnd [updateRequested=false, After flush]"),yield t._connection.layerView.setUpdating({data:t._source.updateTracking.updating,pipeline:t._updateRequested}))})()}_doUpdateSchema(t,s){var i=this;return(0,m.Z)(function*(){if((0,I.Z)("esri-2d-update-debug")&&console.debug(`Version[${s}] Pipeline.updateStart`,{schema:t}),!i._tileInfoView){const o=D.Z.fromJSON(t.source.tileInfoJSON);i._tileInfoView=new se.Z(o)}const a={tileInfo:i._tileInfoView?.tileInfo};try{const o=yield i._source.update(t,s),u=Array.from(i._subscriptions.values());yield i._processor.update(t,s,a,o,u)}catch(o){console.error(o)}(0,I.Z)("esri-2d-update-debug")&&console.debug(`Version[${s}] Pipeline.updateEnd`)})()}_doUpdateSubscriptions(t){if((0,I.Z)("esri-2d-update-debug")&&console.debug("Pipeline.updateSubscriptions",t),!this._tileInfoView){const s=D.Z.fromJSON(t.tileInfoJSON);this._tileInfoView=new se.Z(s)}for(const s of t.subscribe)this._subscribe(s);for(const s of t.unsubscribe)this._unsubscribe(s);if((0,I.Z)("featurelayer-query-pausing-enabled"))for(const s of t.pause)this._pauseSubscription(s)}}},55376:(ue,G,g)=>{function m(Z,S,I,f){const y=Z.clone(),b=1<<y.level,v=y.col+S,x=y.row+I;return f&&v<0?(y.col=v+b,y.world-=1):v>=b?(y.col=v-b,y.world+=1):y.col=v,y.row=x,y}g.d(G,{M:()=>m})}}]);